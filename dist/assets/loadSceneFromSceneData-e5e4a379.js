import{P as wi,a as iP,b as oP,s as ud}from"./index-9d9950c6.js";class Il{static urlParams(){return new URLSearchParams(globalThis.location.search)}static urlParam(e){return this.urlParams().get(e)}static noAssemblers(){return this.urlParam("noassemblers")=="1"}static debugLoadProgress(){return this.urlParam("debugLoadProgress")=="1"}static testBatchId(){const e=this.urlParam("testBatchId");return e?parseInt(e):-1}}var J=(n=>(n.BOOLEAN="boolean",n.BUTTON="button",n.COLOR="color",n.FLOAT="float",n.FOLDER="folder",n.INTEGER="integer",n.PARAM_PATH="param_path",n.NODE_PATH="node_path",n.RAMP="ramp",n.STRING="string",n.VECTOR2="vector2",n.VECTOR3="vector3",n.VECTOR4="vector4",n))(J||{});/**
 * @license
 * Copyright 2010-2023 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const wg="159",Gs={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},fs={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},aP=0,ay=1,cP=2,lP=0,Og=1,EA=2,hs=3,In=0,bn=1,er=2,$s=0,ki=1,r_=2,s_=3,i_=4,uP=5,go=100,hP=101,dP=102,cy=103,ly=104,pP=200,fP=201,mP=202,_P=203,o_=204,a_=205,gP=206,vP=207,yP=208,xP=209,bP=210,CP=211,EP=212,SP=213,AP=214,TP=0,MP=1,RP=2,Pd=3,wP=4,OP=5,PP=6,NP=7,_c=0,Pg=1,Ng=2,Fr=0,SA=1,AA=2,TA=3,MA=4,IP=5,RA=300,Qa=301,ec=302,c_=303,l_=304,pp=306,Nd=1e3,cr=1001,u_=1002,jt=1003,uy=1004,rf=1005,Or=1006,DP=1007,Dl=1008,Bi=1009,LP=1010,FP=1011,Ig=1012,wA=1013,Oi=1014,jn=1015,tc=1016,OA=1017,PA=1018,Gi=1020,UP=1021,fn=1023,kP=1024,BP=1025,To=1026,nc=1027,GP=1028,NA=1029,VP=1030,IA=1031,DA=1033,sf=33776,of=33777,af=33778,cf=33779,hy=35840,dy=35841,py=35842,fy=35843,LA=36196,my=37492,_y=37496,gy=37808,vy=37809,yy=37810,xy=37811,by=37812,Cy=37813,Ey=37814,Sy=37815,Ay=37816,Ty=37817,My=37818,Ry=37819,wy=37820,Oy=37821,lf=36492,Py=36494,Ny=36495,zP=36283,Iy=36284,Dy=36285,Ly=36286,Fy=2400,Uy=2401,ky=2402,FA=3e3,Mo=3001,HP=3200,jP=3201,ti=0,Dg=1,xn="",nn="srgb",kr="srgb-linear",gc="display-p3",Fo="display-p3-linear",Id="linear",kt="srgb",Dd="rec709",Ld="p3",Xo=7680,By=519,WP=512,XP=513,$P=514,UA=515,qP=516,YP=517,KP=518,ZP=519,Gy=35044,Vy="300 es",h_=1035,js=2e3,Fd=2001;class Ms{addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const r=this._listeners;r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const r=this._listeners;return r[e]!==void 0&&r[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const s=this._listeners[e];if(s!==void 0){const i=s.indexOf(t);i!==-1&&s.splice(i,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const r=this._listeners[e.type];if(r!==void 0){e.target=this;const s=r.slice(0);for(let i=0,o=s.length;i<o;i++)s[i].call(this,e);e.target=null}}}const Vn=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let zy=1234567;const ml=Math.PI/180,rc=180/Math.PI;function Uo(){const n=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,r=Math.random()*4294967295|0;return(Vn[n&255]+Vn[n>>8&255]+Vn[n>>16&255]+Vn[n>>24&255]+"-"+Vn[e&255]+Vn[e>>8&255]+"-"+Vn[e>>16&15|64]+Vn[e>>24&255]+"-"+Vn[t&63|128]+Vn[t>>8&255]+"-"+Vn[t>>16&255]+Vn[t>>24&255]+Vn[r&255]+Vn[r>>8&255]+Vn[r>>16&255]+Vn[r>>24&255]).toLowerCase()}function pn(n,e,t){return Math.max(e,Math.min(t,n))}function Lg(n,e){return(n%e+e)%e}function JP(n,e,t,r,s){return r+(n-e)*(s-r)/(t-e)}function QP(n,e,t){return n!==e?(t-n)/(e-n):0}function _l(n,e,t){return(1-t)*n+t*e}function eN(n,e,t,r){return _l(n,e,1-Math.exp(-t*r))}function tN(n,e=1){return e-Math.abs(Lg(n,e*2)-e)}function nN(n,e,t){return n<=e?0:n>=t?1:(n=(n-e)/(t-e),n*n*(3-2*n))}function rN(n,e,t){return n<=e?0:n>=t?1:(n=(n-e)/(t-e),n*n*n*(n*(n*6-15)+10))}function sN(n,e){return n+Math.floor(Math.random()*(e-n+1))}function iN(n,e){return n+Math.random()*(e-n)}function oN(n){return n*(.5-Math.random())}function aN(n){n!==void 0&&(zy=n);let e=zy+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}function cN(n){return n*ml}function lN(n){return n*rc}function d_(n){return(n&n-1)===0&&n!==0}function uN(n){return Math.pow(2,Math.ceil(Math.log(n)/Math.LN2))}function Ud(n){return Math.pow(2,Math.floor(Math.log(n)/Math.LN2))}function hN(n,e,t,r,s){const i=Math.cos,o=Math.sin,a=i(t/2),c=o(t/2),l=i((e+r)/2),u=o((e+r)/2),h=i((e-r)/2),d=o((e-r)/2),p=i((r-e)/2),_=o((r-e)/2);switch(s){case"XYX":n.set(a*u,c*h,c*d,a*l);break;case"YZY":n.set(c*d,a*u,c*h,a*l);break;case"ZXZ":n.set(c*h,c*d,a*u,a*l);break;case"XZX":n.set(a*u,c*_,c*p,a*l);break;case"YXY":n.set(c*p,a*u,c*_,a*l);break;case"ZYZ":n.set(c*_,c*p,a*u,a*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+s)}}function Na(n,e){switch(e.constructor){case Float32Array:return n;case Uint32Array:return n/4294967295;case Uint16Array:return n/65535;case Uint8Array:return n/255;case Int32Array:return Math.max(n/2147483647,-1);case Int16Array:return Math.max(n/32767,-1);case Int8Array:return Math.max(n/127,-1);default:throw new Error("Invalid component type.")}}function qn(n,e){switch(e.constructor){case Float32Array:return n;case Uint32Array:return Math.round(n*4294967295);case Uint16Array:return Math.round(n*65535);case Uint8Array:return Math.round(n*255);case Int32Array:return Math.round(n*2147483647);case Int16Array:return Math.round(n*32767);case Int8Array:return Math.round(n*127);default:throw new Error("Invalid component type.")}}const On={DEG2RAD:ml,RAD2DEG:rc,generateUUID:Uo,clamp:pn,euclideanModulo:Lg,mapLinear:JP,inverseLerp:QP,lerp:_l,damp:eN,pingpong:tN,smoothstep:nN,smootherstep:rN,randInt:sN,randFloat:iN,randFloatSpread:oN,seededRandom:aN,degToRad:cN,radToDeg:lN,isPowerOfTwo:d_,ceilPowerOfTwo:uN,floorPowerOfTwo:Ud,setQuaternionFromProperEuler:hN,normalize:qn,denormalize:Na};class W{constructor(e=0,t=0){W.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,r=this.y,s=e.elements;return this.x=s[0]*t+s[3]*r+s[6],this.y=s[1]*t+s[4]*r+s[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(t===0)return Math.PI/2;const r=this.dot(e)/t;return Math.acos(pn(r,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,r=this.y-e.y;return t*t+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const r=Math.cos(t),s=Math.sin(t),i=this.x-e.x,o=this.y-e.y;return this.x=i*r-o*s+e.x,this.y=i*s+o*r+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class nt{constructor(e,t,r,s,i,o,a,c,l){nt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],e!==void 0&&this.set(e,t,r,s,i,o,a,c,l)}set(e,t,r,s,i,o,a,c,l){const u=this.elements;return u[0]=e,u[1]=s,u[2]=a,u[3]=t,u[4]=i,u[5]=c,u[6]=r,u[7]=o,u[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],this}extractBasis(e,t,r){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const r=e.elements,s=t.elements,i=this.elements,o=r[0],a=r[3],c=r[6],l=r[1],u=r[4],h=r[7],d=r[2],p=r[5],_=r[8],g=s[0],f=s[3],m=s[6],y=s[1],v=s[4],b=s[7],x=s[2],E=s[5],S=s[8];return i[0]=o*g+a*y+c*x,i[3]=o*f+a*v+c*E,i[6]=o*m+a*b+c*S,i[1]=l*g+u*y+h*x,i[4]=l*f+u*v+h*E,i[7]=l*m+u*b+h*S,i[2]=d*g+p*y+_*x,i[5]=d*f+p*v+_*E,i[8]=d*m+p*b+_*S,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],r=e[1],s=e[2],i=e[3],o=e[4],a=e[5],c=e[6],l=e[7],u=e[8];return t*o*u-t*a*l-r*i*u+r*a*c+s*i*l-s*o*c}invert(){const e=this.elements,t=e[0],r=e[1],s=e[2],i=e[3],o=e[4],a=e[5],c=e[6],l=e[7],u=e[8],h=u*o-a*l,d=a*c-u*i,p=l*i-o*c,_=t*h+r*d+s*p;if(_===0)return this.set(0,0,0,0,0,0,0,0,0);const g=1/_;return e[0]=h*g,e[1]=(s*l-u*r)*g,e[2]=(a*r-s*o)*g,e[3]=d*g,e[4]=(u*t-s*c)*g,e[5]=(s*i-a*t)*g,e[6]=p*g,e[7]=(r*c-l*t)*g,e[8]=(o*t-r*i)*g,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,r,s,i,o,a){const c=Math.cos(i),l=Math.sin(i);return this.set(r*c,r*l,-r*(c*o+l*a)+o+e,-s*l,s*c,-s*(-l*o+c*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(uf.makeScale(e,t)),this}rotate(e){return this.premultiply(uf.makeRotation(-e)),this}translate(e,t){return this.premultiply(uf.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,r,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,r=e.elements;for(let s=0;s<9;s++)if(t[s]!==r[s])return!1;return!0}fromArray(e,t=0){for(let r=0;r<9;r++)this.elements[r]=e[r+t];return this}toArray(e=[],t=0){const r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e}clone(){return new this.constructor().fromArray(this.elements)}}const uf=new nt;function kA(n){for(let e=n.length-1;e>=0;--e)if(n[e]>=65535)return!0;return!1}function kd(n){return document.createElementNS("http://www.w3.org/1999/xhtml",n)}function dN(){const n=kd("canvas");return n.style.display="block",n}const Hy={};function gl(n){n in Hy||(Hy[n]=!0,console.warn(n))}const jy=new nt().set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Wy=new nt().set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),ku={[kr]:{transfer:Id,primaries:Dd,toReference:n=>n,fromReference:n=>n},[nn]:{transfer:kt,primaries:Dd,toReference:n=>n.convertSRGBToLinear(),fromReference:n=>n.convertLinearToSRGB()},[Fo]:{transfer:Id,primaries:Ld,toReference:n=>n.applyMatrix3(Wy),fromReference:n=>n.applyMatrix3(jy)},[gc]:{transfer:kt,primaries:Ld,toReference:n=>n.convertSRGBToLinear().applyMatrix3(Wy),fromReference:n=>n.applyMatrix3(jy).convertLinearToSRGB()}},pN=new Set([kr,Fo]),Rt={enabled:!0,_workingColorSpace:kr,get legacyMode(){return console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),!this.enabled},set legacyMode(n){console.warn("THREE.ColorManagement: .legacyMode=false renamed to .enabled=true in r150."),this.enabled=!n},get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(n){if(!pN.has(n))throw new Error(`Unsupported working color space, "${n}".`);this._workingColorSpace=n},convert:function(n,e,t){if(this.enabled===!1||e===t||!e||!t)return n;const r=ku[e].toReference,s=ku[t].fromReference;return s(r(n))},fromWorkingColorSpace:function(n,e){return this.convert(n,this._workingColorSpace,e)},toWorkingColorSpace:function(n,e){return this.convert(n,e,this._workingColorSpace)},getPrimaries:function(n){return ku[n].primaries},getTransfer:function(n){return n===xn?Id:ku[n].transfer}};function qa(n){return n<.04045?n*.0773993808:Math.pow(n*.9478672986+.0521327014,2.4)}function hf(n){return n<.0031308?n*12.92:1.055*Math.pow(n,.41666)-.055}let $o;class BA{static getDataURL(e){if(/^data:/i.test(e.src)||typeof HTMLCanvasElement>"u")return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{$o===void 0&&($o=kd("canvas")),$o.width=e.width,$o.height=e.height;const r=$o.getContext("2d");e instanceof ImageData?r.putImageData(e,0,0):r.drawImage(e,0,0,e.width,e.height),t=$o}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}static sRGBToLinear(e){if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap){const t=kd("canvas");t.width=e.width,t.height=e.height;const r=t.getContext("2d");r.drawImage(e,0,0,e.width,e.height);const s=r.getImageData(0,0,e.width,e.height),i=s.data;for(let o=0;o<i.length;o++)i[o]=qa(i[o]/255)*255;return r.putImageData(s,0,0),t}else if(e.data){const t=e.data.slice(0);for(let r=0;r<t.length;r++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[r]=Math.floor(qa(t[r]/255)*255):t[r]=qa(t[r]);return{data:t,width:e.width,height:e.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let fN=0;class GA{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:fN++}),this.uuid=Uo(),this.data=e,this.version=0}set needsUpdate(e){e===!0&&this.version++}toJSON(e){const t=e===void 0||typeof e=="string";if(!t&&e.images[this.uuid]!==void 0)return e.images[this.uuid];const r={uuid:this.uuid,url:""},s=this.data;if(s!==null){let i;if(Array.isArray(s)){i=[];for(let o=0,a=s.length;o<a;o++)s[o].isDataTexture?i.push(df(s[o].image)):i.push(df(s[o]))}else i=df(s);r.url=i}return t||(e.images[this.uuid]=r),r}}function df(n){return typeof HTMLImageElement<"u"&&n instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&n instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&n instanceof ImageBitmap?BA.getDataURL(n):n.data?{data:Array.from(n.data),width:n.width,height:n.height,type:n.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let mN=0;class Wn extends Ms{constructor(e=Wn.DEFAULT_IMAGE,t=Wn.DEFAULT_MAPPING,r=cr,s=cr,i=Or,o=Dl,a=fn,c=Bi,l=Wn.DEFAULT_ANISOTROPY,u=xn){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:mN++}),this.uuid=Uo(),this.name="",this.source=new GA(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=r,this.wrapT=s,this.magFilter=i,this.minFilter=o,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=c,this.offset=new W(0,0),this.repeat=new W(1,1),this.center=new W(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new nt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,typeof u=="string"?this.colorSpace=u:(gl("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=u===Mo?nn:xn),this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const t=e===void 0||typeof e=="string";if(!t&&e.textures[this.uuid]!==void 0)return e.textures[this.uuid];const r={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(r.userData=this.userData),t||(e.textures[this.uuid]=r),r}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==RA)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Nd:e.x=e.x-Math.floor(e.x);break;case cr:e.x=e.x<0?0:1;break;case u_:Math.abs(Math.floor(e.x)%2)===1?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x);break}if(e.y<0||e.y>1)switch(this.wrapT){case Nd:e.y=e.y-Math.floor(e.y);break;case cr:e.y=e.y<0?0:1;break;case u_:Math.abs(Math.floor(e.y)%2)===1?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y);break}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){e===!0&&(this.version++,this.source.needsUpdate=!0)}get encoding(){return gl("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace===nn?Mo:FA}set encoding(e){gl("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=e===Mo?nn:xn}}Wn.DEFAULT_IMAGE=null;Wn.DEFAULT_MAPPING=RA;Wn.DEFAULT_ANISOTROPY=1;class We{constructor(e=0,t=0,r=0,s=1){We.prototype.isVector4=!0,this.x=e,this.y=t,this.z=r,this.w=s}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,r,s){return this.x=e,this.y=t,this.z=r,this.w=s,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==void 0?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,r=this.y,s=this.z,i=this.w,o=e.elements;return this.x=o[0]*t+o[4]*r+o[8]*s+o[12]*i,this.y=o[1]*t+o[5]*r+o[9]*s+o[13]*i,this.z=o[2]*t+o[6]*r+o[10]*s+o[14]*i,this.w=o[3]*t+o[7]*r+o[11]*s+o[15]*i,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,r,s,i;const c=e.elements,l=c[0],u=c[4],h=c[8],d=c[1],p=c[5],_=c[9],g=c[2],f=c[6],m=c[10];if(Math.abs(u-d)<.01&&Math.abs(h-g)<.01&&Math.abs(_-f)<.01){if(Math.abs(u+d)<.1&&Math.abs(h+g)<.1&&Math.abs(_+f)<.1&&Math.abs(l+p+m-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;const v=(l+1)/2,b=(p+1)/2,x=(m+1)/2,E=(u+d)/4,S=(h+g)/4,R=(_+f)/4;return v>b&&v>x?v<.01?(r=0,s=.707106781,i=.707106781):(r=Math.sqrt(v),s=E/r,i=S/r):b>x?b<.01?(r=.707106781,s=0,i=.707106781):(s=Math.sqrt(b),r=E/s,i=R/s):x<.01?(r=.707106781,s=.707106781,i=0):(i=Math.sqrt(x),r=S/i,s=R/i),this.set(r,s,i,t),this}let y=Math.sqrt((f-_)*(f-_)+(h-g)*(h-g)+(d-u)*(d-u));return Math.abs(y)<.001&&(y=1),this.x=(f-_)/y,this.y=(h-g)/y,this.z=(d-u)/y,this.w=Math.acos((l+p+m-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this.w=e.w+(t.w-e.w)*r,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class _N extends Ms{constructor(e=1,t=1,r={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new We(0,0,e,t),this.scissorTest=!1,this.viewport=new We(0,0,e,t);const s={width:e,height:t,depth:1};r.encoding!==void 0&&(gl("THREE.WebGLRenderTarget: option.encoding has been replaced by option.colorSpace."),r.colorSpace=r.encoding===Mo?nn:xn),r=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:Or,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0},r),this.texture=new Wn(s,r.mapping,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy,r.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=r.generateMipmaps,this.texture.internalFormat=r.internalFormat,this.depthBuffer=r.depthBuffer,this.stencilBuffer=r.stencilBuffer,this.depthTexture=r.depthTexture,this.samples=r.samples}setSize(e,t,r=1){(this.width!==e||this.height!==t||this.depth!==r)&&(this.width=e,this.height=t,this.depth=r,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=r,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return new this.constructor().copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.texture.isRenderTargetTexture=!0;const t=Object.assign({},e.texture.image);return this.texture.source=new GA(t),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,e.depthTexture!==null&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Br extends _N{constructor(e=1,t=1,r={}){super(e,t,r),this.isWebGLRenderTarget=!0}}class VA extends Wn{constructor(e=null,t=1,r=1,s=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:r,depth:s},this.magFilter=jt,this.minFilter=jt,this.wrapR=cr,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class gN extends Wn{constructor(e=null,t=1,r=1,s=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:r,depth:s},this.magFilter=jt,this.minFilter=jt,this.wrapR=cr,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Qt{constructor(e=0,t=0,r=0,s=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=r,this._w=s}static slerpFlat(e,t,r,s,i,o,a){let c=r[s+0],l=r[s+1],u=r[s+2],h=r[s+3];const d=i[o+0],p=i[o+1],_=i[o+2],g=i[o+3];if(a===0){e[t+0]=c,e[t+1]=l,e[t+2]=u,e[t+3]=h;return}if(a===1){e[t+0]=d,e[t+1]=p,e[t+2]=_,e[t+3]=g;return}if(h!==g||c!==d||l!==p||u!==_){let f=1-a;const m=c*d+l*p+u*_+h*g,y=m>=0?1:-1,v=1-m*m;if(v>Number.EPSILON){const x=Math.sqrt(v),E=Math.atan2(x,m*y);f=Math.sin(f*E)/x,a=Math.sin(a*E)/x}const b=a*y;if(c=c*f+d*b,l=l*f+p*b,u=u*f+_*b,h=h*f+g*b,f===1-a){const x=1/Math.sqrt(c*c+l*l+u*u+h*h);c*=x,l*=x,u*=x,h*=x}}e[t]=c,e[t+1]=l,e[t+2]=u,e[t+3]=h}static multiplyQuaternionsFlat(e,t,r,s,i,o){const a=r[s],c=r[s+1],l=r[s+2],u=r[s+3],h=i[o],d=i[o+1],p=i[o+2],_=i[o+3];return e[t]=a*_+u*h+c*p-l*d,e[t+1]=c*_+u*d+l*h-a*p,e[t+2]=l*_+u*p+a*d-c*h,e[t+3]=u*_-a*h-c*d-l*p,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,r,s){return this._x=e,this._y=t,this._z=r,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){const r=e._x,s=e._y,i=e._z,o=e._order,a=Math.cos,c=Math.sin,l=a(r/2),u=a(s/2),h=a(i/2),d=c(r/2),p=c(s/2),_=c(i/2);switch(o){case"XYZ":this._x=d*u*h+l*p*_,this._y=l*p*h-d*u*_,this._z=l*u*_+d*p*h,this._w=l*u*h-d*p*_;break;case"YXZ":this._x=d*u*h+l*p*_,this._y=l*p*h-d*u*_,this._z=l*u*_-d*p*h,this._w=l*u*h+d*p*_;break;case"ZXY":this._x=d*u*h-l*p*_,this._y=l*p*h+d*u*_,this._z=l*u*_+d*p*h,this._w=l*u*h-d*p*_;break;case"ZYX":this._x=d*u*h-l*p*_,this._y=l*p*h+d*u*_,this._z=l*u*_-d*p*h,this._w=l*u*h+d*p*_;break;case"YZX":this._x=d*u*h+l*p*_,this._y=l*p*h+d*u*_,this._z=l*u*_-d*p*h,this._w=l*u*h-d*p*_;break;case"XZY":this._x=d*u*h-l*p*_,this._y=l*p*h-d*u*_,this._z=l*u*_+d*p*h,this._w=l*u*h+d*p*_;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return t!==!1&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const r=t/2,s=Math.sin(r);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,r=t[0],s=t[4],i=t[8],o=t[1],a=t[5],c=t[9],l=t[2],u=t[6],h=t[10],d=r+a+h;if(d>0){const p=.5/Math.sqrt(d+1);this._w=.25/p,this._x=(u-c)*p,this._y=(i-l)*p,this._z=(o-s)*p}else if(r>a&&r>h){const p=2*Math.sqrt(1+r-a-h);this._w=(u-c)/p,this._x=.25*p,this._y=(s+o)/p,this._z=(i+l)/p}else if(a>h){const p=2*Math.sqrt(1+a-r-h);this._w=(i-l)/p,this._x=(s+o)/p,this._y=.25*p,this._z=(c+u)/p}else{const p=2*Math.sqrt(1+h-r-a);this._w=(o-s)/p,this._x=(i+l)/p,this._y=(c+u)/p,this._z=.25*p}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let r=e.dot(t)+1;return r<Number.EPSILON?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=r):(this._x=0,this._y=-e.z,this._z=e.y,this._w=r)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=r),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(pn(this.dot(e),-1,1)))}rotateTowards(e,t){const r=this.angleTo(e);if(r===0)return this;const s=Math.min(1,t/r);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return e===0?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const r=e._x,s=e._y,i=e._z,o=e._w,a=t._x,c=t._y,l=t._z,u=t._w;return this._x=r*u+o*a+s*l-i*c,this._y=s*u+o*c+i*a-r*l,this._z=i*u+o*l+r*c-s*a,this._w=o*u-r*a-s*c-i*l,this._onChangeCallback(),this}slerp(e,t){if(t===0)return this;if(t===1)return this.copy(e);const r=this._x,s=this._y,i=this._z,o=this._w;let a=o*e._w+r*e._x+s*e._y+i*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=o,this._x=r,this._y=s,this._z=i,this;const c=1-a*a;if(c<=Number.EPSILON){const p=1-t;return this._w=p*o+t*this._w,this._x=p*r+t*this._x,this._y=p*s+t*this._y,this._z=p*i+t*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(c),u=Math.atan2(l,a),h=Math.sin((1-t)*u)/l,d=Math.sin(t*u)/l;return this._w=o*h+this._w*d,this._x=r*h+this._x*d,this._y=s*h+this._y*d,this._z=i*h+this._z*d,this._onChangeCallback(),this}slerpQuaternions(e,t,r){return this.copy(e).slerp(t,r)}random(){const e=Math.random(),t=Math.sqrt(1-e),r=Math.sqrt(e),s=2*Math.PI*Math.random(),i=2*Math.PI*Math.random();return this.set(t*Math.cos(s),r*Math.sin(i),r*Math.cos(i),t*Math.sin(s))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class T{constructor(e=0,t=0,r=0){T.prototype.isVector3=!0,this.x=e,this.y=t,this.z=r}set(e,t,r){return r===void 0&&(r=this.z),this.x=e,this.y=t,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(Xy.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Xy.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,r=this.y,s=this.z,i=e.elements;return this.x=i[0]*t+i[3]*r+i[6]*s,this.y=i[1]*t+i[4]*r+i[7]*s,this.z=i[2]*t+i[5]*r+i[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,r=this.y,s=this.z,i=e.elements,o=1/(i[3]*t+i[7]*r+i[11]*s+i[15]);return this.x=(i[0]*t+i[4]*r+i[8]*s+i[12])*o,this.y=(i[1]*t+i[5]*r+i[9]*s+i[13])*o,this.z=(i[2]*t+i[6]*r+i[10]*s+i[14])*o,this}applyQuaternion(e){const t=this.x,r=this.y,s=this.z,i=e.x,o=e.y,a=e.z,c=e.w,l=2*(o*s-a*r),u=2*(a*t-i*s),h=2*(i*r-o*t);return this.x=t+c*l+o*h-a*u,this.y=r+c*u+a*l-i*h,this.z=s+c*h+i*u-o*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,r=this.y,s=this.z,i=e.elements;return this.x=i[0]*t+i[4]*r+i[8]*s,this.y=i[1]*t+i[5]*r+i[9]*s,this.z=i[2]*t+i[6]*r+i[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(e,Math.min(t,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,r){return this.x=e.x+(t.x-e.x)*r,this.y=e.y+(t.y-e.y)*r,this.z=e.z+(t.z-e.z)*r,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const r=e.x,s=e.y,i=e.z,o=t.x,a=t.y,c=t.z;return this.x=s*c-i*a,this.y=i*o-r*c,this.z=r*a-s*o,this}projectOnVector(e){const t=e.lengthSq();if(t===0)return this.set(0,0,0);const r=e.dot(this)/t;return this.copy(e).multiplyScalar(r)}projectOnPlane(e){return pf.copy(this).projectOnVector(e),this.sub(pf)}reflect(e){return this.sub(pf.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(t===0)return Math.PI/2;const r=this.dot(e)/t;return Math.acos(pn(r,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,r=this.y-e.y,s=this.z-e.z;return t*t+r*r+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,r){const s=Math.sin(t)*e;return this.x=s*Math.sin(r),this.y=Math.cos(t)*e,this.z=s*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,r){return this.x=e*Math.sin(t),this.y=r,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,t*4)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,t*3)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=(Math.random()-.5)*2,t=Math.random()*Math.PI*2,r=Math.sqrt(1-e**2);return this.x=r*Math.cos(t),this.y=r*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const pf=new T,Xy=new Qt;class Ht{constructor(e=new T(1/0,1/0,1/0),t=new T(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,r=e.length;t<r;t+=3)this.expandByPoint(jr.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,r=e.count;t<r;t++)this.expandByPoint(jr.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const r=jr.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const r=e.geometry;if(r!==void 0){const i=r.getAttribute("position");if(t===!0&&i!==void 0&&e.isInstancedMesh!==!0)for(let o=0,a=i.count;o<a;o++)e.isMesh===!0?e.getVertexPosition(o,jr):jr.fromBufferAttribute(i,o),jr.applyMatrix4(e.matrixWorld),this.expandByPoint(jr);else e.boundingBox!==void 0?(e.boundingBox===null&&e.computeBoundingBox(),Bu.copy(e.boundingBox)):(r.boundingBox===null&&r.computeBoundingBox(),Bu.copy(r.boundingBox)),Bu.applyMatrix4(e.matrixWorld),this.union(Bu)}const s=e.children;for(let i=0,o=s.length;i<o;i++)this.expandByObject(s[i],t);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,jr),jr.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,r;return e.normal.x>0?(t=e.normal.x*this.min.x,r=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,r=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),t<=-e.constant&&r>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Dc),Gu.subVectors(this.max,Dc),qo.subVectors(e.a,Dc),Yo.subVectors(e.b,Dc),Ko.subVectors(e.c,Dc),ci.subVectors(Yo,qo),li.subVectors(Ko,Yo),Qi.subVectors(qo,Ko);let t=[0,-ci.z,ci.y,0,-li.z,li.y,0,-Qi.z,Qi.y,ci.z,0,-ci.x,li.z,0,-li.x,Qi.z,0,-Qi.x,-ci.y,ci.x,0,-li.y,li.x,0,-Qi.y,Qi.x,0];return!ff(t,qo,Yo,Ko,Gu)||(t=[1,0,0,0,1,0,0,0,1],!ff(t,qo,Yo,Ko,Gu))?!1:(Vu.crossVectors(ci,li),t=[Vu.x,Vu.y,Vu.z],ff(t,qo,Yo,Ko,Gu))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,jr).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=this.getSize(jr).length()*.5),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()?this:(Ns[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Ns[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Ns[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Ns[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Ns[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Ns[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Ns[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Ns[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Ns),this)}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const Ns=[new T,new T,new T,new T,new T,new T,new T,new T],jr=new T,Bu=new Ht,qo=new T,Yo=new T,Ko=new T,ci=new T,li=new T,Qi=new T,Dc=new T,Gu=new T,Vu=new T,eo=new T;function ff(n,e,t,r,s){for(let i=0,o=n.length-3;i<=o;i+=3){eo.fromArray(n,i);const a=s.x*Math.abs(eo.x)+s.y*Math.abs(eo.y)+s.z*Math.abs(eo.z),c=e.dot(eo),l=t.dot(eo),u=r.dot(eo);if(Math.max(-Math.max(c,l,u),Math.min(c,l,u))>a)return!1}return!0}const vN=new Ht,Lc=new T,mf=new T;class vr{constructor(e=new T,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const r=this.center;t!==void 0?r.copy(t):vN.setFromPoints(e).getCenter(r);let s=0;for(let i=0,o=e.length;i<o;i++)s=Math.max(s,r.distanceToSquared(e[i]));return this.radius=Math.sqrt(s),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const r=this.center.distanceToSquared(e);return t.copy(e),r>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;Lc.subVectors(e,this.center);const t=Lc.lengthSq();if(t>this.radius*this.radius){const r=Math.sqrt(t),s=(r-this.radius)*.5;this.center.addScaledVector(Lc,s/r),this.radius+=s}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(this.center.equals(e.center)===!0?this.radius=Math.max(this.radius,e.radius):(mf.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(Lc.copy(e.center).add(mf)),this.expandByPoint(Lc.copy(e.center).sub(mf))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}}const Is=new T,_f=new T,zu=new T,ui=new T,gf=new T,Hu=new T,vf=new T;class ni{constructor(e=new T,t=new T(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Is)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const r=t.dot(this.direction);return r<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,r)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Is.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Is.copy(this.origin).addScaledVector(this.direction,t),Is.distanceToSquared(e))}distanceSqToSegment(e,t,r,s){_f.copy(e).add(t).multiplyScalar(.5),zu.copy(t).sub(e).normalize(),ui.copy(this.origin).sub(_f);const i=e.distanceTo(t)*.5,o=-this.direction.dot(zu),a=ui.dot(this.direction),c=-ui.dot(zu),l=ui.lengthSq(),u=Math.abs(1-o*o);let h,d,p,_;if(u>0)if(h=o*c-a,d=o*a-c,_=i*u,h>=0)if(d>=-_)if(d<=_){const g=1/u;h*=g,d*=g,p=h*(h+o*d+2*a)+d*(o*h+d+2*c)+l}else d=i,h=Math.max(0,-(o*d+a)),p=-h*h+d*(d+2*c)+l;else d=-i,h=Math.max(0,-(o*d+a)),p=-h*h+d*(d+2*c)+l;else d<=-_?(h=Math.max(0,-(-o*i+a)),d=h>0?-i:Math.min(Math.max(-i,-c),i),p=-h*h+d*(d+2*c)+l):d<=_?(h=0,d=Math.min(Math.max(-i,-c),i),p=d*(d+2*c)+l):(h=Math.max(0,-(o*i+a)),d=h>0?i:Math.min(Math.max(-i,-c),i),p=-h*h+d*(d+2*c)+l);else d=o>0?-i:i,h=Math.max(0,-(o*d+a)),p=-h*h+d*(d+2*c)+l;return r&&r.copy(this.origin).addScaledVector(this.direction,h),s&&s.copy(_f).addScaledVector(zu,d),p}intersectSphere(e,t){Is.subVectors(e.center,this.origin);const r=Is.dot(this.direction),s=Is.dot(Is)-r*r,i=e.radius*e.radius;if(s>i)return null;const o=Math.sqrt(i-s),a=r-o,c=r+o;return c<0?null:a<0?this.at(c,t):this.at(a,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(t===0)return e.distanceToPoint(this.origin)===0?0:null;const r=-(this.origin.dot(e.normal)+e.constant)/t;return r>=0?r:null}intersectPlane(e,t){const r=this.distanceToPlane(e);return r===null?null:this.at(r,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return t===0||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let r,s,i,o,a,c;const l=1/this.direction.x,u=1/this.direction.y,h=1/this.direction.z,d=this.origin;return l>=0?(r=(e.min.x-d.x)*l,s=(e.max.x-d.x)*l):(r=(e.max.x-d.x)*l,s=(e.min.x-d.x)*l),u>=0?(i=(e.min.y-d.y)*u,o=(e.max.y-d.y)*u):(i=(e.max.y-d.y)*u,o=(e.min.y-d.y)*u),r>o||i>s||((i>r||isNaN(r))&&(r=i),(o<s||isNaN(s))&&(s=o),h>=0?(a=(e.min.z-d.z)*h,c=(e.max.z-d.z)*h):(a=(e.max.z-d.z)*h,c=(e.min.z-d.z)*h),r>c||a>s)||((a>r||r!==r)&&(r=a),(c<s||s!==s)&&(s=c),s<0)?null:this.at(r>=0?r:s,t)}intersectsBox(e){return this.intersectBox(e,Is)!==null}intersectTriangle(e,t,r,s,i){gf.subVectors(t,e),Hu.subVectors(r,e),vf.crossVectors(gf,Hu);let o=this.direction.dot(vf),a;if(o>0){if(s)return null;a=1}else if(o<0)a=-1,o=-o;else return null;ui.subVectors(this.origin,e);const c=a*this.direction.dot(Hu.crossVectors(ui,Hu));if(c<0)return null;const l=a*this.direction.dot(gf.cross(ui));if(l<0||c+l>o)return null;const u=-a*ui.dot(vf);return u<0?null:this.at(u/o,i)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class qe{constructor(e,t,r,s,i,o,a,c,l,u,h,d,p,_,g,f){qe.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e!==void 0&&this.set(e,t,r,s,i,o,a,c,l,u,h,d,p,_,g,f)}set(e,t,r,s,i,o,a,c,l,u,h,d,p,_,g,f){const m=this.elements;return m[0]=e,m[4]=t,m[8]=r,m[12]=s,m[1]=i,m[5]=o,m[9]=a,m[13]=c,m[2]=l,m[6]=u,m[10]=h,m[14]=d,m[3]=p,m[7]=_,m[11]=g,m[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new qe().fromArray(this.elements)}copy(e){const t=this.elements,r=e.elements;return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15],this}copyPosition(e){const t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this}makeBasis(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,r=e.elements,s=1/Zo.setFromMatrixColumn(e,0).length(),i=1/Zo.setFromMatrixColumn(e,1).length(),o=1/Zo.setFromMatrixColumn(e,2).length();return t[0]=r[0]*s,t[1]=r[1]*s,t[2]=r[2]*s,t[3]=0,t[4]=r[4]*i,t[5]=r[5]*i,t[6]=r[6]*i,t[7]=0,t[8]=r[8]*o,t[9]=r[9]*o,t[10]=r[10]*o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,r=e.x,s=e.y,i=e.z,o=Math.cos(r),a=Math.sin(r),c=Math.cos(s),l=Math.sin(s),u=Math.cos(i),h=Math.sin(i);if(e.order==="XYZ"){const d=o*u,p=o*h,_=a*u,g=a*h;t[0]=c*u,t[4]=-c*h,t[8]=l,t[1]=p+_*l,t[5]=d-g*l,t[9]=-a*c,t[2]=g-d*l,t[6]=_+p*l,t[10]=o*c}else if(e.order==="YXZ"){const d=c*u,p=c*h,_=l*u,g=l*h;t[0]=d+g*a,t[4]=_*a-p,t[8]=o*l,t[1]=o*h,t[5]=o*u,t[9]=-a,t[2]=p*a-_,t[6]=g+d*a,t[10]=o*c}else if(e.order==="ZXY"){const d=c*u,p=c*h,_=l*u,g=l*h;t[0]=d-g*a,t[4]=-o*h,t[8]=_+p*a,t[1]=p+_*a,t[5]=o*u,t[9]=g-d*a,t[2]=-o*l,t[6]=a,t[10]=o*c}else if(e.order==="ZYX"){const d=o*u,p=o*h,_=a*u,g=a*h;t[0]=c*u,t[4]=_*l-p,t[8]=d*l+g,t[1]=c*h,t[5]=g*l+d,t[9]=p*l-_,t[2]=-l,t[6]=a*c,t[10]=o*c}else if(e.order==="YZX"){const d=o*c,p=o*l,_=a*c,g=a*l;t[0]=c*u,t[4]=g-d*h,t[8]=_*h+p,t[1]=h,t[5]=o*u,t[9]=-a*u,t[2]=-l*u,t[6]=p*h+_,t[10]=d-g*h}else if(e.order==="XZY"){const d=o*c,p=o*l,_=a*c,g=a*l;t[0]=c*u,t[4]=-h,t[8]=l*u,t[1]=d*h+g,t[5]=o*u,t[9]=p*h-_,t[2]=_*h-p,t[6]=a*u,t[10]=g*h+d}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(yN,e,xN)}lookAt(e,t,r){const s=this.elements;return ir.subVectors(e,t),ir.lengthSq()===0&&(ir.z=1),ir.normalize(),hi.crossVectors(r,ir),hi.lengthSq()===0&&(Math.abs(r.z)===1?ir.x+=1e-4:ir.z+=1e-4,ir.normalize(),hi.crossVectors(r,ir)),hi.normalize(),ju.crossVectors(ir,hi),s[0]=hi.x,s[4]=ju.x,s[8]=ir.x,s[1]=hi.y,s[5]=ju.y,s[9]=ir.y,s[2]=hi.z,s[6]=ju.z,s[10]=ir.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const r=e.elements,s=t.elements,i=this.elements,o=r[0],a=r[4],c=r[8],l=r[12],u=r[1],h=r[5],d=r[9],p=r[13],_=r[2],g=r[6],f=r[10],m=r[14],y=r[3],v=r[7],b=r[11],x=r[15],E=s[0],S=s[4],R=s[8],C=s[12],M=s[1],G=s[5],F=s[9],X=s[13],N=s[2],j=s[6],K=s[10],$=s[14],q=s[3],ne=s[7],le=s[11],ue=s[15];return i[0]=o*E+a*M+c*N+l*q,i[4]=o*S+a*G+c*j+l*ne,i[8]=o*R+a*F+c*K+l*le,i[12]=o*C+a*X+c*$+l*ue,i[1]=u*E+h*M+d*N+p*q,i[5]=u*S+h*G+d*j+p*ne,i[9]=u*R+h*F+d*K+p*le,i[13]=u*C+h*X+d*$+p*ue,i[2]=_*E+g*M+f*N+m*q,i[6]=_*S+g*G+f*j+m*ne,i[10]=_*R+g*F+f*K+m*le,i[14]=_*C+g*X+f*$+m*ue,i[3]=y*E+v*M+b*N+x*q,i[7]=y*S+v*G+b*j+x*ne,i[11]=y*R+v*F+b*K+x*le,i[15]=y*C+v*X+b*$+x*ue,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],r=e[4],s=e[8],i=e[12],o=e[1],a=e[5],c=e[9],l=e[13],u=e[2],h=e[6],d=e[10],p=e[14],_=e[3],g=e[7],f=e[11],m=e[15];return _*(+i*c*h-s*l*h-i*a*d+r*l*d+s*a*p-r*c*p)+g*(+t*c*p-t*l*d+i*o*d-s*o*p+s*l*u-i*c*u)+f*(+t*l*h-t*a*p-i*o*h+r*o*p+i*a*u-r*l*u)+m*(-s*a*u-t*c*h+t*a*d+s*o*h-r*o*d+r*c*u)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,r){const s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=r),this}invert(){const e=this.elements,t=e[0],r=e[1],s=e[2],i=e[3],o=e[4],a=e[5],c=e[6],l=e[7],u=e[8],h=e[9],d=e[10],p=e[11],_=e[12],g=e[13],f=e[14],m=e[15],y=h*f*l-g*d*l+g*c*p-a*f*p-h*c*m+a*d*m,v=_*d*l-u*f*l-_*c*p+o*f*p+u*c*m-o*d*m,b=u*g*l-_*h*l+_*a*p-o*g*p-u*a*m+o*h*m,x=_*h*c-u*g*c-_*a*d+o*g*d+u*a*f-o*h*f,E=t*y+r*v+s*b+i*x;if(E===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const S=1/E;return e[0]=y*S,e[1]=(g*d*i-h*f*i-g*s*p+r*f*p+h*s*m-r*d*m)*S,e[2]=(a*f*i-g*c*i+g*s*l-r*f*l-a*s*m+r*c*m)*S,e[3]=(h*c*i-a*d*i-h*s*l+r*d*l+a*s*p-r*c*p)*S,e[4]=v*S,e[5]=(u*f*i-_*d*i+_*s*p-t*f*p-u*s*m+t*d*m)*S,e[6]=(_*c*i-o*f*i-_*s*l+t*f*l+o*s*m-t*c*m)*S,e[7]=(o*d*i-u*c*i+u*s*l-t*d*l-o*s*p+t*c*p)*S,e[8]=b*S,e[9]=(_*h*i-u*g*i-_*r*p+t*g*p+u*r*m-t*h*m)*S,e[10]=(o*g*i-_*a*i+_*r*l-t*g*l-o*r*m+t*a*m)*S,e[11]=(u*a*i-o*h*i-u*r*l+t*h*l+o*r*p-t*a*p)*S,e[12]=x*S,e[13]=(u*g*s-_*h*s+_*r*d-t*g*d-u*r*f+t*h*f)*S,e[14]=(_*a*s-o*g*s-_*r*c+t*g*c+o*r*f-t*a*f)*S,e[15]=(o*h*s-u*a*s+u*r*c-t*h*c-o*r*d+t*a*d)*S,this}scale(e){const t=this.elements,r=e.x,s=e.y,i=e.z;return t[0]*=r,t[4]*=s,t[8]*=i,t[1]*=r,t[5]*=s,t[9]*=i,t[2]*=r,t[6]*=s,t[10]*=i,t[3]*=r,t[7]*=s,t[11]*=i,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,s))}makeTranslation(e,t,r){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const r=Math.cos(t),s=Math.sin(t),i=1-r,o=e.x,a=e.y,c=e.z,l=i*o,u=i*a;return this.set(l*o+r,l*a-s*c,l*c+s*a,0,l*a+s*c,u*a+r,u*c-s*o,0,l*c-s*a,u*c+s*o,i*c*c+r,0,0,0,0,1),this}makeScale(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,t,r,s,i,o){return this.set(1,r,i,0,e,1,o,0,t,s,1,0,0,0,0,1),this}compose(e,t,r){const s=this.elements,i=t._x,o=t._y,a=t._z,c=t._w,l=i+i,u=o+o,h=a+a,d=i*l,p=i*u,_=i*h,g=o*u,f=o*h,m=a*h,y=c*l,v=c*u,b=c*h,x=r.x,E=r.y,S=r.z;return s[0]=(1-(g+m))*x,s[1]=(p+b)*x,s[2]=(_-v)*x,s[3]=0,s[4]=(p-b)*E,s[5]=(1-(d+m))*E,s[6]=(f+y)*E,s[7]=0,s[8]=(_+v)*S,s[9]=(f-y)*S,s[10]=(1-(d+g))*S,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,r){const s=this.elements;let i=Zo.set(s[0],s[1],s[2]).length();const o=Zo.set(s[4],s[5],s[6]).length(),a=Zo.set(s[8],s[9],s[10]).length();this.determinant()<0&&(i=-i),e.x=s[12],e.y=s[13],e.z=s[14],Wr.copy(this);const l=1/i,u=1/o,h=1/a;return Wr.elements[0]*=l,Wr.elements[1]*=l,Wr.elements[2]*=l,Wr.elements[4]*=u,Wr.elements[5]*=u,Wr.elements[6]*=u,Wr.elements[8]*=h,Wr.elements[9]*=h,Wr.elements[10]*=h,t.setFromRotationMatrix(Wr),r.x=i,r.y=o,r.z=a,this}makePerspective(e,t,r,s,i,o,a=js){const c=this.elements,l=2*i/(t-e),u=2*i/(r-s),h=(t+e)/(t-e),d=(r+s)/(r-s);let p,_;if(a===js)p=-(o+i)/(o-i),_=-2*o*i/(o-i);else if(a===Fd)p=-o/(o-i),_=-o*i/(o-i);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);return c[0]=l,c[4]=0,c[8]=h,c[12]=0,c[1]=0,c[5]=u,c[9]=d,c[13]=0,c[2]=0,c[6]=0,c[10]=p,c[14]=_,c[3]=0,c[7]=0,c[11]=-1,c[15]=0,this}makeOrthographic(e,t,r,s,i,o,a=js){const c=this.elements,l=1/(t-e),u=1/(r-s),h=1/(o-i),d=(t+e)*l,p=(r+s)*u;let _,g;if(a===js)_=(o+i)*h,g=-2*h;else if(a===Fd)_=i*h,g=-1*h;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);return c[0]=2*l,c[4]=0,c[8]=0,c[12]=-d,c[1]=0,c[5]=2*u,c[9]=0,c[13]=-p,c[2]=0,c[6]=0,c[10]=g,c[14]=-_,c[3]=0,c[7]=0,c[11]=0,c[15]=1,this}equals(e){const t=this.elements,r=e.elements;for(let s=0;s<16;s++)if(t[s]!==r[s])return!1;return!0}fromArray(e,t=0){for(let r=0;r<16;r++)this.elements[r]=e[r+t];return this}toArray(e=[],t=0){const r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}}const Zo=new T,Wr=new qe,yN=new T(0,0,0),xN=new T(1,1,1),hi=new T,ju=new T,ir=new T,$y=new qe,qy=new Qt;class pr{constructor(e=0,t=0,r=0,s=pr.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=r,this._order=s}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,r,s=this._order){return this._x=e,this._y=t,this._z=r,this._order=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,r=!0){const s=e.elements,i=s[0],o=s[4],a=s[8],c=s[1],l=s[5],u=s[9],h=s[2],d=s[6],p=s[10];switch(t){case"XYZ":this._y=Math.asin(pn(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-u,p),this._z=Math.atan2(-o,i)):(this._x=Math.atan2(d,l),this._z=0);break;case"YXZ":this._x=Math.asin(-pn(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(a,p),this._z=Math.atan2(c,l)):(this._y=Math.atan2(-h,i),this._z=0);break;case"ZXY":this._x=Math.asin(pn(d,-1,1)),Math.abs(d)<.9999999?(this._y=Math.atan2(-h,p),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(c,i));break;case"ZYX":this._y=Math.asin(-pn(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(d,p),this._z=Math.atan2(c,i)):(this._x=0,this._z=Math.atan2(-o,l));break;case"YZX":this._z=Math.asin(pn(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(-u,l),this._y=Math.atan2(-h,i)):(this._x=0,this._y=Math.atan2(a,p));break;case"XZY":this._z=Math.asin(-pn(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(d,l),this._y=Math.atan2(a,i)):(this._x=Math.atan2(-u,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,r===!0&&this._onChangeCallback(),this}setFromQuaternion(e,t,r){return $y.makeRotationFromQuaternion(e),this.setFromRotationMatrix($y,t,r)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return qy.setFromEuler(this),this.setFromQuaternion(qy,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],e[3]!==void 0&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}pr.DEFAULT_ORDER="XYZ";class Fg{constructor(){this.mask=1}set(e){this.mask=(1<<e|0)>>>0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!==0}isEnabled(e){return(this.mask&(1<<e|0))!==0}}let bN=0;const Yy=new T,Jo=new Qt,Ds=new qe,Wu=new T,Fc=new T,CN=new T,EN=new Qt,Ky=new T(1,0,0),Zy=new T(0,1,0),Jy=new T(0,0,1),SN={type:"added"},AN={type:"removed"};class wt extends Ms{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:bN++}),this.uuid=Uo(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=wt.DEFAULT_UP.clone();const e=new T,t=new pr,r=new Qt,s=new T(1,1,1);function i(){r.setFromEuler(t,!1)}function o(){t.setFromQuaternion(r,void 0,!1)}t._onChange(i),r._onChange(o),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:s},modelViewMatrix:{value:new qe},normalMatrix:{value:new nt}}),this.matrix=new qe,this.matrixWorld=new qe,this.matrixAutoUpdate=wt.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=wt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Fg,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return Jo.setFromAxisAngle(e,t),this.quaternion.multiply(Jo),this}rotateOnWorldAxis(e,t){return Jo.setFromAxisAngle(e,t),this.quaternion.premultiply(Jo),this}rotateX(e){return this.rotateOnAxis(Ky,e)}rotateY(e){return this.rotateOnAxis(Zy,e)}rotateZ(e){return this.rotateOnAxis(Jy,e)}translateOnAxis(e,t){return Yy.copy(e).applyQuaternion(this.quaternion),this.position.add(Yy.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Ky,e)}translateY(e){return this.translateOnAxis(Zy,e)}translateZ(e){return this.translateOnAxis(Jy,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Ds.copy(this.matrixWorld).invert())}lookAt(e,t,r){e.isVector3?Wu.copy(e):Wu.set(e,t,r);const s=this.parent;this.updateWorldMatrix(!0,!1),Fc.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Ds.lookAt(Fc,Wu,this.up):Ds.lookAt(Wu,Fc,this.up),this.quaternion.setFromRotationMatrix(Ds),s&&(Ds.extractRotation(s.matrixWorld),Jo.setFromRotationMatrix(Ds),this.quaternion.premultiply(Jo.invert()))}add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.parent!==null&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(SN)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let r=0;r<arguments.length;r++)this.remove(arguments[r]);return this}const t=this.children.indexOf(e);return t!==-1&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(AN)),this}removeFromParent(){const e=this.parent;return e!==null&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Ds.copy(this.matrixWorld).invert(),e.parent!==null&&(e.parent.updateWorldMatrix(!0,!1),Ds.multiply(e.parent.matrixWorld)),e.applyMatrix4(Ds),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let r=0,s=this.children.length;r<s;r++){const o=this.children[r].getObjectByProperty(e,t);if(o!==void 0)return o}}getObjectsByProperty(e,t,r=[]){this[e]===t&&r.push(this);const s=this.children;for(let i=0,o=s.length;i<o;i++)s[i].getObjectsByProperty(e,t,r);return r}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Fc,e,CN),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Fc,EN,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let r=0,s=t.length;r<s;r++)t[r].traverse(e)}traverseVisible(e){if(this.visible===!1)return;e(this);const t=this.children;for(let r=0,s=t.length;r<s;r++)t[r].traverseVisible(e)}traverseAncestors(e){const t=this.parent;t!==null&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let r=0,s=t.length;r<s;r++){const i=t[r];(i.matrixWorldAutoUpdate===!0||e===!0)&&i.updateMatrixWorld(e)}}updateWorldMatrix(e,t){const r=this.parent;if(e===!0&&r!==null&&r.matrixWorldAutoUpdate===!0&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),t===!0){const s=this.children;for(let i=0,o=s.length;i<o;i++){const a=s[i];a.matrixWorldAutoUpdate===!0&&a.updateWorldMatrix(!1,!0)}}}toJSON(e){const t=e===void 0||typeof e=="string",r={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const s={};s.uuid=this.uuid,s.type=this.type,this.name!==""&&(s.name=this.name),this.castShadow===!0&&(s.castShadow=!0),this.receiveShadow===!0&&(s.receiveShadow=!0),this.visible===!1&&(s.visible=!1),this.frustumCulled===!1&&(s.frustumCulled=!1),this.renderOrder!==0&&(s.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),s.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(s.matrixAutoUpdate=!1),this.isInstancedMesh&&(s.type="InstancedMesh",s.count=this.count,s.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(s.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(s.type="BatchedMesh",s.perObjectFrustumCulled=this.perObjectFrustumCulled,s.sortObjects=this.sortObjects,s.drawRanges=this._drawRanges,s.reservedRanges=this._reservedRanges,s.visibility=this._visibility,s.active=this._active,s.bounds=this._bounds.map(a=>({boxInitialized:a.boxInitialized,boxMin:a.box.min.toArray(),boxMax:a.box.max.toArray(),sphereInitialized:a.sphereInitialized,sphereRadius:a.sphere.radius,sphereCenter:a.sphere.center.toArray()})),s.maxGeometryCount=this._maxGeometryCount,s.maxVertexCount=this._maxVertexCount,s.maxIndexCount=this._maxIndexCount,s.geometryInitialized=this._geometryInitialized,s.geometryCount=this._geometryCount,s.matricesTexture=this._matricesTexture.toJSON(e),this.boundingSphere!==null&&(s.boundingSphere={center:s.boundingSphere.center.toArray(),radius:s.boundingSphere.radius}),this.boundingBox!==null&&(s.boundingBox={min:s.boundingBox.min.toArray(),max:s.boundingBox.max.toArray()}));function i(a,c){return a[c.uuid]===void 0&&(a[c.uuid]=c.toJSON(e)),c.uuid}if(this.isScene)this.background&&(this.background.isColor?s.background=this.background.toJSON():this.background.isTexture&&(s.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(s.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){s.geometry=i(e.geometries,this.geometry);const a=this.geometry.parameters;if(a!==void 0&&a.shapes!==void 0){const c=a.shapes;if(Array.isArray(c))for(let l=0,u=c.length;l<u;l++){const h=c[l];i(e.shapes,h)}else i(e.shapes,c)}}if(this.isSkinnedMesh&&(s.bindMode=this.bindMode,s.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(i(e.skeletons,this.skeleton),s.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const a=[];for(let c=0,l=this.material.length;c<l;c++)a.push(i(e.materials,this.material[c]));s.material=a}else s.material=i(e.materials,this.material);if(this.children.length>0){s.children=[];for(let a=0;a<this.children.length;a++)s.children.push(this.children[a].toJSON(e).object)}if(this.animations.length>0){s.animations=[];for(let a=0;a<this.animations.length;a++){const c=this.animations[a];s.animations.push(i(e.animations,c))}}if(t){const a=o(e.geometries),c=o(e.materials),l=o(e.textures),u=o(e.images),h=o(e.shapes),d=o(e.skeletons),p=o(e.animations),_=o(e.nodes);a.length>0&&(r.geometries=a),c.length>0&&(r.materials=c),l.length>0&&(r.textures=l),u.length>0&&(r.images=u),h.length>0&&(r.shapes=h),d.length>0&&(r.skeletons=d),p.length>0&&(r.animations=p),_.length>0&&(r.nodes=_)}return r.object=s,r;function o(a){const c=[];for(const l in a){const u=a[l];delete u.metadata,c.push(u)}return c}}clone(e){return new this.constructor().copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),t===!0)for(let r=0;r<e.children.length;r++){const s=e.children[r];this.add(s.clone())}return this}}wt.DEFAULT_UP=new T(0,1,0);wt.DEFAULT_MATRIX_AUTO_UPDATE=!0;wt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Xr=new T,Ls=new T,yf=new T,Fs=new T,Qo=new T,ea=new T,Qy=new T,xf=new T,bf=new T,Cf=new T;let Xu=!1;class Fn{constructor(e=new T,t=new T,r=new T){this.a=e,this.b=t,this.c=r}static getNormal(e,t,r,s){s.subVectors(r,t),Xr.subVectors(e,t),s.cross(Xr);const i=s.lengthSq();return i>0?s.multiplyScalar(1/Math.sqrt(i)):s.set(0,0,0)}static getBarycoord(e,t,r,s,i){Xr.subVectors(s,t),Ls.subVectors(r,t),yf.subVectors(e,t);const o=Xr.dot(Xr),a=Xr.dot(Ls),c=Xr.dot(yf),l=Ls.dot(Ls),u=Ls.dot(yf),h=o*l-a*a;if(h===0)return i.set(-2,-1,-1);const d=1/h,p=(l*c-a*u)*d,_=(o*u-a*c)*d;return i.set(1-p-_,_,p)}static containsPoint(e,t,r,s){return this.getBarycoord(e,t,r,s,Fs),Fs.x>=0&&Fs.y>=0&&Fs.x+Fs.y<=1}static getUV(e,t,r,s,i,o,a,c){return Xu===!1&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),Xu=!0),this.getInterpolation(e,t,r,s,i,o,a,c)}static getInterpolation(e,t,r,s,i,o,a,c){return this.getBarycoord(e,t,r,s,Fs),c.setScalar(0),c.addScaledVector(i,Fs.x),c.addScaledVector(o,Fs.y),c.addScaledVector(a,Fs.z),c}static isFrontFacing(e,t,r,s){return Xr.subVectors(r,t),Ls.subVectors(e,t),Xr.cross(Ls).dot(s)<0}set(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this}setFromPointsAndIndices(e,t,r,s){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[s]),this}setFromAttributeAndIndices(e,t,r,s){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,r),this.c.fromBufferAttribute(e,s),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Xr.subVectors(this.c,this.b),Ls.subVectors(this.a,this.b),Xr.cross(Ls).length()*.5}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Fn.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Fn.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,r,s,i){return Xu===!1&&(console.warn("THREE.Triangle.getUV() has been renamed to THREE.Triangle.getInterpolation()."),Xu=!0),Fn.getInterpolation(e,this.a,this.b,this.c,t,r,s,i)}getInterpolation(e,t,r,s,i){return Fn.getInterpolation(e,this.a,this.b,this.c,t,r,s,i)}containsPoint(e){return Fn.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Fn.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const r=this.a,s=this.b,i=this.c;let o,a;Qo.subVectors(s,r),ea.subVectors(i,r),xf.subVectors(e,r);const c=Qo.dot(xf),l=ea.dot(xf);if(c<=0&&l<=0)return t.copy(r);bf.subVectors(e,s);const u=Qo.dot(bf),h=ea.dot(bf);if(u>=0&&h<=u)return t.copy(s);const d=c*h-u*l;if(d<=0&&c>=0&&u<=0)return o=c/(c-u),t.copy(r).addScaledVector(Qo,o);Cf.subVectors(e,i);const p=Qo.dot(Cf),_=ea.dot(Cf);if(_>=0&&p<=_)return t.copy(i);const g=p*l-c*_;if(g<=0&&l>=0&&_<=0)return a=l/(l-_),t.copy(r).addScaledVector(ea,a);const f=u*_-p*h;if(f<=0&&h-u>=0&&p-_>=0)return Qy.subVectors(i,s),a=(h-u)/(h-u+(p-_)),t.copy(s).addScaledVector(Qy,a);const m=1/(f+g+d);return o=g*m,a=d*m,t.copy(r).addScaledVector(Qo,o).addScaledVector(ea,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const zA={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},di={h:0,s:0,l:0},$u={h:0,s:0,l:0};function Ef(n,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?n+(e-n)*6*t:t<1/2?e:t<2/3?n+(e-n)*6*(2/3-t):n}class xe{constructor(e,t,r){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,r)}set(e,t,r){if(t===void 0&&r===void 0){const s=e;s&&s.isColor?this.copy(s):typeof s=="number"?this.setHex(s):typeof s=="string"&&this.setStyle(s)}else this.setRGB(e,t,r);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=nn){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,Rt.toWorkingColorSpace(this,t),this}setRGB(e,t,r,s=Rt.workingColorSpace){return this.r=e,this.g=t,this.b=r,Rt.toWorkingColorSpace(this,s),this}setHSL(e,t,r,s=Rt.workingColorSpace){if(e=Lg(e,1),t=pn(t,0,1),r=pn(r,0,1),t===0)this.r=this.g=this.b=r;else{const i=r<=.5?r*(1+t):r+t-r*t,o=2*r-i;this.r=Ef(o,i,e+1/3),this.g=Ef(o,i,e),this.b=Ef(o,i,e-1/3)}return Rt.toWorkingColorSpace(this,s),this}setStyle(e,t=nn){function r(i){i!==void 0&&parseFloat(i)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let s;if(s=/^(\w+)\(([^\)]*)\)/.exec(e)){let i;const o=s[1],a=s[2];switch(o){case"rgb":case"rgba":if(i=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return r(i[4]),this.setRGB(Math.min(255,parseInt(i[1],10))/255,Math.min(255,parseInt(i[2],10))/255,Math.min(255,parseInt(i[3],10))/255,t);if(i=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return r(i[4]),this.setRGB(Math.min(100,parseInt(i[1],10))/100,Math.min(100,parseInt(i[2],10))/100,Math.min(100,parseInt(i[3],10))/100,t);break;case"hsl":case"hsla":if(i=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return r(i[4]),this.setHSL(parseFloat(i[1])/360,parseFloat(i[2])/100,parseFloat(i[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(s=/^\#([A-Fa-f\d]+)$/.exec(e)){const i=s[1],o=i.length;if(o===3)return this.setRGB(parseInt(i.charAt(0),16)/15,parseInt(i.charAt(1),16)/15,parseInt(i.charAt(2),16)/15,t);if(o===6)return this.setHex(parseInt(i,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=nn){const r=zA[e.toLowerCase()];return r!==void 0?this.setHex(r,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=qa(e.r),this.g=qa(e.g),this.b=qa(e.b),this}copyLinearToSRGB(e){return this.r=hf(e.r),this.g=hf(e.g),this.b=hf(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=nn){return Rt.fromWorkingColorSpace(zn.copy(this),e),Math.round(pn(zn.r*255,0,255))*65536+Math.round(pn(zn.g*255,0,255))*256+Math.round(pn(zn.b*255,0,255))}getHexString(e=nn){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Rt.workingColorSpace){Rt.fromWorkingColorSpace(zn.copy(this),t);const r=zn.r,s=zn.g,i=zn.b,o=Math.max(r,s,i),a=Math.min(r,s,i);let c,l;const u=(a+o)/2;if(a===o)c=0,l=0;else{const h=o-a;switch(l=u<=.5?h/(o+a):h/(2-o-a),o){case r:c=(s-i)/h+(s<i?6:0);break;case s:c=(i-r)/h+2;break;case i:c=(r-s)/h+4;break}c/=6}return e.h=c,e.s=l,e.l=u,e}getRGB(e,t=Rt.workingColorSpace){return Rt.fromWorkingColorSpace(zn.copy(this),t),e.r=zn.r,e.g=zn.g,e.b=zn.b,e}getStyle(e=nn){Rt.fromWorkingColorSpace(zn.copy(this),e);const t=zn.r,r=zn.g,s=zn.b;return e!==nn?`color(${e} ${t.toFixed(3)} ${r.toFixed(3)} ${s.toFixed(3)})`:`rgb(${Math.round(t*255)},${Math.round(r*255)},${Math.round(s*255)})`}offsetHSL(e,t,r){return this.getHSL(di),this.setHSL(di.h+e,di.s+t,di.l+r)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,r){return this.r=e.r+(t.r-e.r)*r,this.g=e.g+(t.g-e.g)*r,this.b=e.b+(t.b-e.b)*r,this}lerpHSL(e,t){this.getHSL(di),e.getHSL($u);const r=_l(di.h,$u.h,t),s=_l(di.s,$u.s,t),i=_l(di.l,$u.l,t);return this.setHSL(r,s,i),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,r=this.g,s=this.b,i=e.elements;return this.r=i[0]*t+i[3]*r+i[6]*s,this.g=i[1]*t+i[4]*r+i[7]*s,this.b=i[2]*t+i[5]*r+i[8]*s,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const zn=new xe;xe.NAMES=zA;let TN=0;class gn extends Ms{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:TN++}),this.uuid=Uo(),this.name="",this.type="Material",this.blending=ki,this.side=In,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=o_,this.blendDst=a_,this.blendEquation=go,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new xe(0,0,0),this.blendAlpha=0,this.depthFunc=Pd,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=By,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Xo,this.stencilZFail=Xo,this.stencilZPass=Xo,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(e!==void 0)for(const t in e){const r=e[t];if(r===void 0){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const s=this[t];if(s===void 0){console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`);continue}s&&s.isColor?s.set(r):s&&s.isVector3&&r&&r.isVector3?s.copy(r):this[t]=r}}toJSON(e){const t=e===void 0||typeof e=="string";t&&(e={textures:{},images:{}});const r={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};r.uuid=this.uuid,r.type=this.type,this.name!==""&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),this.roughness!==void 0&&(r.roughness=this.roughness),this.metalness!==void 0&&(r.metalness=this.metalness),this.sheen!==void 0&&(r.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(r.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(r.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),this.emissiveIntensity&&this.emissiveIntensity!==1&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(r.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(r.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(r.shininess=this.shininess),this.clearcoat!==void 0&&(r.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.iridescence!==void 0&&(r.iridescence=this.iridescence),this.iridescenceIOR!==void 0&&(r.iridescenceIOR=this.iridescenceIOR),this.iridescenceThicknessRange!==void 0&&(r.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(r.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(r.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),this.anisotropy!==void 0&&(r.anisotropy=this.anisotropy),this.anisotropyRotation!==void 0&&(r.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(r.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(e).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(r.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(r.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,this.combine!==void 0&&(r.combine=this.combine)),this.envMapIntensity!==void 0&&(r.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(r.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(r.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),this.transmission!==void 0&&(r.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(r.transmissionMap=this.transmissionMap.toJSON(e).uuid),this.thickness!==void 0&&(r.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(r.thicknessMap=this.thicknessMap.toJSON(e).uuid),this.attenuationDistance!==void 0&&this.attenuationDistance!==1/0&&(r.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(r.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(r.size=this.size),this.shadowSide!==null&&(r.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==ki&&(r.blending=this.blending),this.side!==In&&(r.side=this.side),this.vertexColors===!0&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),this.transparent===!0&&(r.transparent=!0),this.blendSrc!==o_&&(r.blendSrc=this.blendSrc),this.blendDst!==a_&&(r.blendDst=this.blendDst),this.blendEquation!==go&&(r.blendEquation=this.blendEquation),this.blendSrcAlpha!==null&&(r.blendSrcAlpha=this.blendSrcAlpha),this.blendDstAlpha!==null&&(r.blendDstAlpha=this.blendDstAlpha),this.blendEquationAlpha!==null&&(r.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(r.blendColor=this.blendColor.getHex()),this.blendAlpha!==0&&(r.blendAlpha=this.blendAlpha),this.depthFunc!==Pd&&(r.depthFunc=this.depthFunc),this.depthTest===!1&&(r.depthTest=this.depthTest),this.depthWrite===!1&&(r.depthWrite=this.depthWrite),this.colorWrite===!1&&(r.colorWrite=this.colorWrite),this.stencilWriteMask!==255&&(r.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==By&&(r.stencilFunc=this.stencilFunc),this.stencilRef!==0&&(r.stencilRef=this.stencilRef),this.stencilFuncMask!==255&&(r.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Xo&&(r.stencilFail=this.stencilFail),this.stencilZFail!==Xo&&(r.stencilZFail=this.stencilZFail),this.stencilZPass!==Xo&&(r.stencilZPass=this.stencilZPass),this.stencilWrite===!0&&(r.stencilWrite=this.stencilWrite),this.rotation!==void 0&&this.rotation!==0&&(r.rotation=this.rotation),this.polygonOffset===!0&&(r.polygonOffset=!0),this.polygonOffsetFactor!==0&&(r.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(r.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth!==void 0&&this.linewidth!==1&&(r.linewidth=this.linewidth),this.dashSize!==void 0&&(r.dashSize=this.dashSize),this.gapSize!==void 0&&(r.gapSize=this.gapSize),this.scale!==void 0&&(r.scale=this.scale),this.dithering===!0&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),this.alphaHash===!0&&(r.alphaHash=!0),this.alphaToCoverage===!0&&(r.alphaToCoverage=!0),this.premultipliedAlpha===!0&&(r.premultipliedAlpha=!0),this.forceSinglePass===!0&&(r.forceSinglePass=!0),this.wireframe===!0&&(r.wireframe=!0),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(r.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(r.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(r.flatShading=!0),this.visible===!1&&(r.visible=!1),this.toneMapped===!1&&(r.toneMapped=!1),this.fog===!1&&(r.fog=!1),Object.keys(this.userData).length>0&&(r.userData=this.userData);function s(i){const o=[];for(const a in i){const c=i[a];delete c.metadata,o.push(c)}return o}if(t){const i=s(e.textures),o=s(e.images);i.length>0&&(r.textures=i),o.length>0&&(r.images=o)}return r}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let r=null;if(t!==null){const s=t.length;r=new Array(s);for(let i=0;i!==s;++i)r[i]=t[i].clone()}return this.clippingPlanes=r,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){e===!0&&this.version++}}class _u extends gn{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new xe(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=_c,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const un=new T,qu=new W;class Lt{constructor(e,t,r=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=e!==void 0?e.length/t:0,this.normalized=r,this.usage=Gy,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=jn,this.version=0}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}get updateRange(){return console.warn('THREE.BufferAttribute: "updateRange" is deprecated and removed in r169. Use "addUpdateRange()" instead.'),this._updateRange}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,r){e*=this.itemSize,r*=t.itemSize;for(let s=0,i=this.itemSize;s<i;s++)this.array[e+s]=t.array[r+s];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(this.itemSize===2)for(let t=0,r=this.count;t<r;t++)qu.fromBufferAttribute(this,t),qu.applyMatrix3(e),this.setXY(t,qu.x,qu.y);else if(this.itemSize===3)for(let t=0,r=this.count;t<r;t++)un.fromBufferAttribute(this,t),un.applyMatrix3(e),this.setXYZ(t,un.x,un.y,un.z);return this}applyMatrix4(e){for(let t=0,r=this.count;t<r;t++)un.fromBufferAttribute(this,t),un.applyMatrix4(e),this.setXYZ(t,un.x,un.y,un.z);return this}applyNormalMatrix(e){for(let t=0,r=this.count;t<r;t++)un.fromBufferAttribute(this,t),un.applyNormalMatrix(e),this.setXYZ(t,un.x,un.y,un.z);return this}transformDirection(e){for(let t=0,r=this.count;t<r;t++)un.fromBufferAttribute(this,t),un.transformDirection(e),this.setXYZ(t,un.x,un.y,un.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let r=this.array[e*this.itemSize+t];return this.normalized&&(r=Na(r,this.array)),r}setComponent(e,t,r){return this.normalized&&(r=qn(r,this.array)),this.array[e*this.itemSize+t]=r,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=Na(t,this.array)),t}setX(e,t){return this.normalized&&(t=qn(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=Na(t,this.array)),t}setY(e,t){return this.normalized&&(t=qn(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=Na(t,this.array)),t}setZ(e,t){return this.normalized&&(t=qn(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=Na(t,this.array)),t}setW(e,t){return this.normalized&&(t=qn(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,r){return e*=this.itemSize,this.normalized&&(t=qn(t,this.array),r=qn(r,this.array)),this.array[e+0]=t,this.array[e+1]=r,this}setXYZ(e,t,r,s){return e*=this.itemSize,this.normalized&&(t=qn(t,this.array),r=qn(r,this.array),s=qn(s,this.array)),this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=s,this}setXYZW(e,t,r,s,i){return e*=this.itemSize,this.normalized&&(t=qn(t,this.array),r=qn(r,this.array),s=qn(s,this.array),i=qn(i,this.array)),this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=s,this.array[e+3]=i,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return this.name!==""&&(e.name=this.name),this.usage!==Gy&&(e.usage=this.usage),e}}class HA extends Lt{constructor(e,t,r){super(new Uint16Array(e),t,r)}}class MN extends Lt{constructor(e,t,r){super(new Int32Array(e),t,r)}}class jA extends Lt{constructor(e,t,r){super(new Uint32Array(e),t,r)}}class gt extends Lt{constructor(e,t,r){super(new Float32Array(e),t,r)}}let RN=0;const Sr=new qe,Sf=new wt,ta=new T,or=new Ht,Uc=new Ht,Tn=new T;class sn extends Ms{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:RN++}),this.uuid=Uo(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(kA(e)?jA:HA)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return this.attributes[e]!==void 0}addGroup(e,t,r=0){this.groups.push({start:e,count:t,materialIndex:r})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;t!==void 0&&(t.applyMatrix4(e),t.needsUpdate=!0);const r=this.attributes.normal;if(r!==void 0){const i=new nt().getNormalMatrix(e);r.applyNormalMatrix(i),r.needsUpdate=!0}const s=this.attributes.tangent;return s!==void 0&&(s.transformDirection(e),s.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(e){return Sr.makeRotationFromQuaternion(e),this.applyMatrix4(Sr),this}rotateX(e){return Sr.makeRotationX(e),this.applyMatrix4(Sr),this}rotateY(e){return Sr.makeRotationY(e),this.applyMatrix4(Sr),this}rotateZ(e){return Sr.makeRotationZ(e),this.applyMatrix4(Sr),this}translate(e,t,r){return Sr.makeTranslation(e,t,r),this.applyMatrix4(Sr),this}scale(e,t,r){return Sr.makeScale(e,t,r),this.applyMatrix4(Sr),this}lookAt(e){return Sf.lookAt(e),Sf.updateMatrix(),this.applyMatrix4(Sf.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(ta).negate(),this.translate(ta.x,ta.y,ta.z),this}setFromPoints(e){const t=[];for(let r=0,s=e.length;r<s;r++){const i=e[r];t.push(i.x,i.y,i.z||0)}return this.setAttribute("position",new gt(t,3)),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Ht);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingBox.set(new T(-1/0,-1/0,-1/0),new T(1/0,1/0,1/0));return}if(e!==void 0){if(this.boundingBox.setFromBufferAttribute(e),t)for(let r=0,s=t.length;r<s;r++){const i=t[r];or.setFromBufferAttribute(i),this.morphTargetsRelative?(Tn.addVectors(this.boundingBox.min,or.min),this.boundingBox.expandByPoint(Tn),Tn.addVectors(this.boundingBox.max,or.max),this.boundingBox.expandByPoint(Tn)):(this.boundingBox.expandByPoint(or.min),this.boundingBox.expandByPoint(or.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new vr);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),this.boundingSphere.set(new T,1/0);return}if(e){const r=this.boundingSphere.center;if(or.setFromBufferAttribute(e),t)for(let i=0,o=t.length;i<o;i++){const a=t[i];Uc.setFromBufferAttribute(a),this.morphTargetsRelative?(Tn.addVectors(or.min,Uc.min),or.expandByPoint(Tn),Tn.addVectors(or.max,Uc.max),or.expandByPoint(Tn)):(or.expandByPoint(Uc.min),or.expandByPoint(Uc.max))}or.getCenter(r);let s=0;for(let i=0,o=e.count;i<o;i++)Tn.fromBufferAttribute(e,i),s=Math.max(s,r.distanceToSquared(Tn));if(t)for(let i=0,o=t.length;i<o;i++){const a=t[i],c=this.morphTargetsRelative;for(let l=0,u=a.count;l<u;l++)Tn.fromBufferAttribute(a,l),c&&(ta.fromBufferAttribute(e,l),Tn.add(ta)),s=Math.max(s,r.distanceToSquared(Tn))}this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(e===null||t.position===void 0||t.normal===void 0||t.uv===void 0){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const r=e.array,s=t.position.array,i=t.normal.array,o=t.uv.array,a=s.length/3;this.hasAttribute("tangent")===!1&&this.setAttribute("tangent",new Lt(new Float32Array(4*a),4));const c=this.getAttribute("tangent").array,l=[],u=[];for(let M=0;M<a;M++)l[M]=new T,u[M]=new T;const h=new T,d=new T,p=new T,_=new W,g=new W,f=new W,m=new T,y=new T;function v(M,G,F){h.fromArray(s,M*3),d.fromArray(s,G*3),p.fromArray(s,F*3),_.fromArray(o,M*2),g.fromArray(o,G*2),f.fromArray(o,F*2),d.sub(h),p.sub(h),g.sub(_),f.sub(_);const X=1/(g.x*f.y-f.x*g.y);isFinite(X)&&(m.copy(d).multiplyScalar(f.y).addScaledVector(p,-g.y).multiplyScalar(X),y.copy(p).multiplyScalar(g.x).addScaledVector(d,-f.x).multiplyScalar(X),l[M].add(m),l[G].add(m),l[F].add(m),u[M].add(y),u[G].add(y),u[F].add(y))}let b=this.groups;b.length===0&&(b=[{start:0,count:r.length}]);for(let M=0,G=b.length;M<G;++M){const F=b[M],X=F.start,N=F.count;for(let j=X,K=X+N;j<K;j+=3)v(r[j+0],r[j+1],r[j+2])}const x=new T,E=new T,S=new T,R=new T;function C(M){S.fromArray(i,M*3),R.copy(S);const G=l[M];x.copy(G),x.sub(S.multiplyScalar(S.dot(G))).normalize(),E.crossVectors(R,G);const X=E.dot(u[M])<0?-1:1;c[M*4]=x.x,c[M*4+1]=x.y,c[M*4+2]=x.z,c[M*4+3]=X}for(let M=0,G=b.length;M<G;++M){const F=b[M],X=F.start,N=F.count;for(let j=X,K=X+N;j<K;j+=3)C(r[j+0]),C(r[j+1]),C(r[j+2])}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(t!==void 0){let r=this.getAttribute("normal");if(r===void 0)r=new Lt(new Float32Array(t.count*3),3),this.setAttribute("normal",r);else for(let d=0,p=r.count;d<p;d++)r.setXYZ(d,0,0,0);const s=new T,i=new T,o=new T,a=new T,c=new T,l=new T,u=new T,h=new T;if(e)for(let d=0,p=e.count;d<p;d+=3){const _=e.getX(d+0),g=e.getX(d+1),f=e.getX(d+2);s.fromBufferAttribute(t,_),i.fromBufferAttribute(t,g),o.fromBufferAttribute(t,f),u.subVectors(o,i),h.subVectors(s,i),u.cross(h),a.fromBufferAttribute(r,_),c.fromBufferAttribute(r,g),l.fromBufferAttribute(r,f),a.add(u),c.add(u),l.add(u),r.setXYZ(_,a.x,a.y,a.z),r.setXYZ(g,c.x,c.y,c.z),r.setXYZ(f,l.x,l.y,l.z)}else for(let d=0,p=t.count;d<p;d+=3)s.fromBufferAttribute(t,d+0),i.fromBufferAttribute(t,d+1),o.fromBufferAttribute(t,d+2),u.subVectors(o,i),h.subVectors(s,i),u.cross(h),r.setXYZ(d+0,u.x,u.y,u.z),r.setXYZ(d+1,u.x,u.y,u.z),r.setXYZ(d+2,u.x,u.y,u.z);this.normalizeNormals(),r.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,r=e.count;t<r;t++)Tn.fromBufferAttribute(e,t),Tn.normalize(),e.setXYZ(t,Tn.x,Tn.y,Tn.z)}toNonIndexed(){function e(a,c){const l=a.array,u=a.itemSize,h=a.normalized,d=new l.constructor(c.length*u);let p=0,_=0;for(let g=0,f=c.length;g<f;g++){a.isInterleavedBufferAttribute?p=c[g]*a.data.stride+a.offset:p=c[g]*u;for(let m=0;m<u;m++)d[_++]=l[p++]}return new Lt(d,u,h)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new sn,r=this.index.array,s=this.attributes;for(const a in s){const c=s[a],l=e(c,r);t.setAttribute(a,l)}const i=this.morphAttributes;for(const a in i){const c=[],l=i[a];for(let u=0,h=l.length;u<h;u++){const d=l[u],p=e(d,r);c.push(p)}t.morphAttributes[a]=c}t.morphTargetsRelative=this.morphTargetsRelative;const o=this.groups;for(let a=0,c=o.length;a<c;a++){const l=o[a];t.addGroup(l.start,l.count,l.materialIndex)}return t}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,this.name!==""&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),this.parameters!==void 0){const c=this.parameters;for(const l in c)c[l]!==void 0&&(e[l]=c[l]);return e}e.data={attributes:{}};const t=this.index;t!==null&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const r=this.attributes;for(const c in r){const l=r[c];e.data.attributes[c]=l.toJSON(e.data)}const s={};let i=!1;for(const c in this.morphAttributes){const l=this.morphAttributes[c],u=[];for(let h=0,d=l.length;h<d;h++){const p=l[h];u.push(p.toJSON(e.data))}u.length>0&&(s[c]=u,i=!0)}i&&(e.data.morphAttributes=s,e.data.morphTargetsRelative=this.morphTargetsRelative);const o=this.groups;o.length>0&&(e.data.groups=JSON.parse(JSON.stringify(o)));const a=this.boundingSphere;return a!==null&&(e.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),e}clone(){return new this.constructor().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const r=e.index;r!==null&&this.setIndex(r.clone(t));const s=e.attributes;for(const l in s){const u=s[l];this.setAttribute(l,u.clone(t))}const i=e.morphAttributes;for(const l in i){const u=[],h=i[l];for(let d=0,p=h.length;d<p;d++)u.push(h[d].clone(t));this.morphAttributes[l]=u}this.morphTargetsRelative=e.morphTargetsRelative;const o=e.groups;for(let l=0,u=o.length;l<u;l++){const h=o[l];this.addGroup(h.start,h.count,h.materialIndex)}const a=e.boundingBox;a!==null&&(this.boundingBox=a.clone());const c=e.boundingSphere;return c!==null&&(this.boundingSphere=c.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const ex=new qe,to=new ni,Yu=new vr,tx=new T,na=new T,ra=new T,sa=new T,Af=new T,Ku=new T,Zu=new W,Ju=new W,Qu=new W,nx=new T,rx=new T,sx=new T,eh=new T,th=new T;class Jt extends wt{constructor(e=new sn,t=new _u){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),e.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),e.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,r=Object.keys(t);if(r.length>0){const s=t[r[0]];if(s!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let i=0,o=s.length;i<o;i++){const a=s[i].name||String(i);this.morphTargetInfluences.push(0),this.morphTargetDictionary[a]=i}}}}getVertexPosition(e,t){const r=this.geometry,s=r.attributes.position,i=r.morphAttributes.position,o=r.morphTargetsRelative;t.fromBufferAttribute(s,e);const a=this.morphTargetInfluences;if(i&&a){Ku.set(0,0,0);for(let c=0,l=i.length;c<l;c++){const u=a[c],h=i[c];u!==0&&(Af.fromBufferAttribute(h,e),o?Ku.addScaledVector(Af,u):Ku.addScaledVector(Af.sub(t),u))}t.add(Ku)}return t}raycast(e,t){const r=this.geometry,s=this.material,i=this.matrixWorld;s!==void 0&&(r.boundingSphere===null&&r.computeBoundingSphere(),Yu.copy(r.boundingSphere),Yu.applyMatrix4(i),to.copy(e.ray).recast(e.near),!(Yu.containsPoint(to.origin)===!1&&(to.intersectSphere(Yu,tx)===null||to.origin.distanceToSquared(tx)>(e.far-e.near)**2))&&(ex.copy(i).invert(),to.copy(e.ray).applyMatrix4(ex),!(r.boundingBox!==null&&to.intersectsBox(r.boundingBox)===!1)&&this._computeIntersections(e,t,to)))}_computeIntersections(e,t,r){let s;const i=this.geometry,o=this.material,a=i.index,c=i.attributes.position,l=i.attributes.uv,u=i.attributes.uv1,h=i.attributes.normal,d=i.groups,p=i.drawRange;if(a!==null)if(Array.isArray(o))for(let _=0,g=d.length;_<g;_++){const f=d[_],m=o[f.materialIndex],y=Math.max(f.start,p.start),v=Math.min(a.count,Math.min(f.start+f.count,p.start+p.count));for(let b=y,x=v;b<x;b+=3){const E=a.getX(b),S=a.getX(b+1),R=a.getX(b+2);s=nh(this,m,e,r,l,u,h,E,S,R),s&&(s.faceIndex=Math.floor(b/3),s.face.materialIndex=f.materialIndex,t.push(s))}}else{const _=Math.max(0,p.start),g=Math.min(a.count,p.start+p.count);for(let f=_,m=g;f<m;f+=3){const y=a.getX(f),v=a.getX(f+1),b=a.getX(f+2);s=nh(this,o,e,r,l,u,h,y,v,b),s&&(s.faceIndex=Math.floor(f/3),t.push(s))}}else if(c!==void 0)if(Array.isArray(o))for(let _=0,g=d.length;_<g;_++){const f=d[_],m=o[f.materialIndex],y=Math.max(f.start,p.start),v=Math.min(c.count,Math.min(f.start+f.count,p.start+p.count));for(let b=y,x=v;b<x;b+=3){const E=b,S=b+1,R=b+2;s=nh(this,m,e,r,l,u,h,E,S,R),s&&(s.faceIndex=Math.floor(b/3),s.face.materialIndex=f.materialIndex,t.push(s))}}else{const _=Math.max(0,p.start),g=Math.min(c.count,p.start+p.count);for(let f=_,m=g;f<m;f+=3){const y=f,v=f+1,b=f+2;s=nh(this,o,e,r,l,u,h,y,v,b),s&&(s.faceIndex=Math.floor(f/3),t.push(s))}}}}function wN(n,e,t,r,s,i,o,a){let c;if(e.side===bn?c=r.intersectTriangle(o,i,s,!0,a):c=r.intersectTriangle(s,i,o,e.side===In,a),c===null)return null;th.copy(a),th.applyMatrix4(n.matrixWorld);const l=t.ray.origin.distanceTo(th);return l<t.near||l>t.far?null:{distance:l,point:th.clone(),object:n}}function nh(n,e,t,r,s,i,o,a,c,l){n.getVertexPosition(a,na),n.getVertexPosition(c,ra),n.getVertexPosition(l,sa);const u=wN(n,e,t,r,na,ra,sa,eh);if(u){s&&(Zu.fromBufferAttribute(s,a),Ju.fromBufferAttribute(s,c),Qu.fromBufferAttribute(s,l),u.uv=Fn.getInterpolation(eh,na,ra,sa,Zu,Ju,Qu,new W)),i&&(Zu.fromBufferAttribute(i,a),Ju.fromBufferAttribute(i,c),Qu.fromBufferAttribute(i,l),u.uv1=Fn.getInterpolation(eh,na,ra,sa,Zu,Ju,Qu,new W),u.uv2=u.uv1),o&&(nx.fromBufferAttribute(o,a),rx.fromBufferAttribute(o,c),sx.fromBufferAttribute(o,l),u.normal=Fn.getInterpolation(eh,na,ra,sa,nx,rx,sx,new T),u.normal.dot(r.direction)>0&&u.normal.multiplyScalar(-1));const h={a,b:c,c:l,normal:new T,materialIndex:0};Fn.getNormal(na,ra,sa,h.normal),u.face=h}return u}class vc extends sn{constructor(e=1,t=1,r=1,s=1,i=1,o=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:s,heightSegments:i,depthSegments:o};const a=this;s=Math.floor(s),i=Math.floor(i),o=Math.floor(o);const c=[],l=[],u=[],h=[];let d=0,p=0;_("z","y","x",-1,-1,r,t,e,o,i,0),_("z","y","x",1,-1,r,t,-e,o,i,1),_("x","z","y",1,1,e,r,t,s,o,2),_("x","z","y",1,-1,e,r,-t,s,o,3),_("x","y","z",1,-1,e,t,r,s,i,4),_("x","y","z",-1,-1,e,t,-r,s,i,5),this.setIndex(c),this.setAttribute("position",new gt(l,3)),this.setAttribute("normal",new gt(u,3)),this.setAttribute("uv",new gt(h,2));function _(g,f,m,y,v,b,x,E,S,R,C){const M=b/S,G=x/R,F=b/2,X=x/2,N=E/2,j=S+1,K=R+1;let $=0,q=0;const ne=new T;for(let le=0;le<K;le++){const ue=le*G-X;for(let Ee=0;Ee<j;Ee++){const de=Ee*M-F;ne[g]=de*y,ne[f]=ue*v,ne[m]=N,l.push(ne.x,ne.y,ne.z),ne[g]=0,ne[f]=0,ne[m]=E>0?1:-1,u.push(ne.x,ne.y,ne.z),h.push(Ee/S),h.push(1-le/R),$+=1}}for(let le=0;le<R;le++)for(let ue=0;ue<S;ue++){const Ee=d+ue+j*le,de=d+ue+j*(le+1),V=d+(ue+1)+j*(le+1),B=d+(ue+1)+j*le;c.push(Ee,de,B),c.push(de,V,B),q+=6}a.addGroup(p,q,C),p+=q,d+=$}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new vc(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function sc(n){const e={};for(const t in n){e[t]={};for(const r in n[t]){const s=n[t][r];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?s.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),e[t][r]=null):e[t][r]=s.clone():Array.isArray(s)?e[t][r]=s.slice():e[t][r]=s}}return e}function Yn(n){const e={};for(let t=0;t<n.length;t++){const r=sc(n[t]);for(const s in r)e[s]=r[s]}return e}function ON(n){const e=[];for(let t=0;t<n.length;t++)e.push(n[t].clone());return e}function WA(n){return n.getRenderTarget()===null?n.outputColorSpace:Rt.workingColorSpace}const XA={clone:sc,merge:Yn};var PN=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,NN=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;class Kn extends gn{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=PN,this.fragmentShader=NN,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,e!==void 0&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=sc(e.uniforms),this.uniformsGroups=ON(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const s in this.uniforms){const o=this.uniforms[s].value;o&&o.isTexture?t.uniforms[s]={type:"t",value:o.toJSON(e).uuid}:o&&o.isColor?t.uniforms[s]={type:"c",value:o.getHex()}:o&&o.isVector2?t.uniforms[s]={type:"v2",value:o.toArray()}:o&&o.isVector3?t.uniforms[s]={type:"v3",value:o.toArray()}:o&&o.isVector4?t.uniforms[s]={type:"v4",value:o.toArray()}:o&&o.isMatrix3?t.uniforms[s]={type:"m3",value:o.toArray()}:o&&o.isMatrix4?t.uniforms[s]={type:"m4",value:o.toArray()}:t.uniforms[s]={value:o}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const r={};for(const s in this.extensions)this.extensions[s]===!0&&(r[s]=!0);return Object.keys(r).length>0&&(t.extensions=r),t}}class $A extends wt{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new qe,this.projectionMatrix=new qe,this.projectionMatrixInverse=new qe,this.coordinateSystem=js}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}class Un extends $A{constructor(e=50,t=1,r=.1,s=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=r,this.far=s,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=e.view===null?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=rc*2*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(ml*.5*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return rc*2*Math.atan(Math.tan(ml*.5*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(e,t,r,s,i,o){this.aspect=e/t,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=s,this.view.width=i,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(ml*.5*this.fov)/this.zoom,r=2*t,s=this.aspect*r,i=-.5*s;const o=this.view;if(this.view!==null&&this.view.enabled){const c=o.fullWidth,l=o.fullHeight;i+=o.offsetX*s/c,t-=o.offsetY*r/l,s*=o.width/c,r*=o.height/l}const a=this.filmOffset;a!==0&&(i+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+s,t,t-r,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,this.view!==null&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const ia=-90,oa=1;class IN extends wt{constructor(e,t,r){super(),this.type="CubeCamera",this.renderTarget=r,this.coordinateSystem=null,this.activeMipmapLevel=0;const s=new Un(ia,oa,e,t);s.layers=this.layers,this.add(s);const i=new Un(ia,oa,e,t);i.layers=this.layers,this.add(i);const o=new Un(ia,oa,e,t);o.layers=this.layers,this.add(o);const a=new Un(ia,oa,e,t);a.layers=this.layers,this.add(a);const c=new Un(ia,oa,e,t);c.layers=this.layers,this.add(c);const l=new Un(ia,oa,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[r,s,i,o,a,c]=t;for(const l of t)this.remove(l);if(e===js)r.up.set(0,1,0),r.lookAt(1,0,0),s.up.set(0,1,0),s.lookAt(-1,0,0),i.up.set(0,0,-1),i.lookAt(0,1,0),o.up.set(0,0,1),o.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),c.up.set(0,1,0),c.lookAt(0,0,-1);else if(e===Fd)r.up.set(0,-1,0),r.lookAt(-1,0,0),s.up.set(0,-1,0),s.lookAt(1,0,0),i.up.set(0,0,1),i.lookAt(0,1,0),o.up.set(0,0,-1),o.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),c.up.set(0,-1,0),c.lookAt(0,0,-1);else throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);for(const l of t)this.add(l),l.updateMatrixWorld()}update(e,t){this.parent===null&&this.updateMatrixWorld();const{renderTarget:r,activeMipmapLevel:s}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[i,o,a,c,l,u]=this.children,h=e.getRenderTarget(),d=e.getActiveCubeFace(),p=e.getActiveMipmapLevel(),_=e.xr.enabled;e.xr.enabled=!1;const g=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,e.setRenderTarget(r,0,s),e.render(t,i),e.setRenderTarget(r,1,s),e.render(t,o),e.setRenderTarget(r,2,s),e.render(t,a),e.setRenderTarget(r,3,s),e.render(t,c),e.setRenderTarget(r,4,s),e.render(t,l),r.texture.generateMipmaps=g,e.setRenderTarget(r,5,s),e.render(t,u),e.setRenderTarget(h,d,p),e.xr.enabled=_,r.texture.needsPMREMUpdate=!0}}class qA extends Wn{constructor(e,t,r,s,i,o,a,c,l,u){e=e!==void 0?e:[],t=t!==void 0?t:Qa,super(e,t,r,s,i,o,a,c,l,u),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class DN extends Br{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const r={width:e,height:e,depth:1},s=[r,r,r,r,r,r];t.encoding!==void 0&&(gl("THREE.WebGLCubeRenderTarget: option.encoding has been replaced by option.colorSpace."),t.colorSpace=t.encoding===Mo?nn:xn),this.texture=new qA(s,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=t.generateMipmaps!==void 0?t.generateMipmaps:!1,this.texture.minFilter=t.minFilter!==void 0?t.minFilter:Or}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const r={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},s=new vc(5,5,5),i=new Kn({name:"CubemapFromEquirect",uniforms:sc(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:bn,blending:$s});i.uniforms.tEquirect.value=t;const o=new Jt(s,i),a=t.minFilter;return t.minFilter===Dl&&(t.minFilter=Or),new IN(1,10,this).update(e,o),t.minFilter=a,o.geometry.dispose(),o.material.dispose(),this}clear(e,t,r,s){const i=e.getRenderTarget();for(let o=0;o<6;o++)e.setRenderTarget(this,o),e.clear(t,r,s);e.setRenderTarget(i)}}const Tf=new T,LN=new T,FN=new nt;class ar{constructor(e=new T(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,r,s){return this.normal.set(e,t,r),this.constant=s,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,r){const s=Tf.subVectors(r,t).cross(LN.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const r=e.delta(Tf),s=this.normal.dot(r);if(s===0)return this.distanceToPoint(e.start)===0?t.copy(e.start):null;const i=-(e.start.dot(this.normal)+this.constant)/s;return i<0||i>1?null:t.copy(e.start).addScaledVector(r,i)}intersectsLine(e){const t=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return t<0&&r>0||r<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const r=t||FN.getNormalMatrix(e),s=this.coplanarPoint(Tf).applyMatrix4(e),i=this.normal.applyMatrix3(r).normalize();return this.constant=-s.dot(i),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}const no=new vr,rh=new T;class Ug{constructor(e=new ar,t=new ar,r=new ar,s=new ar,i=new ar,o=new ar){this.planes=[e,t,r,s,i,o]}set(e,t,r,s,i,o){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(r),a[3].copy(s),a[4].copy(i),a[5].copy(o),this}copy(e){const t=this.planes;for(let r=0;r<6;r++)t[r].copy(e.planes[r]);return this}setFromProjectionMatrix(e,t=js){const r=this.planes,s=e.elements,i=s[0],o=s[1],a=s[2],c=s[3],l=s[4],u=s[5],h=s[6],d=s[7],p=s[8],_=s[9],g=s[10],f=s[11],m=s[12],y=s[13],v=s[14],b=s[15];if(r[0].setComponents(c-i,d-l,f-p,b-m).normalize(),r[1].setComponents(c+i,d+l,f+p,b+m).normalize(),r[2].setComponents(c+o,d+u,f+_,b+y).normalize(),r[3].setComponents(c-o,d-u,f-_,b-y).normalize(),r[4].setComponents(c-a,d-h,f-g,b-v).normalize(),t===js)r[5].setComponents(c+a,d+h,f+g,b+v).normalize();else if(t===Fd)r[5].setComponents(a,h,g,v).normalize();else throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);return this}intersectsObject(e){if(e.boundingSphere!==void 0)e.boundingSphere===null&&e.computeBoundingSphere(),no.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;t.boundingSphere===null&&t.computeBoundingSphere(),no.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(no)}intersectsSprite(e){return no.center.set(0,0,0),no.radius=.7071067811865476,no.applyMatrix4(e.matrixWorld),this.intersectsSphere(no)}intersectsSphere(e){const t=this.planes,r=e.center,s=-e.radius;for(let i=0;i<6;i++)if(t[i].distanceToPoint(r)<s)return!1;return!0}intersectsBox(e){const t=this.planes;for(let r=0;r<6;r++){const s=t[r];if(rh.x=s.normal.x>0?e.max.x:e.min.x,rh.y=s.normal.y>0?e.max.y:e.min.y,rh.z=s.normal.z>0?e.max.z:e.min.z,s.distanceToPoint(rh)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let r=0;r<6;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}function YA(){let n=null,e=!1,t=null,r=null;function s(i,o){t(i,o),r=n.requestAnimationFrame(s)}return{start:function(){e!==!0&&t!==null&&(r=n.requestAnimationFrame(s),e=!0)},stop:function(){n.cancelAnimationFrame(r),e=!1},setAnimationLoop:function(i){t=i},setContext:function(i){n=i}}}function UN(n,e){const t=e.isWebGL2,r=new WeakMap;function s(l,u){const h=l.array,d=l.usage,p=h.byteLength,_=n.createBuffer();n.bindBuffer(u,_),n.bufferData(u,h,d),l.onUploadCallback();let g;if(h instanceof Float32Array)g=n.FLOAT;else if(h instanceof Uint16Array)if(l.isFloat16BufferAttribute)if(t)g=n.HALF_FLOAT;else throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");else g=n.UNSIGNED_SHORT;else if(h instanceof Int16Array)g=n.SHORT;else if(h instanceof Uint32Array)g=n.UNSIGNED_INT;else if(h instanceof Int32Array)g=n.INT;else if(h instanceof Int8Array)g=n.BYTE;else if(h instanceof Uint8Array)g=n.UNSIGNED_BYTE;else if(h instanceof Uint8ClampedArray)g=n.UNSIGNED_BYTE;else throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+h);return{buffer:_,type:g,bytesPerElement:h.BYTES_PER_ELEMENT,version:l.version,size:p}}function i(l,u,h){const d=u.array,p=u._updateRange,_=u.updateRanges;if(n.bindBuffer(h,l),p.count===-1&&_.length===0&&n.bufferSubData(h,0,d),_.length!==0){for(let g=0,f=_.length;g<f;g++){const m=_[g];t?n.bufferSubData(h,m.start*d.BYTES_PER_ELEMENT,d,m.start,m.count):n.bufferSubData(h,m.start*d.BYTES_PER_ELEMENT,d.subarray(m.start,m.start+m.count))}u.clearUpdateRanges()}p.count!==-1&&(t?n.bufferSubData(h,p.offset*d.BYTES_PER_ELEMENT,d,p.offset,p.count):n.bufferSubData(h,p.offset*d.BYTES_PER_ELEMENT,d.subarray(p.offset,p.offset+p.count)),p.count=-1),u.onUploadCallback()}function o(l){return l.isInterleavedBufferAttribute&&(l=l.data),r.get(l)}function a(l){l.isInterleavedBufferAttribute&&(l=l.data);const u=r.get(l);u&&(n.deleteBuffer(u.buffer),r.delete(l))}function c(l,u){if(l.isGLBufferAttribute){const d=r.get(l);(!d||d.version<l.version)&&r.set(l,{buffer:l.buffer,type:l.type,bytesPerElement:l.elementSize,version:l.version});return}l.isInterleavedBufferAttribute&&(l=l.data);const h=r.get(l);if(h===void 0)r.set(l,s(l,u));else if(h.version<l.version){if(h.size!==l.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");i(h.buffer,l,u),h.version=l.version}}return{get:o,remove:a,update:c}}class fp extends sn{constructor(e=1,t=1,r=1,s=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:s};const i=e/2,o=t/2,a=Math.floor(r),c=Math.floor(s),l=a+1,u=c+1,h=e/a,d=t/c,p=[],_=[],g=[],f=[];for(let m=0;m<u;m++){const y=m*d-o;for(let v=0;v<l;v++){const b=v*h-i;_.push(b,-y,0),g.push(0,0,1),f.push(v/a),f.push(1-m/c)}}for(let m=0;m<c;m++)for(let y=0;y<a;y++){const v=y+l*m,b=y+l*(m+1),x=y+1+l*(m+1),E=y+1+l*m;p.push(v,b,E),p.push(b,x,E)}this.setIndex(p),this.setAttribute("position",new gt(_,3)),this.setAttribute("normal",new gt(g,3)),this.setAttribute("uv",new gt(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new fp(e.width,e.height,e.widthSegments,e.heightSegments)}}var kN=`#ifdef USE_ALPHAHASH
	if ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;
#endif`,BN=`#ifdef USE_ALPHAHASH
	const float ALPHA_HASH_SCALE = 0.05;
	float hash2D( vec2 value ) {
		return fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );
	}
	float hash3D( vec3 value ) {
		return hash2D( vec2( hash2D( value.xy ), value.z ) );
	}
	float getAlphaHashThreshold( vec3 position ) {
		float maxDeriv = max(
			length( dFdx( position.xyz ) ),
			length( dFdy( position.xyz ) )
		);
		float pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );
		vec2 pixScales = vec2(
			exp2( floor( log2( pixScale ) ) ),
			exp2( ceil( log2( pixScale ) ) )
		);
		vec2 alpha = vec2(
			hash3D( floor( pixScales.x * position.xyz ) ),
			hash3D( floor( pixScales.y * position.xyz ) )
		);
		float lerpFactor = fract( log2( pixScale ) );
		float x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;
		float a = min( lerpFactor, 1.0 - lerpFactor );
		vec3 cases = vec3(
			x * x / ( 2.0 * a * ( 1.0 - a ) ),
			( x - 0.5 * a ) / ( 1.0 - a ),
			1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )
		);
		float threshold = ( x < ( 1.0 - a ) )
			? ( ( x < a ) ? cases.x : cases.y )
			: cases.z;
		return clamp( threshold , 1.0e-6, 1.0 );
	}
#endif`,GN=`#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;
#endif`,VN=`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,zN=`#ifdef USE_ALPHATEST
	if ( diffuseColor.a < alphaTest ) discard;
#endif`,HN=`#ifdef USE_ALPHATEST
	uniform float alphaTest;
#endif`,jN=`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_CLEARCOAT ) 
		clearcoatSpecularIndirect *= ambientOcclusion;
	#endif
	#if defined( USE_SHEEN ) 
		sheenSpecularIndirect *= ambientOcclusion;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometryNormal, geometryViewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );
	#endif
#endif`,WN=`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,XN=`#ifdef USE_BATCHING
	attribute float batchId;
	uniform highp sampler2D batchingTexture;
	mat4 getBatchingMatrix( const in float i ) {
		int size = textureSize( batchingTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );
		return mat4( v1, v2, v3, v4 );
	}
#endif`,$N=`#ifdef USE_BATCHING
	mat4 batchingMatrix = getBatchingMatrix( batchId );
#endif`,qN=`vec3 transformed = vec3( position );
#ifdef USE_ALPHAHASH
	vPosition = vec3( position );
#endif`,YN=`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,KN=`float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( specularColor, 1.0, dotVH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
} // validated`,ZN=`#ifdef USE_IRIDESCENCE
	const mat3 XYZ_TO_REC709 = mat3(
		 3.2404542, -0.9692660,  0.0556434,
		-1.5371385,  1.8760108, -0.2040259,
		-0.4985314,  0.0415560,  1.0572252
	);
	vec3 Fresnel0ToIor( vec3 fresnel0 ) {
		vec3 sqrtF0 = sqrt( fresnel0 );
		return ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );
	}
	vec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );
	}
	float IorToFresnel0( float transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));
	}
	vec3 evalSensitivity( float OPD, vec3 shift ) {
		float phase = 2.0 * PI * OPD * 1.0e-9;
		vec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );
		vec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );
		vec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );
		vec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );
		xyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );
		xyz /= 1.0685e-7;
		vec3 rgb = XYZ_TO_REC709 * xyz;
		return rgb;
	}
	vec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {
		vec3 I;
		float iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );
		float sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );
		float cosTheta2Sq = 1.0 - sinTheta2Sq;
		if ( cosTheta2Sq < 0.0 ) {
			return vec3( 1.0 );
		}
		float cosTheta2 = sqrt( cosTheta2Sq );
		float R0 = IorToFresnel0( iridescenceIOR, outsideIOR );
		float R12 = F_Schlick( R0, 1.0, cosTheta1 );
		float T121 = 1.0 - R12;
		float phi12 = 0.0;
		if ( iridescenceIOR < outsideIOR ) phi12 = PI;
		float phi21 = PI - phi12;
		vec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );		vec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );
		vec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );
		vec3 phi23 = vec3( 0.0 );
		if ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;
		if ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;
		if ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;
		float OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;
		vec3 phi = vec3( phi21 ) + phi23;
		vec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );
		vec3 r123 = sqrt( R123 );
		vec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );
		vec3 C0 = R12 + Rs;
		I = C0;
		vec3 Cm = Rs - T121;
		for ( int m = 1; m <= 2; ++ m ) {
			Cm *= r123;
			vec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );
			I += Cm * Sm;
		}
		return max( I, vec3( 0.0 ) );
	}
#endif`,JN=`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vBumpMapUv );
		vec2 dSTdy = dFdy( vBumpMapUv );
		float Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {
		vec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );
		vec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 ) * faceDirection;
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,QN=`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#pragma unroll_loop_start
	for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
		plane = clippingPlanes[ i ];
		if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
	}
	#pragma unroll_loop_end
	#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
		bool clipped = true;
		#pragma unroll_loop_start
		for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
		}
		#pragma unroll_loop_end
		if ( clipped ) discard;
	#endif
#endif`,e1=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,t1=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,n1=`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,r1=`#if defined( USE_COLOR_ALPHA )
	diffuseColor *= vColor;
#elif defined( USE_COLOR )
	diffuseColor.rgb *= vColor;
#endif`,s1=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR )
	varying vec3 vColor;
#endif`,i1=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	varying vec3 vColor;
#endif`,o1=`#if defined( USE_COLOR_ALPHA )
	vColor = vec4( 1.0 );
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )
	vColor = vec3( 1.0 );
#endif
#ifdef USE_COLOR
	vColor *= color;
#endif
#ifdef USE_INSTANCING_COLOR
	vColor.xyz *= instanceColor.xyz;
#endif`,a1=`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement( a ) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
vec3 pow2( const in vec3 x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }
float average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract( sin( sn ) * c );
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
#ifdef USE_ALPHAHASH
	varying vec3 vPosition;
#endif
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
float luminance( const in vec3 rgb ) {
	const vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );
	return dot( weights, rgb );
}
bool isPerspectiveMatrix( mat4 m ) {
	return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}
vec3 BRDF_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
}
float F_Schlick( const in float f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
} // validated`,c1=`#ifdef ENVMAP_TYPE_CUBE_UV
	#define cubeUV_minMipLevel 4.0
	#define cubeUV_minTileSize 16.0
	float getFace( vec3 direction ) {
		vec3 absDirection = abs( direction );
		float face = - 1.0;
		if ( absDirection.x > absDirection.z ) {
			if ( absDirection.x > absDirection.y )
				face = direction.x > 0.0 ? 0.0 : 3.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		} else {
			if ( absDirection.z > absDirection.y )
				face = direction.z > 0.0 ? 2.0 : 5.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		}
		return face;
	}
	vec2 getUV( vec3 direction, float face ) {
		vec2 uv;
		if ( face == 0.0 ) {
			uv = vec2( direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 1.0 ) {
			uv = vec2( - direction.x, - direction.z ) / abs( direction.y );
		} else if ( face == 2.0 ) {
			uv = vec2( - direction.x, direction.y ) / abs( direction.z );
		} else if ( face == 3.0 ) {
			uv = vec2( - direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 4.0 ) {
			uv = vec2( - direction.x, direction.z ) / abs( direction.y );
		} else {
			uv = vec2( direction.x, direction.y ) / abs( direction.z );
		}
		return 0.5 * ( uv + 1.0 );
	}
	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {
		float face = getFace( direction );
		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );
		mipInt = max( mipInt, cubeUV_minMipLevel );
		float faceSize = exp2( mipInt );
		highp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;
		if ( face > 2.0 ) {
			uv.y += faceSize;
			face -= 3.0;
		}
		uv.x += face * faceSize;
		uv.x += filterInt * 3.0 * cubeUV_minTileSize;
		uv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );
		uv.x *= CUBEUV_TEXEL_WIDTH;
		uv.y *= CUBEUV_TEXEL_HEIGHT;
		#ifdef texture2DGradEXT
			return texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;
		#else
			return texture2D( envMap, uv ).rgb;
		#endif
	}
	#define cubeUV_r0 1.0
	#define cubeUV_v0 0.339
	#define cubeUV_m0 - 2.0
	#define cubeUV_r1 0.8
	#define cubeUV_v1 0.276
	#define cubeUV_m1 - 1.0
	#define cubeUV_r4 0.4
	#define cubeUV_v4 0.046
	#define cubeUV_m4 2.0
	#define cubeUV_r5 0.305
	#define cubeUV_v5 0.016
	#define cubeUV_m5 3.0
	#define cubeUV_r6 0.21
	#define cubeUV_v6 0.0038
	#define cubeUV_m6 4.0
	float roughnessToMip( float roughness ) {
		float mip = 0.0;
		if ( roughness >= cubeUV_r1 ) {
			mip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;
		} else if ( roughness >= cubeUV_r4 ) {
			mip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;
		} else if ( roughness >= cubeUV_r5 ) {
			mip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;
		} else if ( roughness >= cubeUV_r6 ) {
			mip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;
		} else {
			mip = - 2.0 * log2( 1.16 * roughness );		}
		return mip;
	}
	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {
		float mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );
		float mipF = fract( mip );
		float mipInt = floor( mip );
		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );
		if ( mipF == 0.0 ) {
			return vec4( color0, 1.0 );
		} else {
			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );
			return vec4( mix( color0, color1, mipF ), 1.0 );
		}
	}
#endif`,l1=`vec3 transformedNormal = objectNormal;
#ifdef USE_TANGENT
	vec3 transformedTangent = objectTangent;
#endif
#ifdef USE_BATCHING
	mat3 bm = mat3( batchingMatrix );
	transformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );
	transformedNormal = bm * transformedNormal;
	#ifdef USE_TANGENT
		transformedTangent = bm * transformedTangent;
	#endif
#endif
#ifdef USE_INSTANCING
	mat3 im = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );
	transformedNormal = im * transformedNormal;
	#ifdef USE_TANGENT
		transformedTangent = im * transformedTangent;
	#endif
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	transformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,u1=`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,h1=`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );
#endif`,d1=`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,p1=`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,f1="gl_FragColor = linearToOutputTexel( gl_FragColor );",m1=`
const mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(
	vec3( 0.8224621, 0.177538, 0.0 ),
	vec3( 0.0331941, 0.9668058, 0.0 ),
	vec3( 0.0170827, 0.0723974, 0.9105199 )
);
const mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(
	vec3( 1.2249401, - 0.2249404, 0.0 ),
	vec3( - 0.0420569, 1.0420571, 0.0 ),
	vec3( - 0.0196376, - 0.0786361, 1.0982735 )
);
vec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {
	return vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );
}
vec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {
	return vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );
}
vec4 LinearTransferOETF( in vec4 value ) {
	return value;
}
vec4 sRGBTransferOETF( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}
vec4 LinearToLinear( in vec4 value ) {
	return value;
}
vec4 LinearTosRGB( in vec4 value ) {
	return sRGBTransferOETF( value );
}`,_1=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,g1=`#ifdef USE_ENVMAP
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
	
#endif`,v1=`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,y1=`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,x1=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) {
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,b1=`#ifdef USE_FOG
	vFogDepth = - mvPosition.z;
#endif`,C1=`#ifdef USE_FOG
	varying float vFogDepth;
#endif`,E1=`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,S1=`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float vFogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,A1=`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return vec3( texture2D( gradientMap, coord ).r );
	#else
		vec2 fw = fwidth( coord ) * 0.5;
		return mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );
	#endif
}`,T1=`#ifdef USE_LIGHTMAP
	vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
	vec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;
	reflectedLight.indirectDiffuse += lightMapIrradiance;
#endif`,M1=`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,R1=`LambertMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularStrength = specularStrength;`,w1=`varying vec3 vViewPosition;
struct LambertMaterial {
	vec3 diffuseColor;
	float specularStrength;
};
void RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Lambert
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Lambert`,O1=`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
#if defined( USE_LIGHT_PROBES )
	uniform vec3 lightProbe[ 9 ];
#endif
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {
	vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	return irradiance;
}
float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
	#if defined ( LEGACY_LIGHTS )
		if ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {
			return pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );
		}
		return 1.0;
	#else
		float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
		if ( cutoffDistance > 0.0 ) {
			distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
		}
		return distanceFalloff;
	#endif
}
float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {
	return smoothstep( coneCosine, penumbraCosine, angleCosine );
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {
		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = pointLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float lightDistance = length( lVector );
		light.color = pointLight.color;
		light.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = spotLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float angleCos = dot( light.direction, spotLight.direction );
		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );
		if ( spotAttenuation > 0.0 ) {
			float lightDistance = length( lVector );
			light.color = spotLight.color * spotAttenuation;
			light.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );
		} else {
			light.color = vec3( 0.0 );
			light.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {
		float dotNL = dot( normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		return irradiance;
	}
#endif`,P1=`#ifdef USE_ENVMAP
	vec3 getIBLIrradiance( const in vec3 normal ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
			vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );
			return PI * envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
			vec3 reflectVec = reflect( - viewDir, normal );
			reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );
			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );
			return envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	#ifdef USE_ANISOTROPY
		vec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {
			#ifdef ENVMAP_TYPE_CUBE_UV
				vec3 bentNormal = cross( bitangent, viewDir );
				bentNormal = normalize( cross( bentNormal, bitangent ) );
				bentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );
				return getIBLRadiance( viewDir, bentNormal, roughness );
			#else
				return vec3( 0.0 );
			#endif
		}
	#endif
#endif`,N1=`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,I1=`varying vec3 vViewPosition;
struct ToonMaterial {
	vec3 diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon`,D1=`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,L1=`varying vec3 vViewPosition;
struct BlinnPhongMaterial {
	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong`,F1=`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );
vec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;
material.roughness = min( material.roughness, 1.0 );
#ifdef IOR
	material.ior = ior;
	#ifdef USE_SPECULAR
		float specularIntensityFactor = specularIntensity;
		vec3 specularColorFactor = specularColor;
		#ifdef USE_SPECULAR_COLORMAP
			specularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;
		#endif
		#ifdef USE_SPECULAR_INTENSITYMAP
			specularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;
		#endif
		material.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );
	#else
		float specularIntensityFactor = 1.0;
		vec3 specularColorFactor = vec3( 1.0 );
		material.specularF90 = 1.0;
	#endif
	material.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );
	material.specularF90 = 1.0;
#endif
#ifdef USE_CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	material.clearcoatF0 = vec3( 0.04 );
	material.clearcoatF90 = 1.0;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_IRIDESCENCE
	material.iridescence = iridescence;
	material.iridescenceIOR = iridescenceIOR;
	#ifdef USE_IRIDESCENCEMAP
		material.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;
	#endif
	#ifdef USE_IRIDESCENCE_THICKNESSMAP
		material.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;
	#else
		material.iridescenceThickness = iridescenceThicknessMaximum;
	#endif
#endif
#ifdef USE_SHEEN
	material.sheenColor = sheenColor;
	#ifdef USE_SHEEN_COLORMAP
		material.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;
	#endif
	material.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );
	#ifdef USE_SHEEN_ROUGHNESSMAP
		material.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;
	#endif
#endif
#ifdef USE_ANISOTROPY
	#ifdef USE_ANISOTROPYMAP
		mat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );
		vec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;
		vec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;
	#else
		vec2 anisotropyV = anisotropyVector;
	#endif
	material.anisotropy = length( anisotropyV );
	if( material.anisotropy == 0.0 ) {
		anisotropyV = vec2( 1.0, 0.0 );
	} else {
		anisotropyV /= material.anisotropy;
		material.anisotropy = saturate( material.anisotropy );
	}
	material.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );
	material.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;
	material.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;
#endif`,U1=`struct PhysicalMaterial {
	vec3 diffuseColor;
	float roughness;
	vec3 specularColor;
	float specularF90;
	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif
	#ifdef USE_IRIDESCENCE
		float iridescence;
		float iridescenceIOR;
		float iridescenceThickness;
		vec3 iridescenceFresnel;
		vec3 iridescenceF0;
	#endif
	#ifdef USE_SHEEN
		vec3 sheenColor;
		float sheenRoughness;
	#endif
	#ifdef IOR
		float ior;
	#endif
	#ifdef USE_TRANSMISSION
		float transmission;
		float transmissionAlpha;
		float thickness;
		float attenuationDistance;
		vec3 attenuationColor;
	#endif
	#ifdef USE_ANISOTROPY
		float anisotropy;
		float alphaT;
		vec3 anisotropyT;
		vec3 anisotropyB;
	#endif
};
vec3 clearcoatSpecularDirect = vec3( 0.0 );
vec3 clearcoatSpecularIndirect = vec3( 0.0 );
vec3 sheenSpecularDirect = vec3( 0.0 );
vec3 sheenSpecularIndirect = vec3(0.0 );
vec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {
    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );
    float x2 = x * x;
    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );
    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );
}
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
#ifdef USE_ANISOTROPY
	float V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {
		float gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );
		float gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );
		float v = 0.5 / ( gv + gl );
		return saturate(v);
	}
	float D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {
		float a2 = alphaT * alphaB;
		highp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );
		highp float v2 = dot( v, v );
		float w2 = a2 / v2;
		return RECIPROCAL_PI * a2 * pow2 ( w2 );
	}
#endif
#ifdef USE_CLEARCOAT
	vec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {
		vec3 f0 = material.clearcoatF0;
		float f90 = material.clearcoatF90;
		float roughness = material.clearcoatRoughness;
		float alpha = pow2( roughness );
		vec3 halfDir = normalize( lightDir + viewDir );
		float dotNL = saturate( dot( normal, lightDir ) );
		float dotNV = saturate( dot( normal, viewDir ) );
		float dotNH = saturate( dot( normal, halfDir ) );
		float dotVH = saturate( dot( viewDir, halfDir ) );
		vec3 F = F_Schlick( f0, f90, dotVH );
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
		return F * ( V * D );
	}
#endif
vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {
	vec3 f0 = material.specularColor;
	float f90 = material.specularF90;
	float roughness = material.roughness;
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( f0, f90, dotVH );
	#ifdef USE_IRIDESCENCE
		F = mix( F, material.iridescenceFresnel, material.iridescence );
	#endif
	#ifdef USE_ANISOTROPY
		float dotTL = dot( material.anisotropyT, lightDir );
		float dotTV = dot( material.anisotropyT, viewDir );
		float dotTH = dot( material.anisotropyT, halfDir );
		float dotBL = dot( material.anisotropyB, lightDir );
		float dotBV = dot( material.anisotropyB, viewDir );
		float dotBH = dot( material.anisotropyB, halfDir );
		float V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );
		float D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );
	#else
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
	#endif
	return F * ( V * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
#if defined( USE_SHEEN )
float D_Charlie( float roughness, float dotNH ) {
	float alpha = pow2( roughness );
	float invAlpha = 1.0 / alpha;
	float cos2h = dotNH * dotNH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 );
	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );
}
float V_Neubelt( float dotNV, float dotNL ) {
	return saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );
}
vec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float D = D_Charlie( sheenRoughness, dotNH );
	float V = V_Neubelt( dotNV, dotNL );
	return sheenColor * ( D * V );
}
#endif
float IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	float r2 = roughness * roughness;
	float a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;
	float b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;
	float DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );
	return saturate( DG * RECIPROCAL_PI );
}
vec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );
	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );
	vec4 r = roughness * c0 + c1;
	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;
	vec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;
	return fab;
}
vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	return specularColor * fab.x + specularF90 * fab.y;
}
#ifdef USE_IRIDESCENCE
void computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#else
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#endif
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	#ifdef USE_IRIDESCENCE
		vec3 Fr = mix( specularColor, iridescenceF0, iridescence );
	#else
		vec3 Fr = specularColor;
	#endif
	vec3 FssEss = Fr * fab.x + specularF90 * fab.y;
	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometryNormal;
		vec3 viewDir = geometryViewDir;
		vec3 position = geometryPosition;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifdef USE_CLEARCOAT
		float dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = dotNLcc * directLight.color;
		clearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );
	#endif
	#ifdef USE_SHEEN
		sheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );
	#endif
	reflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef USE_CLEARCOAT
		clearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	#ifdef USE_SHEEN
		sheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );
	#endif
	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	#ifdef USE_IRIDESCENCE
		computeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );
	#else
		computeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );
	#endif
	vec3 totalScattering = singleScattering + multiScattering;
	vec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );
	reflectedLight.indirectSpecular += radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,k1=`
vec3 geometryPosition = - vViewPosition;
vec3 geometryNormal = normal;
vec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
vec3 geometryClearcoatNormal = vec3( 0.0 );
#ifdef USE_CLEARCOAT
	geometryClearcoatNormal = clearcoatNormal;
#endif
#ifdef USE_IRIDESCENCE
	float dotNVi = saturate( dot( normal, geometryViewDir ) );
	if ( material.iridescenceThickness == 0.0 ) {
		material.iridescence = 0.0;
	} else {
		material.iridescence = saturate( material.iridescence );
	}
	if ( material.iridescence > 0.0 ) {
		material.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );
		material.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );
	}
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointLightInfo( pointLight, geometryPosition, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	vec4 spotColor;
	vec3 spotLightCoord;
	bool inSpotLightMap;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotLightInfo( spotLight, geometryPosition, directLight );
		#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX
		#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS
		#else
		#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#endif
		#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )
			spotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;
			inSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );
			spotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );
			directLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;
		#endif
		#undef SPOT_LIGHT_MAP_INDEX
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalLightInfo( directionalLight, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	#if defined( USE_LIGHT_PROBES )
		irradiance += getLightProbeIrradiance( lightProbe, geometryNormal );
	#endif
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,B1=`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		vec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getIBLIrradiance( geometryNormal );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	#ifdef USE_ANISOTROPY
		radiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );
	#else
		radiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );
	#endif
	#ifdef USE_CLEARCOAT
		clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );
	#endif
#endif`,G1=`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif`,V1=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	gl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,z1=`#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,H1=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		varying float vFragDepth;
		varying float vIsPerspective;
	#else
		uniform float logDepthBufFC;
	#endif
#endif`,j1=`#ifdef USE_LOGDEPTHBUF
	#ifdef USE_LOGDEPTHBUF_EXT
		vFragDepth = 1.0 + gl_Position.w;
		vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
	#else
		if ( isPerspectiveMatrix( projectionMatrix ) ) {
			gl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;
			gl_Position.z *= gl_Position.w;
		}
	#endif
#endif`,W1=`#ifdef USE_MAP
	vec4 sampledDiffuseColor = texture2D( map, vMapUv );
	#ifdef DECODE_VIDEO_TEXTURE
		sampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );
	
	#endif
	diffuseColor *= sampledDiffuseColor;
#endif`,X1=`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,$1=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	#if defined( USE_POINTS_UV )
		vec2 uv = vUv;
	#else
		vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
	#endif
#endif
#ifdef USE_MAP
	diffuseColor *= texture2D( map, uv );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,q1=`#if defined( USE_POINTS_UV )
	varying vec2 vUv;
#else
	#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
		uniform mat3 uvTransform;
	#endif
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,Y1=`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );
	metalnessFactor *= texelMetalness.b;
#endif`,K1=`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,Z1=`#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )
	vColor *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		#if defined( USE_COLOR_ALPHA )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];
		#elif defined( USE_COLOR )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];
		#endif
	}
#endif`,J1=`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
			if ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];
		}
	#else
		objectNormal += morphNormal0 * morphTargetInfluences[ 0 ];
		objectNormal += morphNormal1 * morphTargetInfluences[ 1 ];
		objectNormal += morphNormal2 * morphTargetInfluences[ 2 ];
		objectNormal += morphNormal3 * morphTargetInfluences[ 3 ];
	#endif
#endif`,Q1=`#ifdef USE_MORPHTARGETS
	uniform float morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		uniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];
		uniform sampler2DArray morphTargetsTexture;
		uniform ivec2 morphTargetsTextureSize;
		vec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {
			int texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;
			int y = texelIndex / morphTargetsTextureSize.x;
			int x = texelIndex - y * morphTargetsTextureSize.x;
			ivec3 morphUV = ivec3( x, y, morphTargetIndex );
			return texelFetch( morphTargetsTexture, morphUV, 0 );
		}
	#else
		#ifndef USE_MORPHNORMALS
			uniform float morphTargetInfluences[ 8 ];
		#else
			uniform float morphTargetInfluences[ 4 ];
		#endif
	#endif
#endif`,eI=`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	#ifdef MORPHTARGETS_TEXTURE
		for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
			if ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];
		}
	#else
		transformed += morphTarget0 * morphTargetInfluences[ 0 ];
		transformed += morphTarget1 * morphTargetInfluences[ 1 ];
		transformed += morphTarget2 * morphTargetInfluences[ 2 ];
		transformed += morphTarget3 * morphTargetInfluences[ 3 ];
		#ifndef USE_MORPHNORMALS
			transformed += morphTarget4 * morphTargetInfluences[ 4 ];
			transformed += morphTarget5 * morphTargetInfluences[ 5 ];
			transformed += morphTarget6 * morphTargetInfluences[ 6 ];
			transformed += morphTarget7 * morphTargetInfluences[ 7 ];
		#endif
	#endif
#endif`,tI=`float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;
#ifdef FLAT_SHADED
	vec3 fdx = dFdx( vViewPosition );
	vec3 fdy = dFdy( vViewPosition );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal *= faceDirection;
	#endif
#endif
#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )
	#ifdef USE_TANGENT
		mat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn = getTangentFrame( - vViewPosition, normal,
		#if defined( USE_NORMALMAP )
			vNormalMapUv
		#elif defined( USE_CLEARCOAT_NORMALMAP )
			vClearcoatNormalMapUv
		#else
			vUv
		#endif
		);
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn[0] *= faceDirection;
		tbn[1] *= faceDirection;
	#endif
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	#ifdef USE_TANGENT
		mat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn2[0] *= faceDirection;
		tbn2[1] *= faceDirection;
	#endif
#endif
vec3 nonPerturbedNormal = normal;`,nI=`#ifdef USE_NORMALMAP_OBJECTSPACE
	normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( USE_NORMALMAP_TANGENTSPACE )
	vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	normal = normalize( tbn * mapN );
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );
#endif`,rI=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,sI=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,iI=`#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif`,oI=`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef USE_NORMALMAP_OBJECTSPACE
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )
	mat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {
		vec3 q0 = dFdx( eye_pos.xyz );
		vec3 q1 = dFdy( eye_pos.xyz );
		vec2 st0 = dFdx( uv.st );
		vec2 st1 = dFdy( uv.st );
		vec3 N = surf_norm;
		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );
		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;
		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );
		return mat3( T * scale, B * scale, N );
	}
#endif`,aI=`#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal = nonPerturbedNormal;
#endif`,cI=`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	clearcoatNormal = normalize( tbn2 * clearcoatMapN );
#endif`,lI=`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif`,uI=`#ifdef USE_IRIDESCENCEMAP
	uniform sampler2D iridescenceMap;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform sampler2D iridescenceThicknessMap;
#endif`,hI=`#ifdef OPAQUE
diffuseColor.a = 1.0;
#endif
#ifdef USE_TRANSMISSION
diffuseColor.a *= material.transmissionAlpha;
#endif
gl_FragColor = vec4( outgoingLight, diffuseColor.a );`,dI=`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;
const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );
const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );
const float ShiftRight8 = 1. / 256.;
vec4 packDepthToRGBA( const in float v ) {
	vec4 r = vec4( fract( v * PackFactors ), v );
	r.yzw -= r.xyz * ShiftRight8;	return r * PackUpscale;
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors );
}
vec2 packDepthToRG( in highp float v ) {
	return packDepthToRGBA( v ).yx;
}
float unpackRGToDepth( const in highp vec2 v ) {
	return unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );
}
vec4 pack2HalfToRGBA( vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );
}
vec2 unpackRGBATo2Half( vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return depth * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * depth - far );
}`,pI=`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,fI=`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_BATCHING
	mvPosition = batchingMatrix * mvPosition;
#endif
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,mI=`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,_I=`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,gI=`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );
	roughnessFactor *= texelRoughness.g;
#endif`,vI=`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,yI=`#if NUM_SPOT_LIGHT_COORDS > 0
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#if NUM_SPOT_LIGHT_MAPS > 0
	uniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {
		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );
	}
	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {
		return unpackRGBATo2Half( texture2D( shadow, uv ) );
	}
	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){
		float occlusion = 1.0;
		vec2 distribution = texture2DDistribution( shadow, uv );
		float hard_shadow = step( compare , distribution.x );
		if (hard_shadow != 1.0 ) {
			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance );			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );
		}
		return occlusion;
	}
	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
		float shadow = 1.0;
		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;
		bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
		bool frustumTest = inFrustum && shadowCoord.z <= 1.0;
		if ( frustumTest ) {
		#if defined( SHADOWMAP_TYPE_PCF )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;
			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );
		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;
			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;
			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );
		#elif defined( SHADOWMAP_TYPE_VSM )
			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );
		#else
			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );
		#endif
		}
		return shadow;
	}
	vec2 cubeToUV( vec3 v, float texelSizeY ) {
		vec3 absV = abs( v );
		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );
		vec2 planar = v.xy;
		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;
		if ( absV.z >= almostOne ) {
			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;
		} else if ( absV.x >= almostOne ) {
			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;
		} else if ( absV.y >= almostOne ) {
			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;
		}
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );
	}
	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );
		vec3 lightToPosition = shadowCoord.xyz;
		float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );		dp += shadowBias;
		vec3 bd3D = normalize( lightToPosition );
		#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )
			vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;
			return (
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
			) * ( 1.0 / 9.0 );
		#else
			return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );
		#endif
	}
#endif`,xI=`#if NUM_SPOT_LIGHT_COORDS > 0
	uniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,bI=`#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )
	vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
	vec4 shadowWorldPosition;
#endif
#if defined( USE_SHADOWMAP )
	#if NUM_DIR_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
			vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
			vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
#endif
#if NUM_SPOT_LIGHT_COORDS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {
		shadowWorldPosition = worldPosition;
		#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
			shadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;
		#endif
		vSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
#endif`,CI=`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,EI=`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,SI=`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	uniform highp sampler2D boneTexture;
	mat4 getBoneMatrix( const in float i ) {
		int size = textureSize( boneTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );
		return mat4( v1, v2, v3, v4 );
	}
#endif`,AI=`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,TI=`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,MI=`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,RI=`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,wI=`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,OI=`#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return saturate( toneMappingExposure * color );
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 OptimizedCineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,PI=`#ifdef USE_TRANSMISSION
	material.transmission = transmission;
	material.transmissionAlpha = 1.0;
	material.thickness = thickness;
	material.attenuationDistance = attenuationDistance;
	material.attenuationColor = attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		material.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;
	#endif
	#ifdef USE_THICKNESSMAP
		material.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;
	#endif
	vec3 pos = vWorldPosition;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );
	vec4 transmitted = getIBLVolumeRefraction(
		n, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
		pos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,
		material.attenuationColor, material.attenuationDistance );
	material.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );
	totalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );
#endif`,NI=`#ifdef USE_TRANSMISSION
	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		uniform sampler2D transmissionMap;
	#endif
	#ifdef USE_THICKNESSMAP
		uniform sampler2D thicknessMap;
	#endif
	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;
	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;
	varying vec3 vWorldPosition;
	float w0( float a ) {
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );
	}
	float w1( float a ) {
		return ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );
	}
	float w2( float a ){
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );
	}
	float w3( float a ) {
		return ( 1.0 / 6.0 ) * ( a * a * a );
	}
	float g0( float a ) {
		return w0( a ) + w1( a );
	}
	float g1( float a ) {
		return w2( a ) + w3( a );
	}
	float h0( float a ) {
		return - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );
	}
	float h1( float a ) {
		return 1.0 + w3( a ) / ( w2( a ) + w3( a ) );
	}
	vec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {
		uv = uv * texelSize.zw + 0.5;
		vec2 iuv = floor( uv );
		vec2 fuv = fract( uv );
		float g0x = g0( fuv.x );
		float g1x = g1( fuv.x );
		float h0x = h0( fuv.x );
		float h1x = h1( fuv.x );
		float h0y = h0( fuv.y );
		float h1y = h1( fuv.y );
		vec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		vec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		return g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +
			g1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );
	}
	vec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {
		vec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );
		vec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );
		vec2 fLodSizeInv = 1.0 / fLodSize;
		vec2 cLodSizeInv = 1.0 / cLodSize;
		vec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );
		vec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );
		return mix( fSample, cSample, fract( lod ) );
	}
	vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
		vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
		vec3 modelScale;
		modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
		modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
		modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
		return normalize( refractionVector ) * thickness * modelScale;
	}
	float applyIorToRoughness( const in float roughness, const in float ior ) {
		return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
	}
	vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
		float lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );
		return textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );
	}
	vec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
		if ( isinf( attenuationDistance ) ) {
			return vec3( 1.0 );
		} else {
			vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
			vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );			return transmittance;
		}
	}
	vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
		const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
		const in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,
		const in vec3 attenuationColor, const in float attenuationDistance ) {
		vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
		vec3 refractedRayExit = position + transmissionRay;
		vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
		vec2 refractionCoords = ndcPos.xy / ndcPos.w;
		refractionCoords += 1.0;
		refractionCoords /= 2.0;
		vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
		vec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );
		vec3 attenuatedColor = transmittance * transmittedLight.rgb;
		vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
		float transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;
		return vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );
	}
#endif`,II=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_SPECULARMAP
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,DI=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	uniform mat3 mapTransform;
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	uniform mat3 alphaMapTransform;
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	uniform mat3 lightMapTransform;
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	uniform mat3 aoMapTransform;
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	uniform mat3 bumpMapTransform;
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	uniform mat3 normalMapTransform;
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_DISPLACEMENTMAP
	uniform mat3 displacementMapTransform;
	varying vec2 vDisplacementMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	uniform mat3 emissiveMapTransform;
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	uniform mat3 metalnessMapTransform;
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	uniform mat3 roughnessMapTransform;
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	uniform mat3 anisotropyMapTransform;
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	uniform mat3 clearcoatMapTransform;
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform mat3 clearcoatNormalMapTransform;
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform mat3 clearcoatRoughnessMapTransform;
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	uniform mat3 sheenColorMapTransform;
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	uniform mat3 sheenRoughnessMapTransform;
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	uniform mat3 iridescenceMapTransform;
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform mat3 iridescenceThicknessMapTransform;
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SPECULARMAP
	uniform mat3 specularMapTransform;
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	uniform mat3 specularColorMapTransform;
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	uniform mat3 specularIntensityMapTransform;
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,LI=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	vUv = vec3( uv, 1 ).xy;
#endif
#ifdef USE_MAP
	vMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ALPHAMAP
	vAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_LIGHTMAP
	vLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_AOMAP
	vAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_BUMPMAP
	vBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_NORMALMAP
	vNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_DISPLACEMENTMAP
	vDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_EMISSIVEMAP
	vEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_METALNESSMAP
	vMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ROUGHNESSMAP
	vRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ANISOTROPYMAP
	vAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOATMAP
	vClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	vClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	vClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCEMAP
	vIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	vIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_COLORMAP
	vSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	vSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULARMAP
	vSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_COLORMAP
	vSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	vSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_TRANSMISSIONMAP
	vTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_THICKNESSMAP
	vThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;
#endif`,FI=`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_BATCHING
		worldPosition = batchingMatrix * worldPosition;
	#endif
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`;const UI=`varying vec2 vUv;
uniform mat3 uvTransform;
void main() {
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,kI=`uniform sampler2D t2D;
uniform float backgroundIntensity;
varying vec2 vUv;
void main() {
	vec4 texColor = texture2D( t2D, vUv );
	#ifdef DECODE_VIDEO_TEXTURE
		texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );
	#endif
	texColor.rgb *= backgroundIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,BI=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,GI=`#ifdef ENVMAP_TYPE_CUBE
	uniform samplerCube envMap;
#elif defined( ENVMAP_TYPE_CUBE_UV )
	uniform sampler2D envMap;
#endif
uniform float flipEnvMap;
uniform float backgroundBlurriness;
uniform float backgroundIntensity;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
void main() {
	#ifdef ENVMAP_TYPE_CUBE
		vec4 texColor = textureCube( envMap, vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 texColor = textureCubeUV( envMap, vWorldDirection, backgroundBlurriness );
	#else
		vec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );
	#endif
	texColor.rgb *= backgroundIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,VI=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,zI=`uniform samplerCube tCube;
uniform float tFlip;
uniform float opacity;
varying vec3 vWorldDirection;
void main() {
	vec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );
	gl_FragColor = texColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,HI=`#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,jI=`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <logdepthbuf_fragment>
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#endif
}`,WI=`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <skinbase_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,XI=`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( 1.0 );
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = packDepthToRGBA( dist );
}`,$I=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,qI=`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	gl_FragColor = texture2D( tEquirect, sampleUV );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,YI=`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,KI=`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,ZI=`#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,JI=`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,QI=`#define LAMBERT
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,eD=`#define LAMBERT
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_lambert_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_lambert_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,tD=`#define MATCAP
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,nD=`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
	#else
		vec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,rD=`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	vViewPosition = - mvPosition.xyz;
#endif
}`,sD=`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <packing>
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( packNormalToRGB( normal ), opacity );
	#ifdef OPAQUE
		gl_FragColor.a = 1.0;
	#endif
}`,iD=`#define PHONG
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,oD=`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,aD=`#define STANDARD
varying vec3 vViewPosition;
#ifdef USE_TRANSMISSION
	varying vec3 vWorldPosition;
#endif
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition.xyz;
#endif
}`,cD=`#define STANDARD
#ifdef PHYSICAL
	#define IOR
	#define USE_SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef IOR
	uniform float ior;
#endif
#ifdef USE_SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularColor;
	#ifdef USE_SPECULAR_COLORMAP
		uniform sampler2D specularColorMap;
	#endif
	#ifdef USE_SPECULAR_INTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
#endif
#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_IRIDESCENCE
	uniform float iridescence;
	uniform float iridescenceIOR;
	uniform float iridescenceThicknessMinimum;
	uniform float iridescenceThicknessMaximum;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheenColor;
	uniform float sheenRoughness;
	#ifdef USE_SHEEN_COLORMAP
		uniform sampler2D sheenColorMap;
	#endif
	#ifdef USE_SHEEN_ROUGHNESSMAP
		uniform sampler2D sheenRoughnessMap;
	#endif
#endif
#ifdef USE_ANISOTROPY
	uniform vec2 anisotropyVector;
	#ifdef USE_ANISOTROPYMAP
		uniform sampler2D anisotropyMap;
	#endif
#endif
varying vec3 vViewPosition;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <iridescence_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <iridescence_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
	#include <transmission_fragment>
	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
	#ifdef USE_SHEEN
		float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );
		outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;
	#endif
	#ifdef USE_CLEARCOAT
		float dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );
		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );
		outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;
	#endif
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,lD=`#define TOON
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,uD=`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec4 diffuseColor = vec4( diffuse, opacity );
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,hD=`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
#ifdef USE_POINTS_UV
	varying vec2 vUv;
	uniform mat3 uvTransform;
#endif
void main() {
	#ifdef USE_POINTS_UV
		vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	#endif
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,dD=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,pD=`#include <common>
#include <batching_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,fD=`uniform vec3 color;
uniform float opacity;
#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <logdepthbuf_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	#include <logdepthbuf_fragment>
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`,mD=`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec2 scale;
	scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
	scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,_D=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`,lt={alphahash_fragment:kN,alphahash_pars_fragment:BN,alphamap_fragment:GN,alphamap_pars_fragment:VN,alphatest_fragment:zN,alphatest_pars_fragment:HN,aomap_fragment:jN,aomap_pars_fragment:WN,batching_pars_vertex:XN,batching_vertex:$N,begin_vertex:qN,beginnormal_vertex:YN,bsdfs:KN,iridescence_fragment:ZN,bumpmap_pars_fragment:JN,clipping_planes_fragment:QN,clipping_planes_pars_fragment:e1,clipping_planes_pars_vertex:t1,clipping_planes_vertex:n1,color_fragment:r1,color_pars_fragment:s1,color_pars_vertex:i1,color_vertex:o1,common:a1,cube_uv_reflection_fragment:c1,defaultnormal_vertex:l1,displacementmap_pars_vertex:u1,displacementmap_vertex:h1,emissivemap_fragment:d1,emissivemap_pars_fragment:p1,colorspace_fragment:f1,colorspace_pars_fragment:m1,envmap_fragment:_1,envmap_common_pars_fragment:g1,envmap_pars_fragment:v1,envmap_pars_vertex:y1,envmap_physical_pars_fragment:P1,envmap_vertex:x1,fog_vertex:b1,fog_pars_vertex:C1,fog_fragment:E1,fog_pars_fragment:S1,gradientmap_pars_fragment:A1,lightmap_fragment:T1,lightmap_pars_fragment:M1,lights_lambert_fragment:R1,lights_lambert_pars_fragment:w1,lights_pars_begin:O1,lights_toon_fragment:N1,lights_toon_pars_fragment:I1,lights_phong_fragment:D1,lights_phong_pars_fragment:L1,lights_physical_fragment:F1,lights_physical_pars_fragment:U1,lights_fragment_begin:k1,lights_fragment_maps:B1,lights_fragment_end:G1,logdepthbuf_fragment:V1,logdepthbuf_pars_fragment:z1,logdepthbuf_pars_vertex:H1,logdepthbuf_vertex:j1,map_fragment:W1,map_pars_fragment:X1,map_particle_fragment:$1,map_particle_pars_fragment:q1,metalnessmap_fragment:Y1,metalnessmap_pars_fragment:K1,morphcolor_vertex:Z1,morphnormal_vertex:J1,morphtarget_pars_vertex:Q1,morphtarget_vertex:eI,normal_fragment_begin:tI,normal_fragment_maps:nI,normal_pars_fragment:rI,normal_pars_vertex:sI,normal_vertex:iI,normalmap_pars_fragment:oI,clearcoat_normal_fragment_begin:aI,clearcoat_normal_fragment_maps:cI,clearcoat_pars_fragment:lI,iridescence_pars_fragment:uI,opaque_fragment:hI,packing:dI,premultiplied_alpha_fragment:pI,project_vertex:fI,dithering_fragment:mI,dithering_pars_fragment:_I,roughnessmap_fragment:gI,roughnessmap_pars_fragment:vI,shadowmap_pars_fragment:yI,shadowmap_pars_vertex:xI,shadowmap_vertex:bI,shadowmask_pars_fragment:CI,skinbase_vertex:EI,skinning_pars_vertex:SI,skinning_vertex:AI,skinnormal_vertex:TI,specularmap_fragment:MI,specularmap_pars_fragment:RI,tonemapping_fragment:wI,tonemapping_pars_fragment:OI,transmission_fragment:PI,transmission_pars_fragment:NI,uv_pars_fragment:II,uv_pars_vertex:DI,uv_vertex:LI,worldpos_vertex:FI,background_vert:UI,background_frag:kI,backgroundCube_vert:BI,backgroundCube_frag:GI,cube_vert:VI,cube_frag:zI,depth_vert:HI,depth_frag:jI,distanceRGBA_vert:WI,distanceRGBA_frag:XI,equirect_vert:$I,equirect_frag:qI,linedashed_vert:YI,linedashed_frag:KI,meshbasic_vert:ZI,meshbasic_frag:JI,meshlambert_vert:QI,meshlambert_frag:eD,meshmatcap_vert:tD,meshmatcap_frag:nD,meshnormal_vert:rD,meshnormal_frag:sD,meshphong_vert:iD,meshphong_frag:oD,meshphysical_vert:aD,meshphysical_frag:cD,meshtoon_vert:lD,meshtoon_frag:uD,points_vert:hD,points_frag:dD,shadow_vert:pD,shadow_frag:fD,sprite_vert:mD,sprite_frag:_D},Oe={common:{diffuse:{value:new xe(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new nt},alphaMap:{value:null},alphaMapTransform:{value:new nt},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new nt}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new nt}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new nt}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new nt},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new nt},normalScale:{value:new W(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new nt},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new nt}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new nt}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new nt}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new xe(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new xe(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new nt},alphaTest:{value:0},uvTransform:{value:new nt}},sprite:{diffuse:{value:new xe(16777215)},opacity:{value:1},center:{value:new W(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new nt},alphaMap:{value:null},alphaMapTransform:{value:new nt},alphaTest:{value:0}}},ms={basic:{uniforms:Yn([Oe.common,Oe.specularmap,Oe.envmap,Oe.aomap,Oe.lightmap,Oe.fog]),vertexShader:lt.meshbasic_vert,fragmentShader:lt.meshbasic_frag},lambert:{uniforms:Yn([Oe.common,Oe.specularmap,Oe.envmap,Oe.aomap,Oe.lightmap,Oe.emissivemap,Oe.bumpmap,Oe.normalmap,Oe.displacementmap,Oe.fog,Oe.lights,{emissive:{value:new xe(0)}}]),vertexShader:lt.meshlambert_vert,fragmentShader:lt.meshlambert_frag},phong:{uniforms:Yn([Oe.common,Oe.specularmap,Oe.envmap,Oe.aomap,Oe.lightmap,Oe.emissivemap,Oe.bumpmap,Oe.normalmap,Oe.displacementmap,Oe.fog,Oe.lights,{emissive:{value:new xe(0)},specular:{value:new xe(1118481)},shininess:{value:30}}]),vertexShader:lt.meshphong_vert,fragmentShader:lt.meshphong_frag},standard:{uniforms:Yn([Oe.common,Oe.envmap,Oe.aomap,Oe.lightmap,Oe.emissivemap,Oe.bumpmap,Oe.normalmap,Oe.displacementmap,Oe.roughnessmap,Oe.metalnessmap,Oe.fog,Oe.lights,{emissive:{value:new xe(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:lt.meshphysical_vert,fragmentShader:lt.meshphysical_frag},toon:{uniforms:Yn([Oe.common,Oe.aomap,Oe.lightmap,Oe.emissivemap,Oe.bumpmap,Oe.normalmap,Oe.displacementmap,Oe.gradientmap,Oe.fog,Oe.lights,{emissive:{value:new xe(0)}}]),vertexShader:lt.meshtoon_vert,fragmentShader:lt.meshtoon_frag},matcap:{uniforms:Yn([Oe.common,Oe.bumpmap,Oe.normalmap,Oe.displacementmap,Oe.fog,{matcap:{value:null}}]),vertexShader:lt.meshmatcap_vert,fragmentShader:lt.meshmatcap_frag},points:{uniforms:Yn([Oe.points,Oe.fog]),vertexShader:lt.points_vert,fragmentShader:lt.points_frag},dashed:{uniforms:Yn([Oe.common,Oe.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:lt.linedashed_vert,fragmentShader:lt.linedashed_frag},depth:{uniforms:Yn([Oe.common,Oe.displacementmap]),vertexShader:lt.depth_vert,fragmentShader:lt.depth_frag},normal:{uniforms:Yn([Oe.common,Oe.bumpmap,Oe.normalmap,Oe.displacementmap,{opacity:{value:1}}]),vertexShader:lt.meshnormal_vert,fragmentShader:lt.meshnormal_frag},sprite:{uniforms:Yn([Oe.sprite,Oe.fog]),vertexShader:lt.sprite_vert,fragmentShader:lt.sprite_frag},background:{uniforms:{uvTransform:{value:new nt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:lt.background_vert,fragmentShader:lt.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:lt.backgroundCube_vert,fragmentShader:lt.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:lt.cube_vert,fragmentShader:lt.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:lt.equirect_vert,fragmentShader:lt.equirect_frag},distanceRGBA:{uniforms:Yn([Oe.common,Oe.displacementmap,{referencePosition:{value:new T},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:lt.distanceRGBA_vert,fragmentShader:lt.distanceRGBA_frag},shadow:{uniforms:Yn([Oe.lights,Oe.fog,{color:{value:new xe(0)},opacity:{value:1}}]),vertexShader:lt.shadow_vert,fragmentShader:lt.shadow_frag}};ms.physical={uniforms:Yn([ms.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new nt},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new nt},clearcoatNormalScale:{value:new W(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new nt},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new nt},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new nt},sheen:{value:0},sheenColor:{value:new xe(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new nt},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new nt},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new nt},transmissionSamplerSize:{value:new W},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new nt},attenuationDistance:{value:0},attenuationColor:{value:new xe(0)},specularColor:{value:new xe(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new nt},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new nt},anisotropyVector:{value:new W},anisotropyMap:{value:null},anisotropyMapTransform:{value:new nt}}]),vertexShader:lt.meshphysical_vert,fragmentShader:lt.meshphysical_frag};const sh={r:0,b:0,g:0};function gD(n,e,t,r,s,i,o){const a=new xe(0);let c=i===!0?0:1,l,u,h=null,d=0,p=null;function _(f,m){let y=!1,v=m.isScene===!0?m.background:null;v&&v.isTexture&&(v=(m.backgroundBlurriness>0?t:e).get(v)),v===null?g(a,c):v&&v.isColor&&(g(v,1),y=!0);const b=n.xr.getEnvironmentBlendMode();b==="additive"?r.buffers.color.setClear(0,0,0,1,o):b==="alpha-blend"&&r.buffers.color.setClear(0,0,0,0,o),(n.autoClear||y)&&n.clear(n.autoClearColor,n.autoClearDepth,n.autoClearStencil),v&&(v.isCubeTexture||v.mapping===pp)?(u===void 0&&(u=new Jt(new vc(1,1,1),new Kn({name:"BackgroundCubeMaterial",uniforms:sc(ms.backgroundCube.uniforms),vertexShader:ms.backgroundCube.vertexShader,fragmentShader:ms.backgroundCube.fragmentShader,side:bn,depthTest:!1,depthWrite:!1,fog:!1})),u.geometry.deleteAttribute("normal"),u.geometry.deleteAttribute("uv"),u.onBeforeRender=function(x,E,S){this.matrixWorld.copyPosition(S.matrixWorld)},Object.defineProperty(u.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(u)),u.material.uniforms.envMap.value=v,u.material.uniforms.flipEnvMap.value=v.isCubeTexture&&v.isRenderTargetTexture===!1?-1:1,u.material.uniforms.backgroundBlurriness.value=m.backgroundBlurriness,u.material.uniforms.backgroundIntensity.value=m.backgroundIntensity,u.material.toneMapped=Rt.getTransfer(v.colorSpace)!==kt,(h!==v||d!==v.version||p!==n.toneMapping)&&(u.material.needsUpdate=!0,h=v,d=v.version,p=n.toneMapping),u.layers.enableAll(),f.unshift(u,u.geometry,u.material,0,0,null)):v&&v.isTexture&&(l===void 0&&(l=new Jt(new fp(2,2),new Kn({name:"BackgroundMaterial",uniforms:sc(ms.background.uniforms),vertexShader:ms.background.vertexShader,fragmentShader:ms.background.fragmentShader,side:In,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(l)),l.material.uniforms.t2D.value=v,l.material.uniforms.backgroundIntensity.value=m.backgroundIntensity,l.material.toneMapped=Rt.getTransfer(v.colorSpace)!==kt,v.matrixAutoUpdate===!0&&v.updateMatrix(),l.material.uniforms.uvTransform.value.copy(v.matrix),(h!==v||d!==v.version||p!==n.toneMapping)&&(l.material.needsUpdate=!0,h=v,d=v.version,p=n.toneMapping),l.layers.enableAll(),f.unshift(l,l.geometry,l.material,0,0,null))}function g(f,m){f.getRGB(sh,WA(n)),r.buffers.color.setClear(sh.r,sh.g,sh.b,m,o)}return{getClearColor:function(){return a},setClearColor:function(f,m=1){a.set(f),c=m,g(a,c)},getClearAlpha:function(){return c},setClearAlpha:function(f){c=f,g(a,c)},render:_}}function vD(n,e,t,r){const s=n.getParameter(n.MAX_VERTEX_ATTRIBS),i=r.isWebGL2?null:e.get("OES_vertex_array_object"),o=r.isWebGL2||i!==null,a={},c=f(null);let l=c,u=!1;function h(N,j,K,$,q){let ne=!1;if(o){const le=g($,K,j);l!==le&&(l=le,p(l.object)),ne=m(N,$,K,q),ne&&y(N,$,K,q)}else{const le=j.wireframe===!0;(l.geometry!==$.id||l.program!==K.id||l.wireframe!==le)&&(l.geometry=$.id,l.program=K.id,l.wireframe=le,ne=!0)}q!==null&&t.update(q,n.ELEMENT_ARRAY_BUFFER),(ne||u)&&(u=!1,R(N,j,K,$),q!==null&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.get(q).buffer))}function d(){return r.isWebGL2?n.createVertexArray():i.createVertexArrayOES()}function p(N){return r.isWebGL2?n.bindVertexArray(N):i.bindVertexArrayOES(N)}function _(N){return r.isWebGL2?n.deleteVertexArray(N):i.deleteVertexArrayOES(N)}function g(N,j,K){const $=K.wireframe===!0;let q=a[N.id];q===void 0&&(q={},a[N.id]=q);let ne=q[j.id];ne===void 0&&(ne={},q[j.id]=ne);let le=ne[$];return le===void 0&&(le=f(d()),ne[$]=le),le}function f(N){const j=[],K=[],$=[];for(let q=0;q<s;q++)j[q]=0,K[q]=0,$[q]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:j,enabledAttributes:K,attributeDivisors:$,object:N,attributes:{},index:null}}function m(N,j,K,$){const q=l.attributes,ne=j.attributes;let le=0;const ue=K.getAttributes();for(const Ee in ue)if(ue[Ee].location>=0){const V=q[Ee];let B=ne[Ee];if(B===void 0&&(Ee==="instanceMatrix"&&N.instanceMatrix&&(B=N.instanceMatrix),Ee==="instanceColor"&&N.instanceColor&&(B=N.instanceColor)),V===void 0||V.attribute!==B||B&&V.data!==B.data)return!0;le++}return l.attributesNum!==le||l.index!==$}function y(N,j,K,$){const q={},ne=j.attributes;let le=0;const ue=K.getAttributes();for(const Ee in ue)if(ue[Ee].location>=0){let V=ne[Ee];V===void 0&&(Ee==="instanceMatrix"&&N.instanceMatrix&&(V=N.instanceMatrix),Ee==="instanceColor"&&N.instanceColor&&(V=N.instanceColor));const B={};B.attribute=V,V&&V.data&&(B.data=V.data),q[Ee]=B,le++}l.attributes=q,l.attributesNum=le,l.index=$}function v(){const N=l.newAttributes;for(let j=0,K=N.length;j<K;j++)N[j]=0}function b(N){x(N,0)}function x(N,j){const K=l.newAttributes,$=l.enabledAttributes,q=l.attributeDivisors;K[N]=1,$[N]===0&&(n.enableVertexAttribArray(N),$[N]=1),q[N]!==j&&((r.isWebGL2?n:e.get("ANGLE_instanced_arrays"))[r.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](N,j),q[N]=j)}function E(){const N=l.newAttributes,j=l.enabledAttributes;for(let K=0,$=j.length;K<$;K++)j[K]!==N[K]&&(n.disableVertexAttribArray(K),j[K]=0)}function S(N,j,K,$,q,ne,le){le===!0?n.vertexAttribIPointer(N,j,K,q,ne):n.vertexAttribPointer(N,j,K,$,q,ne)}function R(N,j,K,$){if(r.isWebGL2===!1&&(N.isInstancedMesh||$.isInstancedBufferGeometry)&&e.get("ANGLE_instanced_arrays")===null)return;v();const q=$.attributes,ne=K.getAttributes(),le=j.defaultAttributeValues;for(const ue in ne){const Ee=ne[ue];if(Ee.location>=0){let de=q[ue];if(de===void 0&&(ue==="instanceMatrix"&&N.instanceMatrix&&(de=N.instanceMatrix),ue==="instanceColor"&&N.instanceColor&&(de=N.instanceColor)),de!==void 0){const V=de.normalized,B=de.itemSize,P=t.get(de);if(P===void 0)continue;const O=P.buffer,se=P.type,_e=P.bytesPerElement,Z=r.isWebGL2===!0&&(se===n.INT||se===n.UNSIGNED_INT||de.gpuType===wA);if(de.isInterleavedBufferAttribute){const me=de.data,L=me.stride,oe=de.offset;if(me.isInstancedInterleavedBuffer){for(let H=0;H<Ee.locationSize;H++)x(Ee.location+H,me.meshPerAttribute);N.isInstancedMesh!==!0&&$._maxInstanceCount===void 0&&($._maxInstanceCount=me.meshPerAttribute*me.count)}else for(let H=0;H<Ee.locationSize;H++)b(Ee.location+H);n.bindBuffer(n.ARRAY_BUFFER,O);for(let H=0;H<Ee.locationSize;H++)S(Ee.location+H,B/Ee.locationSize,se,V,L*_e,(oe+B/Ee.locationSize*H)*_e,Z)}else{if(de.isInstancedBufferAttribute){for(let me=0;me<Ee.locationSize;me++)x(Ee.location+me,de.meshPerAttribute);N.isInstancedMesh!==!0&&$._maxInstanceCount===void 0&&($._maxInstanceCount=de.meshPerAttribute*de.count)}else for(let me=0;me<Ee.locationSize;me++)b(Ee.location+me);n.bindBuffer(n.ARRAY_BUFFER,O);for(let me=0;me<Ee.locationSize;me++)S(Ee.location+me,B/Ee.locationSize,se,V,B*_e,B/Ee.locationSize*me*_e,Z)}}else if(le!==void 0){const V=le[ue];if(V!==void 0)switch(V.length){case 2:n.vertexAttrib2fv(Ee.location,V);break;case 3:n.vertexAttrib3fv(Ee.location,V);break;case 4:n.vertexAttrib4fv(Ee.location,V);break;default:n.vertexAttrib1fv(Ee.location,V)}}}}E()}function C(){F();for(const N in a){const j=a[N];for(const K in j){const $=j[K];for(const q in $)_($[q].object),delete $[q];delete j[K]}delete a[N]}}function M(N){if(a[N.id]===void 0)return;const j=a[N.id];for(const K in j){const $=j[K];for(const q in $)_($[q].object),delete $[q];delete j[K]}delete a[N.id]}function G(N){for(const j in a){const K=a[j];if(K[N.id]===void 0)continue;const $=K[N.id];for(const q in $)_($[q].object),delete $[q];delete K[N.id]}}function F(){X(),u=!0,l!==c&&(l=c,p(l.object))}function X(){c.geometry=null,c.program=null,c.wireframe=!1}return{setup:h,reset:F,resetDefaultState:X,dispose:C,releaseStatesOfGeometry:M,releaseStatesOfProgram:G,initAttributes:v,enableAttribute:b,disableUnusedAttributes:E}}function yD(n,e,t,r){const s=r.isWebGL2;let i;function o(u){i=u}function a(u,h){n.drawArrays(i,u,h),t.update(h,i,1)}function c(u,h,d){if(d===0)return;let p,_;if(s)p=n,_="drawArraysInstanced";else if(p=e.get("ANGLE_instanced_arrays"),_="drawArraysInstancedANGLE",p===null){console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}p[_](i,u,h,d),t.update(h,i,d)}function l(u,h,d){if(d===0)return;const p=e.get("WEBGL_multi_draw");if(p===null)for(let _=0;_<d;_++)this.render(u[_],h[_]);else{p.multiDrawArraysWEBGL(i,u,0,h,0,d);let _=0;for(let g=0;g<d;g++)_+=h[g];t.update(_,i,1)}}this.setMode=o,this.render=a,this.renderInstances=c,this.renderMultiDraw=l}function xD(n,e,t){let r;function s(){if(r!==void 0)return r;if(e.has("EXT_texture_filter_anisotropic")===!0){const S=e.get("EXT_texture_filter_anisotropic");r=n.getParameter(S.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else r=0;return r}function i(S){if(S==="highp"){if(n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.HIGH_FLOAT).precision>0&&n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.HIGH_FLOAT).precision>0)return"highp";S="mediump"}return S==="mediump"&&n.getShaderPrecisionFormat(n.VERTEX_SHADER,n.MEDIUM_FLOAT).precision>0&&n.getShaderPrecisionFormat(n.FRAGMENT_SHADER,n.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const o=typeof WebGL2RenderingContext<"u"&&n.constructor.name==="WebGL2RenderingContext";let a=t.precision!==void 0?t.precision:"highp";const c=i(a);c!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",c,"instead."),a=c);const l=o||e.has("WEBGL_draw_buffers"),u=t.logarithmicDepthBuffer===!0,h=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS),d=n.getParameter(n.MAX_VERTEX_TEXTURE_IMAGE_UNITS),p=n.getParameter(n.MAX_TEXTURE_SIZE),_=n.getParameter(n.MAX_CUBE_MAP_TEXTURE_SIZE),g=n.getParameter(n.MAX_VERTEX_ATTRIBS),f=n.getParameter(n.MAX_VERTEX_UNIFORM_VECTORS),m=n.getParameter(n.MAX_VARYING_VECTORS),y=n.getParameter(n.MAX_FRAGMENT_UNIFORM_VECTORS),v=d>0,b=o||e.has("OES_texture_float"),x=v&&b,E=o?n.getParameter(n.MAX_SAMPLES):0;return{isWebGL2:o,drawBuffers:l,getMaxAnisotropy:s,getMaxPrecision:i,precision:a,logarithmicDepthBuffer:u,maxTextures:h,maxVertexTextures:d,maxTextureSize:p,maxCubemapSize:_,maxAttributes:g,maxVertexUniforms:f,maxVaryings:m,maxFragmentUniforms:y,vertexTextures:v,floatFragmentTextures:b,floatVertexTextures:x,maxSamples:E}}function bD(n){const e=this;let t=null,r=0,s=!1,i=!1;const o=new ar,a=new nt,c={value:null,needsUpdate:!1};this.uniform=c,this.numPlanes=0,this.numIntersection=0,this.init=function(h,d){const p=h.length!==0||d||r!==0||s;return s=d,r=h.length,p},this.beginShadows=function(){i=!0,u(null)},this.endShadows=function(){i=!1},this.setGlobalState=function(h,d){t=u(h,d,0)},this.setState=function(h,d,p){const _=h.clippingPlanes,g=h.clipIntersection,f=h.clipShadows,m=n.get(h);if(!s||_===null||_.length===0||i&&!f)i?u(null):l();else{const y=i?0:r,v=y*4;let b=m.clippingState||null;c.value=b,b=u(_,d,v,p);for(let x=0;x!==v;++x)b[x]=t[x];m.clippingState=b,this.numIntersection=g?this.numPlanes:0,this.numPlanes+=y}};function l(){c.value!==t&&(c.value=t,c.needsUpdate=r>0),e.numPlanes=r,e.numIntersection=0}function u(h,d,p,_){const g=h!==null?h.length:0;let f=null;if(g!==0){if(f=c.value,_!==!0||f===null){const m=p+g*4,y=d.matrixWorldInverse;a.getNormalMatrix(y),(f===null||f.length<m)&&(f=new Float32Array(m));for(let v=0,b=p;v!==g;++v,b+=4)o.copy(h[v]).applyMatrix4(y,a),o.normal.toArray(f,b),f[b+3]=o.constant}c.value=f,c.needsUpdate=!0}return e.numPlanes=g,e.numIntersection=0,f}}function CD(n){let e=new WeakMap;function t(o,a){return a===c_?o.mapping=Qa:a===l_&&(o.mapping=ec),o}function r(o){if(o&&o.isTexture){const a=o.mapping;if(a===c_||a===l_)if(e.has(o)){const c=e.get(o).texture;return t(c,o.mapping)}else{const c=o.image;if(c&&c.height>0){const l=new DN(c.height/2);return l.fromEquirectangularTexture(n,o),e.set(o,l),o.addEventListener("dispose",s),t(l.texture,o.mapping)}else return null}}return o}function s(o){const a=o.target;a.removeEventListener("dispose",s);const c=e.get(a);c!==void 0&&(e.delete(a),c.dispose())}function i(){e=new WeakMap}return{get:r,dispose:i}}class kg extends $A{constructor(e=-1,t=1,r=1,s=-1,i=.1,o=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=r,this.bottom=s,this.near=i,this.far=o,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=e.view===null?null:Object.assign({},e.view),this}setViewOffset(e,t,r,s,i,o){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=r,this.view.offsetY=s,this.view.width=i,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let i=r-e,o=r+e,a=s+t,c=s-t;if(this.view!==null&&this.view.enabled){const l=(this.right-this.left)/this.view.fullWidth/this.zoom,u=(this.top-this.bottom)/this.view.fullHeight/this.zoom;i+=l*this.view.offsetX,o=i+l*this.view.width,a-=u*this.view.offsetY,c=a-u*this.view.height}this.projectionMatrix.makeOrthographic(i,o,a,c,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,this.view!==null&&(t.object.view=Object.assign({},this.view)),t}}const ka=4,ix=[.125,.215,.35,.446,.526,.582],vo=20,Mf=new kg,ox=new xe;let Rf=null,wf=0,Of=0;const uo=(1+Math.sqrt(5))/2,aa=1/uo,ax=[new T(1,1,1),new T(-1,1,1),new T(1,1,-1),new T(-1,1,-1),new T(0,uo,aa),new T(0,uo,-aa),new T(aa,0,uo),new T(-aa,0,uo),new T(uo,aa,0),new T(-uo,aa,0)];class cx{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,r=.1,s=100){Rf=this._renderer.getRenderTarget(),wf=this._renderer.getActiveCubeFace(),Of=this._renderer.getActiveMipmapLevel(),this._setSize(256);const i=this._allocateTargets();return i.depthBuffer=!0,this._sceneToCubeUV(e,r,s,i),t>0&&this._blur(i,0,0,t),this._applyPMREM(i),this._cleanup(i),i}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){this._cubemapMaterial===null&&(this._cubemapMaterial=hx(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){this._equirectMaterial===null&&(this._equirectMaterial=ux(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),this._cubemapMaterial!==null&&this._cubemapMaterial.dispose(),this._equirectMaterial!==null&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){this._blurMaterial!==null&&this._blurMaterial.dispose(),this._pingPongRenderTarget!==null&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(Rf,wf,Of),e.scissorTest=!1,ih(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===Qa||e.mapping===ec?this._setSize(e.image.length===0?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),Rf=this._renderer.getRenderTarget(),wf=this._renderer.getActiveCubeFace(),Of=this._renderer.getActiveMipmapLevel();const r=t||this._allocateTargets();return this._textureToCubeUV(e,r),this._applyPMREM(r),this._cleanup(r),r}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,r={magFilter:Or,minFilter:Or,generateMipmaps:!1,type:tc,format:fn,colorSpace:kr,depthBuffer:!1},s=lx(e,t,r);if(this._pingPongRenderTarget===null||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){this._pingPongRenderTarget!==null&&this._dispose(),this._pingPongRenderTarget=lx(e,t,r);const{_lodMax:i}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=ED(i)),this._blurMaterial=SD(i,e,t)}return s}_compileMaterial(e){const t=new Jt(this._lodPlanes[0],e);this._renderer.compile(t,Mf)}_sceneToCubeUV(e,t,r,s){const a=new Un(90,1,t,r),c=[1,-1,1,1,1,1],l=[1,1,1,-1,-1,-1],u=this._renderer,h=u.autoClear,d=u.toneMapping;u.getClearColor(ox),u.toneMapping=Fr,u.autoClear=!1;const p=new _u({name:"PMREM.Background",side:bn,depthWrite:!1,depthTest:!1}),_=new Jt(new vc,p);let g=!1;const f=e.background;f?f.isColor&&(p.color.copy(f),e.background=null,g=!0):(p.color.copy(ox),g=!0);for(let m=0;m<6;m++){const y=m%3;y===0?(a.up.set(0,c[m],0),a.lookAt(l[m],0,0)):y===1?(a.up.set(0,0,c[m]),a.lookAt(0,l[m],0)):(a.up.set(0,c[m],0),a.lookAt(0,0,l[m]));const v=this._cubeSize;ih(s,y*v,m>2?v:0,v,v),u.setRenderTarget(s),g&&u.render(_,a),u.render(e,a)}_.geometry.dispose(),_.material.dispose(),u.toneMapping=d,u.autoClear=h,e.background=f}_textureToCubeUV(e,t){const r=this._renderer,s=e.mapping===Qa||e.mapping===ec;s?(this._cubemapMaterial===null&&(this._cubemapMaterial=hx()),this._cubemapMaterial.uniforms.flipEnvMap.value=e.isRenderTargetTexture===!1?-1:1):this._equirectMaterial===null&&(this._equirectMaterial=ux());const i=s?this._cubemapMaterial:this._equirectMaterial,o=new Jt(this._lodPlanes[0],i),a=i.uniforms;a.envMap.value=e;const c=this._cubeSize;ih(t,0,0,3*c,2*c),r.setRenderTarget(t),r.render(o,Mf)}_applyPMREM(e){const t=this._renderer,r=t.autoClear;t.autoClear=!1;for(let s=1;s<this._lodPlanes.length;s++){const i=Math.sqrt(this._sigmas[s]*this._sigmas[s]-this._sigmas[s-1]*this._sigmas[s-1]),o=ax[(s-1)%ax.length];this._blur(e,s-1,s,i,o)}t.autoClear=r}_blur(e,t,r,s,i){const o=this._pingPongRenderTarget;this._halfBlur(e,o,t,r,s,"latitudinal",i),this._halfBlur(o,e,r,r,s,"longitudinal",i)}_halfBlur(e,t,r,s,i,o,a){const c=this._renderer,l=this._blurMaterial;o!=="latitudinal"&&o!=="longitudinal"&&console.error("blur direction must be either latitudinal or longitudinal!");const u=3,h=new Jt(this._lodPlanes[s],l),d=l.uniforms,p=this._sizeLods[r]-1,_=isFinite(i)?Math.PI/(2*p):2*Math.PI/(2*vo-1),g=i/_,f=isFinite(i)?1+Math.floor(u*g):vo;f>vo&&console.warn(`sigmaRadians, ${i}, is too large and will clip, as it requested ${f} samples when the maximum is set to ${vo}`);const m=[];let y=0;for(let S=0;S<vo;++S){const R=S/g,C=Math.exp(-R*R/2);m.push(C),S===0?y+=C:S<f&&(y+=2*C)}for(let S=0;S<m.length;S++)m[S]=m[S]/y;d.envMap.value=e.texture,d.samples.value=f,d.weights.value=m,d.latitudinal.value=o==="latitudinal",a&&(d.poleAxis.value=a);const{_lodMax:v}=this;d.dTheta.value=_,d.mipInt.value=v-r;const b=this._sizeLods[s],x=3*b*(s>v-ka?s-v+ka:0),E=4*(this._cubeSize-b);ih(t,x,E,3*b,2*b),c.setRenderTarget(t),c.render(h,Mf)}}function ED(n){const e=[],t=[],r=[];let s=n;const i=n-ka+1+ix.length;for(let o=0;o<i;o++){const a=Math.pow(2,s);t.push(a);let c=1/a;o>n-ka?c=ix[o-n+ka-1]:o===0&&(c=0),r.push(c);const l=1/(a-2),u=-l,h=1+l,d=[u,u,h,u,h,h,u,u,h,h,u,h],p=6,_=6,g=3,f=2,m=1,y=new Float32Array(g*_*p),v=new Float32Array(f*_*p),b=new Float32Array(m*_*p);for(let E=0;E<p;E++){const S=E%3*2/3-1,R=E>2?0:-1,C=[S,R,0,S+2/3,R,0,S+2/3,R+1,0,S,R,0,S+2/3,R+1,0,S,R+1,0];y.set(C,g*_*E),v.set(d,f*_*E);const M=[E,E,E,E,E,E];b.set(M,m*_*E)}const x=new sn;x.setAttribute("position",new Lt(y,g)),x.setAttribute("uv",new Lt(v,f)),x.setAttribute("faceIndex",new Lt(b,m)),e.push(x),s>ka&&s--}return{lodPlanes:e,sizeLods:t,sigmas:r}}function lx(n,e,t){const r=new Br(n,e,t);return r.texture.mapping=pp,r.texture.name="PMREM.cubeUv",r.scissorTest=!0,r}function ih(n,e,t,r,s){n.viewport.set(e,t,r,s),n.scissor.set(e,t,r,s)}function SD(n,e,t){const r=new Float32Array(vo),s=new T(0,1,0);return new Kn({name:"SphericalGaussianBlur",defines:{n:vo,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/t,CUBEUV_MAX_MIP:`${n}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:r},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:s}},vertexShader:Bg(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

			}
		`,blending:$s,depthTest:!1,depthWrite:!1})}function ux(){return new Kn({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:Bg(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;

			#include <common>

			void main() {

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				gl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );

			}
		`,blending:$s,depthTest:!1,depthWrite:!1})}function hx(){return new Kn({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:Bg(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			uniform float flipEnvMap;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			void main() {

				gl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );

			}
		`,blending:$s,depthTest:!1,depthWrite:!1})}function Bg(){return`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function AD(n){let e=new WeakMap,t=null;function r(a){if(a&&a.isTexture){const c=a.mapping,l=c===c_||c===l_,u=c===Qa||c===ec;if(l||u)if(a.isRenderTargetTexture&&a.needsPMREMUpdate===!0){a.needsPMREMUpdate=!1;let h=e.get(a);return t===null&&(t=new cx(n)),h=l?t.fromEquirectangular(a,h):t.fromCubemap(a,h),e.set(a,h),h.texture}else{if(e.has(a))return e.get(a).texture;{const h=a.image;if(l&&h&&h.height>0||u&&h&&s(h)){t===null&&(t=new cx(n));const d=l?t.fromEquirectangular(a):t.fromCubemap(a);return e.set(a,d),a.addEventListener("dispose",i),d.texture}else return null}}}return a}function s(a){let c=0;const l=6;for(let u=0;u<l;u++)a[u]!==void 0&&c++;return c===l}function i(a){const c=a.target;c.removeEventListener("dispose",i);const l=e.get(c);l!==void 0&&(e.delete(c),l.dispose())}function o(){e=new WeakMap,t!==null&&(t.dispose(),t=null)}return{get:r,dispose:o}}function TD(n){const e={};function t(r){if(e[r]!==void 0)return e[r];let s;switch(r){case"WEBGL_depth_texture":s=n.getExtension("WEBGL_depth_texture")||n.getExtension("MOZ_WEBGL_depth_texture")||n.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":s=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":s=n.getExtension("WEBGL_compressed_texture_s3tc")||n.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":s=n.getExtension("WEBGL_compressed_texture_pvrtc")||n.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:s=n.getExtension(r)}return e[r]=s,s}return{has:function(r){return t(r)!==null},init:function(r){r.isWebGL2?t("EXT_color_buffer_float"):(t("WEBGL_depth_texture"),t("OES_texture_float"),t("OES_texture_half_float"),t("OES_texture_half_float_linear"),t("OES_standard_derivatives"),t("OES_element_index_uint"),t("OES_vertex_array_object"),t("ANGLE_instanced_arrays")),t("OES_texture_float_linear"),t("EXT_color_buffer_half_float"),t("WEBGL_multisampled_render_to_texture")},get:function(r){const s=t(r);return s===null&&console.warn("THREE.WebGLRenderer: "+r+" extension not supported."),s}}}function MD(n,e,t,r){const s={},i=new WeakMap;function o(h){const d=h.target;d.index!==null&&e.remove(d.index);for(const _ in d.attributes)e.remove(d.attributes[_]);for(const _ in d.morphAttributes){const g=d.morphAttributes[_];for(let f=0,m=g.length;f<m;f++)e.remove(g[f])}d.removeEventListener("dispose",o),delete s[d.id];const p=i.get(d);p&&(e.remove(p),i.delete(d)),r.releaseStatesOfGeometry(d),d.isInstancedBufferGeometry===!0&&delete d._maxInstanceCount,t.memory.geometries--}function a(h,d){return s[d.id]===!0||(d.addEventListener("dispose",o),s[d.id]=!0,t.memory.geometries++),d}function c(h){const d=h.attributes;for(const _ in d)e.update(d[_],n.ARRAY_BUFFER);const p=h.morphAttributes;for(const _ in p){const g=p[_];for(let f=0,m=g.length;f<m;f++)e.update(g[f],n.ARRAY_BUFFER)}}function l(h){const d=[],p=h.index,_=h.attributes.position;let g=0;if(p!==null){const y=p.array;g=p.version;for(let v=0,b=y.length;v<b;v+=3){const x=y[v+0],E=y[v+1],S=y[v+2];d.push(x,E,E,S,S,x)}}else if(_!==void 0){const y=_.array;g=_.version;for(let v=0,b=y.length/3-1;v<b;v+=3){const x=v+0,E=v+1,S=v+2;d.push(x,E,E,S,S,x)}}else return;const f=new(kA(d)?jA:HA)(d,1);f.version=g;const m=i.get(h);m&&e.remove(m),i.set(h,f)}function u(h){const d=i.get(h);if(d){const p=h.index;p!==null&&d.version<p.version&&l(h)}else l(h);return i.get(h)}return{get:a,update:c,getWireframeAttribute:u}}function RD(n,e,t,r){const s=r.isWebGL2;let i;function o(p){i=p}let a,c;function l(p){a=p.type,c=p.bytesPerElement}function u(p,_){n.drawElements(i,_,a,p*c),t.update(_,i,1)}function h(p,_,g){if(g===0)return;let f,m;if(s)f=n,m="drawElementsInstanced";else if(f=e.get("ANGLE_instanced_arrays"),m="drawElementsInstancedANGLE",f===null){console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");return}f[m](i,_,a,p*c,g),t.update(_,i,g)}function d(p,_,g){if(g===0)return;const f=e.get("WEBGL_multi_draw");if(f===null)for(let m=0;m<g;m++)this.render(p[m]/c,_[m]);else{f.multiDrawElementsWEBGL(i,_,0,a,p,0,g);let m=0;for(let y=0;y<g;y++)m+=_[y];t.update(m,i,1)}}this.setMode=o,this.setIndex=l,this.render=u,this.renderInstances=h,this.renderMultiDraw=d}function wD(n){const e={geometries:0,textures:0},t={frame:0,calls:0,triangles:0,points:0,lines:0};function r(i,o,a){switch(t.calls++,o){case n.TRIANGLES:t.triangles+=a*(i/3);break;case n.LINES:t.lines+=a*(i/2);break;case n.LINE_STRIP:t.lines+=a*(i-1);break;case n.LINE_LOOP:t.lines+=a*i;break;case n.POINTS:t.points+=a*i;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",o);break}}function s(){t.calls=0,t.triangles=0,t.points=0,t.lines=0}return{memory:e,render:t,programs:null,autoReset:!0,reset:s,update:r}}function OD(n,e){return n[0]-e[0]}function PD(n,e){return Math.abs(e[1])-Math.abs(n[1])}function ND(n,e,t){const r={},s=new Float32Array(8),i=new WeakMap,o=new We,a=[];for(let l=0;l<8;l++)a[l]=[l,0];function c(l,u,h){const d=l.morphTargetInfluences;if(e.isWebGL2===!0){const p=u.morphAttributes.position||u.morphAttributes.normal||u.morphAttributes.color,_=p!==void 0?p.length:0;let g=i.get(u);if(g===void 0||g.count!==_){let N=function(){F.dispose(),i.delete(u),u.removeEventListener("dispose",N)};g!==void 0&&g.texture.dispose();const y=u.morphAttributes.position!==void 0,v=u.morphAttributes.normal!==void 0,b=u.morphAttributes.color!==void 0,x=u.morphAttributes.position||[],E=u.morphAttributes.normal||[],S=u.morphAttributes.color||[];let R=0;y===!0&&(R=1),v===!0&&(R=2),b===!0&&(R=3);let C=u.attributes.position.count*R,M=1;C>e.maxTextureSize&&(M=Math.ceil(C/e.maxTextureSize),C=e.maxTextureSize);const G=new Float32Array(C*M*4*_),F=new VA(G,C,M,_);F.type=jn,F.needsUpdate=!0;const X=R*4;for(let j=0;j<_;j++){const K=x[j],$=E[j],q=S[j],ne=C*M*4*j;for(let le=0;le<K.count;le++){const ue=le*X;y===!0&&(o.fromBufferAttribute(K,le),G[ne+ue+0]=o.x,G[ne+ue+1]=o.y,G[ne+ue+2]=o.z,G[ne+ue+3]=0),v===!0&&(o.fromBufferAttribute($,le),G[ne+ue+4]=o.x,G[ne+ue+5]=o.y,G[ne+ue+6]=o.z,G[ne+ue+7]=0),b===!0&&(o.fromBufferAttribute(q,le),G[ne+ue+8]=o.x,G[ne+ue+9]=o.y,G[ne+ue+10]=o.z,G[ne+ue+11]=q.itemSize===4?o.w:1)}}g={count:_,texture:F,size:new W(C,M)},i.set(u,g),u.addEventListener("dispose",N)}let f=0;for(let y=0;y<d.length;y++)f+=d[y];const m=u.morphTargetsRelative?1:1-f;h.getUniforms().setValue(n,"morphTargetBaseInfluence",m),h.getUniforms().setValue(n,"morphTargetInfluences",d),h.getUniforms().setValue(n,"morphTargetsTexture",g.texture,t),h.getUniforms().setValue(n,"morphTargetsTextureSize",g.size)}else{const p=d===void 0?0:d.length;let _=r[u.id];if(_===void 0||_.length!==p){_=[];for(let v=0;v<p;v++)_[v]=[v,0];r[u.id]=_}for(let v=0;v<p;v++){const b=_[v];b[0]=v,b[1]=d[v]}_.sort(PD);for(let v=0;v<8;v++)v<p&&_[v][1]?(a[v][0]=_[v][0],a[v][1]=_[v][1]):(a[v][0]=Number.MAX_SAFE_INTEGER,a[v][1]=0);a.sort(OD);const g=u.morphAttributes.position,f=u.morphAttributes.normal;let m=0;for(let v=0;v<8;v++){const b=a[v],x=b[0],E=b[1];x!==Number.MAX_SAFE_INTEGER&&E?(g&&u.getAttribute("morphTarget"+v)!==g[x]&&u.setAttribute("morphTarget"+v,g[x]),f&&u.getAttribute("morphNormal"+v)!==f[x]&&u.setAttribute("morphNormal"+v,f[x]),s[v]=E,m+=E):(g&&u.hasAttribute("morphTarget"+v)===!0&&u.deleteAttribute("morphTarget"+v),f&&u.hasAttribute("morphNormal"+v)===!0&&u.deleteAttribute("morphNormal"+v),s[v]=0)}const y=u.morphTargetsRelative?1:1-m;h.getUniforms().setValue(n,"morphTargetBaseInfluence",y),h.getUniforms().setValue(n,"morphTargetInfluences",s)}}return{update:c}}function ID(n,e,t,r){let s=new WeakMap;function i(c){const l=r.render.frame,u=c.geometry,h=e.get(c,u);if(s.get(h)!==l&&(e.update(h),s.set(h,l)),c.isInstancedMesh&&(c.hasEventListener("dispose",a)===!1&&c.addEventListener("dispose",a),s.get(c)!==l&&(t.update(c.instanceMatrix,n.ARRAY_BUFFER),c.instanceColor!==null&&t.update(c.instanceColor,n.ARRAY_BUFFER),s.set(c,l))),c.isSkinnedMesh){const d=c.skeleton;s.get(d)!==l&&(d.update(),s.set(d,l))}return h}function o(){s=new WeakMap}function a(c){const l=c.target;l.removeEventListener("dispose",a),t.remove(l.instanceMatrix),l.instanceColor!==null&&t.remove(l.instanceColor)}return{update:i,dispose:o}}class Gg extends Wn{constructor(e,t,r,s,i,o,a,c,l,u){if(u=u!==void 0?u:To,u!==To&&u!==nc)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");r===void 0&&u===To&&(r=Oi),r===void 0&&u===nc&&(r=Gi),super(null,s,i,o,a,c,u,r,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=a!==void 0?a:jt,this.minFilter=c!==void 0?c:jt,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return this.compareFunction!==null&&(t.compareFunction=this.compareFunction),t}}const KA=new Wn,ZA=new Gg(1,1);ZA.compareFunction=UA;const JA=new VA,QA=new gN,eT=new qA,dx=[],px=[],fx=new Float32Array(16),mx=new Float32Array(9),_x=new Float32Array(4);function yc(n,e,t){const r=n[0];if(r<=0||r>0)return n;const s=e*t;let i=dx[s];if(i===void 0&&(i=new Float32Array(s),dx[s]=i),e!==0){r.toArray(i,0);for(let o=1,a=0;o!==e;++o)a+=t,n[o].toArray(i,a)}return i}function En(n,e){if(n.length!==e.length)return!1;for(let t=0,r=n.length;t<r;t++)if(n[t]!==e[t])return!1;return!0}function Sn(n,e){for(let t=0,r=e.length;t<r;t++)n[t]=e[t]}function mp(n,e){let t=px[e];t===void 0&&(t=new Int32Array(e),px[e]=t);for(let r=0;r!==e;++r)t[r]=n.allocateTextureUnit();return t}function DD(n,e){const t=this.cache;t[0]!==e&&(n.uniform1f(this.addr,e),t[0]=e)}function LD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(n.uniform2f(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(En(t,e))return;n.uniform2fv(this.addr,e),Sn(t,e)}}function FD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(n.uniform3f(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else if(e.r!==void 0)(t[0]!==e.r||t[1]!==e.g||t[2]!==e.b)&&(n.uniform3f(this.addr,e.r,e.g,e.b),t[0]=e.r,t[1]=e.g,t[2]=e.b);else{if(En(t,e))return;n.uniform3fv(this.addr,e),Sn(t,e)}}function UD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(n.uniform4f(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(En(t,e))return;n.uniform4fv(this.addr,e),Sn(t,e)}}function kD(n,e){const t=this.cache,r=e.elements;if(r===void 0){if(En(t,e))return;n.uniformMatrix2fv(this.addr,!1,e),Sn(t,e)}else{if(En(t,r))return;_x.set(r),n.uniformMatrix2fv(this.addr,!1,_x),Sn(t,r)}}function BD(n,e){const t=this.cache,r=e.elements;if(r===void 0){if(En(t,e))return;n.uniformMatrix3fv(this.addr,!1,e),Sn(t,e)}else{if(En(t,r))return;mx.set(r),n.uniformMatrix3fv(this.addr,!1,mx),Sn(t,r)}}function GD(n,e){const t=this.cache,r=e.elements;if(r===void 0){if(En(t,e))return;n.uniformMatrix4fv(this.addr,!1,e),Sn(t,e)}else{if(En(t,r))return;fx.set(r),n.uniformMatrix4fv(this.addr,!1,fx),Sn(t,r)}}function VD(n,e){const t=this.cache;t[0]!==e&&(n.uniform1i(this.addr,e),t[0]=e)}function zD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(n.uniform2i(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(En(t,e))return;n.uniform2iv(this.addr,e),Sn(t,e)}}function HD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(n.uniform3i(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else{if(En(t,e))return;n.uniform3iv(this.addr,e),Sn(t,e)}}function jD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(n.uniform4i(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(En(t,e))return;n.uniform4iv(this.addr,e),Sn(t,e)}}function WD(n,e){const t=this.cache;t[0]!==e&&(n.uniform1ui(this.addr,e),t[0]=e)}function XD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(n.uniform2ui(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(En(t,e))return;n.uniform2uiv(this.addr,e),Sn(t,e)}}function $D(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(n.uniform3ui(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else{if(En(t,e))return;n.uniform3uiv(this.addr,e),Sn(t,e)}}function qD(n,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(n.uniform4ui(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(En(t,e))return;n.uniform4uiv(this.addr,e),Sn(t,e)}}function YD(n,e,t){const r=this.cache,s=t.allocateTextureUnit();r[0]!==s&&(n.uniform1i(this.addr,s),r[0]=s);const i=this.type===n.SAMPLER_2D_SHADOW?ZA:KA;t.setTexture2D(e||i,s)}function KD(n,e,t){const r=this.cache,s=t.allocateTextureUnit();r[0]!==s&&(n.uniform1i(this.addr,s),r[0]=s),t.setTexture3D(e||QA,s)}function ZD(n,e,t){const r=this.cache,s=t.allocateTextureUnit();r[0]!==s&&(n.uniform1i(this.addr,s),r[0]=s),t.setTextureCube(e||eT,s)}function JD(n,e,t){const r=this.cache,s=t.allocateTextureUnit();r[0]!==s&&(n.uniform1i(this.addr,s),r[0]=s),t.setTexture2DArray(e||JA,s)}function QD(n){switch(n){case 5126:return DD;case 35664:return LD;case 35665:return FD;case 35666:return UD;case 35674:return kD;case 35675:return BD;case 35676:return GD;case 5124:case 35670:return VD;case 35667:case 35671:return zD;case 35668:case 35672:return HD;case 35669:case 35673:return jD;case 5125:return WD;case 36294:return XD;case 36295:return $D;case 36296:return qD;case 35678:case 36198:case 36298:case 36306:case 35682:return YD;case 35679:case 36299:case 36307:return KD;case 35680:case 36300:case 36308:case 36293:return ZD;case 36289:case 36303:case 36311:case 36292:return JD}}function eL(n,e){n.uniform1fv(this.addr,e)}function tL(n,e){const t=yc(e,this.size,2);n.uniform2fv(this.addr,t)}function nL(n,e){const t=yc(e,this.size,3);n.uniform3fv(this.addr,t)}function rL(n,e){const t=yc(e,this.size,4);n.uniform4fv(this.addr,t)}function sL(n,e){const t=yc(e,this.size,4);n.uniformMatrix2fv(this.addr,!1,t)}function iL(n,e){const t=yc(e,this.size,9);n.uniformMatrix3fv(this.addr,!1,t)}function oL(n,e){const t=yc(e,this.size,16);n.uniformMatrix4fv(this.addr,!1,t)}function aL(n,e){n.uniform1iv(this.addr,e)}function cL(n,e){n.uniform2iv(this.addr,e)}function lL(n,e){n.uniform3iv(this.addr,e)}function uL(n,e){n.uniform4iv(this.addr,e)}function hL(n,e){n.uniform1uiv(this.addr,e)}function dL(n,e){n.uniform2uiv(this.addr,e)}function pL(n,e){n.uniform3uiv(this.addr,e)}function fL(n,e){n.uniform4uiv(this.addr,e)}function mL(n,e,t){const r=this.cache,s=e.length,i=mp(t,s);En(r,i)||(n.uniform1iv(this.addr,i),Sn(r,i));for(let o=0;o!==s;++o)t.setTexture2D(e[o]||KA,i[o])}function _L(n,e,t){const r=this.cache,s=e.length,i=mp(t,s);En(r,i)||(n.uniform1iv(this.addr,i),Sn(r,i));for(let o=0;o!==s;++o)t.setTexture3D(e[o]||QA,i[o])}function gL(n,e,t){const r=this.cache,s=e.length,i=mp(t,s);En(r,i)||(n.uniform1iv(this.addr,i),Sn(r,i));for(let o=0;o!==s;++o)t.setTextureCube(e[o]||eT,i[o])}function vL(n,e,t){const r=this.cache,s=e.length,i=mp(t,s);En(r,i)||(n.uniform1iv(this.addr,i),Sn(r,i));for(let o=0;o!==s;++o)t.setTexture2DArray(e[o]||JA,i[o])}function yL(n){switch(n){case 5126:return eL;case 35664:return tL;case 35665:return nL;case 35666:return rL;case 35674:return sL;case 35675:return iL;case 35676:return oL;case 5124:case 35670:return aL;case 35667:case 35671:return cL;case 35668:case 35672:return lL;case 35669:case 35673:return uL;case 5125:return hL;case 36294:return dL;case 36295:return pL;case 36296:return fL;case 35678:case 36198:case 36298:case 36306:case 35682:return mL;case 35679:case 36299:case 36307:return _L;case 35680:case 36300:case 36308:case 36293:return gL;case 36289:case 36303:case 36311:case 36292:return vL}}class xL{constructor(e,t,r){this.id=e,this.addr=r,this.cache=[],this.type=t.type,this.setValue=QD(t.type)}}class bL{constructor(e,t,r){this.id=e,this.addr=r,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=yL(t.type)}}class CL{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,r){const s=this.seq;for(let i=0,o=s.length;i!==o;++i){const a=s[i];a.setValue(e,t[a.id],r)}}}const Pf=/(\w+)(\])?(\[|\.)?/g;function gx(n,e){n.seq.push(e),n.map[e.id]=e}function EL(n,e,t){const r=n.name,s=r.length;for(Pf.lastIndex=0;;){const i=Pf.exec(r),o=Pf.lastIndex;let a=i[1];const c=i[2]==="]",l=i[3];if(c&&(a=a|0),l===void 0||l==="["&&o+2===s){gx(t,l===void 0?new xL(a,n,e):new bL(a,n,e));break}else{let h=t.map[a];h===void 0&&(h=new CL(a),gx(t,h)),t=h}}}class hd{constructor(e,t){this.seq=[],this.map={};const r=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let s=0;s<r;++s){const i=e.getActiveUniform(t,s),o=e.getUniformLocation(t,i.name);EL(i,o,this)}}setValue(e,t,r,s){const i=this.map[t];i!==void 0&&i.setValue(e,r,s)}setOptional(e,t,r){const s=t[r];s!==void 0&&this.setValue(e,r,s)}static upload(e,t,r,s){for(let i=0,o=t.length;i!==o;++i){const a=t[i],c=r[a.id];c.needsUpdate!==!1&&a.setValue(e,c.value,s)}}static seqWithValue(e,t){const r=[];for(let s=0,i=e.length;s!==i;++s){const o=e[s];o.id in t&&r.push(o)}return r}}function vx(n,e,t){const r=n.createShader(e);return n.shaderSource(r,t),n.compileShader(r),r}const SL=37297;let AL=0;function TL(n,e){const t=n.split(`
`),r=[],s=Math.max(e-6,0),i=Math.min(e+6,t.length);for(let o=s;o<i;o++){const a=o+1;r.push(`${a===e?">":" "} ${a}: ${t[o]}`)}return r.join(`
`)}function ML(n){const e=Rt.getPrimaries(Rt.workingColorSpace),t=Rt.getPrimaries(n);let r;switch(e===t?r="":e===Ld&&t===Dd?r="LinearDisplayP3ToLinearSRGB":e===Dd&&t===Ld&&(r="LinearSRGBToLinearDisplayP3"),n){case kr:case Fo:return[r,"LinearTransferOETF"];case nn:case gc:return[r,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space:",n),[r,"LinearTransferOETF"]}}function yx(n,e,t){const r=n.getShaderParameter(e,n.COMPILE_STATUS),s=n.getShaderInfoLog(e).trim();if(r&&s==="")return"";const i=/ERROR: 0:(\d+)/.exec(s);if(i){const o=parseInt(i[1]);return t.toUpperCase()+`

`+s+`

`+TL(n.getShaderSource(e),o)}else return s}function RL(n,e){const t=ML(e);return`vec4 ${n}( vec4 value ) { return ${t[0]}( ${t[1]}( value ) ); }`}function wL(n,e){let t;switch(e){case SA:t="Linear";break;case AA:t="Reinhard";break;case TA:t="OptimizedCineon";break;case MA:t="ACESFilmic";break;case IP:t="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),t="Linear"}return"vec3 "+n+"( vec3 color ) { return "+t+"ToneMapping( color ); }"}function OL(n){return[n.extensionDerivatives||n.envMapCubeUVHeight||n.bumpMap||n.normalMapTangentSpace||n.clearcoatNormalMap||n.flatShading||n.shaderID==="physical"?"#extension GL_OES_standard_derivatives : enable":"",(n.extensionFragDepth||n.logarithmicDepthBuffer)&&n.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",n.extensionDrawBuffers&&n.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(n.extensionShaderTextureLOD||n.envMap||n.transmission)&&n.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(ol).join(`
`)}function PL(n){const e=[];for(const t in n){const r=n[t];r!==!1&&e.push("#define "+t+" "+r)}return e.join(`
`)}function NL(n,e){const t={},r=n.getProgramParameter(e,n.ACTIVE_ATTRIBUTES);for(let s=0;s<r;s++){const i=n.getActiveAttrib(e,s),o=i.name;let a=1;i.type===n.FLOAT_MAT2&&(a=2),i.type===n.FLOAT_MAT3&&(a=3),i.type===n.FLOAT_MAT4&&(a=4),t[o]={type:i.type,location:n.getAttribLocation(e,o),locationSize:a}}return t}function ol(n){return n!==""}function xx(n,e){const t=e.numSpotLightShadows+e.numSpotLightMaps-e.numSpotLightShadowsWithMaps;return n.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,e.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,t).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,e.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function bx(n,e){return n.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const IL=/^[ \t]*#include +<([\w\d./]+)>/gm;function p_(n){return n.replace(IL,LL)}const DL=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function LL(n,e){let t=lt[e];if(t===void 0){const r=DL.get(e);if(r!==void 0)t=lt[r],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',e,r);else throw new Error("Can not resolve #include <"+e+">")}return p_(t)}const FL=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Cx(n){return n.replace(FL,UL)}function UL(n,e,t,r){let s="";for(let i=parseInt(e);i<parseInt(t);i++)s+=r.replace(/\[\s*i\s*\]/g,"[ "+i+" ]").replace(/UNROLLED_LOOP_INDEX/g,i);return s}function Ex(n){let e="precision "+n.precision+` float;
precision `+n.precision+" int;";return n.precision==="highp"?e+=`
#define HIGH_PRECISION`:n.precision==="mediump"?e+=`
#define MEDIUM_PRECISION`:n.precision==="lowp"&&(e+=`
#define LOW_PRECISION`),e}function kL(n){let e="SHADOWMAP_TYPE_BASIC";return n.shadowMapType===Og?e="SHADOWMAP_TYPE_PCF":n.shadowMapType===EA?e="SHADOWMAP_TYPE_PCF_SOFT":n.shadowMapType===hs&&(e="SHADOWMAP_TYPE_VSM"),e}function BL(n){let e="ENVMAP_TYPE_CUBE";if(n.envMap)switch(n.envMapMode){case Qa:case ec:e="ENVMAP_TYPE_CUBE";break;case pp:e="ENVMAP_TYPE_CUBE_UV";break}return e}function GL(n){let e="ENVMAP_MODE_REFLECTION";if(n.envMap)switch(n.envMapMode){case ec:e="ENVMAP_MODE_REFRACTION";break}return e}function VL(n){let e="ENVMAP_BLENDING_NONE";if(n.envMap)switch(n.combine){case _c:e="ENVMAP_BLENDING_MULTIPLY";break;case Pg:e="ENVMAP_BLENDING_MIX";break;case Ng:e="ENVMAP_BLENDING_ADD";break}return e}function zL(n){const e=n.envMapCubeUVHeight;if(e===null)return null;const t=Math.log2(e)-2,r=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,t),7*16)),texelHeight:r,maxMip:t}}function HL(n,e,t,r){const s=n.getContext(),i=t.defines;let o=t.vertexShader,a=t.fragmentShader;const c=kL(t),l=BL(t),u=GL(t),h=VL(t),d=zL(t),p=t.isWebGL2?"":OL(t),_=PL(i),g=s.createProgram();let f,m,y=t.glslVersion?"#version "+t.glslVersion+`
`:"";t.isRawShaderMaterial?(f=["#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,_].filter(ol).join(`
`),f.length>0&&(f+=`
`),m=[p,"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,_].filter(ol).join(`
`),m.length>0&&(m+=`
`)):(f=[Ex(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,_,t.batching?"#define USE_BATCHING":"",t.instancing?"#define USE_INSTANCING":"",t.instancingColor?"#define USE_INSTANCING_COLOR":"",t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+u:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.displacementMap?"#define USE_DISPLACEMENTMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.mapUv?"#define MAP_UV "+t.mapUv:"",t.alphaMapUv?"#define ALPHAMAP_UV "+t.alphaMapUv:"",t.lightMapUv?"#define LIGHTMAP_UV "+t.lightMapUv:"",t.aoMapUv?"#define AOMAP_UV "+t.aoMapUv:"",t.emissiveMapUv?"#define EMISSIVEMAP_UV "+t.emissiveMapUv:"",t.bumpMapUv?"#define BUMPMAP_UV "+t.bumpMapUv:"",t.normalMapUv?"#define NORMALMAP_UV "+t.normalMapUv:"",t.displacementMapUv?"#define DISPLACEMENTMAP_UV "+t.displacementMapUv:"",t.metalnessMapUv?"#define METALNESSMAP_UV "+t.metalnessMapUv:"",t.roughnessMapUv?"#define ROUGHNESSMAP_UV "+t.roughnessMapUv:"",t.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+t.anisotropyMapUv:"",t.clearcoatMapUv?"#define CLEARCOATMAP_UV "+t.clearcoatMapUv:"",t.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+t.clearcoatNormalMapUv:"",t.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+t.clearcoatRoughnessMapUv:"",t.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+t.iridescenceMapUv:"",t.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+t.iridescenceThicknessMapUv:"",t.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+t.sheenColorMapUv:"",t.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+t.sheenRoughnessMapUv:"",t.specularMapUv?"#define SPECULARMAP_UV "+t.specularMapUv:"",t.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+t.specularColorMapUv:"",t.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+t.specularIntensityMapUv:"",t.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+t.transmissionMapUv:"",t.thicknessMapUv?"#define THICKNESSMAP_UV "+t.thicknessMapUv:"",t.vertexTangents&&t.flatShading===!1?"#define USE_TANGENT":"",t.vertexColors?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.flatShading?"#define FLAT_SHADED":"",t.skinning?"#define USE_SKINNING":"",t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals&&t.flatShading===!1?"#define USE_MORPHNORMALS":"",t.morphColors&&t.isWebGL2?"#define USE_MORPHCOLORS":"",t.morphTargetsCount>0&&t.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",t.morphTargetsCount>0&&t.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+t.morphTextureStride:"",t.morphTargetsCount>0&&t.isWebGL2?"#define MORPHTARGETS_COUNT "+t.morphTargetsCount:"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+c:"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.numLightProbes>0?"#define USE_LIGHT_PROBES":"",t.useLegacyLights?"#define LEGACY_LIGHTS":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","	attribute vec2 uv1;","#endif","#ifdef USE_UV2","	attribute vec2 uv2;","#endif","#ifdef USE_UV3","	attribute vec2 uv3;","#endif","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","	attribute vec3 morphTarget0;","	attribute vec3 morphTarget1;","	attribute vec3 morphTarget2;","	attribute vec3 morphTarget3;","	#ifdef USE_MORPHNORMALS","		attribute vec3 morphNormal0;","		attribute vec3 morphNormal1;","		attribute vec3 morphNormal2;","		attribute vec3 morphNormal3;","	#else","		attribute vec3 morphTarget4;","		attribute vec3 morphTarget5;","		attribute vec3 morphTarget6;","		attribute vec3 morphTarget7;","	#endif","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter(ol).join(`
`),m=[p,Ex(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,_,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.matcap?"#define USE_MATCAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+l:"",t.envMap?"#define "+u:"",t.envMap?"#define "+h:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoat?"#define USE_CLEARCOAT":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.iridescence?"#define USE_IRIDESCENCE":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaTest?"#define USE_ALPHATEST":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.sheen?"#define USE_SHEEN":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.vertexTangents&&t.flatShading===!1?"#define USE_TANGENT":"",t.vertexColors||t.instancingColor?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.gradientMap?"#define USE_GRADIENTMAP":"",t.flatShading?"#define FLAT_SHADED":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+c:"",t.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",t.numLightProbes>0?"#define USE_LIGHT_PROBES":"",t.useLegacyLights?"#define LEGACY_LIGHTS":"",t.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",t.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",t.logarithmicDepthBuffer&&t.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",t.toneMapping!==Fr?"#define TONE_MAPPING":"",t.toneMapping!==Fr?lt.tonemapping_pars_fragment:"",t.toneMapping!==Fr?wL("toneMapping",t.toneMapping):"",t.dithering?"#define DITHERING":"",t.opaque?"#define OPAQUE":"",lt.colorspace_pars_fragment,RL("linearToOutputTexel",t.outputColorSpace),t.useDepthPacking?"#define DEPTH_PACKING "+t.depthPacking:"",`
`].filter(ol).join(`
`)),o=p_(o),o=xx(o,t),o=bx(o,t),a=p_(a),a=xx(a,t),a=bx(a,t),o=Cx(o),a=Cx(a),t.isWebGL2&&t.isRawShaderMaterial!==!0&&(y=`#version 300 es
`,f=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+f,m=["precision mediump sampler2DArray;","#define varying in",t.glslVersion===Vy?"":"layout(location = 0) out highp vec4 pc_fragColor;",t.glslVersion===Vy?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join(`
`)+`
`+m);const v=y+f+o,b=y+m+a,x=vx(s,s.VERTEX_SHADER,v),E=vx(s,s.FRAGMENT_SHADER,b);s.attachShader(g,x),s.attachShader(g,E),t.index0AttributeName!==void 0?s.bindAttribLocation(g,0,t.index0AttributeName):t.morphTargets===!0&&s.bindAttribLocation(g,0,"position"),s.linkProgram(g);function S(G){if(n.debug.checkShaderErrors){const F=s.getProgramInfoLog(g).trim(),X=s.getShaderInfoLog(x).trim(),N=s.getShaderInfoLog(E).trim();let j=!0,K=!0;if(s.getProgramParameter(g,s.LINK_STATUS)===!1)if(j=!1,typeof n.debug.onShaderError=="function")n.debug.onShaderError(s,g,x,E);else{const $=yx(s,x,"vertex"),q=yx(s,E,"fragment");console.error("THREE.WebGLProgram: Shader Error "+s.getError()+" - VALIDATE_STATUS "+s.getProgramParameter(g,s.VALIDATE_STATUS)+`

Program Info Log: `+F+`
`+$+`
`+q)}else F!==""?console.warn("THREE.WebGLProgram: Program Info Log:",F):(X===""||N==="")&&(K=!1);K&&(G.diagnostics={runnable:j,programLog:F,vertexShader:{log:X,prefix:f},fragmentShader:{log:N,prefix:m}})}s.deleteShader(x),s.deleteShader(E),R=new hd(s,g),C=NL(s,g)}let R;this.getUniforms=function(){return R===void 0&&S(this),R};let C;this.getAttributes=function(){return C===void 0&&S(this),C};let M=t.rendererExtensionParallelShaderCompile===!1;return this.isReady=function(){return M===!1&&(M=s.getProgramParameter(g,SL)),M},this.destroy=function(){r.releaseStatesOfProgram(this),s.deleteProgram(g),this.program=void 0},this.type=t.shaderType,this.name=t.shaderName,this.id=AL++,this.cacheKey=e,this.usedTimes=1,this.program=g,this.vertexShader=x,this.fragmentShader=E,this}let jL=0;class WL{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,r=e.fragmentShader,s=this._getShaderStage(t),i=this._getShaderStage(r),o=this._getShaderCacheForMaterial(e);return o.has(s)===!1&&(o.add(s),s.usedTimes++),o.has(i)===!1&&(o.add(i),i.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const r of t)r.usedTimes--,r.usedTimes===0&&this.shaderCache.delete(r.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let r=t.get(e);return r===void 0&&(r=new Set,t.set(e,r)),r}_getShaderStage(e){const t=this.shaderCache;let r=t.get(e);return r===void 0&&(r=new XL(e),t.set(e,r)),r}}class XL{constructor(e){this.id=jL++,this.code=e,this.usedTimes=0}}function $L(n,e,t,r,s,i,o){const a=new Fg,c=new WL,l=[],u=s.isWebGL2,h=s.logarithmicDepthBuffer,d=s.vertexTextures;let p=s.precision;const _={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function g(C){return C===0?"uv":`uv${C}`}function f(C,M,G,F,X){const N=F.fog,j=X.geometry,K=C.isMeshStandardMaterial?F.environment:null,$=(C.isMeshStandardMaterial?t:e).get(C.envMap||K),q=$&&$.mapping===pp?$.image.height:null,ne=_[C.type];C.precision!==null&&(p=s.getMaxPrecision(C.precision),p!==C.precision&&console.warn("THREE.WebGLProgram.getParameters:",C.precision,"not supported, using",p,"instead."));const le=j.morphAttributes.position||j.morphAttributes.normal||j.morphAttributes.color,ue=le!==void 0?le.length:0;let Ee=0;j.morphAttributes.position!==void 0&&(Ee=1),j.morphAttributes.normal!==void 0&&(Ee=2),j.morphAttributes.color!==void 0&&(Ee=3);let de,V,B,P;if(ne){const Xt=ms[ne];de=Xt.vertexShader,V=Xt.fragmentShader}else de=C.vertexShader,V=C.fragmentShader,c.update(C),B=c.getVertexShaderID(C),P=c.getFragmentShaderID(C);const O=n.getRenderTarget(),se=X.isInstancedMesh===!0,_e=X.isBatchedMesh===!0,Z=!!C.map,me=!!C.matcap,L=!!$,oe=!!C.aoMap,H=!!C.lightMap,Q=!!C.bumpMap,ee=!!C.normalMap,ge=!!C.displacementMap,z=!!C.emissiveMap,D=!!C.metalnessMap,ye=!!C.roughnessMap,Ie=C.anisotropy>0,ot=C.clearcoat>0,U=C.iridescence>0,w=C.sheen>0,re=C.transmission>0,Se=Ie&&!!C.anisotropyMap,Ce=ot&&!!C.clearcoatMap,Ae=ot&&!!C.clearcoatNormalMap,Ve=ot&&!!C.clearcoatRoughnessMap,Re=U&&!!C.iridescenceMap,Ne=U&&!!C.iridescenceThicknessMap,Ze=w&&!!C.sheenColorMap,pt=w&&!!C.sheenRoughnessMap,k=!!C.specularMap,we=!!C.specularColorMap,je=!!C.specularIntensityMap,Be=re&&!!C.transmissionMap,Ge=re&&!!C.thicknessMap,De=!!C.gradientMap,st=!!C.alphaMap,Y=C.alphaTest>0,Ue=!!C.alphaHash,Te=!!C.extensions,pe=!!j.attributes.uv1,Me=!!j.attributes.uv2,Je=!!j.attributes.uv3;let ft=Fr;return C.toneMapped&&(O===null||O.isXRRenderTarget===!0)&&(ft=n.toneMapping),{isWebGL2:u,shaderID:ne,shaderType:C.type,shaderName:C.name,vertexShader:de,fragmentShader:V,defines:C.defines,customVertexShaderID:B,customFragmentShaderID:P,isRawShaderMaterial:C.isRawShaderMaterial===!0,glslVersion:C.glslVersion,precision:p,batching:_e,instancing:se,instancingColor:se&&X.instanceColor!==null,supportsVertexTextures:d,outputColorSpace:O===null?n.outputColorSpace:O.isXRRenderTarget===!0?O.texture.colorSpace:kr,map:Z,matcap:me,envMap:L,envMapMode:L&&$.mapping,envMapCubeUVHeight:q,aoMap:oe,lightMap:H,bumpMap:Q,normalMap:ee,displacementMap:d&&ge,emissiveMap:z,normalMapObjectSpace:ee&&C.normalMapType===Dg,normalMapTangentSpace:ee&&C.normalMapType===ti,metalnessMap:D,roughnessMap:ye,anisotropy:Ie,anisotropyMap:Se,clearcoat:ot,clearcoatMap:Ce,clearcoatNormalMap:Ae,clearcoatRoughnessMap:Ve,iridescence:U,iridescenceMap:Re,iridescenceThicknessMap:Ne,sheen:w,sheenColorMap:Ze,sheenRoughnessMap:pt,specularMap:k,specularColorMap:we,specularIntensityMap:je,transmission:re,transmissionMap:Be,thicknessMap:Ge,gradientMap:De,opaque:C.transparent===!1&&C.blending===ki,alphaMap:st,alphaTest:Y,alphaHash:Ue,combine:C.combine,mapUv:Z&&g(C.map.channel),aoMapUv:oe&&g(C.aoMap.channel),lightMapUv:H&&g(C.lightMap.channel),bumpMapUv:Q&&g(C.bumpMap.channel),normalMapUv:ee&&g(C.normalMap.channel),displacementMapUv:ge&&g(C.displacementMap.channel),emissiveMapUv:z&&g(C.emissiveMap.channel),metalnessMapUv:D&&g(C.metalnessMap.channel),roughnessMapUv:ye&&g(C.roughnessMap.channel),anisotropyMapUv:Se&&g(C.anisotropyMap.channel),clearcoatMapUv:Ce&&g(C.clearcoatMap.channel),clearcoatNormalMapUv:Ae&&g(C.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:Ve&&g(C.clearcoatRoughnessMap.channel),iridescenceMapUv:Re&&g(C.iridescenceMap.channel),iridescenceThicknessMapUv:Ne&&g(C.iridescenceThicknessMap.channel),sheenColorMapUv:Ze&&g(C.sheenColorMap.channel),sheenRoughnessMapUv:pt&&g(C.sheenRoughnessMap.channel),specularMapUv:k&&g(C.specularMap.channel),specularColorMapUv:we&&g(C.specularColorMap.channel),specularIntensityMapUv:je&&g(C.specularIntensityMap.channel),transmissionMapUv:Be&&g(C.transmissionMap.channel),thicknessMapUv:Ge&&g(C.thicknessMap.channel),alphaMapUv:st&&g(C.alphaMap.channel),vertexTangents:!!j.attributes.tangent&&(ee||Ie),vertexColors:C.vertexColors,vertexAlphas:C.vertexColors===!0&&!!j.attributes.color&&j.attributes.color.itemSize===4,vertexUv1s:pe,vertexUv2s:Me,vertexUv3s:Je,pointsUvs:X.isPoints===!0&&!!j.attributes.uv&&(Z||st),fog:!!N,useFog:C.fog===!0,fogExp2:N&&N.isFogExp2,flatShading:C.flatShading===!0,sizeAttenuation:C.sizeAttenuation===!0,logarithmicDepthBuffer:h,skinning:X.isSkinnedMesh===!0,morphTargets:j.morphAttributes.position!==void 0,morphNormals:j.morphAttributes.normal!==void 0,morphColors:j.morphAttributes.color!==void 0,morphTargetsCount:ue,morphTextureStride:Ee,numDirLights:M.directional.length,numPointLights:M.point.length,numSpotLights:M.spot.length,numSpotLightMaps:M.spotLightMap.length,numRectAreaLights:M.rectArea.length,numHemiLights:M.hemi.length,numDirLightShadows:M.directionalShadowMap.length,numPointLightShadows:M.pointShadowMap.length,numSpotLightShadows:M.spotShadowMap.length,numSpotLightShadowsWithMaps:M.numSpotLightShadowsWithMaps,numLightProbes:M.numLightProbes,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:C.dithering,shadowMapEnabled:n.shadowMap.enabled&&G.length>0,shadowMapType:n.shadowMap.type,toneMapping:ft,useLegacyLights:n._useLegacyLights,decodeVideoTexture:Z&&C.map.isVideoTexture===!0&&Rt.getTransfer(C.map.colorSpace)===kt,premultipliedAlpha:C.premultipliedAlpha,doubleSided:C.side===er,flipSided:C.side===bn,useDepthPacking:C.depthPacking>=0,depthPacking:C.depthPacking||0,index0AttributeName:C.index0AttributeName,extensionDerivatives:Te&&C.extensions.derivatives===!0,extensionFragDepth:Te&&C.extensions.fragDepth===!0,extensionDrawBuffers:Te&&C.extensions.drawBuffers===!0,extensionShaderTextureLOD:Te&&C.extensions.shaderTextureLOD===!0,rendererExtensionFragDepth:u||r.has("EXT_frag_depth"),rendererExtensionDrawBuffers:u||r.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:u||r.has("EXT_shader_texture_lod"),rendererExtensionParallelShaderCompile:r.has("KHR_parallel_shader_compile"),customProgramCacheKey:C.customProgramCacheKey()}}function m(C){const M=[];if(C.shaderID?M.push(C.shaderID):(M.push(C.customVertexShaderID),M.push(C.customFragmentShaderID)),C.defines!==void 0)for(const G in C.defines)M.push(G),M.push(C.defines[G]);return C.isRawShaderMaterial===!1&&(y(M,C),v(M,C),M.push(n.outputColorSpace)),M.push(C.customProgramCacheKey),M.join()}function y(C,M){C.push(M.precision),C.push(M.outputColorSpace),C.push(M.envMapMode),C.push(M.envMapCubeUVHeight),C.push(M.mapUv),C.push(M.alphaMapUv),C.push(M.lightMapUv),C.push(M.aoMapUv),C.push(M.bumpMapUv),C.push(M.normalMapUv),C.push(M.displacementMapUv),C.push(M.emissiveMapUv),C.push(M.metalnessMapUv),C.push(M.roughnessMapUv),C.push(M.anisotropyMapUv),C.push(M.clearcoatMapUv),C.push(M.clearcoatNormalMapUv),C.push(M.clearcoatRoughnessMapUv),C.push(M.iridescenceMapUv),C.push(M.iridescenceThicknessMapUv),C.push(M.sheenColorMapUv),C.push(M.sheenRoughnessMapUv),C.push(M.specularMapUv),C.push(M.specularColorMapUv),C.push(M.specularIntensityMapUv),C.push(M.transmissionMapUv),C.push(M.thicknessMapUv),C.push(M.combine),C.push(M.fogExp2),C.push(M.sizeAttenuation),C.push(M.morphTargetsCount),C.push(M.morphAttributeCount),C.push(M.numDirLights),C.push(M.numPointLights),C.push(M.numSpotLights),C.push(M.numSpotLightMaps),C.push(M.numHemiLights),C.push(M.numRectAreaLights),C.push(M.numDirLightShadows),C.push(M.numPointLightShadows),C.push(M.numSpotLightShadows),C.push(M.numSpotLightShadowsWithMaps),C.push(M.numLightProbes),C.push(M.shadowMapType),C.push(M.toneMapping),C.push(M.numClippingPlanes),C.push(M.numClipIntersection),C.push(M.depthPacking)}function v(C,M){a.disableAll(),M.isWebGL2&&a.enable(0),M.supportsVertexTextures&&a.enable(1),M.instancing&&a.enable(2),M.instancingColor&&a.enable(3),M.matcap&&a.enable(4),M.envMap&&a.enable(5),M.normalMapObjectSpace&&a.enable(6),M.normalMapTangentSpace&&a.enable(7),M.clearcoat&&a.enable(8),M.iridescence&&a.enable(9),M.alphaTest&&a.enable(10),M.vertexColors&&a.enable(11),M.vertexAlphas&&a.enable(12),M.vertexUv1s&&a.enable(13),M.vertexUv2s&&a.enable(14),M.vertexUv3s&&a.enable(15),M.vertexTangents&&a.enable(16),M.anisotropy&&a.enable(17),M.alphaHash&&a.enable(18),M.batching&&a.enable(19),C.push(a.mask),a.disableAll(),M.fog&&a.enable(0),M.useFog&&a.enable(1),M.flatShading&&a.enable(2),M.logarithmicDepthBuffer&&a.enable(3),M.skinning&&a.enable(4),M.morphTargets&&a.enable(5),M.morphNormals&&a.enable(6),M.morphColors&&a.enable(7),M.premultipliedAlpha&&a.enable(8),M.shadowMapEnabled&&a.enable(9),M.useLegacyLights&&a.enable(10),M.doubleSided&&a.enable(11),M.flipSided&&a.enable(12),M.useDepthPacking&&a.enable(13),M.dithering&&a.enable(14),M.transmission&&a.enable(15),M.sheen&&a.enable(16),M.opaque&&a.enable(17),M.pointsUvs&&a.enable(18),M.decodeVideoTexture&&a.enable(19),C.push(a.mask)}function b(C){const M=_[C.type];let G;if(M){const F=ms[M];G=XA.clone(F.uniforms)}else G=C.uniforms;return G}function x(C,M){let G;for(let F=0,X=l.length;F<X;F++){const N=l[F];if(N.cacheKey===M){G=N,++G.usedTimes;break}}return G===void 0&&(G=new HL(n,M,C,i),l.push(G)),G}function E(C){if(--C.usedTimes===0){const M=l.indexOf(C);l[M]=l[l.length-1],l.pop(),C.destroy()}}function S(C){c.remove(C)}function R(){c.dispose()}return{getParameters:f,getProgramCacheKey:m,getUniforms:b,acquireProgram:x,releaseProgram:E,releaseShaderCache:S,programs:l,dispose:R}}function qL(){let n=new WeakMap;function e(i){let o=n.get(i);return o===void 0&&(o={},n.set(i,o)),o}function t(i){n.delete(i)}function r(i,o,a){n.get(i)[o]=a}function s(){n=new WeakMap}return{get:e,remove:t,update:r,dispose:s}}function YL(n,e){return n.groupOrder!==e.groupOrder?n.groupOrder-e.groupOrder:n.renderOrder!==e.renderOrder?n.renderOrder-e.renderOrder:n.material.id!==e.material.id?n.material.id-e.material.id:n.z!==e.z?n.z-e.z:n.id-e.id}function Sx(n,e){return n.groupOrder!==e.groupOrder?n.groupOrder-e.groupOrder:n.renderOrder!==e.renderOrder?n.renderOrder-e.renderOrder:n.z!==e.z?e.z-n.z:n.id-e.id}function Ax(){const n=[];let e=0;const t=[],r=[],s=[];function i(){e=0,t.length=0,r.length=0,s.length=0}function o(h,d,p,_,g,f){let m=n[e];return m===void 0?(m={id:h.id,object:h,geometry:d,material:p,groupOrder:_,renderOrder:h.renderOrder,z:g,group:f},n[e]=m):(m.id=h.id,m.object=h,m.geometry=d,m.material=p,m.groupOrder=_,m.renderOrder=h.renderOrder,m.z=g,m.group=f),e++,m}function a(h,d,p,_,g,f){const m=o(h,d,p,_,g,f);p.transmission>0?r.push(m):p.transparent===!0?s.push(m):t.push(m)}function c(h,d,p,_,g,f){const m=o(h,d,p,_,g,f);p.transmission>0?r.unshift(m):p.transparent===!0?s.unshift(m):t.unshift(m)}function l(h,d){t.length>1&&t.sort(h||YL),r.length>1&&r.sort(d||Sx),s.length>1&&s.sort(d||Sx)}function u(){for(let h=e,d=n.length;h<d;h++){const p=n[h];if(p.id===null)break;p.id=null,p.object=null,p.geometry=null,p.material=null,p.group=null}}return{opaque:t,transmissive:r,transparent:s,init:i,push:a,unshift:c,finish:u,sort:l}}function KL(){let n=new WeakMap;function e(r,s){const i=n.get(r);let o;return i===void 0?(o=new Ax,n.set(r,[o])):s>=i.length?(o=new Ax,i.push(o)):o=i[s],o}function t(){n=new WeakMap}return{get:e,dispose:t}}function ZL(){const n={};return{get:function(e){if(n[e.id]!==void 0)return n[e.id];let t;switch(e.type){case"DirectionalLight":t={direction:new T,color:new xe};break;case"SpotLight":t={position:new T,direction:new T,color:new xe,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":t={position:new T,color:new xe,distance:0,decay:0};break;case"HemisphereLight":t={direction:new T,skyColor:new xe,groundColor:new xe};break;case"RectAreaLight":t={color:new xe,position:new T,halfWidth:new T,halfHeight:new T};break}return n[e.id]=t,t}}}function JL(){const n={};return{get:function(e){if(n[e.id]!==void 0)return n[e.id];let t;switch(e.type){case"DirectionalLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new W};break;case"SpotLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new W};break;case"PointLight":t={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new W,shadowCameraNear:1,shadowCameraFar:1e3};break}return n[e.id]=t,t}}}let QL=0;function eF(n,e){return(e.castShadow?2:0)-(n.castShadow?2:0)+(e.map?1:0)-(n.map?1:0)}function tF(n,e){const t=new ZL,r=JL(),s={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let u=0;u<9;u++)s.probe.push(new T);const i=new T,o=new qe,a=new qe;function c(u,h){let d=0,p=0,_=0;for(let F=0;F<9;F++)s.probe[F].set(0,0,0);let g=0,f=0,m=0,y=0,v=0,b=0,x=0,E=0,S=0,R=0,C=0;u.sort(eF);const M=h===!0?Math.PI:1;for(let F=0,X=u.length;F<X;F++){const N=u[F],j=N.color,K=N.intensity,$=N.distance,q=N.shadow&&N.shadow.map?N.shadow.map.texture:null;if(N.isAmbientLight)d+=j.r*K*M,p+=j.g*K*M,_+=j.b*K*M;else if(N.isLightProbe){for(let ne=0;ne<9;ne++)s.probe[ne].addScaledVector(N.sh.coefficients[ne],K);C++}else if(N.isDirectionalLight){const ne=t.get(N);if(ne.color.copy(N.color).multiplyScalar(N.intensity*M),N.castShadow){const le=N.shadow,ue=r.get(N);ue.shadowBias=le.bias,ue.shadowNormalBias=le.normalBias,ue.shadowRadius=le.radius,ue.shadowMapSize=le.mapSize,s.directionalShadow[g]=ue,s.directionalShadowMap[g]=q,s.directionalShadowMatrix[g]=N.shadow.matrix,b++}s.directional[g]=ne,g++}else if(N.isSpotLight){const ne=t.get(N);ne.position.setFromMatrixPosition(N.matrixWorld),ne.color.copy(j).multiplyScalar(K*M),ne.distance=$,ne.coneCos=Math.cos(N.angle),ne.penumbraCos=Math.cos(N.angle*(1-N.penumbra)),ne.decay=N.decay,s.spot[m]=ne;const le=N.shadow;if(N.map&&(s.spotLightMap[S]=N.map,S++,le.updateMatrices(N),N.castShadow&&R++),s.spotLightMatrix[m]=le.matrix,N.castShadow){const ue=r.get(N);ue.shadowBias=le.bias,ue.shadowNormalBias=le.normalBias,ue.shadowRadius=le.radius,ue.shadowMapSize=le.mapSize,s.spotShadow[m]=ue,s.spotShadowMap[m]=q,E++}m++}else if(N.isRectAreaLight){const ne=t.get(N);ne.color.copy(j).multiplyScalar(K),ne.halfWidth.set(N.width*.5,0,0),ne.halfHeight.set(0,N.height*.5,0),s.rectArea[y]=ne,y++}else if(N.isPointLight){const ne=t.get(N);if(ne.color.copy(N.color).multiplyScalar(N.intensity*M),ne.distance=N.distance,ne.decay=N.decay,N.castShadow){const le=N.shadow,ue=r.get(N);ue.shadowBias=le.bias,ue.shadowNormalBias=le.normalBias,ue.shadowRadius=le.radius,ue.shadowMapSize=le.mapSize,ue.shadowCameraNear=le.camera.near,ue.shadowCameraFar=le.camera.far,s.pointShadow[f]=ue,s.pointShadowMap[f]=q,s.pointShadowMatrix[f]=N.shadow.matrix,x++}s.point[f]=ne,f++}else if(N.isHemisphereLight){const ne=t.get(N);ne.skyColor.copy(N.color).multiplyScalar(K*M),ne.groundColor.copy(N.groundColor).multiplyScalar(K*M),s.hemi[v]=ne,v++}}y>0&&(e.isWebGL2||n.has("OES_texture_float_linear")===!0?(s.rectAreaLTC1=Oe.LTC_FLOAT_1,s.rectAreaLTC2=Oe.LTC_FLOAT_2):n.has("OES_texture_half_float_linear")===!0?(s.rectAreaLTC1=Oe.LTC_HALF_1,s.rectAreaLTC2=Oe.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),s.ambient[0]=d,s.ambient[1]=p,s.ambient[2]=_;const G=s.hash;(G.directionalLength!==g||G.pointLength!==f||G.spotLength!==m||G.rectAreaLength!==y||G.hemiLength!==v||G.numDirectionalShadows!==b||G.numPointShadows!==x||G.numSpotShadows!==E||G.numSpotMaps!==S||G.numLightProbes!==C)&&(s.directional.length=g,s.spot.length=m,s.rectArea.length=y,s.point.length=f,s.hemi.length=v,s.directionalShadow.length=b,s.directionalShadowMap.length=b,s.pointShadow.length=x,s.pointShadowMap.length=x,s.spotShadow.length=E,s.spotShadowMap.length=E,s.directionalShadowMatrix.length=b,s.pointShadowMatrix.length=x,s.spotLightMatrix.length=E+S-R,s.spotLightMap.length=S,s.numSpotLightShadowsWithMaps=R,s.numLightProbes=C,G.directionalLength=g,G.pointLength=f,G.spotLength=m,G.rectAreaLength=y,G.hemiLength=v,G.numDirectionalShadows=b,G.numPointShadows=x,G.numSpotShadows=E,G.numSpotMaps=S,G.numLightProbes=C,s.version=QL++)}function l(u,h){let d=0,p=0,_=0,g=0,f=0;const m=h.matrixWorldInverse;for(let y=0,v=u.length;y<v;y++){const b=u[y];if(b.isDirectionalLight){const x=s.directional[d];x.direction.setFromMatrixPosition(b.matrixWorld),i.setFromMatrixPosition(b.target.matrixWorld),x.direction.sub(i),x.direction.transformDirection(m),d++}else if(b.isSpotLight){const x=s.spot[_];x.position.setFromMatrixPosition(b.matrixWorld),x.position.applyMatrix4(m),x.direction.setFromMatrixPosition(b.matrixWorld),i.setFromMatrixPosition(b.target.matrixWorld),x.direction.sub(i),x.direction.transformDirection(m),_++}else if(b.isRectAreaLight){const x=s.rectArea[g];x.position.setFromMatrixPosition(b.matrixWorld),x.position.applyMatrix4(m),a.identity(),o.copy(b.matrixWorld),o.premultiply(m),a.extractRotation(o),x.halfWidth.set(b.width*.5,0,0),x.halfHeight.set(0,b.height*.5,0),x.halfWidth.applyMatrix4(a),x.halfHeight.applyMatrix4(a),g++}else if(b.isPointLight){const x=s.point[p];x.position.setFromMatrixPosition(b.matrixWorld),x.position.applyMatrix4(m),p++}else if(b.isHemisphereLight){const x=s.hemi[f];x.direction.setFromMatrixPosition(b.matrixWorld),x.direction.transformDirection(m),f++}}}return{setup:c,setupView:l,state:s}}function Tx(n,e){const t=new tF(n,e),r=[],s=[];function i(){r.length=0,s.length=0}function o(h){r.push(h)}function a(h){s.push(h)}function c(h){t.setup(r,h)}function l(h){t.setupView(r,h)}return{init:i,state:{lightsArray:r,shadowsArray:s,lights:t},setupLights:c,setupLightsView:l,pushLight:o,pushShadow:a}}function nF(n,e){let t=new WeakMap;function r(i,o=0){const a=t.get(i);let c;return a===void 0?(c=new Tx(n,e),t.set(i,[c])):o>=a.length?(c=new Tx(n,e),a.push(c)):c=a[o],c}function s(){t=new WeakMap}return{get:r,dispose:s}}class Vg extends gn{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=HP,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class zg extends gn{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}const rF=`void main() {
	gl_Position = vec4( position, 1.0 );
}`,sF=`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
#include <packing>
void main() {
	const float samples = float( VSM_SAMPLES );
	float mean = 0.0;
	float squared_mean = 0.0;
	float uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );
	float uvStart = samples <= 1.0 ? 0.0 : - 1.0;
	for ( float i = 0.0; i < samples; i ++ ) {
		float uvOffset = uvStart + i * uvStride;
		#ifdef HORIZONTAL_PASS
			vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
		#else
			float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );
			mean += depth;
			squared_mean += depth * depth;
		#endif
	}
	mean = mean / samples;
	squared_mean = squared_mean / samples;
	float std_dev = sqrt( squared_mean - mean * mean );
	gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );
}`;function iF(n,e,t){let r=new Ug;const s=new W,i=new W,o=new We,a=new Vg({depthPacking:jP}),c=new zg,l={},u=t.maxTextureSize,h={[In]:bn,[bn]:In,[er]:er},d=new Kn({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new W},radius:{value:4}},vertexShader:rF,fragmentShader:sF}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const _=new sn;_.setAttribute("position",new Lt(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const g=new Jt(_,d),f=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=Og;let m=this.type;this.render=function(x,E,S){if(f.enabled===!1||f.autoUpdate===!1&&f.needsUpdate===!1||x.length===0)return;const R=n.getRenderTarget(),C=n.getActiveCubeFace(),M=n.getActiveMipmapLevel(),G=n.state;G.setBlending($s),G.buffers.color.setClear(1,1,1,1),G.buffers.depth.setTest(!0),G.setScissorTest(!1);const F=m!==hs&&this.type===hs,X=m===hs&&this.type!==hs;for(let N=0,j=x.length;N<j;N++){const K=x[N],$=K.shadow;if($===void 0){console.warn("THREE.WebGLShadowMap:",K,"has no shadow.");continue}if($.autoUpdate===!1&&$.needsUpdate===!1)continue;s.copy($.mapSize);const q=$.getFrameExtents();if(s.multiply(q),i.copy($.mapSize),(s.x>u||s.y>u)&&(s.x>u&&(i.x=Math.floor(u/q.x),s.x=i.x*q.x,$.mapSize.x=i.x),s.y>u&&(i.y=Math.floor(u/q.y),s.y=i.y*q.y,$.mapSize.y=i.y)),$.map===null||F===!0||X===!0){const le=this.type!==hs?{minFilter:jt,magFilter:jt}:{};$.map!==null&&$.map.dispose(),$.map=new Br(s.x,s.y,le),$.map.texture.name=K.name+".shadowMap",$.camera.updateProjectionMatrix()}n.setRenderTarget($.map),n.clear();const ne=$.getViewportCount();for(let le=0;le<ne;le++){const ue=$.getViewport(le);o.set(i.x*ue.x,i.y*ue.y,i.x*ue.z,i.y*ue.w),G.viewport(o),$.updateMatrices(K,le),r=$.getFrustum(),b(E,S,$.camera,K,this.type)}$.isPointLightShadow!==!0&&this.type===hs&&y($,S),$.needsUpdate=!1}m=this.type,f.needsUpdate=!1,n.setRenderTarget(R,C,M)};function y(x,E){const S=e.update(g);d.defines.VSM_SAMPLES!==x.blurSamples&&(d.defines.VSM_SAMPLES=x.blurSamples,p.defines.VSM_SAMPLES=x.blurSamples,d.needsUpdate=!0,p.needsUpdate=!0),x.mapPass===null&&(x.mapPass=new Br(s.x,s.y)),d.uniforms.shadow_pass.value=x.map.texture,d.uniforms.resolution.value=x.mapSize,d.uniforms.radius.value=x.radius,n.setRenderTarget(x.mapPass),n.clear(),n.renderBufferDirect(E,null,S,d,g,null),p.uniforms.shadow_pass.value=x.mapPass.texture,p.uniforms.resolution.value=x.mapSize,p.uniforms.radius.value=x.radius,n.setRenderTarget(x.map),n.clear(),n.renderBufferDirect(E,null,S,p,g,null)}function v(x,E,S,R){let C=null;const M=S.isPointLight===!0?x.customDistanceMaterial:x.customDepthMaterial;if(M!==void 0)C=M;else if(C=S.isPointLight===!0?c:a,n.localClippingEnabled&&E.clipShadows===!0&&Array.isArray(E.clippingPlanes)&&E.clippingPlanes.length!==0||E.displacementMap&&E.displacementScale!==0||E.alphaMap&&E.alphaTest>0||E.map&&E.alphaTest>0){const G=C.uuid,F=E.uuid;let X=l[G];X===void 0&&(X={},l[G]=X);let N=X[F];N===void 0&&(N=C.clone(),X[F]=N),C=N}if(C.visible=E.visible,C.wireframe=E.wireframe,R===hs?C.side=E.shadowSide!==null?E.shadowSide:E.side:C.side=E.shadowSide!==null?E.shadowSide:h[E.side],C.alphaMap=E.alphaMap,C.alphaTest=E.alphaTest,C.map=E.map,C.clipShadows=E.clipShadows,C.clippingPlanes=E.clippingPlanes,C.clipIntersection=E.clipIntersection,C.displacementMap=E.displacementMap,C.displacementScale=E.displacementScale,C.displacementBias=E.displacementBias,C.wireframeLinewidth=E.wireframeLinewidth,C.linewidth=E.linewidth,S.isPointLight===!0&&C.isMeshDistanceMaterial===!0){const G=n.properties.get(C);G.light=S}return C}function b(x,E,S,R,C){if(x.visible===!1)return;if(x.layers.test(E.layers)&&(x.isMesh||x.isLine||x.isPoints)&&(x.castShadow||x.receiveShadow&&C===hs)&&(!x.frustumCulled||r.intersectsObject(x))){x.modelViewMatrix.multiplyMatrices(S.matrixWorldInverse,x.matrixWorld);const F=e.update(x),X=x.material;if(Array.isArray(X)){const N=F.groups;for(let j=0,K=N.length;j<K;j++){const $=N[j],q=X[$.materialIndex];if(q&&q.visible){const ne=v(x,q,R,C);x.onBeforeShadow(n,x,E,S,F,ne,$),n.renderBufferDirect(S,null,F,ne,x,$),x.onAfterShadow(n,x,E,S,F,ne,$)}}}else if(X.visible){const N=v(x,X,R,C);x.onBeforeShadow(n,x,E,S,F,N,null),n.renderBufferDirect(S,null,F,N,x,null),x.onAfterShadow(n,x,E,S,F,N,null)}}const G=x.children;for(let F=0,X=G.length;F<X;F++)b(G[F],E,S,R,C)}}function oF(n,e,t){const r=t.isWebGL2;function s(){let Y=!1;const Ue=new We;let Te=null;const pe=new We(0,0,0,0);return{setMask:function(Me){Te!==Me&&!Y&&(n.colorMask(Me,Me,Me,Me),Te=Me)},setLocked:function(Me){Y=Me},setClear:function(Me,Je,ft,Wt,Xt){Xt===!0&&(Me*=Wt,Je*=Wt,ft*=Wt),Ue.set(Me,Je,ft,Wt),pe.equals(Ue)===!1&&(n.clearColor(Me,Je,ft,Wt),pe.copy(Ue))},reset:function(){Y=!1,Te=null,pe.set(-1,0,0,0)}}}function i(){let Y=!1,Ue=null,Te=null,pe=null;return{setTest:function(Me){Me?_e(n.DEPTH_TEST):Z(n.DEPTH_TEST)},setMask:function(Me){Ue!==Me&&!Y&&(n.depthMask(Me),Ue=Me)},setFunc:function(Me){if(Te!==Me){switch(Me){case TP:n.depthFunc(n.NEVER);break;case MP:n.depthFunc(n.ALWAYS);break;case RP:n.depthFunc(n.LESS);break;case Pd:n.depthFunc(n.LEQUAL);break;case wP:n.depthFunc(n.EQUAL);break;case OP:n.depthFunc(n.GEQUAL);break;case PP:n.depthFunc(n.GREATER);break;case NP:n.depthFunc(n.NOTEQUAL);break;default:n.depthFunc(n.LEQUAL)}Te=Me}},setLocked:function(Me){Y=Me},setClear:function(Me){pe!==Me&&(n.clearDepth(Me),pe=Me)},reset:function(){Y=!1,Ue=null,Te=null,pe=null}}}function o(){let Y=!1,Ue=null,Te=null,pe=null,Me=null,Je=null,ft=null,Wt=null,Xt=null;return{setTest:function(Ct){Y||(Ct?_e(n.STENCIL_TEST):Z(n.STENCIL_TEST))},setMask:function(Ct){Ue!==Ct&&!Y&&(n.stencilMask(Ct),Ue=Ct)},setFunc:function(Ct,Dn,os){(Te!==Ct||pe!==Dn||Me!==os)&&(n.stencilFunc(Ct,Dn,os),Te=Ct,pe=Dn,Me=os)},setOp:function(Ct,Dn,os){(Je!==Ct||ft!==Dn||Wt!==os)&&(n.stencilOp(Ct,Dn,os),Je=Ct,ft=Dn,Wt=os)},setLocked:function(Ct){Y=Ct},setClear:function(Ct){Xt!==Ct&&(n.clearStencil(Ct),Xt=Ct)},reset:function(){Y=!1,Ue=null,Te=null,pe=null,Me=null,Je=null,ft=null,Wt=null,Xt=null}}}const a=new s,c=new i,l=new o,u=new WeakMap,h=new WeakMap;let d={},p={},_=new WeakMap,g=[],f=null,m=!1,y=null,v=null,b=null,x=null,E=null,S=null,R=null,C=new xe(0,0,0),M=0,G=!1,F=null,X=null,N=null,j=null,K=null;const $=n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let q=!1,ne=0;const le=n.getParameter(n.VERSION);le.indexOf("WebGL")!==-1?(ne=parseFloat(/^WebGL (\d)/.exec(le)[1]),q=ne>=1):le.indexOf("OpenGL ES")!==-1&&(ne=parseFloat(/^OpenGL ES (\d)/.exec(le)[1]),q=ne>=2);let ue=null,Ee={};const de=n.getParameter(n.SCISSOR_BOX),V=n.getParameter(n.VIEWPORT),B=new We().fromArray(de),P=new We().fromArray(V);function O(Y,Ue,Te,pe){const Me=new Uint8Array(4),Je=n.createTexture();n.bindTexture(Y,Je),n.texParameteri(Y,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(Y,n.TEXTURE_MAG_FILTER,n.NEAREST);for(let ft=0;ft<Te;ft++)r&&(Y===n.TEXTURE_3D||Y===n.TEXTURE_2D_ARRAY)?n.texImage3D(Ue,0,n.RGBA,1,1,pe,0,n.RGBA,n.UNSIGNED_BYTE,Me):n.texImage2D(Ue+ft,0,n.RGBA,1,1,0,n.RGBA,n.UNSIGNED_BYTE,Me);return Je}const se={};se[n.TEXTURE_2D]=O(n.TEXTURE_2D,n.TEXTURE_2D,1),se[n.TEXTURE_CUBE_MAP]=O(n.TEXTURE_CUBE_MAP,n.TEXTURE_CUBE_MAP_POSITIVE_X,6),r&&(se[n.TEXTURE_2D_ARRAY]=O(n.TEXTURE_2D_ARRAY,n.TEXTURE_2D_ARRAY,1,1),se[n.TEXTURE_3D]=O(n.TEXTURE_3D,n.TEXTURE_3D,1,1)),a.setClear(0,0,0,1),c.setClear(1),l.setClear(0),_e(n.DEPTH_TEST),c.setFunc(Pd),z(!1),D(ay),_e(n.CULL_FACE),ee($s);function _e(Y){d[Y]!==!0&&(n.enable(Y),d[Y]=!0)}function Z(Y){d[Y]!==!1&&(n.disable(Y),d[Y]=!1)}function me(Y,Ue){return p[Y]!==Ue?(n.bindFramebuffer(Y,Ue),p[Y]=Ue,r&&(Y===n.DRAW_FRAMEBUFFER&&(p[n.FRAMEBUFFER]=Ue),Y===n.FRAMEBUFFER&&(p[n.DRAW_FRAMEBUFFER]=Ue)),!0):!1}function L(Y,Ue){let Te=g,pe=!1;if(Y)if(Te=_.get(Ue),Te===void 0&&(Te=[],_.set(Ue,Te)),Y.isWebGLMultipleRenderTargets){const Me=Y.texture;if(Te.length!==Me.length||Te[0]!==n.COLOR_ATTACHMENT0){for(let Je=0,ft=Me.length;Je<ft;Je++)Te[Je]=n.COLOR_ATTACHMENT0+Je;Te.length=Me.length,pe=!0}}else Te[0]!==n.COLOR_ATTACHMENT0&&(Te[0]=n.COLOR_ATTACHMENT0,pe=!0);else Te[0]!==n.BACK&&(Te[0]=n.BACK,pe=!0);pe&&(t.isWebGL2?n.drawBuffers(Te):e.get("WEBGL_draw_buffers").drawBuffersWEBGL(Te))}function oe(Y){return f!==Y?(n.useProgram(Y),f=Y,!0):!1}const H={[go]:n.FUNC_ADD,[hP]:n.FUNC_SUBTRACT,[dP]:n.FUNC_REVERSE_SUBTRACT};if(r)H[cy]=n.MIN,H[ly]=n.MAX;else{const Y=e.get("EXT_blend_minmax");Y!==null&&(H[cy]=Y.MIN_EXT,H[ly]=Y.MAX_EXT)}const Q={[pP]:n.ZERO,[fP]:n.ONE,[mP]:n.SRC_COLOR,[o_]:n.SRC_ALPHA,[bP]:n.SRC_ALPHA_SATURATE,[yP]:n.DST_COLOR,[gP]:n.DST_ALPHA,[_P]:n.ONE_MINUS_SRC_COLOR,[a_]:n.ONE_MINUS_SRC_ALPHA,[xP]:n.ONE_MINUS_DST_COLOR,[vP]:n.ONE_MINUS_DST_ALPHA,[CP]:n.CONSTANT_COLOR,[EP]:n.ONE_MINUS_CONSTANT_COLOR,[SP]:n.CONSTANT_ALPHA,[AP]:n.ONE_MINUS_CONSTANT_ALPHA};function ee(Y,Ue,Te,pe,Me,Je,ft,Wt,Xt,Ct){if(Y===$s){m===!0&&(Z(n.BLEND),m=!1);return}if(m===!1&&(_e(n.BLEND),m=!0),Y!==uP){if(Y!==y||Ct!==G){if((v!==go||E!==go)&&(n.blendEquation(n.FUNC_ADD),v=go,E=go),Ct)switch(Y){case ki:n.blendFuncSeparate(n.ONE,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA);break;case r_:n.blendFunc(n.ONE,n.ONE);break;case s_:n.blendFuncSeparate(n.ZERO,n.ONE_MINUS_SRC_COLOR,n.ZERO,n.ONE);break;case i_:n.blendFuncSeparate(n.ZERO,n.SRC_COLOR,n.ZERO,n.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",Y);break}else switch(Y){case ki:n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA);break;case r_:n.blendFunc(n.SRC_ALPHA,n.ONE);break;case s_:n.blendFuncSeparate(n.ZERO,n.ONE_MINUS_SRC_COLOR,n.ZERO,n.ONE);break;case i_:n.blendFunc(n.ZERO,n.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",Y);break}b=null,x=null,S=null,R=null,C.set(0,0,0),M=0,y=Y,G=Ct}return}Me=Me||Ue,Je=Je||Te,ft=ft||pe,(Ue!==v||Me!==E)&&(n.blendEquationSeparate(H[Ue],H[Me]),v=Ue,E=Me),(Te!==b||pe!==x||Je!==S||ft!==R)&&(n.blendFuncSeparate(Q[Te],Q[pe],Q[Je],Q[ft]),b=Te,x=pe,S=Je,R=ft),(Wt.equals(C)===!1||Xt!==M)&&(n.blendColor(Wt.r,Wt.g,Wt.b,Xt),C.copy(Wt),M=Xt),y=Y,G=!1}function ge(Y,Ue){Y.side===er?Z(n.CULL_FACE):_e(n.CULL_FACE);let Te=Y.side===bn;Ue&&(Te=!Te),z(Te),Y.blending===ki&&Y.transparent===!1?ee($s):ee(Y.blending,Y.blendEquation,Y.blendSrc,Y.blendDst,Y.blendEquationAlpha,Y.blendSrcAlpha,Y.blendDstAlpha,Y.blendColor,Y.blendAlpha,Y.premultipliedAlpha),c.setFunc(Y.depthFunc),c.setTest(Y.depthTest),c.setMask(Y.depthWrite),a.setMask(Y.colorWrite);const pe=Y.stencilWrite;l.setTest(pe),pe&&(l.setMask(Y.stencilWriteMask),l.setFunc(Y.stencilFunc,Y.stencilRef,Y.stencilFuncMask),l.setOp(Y.stencilFail,Y.stencilZFail,Y.stencilZPass)),Ie(Y.polygonOffset,Y.polygonOffsetFactor,Y.polygonOffsetUnits),Y.alphaToCoverage===!0?_e(n.SAMPLE_ALPHA_TO_COVERAGE):Z(n.SAMPLE_ALPHA_TO_COVERAGE)}function z(Y){F!==Y&&(Y?n.frontFace(n.CW):n.frontFace(n.CCW),F=Y)}function D(Y){Y!==aP?(_e(n.CULL_FACE),Y!==X&&(Y===ay?n.cullFace(n.BACK):Y===cP?n.cullFace(n.FRONT):n.cullFace(n.FRONT_AND_BACK))):Z(n.CULL_FACE),X=Y}function ye(Y){Y!==N&&(q&&n.lineWidth(Y),N=Y)}function Ie(Y,Ue,Te){Y?(_e(n.POLYGON_OFFSET_FILL),(j!==Ue||K!==Te)&&(n.polygonOffset(Ue,Te),j=Ue,K=Te)):Z(n.POLYGON_OFFSET_FILL)}function ot(Y){Y?_e(n.SCISSOR_TEST):Z(n.SCISSOR_TEST)}function U(Y){Y===void 0&&(Y=n.TEXTURE0+$-1),ue!==Y&&(n.activeTexture(Y),ue=Y)}function w(Y,Ue,Te){Te===void 0&&(ue===null?Te=n.TEXTURE0+$-1:Te=ue);let pe=Ee[Te];pe===void 0&&(pe={type:void 0,texture:void 0},Ee[Te]=pe),(pe.type!==Y||pe.texture!==Ue)&&(ue!==Te&&(n.activeTexture(Te),ue=Te),n.bindTexture(Y,Ue||se[Y]),pe.type=Y,pe.texture=Ue)}function re(){const Y=Ee[ue];Y!==void 0&&Y.type!==void 0&&(n.bindTexture(Y.type,null),Y.type=void 0,Y.texture=void 0)}function Se(){try{n.compressedTexImage2D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function Ce(){try{n.compressedTexImage3D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function Ae(){try{n.texSubImage2D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function Ve(){try{n.texSubImage3D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function Re(){try{n.compressedTexSubImage2D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function Ne(){try{n.compressedTexSubImage3D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function Ze(){try{n.texStorage2D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function pt(){try{n.texStorage3D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function k(){try{n.texImage2D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function we(){try{n.texImage3D.apply(n,arguments)}catch(Y){console.error("THREE.WebGLState:",Y)}}function je(Y){B.equals(Y)===!1&&(n.scissor(Y.x,Y.y,Y.z,Y.w),B.copy(Y))}function Be(Y){P.equals(Y)===!1&&(n.viewport(Y.x,Y.y,Y.z,Y.w),P.copy(Y))}function Ge(Y,Ue){let Te=h.get(Ue);Te===void 0&&(Te=new WeakMap,h.set(Ue,Te));let pe=Te.get(Y);pe===void 0&&(pe=n.getUniformBlockIndex(Ue,Y.name),Te.set(Y,pe))}function De(Y,Ue){const pe=h.get(Ue).get(Y);u.get(Ue)!==pe&&(n.uniformBlockBinding(Ue,pe,Y.__bindingPointIndex),u.set(Ue,pe))}function st(){n.disable(n.BLEND),n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.disable(n.POLYGON_OFFSET_FILL),n.disable(n.SCISSOR_TEST),n.disable(n.STENCIL_TEST),n.disable(n.SAMPLE_ALPHA_TO_COVERAGE),n.blendEquation(n.FUNC_ADD),n.blendFunc(n.ONE,n.ZERO),n.blendFuncSeparate(n.ONE,n.ZERO,n.ONE,n.ZERO),n.blendColor(0,0,0,0),n.colorMask(!0,!0,!0,!0),n.clearColor(0,0,0,0),n.depthMask(!0),n.depthFunc(n.LESS),n.clearDepth(1),n.stencilMask(4294967295),n.stencilFunc(n.ALWAYS,0,4294967295),n.stencilOp(n.KEEP,n.KEEP,n.KEEP),n.clearStencil(0),n.cullFace(n.BACK),n.frontFace(n.CCW),n.polygonOffset(0,0),n.activeTexture(n.TEXTURE0),n.bindFramebuffer(n.FRAMEBUFFER,null),r===!0&&(n.bindFramebuffer(n.DRAW_FRAMEBUFFER,null),n.bindFramebuffer(n.READ_FRAMEBUFFER,null)),n.useProgram(null),n.lineWidth(1),n.scissor(0,0,n.canvas.width,n.canvas.height),n.viewport(0,0,n.canvas.width,n.canvas.height),d={},ue=null,Ee={},p={},_=new WeakMap,g=[],f=null,m=!1,y=null,v=null,b=null,x=null,E=null,S=null,R=null,C=new xe(0,0,0),M=0,G=!1,F=null,X=null,N=null,j=null,K=null,B.set(0,0,n.canvas.width,n.canvas.height),P.set(0,0,n.canvas.width,n.canvas.height),a.reset(),c.reset(),l.reset()}return{buffers:{color:a,depth:c,stencil:l},enable:_e,disable:Z,bindFramebuffer:me,drawBuffers:L,useProgram:oe,setBlending:ee,setMaterial:ge,setFlipSided:z,setCullFace:D,setLineWidth:ye,setPolygonOffset:Ie,setScissorTest:ot,activeTexture:U,bindTexture:w,unbindTexture:re,compressedTexImage2D:Se,compressedTexImage3D:Ce,texImage2D:k,texImage3D:we,updateUBOMapping:Ge,uniformBlockBinding:De,texStorage2D:Ze,texStorage3D:pt,texSubImage2D:Ae,texSubImage3D:Ve,compressedTexSubImage2D:Re,compressedTexSubImage3D:Ne,scissor:je,viewport:Be,reset:st}}function aF(n,e,t,r,s,i,o){const a=s.isWebGL2,c=s.maxTextures,l=s.maxCubemapSize,u=s.maxTextureSize,h=s.maxSamples,d=e.has("WEBGL_multisampled_render_to_texture")?e.get("WEBGL_multisampled_render_to_texture"):null,p=typeof navigator>"u"?!1:/OculusBrowser/g.test(navigator.userAgent),_=new WeakMap;let g;const f=new WeakMap;let m=!1;try{m=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function y(U,w){return m?new OffscreenCanvas(U,w):kd("canvas")}function v(U,w,re,Se){let Ce=1;if((U.width>Se||U.height>Se)&&(Ce=Se/Math.max(U.width,U.height)),Ce<1||w===!0)if(typeof HTMLImageElement<"u"&&U instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&U instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&U instanceof ImageBitmap){const Ae=w?Ud:Math.floor,Ve=Ae(Ce*U.width),Re=Ae(Ce*U.height);g===void 0&&(g=y(Ve,Re));const Ne=re?y(Ve,Re):g;return Ne.width=Ve,Ne.height=Re,Ne.getContext("2d").drawImage(U,0,0,Ve,Re),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+U.width+"x"+U.height+") to ("+Ve+"x"+Re+")."),Ne}else return"data"in U&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+U.width+"x"+U.height+")."),U;return U}function b(U){return d_(U.width)&&d_(U.height)}function x(U){return a?!1:U.wrapS!==cr||U.wrapT!==cr||U.minFilter!==jt&&U.minFilter!==Or}function E(U,w){return U.generateMipmaps&&w&&U.minFilter!==jt&&U.minFilter!==Or}function S(U){n.generateMipmap(U)}function R(U,w,re,Se,Ce=!1){if(a===!1)return w;if(U!==null){if(n[U]!==void 0)return n[U];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+U+"'")}let Ae=w;if(w===n.RED&&(re===n.FLOAT&&(Ae=n.R32F),re===n.HALF_FLOAT&&(Ae=n.R16F),re===n.UNSIGNED_BYTE&&(Ae=n.R8)),w===n.RED_INTEGER&&(re===n.UNSIGNED_BYTE&&(Ae=n.R8UI),re===n.UNSIGNED_SHORT&&(Ae=n.R16UI),re===n.UNSIGNED_INT&&(Ae=n.R32UI),re===n.BYTE&&(Ae=n.R8I),re===n.SHORT&&(Ae=n.R16I),re===n.INT&&(Ae=n.R32I)),w===n.RG&&(re===n.FLOAT&&(Ae=n.RG32F),re===n.HALF_FLOAT&&(Ae=n.RG16F),re===n.UNSIGNED_BYTE&&(Ae=n.RG8)),w===n.RGBA){const Ve=Ce?Id:Rt.getTransfer(Se);re===n.FLOAT&&(Ae=n.RGBA32F),re===n.HALF_FLOAT&&(Ae=n.RGBA16F),re===n.UNSIGNED_BYTE&&(Ae=Ve===kt?n.SRGB8_ALPHA8:n.RGBA8),re===n.UNSIGNED_SHORT_4_4_4_4&&(Ae=n.RGBA4),re===n.UNSIGNED_SHORT_5_5_5_1&&(Ae=n.RGB5_A1)}return(Ae===n.R16F||Ae===n.R32F||Ae===n.RG16F||Ae===n.RG32F||Ae===n.RGBA16F||Ae===n.RGBA32F)&&e.get("EXT_color_buffer_float"),Ae}function C(U,w,re){return E(U,re)===!0||U.isFramebufferTexture&&U.minFilter!==jt&&U.minFilter!==Or?Math.log2(Math.max(w.width,w.height))+1:U.mipmaps!==void 0&&U.mipmaps.length>0?U.mipmaps.length:U.isCompressedTexture&&Array.isArray(U.image)?w.mipmaps.length:1}function M(U){return U===jt||U===uy||U===rf?n.NEAREST:n.LINEAR}function G(U){const w=U.target;w.removeEventListener("dispose",G),X(w),w.isVideoTexture&&_.delete(w)}function F(U){const w=U.target;w.removeEventListener("dispose",F),j(w)}function X(U){const w=r.get(U);if(w.__webglInit===void 0)return;const re=U.source,Se=f.get(re);if(Se){const Ce=Se[w.__cacheKey];Ce.usedTimes--,Ce.usedTimes===0&&N(U),Object.keys(Se).length===0&&f.delete(re)}r.remove(U)}function N(U){const w=r.get(U);n.deleteTexture(w.__webglTexture);const re=U.source,Se=f.get(re);delete Se[w.__cacheKey],o.memory.textures--}function j(U){const w=U.texture,re=r.get(U),Se=r.get(w);if(Se.__webglTexture!==void 0&&(n.deleteTexture(Se.__webglTexture),o.memory.textures--),U.depthTexture&&U.depthTexture.dispose(),U.isWebGLCubeRenderTarget)for(let Ce=0;Ce<6;Ce++){if(Array.isArray(re.__webglFramebuffer[Ce]))for(let Ae=0;Ae<re.__webglFramebuffer[Ce].length;Ae++)n.deleteFramebuffer(re.__webglFramebuffer[Ce][Ae]);else n.deleteFramebuffer(re.__webglFramebuffer[Ce]);re.__webglDepthbuffer&&n.deleteRenderbuffer(re.__webglDepthbuffer[Ce])}else{if(Array.isArray(re.__webglFramebuffer))for(let Ce=0;Ce<re.__webglFramebuffer.length;Ce++)n.deleteFramebuffer(re.__webglFramebuffer[Ce]);else n.deleteFramebuffer(re.__webglFramebuffer);if(re.__webglDepthbuffer&&n.deleteRenderbuffer(re.__webglDepthbuffer),re.__webglMultisampledFramebuffer&&n.deleteFramebuffer(re.__webglMultisampledFramebuffer),re.__webglColorRenderbuffer)for(let Ce=0;Ce<re.__webglColorRenderbuffer.length;Ce++)re.__webglColorRenderbuffer[Ce]&&n.deleteRenderbuffer(re.__webglColorRenderbuffer[Ce]);re.__webglDepthRenderbuffer&&n.deleteRenderbuffer(re.__webglDepthRenderbuffer)}if(U.isWebGLMultipleRenderTargets)for(let Ce=0,Ae=w.length;Ce<Ae;Ce++){const Ve=r.get(w[Ce]);Ve.__webglTexture&&(n.deleteTexture(Ve.__webglTexture),o.memory.textures--),r.remove(w[Ce])}r.remove(w),r.remove(U)}let K=0;function $(){K=0}function q(){const U=K;return U>=c&&console.warn("THREE.WebGLTextures: Trying to use "+U+" texture units while this GPU supports only "+c),K+=1,U}function ne(U){const w=[];return w.push(U.wrapS),w.push(U.wrapT),w.push(U.wrapR||0),w.push(U.magFilter),w.push(U.minFilter),w.push(U.anisotropy),w.push(U.internalFormat),w.push(U.format),w.push(U.type),w.push(U.generateMipmaps),w.push(U.premultiplyAlpha),w.push(U.flipY),w.push(U.unpackAlignment),w.push(U.colorSpace),w.join()}function le(U,w){const re=r.get(U);if(U.isVideoTexture&&Ie(U),U.isRenderTargetTexture===!1&&U.version>0&&re.__version!==U.version){const Se=U.image;if(Se===null)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else if(Se.complete===!1)console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete");else{_e(re,U,w);return}}t.bindTexture(n.TEXTURE_2D,re.__webglTexture,n.TEXTURE0+w)}function ue(U,w){const re=r.get(U);if(U.version>0&&re.__version!==U.version){_e(re,U,w);return}t.bindTexture(n.TEXTURE_2D_ARRAY,re.__webglTexture,n.TEXTURE0+w)}function Ee(U,w){const re=r.get(U);if(U.version>0&&re.__version!==U.version){_e(re,U,w);return}t.bindTexture(n.TEXTURE_3D,re.__webglTexture,n.TEXTURE0+w)}function de(U,w){const re=r.get(U);if(U.version>0&&re.__version!==U.version){Z(re,U,w);return}t.bindTexture(n.TEXTURE_CUBE_MAP,re.__webglTexture,n.TEXTURE0+w)}const V={[Nd]:n.REPEAT,[cr]:n.CLAMP_TO_EDGE,[u_]:n.MIRRORED_REPEAT},B={[jt]:n.NEAREST,[uy]:n.NEAREST_MIPMAP_NEAREST,[rf]:n.NEAREST_MIPMAP_LINEAR,[Or]:n.LINEAR,[DP]:n.LINEAR_MIPMAP_NEAREST,[Dl]:n.LINEAR_MIPMAP_LINEAR},P={[WP]:n.NEVER,[ZP]:n.ALWAYS,[XP]:n.LESS,[UA]:n.LEQUAL,[$P]:n.EQUAL,[KP]:n.GEQUAL,[qP]:n.GREATER,[YP]:n.NOTEQUAL};function O(U,w,re){if(re?(n.texParameteri(U,n.TEXTURE_WRAP_S,V[w.wrapS]),n.texParameteri(U,n.TEXTURE_WRAP_T,V[w.wrapT]),(U===n.TEXTURE_3D||U===n.TEXTURE_2D_ARRAY)&&n.texParameteri(U,n.TEXTURE_WRAP_R,V[w.wrapR]),n.texParameteri(U,n.TEXTURE_MAG_FILTER,B[w.magFilter]),n.texParameteri(U,n.TEXTURE_MIN_FILTER,B[w.minFilter])):(n.texParameteri(U,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(U,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),(U===n.TEXTURE_3D||U===n.TEXTURE_2D_ARRAY)&&n.texParameteri(U,n.TEXTURE_WRAP_R,n.CLAMP_TO_EDGE),(w.wrapS!==cr||w.wrapT!==cr)&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),n.texParameteri(U,n.TEXTURE_MAG_FILTER,M(w.magFilter)),n.texParameteri(U,n.TEXTURE_MIN_FILTER,M(w.minFilter)),w.minFilter!==jt&&w.minFilter!==Or&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),w.compareFunction&&(n.texParameteri(U,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE),n.texParameteri(U,n.TEXTURE_COMPARE_FUNC,P[w.compareFunction])),e.has("EXT_texture_filter_anisotropic")===!0){const Se=e.get("EXT_texture_filter_anisotropic");if(w.magFilter===jt||w.minFilter!==rf&&w.minFilter!==Dl||w.type===jn&&e.has("OES_texture_float_linear")===!1||a===!1&&w.type===tc&&e.has("OES_texture_half_float_linear")===!1)return;(w.anisotropy>1||r.get(w).__currentAnisotropy)&&(n.texParameterf(U,Se.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(w.anisotropy,s.getMaxAnisotropy())),r.get(w).__currentAnisotropy=w.anisotropy)}}function se(U,w){let re=!1;U.__webglInit===void 0&&(U.__webglInit=!0,w.addEventListener("dispose",G));const Se=w.source;let Ce=f.get(Se);Ce===void 0&&(Ce={},f.set(Se,Ce));const Ae=ne(w);if(Ae!==U.__cacheKey){Ce[Ae]===void 0&&(Ce[Ae]={texture:n.createTexture(),usedTimes:0},o.memory.textures++,re=!0),Ce[Ae].usedTimes++;const Ve=Ce[U.__cacheKey];Ve!==void 0&&(Ce[U.__cacheKey].usedTimes--,Ve.usedTimes===0&&N(w)),U.__cacheKey=Ae,U.__webglTexture=Ce[Ae].texture}return re}function _e(U,w,re){let Se=n.TEXTURE_2D;(w.isDataArrayTexture||w.isCompressedArrayTexture)&&(Se=n.TEXTURE_2D_ARRAY),w.isData3DTexture&&(Se=n.TEXTURE_3D);const Ce=se(U,w),Ae=w.source;t.bindTexture(Se,U.__webglTexture,n.TEXTURE0+re);const Ve=r.get(Ae);if(Ae.version!==Ve.__version||Ce===!0){t.activeTexture(n.TEXTURE0+re);const Re=Rt.getPrimaries(Rt.workingColorSpace),Ne=w.colorSpace===xn?null:Rt.getPrimaries(w.colorSpace),Ze=w.colorSpace===xn||Re===Ne?n.NONE:n.BROWSER_DEFAULT_WEBGL;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,w.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,w.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,w.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,Ze);const pt=x(w)&&b(w.image)===!1;let k=v(w.image,pt,!1,u);k=ot(w,k);const we=b(k)||a,je=i.convert(w.format,w.colorSpace);let Be=i.convert(w.type),Ge=R(w.internalFormat,je,Be,w.colorSpace,w.isVideoTexture);O(Se,w,we);let De;const st=w.mipmaps,Y=a&&w.isVideoTexture!==!0&&Ge!==LA,Ue=Ve.__version===void 0||Ce===!0,Te=C(w,k,we);if(w.isDepthTexture)Ge=n.DEPTH_COMPONENT,a?w.type===jn?Ge=n.DEPTH_COMPONENT32F:w.type===Oi?Ge=n.DEPTH_COMPONENT24:w.type===Gi?Ge=n.DEPTH24_STENCIL8:Ge=n.DEPTH_COMPONENT16:w.type===jn&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),w.format===To&&Ge===n.DEPTH_COMPONENT&&w.type!==Ig&&w.type!==Oi&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),w.type=Oi,Be=i.convert(w.type)),w.format===nc&&Ge===n.DEPTH_COMPONENT&&(Ge=n.DEPTH_STENCIL,w.type!==Gi&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),w.type=Gi,Be=i.convert(w.type))),Ue&&(Y?t.texStorage2D(n.TEXTURE_2D,1,Ge,k.width,k.height):t.texImage2D(n.TEXTURE_2D,0,Ge,k.width,k.height,0,je,Be,null));else if(w.isDataTexture)if(st.length>0&&we){Y&&Ue&&t.texStorage2D(n.TEXTURE_2D,Te,Ge,st[0].width,st[0].height);for(let pe=0,Me=st.length;pe<Me;pe++)De=st[pe],Y?t.texSubImage2D(n.TEXTURE_2D,pe,0,0,De.width,De.height,je,Be,De.data):t.texImage2D(n.TEXTURE_2D,pe,Ge,De.width,De.height,0,je,Be,De.data);w.generateMipmaps=!1}else Y?(Ue&&t.texStorage2D(n.TEXTURE_2D,Te,Ge,k.width,k.height),t.texSubImage2D(n.TEXTURE_2D,0,0,0,k.width,k.height,je,Be,k.data)):t.texImage2D(n.TEXTURE_2D,0,Ge,k.width,k.height,0,je,Be,k.data);else if(w.isCompressedTexture)if(w.isCompressedArrayTexture){Y&&Ue&&t.texStorage3D(n.TEXTURE_2D_ARRAY,Te,Ge,st[0].width,st[0].height,k.depth);for(let pe=0,Me=st.length;pe<Me;pe++)De=st[pe],w.format!==fn?je!==null?Y?t.compressedTexSubImage3D(n.TEXTURE_2D_ARRAY,pe,0,0,0,De.width,De.height,k.depth,je,De.data,0,0):t.compressedTexImage3D(n.TEXTURE_2D_ARRAY,pe,Ge,De.width,De.height,k.depth,0,De.data,0,0):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):Y?t.texSubImage3D(n.TEXTURE_2D_ARRAY,pe,0,0,0,De.width,De.height,k.depth,je,Be,De.data):t.texImage3D(n.TEXTURE_2D_ARRAY,pe,Ge,De.width,De.height,k.depth,0,je,Be,De.data)}else{Y&&Ue&&t.texStorage2D(n.TEXTURE_2D,Te,Ge,st[0].width,st[0].height);for(let pe=0,Me=st.length;pe<Me;pe++)De=st[pe],w.format!==fn?je!==null?Y?t.compressedTexSubImage2D(n.TEXTURE_2D,pe,0,0,De.width,De.height,je,De.data):t.compressedTexImage2D(n.TEXTURE_2D,pe,Ge,De.width,De.height,0,De.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):Y?t.texSubImage2D(n.TEXTURE_2D,pe,0,0,De.width,De.height,je,Be,De.data):t.texImage2D(n.TEXTURE_2D,pe,Ge,De.width,De.height,0,je,Be,De.data)}else if(w.isDataArrayTexture)Y?(Ue&&t.texStorage3D(n.TEXTURE_2D_ARRAY,Te,Ge,k.width,k.height,k.depth),t.texSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,0,k.width,k.height,k.depth,je,Be,k.data)):t.texImage3D(n.TEXTURE_2D_ARRAY,0,Ge,k.width,k.height,k.depth,0,je,Be,k.data);else if(w.isData3DTexture)Y?(Ue&&t.texStorage3D(n.TEXTURE_3D,Te,Ge,k.width,k.height,k.depth),t.texSubImage3D(n.TEXTURE_3D,0,0,0,0,k.width,k.height,k.depth,je,Be,k.data)):t.texImage3D(n.TEXTURE_3D,0,Ge,k.width,k.height,k.depth,0,je,Be,k.data);else if(w.isFramebufferTexture){if(Ue)if(Y)t.texStorage2D(n.TEXTURE_2D,Te,Ge,k.width,k.height);else{let pe=k.width,Me=k.height;for(let Je=0;Je<Te;Je++)t.texImage2D(n.TEXTURE_2D,Je,Ge,pe,Me,0,je,Be,null),pe>>=1,Me>>=1}}else if(st.length>0&&we){Y&&Ue&&t.texStorage2D(n.TEXTURE_2D,Te,Ge,st[0].width,st[0].height);for(let pe=0,Me=st.length;pe<Me;pe++)De=st[pe],Y?t.texSubImage2D(n.TEXTURE_2D,pe,0,0,je,Be,De):t.texImage2D(n.TEXTURE_2D,pe,Ge,je,Be,De);w.generateMipmaps=!1}else Y?(Ue&&t.texStorage2D(n.TEXTURE_2D,Te,Ge,k.width,k.height),t.texSubImage2D(n.TEXTURE_2D,0,0,0,je,Be,k)):t.texImage2D(n.TEXTURE_2D,0,Ge,je,Be,k);E(w,we)&&S(Se),Ve.__version=Ae.version,w.onUpdate&&w.onUpdate(w)}U.__version=w.version}function Z(U,w,re){if(w.image.length!==6)return;const Se=se(U,w),Ce=w.source;t.bindTexture(n.TEXTURE_CUBE_MAP,U.__webglTexture,n.TEXTURE0+re);const Ae=r.get(Ce);if(Ce.version!==Ae.__version||Se===!0){t.activeTexture(n.TEXTURE0+re);const Ve=Rt.getPrimaries(Rt.workingColorSpace),Re=w.colorSpace===xn?null:Rt.getPrimaries(w.colorSpace),Ne=w.colorSpace===xn||Ve===Re?n.NONE:n.BROWSER_DEFAULT_WEBGL;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,w.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,w.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,w.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,Ne);const Ze=w.isCompressedTexture||w.image[0].isCompressedTexture,pt=w.image[0]&&w.image[0].isDataTexture,k=[];for(let pe=0;pe<6;pe++)!Ze&&!pt?k[pe]=v(w.image[pe],!1,!0,l):k[pe]=pt?w.image[pe].image:w.image[pe],k[pe]=ot(w,k[pe]);const we=k[0],je=b(we)||a,Be=i.convert(w.format,w.colorSpace),Ge=i.convert(w.type),De=R(w.internalFormat,Be,Ge,w.colorSpace),st=a&&w.isVideoTexture!==!0,Y=Ae.__version===void 0||Se===!0;let Ue=C(w,we,je);O(n.TEXTURE_CUBE_MAP,w,je);let Te;if(Ze){st&&Y&&t.texStorage2D(n.TEXTURE_CUBE_MAP,Ue,De,we.width,we.height);for(let pe=0;pe<6;pe++){Te=k[pe].mipmaps;for(let Me=0;Me<Te.length;Me++){const Je=Te[Me];w.format!==fn?Be!==null?st?t.compressedTexSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me,0,0,Je.width,Je.height,Be,Je.data):t.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me,De,Je.width,Je.height,0,Je.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):st?t.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me,0,0,Je.width,Je.height,Be,Ge,Je.data):t.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me,De,Je.width,Je.height,0,Be,Ge,Je.data)}}}else{Te=w.mipmaps,st&&Y&&(Te.length>0&&Ue++,t.texStorage2D(n.TEXTURE_CUBE_MAP,Ue,De,k[0].width,k[0].height));for(let pe=0;pe<6;pe++)if(pt){st?t.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,0,0,0,k[pe].width,k[pe].height,Be,Ge,k[pe].data):t.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,0,De,k[pe].width,k[pe].height,0,Be,Ge,k[pe].data);for(let Me=0;Me<Te.length;Me++){const ft=Te[Me].image[pe].image;st?t.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me+1,0,0,ft.width,ft.height,Be,Ge,ft.data):t.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me+1,De,ft.width,ft.height,0,Be,Ge,ft.data)}}else{st?t.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,0,0,0,Be,Ge,k[pe]):t.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,0,De,Be,Ge,k[pe]);for(let Me=0;Me<Te.length;Me++){const Je=Te[Me];st?t.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me+1,0,0,Be,Ge,Je.image[pe]):t.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+pe,Me+1,De,Be,Ge,Je.image[pe])}}}E(w,je)&&S(n.TEXTURE_CUBE_MAP),Ae.__version=Ce.version,w.onUpdate&&w.onUpdate(w)}U.__version=w.version}function me(U,w,re,Se,Ce,Ae){const Ve=i.convert(re.format,re.colorSpace),Re=i.convert(re.type),Ne=R(re.internalFormat,Ve,Re,re.colorSpace);if(!r.get(w).__hasExternalTextures){const pt=Math.max(1,w.width>>Ae),k=Math.max(1,w.height>>Ae);Ce===n.TEXTURE_3D||Ce===n.TEXTURE_2D_ARRAY?t.texImage3D(Ce,Ae,Ne,pt,k,w.depth,0,Ve,Re,null):t.texImage2D(Ce,Ae,Ne,pt,k,0,Ve,Re,null)}t.bindFramebuffer(n.FRAMEBUFFER,U),ye(w)?d.framebufferTexture2DMultisampleEXT(n.FRAMEBUFFER,Se,Ce,r.get(re).__webglTexture,0,D(w)):(Ce===n.TEXTURE_2D||Ce>=n.TEXTURE_CUBE_MAP_POSITIVE_X&&Ce<=n.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&n.framebufferTexture2D(n.FRAMEBUFFER,Se,Ce,r.get(re).__webglTexture,Ae),t.bindFramebuffer(n.FRAMEBUFFER,null)}function L(U,w,re){if(n.bindRenderbuffer(n.RENDERBUFFER,U),w.depthBuffer&&!w.stencilBuffer){let Se=a===!0?n.DEPTH_COMPONENT24:n.DEPTH_COMPONENT16;if(re||ye(w)){const Ce=w.depthTexture;Ce&&Ce.isDepthTexture&&(Ce.type===jn?Se=n.DEPTH_COMPONENT32F:Ce.type===Oi&&(Se=n.DEPTH_COMPONENT24));const Ae=D(w);ye(w)?d.renderbufferStorageMultisampleEXT(n.RENDERBUFFER,Ae,Se,w.width,w.height):n.renderbufferStorageMultisample(n.RENDERBUFFER,Ae,Se,w.width,w.height)}else n.renderbufferStorage(n.RENDERBUFFER,Se,w.width,w.height);n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.RENDERBUFFER,U)}else if(w.depthBuffer&&w.stencilBuffer){const Se=D(w);re&&ye(w)===!1?n.renderbufferStorageMultisample(n.RENDERBUFFER,Se,n.DEPTH24_STENCIL8,w.width,w.height):ye(w)?d.renderbufferStorageMultisampleEXT(n.RENDERBUFFER,Se,n.DEPTH24_STENCIL8,w.width,w.height):n.renderbufferStorage(n.RENDERBUFFER,n.DEPTH_STENCIL,w.width,w.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.RENDERBUFFER,U)}else{const Se=w.isWebGLMultipleRenderTargets===!0?w.texture:[w.texture];for(let Ce=0;Ce<Se.length;Ce++){const Ae=Se[Ce],Ve=i.convert(Ae.format,Ae.colorSpace),Re=i.convert(Ae.type),Ne=R(Ae.internalFormat,Ve,Re,Ae.colorSpace),Ze=D(w);re&&ye(w)===!1?n.renderbufferStorageMultisample(n.RENDERBUFFER,Ze,Ne,w.width,w.height):ye(w)?d.renderbufferStorageMultisampleEXT(n.RENDERBUFFER,Ze,Ne,w.width,w.height):n.renderbufferStorage(n.RENDERBUFFER,Ne,w.width,w.height)}}n.bindRenderbuffer(n.RENDERBUFFER,null)}function oe(U,w){if(w&&w.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(n.FRAMEBUFFER,U),!(w.depthTexture&&w.depthTexture.isDepthTexture))throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");(!r.get(w.depthTexture).__webglTexture||w.depthTexture.image.width!==w.width||w.depthTexture.image.height!==w.height)&&(w.depthTexture.image.width=w.width,w.depthTexture.image.height=w.height,w.depthTexture.needsUpdate=!0),le(w.depthTexture,0);const Se=r.get(w.depthTexture).__webglTexture,Ce=D(w);if(w.depthTexture.format===To)ye(w)?d.framebufferTexture2DMultisampleEXT(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.TEXTURE_2D,Se,0,Ce):n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_ATTACHMENT,n.TEXTURE_2D,Se,0);else if(w.depthTexture.format===nc)ye(w)?d.framebufferTexture2DMultisampleEXT(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.TEXTURE_2D,Se,0,Ce):n.framebufferTexture2D(n.FRAMEBUFFER,n.DEPTH_STENCIL_ATTACHMENT,n.TEXTURE_2D,Se,0);else throw new Error("Unknown depthTexture format")}function H(U){const w=r.get(U),re=U.isWebGLCubeRenderTarget===!0;if(U.depthTexture&&!w.__autoAllocateDepthBuffer){if(re)throw new Error("target.depthTexture not supported in Cube render targets");oe(w.__webglFramebuffer,U)}else if(re){w.__webglDepthbuffer=[];for(let Se=0;Se<6;Se++)t.bindFramebuffer(n.FRAMEBUFFER,w.__webglFramebuffer[Se]),w.__webglDepthbuffer[Se]=n.createRenderbuffer(),L(w.__webglDepthbuffer[Se],U,!1)}else t.bindFramebuffer(n.FRAMEBUFFER,w.__webglFramebuffer),w.__webglDepthbuffer=n.createRenderbuffer(),L(w.__webglDepthbuffer,U,!1);t.bindFramebuffer(n.FRAMEBUFFER,null)}function Q(U,w,re){const Se=r.get(U);w!==void 0&&me(Se.__webglFramebuffer,U,U.texture,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,0),re!==void 0&&H(U)}function ee(U){const w=U.texture,re=r.get(U),Se=r.get(w);U.addEventListener("dispose",F),U.isWebGLMultipleRenderTargets!==!0&&(Se.__webglTexture===void 0&&(Se.__webglTexture=n.createTexture()),Se.__version=w.version,o.memory.textures++);const Ce=U.isWebGLCubeRenderTarget===!0,Ae=U.isWebGLMultipleRenderTargets===!0,Ve=b(U)||a;if(Ce){re.__webglFramebuffer=[];for(let Re=0;Re<6;Re++)if(a&&w.mipmaps&&w.mipmaps.length>0){re.__webglFramebuffer[Re]=[];for(let Ne=0;Ne<w.mipmaps.length;Ne++)re.__webglFramebuffer[Re][Ne]=n.createFramebuffer()}else re.__webglFramebuffer[Re]=n.createFramebuffer()}else{if(a&&w.mipmaps&&w.mipmaps.length>0){re.__webglFramebuffer=[];for(let Re=0;Re<w.mipmaps.length;Re++)re.__webglFramebuffer[Re]=n.createFramebuffer()}else re.__webglFramebuffer=n.createFramebuffer();if(Ae)if(s.drawBuffers){const Re=U.texture;for(let Ne=0,Ze=Re.length;Ne<Ze;Ne++){const pt=r.get(Re[Ne]);pt.__webglTexture===void 0&&(pt.__webglTexture=n.createTexture(),o.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");if(a&&U.samples>0&&ye(U)===!1){const Re=Ae?w:[w];re.__webglMultisampledFramebuffer=n.createFramebuffer(),re.__webglColorRenderbuffer=[],t.bindFramebuffer(n.FRAMEBUFFER,re.__webglMultisampledFramebuffer);for(let Ne=0;Ne<Re.length;Ne++){const Ze=Re[Ne];re.__webglColorRenderbuffer[Ne]=n.createRenderbuffer(),n.bindRenderbuffer(n.RENDERBUFFER,re.__webglColorRenderbuffer[Ne]);const pt=i.convert(Ze.format,Ze.colorSpace),k=i.convert(Ze.type),we=R(Ze.internalFormat,pt,k,Ze.colorSpace,U.isXRRenderTarget===!0),je=D(U);n.renderbufferStorageMultisample(n.RENDERBUFFER,je,we,U.width,U.height),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+Ne,n.RENDERBUFFER,re.__webglColorRenderbuffer[Ne])}n.bindRenderbuffer(n.RENDERBUFFER,null),U.depthBuffer&&(re.__webglDepthRenderbuffer=n.createRenderbuffer(),L(re.__webglDepthRenderbuffer,U,!0)),t.bindFramebuffer(n.FRAMEBUFFER,null)}}if(Ce){t.bindTexture(n.TEXTURE_CUBE_MAP,Se.__webglTexture),O(n.TEXTURE_CUBE_MAP,w,Ve);for(let Re=0;Re<6;Re++)if(a&&w.mipmaps&&w.mipmaps.length>0)for(let Ne=0;Ne<w.mipmaps.length;Ne++)me(re.__webglFramebuffer[Re][Ne],U,w,n.COLOR_ATTACHMENT0,n.TEXTURE_CUBE_MAP_POSITIVE_X+Re,Ne);else me(re.__webglFramebuffer[Re],U,w,n.COLOR_ATTACHMENT0,n.TEXTURE_CUBE_MAP_POSITIVE_X+Re,0);E(w,Ve)&&S(n.TEXTURE_CUBE_MAP),t.unbindTexture()}else if(Ae){const Re=U.texture;for(let Ne=0,Ze=Re.length;Ne<Ze;Ne++){const pt=Re[Ne],k=r.get(pt);t.bindTexture(n.TEXTURE_2D,k.__webglTexture),O(n.TEXTURE_2D,pt,Ve),me(re.__webglFramebuffer,U,pt,n.COLOR_ATTACHMENT0+Ne,n.TEXTURE_2D,0),E(pt,Ve)&&S(n.TEXTURE_2D)}t.unbindTexture()}else{let Re=n.TEXTURE_2D;if((U.isWebGL3DRenderTarget||U.isWebGLArrayRenderTarget)&&(a?Re=U.isWebGL3DRenderTarget?n.TEXTURE_3D:n.TEXTURE_2D_ARRAY:console.error("THREE.WebGLTextures: THREE.Data3DTexture and THREE.DataArrayTexture only supported with WebGL2.")),t.bindTexture(Re,Se.__webglTexture),O(Re,w,Ve),a&&w.mipmaps&&w.mipmaps.length>0)for(let Ne=0;Ne<w.mipmaps.length;Ne++)me(re.__webglFramebuffer[Ne],U,w,n.COLOR_ATTACHMENT0,Re,Ne);else me(re.__webglFramebuffer,U,w,n.COLOR_ATTACHMENT0,Re,0);E(w,Ve)&&S(Re),t.unbindTexture()}U.depthBuffer&&H(U)}function ge(U){const w=b(U)||a,re=U.isWebGLMultipleRenderTargets===!0?U.texture:[U.texture];for(let Se=0,Ce=re.length;Se<Ce;Se++){const Ae=re[Se];if(E(Ae,w)){const Ve=U.isWebGLCubeRenderTarget?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D,Re=r.get(Ae).__webglTexture;t.bindTexture(Ve,Re),S(Ve),t.unbindTexture()}}}function z(U){if(a&&U.samples>0&&ye(U)===!1){const w=U.isWebGLMultipleRenderTargets?U.texture:[U.texture],re=U.width,Se=U.height;let Ce=n.COLOR_BUFFER_BIT;const Ae=[],Ve=U.stencilBuffer?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT,Re=r.get(U),Ne=U.isWebGLMultipleRenderTargets===!0;if(Ne)for(let Ze=0;Ze<w.length;Ze++)t.bindFramebuffer(n.FRAMEBUFFER,Re.__webglMultisampledFramebuffer),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+Ze,n.RENDERBUFFER,null),t.bindFramebuffer(n.FRAMEBUFFER,Re.__webglFramebuffer),n.framebufferTexture2D(n.DRAW_FRAMEBUFFER,n.COLOR_ATTACHMENT0+Ze,n.TEXTURE_2D,null,0);t.bindFramebuffer(n.READ_FRAMEBUFFER,Re.__webglMultisampledFramebuffer),t.bindFramebuffer(n.DRAW_FRAMEBUFFER,Re.__webglFramebuffer);for(let Ze=0;Ze<w.length;Ze++){Ae.push(n.COLOR_ATTACHMENT0+Ze),U.depthBuffer&&Ae.push(Ve);const pt=Re.__ignoreDepthValues!==void 0?Re.__ignoreDepthValues:!1;if(pt===!1&&(U.depthBuffer&&(Ce|=n.DEPTH_BUFFER_BIT),U.stencilBuffer&&(Ce|=n.STENCIL_BUFFER_BIT)),Ne&&n.framebufferRenderbuffer(n.READ_FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.RENDERBUFFER,Re.__webglColorRenderbuffer[Ze]),pt===!0&&(n.invalidateFramebuffer(n.READ_FRAMEBUFFER,[Ve]),n.invalidateFramebuffer(n.DRAW_FRAMEBUFFER,[Ve])),Ne){const k=r.get(w[Ze]).__webglTexture;n.framebufferTexture2D(n.DRAW_FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,k,0)}n.blitFramebuffer(0,0,re,Se,0,0,re,Se,Ce,n.NEAREST),p&&n.invalidateFramebuffer(n.READ_FRAMEBUFFER,Ae)}if(t.bindFramebuffer(n.READ_FRAMEBUFFER,null),t.bindFramebuffer(n.DRAW_FRAMEBUFFER,null),Ne)for(let Ze=0;Ze<w.length;Ze++){t.bindFramebuffer(n.FRAMEBUFFER,Re.__webglMultisampledFramebuffer),n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+Ze,n.RENDERBUFFER,Re.__webglColorRenderbuffer[Ze]);const pt=r.get(w[Ze]).__webglTexture;t.bindFramebuffer(n.FRAMEBUFFER,Re.__webglFramebuffer),n.framebufferTexture2D(n.DRAW_FRAMEBUFFER,n.COLOR_ATTACHMENT0+Ze,n.TEXTURE_2D,pt,0)}t.bindFramebuffer(n.DRAW_FRAMEBUFFER,Re.__webglMultisampledFramebuffer)}}function D(U){return Math.min(h,U.samples)}function ye(U){const w=r.get(U);return a&&U.samples>0&&e.has("WEBGL_multisampled_render_to_texture")===!0&&w.__useRenderToTexture!==!1}function Ie(U){const w=o.render.frame;_.get(U)!==w&&(_.set(U,w),U.update())}function ot(U,w){const re=U.colorSpace,Se=U.format,Ce=U.type;return U.isCompressedTexture===!0||U.isVideoTexture===!0||U.format===h_||re!==kr&&re!==xn&&(Rt.getTransfer(re)===kt?a===!1?e.has("EXT_sRGB")===!0&&Se===fn?(U.format=h_,U.minFilter=Or,U.generateMipmaps=!1):w=BA.sRGBToLinear(w):(Se!==fn||Ce!==Bi)&&console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",re)),w}this.allocateTextureUnit=q,this.resetTextureUnits=$,this.setTexture2D=le,this.setTexture2DArray=ue,this.setTexture3D=Ee,this.setTextureCube=de,this.rebindTextures=Q,this.setupRenderTarget=ee,this.updateRenderTargetMipmap=ge,this.updateMultisampleRenderTarget=z,this.setupDepthRenderbuffer=H,this.setupFrameBufferTexture=me,this.useMultisampledRTT=ye}function cF(n,e,t){const r=t.isWebGL2;function s(i,o=xn){let a;const c=Rt.getTransfer(o);if(i===Bi)return n.UNSIGNED_BYTE;if(i===OA)return n.UNSIGNED_SHORT_4_4_4_4;if(i===PA)return n.UNSIGNED_SHORT_5_5_5_1;if(i===LP)return n.BYTE;if(i===FP)return n.SHORT;if(i===Ig)return n.UNSIGNED_SHORT;if(i===wA)return n.INT;if(i===Oi)return n.UNSIGNED_INT;if(i===jn)return n.FLOAT;if(i===tc)return r?n.HALF_FLOAT:(a=e.get("OES_texture_half_float"),a!==null?a.HALF_FLOAT_OES:null);if(i===UP)return n.ALPHA;if(i===fn)return n.RGBA;if(i===kP)return n.LUMINANCE;if(i===BP)return n.LUMINANCE_ALPHA;if(i===To)return n.DEPTH_COMPONENT;if(i===nc)return n.DEPTH_STENCIL;if(i===h_)return a=e.get("EXT_sRGB"),a!==null?a.SRGB_ALPHA_EXT:null;if(i===GP)return n.RED;if(i===NA)return n.RED_INTEGER;if(i===VP)return n.RG;if(i===IA)return n.RG_INTEGER;if(i===DA)return n.RGBA_INTEGER;if(i===sf||i===of||i===af||i===cf)if(c===kt)if(a=e.get("WEBGL_compressed_texture_s3tc_srgb"),a!==null){if(i===sf)return a.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===of)return a.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===af)return a.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===cf)return a.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null;else if(a=e.get("WEBGL_compressed_texture_s3tc"),a!==null){if(i===sf)return a.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===of)return a.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===af)return a.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===cf)return a.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(i===hy||i===dy||i===py||i===fy)if(a=e.get("WEBGL_compressed_texture_pvrtc"),a!==null){if(i===hy)return a.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===dy)return a.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===py)return a.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===fy)return a.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(i===LA)return a=e.get("WEBGL_compressed_texture_etc1"),a!==null?a.COMPRESSED_RGB_ETC1_WEBGL:null;if(i===my||i===_y)if(a=e.get("WEBGL_compressed_texture_etc"),a!==null){if(i===my)return c===kt?a.COMPRESSED_SRGB8_ETC2:a.COMPRESSED_RGB8_ETC2;if(i===_y)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:a.COMPRESSED_RGBA8_ETC2_EAC}else return null;if(i===gy||i===vy||i===yy||i===xy||i===by||i===Cy||i===Ey||i===Sy||i===Ay||i===Ty||i===My||i===Ry||i===wy||i===Oy)if(a=e.get("WEBGL_compressed_texture_astc"),a!==null){if(i===gy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:a.COMPRESSED_RGBA_ASTC_4x4_KHR;if(i===vy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:a.COMPRESSED_RGBA_ASTC_5x4_KHR;if(i===yy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:a.COMPRESSED_RGBA_ASTC_5x5_KHR;if(i===xy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:a.COMPRESSED_RGBA_ASTC_6x5_KHR;if(i===by)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:a.COMPRESSED_RGBA_ASTC_6x6_KHR;if(i===Cy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:a.COMPRESSED_RGBA_ASTC_8x5_KHR;if(i===Ey)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:a.COMPRESSED_RGBA_ASTC_8x6_KHR;if(i===Sy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:a.COMPRESSED_RGBA_ASTC_8x8_KHR;if(i===Ay)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:a.COMPRESSED_RGBA_ASTC_10x5_KHR;if(i===Ty)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:a.COMPRESSED_RGBA_ASTC_10x6_KHR;if(i===My)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:a.COMPRESSED_RGBA_ASTC_10x8_KHR;if(i===Ry)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:a.COMPRESSED_RGBA_ASTC_10x10_KHR;if(i===wy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:a.COMPRESSED_RGBA_ASTC_12x10_KHR;if(i===Oy)return c===kt?a.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:a.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null;if(i===lf||i===Py||i===Ny)if(a=e.get("EXT_texture_compression_bptc"),a!==null){if(i===lf)return c===kt?a.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:a.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(i===Py)return a.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(i===Ny)return a.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}else return null;if(i===zP||i===Iy||i===Dy||i===Ly)if(a=e.get("EXT_texture_compression_rgtc"),a!==null){if(i===lf)return a.COMPRESSED_RED_RGTC1_EXT;if(i===Iy)return a.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(i===Dy)return a.COMPRESSED_RED_GREEN_RGTC2_EXT;if(i===Ly)return a.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}else return null;return i===Gi?r?n.UNSIGNED_INT_24_8:(a=e.get("WEBGL_depth_texture"),a!==null?a.UNSIGNED_INT_24_8_WEBGL:null):n[i]!==void 0?n[i]:null}return{convert:s}}class lF extends Un{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e}}class lr extends wt{constructor(){super(),this.isGroup=!0,this.type="Group"}}const uF={type:"move"};class Nf{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new lr,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new lr,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new T,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new T),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new lr,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new T,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new T),this._grip}dispatchEvent(e){return this._targetRay!==null&&this._targetRay.dispatchEvent(e),this._grip!==null&&this._grip.dispatchEvent(e),this._hand!==null&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const r of e.hand.values())this._getHandJoint(t,r)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(e,t,r){let s=null,i=null,o=null;const a=this._targetRay,c=this._grip,l=this._hand;if(e&&t.session.visibilityState!=="visible-blurred"){if(l&&e.hand){o=!0;for(const g of e.hand.values()){const f=t.getJointPose(g,r),m=this._getHandJoint(l,g);f!==null&&(m.matrix.fromArray(f.transform.matrix),m.matrix.decompose(m.position,m.rotation,m.scale),m.matrixWorldNeedsUpdate=!0,m.jointRadius=f.radius),m.visible=f!==null}const u=l.joints["index-finger-tip"],h=l.joints["thumb-tip"],d=u.position.distanceTo(h.position),p=.02,_=.005;l.inputState.pinching&&d>p+_?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&d<=p-_&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else c!==null&&e.gripSpace&&(i=t.getPose(e.gripSpace,r),i!==null&&(c.matrix.fromArray(i.transform.matrix),c.matrix.decompose(c.position,c.rotation,c.scale),c.matrixWorldNeedsUpdate=!0,i.linearVelocity?(c.hasLinearVelocity=!0,c.linearVelocity.copy(i.linearVelocity)):c.hasLinearVelocity=!1,i.angularVelocity?(c.hasAngularVelocity=!0,c.angularVelocity.copy(i.angularVelocity)):c.hasAngularVelocity=!1));a!==null&&(s=t.getPose(e.targetRaySpace,r),s===null&&i!==null&&(s=i),s!==null&&(a.matrix.fromArray(s.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,s.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(s.linearVelocity)):a.hasLinearVelocity=!1,s.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(s.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(uF)))}return a!==null&&(a.visible=s!==null),c!==null&&(c.visible=i!==null),l!==null&&(l.visible=o!==null),this}_getHandJoint(e,t){if(e.joints[t.jointName]===void 0){const r=new lr;r.matrixAutoUpdate=!1,r.visible=!1,e.joints[t.jointName]=r,e.add(r)}return e.joints[t.jointName]}}class hF extends Ms{constructor(e,t){super();const r=this;let s=null,i=1,o=null,a="local-floor",c=1,l=null,u=null,h=null,d=null,p=null,_=null;const g=t.getContextAttributes();let f=null,m=null;const y=[],v=[],b=new W;let x=null;const E=new Un;E.layers.enable(1),E.viewport=new We;const S=new Un;S.layers.enable(2),S.viewport=new We;const R=[E,S],C=new lF;C.layers.enable(1),C.layers.enable(2);let M=null,G=null;this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(de){let V=y[de];return V===void 0&&(V=new Nf,y[de]=V),V.getTargetRaySpace()},this.getControllerGrip=function(de){let V=y[de];return V===void 0&&(V=new Nf,y[de]=V),V.getGripSpace()},this.getHand=function(de){let V=y[de];return V===void 0&&(V=new Nf,y[de]=V),V.getHandSpace()};function F(de){const V=v.indexOf(de.inputSource);if(V===-1)return;const B=y[V];B!==void 0&&(B.update(de.inputSource,de.frame,l||o),B.dispatchEvent({type:de.type,data:de.inputSource}))}function X(){s.removeEventListener("select",F),s.removeEventListener("selectstart",F),s.removeEventListener("selectend",F),s.removeEventListener("squeeze",F),s.removeEventListener("squeezestart",F),s.removeEventListener("squeezeend",F),s.removeEventListener("end",X),s.removeEventListener("inputsourceschange",N);for(let de=0;de<y.length;de++){const V=v[de];V!==null&&(v[de]=null,y[de].disconnect(V))}M=null,G=null,e.setRenderTarget(f),p=null,d=null,h=null,s=null,m=null,Ee.stop(),r.isPresenting=!1,e.setPixelRatio(x),e.setSize(b.width,b.height,!1),r.dispatchEvent({type:"sessionend"})}this.setFramebufferScaleFactor=function(de){i=de,r.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(de){a=de,r.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||o},this.setReferenceSpace=function(de){l=de},this.getBaseLayer=function(){return d!==null?d:p},this.getBinding=function(){return h},this.getFrame=function(){return _},this.getSession=function(){return s},this.setSession=async function(de){if(s=de,s!==null){if(f=e.getRenderTarget(),s.addEventListener("select",F),s.addEventListener("selectstart",F),s.addEventListener("selectend",F),s.addEventListener("squeeze",F),s.addEventListener("squeezestart",F),s.addEventListener("squeezeend",F),s.addEventListener("end",X),s.addEventListener("inputsourceschange",N),g.xrCompatible!==!0&&await t.makeXRCompatible(),x=e.getPixelRatio(),e.getSize(b),s.renderState.layers===void 0||e.capabilities.isWebGL2===!1){const V={antialias:s.renderState.layers===void 0?g.antialias:!0,alpha:!0,depth:g.depth,stencil:g.stencil,framebufferScaleFactor:i};p=new XRWebGLLayer(s,t,V),s.updateRenderState({baseLayer:p}),e.setPixelRatio(1),e.setSize(p.framebufferWidth,p.framebufferHeight,!1),m=new Br(p.framebufferWidth,p.framebufferHeight,{format:fn,type:Bi,colorSpace:e.outputColorSpace,stencilBuffer:g.stencil})}else{let V=null,B=null,P=null;g.depth&&(P=g.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,V=g.stencil?nc:To,B=g.stencil?Gi:Oi);const O={colorFormat:t.RGBA8,depthFormat:P,scaleFactor:i};h=new XRWebGLBinding(s,t),d=h.createProjectionLayer(O),s.updateRenderState({layers:[d]}),e.setPixelRatio(1),e.setSize(d.textureWidth,d.textureHeight,!1),m=new Br(d.textureWidth,d.textureHeight,{format:fn,type:Bi,depthTexture:new Gg(d.textureWidth,d.textureHeight,B,void 0,void 0,void 0,void 0,void 0,void 0,V),stencilBuffer:g.stencil,colorSpace:e.outputColorSpace,samples:g.antialias?4:0});const se=e.properties.get(m);se.__ignoreDepthValues=d.ignoreDepthValues}m.isXRRenderTarget=!0,this.setFoveation(c),l=null,o=await s.requestReferenceSpace(a),Ee.setContext(s),Ee.start(),r.isPresenting=!0,r.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(s!==null)return s.environmentBlendMode};function N(de){for(let V=0;V<de.removed.length;V++){const B=de.removed[V],P=v.indexOf(B);P>=0&&(v[P]=null,y[P].disconnect(B))}for(let V=0;V<de.added.length;V++){const B=de.added[V];let P=v.indexOf(B);if(P===-1){for(let se=0;se<y.length;se++)if(se>=v.length){v.push(B),P=se;break}else if(v[se]===null){v[se]=B,P=se;break}if(P===-1)break}const O=y[P];O&&O.connect(B)}}const j=new T,K=new T;function $(de,V,B){j.setFromMatrixPosition(V.matrixWorld),K.setFromMatrixPosition(B.matrixWorld);const P=j.distanceTo(K),O=V.projectionMatrix.elements,se=B.projectionMatrix.elements,_e=O[14]/(O[10]-1),Z=O[14]/(O[10]+1),me=(O[9]+1)/O[5],L=(O[9]-1)/O[5],oe=(O[8]-1)/O[0],H=(se[8]+1)/se[0],Q=_e*oe,ee=_e*H,ge=P/(-oe+H),z=ge*-oe;V.matrixWorld.decompose(de.position,de.quaternion,de.scale),de.translateX(z),de.translateZ(ge),de.matrixWorld.compose(de.position,de.quaternion,de.scale),de.matrixWorldInverse.copy(de.matrixWorld).invert();const D=_e+ge,ye=Z+ge,Ie=Q-z,ot=ee+(P-z),U=me*Z/ye*D,w=L*Z/ye*D;de.projectionMatrix.makePerspective(Ie,ot,U,w,D,ye),de.projectionMatrixInverse.copy(de.projectionMatrix).invert()}function q(de,V){V===null?de.matrixWorld.copy(de.matrix):de.matrixWorld.multiplyMatrices(V.matrixWorld,de.matrix),de.matrixWorldInverse.copy(de.matrixWorld).invert()}this.updateCamera=function(de){if(s===null)return;C.near=S.near=E.near=de.near,C.far=S.far=E.far=de.far,(M!==C.near||G!==C.far)&&(s.updateRenderState({depthNear:C.near,depthFar:C.far}),M=C.near,G=C.far);const V=de.parent,B=C.cameras;q(C,V);for(let P=0;P<B.length;P++)q(B[P],V);B.length===2?$(C,E,S):C.projectionMatrix.copy(E.projectionMatrix),ne(de,C,V)};function ne(de,V,B){B===null?de.matrix.copy(V.matrixWorld):(de.matrix.copy(B.matrixWorld),de.matrix.invert(),de.matrix.multiply(V.matrixWorld)),de.matrix.decompose(de.position,de.quaternion,de.scale),de.updateMatrixWorld(!0),de.projectionMatrix.copy(V.projectionMatrix),de.projectionMatrixInverse.copy(V.projectionMatrixInverse),de.isPerspectiveCamera&&(de.fov=rc*2*Math.atan(1/de.projectionMatrix.elements[5]),de.zoom=1)}this.getCamera=function(){return C},this.getFoveation=function(){if(!(d===null&&p===null))return c},this.setFoveation=function(de){c=de,d!==null&&(d.fixedFoveation=de),p!==null&&p.fixedFoveation!==void 0&&(p.fixedFoveation=de)};let le=null;function ue(de,V){if(u=V.getViewerPose(l||o),_=V,u!==null){const B=u.views;p!==null&&(e.setRenderTargetFramebuffer(m,p.framebuffer),e.setRenderTarget(m));let P=!1;B.length!==C.cameras.length&&(C.cameras.length=0,P=!0);for(let O=0;O<B.length;O++){const se=B[O];let _e=null;if(p!==null)_e=p.getViewport(se);else{const me=h.getViewSubImage(d,se);_e=me.viewport,O===0&&(e.setRenderTargetTextures(m,me.colorTexture,d.ignoreDepthValues?void 0:me.depthStencilTexture),e.setRenderTarget(m))}let Z=R[O];Z===void 0&&(Z=new Un,Z.layers.enable(O),Z.viewport=new We,R[O]=Z),Z.matrix.fromArray(se.transform.matrix),Z.matrix.decompose(Z.position,Z.quaternion,Z.scale),Z.projectionMatrix.fromArray(se.projectionMatrix),Z.projectionMatrixInverse.copy(Z.projectionMatrix).invert(),Z.viewport.set(_e.x,_e.y,_e.width,_e.height),O===0&&(C.matrix.copy(Z.matrix),C.matrix.decompose(C.position,C.quaternion,C.scale)),P===!0&&C.cameras.push(Z)}}for(let B=0;B<y.length;B++){const P=v[B],O=y[B];P!==null&&O!==void 0&&O.update(P,V,l||o)}le&&le(de,V),V.detectedPlanes&&r.dispatchEvent({type:"planesdetected",data:V}),_=null}const Ee=new YA;Ee.setAnimationLoop(ue),this.setAnimationLoop=function(de){le=de},this.dispose=function(){}}}function dF(n,e){function t(f,m){f.matrixAutoUpdate===!0&&f.updateMatrix(),m.value.copy(f.matrix)}function r(f,m){m.color.getRGB(f.fogColor.value,WA(n)),m.isFog?(f.fogNear.value=m.near,f.fogFar.value=m.far):m.isFogExp2&&(f.fogDensity.value=m.density)}function s(f,m,y,v,b){m.isMeshBasicMaterial||m.isMeshLambertMaterial?i(f,m):m.isMeshToonMaterial?(i(f,m),h(f,m)):m.isMeshPhongMaterial?(i(f,m),u(f,m)):m.isMeshStandardMaterial?(i(f,m),d(f,m),m.isMeshPhysicalMaterial&&p(f,m,b)):m.isMeshMatcapMaterial?(i(f,m),_(f,m)):m.isMeshDepthMaterial?i(f,m):m.isMeshDistanceMaterial?(i(f,m),g(f,m)):m.isMeshNormalMaterial?i(f,m):m.isLineBasicMaterial?(o(f,m),m.isLineDashedMaterial&&a(f,m)):m.isPointsMaterial?c(f,m,y,v):m.isSpriteMaterial?l(f,m):m.isShadowMaterial?(f.color.value.copy(m.color),f.opacity.value=m.opacity):m.isShaderMaterial&&(m.uniformsNeedUpdate=!1)}function i(f,m){f.opacity.value=m.opacity,m.color&&f.diffuse.value.copy(m.color),m.emissive&&f.emissive.value.copy(m.emissive).multiplyScalar(m.emissiveIntensity),m.map&&(f.map.value=m.map,t(m.map,f.mapTransform)),m.alphaMap&&(f.alphaMap.value=m.alphaMap,t(m.alphaMap,f.alphaMapTransform)),m.bumpMap&&(f.bumpMap.value=m.bumpMap,t(m.bumpMap,f.bumpMapTransform),f.bumpScale.value=m.bumpScale,m.side===bn&&(f.bumpScale.value*=-1)),m.normalMap&&(f.normalMap.value=m.normalMap,t(m.normalMap,f.normalMapTransform),f.normalScale.value.copy(m.normalScale),m.side===bn&&f.normalScale.value.negate()),m.displacementMap&&(f.displacementMap.value=m.displacementMap,t(m.displacementMap,f.displacementMapTransform),f.displacementScale.value=m.displacementScale,f.displacementBias.value=m.displacementBias),m.emissiveMap&&(f.emissiveMap.value=m.emissiveMap,t(m.emissiveMap,f.emissiveMapTransform)),m.specularMap&&(f.specularMap.value=m.specularMap,t(m.specularMap,f.specularMapTransform)),m.alphaTest>0&&(f.alphaTest.value=m.alphaTest);const y=e.get(m).envMap;if(y&&(f.envMap.value=y,f.flipEnvMap.value=y.isCubeTexture&&y.isRenderTargetTexture===!1?-1:1,f.reflectivity.value=m.reflectivity,f.ior.value=m.ior,f.refractionRatio.value=m.refractionRatio),m.lightMap){f.lightMap.value=m.lightMap;const v=n._useLegacyLights===!0?Math.PI:1;f.lightMapIntensity.value=m.lightMapIntensity*v,t(m.lightMap,f.lightMapTransform)}m.aoMap&&(f.aoMap.value=m.aoMap,f.aoMapIntensity.value=m.aoMapIntensity,t(m.aoMap,f.aoMapTransform))}function o(f,m){f.diffuse.value.copy(m.color),f.opacity.value=m.opacity,m.map&&(f.map.value=m.map,t(m.map,f.mapTransform))}function a(f,m){f.dashSize.value=m.dashSize,f.totalSize.value=m.dashSize+m.gapSize,f.scale.value=m.scale}function c(f,m,y,v){f.diffuse.value.copy(m.color),f.opacity.value=m.opacity,f.size.value=m.size*y,f.scale.value=v*.5,m.map&&(f.map.value=m.map,t(m.map,f.uvTransform)),m.alphaMap&&(f.alphaMap.value=m.alphaMap,t(m.alphaMap,f.alphaMapTransform)),m.alphaTest>0&&(f.alphaTest.value=m.alphaTest)}function l(f,m){f.diffuse.value.copy(m.color),f.opacity.value=m.opacity,f.rotation.value=m.rotation,m.map&&(f.map.value=m.map,t(m.map,f.mapTransform)),m.alphaMap&&(f.alphaMap.value=m.alphaMap,t(m.alphaMap,f.alphaMapTransform)),m.alphaTest>0&&(f.alphaTest.value=m.alphaTest)}function u(f,m){f.specular.value.copy(m.specular),f.shininess.value=Math.max(m.shininess,1e-4)}function h(f,m){m.gradientMap&&(f.gradientMap.value=m.gradientMap)}function d(f,m){f.metalness.value=m.metalness,m.metalnessMap&&(f.metalnessMap.value=m.metalnessMap,t(m.metalnessMap,f.metalnessMapTransform)),f.roughness.value=m.roughness,m.roughnessMap&&(f.roughnessMap.value=m.roughnessMap,t(m.roughnessMap,f.roughnessMapTransform)),e.get(m).envMap&&(f.envMapIntensity.value=m.envMapIntensity)}function p(f,m,y){f.ior.value=m.ior,m.sheen>0&&(f.sheenColor.value.copy(m.sheenColor).multiplyScalar(m.sheen),f.sheenRoughness.value=m.sheenRoughness,m.sheenColorMap&&(f.sheenColorMap.value=m.sheenColorMap,t(m.sheenColorMap,f.sheenColorMapTransform)),m.sheenRoughnessMap&&(f.sheenRoughnessMap.value=m.sheenRoughnessMap,t(m.sheenRoughnessMap,f.sheenRoughnessMapTransform))),m.clearcoat>0&&(f.clearcoat.value=m.clearcoat,f.clearcoatRoughness.value=m.clearcoatRoughness,m.clearcoatMap&&(f.clearcoatMap.value=m.clearcoatMap,t(m.clearcoatMap,f.clearcoatMapTransform)),m.clearcoatRoughnessMap&&(f.clearcoatRoughnessMap.value=m.clearcoatRoughnessMap,t(m.clearcoatRoughnessMap,f.clearcoatRoughnessMapTransform)),m.clearcoatNormalMap&&(f.clearcoatNormalMap.value=m.clearcoatNormalMap,t(m.clearcoatNormalMap,f.clearcoatNormalMapTransform),f.clearcoatNormalScale.value.copy(m.clearcoatNormalScale),m.side===bn&&f.clearcoatNormalScale.value.negate())),m.iridescence>0&&(f.iridescence.value=m.iridescence,f.iridescenceIOR.value=m.iridescenceIOR,f.iridescenceThicknessMinimum.value=m.iridescenceThicknessRange[0],f.iridescenceThicknessMaximum.value=m.iridescenceThicknessRange[1],m.iridescenceMap&&(f.iridescenceMap.value=m.iridescenceMap,t(m.iridescenceMap,f.iridescenceMapTransform)),m.iridescenceThicknessMap&&(f.iridescenceThicknessMap.value=m.iridescenceThicknessMap,t(m.iridescenceThicknessMap,f.iridescenceThicknessMapTransform))),m.transmission>0&&(f.transmission.value=m.transmission,f.transmissionSamplerMap.value=y.texture,f.transmissionSamplerSize.value.set(y.width,y.height),m.transmissionMap&&(f.transmissionMap.value=m.transmissionMap,t(m.transmissionMap,f.transmissionMapTransform)),f.thickness.value=m.thickness,m.thicknessMap&&(f.thicknessMap.value=m.thicknessMap,t(m.thicknessMap,f.thicknessMapTransform)),f.attenuationDistance.value=m.attenuationDistance,f.attenuationColor.value.copy(m.attenuationColor)),m.anisotropy>0&&(f.anisotropyVector.value.set(m.anisotropy*Math.cos(m.anisotropyRotation),m.anisotropy*Math.sin(m.anisotropyRotation)),m.anisotropyMap&&(f.anisotropyMap.value=m.anisotropyMap,t(m.anisotropyMap,f.anisotropyMapTransform))),f.specularIntensity.value=m.specularIntensity,f.specularColor.value.copy(m.specularColor),m.specularColorMap&&(f.specularColorMap.value=m.specularColorMap,t(m.specularColorMap,f.specularColorMapTransform)),m.specularIntensityMap&&(f.specularIntensityMap.value=m.specularIntensityMap,t(m.specularIntensityMap,f.specularIntensityMapTransform))}function _(f,m){m.matcap&&(f.matcap.value=m.matcap)}function g(f,m){const y=e.get(m).light;f.referencePosition.value.setFromMatrixPosition(y.matrixWorld),f.nearDistance.value=y.shadow.camera.near,f.farDistance.value=y.shadow.camera.far}return{refreshFogUniforms:r,refreshMaterialUniforms:s}}function pF(n,e,t,r){let s={},i={},o=[];const a=t.isWebGL2?n.getParameter(n.MAX_UNIFORM_BUFFER_BINDINGS):0;function c(y,v){const b=v.program;r.uniformBlockBinding(y,b)}function l(y,v){let b=s[y.id];b===void 0&&(_(y),b=u(y),s[y.id]=b,y.addEventListener("dispose",f));const x=v.program;r.updateUBOMapping(y,x);const E=e.render.frame;i[y.id]!==E&&(d(y),i[y.id]=E)}function u(y){const v=h();y.__bindingPointIndex=v;const b=n.createBuffer(),x=y.__size,E=y.usage;return n.bindBuffer(n.UNIFORM_BUFFER,b),n.bufferData(n.UNIFORM_BUFFER,x,E),n.bindBuffer(n.UNIFORM_BUFFER,null),n.bindBufferBase(n.UNIFORM_BUFFER,v,b),b}function h(){for(let y=0;y<a;y++)if(o.indexOf(y)===-1)return o.push(y),y;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}function d(y){const v=s[y.id],b=y.uniforms,x=y.__cache;n.bindBuffer(n.UNIFORM_BUFFER,v);for(let E=0,S=b.length;E<S;E++){const R=b[E];if(p(R,E,x)===!0){const C=R.__offset,M=Array.isArray(R.value)?R.value:[R.value];let G=0;for(let F=0;F<M.length;F++){const X=M[F],N=g(X);typeof X=="number"?(R.__data[0]=X,n.bufferSubData(n.UNIFORM_BUFFER,C+G,R.__data)):X.isMatrix3?(R.__data[0]=X.elements[0],R.__data[1]=X.elements[1],R.__data[2]=X.elements[2],R.__data[3]=X.elements[0],R.__data[4]=X.elements[3],R.__data[5]=X.elements[4],R.__data[6]=X.elements[5],R.__data[7]=X.elements[0],R.__data[8]=X.elements[6],R.__data[9]=X.elements[7],R.__data[10]=X.elements[8],R.__data[11]=X.elements[0]):(X.toArray(R.__data,G),G+=N.storage/Float32Array.BYTES_PER_ELEMENT)}n.bufferSubData(n.UNIFORM_BUFFER,C,R.__data)}}n.bindBuffer(n.UNIFORM_BUFFER,null)}function p(y,v,b){const x=y.value;if(b[v]===void 0){if(typeof x=="number")b[v]=x;else{const E=Array.isArray(x)?x:[x],S=[];for(let R=0;R<E.length;R++)S.push(E[R].clone());b[v]=S}return!0}else if(typeof x=="number"){if(b[v]!==x)return b[v]=x,!0}else{const E=Array.isArray(b[v])?b[v]:[b[v]],S=Array.isArray(x)?x:[x];for(let R=0;R<E.length;R++){const C=E[R];if(C.equals(S[R])===!1)return C.copy(S[R]),!0}}return!1}function _(y){const v=y.uniforms;let b=0;const x=16;let E=0;for(let S=0,R=v.length;S<R;S++){const C=v[S],M={boundary:0,storage:0},G=Array.isArray(C.value)?C.value:[C.value];for(let F=0,X=G.length;F<X;F++){const N=G[F],j=g(N);M.boundary+=j.boundary,M.storage+=j.storage}if(C.__data=new Float32Array(M.storage/Float32Array.BYTES_PER_ELEMENT),C.__offset=b,S>0){E=b%x;const F=x-E;E!==0&&F-M.boundary<0&&(b+=x-E,C.__offset=b)}b+=M.storage}return E=b%x,E>0&&(b+=x-E),y.__size=b,y.__cache={},this}function g(y){const v={boundary:0,storage:0};return typeof y=="number"?(v.boundary=4,v.storage=4):y.isVector2?(v.boundary=8,v.storage=8):y.isVector3||y.isColor?(v.boundary=16,v.storage=12):y.isVector4?(v.boundary=16,v.storage=16):y.isMatrix3?(v.boundary=48,v.storage=48):y.isMatrix4?(v.boundary=64,v.storage=64):y.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",y),v}function f(y){const v=y.target;v.removeEventListener("dispose",f);const b=o.indexOf(v.__bindingPointIndex);o.splice(b,1),n.deleteBuffer(s[v.id]),delete s[v.id],delete i[v.id]}function m(){for(const y in s)n.deleteBuffer(s[y]);o=[],s={},i={}}return{bind:c,update:l,dispose:m}}class bs{constructor(e={}){const{canvas:t=dN(),context:r=null,depth:s=!0,stencil:i=!0,alpha:o=!1,antialias:a=!1,premultipliedAlpha:c=!0,preserveDrawingBuffer:l=!1,powerPreference:u="default",failIfMajorPerformanceCaveat:h=!1}=e;this.isWebGLRenderer=!0;let d;r!==null?d=r.getContextAttributes().alpha:d=o;const p=new Uint32Array(4),_=new Int32Array(4);let g=null,f=null;const m=[],y=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=nn,this._useLegacyLights=!1,this.toneMapping=Fr,this.toneMappingExposure=1;const v=this;let b=!1,x=0,E=0,S=null,R=-1,C=null;const M=new We,G=new We;let F=null;const X=new xe(0);let N=0,j=t.width,K=t.height,$=1,q=null,ne=null;const le=new We(0,0,j,K),ue=new We(0,0,j,K);let Ee=!1;const de=new Ug;let V=!1,B=!1,P=null;const O=new qe,se=new W,_e=new T,Z={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function me(){return S===null?$:1}let L=r;function oe(I,te){for(let ce=0;ce<I.length;ce++){const he=I[ce],ae=t.getContext(he,te);if(ae!==null)return ae}return null}try{const I={alpha:!0,depth:s,stencil:i,antialias:a,premultipliedAlpha:c,preserveDrawingBuffer:l,powerPreference:u,failIfMajorPerformanceCaveat:h};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${wg}`),t.addEventListener("webglcontextlost",st,!1),t.addEventListener("webglcontextrestored",Y,!1),t.addEventListener("webglcontextcreationerror",Ue,!1),L===null){const te=["webgl2","webgl","experimental-webgl"];if(v.isWebGL1Renderer===!0&&te.shift(),L=oe(te,I),L===null)throw oe(te)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}typeof WebGLRenderingContext<"u"&&L instanceof WebGLRenderingContext&&console.warn("THREE.WebGLRenderer: WebGL 1 support was deprecated in r153 and will be removed in r163."),L.getShaderPrecisionFormat===void 0&&(L.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(I){throw console.error("THREE.WebGLRenderer: "+I.message),I}let H,Q,ee,ge,z,D,ye,Ie,ot,U,w,re,Se,Ce,Ae,Ve,Re,Ne,Ze,pt,k,we,je,Be;function Ge(){H=new TD(L),Q=new xD(L,H,e),H.init(Q),we=new cF(L,H,Q),ee=new oF(L,H,Q),ge=new wD(L),z=new qL,D=new aF(L,H,ee,z,Q,we,ge),ye=new CD(v),Ie=new AD(v),ot=new UN(L,Q),je=new vD(L,H,ot,Q),U=new MD(L,ot,ge,je),w=new ID(L,U,ot,ge),Ze=new ND(L,Q,D),Ve=new bD(z),re=new $L(v,ye,Ie,H,Q,je,Ve),Se=new dF(v,z),Ce=new KL,Ae=new nF(H,Q),Ne=new gD(v,ye,Ie,ee,w,d,c),Re=new iF(v,w,Q),Be=new pF(L,ge,Q,ee),pt=new yD(L,H,ge,Q),k=new RD(L,H,ge,Q),ge.programs=re.programs,v.capabilities=Q,v.extensions=H,v.properties=z,v.renderLists=Ce,v.shadowMap=Re,v.state=ee,v.info=ge}Ge();const De=new hF(v,L);this.xr=De,this.getContext=function(){return L},this.getContextAttributes=function(){return L.getContextAttributes()},this.forceContextLoss=function(){const I=H.get("WEBGL_lose_context");I&&I.loseContext()},this.forceContextRestore=function(){const I=H.get("WEBGL_lose_context");I&&I.restoreContext()},this.getPixelRatio=function(){return $},this.setPixelRatio=function(I){I!==void 0&&($=I,this.setSize(j,K,!1))},this.getSize=function(I){return I.set(j,K)},this.setSize=function(I,te,ce=!0){if(De.isPresenting){console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting.");return}j=I,K=te,t.width=Math.floor(I*$),t.height=Math.floor(te*$),ce===!0&&(t.style.width=I+"px",t.style.height=te+"px"),this.setViewport(0,0,I,te)},this.getDrawingBufferSize=function(I){return I.set(j*$,K*$).floor()},this.setDrawingBufferSize=function(I,te,ce){j=I,K=te,$=ce,t.width=Math.floor(I*ce),t.height=Math.floor(te*ce),this.setViewport(0,0,I,te)},this.getCurrentViewport=function(I){return I.copy(M)},this.getViewport=function(I){return I.copy(le)},this.setViewport=function(I,te,ce,he){I.isVector4?le.set(I.x,I.y,I.z,I.w):le.set(I,te,ce,he),ee.viewport(M.copy(le).multiplyScalar($).floor())},this.getScissor=function(I){return I.copy(ue)},this.setScissor=function(I,te,ce,he){I.isVector4?ue.set(I.x,I.y,I.z,I.w):ue.set(I,te,ce,he),ee.scissor(G.copy(ue).multiplyScalar($).floor())},this.getScissorTest=function(){return Ee},this.setScissorTest=function(I){ee.setScissorTest(Ee=I)},this.setOpaqueSort=function(I){q=I},this.setTransparentSort=function(I){ne=I},this.getClearColor=function(I){return I.copy(Ne.getClearColor())},this.setClearColor=function(){Ne.setClearColor.apply(Ne,arguments)},this.getClearAlpha=function(){return Ne.getClearAlpha()},this.setClearAlpha=function(){Ne.setClearAlpha.apply(Ne,arguments)},this.clear=function(I=!0,te=!0,ce=!0){let he=0;if(I){let ae=!1;if(S!==null){const ke=S.texture.format;ae=ke===DA||ke===IA||ke===NA}if(ae){const ke=S.texture.type,Xe=ke===Bi||ke===Oi||ke===Ig||ke===Gi||ke===OA||ke===PA,Qe=Ne.getClearColor(),it=Ne.getClearAlpha(),ut=Qe.r,at=Qe.g,ct=Qe.b;Xe?(p[0]=ut,p[1]=at,p[2]=ct,p[3]=it,L.clearBufferuiv(L.COLOR,0,p)):(_[0]=ut,_[1]=at,_[2]=ct,_[3]=it,L.clearBufferiv(L.COLOR,0,_))}else he|=L.COLOR_BUFFER_BIT}te&&(he|=L.DEPTH_BUFFER_BIT),ce&&(he|=L.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),L.clear(he)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",st,!1),t.removeEventListener("webglcontextrestored",Y,!1),t.removeEventListener("webglcontextcreationerror",Ue,!1),Ce.dispose(),Ae.dispose(),z.dispose(),ye.dispose(),Ie.dispose(),w.dispose(),je.dispose(),Be.dispose(),re.dispose(),De.dispose(),De.removeEventListener("sessionstart",Xt),De.removeEventListener("sessionend",Ct),P&&(P.dispose(),P=null),Dn.stop()};function st(I){I.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),b=!0}function Y(){console.log("THREE.WebGLRenderer: Context Restored."),b=!1;const I=ge.autoReset,te=Re.enabled,ce=Re.autoUpdate,he=Re.needsUpdate,ae=Re.type;Ge(),ge.autoReset=I,Re.enabled=te,Re.autoUpdate=ce,Re.needsUpdate=he,Re.type=ae}function Ue(I){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",I.statusMessage)}function Te(I){const te=I.target;te.removeEventListener("dispose",Te),pe(te)}function pe(I){Me(I),z.remove(I)}function Me(I){const te=z.get(I).programs;te!==void 0&&(te.forEach(function(ce){re.releaseProgram(ce)}),I.isShaderMaterial&&re.releaseShaderCache(I))}this.renderBufferDirect=function(I,te,ce,he,ae,ke){te===null&&(te=Z);const Xe=ae.isMesh&&ae.matrixWorld.determinant()<0,Qe=tP(I,te,ce,he,ae);ee.setMaterial(he,Xe);let it=ce.index,ut=1;if(he.wireframe===!0){if(it=U.getWireframeAttribute(ce),it===void 0)return;ut=2}const at=ce.drawRange,ct=ce.attributes.position;let an=at.start*ut,sr=(at.start+at.count)*ut;ke!==null&&(an=Math.max(an,ke.start*ut),sr=Math.min(sr,(ke.start+ke.count)*ut)),it!==null?(an=Math.max(an,0),sr=Math.min(sr,it.count)):ct!=null&&(an=Math.max(an,0),sr=Math.min(sr,ct.count));const An=sr-an;if(An<0||An===1/0)return;je.setup(ae,he,Qe,ce,it);let Ps,$t=pt;if(it!==null&&(Ps=ot.get(it),$t=k,$t.setIndex(Ps)),ae.isMesh)he.wireframe===!0?(ee.setLineWidth(he.wireframeLinewidth*me()),$t.setMode(L.LINES)):$t.setMode(L.TRIANGLES);else if(ae.isLine){let ht=he.linewidth;ht===void 0&&(ht=1),ee.setLineWidth(ht*me()),ae.isLineSegments?$t.setMode(L.LINES):ae.isLineLoop?$t.setMode(L.LINE_LOOP):$t.setMode(L.LINE_STRIP)}else ae.isPoints?$t.setMode(L.POINTS):ae.isSprite&&$t.setMode(L.TRIANGLES);if(ae.isBatchedMesh)$t.renderMultiDraw(ae._multiDrawStarts,ae._multiDrawCounts,ae._multiDrawCount);else if(ae.isInstancedMesh)$t.renderInstances(an,An,ae.count);else if(ce.isInstancedBufferGeometry){const ht=ce._maxInstanceCount!==void 0?ce._maxInstanceCount:1/0,Qp=Math.min(ce.instanceCount,ht);$t.renderInstances(an,An,Qp)}else $t.render(an,An)};function Je(I,te,ce){I.transparent===!0&&I.side===er&&I.forceSinglePass===!1?(I.side=bn,I.needsUpdate=!0,Uu(I,te,ce),I.side=In,I.needsUpdate=!0,Uu(I,te,ce),I.side=er):Uu(I,te,ce)}this.compile=function(I,te,ce=null){ce===null&&(ce=I),f=Ae.get(ce),f.init(),y.push(f),ce.traverseVisible(function(ae){ae.isLight&&ae.layers.test(te.layers)&&(f.pushLight(ae),ae.castShadow&&f.pushShadow(ae))}),I!==ce&&I.traverseVisible(function(ae){ae.isLight&&ae.layers.test(te.layers)&&(f.pushLight(ae),ae.castShadow&&f.pushShadow(ae))}),f.setupLights(v._useLegacyLights);const he=new Set;return I.traverse(function(ae){const ke=ae.material;if(ke)if(Array.isArray(ke))for(let Xe=0;Xe<ke.length;Xe++){const Qe=ke[Xe];Je(Qe,ce,ae),he.add(Qe)}else Je(ke,ce,ae),he.add(ke)}),y.pop(),f=null,he},this.compileAsync=function(I,te,ce=null){const he=this.compile(I,te,ce);return new Promise(ae=>{function ke(){if(he.forEach(function(Xe){z.get(Xe).currentProgram.isReady()&&he.delete(Xe)}),he.size===0){ae(I);return}setTimeout(ke,10)}H.get("KHR_parallel_shader_compile")!==null?ke():setTimeout(ke,10)})};let ft=null;function Wt(I){ft&&ft(I)}function Xt(){Dn.stop()}function Ct(){Dn.start()}const Dn=new YA;Dn.setAnimationLoop(Wt),typeof self<"u"&&Dn.setContext(self),this.setAnimationLoop=function(I){ft=I,De.setAnimationLoop(I),I===null?Dn.stop():Dn.start()},De.addEventListener("sessionstart",Xt),De.addEventListener("sessionend",Ct),this.render=function(I,te){if(te!==void 0&&te.isCamera!==!0){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}if(b===!0)return;I.matrixWorldAutoUpdate===!0&&I.updateMatrixWorld(),te.parent===null&&te.matrixWorldAutoUpdate===!0&&te.updateMatrixWorld(),De.enabled===!0&&De.isPresenting===!0&&(De.cameraAutoUpdate===!0&&De.updateCamera(te),te=De.getCamera()),I.isScene===!0&&I.onBeforeRender(v,I,te,S),f=Ae.get(I,y.length),f.init(),y.push(f),O.multiplyMatrices(te.projectionMatrix,te.matrixWorldInverse),de.setFromProjectionMatrix(O),B=this.localClippingEnabled,V=Ve.init(this.clippingPlanes,B),g=Ce.get(I,m.length),g.init(),m.push(g),os(I,te,0,v.sortObjects),g.finish(),v.sortObjects===!0&&g.sort(q,ne),this.info.render.frame++,V===!0&&Ve.beginShadows();const ce=f.state.shadowsArray;if(Re.render(ce,I,te),V===!0&&Ve.endShadows(),this.info.autoReset===!0&&this.info.reset(),Ne.render(g,I),f.setupLights(v._useLegacyLights),te.isArrayCamera){const he=te.cameras;for(let ae=0,ke=he.length;ae<ke;ae++){const Xe=he[ae];ty(g,I,Xe,Xe.viewport)}}else ty(g,I,te);S!==null&&(D.updateMultisampleRenderTarget(S),D.updateRenderTargetMipmap(S)),I.isScene===!0&&I.onAfterRender(v,I,te),je.resetDefaultState(),R=-1,C=null,y.pop(),y.length>0?f=y[y.length-1]:f=null,m.pop(),m.length>0?g=m[m.length-1]:g=null};function os(I,te,ce,he){if(I.visible===!1)return;if(I.layers.test(te.layers)){if(I.isGroup)ce=I.renderOrder;else if(I.isLOD)I.autoUpdate===!0&&I.update(te);else if(I.isLight)f.pushLight(I),I.castShadow&&f.pushShadow(I);else if(I.isSprite){if(!I.frustumCulled||de.intersectsSprite(I)){he&&_e.setFromMatrixPosition(I.matrixWorld).applyMatrix4(O);const Xe=w.update(I),Qe=I.material;Qe.visible&&g.push(I,Xe,Qe,ce,_e.z,null)}}else if((I.isMesh||I.isLine||I.isPoints)&&(!I.frustumCulled||de.intersectsObject(I))){const Xe=w.update(I),Qe=I.material;if(he&&(I.boundingSphere!==void 0?(I.boundingSphere===null&&I.computeBoundingSphere(),_e.copy(I.boundingSphere.center)):(Xe.boundingSphere===null&&Xe.computeBoundingSphere(),_e.copy(Xe.boundingSphere.center)),_e.applyMatrix4(I.matrixWorld).applyMatrix4(O)),Array.isArray(Qe)){const it=Xe.groups;for(let ut=0,at=it.length;ut<at;ut++){const ct=it[ut],an=Qe[ct.materialIndex];an&&an.visible&&g.push(I,Xe,an,ce,_e.z,ct)}}else Qe.visible&&g.push(I,Xe,Qe,ce,_e.z,null)}}const ke=I.children;for(let Xe=0,Qe=ke.length;Xe<Qe;Xe++)os(ke[Xe],te,ce,he)}function ty(I,te,ce,he){const ae=I.opaque,ke=I.transmissive,Xe=I.transparent;f.setupLightsView(ce),V===!0&&Ve.setGlobalState(v.clippingPlanes,ce),ke.length>0&&eP(ae,ke,te,ce),he&&ee.viewport(M.copy(he)),ae.length>0&&Fu(ae,te,ce),ke.length>0&&Fu(ke,te,ce),Xe.length>0&&Fu(Xe,te,ce),ee.buffers.depth.setTest(!0),ee.buffers.depth.setMask(!0),ee.buffers.color.setMask(!0),ee.setPolygonOffset(!1)}function eP(I,te,ce,he){if((ce.isScene===!0?ce.overrideMaterial:null)!==null)return;const ke=Q.isWebGL2;P===null&&(P=new Br(1,1,{generateMipmaps:!0,type:H.has("EXT_color_buffer_half_float")?tc:Bi,minFilter:Dl,samples:ke?4:0})),v.getDrawingBufferSize(se),ke?P.setSize(se.x,se.y):P.setSize(Ud(se.x),Ud(se.y));const Xe=v.getRenderTarget();v.setRenderTarget(P),v.getClearColor(X),N=v.getClearAlpha(),N<1&&v.setClearColor(16777215,.5),v.clear();const Qe=v.toneMapping;v.toneMapping=Fr,Fu(I,ce,he),D.updateMultisampleRenderTarget(P),D.updateRenderTargetMipmap(P);let it=!1;for(let ut=0,at=te.length;ut<at;ut++){const ct=te[ut],an=ct.object,sr=ct.geometry,An=ct.material,Ps=ct.group;if(An.side===er&&an.layers.test(he.layers)){const $t=An.side;An.side=bn,An.needsUpdate=!0,ny(an,ce,he,sr,An,Ps),An.side=$t,An.needsUpdate=!0,it=!0}}it===!0&&(D.updateMultisampleRenderTarget(P),D.updateRenderTargetMipmap(P)),v.setRenderTarget(Xe),v.setClearColor(X,N),v.toneMapping=Qe}function Fu(I,te,ce){const he=te.isScene===!0?te.overrideMaterial:null;for(let ae=0,ke=I.length;ae<ke;ae++){const Xe=I[ae],Qe=Xe.object,it=Xe.geometry,ut=he===null?Xe.material:he,at=Xe.group;Qe.layers.test(ce.layers)&&ny(Qe,te,ce,it,ut,at)}}function ny(I,te,ce,he,ae,ke){I.onBeforeRender(v,te,ce,he,ae,ke),I.modelViewMatrix.multiplyMatrices(ce.matrixWorldInverse,I.matrixWorld),I.normalMatrix.getNormalMatrix(I.modelViewMatrix),ae.onBeforeRender(v,te,ce,he,I,ke),ae.transparent===!0&&ae.side===er&&ae.forceSinglePass===!1?(ae.side=bn,ae.needsUpdate=!0,v.renderBufferDirect(ce,te,he,ae,I,ke),ae.side=In,ae.needsUpdate=!0,v.renderBufferDirect(ce,te,he,ae,I,ke),ae.side=er):v.renderBufferDirect(ce,te,he,ae,I,ke),I.onAfterRender(v,te,ce,he,ae,ke)}function Uu(I,te,ce){te.isScene!==!0&&(te=Z);const he=z.get(I),ae=f.state.lights,ke=f.state.shadowsArray,Xe=ae.state.version,Qe=re.getParameters(I,ae.state,ke,te,ce),it=re.getProgramCacheKey(Qe);let ut=he.programs;he.environment=I.isMeshStandardMaterial?te.environment:null,he.fog=te.fog,he.envMap=(I.isMeshStandardMaterial?Ie:ye).get(I.envMap||he.environment),ut===void 0&&(I.addEventListener("dispose",Te),ut=new Map,he.programs=ut);let at=ut.get(it);if(at!==void 0){if(he.currentProgram===at&&he.lightsStateVersion===Xe)return sy(I,Qe),at}else Qe.uniforms=re.getUniforms(I),I.onBuild(ce,Qe,v),I.onBeforeCompile(Qe,v),at=re.acquireProgram(Qe,it),ut.set(it,at),he.uniforms=Qe.uniforms;const ct=he.uniforms;return(!I.isShaderMaterial&&!I.isRawShaderMaterial||I.clipping===!0)&&(ct.clippingPlanes=Ve.uniform),sy(I,Qe),he.needsLights=rP(I),he.lightsStateVersion=Xe,he.needsLights&&(ct.ambientLightColor.value=ae.state.ambient,ct.lightProbe.value=ae.state.probe,ct.directionalLights.value=ae.state.directional,ct.directionalLightShadows.value=ae.state.directionalShadow,ct.spotLights.value=ae.state.spot,ct.spotLightShadows.value=ae.state.spotShadow,ct.rectAreaLights.value=ae.state.rectArea,ct.ltc_1.value=ae.state.rectAreaLTC1,ct.ltc_2.value=ae.state.rectAreaLTC2,ct.pointLights.value=ae.state.point,ct.pointLightShadows.value=ae.state.pointShadow,ct.hemisphereLights.value=ae.state.hemi,ct.directionalShadowMap.value=ae.state.directionalShadowMap,ct.directionalShadowMatrix.value=ae.state.directionalShadowMatrix,ct.spotShadowMap.value=ae.state.spotShadowMap,ct.spotLightMatrix.value=ae.state.spotLightMatrix,ct.spotLightMap.value=ae.state.spotLightMap,ct.pointShadowMap.value=ae.state.pointShadowMap,ct.pointShadowMatrix.value=ae.state.pointShadowMatrix),he.currentProgram=at,he.uniformsList=null,at}function ry(I){if(I.uniformsList===null){const te=I.currentProgram.getUniforms();I.uniformsList=hd.seqWithValue(te.seq,I.uniforms)}return I.uniformsList}function sy(I,te){const ce=z.get(I);ce.outputColorSpace=te.outputColorSpace,ce.batching=te.batching,ce.instancing=te.instancing,ce.instancingColor=te.instancingColor,ce.skinning=te.skinning,ce.morphTargets=te.morphTargets,ce.morphNormals=te.morphNormals,ce.morphColors=te.morphColors,ce.morphTargetsCount=te.morphTargetsCount,ce.numClippingPlanes=te.numClippingPlanes,ce.numIntersection=te.numClipIntersection,ce.vertexAlphas=te.vertexAlphas,ce.vertexTangents=te.vertexTangents,ce.toneMapping=te.toneMapping}function tP(I,te,ce,he,ae){te.isScene!==!0&&(te=Z),D.resetTextureUnits();const ke=te.fog,Xe=he.isMeshStandardMaterial?te.environment:null,Qe=S===null?v.outputColorSpace:S.isXRRenderTarget===!0?S.texture.colorSpace:kr,it=(he.isMeshStandardMaterial?Ie:ye).get(he.envMap||Xe),ut=he.vertexColors===!0&&!!ce.attributes.color&&ce.attributes.color.itemSize===4,at=!!ce.attributes.tangent&&(!!he.normalMap||he.anisotropy>0),ct=!!ce.morphAttributes.position,an=!!ce.morphAttributes.normal,sr=!!ce.morphAttributes.color;let An=Fr;he.toneMapped&&(S===null||S.isXRRenderTarget===!0)&&(An=v.toneMapping);const Ps=ce.morphAttributes.position||ce.morphAttributes.normal||ce.morphAttributes.color,$t=Ps!==void 0?Ps.length:0,ht=z.get(he),Qp=f.state.lights;if(V===!0&&(B===!0||I!==C)){const Er=I===C&&he.id===R;Ve.setState(he,I,Er)}let en=!1;he.version===ht.__version?(ht.needsLights&&ht.lightsStateVersion!==Qp.state.version||ht.outputColorSpace!==Qe||ae.isBatchedMesh&&ht.batching===!1||!ae.isBatchedMesh&&ht.batching===!0||ae.isInstancedMesh&&ht.instancing===!1||!ae.isInstancedMesh&&ht.instancing===!0||ae.isSkinnedMesh&&ht.skinning===!1||!ae.isSkinnedMesh&&ht.skinning===!0||ae.isInstancedMesh&&ht.instancingColor===!0&&ae.instanceColor===null||ae.isInstancedMesh&&ht.instancingColor===!1&&ae.instanceColor!==null||ht.envMap!==it||he.fog===!0&&ht.fog!==ke||ht.numClippingPlanes!==void 0&&(ht.numClippingPlanes!==Ve.numPlanes||ht.numIntersection!==Ve.numIntersection)||ht.vertexAlphas!==ut||ht.vertexTangents!==at||ht.morphTargets!==ct||ht.morphNormals!==an||ht.morphColors!==sr||ht.toneMapping!==An||Q.isWebGL2===!0&&ht.morphTargetsCount!==$t)&&(en=!0):(en=!0,ht.__version=he.version);let Zi=ht.currentProgram;en===!0&&(Zi=Uu(he,te,ae));let iy=!1,Ic=!1,ef=!1;const Gn=Zi.getUniforms(),Ji=ht.uniforms;if(ee.useProgram(Zi.program)&&(iy=!0,Ic=!0,ef=!0),he.id!==R&&(R=he.id,Ic=!0),iy||C!==I){Gn.setValue(L,"projectionMatrix",I.projectionMatrix),Gn.setValue(L,"viewMatrix",I.matrixWorldInverse);const Er=Gn.map.cameraPosition;Er!==void 0&&Er.setValue(L,_e.setFromMatrixPosition(I.matrixWorld)),Q.logarithmicDepthBuffer&&Gn.setValue(L,"logDepthBufFC",2/(Math.log(I.far+1)/Math.LN2)),(he.isMeshPhongMaterial||he.isMeshToonMaterial||he.isMeshLambertMaterial||he.isMeshBasicMaterial||he.isMeshStandardMaterial||he.isShaderMaterial)&&Gn.setValue(L,"isOrthographic",I.isOrthographicCamera===!0),C!==I&&(C=I,Ic=!0,ef=!0)}if(ae.isSkinnedMesh){Gn.setOptional(L,ae,"bindMatrix"),Gn.setOptional(L,ae,"bindMatrixInverse");const Er=ae.skeleton;Er&&(Q.floatVertexTextures?(Er.boneTexture===null&&Er.computeBoneTexture(),Gn.setValue(L,"boneTexture",Er.boneTexture,D)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required."))}ae.isBatchedMesh&&(Gn.setOptional(L,ae,"batchingTexture"),Gn.setValue(L,"batchingTexture",ae._matricesTexture,D));const tf=ce.morphAttributes;if((tf.position!==void 0||tf.normal!==void 0||tf.color!==void 0&&Q.isWebGL2===!0)&&Ze.update(ae,ce,Zi),(Ic||ht.receiveShadow!==ae.receiveShadow)&&(ht.receiveShadow=ae.receiveShadow,Gn.setValue(L,"receiveShadow",ae.receiveShadow)),he.isMeshGouraudMaterial&&he.envMap!==null&&(Ji.envMap.value=it,Ji.flipEnvMap.value=it.isCubeTexture&&it.isRenderTargetTexture===!1?-1:1),Ic&&(Gn.setValue(L,"toneMappingExposure",v.toneMappingExposure),ht.needsLights&&nP(Ji,ef),ke&&he.fog===!0&&Se.refreshFogUniforms(Ji,ke),Se.refreshMaterialUniforms(Ji,he,$,K,P),hd.upload(L,ry(ht),Ji,D)),he.isShaderMaterial&&he.uniformsNeedUpdate===!0&&(hd.upload(L,ry(ht),Ji,D),he.uniformsNeedUpdate=!1),he.isSpriteMaterial&&Gn.setValue(L,"center",ae.center),Gn.setValue(L,"modelViewMatrix",ae.modelViewMatrix),Gn.setValue(L,"normalMatrix",ae.normalMatrix),Gn.setValue(L,"modelMatrix",ae.matrixWorld),he.isShaderMaterial||he.isRawShaderMaterial){const Er=he.uniformsGroups;for(let nf=0,sP=Er.length;nf<sP;nf++)if(Q.isWebGL2){const oy=Er[nf];Be.update(oy,Zi),Be.bind(oy,Zi)}else console.warn("THREE.WebGLRenderer: Uniform Buffer Objects can only be used with WebGL 2.")}return Zi}function nP(I,te){I.ambientLightColor.needsUpdate=te,I.lightProbe.needsUpdate=te,I.directionalLights.needsUpdate=te,I.directionalLightShadows.needsUpdate=te,I.pointLights.needsUpdate=te,I.pointLightShadows.needsUpdate=te,I.spotLights.needsUpdate=te,I.spotLightShadows.needsUpdate=te,I.rectAreaLights.needsUpdate=te,I.hemisphereLights.needsUpdate=te}function rP(I){return I.isMeshLambertMaterial||I.isMeshToonMaterial||I.isMeshPhongMaterial||I.isMeshStandardMaterial||I.isShadowMaterial||I.isShaderMaterial&&I.lights===!0}this.getActiveCubeFace=function(){return x},this.getActiveMipmapLevel=function(){return E},this.getRenderTarget=function(){return S},this.setRenderTargetTextures=function(I,te,ce){z.get(I.texture).__webglTexture=te,z.get(I.depthTexture).__webglTexture=ce;const he=z.get(I);he.__hasExternalTextures=!0,he.__hasExternalTextures&&(he.__autoAllocateDepthBuffer=ce===void 0,he.__autoAllocateDepthBuffer||H.has("WEBGL_multisampled_render_to_texture")===!0&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),he.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(I,te){const ce=z.get(I);ce.__webglFramebuffer=te,ce.__useDefaultFramebuffer=te===void 0},this.setRenderTarget=function(I,te=0,ce=0){S=I,x=te,E=ce;let he=!0,ae=null,ke=!1,Xe=!1;if(I){const it=z.get(I);it.__useDefaultFramebuffer!==void 0?(ee.bindFramebuffer(L.FRAMEBUFFER,null),he=!1):it.__webglFramebuffer===void 0?D.setupRenderTarget(I):it.__hasExternalTextures&&D.rebindTextures(I,z.get(I.texture).__webglTexture,z.get(I.depthTexture).__webglTexture);const ut=I.texture;(ut.isData3DTexture||ut.isDataArrayTexture||ut.isCompressedArrayTexture)&&(Xe=!0);const at=z.get(I).__webglFramebuffer;I.isWebGLCubeRenderTarget?(Array.isArray(at[te])?ae=at[te][ce]:ae=at[te],ke=!0):Q.isWebGL2&&I.samples>0&&D.useMultisampledRTT(I)===!1?ae=z.get(I).__webglMultisampledFramebuffer:Array.isArray(at)?ae=at[ce]:ae=at,M.copy(I.viewport),G.copy(I.scissor),F=I.scissorTest}else M.copy(le).multiplyScalar($).floor(),G.copy(ue).multiplyScalar($).floor(),F=Ee;if(ee.bindFramebuffer(L.FRAMEBUFFER,ae)&&Q.drawBuffers&&he&&ee.drawBuffers(I,ae),ee.viewport(M),ee.scissor(G),ee.setScissorTest(F),ke){const it=z.get(I.texture);L.framebufferTexture2D(L.FRAMEBUFFER,L.COLOR_ATTACHMENT0,L.TEXTURE_CUBE_MAP_POSITIVE_X+te,it.__webglTexture,ce)}else if(Xe){const it=z.get(I.texture),ut=te||0;L.framebufferTextureLayer(L.FRAMEBUFFER,L.COLOR_ATTACHMENT0,it.__webglTexture,ce||0,ut)}R=-1},this.readRenderTargetPixels=function(I,te,ce,he,ae,ke,Xe){if(!(I&&I.isWebGLRenderTarget)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");return}let Qe=z.get(I).__webglFramebuffer;if(I.isWebGLCubeRenderTarget&&Xe!==void 0&&(Qe=Qe[Xe]),Qe){ee.bindFramebuffer(L.FRAMEBUFFER,Qe);try{const it=I.texture,ut=it.format,at=it.type;if(ut!==fn&&we.convert(ut)!==L.getParameter(L.IMPLEMENTATION_COLOR_READ_FORMAT)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");return}const ct=at===tc&&(H.has("EXT_color_buffer_half_float")||Q.isWebGL2&&H.has("EXT_color_buffer_float"));if(at!==Bi&&we.convert(at)!==L.getParameter(L.IMPLEMENTATION_COLOR_READ_TYPE)&&!(at===jn&&(Q.isWebGL2||H.has("OES_texture_float")||H.has("WEBGL_color_buffer_float")))&&!ct){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");return}te>=0&&te<=I.width-he&&ce>=0&&ce<=I.height-ae&&L.readPixels(te,ce,he,ae,we.convert(ut),we.convert(at),ke)}finally{const it=S!==null?z.get(S).__webglFramebuffer:null;ee.bindFramebuffer(L.FRAMEBUFFER,it)}}},this.copyFramebufferToTexture=function(I,te,ce=0){const he=Math.pow(2,-ce),ae=Math.floor(te.image.width*he),ke=Math.floor(te.image.height*he);D.setTexture2D(te,0),L.copyTexSubImage2D(L.TEXTURE_2D,ce,0,0,I.x,I.y,ae,ke),ee.unbindTexture()},this.copyTextureToTexture=function(I,te,ce,he=0){const ae=te.image.width,ke=te.image.height,Xe=we.convert(ce.format),Qe=we.convert(ce.type);D.setTexture2D(ce,0),L.pixelStorei(L.UNPACK_FLIP_Y_WEBGL,ce.flipY),L.pixelStorei(L.UNPACK_PREMULTIPLY_ALPHA_WEBGL,ce.premultiplyAlpha),L.pixelStorei(L.UNPACK_ALIGNMENT,ce.unpackAlignment),te.isDataTexture?L.texSubImage2D(L.TEXTURE_2D,he,I.x,I.y,ae,ke,Xe,Qe,te.image.data):te.isCompressedTexture?L.compressedTexSubImage2D(L.TEXTURE_2D,he,I.x,I.y,te.mipmaps[0].width,te.mipmaps[0].height,Xe,te.mipmaps[0].data):L.texSubImage2D(L.TEXTURE_2D,he,I.x,I.y,Xe,Qe,te.image),he===0&&ce.generateMipmaps&&L.generateMipmap(L.TEXTURE_2D),ee.unbindTexture()},this.copyTextureToTexture3D=function(I,te,ce,he,ae=0){if(v.isWebGL1Renderer){console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");return}const ke=I.max.x-I.min.x+1,Xe=I.max.y-I.min.y+1,Qe=I.max.z-I.min.z+1,it=we.convert(he.format),ut=we.convert(he.type);let at;if(he.isData3DTexture)D.setTexture3D(he,0),at=L.TEXTURE_3D;else if(he.isDataArrayTexture)D.setTexture2DArray(he,0),at=L.TEXTURE_2D_ARRAY;else{console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");return}L.pixelStorei(L.UNPACK_FLIP_Y_WEBGL,he.flipY),L.pixelStorei(L.UNPACK_PREMULTIPLY_ALPHA_WEBGL,he.premultiplyAlpha),L.pixelStorei(L.UNPACK_ALIGNMENT,he.unpackAlignment);const ct=L.getParameter(L.UNPACK_ROW_LENGTH),an=L.getParameter(L.UNPACK_IMAGE_HEIGHT),sr=L.getParameter(L.UNPACK_SKIP_PIXELS),An=L.getParameter(L.UNPACK_SKIP_ROWS),Ps=L.getParameter(L.UNPACK_SKIP_IMAGES),$t=ce.isCompressedTexture?ce.mipmaps[0]:ce.image;L.pixelStorei(L.UNPACK_ROW_LENGTH,$t.width),L.pixelStorei(L.UNPACK_IMAGE_HEIGHT,$t.height),L.pixelStorei(L.UNPACK_SKIP_PIXELS,I.min.x),L.pixelStorei(L.UNPACK_SKIP_ROWS,I.min.y),L.pixelStorei(L.UNPACK_SKIP_IMAGES,I.min.z),ce.isDataTexture||ce.isData3DTexture?L.texSubImage3D(at,ae,te.x,te.y,te.z,ke,Xe,Qe,it,ut,$t.data):ce.isCompressedArrayTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),L.compressedTexSubImage3D(at,ae,te.x,te.y,te.z,ke,Xe,Qe,it,$t.data)):L.texSubImage3D(at,ae,te.x,te.y,te.z,ke,Xe,Qe,it,ut,$t),L.pixelStorei(L.UNPACK_ROW_LENGTH,ct),L.pixelStorei(L.UNPACK_IMAGE_HEIGHT,an),L.pixelStorei(L.UNPACK_SKIP_PIXELS,sr),L.pixelStorei(L.UNPACK_SKIP_ROWS,An),L.pixelStorei(L.UNPACK_SKIP_IMAGES,Ps),ae===0&&he.generateMipmaps&&L.generateMipmap(at),ee.unbindTexture()},this.initTexture=function(I){I.isCubeTexture?D.setTextureCube(I,0):I.isData3DTexture?D.setTexture3D(I,0):I.isDataArrayTexture||I.isCompressedArrayTexture?D.setTexture2DArray(I,0):D.setTexture2D(I,0),ee.unbindTexture()},this.resetState=function(){x=0,E=0,S=null,ee.reset(),je.reset()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return js}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=e===gc?"display-p3":"srgb",t.unpackColorSpace=Rt.workingColorSpace===Fo?"display-p3":"srgb"}get physicallyCorrectLights(){return console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),!this.useLegacyLights}set physicallyCorrectLights(e){console.warn("THREE.WebGLRenderer: The property .physicallyCorrectLights has been removed. Set renderer.useLegacyLights instead."),this.useLegacyLights=!e}get outputEncoding(){return console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace===nn?Mo:FA}set outputEncoding(e){console.warn("THREE.WebGLRenderer: Property .outputEncoding has been removed. Use .outputColorSpace instead."),this.outputColorSpace=e===Mo?nn:kr}get useLegacyLights(){return console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights}set useLegacyLights(e){console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights=e}}class fF extends bs{}fF.prototype.isWebGL1Renderer=!0;class Hg{constructor(e,t=25e-5){this.isFogExp2=!0,this.name="",this.color=new xe(e),this.density=t}clone(){return new Hg(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class jg{constructor(e,t=1,r=1e3){this.isFog=!0,this.name="",this.color=new xe(e),this.near=t,this.far=r}clone(){return new jg(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class gu extends wt{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),e.background!==null&&(this.background=e.background.clone()),e.environment!==null&&(this.environment=e.environment.clone()),e.fog!==null&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,e.overrideMaterial!==null&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return this.fog!==null&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),this.backgroundIntensity!==1&&(t.object.backgroundIntensity=this.backgroundIntensity),t}}class tT extends gn{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new xe(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}class xc extends Wn{constructor(e=null,t=1,r=1,s,i,o,a,c,l=jt,u=jt,h,d){super(null,o,a,c,l,u,s,i,h,d),this.isDataTexture=!0,this.image={data:e,width:t,height:r},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class f_ extends Lt{constructor(e,t,r,s=1){super(e,t,r),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=s}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const ca=new qe,Mx=new qe,oh=[],Rx=new Ht,mF=new qe,kc=new Jt,Bc=new vr;class _F extends Jt{constructor(e,t,r){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new f_(new Float32Array(r*16),16),this.instanceColor=null,this.count=r,this.boundingBox=null,this.boundingSphere=null;for(let s=0;s<r;s++)this.setMatrixAt(s,mF)}computeBoundingBox(){const e=this.geometry,t=this.count;this.boundingBox===null&&(this.boundingBox=new Ht),e.boundingBox===null&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let r=0;r<t;r++)this.getMatrixAt(r,ca),Rx.copy(e.boundingBox).applyMatrix4(ca),this.boundingBox.union(Rx)}computeBoundingSphere(){const e=this.geometry,t=this.count;this.boundingSphere===null&&(this.boundingSphere=new vr),e.boundingSphere===null&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let r=0;r<t;r++)this.getMatrixAt(r,ca),Bc.copy(e.boundingSphere).applyMatrix4(ca),this.boundingSphere.union(Bc)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),e.instanceColor!==null&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,e.boundingBox!==null&&(this.boundingBox=e.boundingBox.clone()),e.boundingSphere!==null&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,e*3)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,e*16)}raycast(e,t){const r=this.matrixWorld,s=this.count;if(kc.geometry=this.geometry,kc.material=this.material,kc.material!==void 0&&(this.boundingSphere===null&&this.computeBoundingSphere(),Bc.copy(this.boundingSphere),Bc.applyMatrix4(r),e.ray.intersectsSphere(Bc)!==!1))for(let i=0;i<s;i++){this.getMatrixAt(i,ca),Mx.multiplyMatrices(r,ca),kc.matrixWorld=Mx,kc.raycast(e,oh);for(let o=0,a=oh.length;o<a;o++){const c=oh[o];c.instanceId=i,c.object=this,t.push(c)}oh.length=0}}setColorAt(e,t){this.instanceColor===null&&(this.instanceColor=new f_(new Float32Array(this.instanceMatrix.count*3),3)),t.toArray(this.instanceColor.array,e*3)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,e*16)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}class Cs extends gn{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new xe(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const wx=new T,Ox=new T,Px=new qe,If=new ni,ah=new vr;class gF extends wt{constructor(e=new sn,t=new Cs){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(e.index===null){const t=e.attributes.position,r=[0];for(let s=1,i=t.count;s<i;s++)wx.fromBufferAttribute(t,s-1),Ox.fromBufferAttribute(t,s),r[s]=r[s-1],r[s]+=wx.distanceTo(Ox);e.setAttribute("lineDistance",new gt(r,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const r=this.geometry,s=this.matrixWorld,i=e.params.Line.threshold,o=r.drawRange;if(r.boundingSphere===null&&r.computeBoundingSphere(),ah.copy(r.boundingSphere),ah.applyMatrix4(s),ah.radius+=i,e.ray.intersectsSphere(ah)===!1)return;Px.copy(s).invert(),If.copy(e.ray).applyMatrix4(Px);const a=i/((this.scale.x+this.scale.y+this.scale.z)/3),c=a*a,l=new T,u=new T,h=new T,d=new T,p=this.isLineSegments?2:1,_=r.index,f=r.attributes.position;if(_!==null){const m=Math.max(0,o.start),y=Math.min(_.count,o.start+o.count);for(let v=m,b=y-1;v<b;v+=p){const x=_.getX(v),E=_.getX(v+1);if(l.fromBufferAttribute(f,x),u.fromBufferAttribute(f,E),If.distanceSqToSegment(l,u,d,h)>c)continue;d.applyMatrix4(this.matrixWorld);const R=e.ray.origin.distanceTo(d);R<e.near||R>e.far||t.push({distance:R,point:h.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}else{const m=Math.max(0,o.start),y=Math.min(f.count,o.start+o.count);for(let v=m,b=y-1;v<b;v+=p){if(l.fromBufferAttribute(f,v),u.fromBufferAttribute(f,v+1),If.distanceSqToSegment(l,u,d,h)>c)continue;d.applyMatrix4(this.matrixWorld);const E=e.ray.origin.distanceTo(d);E<e.near||E>e.far||t.push({distance:E,point:h.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}}updateMorphTargets(){const t=this.geometry.morphAttributes,r=Object.keys(t);if(r.length>0){const s=t[r[0]];if(s!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let i=0,o=s.length;i<o;i++){const a=s[i].name||String(i);this.morphTargetInfluences.push(0),this.morphTargetDictionary[a]=i}}}}}const Nx=new T,Ix=new T;class ic extends gF{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(e.index===null){const t=e.attributes.position,r=[];for(let s=0,i=t.count;s<i;s+=2)Nx.fromBufferAttribute(t,s),Ix.fromBufferAttribute(t,s+1),r[s]=s===0?0:r[s-1],r[s+1]=r[s]+Nx.distanceTo(Ix);e.setAttribute("lineDistance",new gt(r,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class Pi extends gn{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new xe(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}const Dx=new qe,m_=new ni,ch=new vr,lh=new T;class vl extends wt{constructor(e=new sn,t=new Pi){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,t){const r=this.geometry,s=this.matrixWorld,i=e.params.Points.threshold,o=r.drawRange;if(r.boundingSphere===null&&r.computeBoundingSphere(),ch.copy(r.boundingSphere),ch.applyMatrix4(s),ch.radius+=i,e.ray.intersectsSphere(ch)===!1)return;Dx.copy(s).invert(),m_.copy(e.ray).applyMatrix4(Dx);const a=i/((this.scale.x+this.scale.y+this.scale.z)/3),c=a*a,l=r.index,h=r.attributes.position;if(l!==null){const d=Math.max(0,o.start),p=Math.min(l.count,o.start+o.count);for(let _=d,g=p;_<g;_++){const f=l.getX(_);lh.fromBufferAttribute(h,f),Lx(lh,f,c,s,e,t,this)}}else{const d=Math.max(0,o.start),p=Math.min(h.count,o.start+o.count);for(let _=d,g=p;_<g;_++)lh.fromBufferAttribute(h,_),Lx(lh,_,c,s,e,t,this)}}updateMorphTargets(){const t=this.geometry.morphAttributes,r=Object.keys(t);if(r.length>0){const s=t[r[0]];if(s!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let i=0,o=s.length;i<o;i++){const a=s[i].name||String(i);this.morphTargetInfluences.push(0),this.morphTargetDictionary[a]=i}}}}}function Lx(n,e,t,r,s,i,o){const a=m_.distanceSqToPoint(n);if(a<t){const c=new T;m_.closestPointToPoint(n,c),c.applyMatrix4(r);const l=s.ray.origin.distanceTo(c);if(l<s.near||l>s.far)return;i.push({distance:l,distanceToRay:Math.sqrt(a),point:c,index:e,face:null,object:o})}}class Rs{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(e,t){const r=this.getUtoTmapping(e);return this.getPoint(r,t)}getPoints(e=5){const t=[];for(let r=0;r<=e;r++)t.push(this.getPoint(r/e));return t}getSpacedPoints(e=5){const t=[];for(let r=0;r<=e;r++)t.push(this.getPointAt(r/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let r,s=this.getPoint(0),i=0;t.push(0);for(let o=1;o<=e;o++)r=this.getPoint(o/e),i+=r.distanceTo(s),t.push(i),s=r;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t){const r=this.getLengths();let s=0;const i=r.length;let o;t?o=t:o=e*r[i-1];let a=0,c=i-1,l;for(;a<=c;)if(s=Math.floor(a+(c-a)/2),l=r[s]-o,l<0)a=s+1;else if(l>0)c=s-1;else{c=s;break}if(s=c,r[s]===o)return s/(i-1);const u=r[s],d=r[s+1]-u,p=(o-u)/d;return(s+p)/(i-1)}getTangent(e,t){let s=e-1e-4,i=e+1e-4;s<0&&(s=0),i>1&&(i=1);const o=this.getPoint(s),a=this.getPoint(i),c=t||(o.isVector2?new W:new T);return c.copy(a).sub(o).normalize(),c}getTangentAt(e,t){const r=this.getUtoTmapping(e);return this.getTangent(r,t)}computeFrenetFrames(e,t){const r=new T,s=[],i=[],o=[],a=new T,c=new qe;for(let p=0;p<=e;p++){const _=p/e;s[p]=this.getTangentAt(_,new T)}i[0]=new T,o[0]=new T;let l=Number.MAX_VALUE;const u=Math.abs(s[0].x),h=Math.abs(s[0].y),d=Math.abs(s[0].z);u<=l&&(l=u,r.set(1,0,0)),h<=l&&(l=h,r.set(0,1,0)),d<=l&&r.set(0,0,1),a.crossVectors(s[0],r).normalize(),i[0].crossVectors(s[0],a),o[0].crossVectors(s[0],i[0]);for(let p=1;p<=e;p++){if(i[p]=i[p-1].clone(),o[p]=o[p-1].clone(),a.crossVectors(s[p-1],s[p]),a.length()>Number.EPSILON){a.normalize();const _=Math.acos(pn(s[p-1].dot(s[p]),-1,1));i[p].applyMatrix4(c.makeRotationAxis(a,_))}o[p].crossVectors(s[p],i[p])}if(t===!0){let p=Math.acos(pn(i[0].dot(i[e]),-1,1));p/=e,s[0].dot(a.crossVectors(i[0],i[e]))>0&&(p=-p);for(let _=1;_<=e;_++)i[_].applyMatrix4(c.makeRotationAxis(s[_],p*_)),o[_].crossVectors(s[_],i[_])}return{tangents:s,normals:i,binormals:o}}clone(){return new this.constructor().copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class Wg extends Rs{constructor(e=0,t=0,r=1,s=1,i=0,o=Math.PI*2,a=!1,c=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=r,this.yRadius=s,this.aStartAngle=i,this.aEndAngle=o,this.aClockwise=a,this.aRotation=c}getPoint(e,t){const r=t||new W,s=Math.PI*2;let i=this.aEndAngle-this.aStartAngle;const o=Math.abs(i)<Number.EPSILON;for(;i<0;)i+=s;for(;i>s;)i-=s;i<Number.EPSILON&&(o?i=0:i=s),this.aClockwise===!0&&!o&&(i===s?i=-s:i=i-s);const a=this.aStartAngle+e*i;let c=this.aX+this.xRadius*Math.cos(a),l=this.aY+this.yRadius*Math.sin(a);if(this.aRotation!==0){const u=Math.cos(this.aRotation),h=Math.sin(this.aRotation),d=c-this.aX,p=l-this.aY;c=d*u-p*h+this.aX,l=d*h+p*u+this.aY}return r.set(c,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}class vF extends Wg{constructor(e,t,r,s,i,o){super(e,t,r,r,s,i,o),this.isArcCurve=!0,this.type="ArcCurve"}}function Xg(){let n=0,e=0,t=0,r=0;function s(i,o,a,c){n=i,e=a,t=-3*i+3*o-2*a-c,r=2*i-2*o+a+c}return{initCatmullRom:function(i,o,a,c,l){s(o,a,l*(a-i),l*(c-o))},initNonuniformCatmullRom:function(i,o,a,c,l,u,h){let d=(o-i)/l-(a-i)/(l+u)+(a-o)/u,p=(a-o)/u-(c-o)/(u+h)+(c-a)/h;d*=u,p*=u,s(o,a,d,p)},calc:function(i){const o=i*i,a=o*i;return n+e*i+t*o+r*a}}}const uh=new T,Df=new Xg,Lf=new Xg,Ff=new Xg;class yF extends Rs{constructor(e=[],t=!1,r="centripetal",s=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=r,this.tension=s}getPoint(e,t=new T){const r=t,s=this.points,i=s.length,o=(i-(this.closed?0:1))*e;let a=Math.floor(o),c=o-a;this.closed?a+=a>0?0:(Math.floor(Math.abs(a)/i)+1)*i:c===0&&a===i-1&&(a=i-2,c=1);let l,u;this.closed||a>0?l=s[(a-1)%i]:(uh.subVectors(s[0],s[1]).add(s[0]),l=uh);const h=s[a%i],d=s[(a+1)%i];if(this.closed||a+2<i?u=s[(a+2)%i]:(uh.subVectors(s[i-1],s[i-2]).add(s[i-1]),u=uh),this.curveType==="centripetal"||this.curveType==="chordal"){const p=this.curveType==="chordal"?.5:.25;let _=Math.pow(l.distanceToSquared(h),p),g=Math.pow(h.distanceToSquared(d),p),f=Math.pow(d.distanceToSquared(u),p);g<1e-4&&(g=1),_<1e-4&&(_=g),f<1e-4&&(f=g),Df.initNonuniformCatmullRom(l.x,h.x,d.x,u.x,_,g,f),Lf.initNonuniformCatmullRom(l.y,h.y,d.y,u.y,_,g,f),Ff.initNonuniformCatmullRom(l.z,h.z,d.z,u.z,_,g,f)}else this.curveType==="catmullrom"&&(Df.initCatmullRom(l.x,h.x,d.x,u.x,this.tension),Lf.initCatmullRom(l.y,h.y,d.y,u.y,this.tension),Ff.initCatmullRom(l.z,h.z,d.z,u.z,this.tension));return r.set(Df.calc(c),Lf.calc(c),Ff.calc(c)),r}copy(e){super.copy(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const s=e.points[t];this.points.push(s.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,r=this.points.length;t<r;t++){const s=this.points[t];e.points.push(s.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const s=e.points[t];this.points.push(new T().fromArray(s))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function Fx(n,e,t,r,s){const i=(r-e)*.5,o=(s-t)*.5,a=n*n,c=n*a;return(2*t-2*r+i+o)*c+(-3*t+3*r-2*i-o)*a+i*n+t}function xF(n,e){const t=1-n;return t*t*e}function bF(n,e){return 2*(1-n)*n*e}function CF(n,e){return n*n*e}function yl(n,e,t,r){return xF(n,e)+bF(n,t)+CF(n,r)}function EF(n,e){const t=1-n;return t*t*t*e}function SF(n,e){const t=1-n;return 3*t*t*n*e}function AF(n,e){return 3*(1-n)*n*n*e}function TF(n,e){return n*n*n*e}function xl(n,e,t,r,s){return EF(n,e)+SF(n,t)+AF(n,r)+TF(n,s)}class nT extends Rs{constructor(e=new W,t=new W,r=new W,s=new W){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=r,this.v3=s}getPoint(e,t=new W){const r=t,s=this.v0,i=this.v1,o=this.v2,a=this.v3;return r.set(xl(e,s.x,i.x,o.x,a.x),xl(e,s.y,i.y,o.y,a.y)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class MF extends Rs{constructor(e=new T,t=new T,r=new T,s=new T){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=r,this.v3=s}getPoint(e,t=new T){const r=t,s=this.v0,i=this.v1,o=this.v2,a=this.v3;return r.set(xl(e,s.x,i.x,o.x,a.x),xl(e,s.y,i.y,o.y,a.y),xl(e,s.z,i.z,o.z,a.z)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class rT extends Rs{constructor(e=new W,t=new W){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new W){const r=t;return e===1?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new W){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class RF extends Rs{constructor(e=new T,t=new T){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new T){const r=t;return e===1?r.copy(this.v2):(r.copy(this.v2).sub(this.v1),r.multiplyScalar(e).add(this.v1)),r}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new T){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class sT extends Rs{constructor(e=new W,t=new W,r=new W){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=r}getPoint(e,t=new W){const r=t,s=this.v0,i=this.v1,o=this.v2;return r.set(yl(e,s.x,i.x,o.x),yl(e,s.y,i.y,o.y)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class wF extends Rs{constructor(e=new T,t=new T,r=new T){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=r}getPoint(e,t=new T){const r=t,s=this.v0,i=this.v1,o=this.v2;return r.set(yl(e,s.x,i.x,o.x),yl(e,s.y,i.y,o.y),yl(e,s.z,i.z,o.z)),r}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class iT extends Rs{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new W){const r=t,s=this.points,i=(s.length-1)*e,o=Math.floor(i),a=i-o,c=s[o===0?o:o-1],l=s[o],u=s[o>s.length-2?s.length-1:o+1],h=s[o>s.length-3?s.length-1:o+2];return r.set(Fx(a,c.x,l.x,u.x,h.x),Fx(a,c.y,l.y,u.y,h.y)),r}copy(e){super.copy(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const s=e.points[t];this.points.push(s.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,r=this.points.length;t<r;t++){const s=this.points[t];e.points.push(s.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,r=e.points.length;t<r;t++){const s=e.points[t];this.points.push(new W().fromArray(s))}return this}}var __=Object.freeze({__proto__:null,ArcCurve:vF,CatmullRomCurve3:yF,CubicBezierCurve:nT,CubicBezierCurve3:MF,EllipseCurve:Wg,LineCurve:rT,LineCurve3:RF,QuadraticBezierCurve:sT,QuadraticBezierCurve3:wF,SplineCurve:iT});class OF extends Rs{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);if(!e.equals(t)){const r=e.isVector2===!0?"LineCurve":"LineCurve3";this.curves.push(new __[r](t,e))}return this}getPoint(e,t){const r=e*this.getLength(),s=this.getCurveLengths();let i=0;for(;i<s.length;){if(s[i]>=r){const o=s[i]-r,a=this.curves[i],c=a.getLength(),l=c===0?0:1-o/c;return a.getPointAt(l,t)}i++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let r=0,s=this.curves.length;r<s;r++)t+=this.curves[r].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let r=0;r<=e;r++)t.push(this.getPoint(r/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let r;for(let s=0,i=this.curves;s<i.length;s++){const o=i[s],a=o.isEllipseCurve?e*2:o.isLineCurve||o.isLineCurve3?1:o.isSplineCurve?e*o.points.length:e,c=o.getPoints(a);for(let l=0;l<c.length;l++){const u=c[l];r&&r.equals(u)||(t.push(u),r=u)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,r=e.curves.length;t<r;t++){const s=e.curves[t];this.curves.push(s.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,r=this.curves.length;t<r;t++){const s=this.curves[t];e.curves.push(s.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,r=e.curves.length;t<r;t++){const s=e.curves[t];this.curves.push(new __[s.type]().fromJSON(s))}return this}}let Ya=class extends OF{constructor(e){super(),this.type="Path",this.currentPoint=new W,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,r=e.length;t<r;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const r=new rT(this.currentPoint.clone(),new W(e,t));return this.curves.push(r),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,r,s){const i=new sT(this.currentPoint.clone(),new W(e,t),new W(r,s));return this.curves.push(i),this.currentPoint.set(r,s),this}bezierCurveTo(e,t,r,s,i,o){const a=new nT(this.currentPoint.clone(),new W(e,t),new W(r,s),new W(i,o));return this.curves.push(a),this.currentPoint.set(i,o),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),r=new iT(t);return this.curves.push(r),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,r,s,i,o){const a=this.currentPoint.x,c=this.currentPoint.y;return this.absarc(e+a,t+c,r,s,i,o),this}absarc(e,t,r,s,i,o){return this.absellipse(e,t,r,r,s,i,o),this}ellipse(e,t,r,s,i,o,a,c){const l=this.currentPoint.x,u=this.currentPoint.y;return this.absellipse(e+l,t+u,r,s,i,o,a,c),this}absellipse(e,t,r,s,i,o,a,c){const l=new Wg(e,t,r,s,i,o,a,c);if(this.curves.length>0){const h=l.getPoint(0);h.equals(this.currentPoint)||this.lineTo(h.x,h.y)}this.curves.push(l);const u=l.getPoint(1);return this.currentPoint.copy(u),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}};class $g extends sn{constructor(e=1,t=1,r=1,s=32,i=1,o=!1,a=0,c=Math.PI*2){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:s,heightSegments:i,openEnded:o,thetaStart:a,thetaLength:c};const l=this;s=Math.floor(s),i=Math.floor(i);const u=[],h=[],d=[],p=[];let _=0;const g=[],f=r/2;let m=0;y(),o===!1&&(e>0&&v(!0),t>0&&v(!1)),this.setIndex(u),this.setAttribute("position",new gt(h,3)),this.setAttribute("normal",new gt(d,3)),this.setAttribute("uv",new gt(p,2));function y(){const b=new T,x=new T;let E=0;const S=(t-e)/r;for(let R=0;R<=i;R++){const C=[],M=R/i,G=M*(t-e)+e;for(let F=0;F<=s;F++){const X=F/s,N=X*c+a,j=Math.sin(N),K=Math.cos(N);x.x=G*j,x.y=-M*r+f,x.z=G*K,h.push(x.x,x.y,x.z),b.set(j,S,K).normalize(),d.push(b.x,b.y,b.z),p.push(X,1-M),C.push(_++)}g.push(C)}for(let R=0;R<s;R++)for(let C=0;C<i;C++){const M=g[C][R],G=g[C+1][R],F=g[C+1][R+1],X=g[C][R+1];u.push(M,G,X),u.push(G,F,X),E+=6}l.addGroup(m,E,0),m+=E}function v(b){const x=_,E=new W,S=new T;let R=0;const C=b===!0?e:t,M=b===!0?1:-1;for(let F=1;F<=s;F++)h.push(0,f*M,0),d.push(0,M,0),p.push(.5,.5),_++;const G=_;for(let F=0;F<=s;F++){const N=F/s*c+a,j=Math.cos(N),K=Math.sin(N);S.x=C*K,S.y=f*M,S.z=C*j,h.push(S.x,S.y,S.z),d.push(0,M,0),E.x=j*.5+.5,E.y=K*.5*M+.5,p.push(E.x,E.y),_++}for(let F=0;F<s;F++){const X=x+F,N=G+F;b===!0?u.push(N,N+1,X):u.push(N+1,N,X),R+=3}l.addGroup(m,R,b===!0?1:2),m+=R}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new $g(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class qg extends $g{constructor(e=1,t=1,r=32,s=1,i=!1,o=0,a=Math.PI*2){super(0,e,t,r,s,i,o,a),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:s,openEnded:i,thetaStart:o,thetaLength:a}}static fromJSON(e){return new qg(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class Ka extends Ya{constructor(e){super(e),this.uuid=Uo(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let r=0,s=this.holes.length;r<s;r++)t[r]=this.holes[r].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,r=e.holes.length;t<r;t++){const s=e.holes[t];this.holes.push(s.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,r=this.holes.length;t<r;t++){const s=this.holes[t];e.holes.push(s.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,r=e.holes.length;t<r;t++){const s=e.holes[t];this.holes.push(new Ya().fromJSON(s))}return this}}const PF={triangulate:function(n,e,t=2){const r=e&&e.length,s=r?e[0]*t:n.length;let i=oT(n,0,s,t,!0);const o=[];if(!i||i.next===i.prev)return o;let a,c,l,u,h,d,p;if(r&&(i=FF(n,e,i,t)),n.length>80*t){a=l=n[0],c=u=n[1];for(let _=t;_<s;_+=t)h=n[_],d=n[_+1],h<a&&(a=h),d<c&&(c=d),h>l&&(l=h),d>u&&(u=d);p=Math.max(l-a,u-c),p=p!==0?32767/p:0}return Ll(i,o,t,a,c,p,0),o}};function oT(n,e,t,r,s){let i,o;if(s===$F(n,e,t,r)>0)for(i=e;i<t;i+=r)o=Ux(i,n[i],n[i+1],o);else for(i=t-r;i>=e;i-=r)o=Ux(i,n[i],n[i+1],o);return o&&_p(o,o.next)&&(Ul(o),o=o.next),o}function Oo(n,e){if(!n)return n;e||(e=n);let t=n,r;do if(r=!1,!t.steiner&&(_p(t,t.next)||Zt(t.prev,t,t.next)===0)){if(Ul(t),t=e=t.prev,t===t.next)break;r=!0}else t=t.next;while(r||t!==e);return e}function Ll(n,e,t,r,s,i,o){if(!n)return;!o&&i&&VF(n,r,s,i);let a=n,c,l;for(;n.prev!==n.next;){if(c=n.prev,l=n.next,i?IF(n,r,s,i):NF(n)){e.push(c.i/t|0),e.push(n.i/t|0),e.push(l.i/t|0),Ul(n),n=l.next,a=l.next;continue}if(n=l,n===a){o?o===1?(n=DF(Oo(n),e,t),Ll(n,e,t,r,s,i,2)):o===2&&LF(n,e,t,r,s,i):Ll(Oo(n),e,t,r,s,i,1);break}}}function NF(n){const e=n.prev,t=n,r=n.next;if(Zt(e,t,r)>=0)return!1;const s=e.x,i=t.x,o=r.x,a=e.y,c=t.y,l=r.y,u=s<i?s<o?s:o:i<o?i:o,h=a<c?a<l?a:l:c<l?c:l,d=s>i?s>o?s:o:i>o?i:o,p=a>c?a>l?a:l:c>l?c:l;let _=r.next;for(;_!==e;){if(_.x>=u&&_.x<=d&&_.y>=h&&_.y<=p&&Ba(s,a,i,c,o,l,_.x,_.y)&&Zt(_.prev,_,_.next)>=0)return!1;_=_.next}return!0}function IF(n,e,t,r){const s=n.prev,i=n,o=n.next;if(Zt(s,i,o)>=0)return!1;const a=s.x,c=i.x,l=o.x,u=s.y,h=i.y,d=o.y,p=a<c?a<l?a:l:c<l?c:l,_=u<h?u<d?u:d:h<d?h:d,g=a>c?a>l?a:l:c>l?c:l,f=u>h?u>d?u:d:h>d?h:d,m=g_(p,_,e,t,r),y=g_(g,f,e,t,r);let v=n.prevZ,b=n.nextZ;for(;v&&v.z>=m&&b&&b.z<=y;){if(v.x>=p&&v.x<=g&&v.y>=_&&v.y<=f&&v!==s&&v!==o&&Ba(a,u,c,h,l,d,v.x,v.y)&&Zt(v.prev,v,v.next)>=0||(v=v.prevZ,b.x>=p&&b.x<=g&&b.y>=_&&b.y<=f&&b!==s&&b!==o&&Ba(a,u,c,h,l,d,b.x,b.y)&&Zt(b.prev,b,b.next)>=0))return!1;b=b.nextZ}for(;v&&v.z>=m;){if(v.x>=p&&v.x<=g&&v.y>=_&&v.y<=f&&v!==s&&v!==o&&Ba(a,u,c,h,l,d,v.x,v.y)&&Zt(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;b&&b.z<=y;){if(b.x>=p&&b.x<=g&&b.y>=_&&b.y<=f&&b!==s&&b!==o&&Ba(a,u,c,h,l,d,b.x,b.y)&&Zt(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function DF(n,e,t){let r=n;do{const s=r.prev,i=r.next.next;!_p(s,i)&&aT(s,r,r.next,i)&&Fl(s,i)&&Fl(i,s)&&(e.push(s.i/t|0),e.push(r.i/t|0),e.push(i.i/t|0),Ul(r),Ul(r.next),r=n=i),r=r.next}while(r!==n);return Oo(r)}function LF(n,e,t,r,s,i){let o=n;do{let a=o.next.next;for(;a!==o.prev;){if(o.i!==a.i&&jF(o,a)){let c=cT(o,a);o=Oo(o,o.next),c=Oo(c,c.next),Ll(o,e,t,r,s,i,0),Ll(c,e,t,r,s,i,0);return}a=a.next}o=o.next}while(o!==n)}function FF(n,e,t,r){const s=[];let i,o,a,c,l;for(i=0,o=e.length;i<o;i++)a=e[i]*r,c=i<o-1?e[i+1]*r:n.length,l=oT(n,a,c,r,!1),l===l.next&&(l.steiner=!0),s.push(HF(l));for(s.sort(UF),i=0;i<s.length;i++)t=kF(s[i],t);return t}function UF(n,e){return n.x-e.x}function kF(n,e){const t=BF(n,e);if(!t)return e;const r=cT(t,n);return Oo(r,r.next),Oo(t,t.next)}function BF(n,e){let t=e,r=-1/0,s;const i=n.x,o=n.y;do{if(o<=t.y&&o>=t.next.y&&t.next.y!==t.y){const d=t.x+(o-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(d<=i&&d>r&&(r=d,s=t.x<t.next.x?t:t.next,d===i))return s}t=t.next}while(t!==e);if(!s)return null;const a=s,c=s.x,l=s.y;let u=1/0,h;t=s;do i>=t.x&&t.x>=c&&i!==t.x&&Ba(o<l?i:r,o,c,l,o<l?r:i,o,t.x,t.y)&&(h=Math.abs(o-t.y)/(i-t.x),Fl(t,n)&&(h<u||h===u&&(t.x>s.x||t.x===s.x&&GF(s,t)))&&(s=t,u=h)),t=t.next;while(t!==a);return s}function GF(n,e){return Zt(n.prev,n,e.prev)<0&&Zt(e.next,n,n.next)<0}function VF(n,e,t,r){let s=n;do s.z===0&&(s.z=g_(s.x,s.y,e,t,r)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==n);s.prevZ.nextZ=null,s.prevZ=null,zF(s)}function zF(n){let e,t,r,s,i,o,a,c,l=1;do{for(t=n,n=null,i=null,o=0;t;){for(o++,r=t,a=0,e=0;e<l&&(a++,r=r.nextZ,!!r);e++);for(c=l;a>0||c>0&&r;)a!==0&&(c===0||!r||t.z<=r.z)?(s=t,t=t.nextZ,a--):(s=r,r=r.nextZ,c--),i?i.nextZ=s:n=s,s.prevZ=i,i=s;t=r}i.nextZ=null,l*=2}while(o>1);return n}function g_(n,e,t,r,s){return n=(n-t)*s|0,e=(e-r)*s|0,n=(n|n<<8)&16711935,n=(n|n<<4)&252645135,n=(n|n<<2)&858993459,n=(n|n<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,n|e<<1}function HF(n){let e=n,t=n;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==n);return t}function Ba(n,e,t,r,s,i,o,a){return(s-o)*(e-a)>=(n-o)*(i-a)&&(n-o)*(r-a)>=(t-o)*(e-a)&&(t-o)*(i-a)>=(s-o)*(r-a)}function jF(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!WF(n,e)&&(Fl(n,e)&&Fl(e,n)&&XF(n,e)&&(Zt(n.prev,n,e.prev)||Zt(n,e.prev,e))||_p(n,e)&&Zt(n.prev,n,n.next)>0&&Zt(e.prev,e,e.next)>0)}function Zt(n,e,t){return(e.y-n.y)*(t.x-e.x)-(e.x-n.x)*(t.y-e.y)}function _p(n,e){return n.x===e.x&&n.y===e.y}function aT(n,e,t,r){const s=dh(Zt(n,e,t)),i=dh(Zt(n,e,r)),o=dh(Zt(t,r,n)),a=dh(Zt(t,r,e));return!!(s!==i&&o!==a||s===0&&hh(n,t,e)||i===0&&hh(n,r,e)||o===0&&hh(t,n,r)||a===0&&hh(t,e,r))}function hh(n,e,t){return e.x<=Math.max(n.x,t.x)&&e.x>=Math.min(n.x,t.x)&&e.y<=Math.max(n.y,t.y)&&e.y>=Math.min(n.y,t.y)}function dh(n){return n>0?1:n<0?-1:0}function WF(n,e){let t=n;do{if(t.i!==n.i&&t.next.i!==n.i&&t.i!==e.i&&t.next.i!==e.i&&aT(t,t.next,n,e))return!0;t=t.next}while(t!==n);return!1}function Fl(n,e){return Zt(n.prev,n,n.next)<0?Zt(n,e,n.next)>=0&&Zt(n,n.prev,e)>=0:Zt(n,e,n.prev)<0||Zt(n,n.next,e)<0}function XF(n,e){let t=n,r=!1;const s=(n.x+e.x)/2,i=(n.y+e.y)/2;do t.y>i!=t.next.y>i&&t.next.y!==t.y&&s<(t.next.x-t.x)*(i-t.y)/(t.next.y-t.y)+t.x&&(r=!r),t=t.next;while(t!==n);return r}function cT(n,e){const t=new v_(n.i,n.x,n.y),r=new v_(e.i,e.x,e.y),s=n.next,i=e.prev;return n.next=e,e.prev=n,t.next=s,s.prev=t,r.next=t,t.prev=r,i.next=r,r.prev=i,r}function Ux(n,e,t,r){const s=new v_(n,e,t);return r?(s.next=r.next,s.prev=r,r.next.prev=s,r.next=s):(s.prev=s,s.next=s),s}function Ul(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function v_(n,e,t){this.i=n,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function $F(n,e,t,r){let s=0;for(let i=e,o=t-r;i<t;i+=r)s+=(n[o]-n[i])*(n[i+1]+n[o+1]),o=i;return s}class Es{static area(e){const t=e.length;let r=0;for(let s=t-1,i=0;i<t;s=i++)r+=e[s].x*e[i].y-e[i].x*e[s].y;return r*.5}static isClockWise(e){return Es.area(e)<0}static triangulateShape(e,t){const r=[],s=[],i=[];kx(e),Bx(r,e);let o=e.length;t.forEach(kx);for(let c=0;c<t.length;c++)s.push(o),o+=t[c].length,Bx(r,t[c]);const a=PF.triangulate(r,s);for(let c=0;c<a.length;c+=3)i.push(a.slice(c,c+3));return i}}function kx(n){const e=n.length;e>2&&n[e-1].equals(n[0])&&n.pop()}function Bx(n,e){for(let t=0;t<e.length;t++)n.push(e[t].x),n.push(e[t].y)}class Yg extends sn{constructor(e=new Ka([new W(.5,.5),new W(-.5,.5),new W(-.5,-.5),new W(.5,-.5)]),t={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const r=this,s=[],i=[];for(let a=0,c=e.length;a<c;a++){const l=e[a];o(l)}this.setAttribute("position",new gt(s,3)),this.setAttribute("uv",new gt(i,2)),this.computeVertexNormals();function o(a){const c=[],l=t.curveSegments!==void 0?t.curveSegments:12,u=t.steps!==void 0?t.steps:1,h=t.depth!==void 0?t.depth:1;let d=t.bevelEnabled!==void 0?t.bevelEnabled:!0,p=t.bevelThickness!==void 0?t.bevelThickness:.2,_=t.bevelSize!==void 0?t.bevelSize:p-.1,g=t.bevelOffset!==void 0?t.bevelOffset:0,f=t.bevelSegments!==void 0?t.bevelSegments:3;const m=t.extrudePath,y=t.UVGenerator!==void 0?t.UVGenerator:qF;let v,b=!1,x,E,S,R;m&&(v=m.getSpacedPoints(u),b=!0,d=!1,x=m.computeFrenetFrames(u,!1),E=new T,S=new T,R=new T),d||(f=0,p=0,_=0,g=0);const C=a.extractPoints(l);let M=C.shape;const G=C.holes;if(!Es.isClockWise(M)){M=M.reverse();for(let L=0,oe=G.length;L<oe;L++){const H=G[L];Es.isClockWise(H)&&(G[L]=H.reverse())}}const X=Es.triangulateShape(M,G),N=M;for(let L=0,oe=G.length;L<oe;L++){const H=G[L];M=M.concat(H)}function j(L,oe,H){return oe||console.error("THREE.ExtrudeGeometry: vec does not exist"),L.clone().addScaledVector(oe,H)}const K=M.length,$=X.length;function q(L,oe,H){let Q,ee,ge;const z=L.x-oe.x,D=L.y-oe.y,ye=H.x-L.x,Ie=H.y-L.y,ot=z*z+D*D,U=z*Ie-D*ye;if(Math.abs(U)>Number.EPSILON){const w=Math.sqrt(ot),re=Math.sqrt(ye*ye+Ie*Ie),Se=oe.x-D/w,Ce=oe.y+z/w,Ae=H.x-Ie/re,Ve=H.y+ye/re,Re=((Ae-Se)*Ie-(Ve-Ce)*ye)/(z*Ie-D*ye);Q=Se+z*Re-L.x,ee=Ce+D*Re-L.y;const Ne=Q*Q+ee*ee;if(Ne<=2)return new W(Q,ee);ge=Math.sqrt(Ne/2)}else{let w=!1;z>Number.EPSILON?ye>Number.EPSILON&&(w=!0):z<-Number.EPSILON?ye<-Number.EPSILON&&(w=!0):Math.sign(D)===Math.sign(Ie)&&(w=!0),w?(Q=-D,ee=z,ge=Math.sqrt(ot)):(Q=z,ee=D,ge=Math.sqrt(ot/2))}return new W(Q/ge,ee/ge)}const ne=[];for(let L=0,oe=N.length,H=oe-1,Q=L+1;L<oe;L++,H++,Q++)H===oe&&(H=0),Q===oe&&(Q=0),ne[L]=q(N[L],N[H],N[Q]);const le=[];let ue,Ee=ne.concat();for(let L=0,oe=G.length;L<oe;L++){const H=G[L];ue=[];for(let Q=0,ee=H.length,ge=ee-1,z=Q+1;Q<ee;Q++,ge++,z++)ge===ee&&(ge=0),z===ee&&(z=0),ue[Q]=q(H[Q],H[ge],H[z]);le.push(ue),Ee=Ee.concat(ue)}for(let L=0;L<f;L++){const oe=L/f,H=p*Math.cos(oe*Math.PI/2),Q=_*Math.sin(oe*Math.PI/2)+g;for(let ee=0,ge=N.length;ee<ge;ee++){const z=j(N[ee],ne[ee],Q);O(z.x,z.y,-H)}for(let ee=0,ge=G.length;ee<ge;ee++){const z=G[ee];ue=le[ee];for(let D=0,ye=z.length;D<ye;D++){const Ie=j(z[D],ue[D],Q);O(Ie.x,Ie.y,-H)}}}const de=_+g;for(let L=0;L<K;L++){const oe=d?j(M[L],Ee[L],de):M[L];b?(S.copy(x.normals[0]).multiplyScalar(oe.x),E.copy(x.binormals[0]).multiplyScalar(oe.y),R.copy(v[0]).add(S).add(E),O(R.x,R.y,R.z)):O(oe.x,oe.y,0)}for(let L=1;L<=u;L++)for(let oe=0;oe<K;oe++){const H=d?j(M[oe],Ee[oe],de):M[oe];b?(S.copy(x.normals[L]).multiplyScalar(H.x),E.copy(x.binormals[L]).multiplyScalar(H.y),R.copy(v[L]).add(S).add(E),O(R.x,R.y,R.z)):O(H.x,H.y,h/u*L)}for(let L=f-1;L>=0;L--){const oe=L/f,H=p*Math.cos(oe*Math.PI/2),Q=_*Math.sin(oe*Math.PI/2)+g;for(let ee=0,ge=N.length;ee<ge;ee++){const z=j(N[ee],ne[ee],Q);O(z.x,z.y,h+H)}for(let ee=0,ge=G.length;ee<ge;ee++){const z=G[ee];ue=le[ee];for(let D=0,ye=z.length;D<ye;D++){const Ie=j(z[D],ue[D],Q);b?O(Ie.x,Ie.y+v[u-1].y,v[u-1].x+H):O(Ie.x,Ie.y,h+H)}}}V(),B();function V(){const L=s.length/3;if(d){let oe=0,H=K*oe;for(let Q=0;Q<$;Q++){const ee=X[Q];se(ee[2]+H,ee[1]+H,ee[0]+H)}oe=u+f*2,H=K*oe;for(let Q=0;Q<$;Q++){const ee=X[Q];se(ee[0]+H,ee[1]+H,ee[2]+H)}}else{for(let oe=0;oe<$;oe++){const H=X[oe];se(H[2],H[1],H[0])}for(let oe=0;oe<$;oe++){const H=X[oe];se(H[0]+K*u,H[1]+K*u,H[2]+K*u)}}r.addGroup(L,s.length/3-L,0)}function B(){const L=s.length/3;let oe=0;P(N,oe),oe+=N.length;for(let H=0,Q=G.length;H<Q;H++){const ee=G[H];P(ee,oe),oe+=ee.length}r.addGroup(L,s.length/3-L,1)}function P(L,oe){let H=L.length;for(;--H>=0;){const Q=H;let ee=H-1;ee<0&&(ee=L.length-1);for(let ge=0,z=u+f*2;ge<z;ge++){const D=K*ge,ye=K*(ge+1),Ie=oe+Q+D,ot=oe+ee+D,U=oe+ee+ye,w=oe+Q+ye;_e(Ie,ot,U,w)}}}function O(L,oe,H){c.push(L),c.push(oe),c.push(H)}function se(L,oe,H){Z(L),Z(oe),Z(H);const Q=s.length/3,ee=y.generateTopUV(r,s,Q-3,Q-2,Q-1);me(ee[0]),me(ee[1]),me(ee[2])}function _e(L,oe,H,Q){Z(L),Z(oe),Z(Q),Z(oe),Z(H),Z(Q);const ee=s.length/3,ge=y.generateSideWallUV(r,s,ee-6,ee-3,ee-2,ee-1);me(ge[0]),me(ge[1]),me(ge[3]),me(ge[1]),me(ge[2]),me(ge[3])}function Z(L){s.push(c[L*3+0]),s.push(c[L*3+1]),s.push(c[L*3+2])}function me(L){i.push(L.x),i.push(L.y)}}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON(),t=this.parameters.shapes,r=this.parameters.options;return YF(t,r,e)}static fromJSON(e,t){const r=[];for(let i=0,o=e.shapes.length;i<o;i++){const a=t[e.shapes[i]];r.push(a)}const s=e.options.extrudePath;return s!==void 0&&(e.options.extrudePath=new __[s.type]().fromJSON(s)),new Yg(r,e.options)}}const qF={generateTopUV:function(n,e,t,r,s){const i=e[t*3],o=e[t*3+1],a=e[r*3],c=e[r*3+1],l=e[s*3],u=e[s*3+1];return[new W(i,o),new W(a,c),new W(l,u)]},generateSideWallUV:function(n,e,t,r,s,i){const o=e[t*3],a=e[t*3+1],c=e[t*3+2],l=e[r*3],u=e[r*3+1],h=e[r*3+2],d=e[s*3],p=e[s*3+1],_=e[s*3+2],g=e[i*3],f=e[i*3+1],m=e[i*3+2];return Math.abs(a-u)<Math.abs(o-l)?[new W(o,1-c),new W(l,1-h),new W(d,1-_),new W(g,1-m)]:[new W(a,1-c),new W(u,1-h),new W(p,1-_),new W(f,1-m)]}};function YF(n,e,t){if(t.shapes=[],Array.isArray(n))for(let r=0,s=n.length;r<s;r++){const i=n[r];t.shapes.push(i.uuid)}else t.shapes.push(n.uuid);return t.options=Object.assign({},e),e.extrudePath!==void 0&&(t.options.extrudePath=e.extrudePath.toJSON()),t}class Kg extends sn{constructor(e=new Ka([new W(0,.5),new W(-.5,-.5),new W(.5,-.5)]),t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const r=[],s=[],i=[],o=[];let a=0,c=0;if(Array.isArray(e)===!1)l(e);else for(let u=0;u<e.length;u++)l(e[u]),this.addGroup(a,c,u),a+=c,c=0;this.setIndex(r),this.setAttribute("position",new gt(s,3)),this.setAttribute("normal",new gt(i,3)),this.setAttribute("uv",new gt(o,2));function l(u){const h=s.length/3,d=u.extractPoints(t);let p=d.shape;const _=d.holes;Es.isClockWise(p)===!1&&(p=p.reverse());for(let f=0,m=_.length;f<m;f++){const y=_[f];Es.isClockWise(y)===!0&&(_[f]=y.reverse())}const g=Es.triangulateShape(p,_);for(let f=0,m=_.length;f<m;f++){const y=_[f];p=p.concat(y)}for(let f=0,m=p.length;f<m;f++){const y=p[f];s.push(y.x,y.y,0),i.push(0,0,1),o.push(y.x,y.y)}for(let f=0,m=g.length;f<m;f++){const y=g[f],v=y[0]+h,b=y[1]+h,x=y[2]+h;r.push(v,b,x),c+=3}}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON(),t=this.parameters.shapes;return KF(t,e)}static fromJSON(e,t){const r=[];for(let s=0,i=e.shapes.length;s<i;s++){const o=t[e.shapes[s]];r.push(o)}return new Kg(r,e.curveSegments)}}function KF(n,e){if(e.shapes=[],Array.isArray(n))for(let t=0,r=n.length;t<r;t++){const s=n[t];e.shapes.push(s.uuid)}else e.shapes.push(n.uuid);return e}class lT extends gn{constructor(e){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new xe(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}}class Zg extends Kn{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class kl extends gn{constructor(e){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new xe(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new xe(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ti,this.normalScale=new W(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class gp extends kl{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new W(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return pn(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(t){this.ior=(1+.4*t)/(1-.4*t)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new xe(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new xe(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new xe(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class Jg extends gn{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new xe(16777215),this.specular=new xe(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new xe(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ti,this.normalScale=new W(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=_c,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class uT extends gn{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new xe(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new xe(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ti,this.normalScale=new W(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}class hT extends gn{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ti,this.normalScale=new W(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}class dT extends gn{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new xe(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new xe(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ti,this.normalScale=new W(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=_c,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class pT extends gn{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new xe(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=ti,this.normalScale=new W(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this.fog=e.fog,this}}class fT extends Cs{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}}class ZF{constructor(e,t,r,s){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=s!==void 0?s:new t.constructor(r),this.sampleValues=t,this.valueSize=r,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let r=this._cachedIndex,s=t[r],i=t[r-1];e:{t:{let o;n:{r:if(!(e<s)){for(let a=r+2;;){if(s===void 0){if(e<i)break r;return r=t.length,this._cachedIndex=r,this.copySampleValue_(r-1)}if(r===a)break;if(i=s,s=t[++r],e<s)break t}o=t.length;break n}if(!(e>=i)){const a=t[1];e<a&&(r=2,i=a);for(let c=r-2;;){if(i===void 0)return this._cachedIndex=0,this.copySampleValue_(0);if(r===c)break;if(s=i,i=t[--r-1],e>=i)break t}o=r,r=0;break n}break e}for(;r<o;){const a=r+o>>>1;e<t[a]?o=a:r=a+1}if(s=t[r],i=t[r-1],i===void 0)return this._cachedIndex=0,this.copySampleValue_(0);if(s===void 0)return r=t.length,this._cachedIndex=r,this.copySampleValue_(r-1)}this._cachedIndex=r,this.intervalChanged_(r,i,s)}return this.interpolate_(r,i,e,s)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,r=this.sampleValues,s=this.valueSize,i=e*s;for(let o=0;o!==s;++o)t[o]=r[i+o];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class JF extends ZF{constructor(e,t,r,s){super(e,t,r,s),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Fy,endingEnd:Fy}}intervalChanged_(e,t,r){const s=this.parameterPositions;let i=e-2,o=e+1,a=s[i],c=s[o];if(a===void 0)switch(this.getSettings_().endingStart){case Uy:i=e,a=2*t-r;break;case ky:i=s.length-2,a=t+s[i]-s[i+1];break;default:i=e,a=r}if(c===void 0)switch(this.getSettings_().endingEnd){case Uy:o=e,c=2*r-t;break;case ky:o=1,c=r+s[1]-s[0];break;default:o=e-1,c=t}const l=(r-t)*.5,u=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(c-r),this._offsetPrev=i*u,this._offsetNext=o*u}interpolate_(e,t,r,s){const i=this.resultBuffer,o=this.sampleValues,a=this.valueSize,c=e*a,l=c-a,u=this._offsetPrev,h=this._offsetNext,d=this._weightPrev,p=this._weightNext,_=(r-t)/(s-t),g=_*_,f=g*_,m=-d*f+2*d*g-d*_,y=(1+d)*f+(-1.5-2*d)*g+(-.5+d)*_+1,v=(-1-p)*f+(1.5+p)*g+.5*_,b=p*f-p*g;for(let x=0;x!==a;++x)i[x]=m*o[u+x]+y*o[l+x]+v*o[c+x]+b*o[h+x];return i}}const Gx={enabled:!1,files:{},add:function(n,e){this.enabled!==!1&&(this.files[n]=e)},get:function(n){if(this.enabled!==!1)return this.files[n]},remove:function(n){delete this.files[n]},clear:function(){this.files={}}};class mT{constructor(e,t,r){const s=this;let i=!1,o=0,a=0,c;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(u){a++,i===!1&&s.onStart!==void 0&&s.onStart(u,o,a),i=!0},this.itemEnd=function(u){o++,s.onProgress!==void 0&&s.onProgress(u,o,a),o===a&&(i=!1,s.onLoad!==void 0&&s.onLoad())},this.itemError=function(u){s.onError!==void 0&&s.onError(u)},this.resolveURL=function(u){return c?c(u):u},this.setURLModifier=function(u){return c=u,this},this.addHandler=function(u,h){return l.push(u,h),this},this.removeHandler=function(u){const h=l.indexOf(u);return h!==-1&&l.splice(h,2),this},this.getHandler=function(u){for(let h=0,d=l.length;h<d;h+=2){const p=l[h],_=l[h+1];if(p.global&&(p.lastIndex=0),p.test(u))return _}return null}}}const QF=new mT;class ko{constructor(e){this.manager=e!==void 0?e:QF,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const r=this;return new Promise(function(s,i){r.load(e,s,t,i)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}ko.DEFAULT_MATERIAL_NAME="__DEFAULT";const Us={};class eU extends Error{constructor(e,t){super(e),this.response=t}}class vu extends ko{constructor(e){super(e)}load(e,t,r,s){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const i=Gx.get(e);if(i!==void 0)return this.manager.itemStart(e),setTimeout(()=>{t&&t(i),this.manager.itemEnd(e)},0),i;if(Us[e]!==void 0){Us[e].push({onLoad:t,onProgress:r,onError:s});return}Us[e]=[],Us[e].push({onLoad:t,onProgress:r,onError:s});const o=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,c=this.responseType;fetch(o).then(l=>{if(l.status===200||l.status===0){if(l.status===0&&console.warn("THREE.FileLoader: HTTP Status 0 received."),typeof ReadableStream>"u"||l.body===void 0||l.body.getReader===void 0)return l;const u=Us[e],h=l.body.getReader(),d=l.headers.get("Content-Length")||l.headers.get("X-File-Size"),p=d?parseInt(d):0,_=p!==0;let g=0;const f=new ReadableStream({start(m){y();function y(){h.read().then(({done:v,value:b})=>{if(v)m.close();else{g+=b.byteLength;const x=new ProgressEvent("progress",{lengthComputable:_,loaded:g,total:p});for(let E=0,S=u.length;E<S;E++){const R=u[E];R.onProgress&&R.onProgress(x)}m.enqueue(b),y()}})}}});return new Response(f)}else throw new eU(`fetch for "${l.url}" responded with ${l.status}: ${l.statusText}`,l)}).then(l=>{switch(c){case"arraybuffer":return l.arrayBuffer();case"blob":return l.blob();case"document":return l.text().then(u=>new DOMParser().parseFromString(u,a));case"json":return l.json();default:if(a===void 0)return l.text();{const h=/charset="?([^;"\s]*)"?/i.exec(a),d=h&&h[1]?h[1].toLowerCase():void 0,p=new TextDecoder(d);return l.arrayBuffer().then(_=>p.decode(_))}}}).then(l=>{Gx.add(e,l);const u=Us[e];delete Us[e];for(let h=0,d=u.length;h<d;h++){const p=u[h];p.onLoad&&p.onLoad(l)}}).catch(l=>{const u=Us[e];if(u===void 0)throw this.manager.itemError(e),l;delete Us[e];for(let h=0,d=u.length;h<d;h++){const p=u[h];p.onError&&p.onError(l)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Qg extends wt{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new xe(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,this.groundColor!==void 0&&(t.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(t.object.distance=this.distance),this.angle!==void 0&&(t.object.angle=this.angle),this.decay!==void 0&&(t.object.decay=this.decay),this.penumbra!==void 0&&(t.object.penumbra=this.penumbra),this.shadow!==void 0&&(t.object.shadow=this.shadow.toJSON()),t}}class Vx extends Qg{constructor(e,t,r){super(e,r),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(wt.DEFAULT_UP),this.updateMatrix(),this.groundColor=new xe(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}}const Uf=new qe,zx=new T,Hx=new T;class tU{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new W(512,512),this.map=null,this.mapPass=null,this.matrix=new qe,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Ug,this._frameExtents=new W(1,1),this._viewportCount=1,this._viewports=[new We(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,r=this.matrix;zx.setFromMatrixPosition(e.matrixWorld),t.position.copy(zx),Hx.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(Hx),t.updateMatrixWorld(),Uf.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Uf),r.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),r.multiply(Uf)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const e={};return this.bias!==0&&(e.bias=this.bias),this.normalBias!==0&&(e.normalBias=this.normalBias),this.radius!==1&&(e.radius=this.radius),(this.mapSize.x!==512||this.mapSize.y!==512)&&(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class nU extends tU{constructor(){super(new Un(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){const t=this.camera,r=rc*2*e.angle*this.focus,s=this.mapSize.width/this.mapSize.height,i=e.distance||t.far;(r!==t.fov||s!==t.aspect||i!==t.far)&&(t.fov=r,t.aspect=s,t.far=i,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class jx extends Qg{constructor(e,t,r=0,s=Math.PI/3,i=0,o=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(wt.DEFAULT_UP),this.updateMatrix(),this.target=new wt,this.distance=r,this.angle=s,this.penumbra=i,this.decay=o,this.map=null,this.shadow=new nU}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class Wx extends Qg{constructor(e,t,r=10,s=10){super(e,t),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=r,this.height=s}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}class ev extends ko{constructor(e){super(e),this.textures={}}load(e,t,r,s){const i=this,o=new vu(i.manager);o.setPath(i.path),o.setRequestHeader(i.requestHeader),o.setWithCredentials(i.withCredentials),o.load(e,function(a){try{t(i.parse(JSON.parse(a)))}catch(c){s?s(c):console.error(c),i.manager.itemError(e)}},r,s)}parse(e){const t=this.textures;function r(i){return t[i]===void 0&&console.warn("THREE.MaterialLoader: Undefined texture",i),t[i]}const s=ev.createMaterialFromType(e.type);if(e.uuid!==void 0&&(s.uuid=e.uuid),e.name!==void 0&&(s.name=e.name),e.color!==void 0&&s.color!==void 0&&s.color.setHex(e.color),e.roughness!==void 0&&(s.roughness=e.roughness),e.metalness!==void 0&&(s.metalness=e.metalness),e.sheen!==void 0&&(s.sheen=e.sheen),e.sheenColor!==void 0&&(s.sheenColor=new xe().setHex(e.sheenColor)),e.sheenRoughness!==void 0&&(s.sheenRoughness=e.sheenRoughness),e.emissive!==void 0&&s.emissive!==void 0&&s.emissive.setHex(e.emissive),e.specular!==void 0&&s.specular!==void 0&&s.specular.setHex(e.specular),e.specularIntensity!==void 0&&(s.specularIntensity=e.specularIntensity),e.specularColor!==void 0&&s.specularColor!==void 0&&s.specularColor.setHex(e.specularColor),e.shininess!==void 0&&(s.shininess=e.shininess),e.clearcoat!==void 0&&(s.clearcoat=e.clearcoat),e.clearcoatRoughness!==void 0&&(s.clearcoatRoughness=e.clearcoatRoughness),e.iridescence!==void 0&&(s.iridescence=e.iridescence),e.iridescenceIOR!==void 0&&(s.iridescenceIOR=e.iridescenceIOR),e.iridescenceThicknessRange!==void 0&&(s.iridescenceThicknessRange=e.iridescenceThicknessRange),e.transmission!==void 0&&(s.transmission=e.transmission),e.thickness!==void 0&&(s.thickness=e.thickness),e.attenuationDistance!==void 0&&(s.attenuationDistance=e.attenuationDistance),e.attenuationColor!==void 0&&s.attenuationColor!==void 0&&s.attenuationColor.setHex(e.attenuationColor),e.anisotropy!==void 0&&(s.anisotropy=e.anisotropy),e.anisotropyRotation!==void 0&&(s.anisotropyRotation=e.anisotropyRotation),e.fog!==void 0&&(s.fog=e.fog),e.flatShading!==void 0&&(s.flatShading=e.flatShading),e.blending!==void 0&&(s.blending=e.blending),e.combine!==void 0&&(s.combine=e.combine),e.side!==void 0&&(s.side=e.side),e.shadowSide!==void 0&&(s.shadowSide=e.shadowSide),e.opacity!==void 0&&(s.opacity=e.opacity),e.transparent!==void 0&&(s.transparent=e.transparent),e.alphaTest!==void 0&&(s.alphaTest=e.alphaTest),e.alphaHash!==void 0&&(s.alphaHash=e.alphaHash),e.depthFunc!==void 0&&(s.depthFunc=e.depthFunc),e.depthTest!==void 0&&(s.depthTest=e.depthTest),e.depthWrite!==void 0&&(s.depthWrite=e.depthWrite),e.colorWrite!==void 0&&(s.colorWrite=e.colorWrite),e.blendSrc!==void 0&&(s.blendSrc=e.blendSrc),e.blendDst!==void 0&&(s.blendDst=e.blendDst),e.blendEquation!==void 0&&(s.blendEquation=e.blendEquation),e.blendSrcAlpha!==void 0&&(s.blendSrcAlpha=e.blendSrcAlpha),e.blendDstAlpha!==void 0&&(s.blendDstAlpha=e.blendDstAlpha),e.blendEquationAlpha!==void 0&&(s.blendEquationAlpha=e.blendEquationAlpha),e.blendColor!==void 0&&s.blendColor!==void 0&&s.blendColor.setHex(e.blendColor),e.blendAlpha!==void 0&&(s.blendAlpha=e.blendAlpha),e.stencilWriteMask!==void 0&&(s.stencilWriteMask=e.stencilWriteMask),e.stencilFunc!==void 0&&(s.stencilFunc=e.stencilFunc),e.stencilRef!==void 0&&(s.stencilRef=e.stencilRef),e.stencilFuncMask!==void 0&&(s.stencilFuncMask=e.stencilFuncMask),e.stencilFail!==void 0&&(s.stencilFail=e.stencilFail),e.stencilZFail!==void 0&&(s.stencilZFail=e.stencilZFail),e.stencilZPass!==void 0&&(s.stencilZPass=e.stencilZPass),e.stencilWrite!==void 0&&(s.stencilWrite=e.stencilWrite),e.wireframe!==void 0&&(s.wireframe=e.wireframe),e.wireframeLinewidth!==void 0&&(s.wireframeLinewidth=e.wireframeLinewidth),e.wireframeLinecap!==void 0&&(s.wireframeLinecap=e.wireframeLinecap),e.wireframeLinejoin!==void 0&&(s.wireframeLinejoin=e.wireframeLinejoin),e.rotation!==void 0&&(s.rotation=e.rotation),e.linewidth!==void 0&&(s.linewidth=e.linewidth),e.dashSize!==void 0&&(s.dashSize=e.dashSize),e.gapSize!==void 0&&(s.gapSize=e.gapSize),e.scale!==void 0&&(s.scale=e.scale),e.polygonOffset!==void 0&&(s.polygonOffset=e.polygonOffset),e.polygonOffsetFactor!==void 0&&(s.polygonOffsetFactor=e.polygonOffsetFactor),e.polygonOffsetUnits!==void 0&&(s.polygonOffsetUnits=e.polygonOffsetUnits),e.dithering!==void 0&&(s.dithering=e.dithering),e.alphaToCoverage!==void 0&&(s.alphaToCoverage=e.alphaToCoverage),e.premultipliedAlpha!==void 0&&(s.premultipliedAlpha=e.premultipliedAlpha),e.forceSinglePass!==void 0&&(s.forceSinglePass=e.forceSinglePass),e.visible!==void 0&&(s.visible=e.visible),e.toneMapped!==void 0&&(s.toneMapped=e.toneMapped),e.userData!==void 0&&(s.userData=e.userData),e.vertexColors!==void 0&&(typeof e.vertexColors=="number"?s.vertexColors=e.vertexColors>0:s.vertexColors=e.vertexColors),e.uniforms!==void 0)for(const i in e.uniforms){const o=e.uniforms[i];switch(s.uniforms[i]={},o.type){case"t":s.uniforms[i].value=r(o.value);break;case"c":s.uniforms[i].value=new xe().setHex(o.value);break;case"v2":s.uniforms[i].value=new W().fromArray(o.value);break;case"v3":s.uniforms[i].value=new T().fromArray(o.value);break;case"v4":s.uniforms[i].value=new We().fromArray(o.value);break;case"m3":s.uniforms[i].value=new nt().fromArray(o.value);break;case"m4":s.uniforms[i].value=new qe().fromArray(o.value);break;default:s.uniforms[i].value=o.value}}if(e.defines!==void 0&&(s.defines=e.defines),e.vertexShader!==void 0&&(s.vertexShader=e.vertexShader),e.fragmentShader!==void 0&&(s.fragmentShader=e.fragmentShader),e.glslVersion!==void 0&&(s.glslVersion=e.glslVersion),e.extensions!==void 0)for(const i in e.extensions)s.extensions[i]=e.extensions[i];if(e.lights!==void 0&&(s.lights=e.lights),e.clipping!==void 0&&(s.clipping=e.clipping),e.size!==void 0&&(s.size=e.size),e.sizeAttenuation!==void 0&&(s.sizeAttenuation=e.sizeAttenuation),e.map!==void 0&&(s.map=r(e.map)),e.matcap!==void 0&&(s.matcap=r(e.matcap)),e.alphaMap!==void 0&&(s.alphaMap=r(e.alphaMap)),e.bumpMap!==void 0&&(s.bumpMap=r(e.bumpMap)),e.bumpScale!==void 0&&(s.bumpScale=e.bumpScale),e.normalMap!==void 0&&(s.normalMap=r(e.normalMap)),e.normalMapType!==void 0&&(s.normalMapType=e.normalMapType),e.normalScale!==void 0){let i=e.normalScale;Array.isArray(i)===!1&&(i=[i,i]),s.normalScale=new W().fromArray(i)}return e.displacementMap!==void 0&&(s.displacementMap=r(e.displacementMap)),e.displacementScale!==void 0&&(s.displacementScale=e.displacementScale),e.displacementBias!==void 0&&(s.displacementBias=e.displacementBias),e.roughnessMap!==void 0&&(s.roughnessMap=r(e.roughnessMap)),e.metalnessMap!==void 0&&(s.metalnessMap=r(e.metalnessMap)),e.emissiveMap!==void 0&&(s.emissiveMap=r(e.emissiveMap)),e.emissiveIntensity!==void 0&&(s.emissiveIntensity=e.emissiveIntensity),e.specularMap!==void 0&&(s.specularMap=r(e.specularMap)),e.specularIntensityMap!==void 0&&(s.specularIntensityMap=r(e.specularIntensityMap)),e.specularColorMap!==void 0&&(s.specularColorMap=r(e.specularColorMap)),e.envMap!==void 0&&(s.envMap=r(e.envMap)),e.envMapIntensity!==void 0&&(s.envMapIntensity=e.envMapIntensity),e.reflectivity!==void 0&&(s.reflectivity=e.reflectivity),e.refractionRatio!==void 0&&(s.refractionRatio=e.refractionRatio),e.lightMap!==void 0&&(s.lightMap=r(e.lightMap)),e.lightMapIntensity!==void 0&&(s.lightMapIntensity=e.lightMapIntensity),e.aoMap!==void 0&&(s.aoMap=r(e.aoMap)),e.aoMapIntensity!==void 0&&(s.aoMapIntensity=e.aoMapIntensity),e.gradientMap!==void 0&&(s.gradientMap=r(e.gradientMap)),e.clearcoatMap!==void 0&&(s.clearcoatMap=r(e.clearcoatMap)),e.clearcoatRoughnessMap!==void 0&&(s.clearcoatRoughnessMap=r(e.clearcoatRoughnessMap)),e.clearcoatNormalMap!==void 0&&(s.clearcoatNormalMap=r(e.clearcoatNormalMap)),e.clearcoatNormalScale!==void 0&&(s.clearcoatNormalScale=new W().fromArray(e.clearcoatNormalScale)),e.iridescenceMap!==void 0&&(s.iridescenceMap=r(e.iridescenceMap)),e.iridescenceThicknessMap!==void 0&&(s.iridescenceThicknessMap=r(e.iridescenceThicknessMap)),e.transmissionMap!==void 0&&(s.transmissionMap=r(e.transmissionMap)),e.thicknessMap!==void 0&&(s.thicknessMap=r(e.thicknessMap)),e.anisotropyMap!==void 0&&(s.anisotropyMap=r(e.anisotropyMap)),e.sheenColorMap!==void 0&&(s.sheenColorMap=r(e.sheenColorMap)),e.sheenRoughnessMap!==void 0&&(s.sheenRoughnessMap=r(e.sheenRoughnessMap)),s}setTextures(e){return this.textures=e,this}static createMaterialFromType(e){const t={ShadowMaterial:lT,SpriteMaterial:tT,RawShaderMaterial:Zg,ShaderMaterial:Kn,PointsMaterial:Pi,MeshPhysicalMaterial:gp,MeshStandardMaterial:kl,MeshPhongMaterial:Jg,MeshToonMaterial:uT,MeshNormalMaterial:hT,MeshLambertMaterial:dT,MeshDepthMaterial:Vg,MeshDistanceMaterial:zg,MeshBasicMaterial:_u,MeshMatcapMaterial:pT,LineDashedMaterial:fT,LineBasicMaterial:Cs,Material:gn};return new t[e]}}class rU{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=Xx(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=Xx();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}function Xx(){return(typeof performance>"u"?Date:performance).now()}class _T{constructor(e,t,r=0,s=1/0){this.ray=new ni(e,t),this.near=r,this.far=s,this.camera=null,this.layers=new Fg,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}intersectObject(e,t=!0,r=[]){return y_(e,this,r,t),r.sort($x),r}intersectObjects(e,t=!0,r=[]){for(let s=0,i=e.length;s<i;s++)y_(e[s],this,r,t);return r.sort($x),r}}function $x(n,e){return n.distance-e.distance}function y_(n,e,t,r){if(n.layers.test(e.layers)&&n.raycast(e,t),r===!0){const s=n.children;for(let i=0,o=s.length;i<o;i++)y_(s[i],e,t,!0)}}class qx{constructor(e=1,t=0,r=0){return this.radius=e,this.phi=t,this.theta=r,this}set(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,r){return this.radius=Math.sqrt(e*e+t*t+r*r),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,r),this.phi=Math.acos(pn(t/this.radius,-1,1))),this}clone(){return new this.constructor().copy(this)}}const Yx=new W;class sU{constructor(e=new W(1/0,1/0),t=new W(-1/0,-1/0)){this.isBox2=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromPoints(e){this.makeEmpty();for(let t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const r=Yx.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,Yx).distanceTo(e)}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const Kx=new T,ph=new T;class qs{constructor(e=new T,t=new T){this.start=e,this.end=t}set(e,t){return this.start.copy(e),this.end.copy(t),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t){return this.delta(t).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t){Kx.subVectors(e,this.start),ph.subVectors(this.end,this.start);const r=ph.dot(ph);let i=ph.dot(Kx)/r;return t&&(i=pn(i,0,1)),i}closestPointToPoint(e,t,r){const s=this.closestPointToPointParameter(e,t);return this.delta(r).multiplyScalar(s).add(this.start)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return new this.constructor().copy(this)}}class xi{constructor(){this.type="ShapePath",this.color=new xe,this.subPaths=[],this.currentPath=null}moveTo(e,t){return this.currentPath=new Ya,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t),this}lineTo(e,t){return this.currentPath.lineTo(e,t),this}quadraticCurveTo(e,t,r,s){return this.currentPath.quadraticCurveTo(e,t,r,s),this}bezierCurveTo(e,t,r,s,i,o){return this.currentPath.bezierCurveTo(e,t,r,s,i,o),this}splineThru(e){return this.currentPath.splineThru(e),this}toShapes(e){function t(m){const y=[];for(let v=0,b=m.length;v<b;v++){const x=m[v],E=new Ka;E.curves=x.curves,y.push(E)}return y}function r(m,y){const v=y.length;let b=!1;for(let x=v-1,E=0;E<v;x=E++){let S=y[x],R=y[E],C=R.x-S.x,M=R.y-S.y;if(Math.abs(M)>Number.EPSILON){if(M<0&&(S=y[E],C=-C,R=y[x],M=-M),m.y<S.y||m.y>R.y)continue;if(m.y===S.y){if(m.x===S.x)return!0}else{const G=M*(m.x-S.x)-C*(m.y-S.y);if(G===0)return!0;if(G<0)continue;b=!b}}else{if(m.y!==S.y)continue;if(R.x<=m.x&&m.x<=S.x||S.x<=m.x&&m.x<=R.x)return!0}}return b}const s=Es.isClockWise,i=this.subPaths;if(i.length===0)return[];let o,a,c;const l=[];if(i.length===1)return a=i[0],c=new Ka,c.curves=a.curves,l.push(c),l;let u=!s(i[0].getPoints());u=e?!u:u;const h=[],d=[];let p=[],_=0,g;d[_]=void 0,p[_]=[];for(let m=0,y=i.length;m<y;m++)a=i[m],g=a.getPoints(),o=s(g),o=e?!o:o,o?(!u&&d[_]&&_++,d[_]={s:new Ka,p:g},d[_].s.curves=a.curves,u&&_++,p[_]=[]):p[_].push({h:a,p:g[0]});if(!d[0])return t(i);if(d.length>1){let m=!1,y=0;for(let v=0,b=d.length;v<b;v++)h[v]=[];for(let v=0,b=d.length;v<b;v++){const x=p[v];for(let E=0;E<x.length;E++){const S=x[E];let R=!0;for(let C=0;C<d.length;C++)r(S.p,d[C].p)&&(v!==C&&y++,R?(R=!1,h[C].push(S)):m=!0);R&&h[v].push(S)}}y>0&&m===!1&&(p=h)}let f;for(let m=0,y=d.length;m<y;m++){c=d[m].s,l.push(c),f=p[m];for(let v=0,b=f.length;v<b;v++)c.holes.push(f[v].h)}return l}}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:wg}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=wg);const kf=[],Bf=[];class gT{constructor(e=""){this._path=e,this._graphNode=null}graphNode(){return this._graphNode}_setGraphNode(e){this._graphNode=e}path(){return this._path}setPath(e){this._path=e}clone(){const e=new this.constructor(this._path);return e._setGraphNode(this._graphNode),e}}class Zr extends gT{setNode(e){this._graphNode=e}node(){return this._graphNode}graphNodePath(){var e;return(e=this.node())==null?void 0:e.path()}resolve(e,t){this._graphNode=bt.findNode(e,this._path,t)}nodeWithContext(e,t){const r=this.node();if(!r){t==null||t.set(`no node found at ${this.path()}`);return}const s=r.context();if(s==e)return r;t==null||t.set(`expected ${e} node, but got a ${s}`)}}class vp extends gT{setParam(e){this._graphNode=e}param(){return this._graphNode}graphNodePath(){var e;return(e=this.param())==null?void 0:e.path()}resolve(e,t){this._graphNode=bt.findParam(e,this._path,t)}paramWithType(e,t){const r=this.param();if(!r){t==null||t.set(`no param found at ${this.path()}`);return}if(r.type()==e)return r;t==null||t.set(`expected ${e} node, but got a ${r.type()}`)}}const At=class{static splitParentChild(n){const e=n.split(At.SEPARATOR).filter(s=>s.length>0),t=e.pop();return{parent:e.join(At.SEPARATOR),child:t}}static findNode(n,e,t){if(!n)return null;const r=e.split(At.SEPARATOR).filter(o=>o.length>0),s=r[0];let i=null;if(e[0]===At.SEPARATOR){const o=e.substring(1);i=this.findNode(n.root(),o,t)}else{switch(s){case At.PARENT:i=n.parent(),i&&(t==null||t.addPathElement({path:s,node:i}));break;case At.CURRENT:i=n,t==null||t.addPathElement({path:s,node:i});break;default:i=n.node(s),i&&(t==null||t.addNamedNode({name:s,node:i}))}if(i!=null&&r.length>1){const o=r.slice(1).join(At.SEPARATOR);i=this.findNode(i,o,t)}return i}return i}static findParam(n,e,t){if(!n)return null;const r=e.split(At.SEPARATOR);if(r.length===1)return n.params.get(r[0]);{let s=null;if(e[0]===At.SEPARATOR&&r.length==2)s=n.root();else{const i=r.slice(0,+(r.length-2)+1||void 0).join(At.SEPARATOR);s=this.findNode(n,i,t)}if(s!=null){const i=r[r.length-1],o=s.params.get(i);return t&&o&&t.addNamedNode({name:i,node:o}),o}else return null}}static relativePath(n,e){const t=this.closestCommonParent(n,e);if(t){const r=this.distanceToParent(n,t);let s="";if(r>0){let l=0;for(Bf.length=0;l++<r;)Bf.push(At.PARENT);s=Bf.join(At.SEPARATOR)+At.SEPARATOR}const i=t.path().split(At.SEPARATOR).filter(l=>l.length>0),o=e.path().split(At.SEPARATOR).filter(l=>l.length>0);kf.length=0;let a=0;for(const l of o)i[a]||kf.push(l),a++;const c=kf.join(At.SEPARATOR);return this.sanitizePath(`${s}${c}`)}else return e.path()}static sanitizePath(n){return n.replace(/\/\//g,"/")}static closestCommonParent(n,e){const t=this.parents(n).reverse().concat([n]),r=this.parents(e).reverse().concat([e]),s=Math.min(t.length,r.length);let i=null;for(let o=0;o<s;o++)t[o].graphNodeId()==r[o].graphNodeId()&&(i=t[o]);return i}static parents(n){const e=[];let t=n.parent();for(;t;)e.push(t),t=t.parent();return e}static distanceToParent(n,e){let t=0,r=n;const s=e.graphNodeId();for(;r&&r.graphNodeId()!=s;)t+=1,r=r.parent();return r&&r.graphNodeId()==s?t:-1}static makeAbsolutePath(n,e){if(e[0]==At.SEPARATOR)return e;const t=e.split(At.SEPARATOR),r=t.shift();if(r)switch(r){case"..":{const s=n.parent();return s?s==n.scene().root()?At.SEPARATOR+t.join(At.SEPARATOR):this.makeAbsolutePath(s,t.join(At.SEPARATOR)):null}case".":return this.makeAbsolutePath(n,t.join(At.SEPARATOR));default:return[n.path(),e].join(At.SEPARATOR)}else return n.path()}};let bt=At;bt.SEPARATOR="/";bt.DOT=".";bt.CURRENT=At.DOT;bt.PARENT="..";bt.CURRENT_WITH_SLASH=`${At.CURRENT}/`;bt.PARENT_WITH_SLASH=`${At.PARENT}/`;bt.NON_LETTER_PREFIXES=[At.SEPARATOR,At.DOT];var vT=(n=>(n.HIGH="high-performance",n.LOW="low-power",n.DEFAULT="default",n))(vT||{});const x_=["high-performance","low-power","default"];var yT=(n=>(n.HIGH="highp",n.MEDIUM="mediump",n.LOW="lowp",n))(yT||{});const b_=["highp","mediump","lowp"],C_={alpha:!0,precision:"highp",premultipliedAlpha:!0,antialias:!0,preserveDrawingBuffer:!1,powerPreference:"default",depth:!0,stencil:!0,logarithmicDepthBuffer:!1},Zx={};let iU=0;const xT=class{constructor(n){this.poly=n,this._printDebug=!1,this._requireWebGL2=!1,this._webGLContextByCanvas=new Map,this._defaultRendererByCanvas=new Map}dispose(){this._webGLContextByCanvas.clear(),this._defaultRendererByCanvas.forEach(n=>{n.dispose()}),this._defaultRendererByCanvas.clear()}setPrintDebug(n=!0){this._printDebug=n}printDebug(){return this._printDebug}printDebugMessage(n){this._printDebug&&console.warn("[Poly debug]",n)}setRequireWebGL2(){this._requireWebGL2||(this._requireWebGL2=!0)}webGL2Available(n){return this._webgl2_available===void 0&&(this._webgl2_available=this._getWebGL2Available(n)),this._webgl2_available}_getWebGL2Available(n){return n=n||this.poly.canvasRegister.dummyCanvas(),(globalThis.WebGL2RenderingContext&&n.getContext("webgl2"))!=null}defaultWebGLRendererForCanvas(n){let e=this._defaultRendererByCanvas.get(n);if(!e){const t=this.getRenderingContext(n);e=this.createWebGLRenderer({...C_,canvas:n,context:t}),this._defaultRendererByCanvas.set(n,e)}return e}createWebGLRenderer(n){const e=new bs(n);return n.canvas!=null&&n.canvas instanceof HTMLCanvasElement?this.poly.canvasRegister.registerCanvas(n.canvas,e):(console.warn("canvas not registerable"),console.log(n.canvas)),this.assignIdToRenderer(e),this.printDebugMessage(["create renderer:",n]),e}assignIdToRenderer(n){if(n._polygonId!=null)return;const e=iU+=1;n._polygonId=e}rendererId(n){const e=n._polygonId;if(e==null){console.error("renderer has no _polygonId");return}return e}getRenderingContext(n){let e=this._webGLContextByCanvas.get(n);return e||(e=this._getRenderingContextWebgl(n,!0),e||console.warn("failed to create webgl2 context"),e||(e=this._getRenderingContextWebgl(n,!1)),e?(e._polygonjsContextId==null&&(e._polygonjsContextId=xT._nextGlContextId++),this._webGLContextByCanvas.set(n,e),e):(console.error("failed to create webgl context"),null))}_getRenderingContextWebgl(n,e){let t;this.webGL2Available(n)?t="webgl2":t=e?"webgl2":"webgl";let r=n.getContext(t,Zx);return r?this.printDebugMessage(`create gl context: ${t}.`):(t=e?"experimental-webgl2":"experimental-webgl",this.printDebugMessage(`create gl context: ${t}.`),r=n.getContext(t,Zx)),r}createRenderTarget(n,e,t){if(this.webGL2Available()){const r=new Br(n,e,t);return r.samples=2,r}else return new Br(n,e,t)}linearRenderer(){return this._linearRenderer=this._linearRenderer||this._createLinearRenderer()}_createLinearRenderer(){const n=this.poly.canvasRegister.findOrCreateCanvas(),e=this.getRenderingContext(n);if(!e)return;const t=this.createWebGLRenderer({alpha:!0,premultipliedAlpha:!0,canvas:n,context:e});return this.poly.canvasRegister.registerCanvas(n,t),t.outputColorSpace=xn,t.toneMapping=Fr,t}};let bT=xT;bT._nextGlContextId=0;class oU{constructor(e){this.poly=e,this._rendererByCanvas=new Map}findOrCreateCanvas(){return this._findAvailableCanvas()||this._createCanvas()}_findAvailableCanvas(){let e;return this._rendererByCanvas.forEach((t,r)=>{e==null&&t==null&&(e=r)}),e}_createCanvas(){return document.createElement("canvas")}registerCanvas(e,t){this._rendererByCanvas.set(e,t)}deregisterCanvas(e){this._rendererByCanvas.set(e,null)}dummyCanvas(){return this._dummyCanvas||(this._dummyCanvas=document.createElement("canvas"))}}class aU{constructor(){this._rootPrefix="",this._root="/three/js/libs",this._KTX2Path="/ktx2",this._DRACOPath="/draco",this._DRACOGLTFPath="/draco/gltf",this._XATLASPath="/xatlas",this._OCCTPath="/occt",this._ManifoldPath="/manifold"}root(){if(this._root)if(this._rootPrefix.length>0){const e=this._root.replace(/^(\.)/,"");return`${this._rootPrefix}${e}`}else return this._root}setRoot(e){this._root=e}setRootPrefix(e){this._rootPrefix=e}KTX2Path(){return this._KTX2Path}DRACOPath(){return this._DRACOPath}DRACOGLTFPath(){return this._DRACOGLTFPath}XATLASPath(){return this._XATLASPath}OCCTPath(){return this._OCCTPath}ManifoldPath(){return this._ManifoldPath}}class cU{constructor(e){this.poly=e}recording(){return!this.poly.playerMode()}clear(){}clearBlobsForNode(e){}async setVirtualFile(e,t){}async fetchBlobGlobal(e){}traverse(e){}}class lU{setMap(e){this._map=e}remapedUrl(e){if(!this._map)return;const t=e.split("?"),r=t[0],s=t[1],i=this._map[r];if(i)return s?`${i}?${s}`:i}}class uU{setPerformanceManager(e){this._performanceManager=e}performanceManager(){return this._performanceManager||globalThis.performance}}class hU{constructor(){this._scenes=new Set,this._registerTimeByScene=new Map}registerScene(e){if(this._scenes.has(e)){console.warn("scene was already registered");return}this._scenes.add(e),this._registerTimeByScene.set(e,performance.now()),this._updateCache()}deregisterScene(e){this._scenes.delete(e),this._registerTimeByScene.delete(e),this._updateCache()}dispose(){const e=this.scenes();for(const t of e)t.dispose()}lastRegisteredScene(){return this._lastRegisteredScene}scenes(){const e=[];return this._scenes.forEach(t=>e.push(t)),e}_updateCache(){this._lastRegisteredScene=void 0,this._registerTimeByScene.forEach((e,t)=>{if(this._lastRegisteredScene==null)this._lastRegisteredScene=t;else{const r=this._registerTimeByScene.get(this._lastRegisteredScene);e!=null&&r!=null&&e>r&&(this._lastRegisteredScene=t)}})}}class dU{setToken(e){this._token=e}setGetTokenFunction(e){this._getTokenFunc=e}async token(){if(this._token)return this._token;if(this._getTokenFunc)return await this._getTokenFunc()}}class pU{constructor(){this._controller=null}setConfig(e){this._config=e}barCodeUrl(e,t){if(this._config)return this._config.barcodeUrl(e,t)}barCodeTypes(){var e;return((e=this._config)==null?void 0:e.barCodes.types)||[""]}config(){return this._config}hasController(){return this._config!=null}createController(e){if(!this._config)return;const t=this._config.createController(e);return this._controller=t,t}controller(){return this._controller}}class fU{markerTracking(){return this._markerTracking=this._markerTracking||new pU}mapbox(){return this._mapbox=this._mapbox||new dU}}function mU(n,e){const t=Object.create(null),r=n.split(",");for(let s=0;s<r.length;s++)t[r[s]]=!0;return e?s=>!!t[s.toLowerCase()]:s=>!!t[s]}const CT=()=>{},_U=Object.prototype.hasOwnProperty,yp=(n,e)=>_U.call(n,e),Ss=Array.isArray,dd=n=>ET(n)==="[object Map]",oc=n=>typeof n=="function",gU=n=>typeof n=="string",tv=n=>typeof n=="symbol",bc=n=>n!==null&&typeof n=="object",vU=n=>bc(n)&&oc(n.then)&&oc(n.catch),yU=Object.prototype.toString,ET=n=>yU.call(n),xU=n=>ET(n).slice(8,-1),nv=n=>gU(n)&&n!=="NaN"&&n[0]!=="-"&&""+parseInt(n,10)===n,Bl=(n,e)=>!Object.is(n,e);let bU;function CU(n,e=bU){e&&e.active&&e.effects.push(n)}const rv=n=>{const e=new Set(n);return e.w=0,e.n=0,e},ST=n=>(n.w&ji)>0,AT=n=>(n.n&ji)>0,EU=({deps:n})=>{if(n.length)for(let e=0;e<n.length;e++)n[e].w|=ji},SU=n=>{const{deps:e}=n;if(e.length){let t=0;for(let r=0;r<e.length;r++){const s=e[r];ST(s)&&!AT(s)?s.delete(n):e[t++]=s,s.w&=~ji,s.n&=~ji}e.length=t}},E_=new WeakMap;let al=0,ji=1;const S_=30;let Kr;const Ro=Symbol(""),A_=Symbol("");class TT{constructor(e,t=null,r){this.fn=e,this.scheduler=t,this.active=!0,this.deps=[],this.parent=void 0,CU(this,r)}run(){if(!this.active)return this.fn();let e=Kr,t=Vi;for(;e;){if(e===this)return;e=e.parent}try{return this.parent=Kr,Kr=this,Vi=!0,ji=1<<++al,al<=S_?EU(this):Jx(this),this.fn()}finally{al<=S_&&SU(this),ji=1<<--al,Kr=this.parent,Vi=t,this.parent=void 0,this.deferStop&&this.stop()}}stop(){Kr===this?this.deferStop=!0:this.active&&(Jx(this),this.onStop&&this.onStop(),this.active=!1)}}function Jx(n){const{deps:e}=n;if(e.length){for(let t=0;t<e.length;t++)e[t].delete(n);e.length=0}}let Vi=!0;const MT=[];function AU(){MT.push(Vi),Vi=!1}function TU(){const n=MT.pop();Vi=n===void 0?!0:n}function Gr(n,e,t){if(Vi&&Kr){let r=E_.get(n);r||E_.set(n,r=new Map);let s=r.get(t);s||r.set(t,s=rv()),RT(s)}}function RT(n,e){let t=!1;al<=S_?AT(n)||(n.n|=ji,t=!ST(n)):t=!n.has(Kr),t&&(n.add(Kr),Kr.deps.push(n))}function Wi(n,e,t,r,s,i){const o=E_.get(n);if(!o)return;let a=[];if(e==="clear")a=[...o.values()];else if(t==="length"&&Ss(n)){const c=Number(r);o.forEach((l,u)=>{(u==="length"||u>=c)&&a.push(l)})}else switch(t!==void 0&&a.push(o.get(t)),e){case"add":Ss(n)?nv(t)&&a.push(o.get("length")):(a.push(o.get(Ro)),dd(n)&&a.push(o.get(A_)));break;case"delete":Ss(n)||(a.push(o.get(Ro)),dd(n)&&a.push(o.get(A_)));break;case"set":dd(n)&&a.push(o.get(Ro));break}if(a.length===1)a[0]&&T_(a[0]);else{const c=[];for(const l of a)l&&c.push(...l);T_(rv(c))}}function T_(n,e){const t=Ss(n)?n:[...n];for(const r of t)r.computed&&Qx(r);for(const r of t)r.computed||Qx(r)}function Qx(n,e){(n!==Kr||n.allowRecurse)&&(n.scheduler?n.scheduler():n.run())}const MU=mU("__proto__,__v_isRef,__isVue"),wT=new Set(Object.getOwnPropertyNames(Symbol).filter(n=>n!=="arguments"&&n!=="caller").map(n=>Symbol[n]).filter(tv)),RU=OT(),wU=OT(!0),eb=OU();function OU(){const n={};return["includes","indexOf","lastIndexOf"].forEach(e=>{n[e]=function(...t){const r=Ot(this);for(let i=0,o=this.length;i<o;i++)Gr(r,"get",i+"");const s=r[e](...t);return s===-1||s===!1?r[e](...t.map(Ot)):s}}),["push","pop","shift","unshift","splice"].forEach(e=>{n[e]=function(...t){AU();const r=Ot(this)[e].apply(this,t);return TU(),r}}),n}function PU(n){const e=Ot(this);return Gr(e,"has",n),e.hasOwnProperty(n)}function OT(n=!1,e=!1){return function(r,s,i){if(s==="__v_isReactive")return!n;if(s==="__v_isReadonly")return n;if(s==="__v_isShallow")return e;if(s==="__v_raw"&&i===(n?e?$U:IT:e?XU:NT).get(r))return r;const o=Ss(r);if(!n){if(o&&yp(eb,s))return Reflect.get(eb,s,i);if(s==="hasOwnProperty")return PU}const a=Reflect.get(r,s,i);return(tv(s)?wT.has(s):MU(s))||(n||Gr(r,"get",s),e)?a:Ni(a)?o&&nv(s)?a:a.value:bc(a)?n?LT(a):DT(a):a}}const NU=IU();function IU(n=!1){return function(t,r,s,i){let o=t[r];if(Gl(o)&&Ni(o)&&!Ni(s))return!1;if(!n&&(!iv(s)&&!Gl(s)&&(o=Ot(o),s=Ot(s)),!Ss(t)&&Ni(o)&&!Ni(s)))return o.value=s,!0;const a=Ss(t)&&nv(r)?Number(r)<t.length:yp(t,r),c=Reflect.set(t,r,s,i);return t===Ot(i)&&(a?Bl(s,o)&&Wi(t,"set",r,s):Wi(t,"add",r,s)),c}}function DU(n,e){const t=yp(n,e);n[e];const r=Reflect.deleteProperty(n,e);return r&&t&&Wi(n,"delete",e,void 0),r}function LU(n,e){const t=Reflect.has(n,e);return(!tv(e)||!wT.has(e))&&Gr(n,"has",e),t}function FU(n){return Gr(n,"iterate",Ss(n)?"length":Ro),Reflect.ownKeys(n)}const UU={get:RU,set:NU,deleteProperty:DU,has:LU,ownKeys:FU},kU={get:wU,set(n,e){return!0},deleteProperty(n,e){return!0}},sv=n=>n,xp=n=>Reflect.getPrototypeOf(n);function fh(n,e,t=!1,r=!1){n=n.__v_raw;const s=Ot(n),i=Ot(e);t||(e!==i&&Gr(s,"get",e),Gr(s,"get",i));const{has:o}=xp(s),a=r?sv:t?ov:Vl;if(o.call(s,e))return a(n.get(e));if(o.call(s,i))return a(n.get(i));n!==s&&n.get(e)}function mh(n,e=!1){const t=this.__v_raw,r=Ot(t),s=Ot(n);return e||(n!==s&&Gr(r,"has",n),Gr(r,"has",s)),n===s?t.has(n):t.has(n)||t.has(s)}function _h(n,e=!1){return n=n.__v_raw,!e&&Gr(Ot(n),"iterate",Ro),Reflect.get(n,"size",n)}function tb(n){n=Ot(n);const e=Ot(this);return xp(e).has.call(e,n)||(e.add(n),Wi(e,"add",n,n)),this}function nb(n,e){e=Ot(e);const t=Ot(this),{has:r,get:s}=xp(t);let i=r.call(t,n);i||(n=Ot(n),i=r.call(t,n));const o=s.call(t,n);return t.set(n,e),i?Bl(e,o)&&Wi(t,"set",n,e):Wi(t,"add",n,e),this}function rb(n){const e=Ot(this),{has:t,get:r}=xp(e);let s=t.call(e,n);s||(n=Ot(n),s=t.call(e,n)),r&&r.call(e,n);const i=e.delete(n);return s&&Wi(e,"delete",n,void 0),i}function sb(){const n=Ot(this),e=n.size!==0,t=n.clear();return e&&Wi(n,"clear",void 0,void 0),t}function gh(n,e){return function(r,s){const i=this,o=i.__v_raw,a=Ot(o),c=e?sv:n?ov:Vl;return!n&&Gr(a,"iterate",Ro),o.forEach((l,u)=>r.call(s,c(l),c(u),i))}}function vh(n,e,t){return function(...r){const s=this.__v_raw,i=Ot(s),o=dd(i),a=n==="entries"||n===Symbol.iterator&&o,c=n==="keys"&&o,l=s[n](...r),u=t?sv:e?ov:Vl;return!e&&Gr(i,"iterate",c?A_:Ro),{next(){const{value:h,done:d}=l.next();return d?{value:h,done:d}:{value:a?[u(h[0]),u(h[1])]:u(h),done:d}},[Symbol.iterator](){return this}}}}function pi(n){return function(...e){return n==="delete"?!1:this}}function BU(){const n={get(i){return fh(this,i)},get size(){return _h(this)},has:mh,add:tb,set:nb,delete:rb,clear:sb,forEach:gh(!1,!1)},e={get(i){return fh(this,i,!1,!0)},get size(){return _h(this)},has:mh,add:tb,set:nb,delete:rb,clear:sb,forEach:gh(!1,!0)},t={get(i){return fh(this,i,!0)},get size(){return _h(this,!0)},has(i){return mh.call(this,i,!0)},add:pi("add"),set:pi("set"),delete:pi("delete"),clear:pi("clear"),forEach:gh(!0,!1)},r={get(i){return fh(this,i,!0,!0)},get size(){return _h(this,!0)},has(i){return mh.call(this,i,!0)},add:pi("add"),set:pi("set"),delete:pi("delete"),clear:pi("clear"),forEach:gh(!0,!0)};return["keys","values","entries",Symbol.iterator].forEach(i=>{n[i]=vh(i,!1,!1),t[i]=vh(i,!0,!1),e[i]=vh(i,!1,!0),r[i]=vh(i,!0,!0)}),[n,t,e,r]}const[GU,VU,zU,HU]=BU();function PT(n,e){const t=e?n?HU:zU:n?VU:GU;return(r,s,i)=>s==="__v_isReactive"?!n:s==="__v_isReadonly"?n:s==="__v_raw"?r:Reflect.get(yp(t,s)&&s in r?t:r,s,i)}const jU={get:PT(!1,!1)},WU={get:PT(!0,!1)},NT=new WeakMap,XU=new WeakMap,IT=new WeakMap,$U=new WeakMap;function qU(n){switch(n){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function YU(n){return n.__v_skip||!Object.isExtensible(n)?0:qU(xU(n))}function DT(n){return Gl(n)?n:FT(n,!1,UU,jU,NT)}function LT(n){return FT(n,!0,kU,WU,IT)}function FT(n,e,t,r,s){if(!bc(n)||n.__v_raw&&!(e&&n.__v_isReactive))return n;const i=s.get(n);if(i)return i;const o=YU(n);if(o===0)return n;const a=new Proxy(n,o===2?r:t);return s.set(n,a),a}function pd(n){return Gl(n)?pd(n.__v_raw):!!(n&&n.__v_isReactive)}function Gl(n){return!!(n&&n.__v_isReadonly)}function iv(n){return!!(n&&n.__v_isShallow)}function Ot(n){const e=n&&n.__v_raw;return e?Ot(e):n}const Vl=n=>bc(n)?DT(n):n,ov=n=>bc(n)?LT(n):n;function UT(n){Vi&&Kr&&(n=Ot(n),RT(n.dep||(n.dep=rv())))}function kT(n,e){n=Ot(n);const t=n.dep;t&&T_(t)}function Ni(n){return!!(n&&n.__v_isRef===!0)}function Pr(n){return KU(n,!1)}function KU(n,e){return Ni(n)?n:new ZU(n,e)}class ZU{constructor(e,t){this.__v_isShallow=t,this.dep=void 0,this.__v_isRef=!0,this._rawValue=t?e:Ot(e),this._value=t?e:Vl(e)}get value(){return UT(this),this._value}set value(e){const t=this.__v_isShallow||iv(e)||Gl(e);e=t?e:Ot(e),Bl(e,this._rawValue)&&(this._rawValue=e,this._value=t?e:Vl(e),kT(this))}}class JU{constructor(e,t,r,s){this._setter=t,this.dep=void 0,this.__v_isRef=!0,this.__v_isReadonly=!1,this._dirty=!0,this.effect=new TT(e,()=>{this._dirty||(this._dirty=!0,kT(this))}),this.effect.computed=this,this.effect.active=this._cacheable=!s,this.__v_isReadonly=r}get value(){const e=Ot(this);return UT(e),(e._dirty||!e._cacheable)&&(e._dirty=!1,e._value=e.effect.run()),e._value}set value(e){this._setter(e)}}function QU(n,e,t=!1){let r,s;const i=oc(n);return i?(r=n,s=CT):(r=n.get,s=n.set),new JU(r,s,i||!s,t)}function fd(n,e,t){let r;try{r=t?n(...t):n()}catch(s){BT(s,e)}return r}function M_(n,e,t){if(oc(n)){const s=fd(n,e,t);return s&&vU(s)&&s.catch(i=>{BT(i,e)}),s}const r=[];for(let s=0;s<n.length;s++)r.push(M_(n[s],e,t));return r}function BT(n,e){console.error(new Error(`[@vue-reactivity/watch]: ${e}`)),console.error(n)}function ek(n){console.warn(tk(n))}function tk(n){return new Error(`[reactivue]: ${n}`)}var ib={};function GT(n,e,t){return nk(n,e,t)}function nk(n,e,{immediate:t,deep:r,flush:s}={}){let i,o=!1,a=!1;if(Ni(n)?(i=()=>n.value,o=iv(n)):pd(n)?(i=()=>n,r=!0):Ss(n)?(a=!0,o=n.some(pd),i=()=>n.map(_=>Ni(_)?_.value:pd(_)?Ga(_):oc(_)?fd(_,"watch getter"):ek("invalid source"))):oc(n)?e?i=()=>fd(n,"watch getter"):i=()=>(c&&c(),M_(n,"watch callback",[l])):i=CT,e&&r){const _=i;i=()=>Ga(_())}let c,l=_=>{c=p.onStop=()=>{fd(_,"watch cleanup")}},u=a?[]:ib;const h=()=>{if(p.active)if(e){const _=p.run();(r||o||(a?_.some((g,f)=>Bl(g,u[f])):Bl(_,u)))&&(c&&c(),M_(e,"watch value",[_,u===ib?void 0:u,l]),u=_)}else p.run()};h.allowRecurse=!!e;let d;s==="sync"?d=h:d=()=>{h()};const p=new TT(i,d);return e?t?h():u=p.run():p.run(),()=>p.stop()}function Ga(n,e=new Set){if(!bc(n)||e.has(n))return n;if(e.add(n),Ss(n))for(let t=0;t<n.length;t++)Ga(n[t],e);else if(n instanceof Map)n.forEach((t,r)=>{Ga(n.get(r),e)});else if(n instanceof Set)n.forEach(t=>{Ga(t,e)});else for(const t of Object.keys(n))Ga(n[t],e);return n}const rk=Math.floor(Number.MAX_SAFE_INTEGER/100);function VT(n){n.value>rk?n.value=0:n.value+=1}function dr(n,e,t){n.has(e)?n.get(e).push(t):n.set(e,[t])}function R_(n,e,t,r=!0){if(n.has(e)){const s=n.get(e),i=s.indexOf(t);i>=0&&(s.splice(i,1),r&&s.length==0&&n.delete(e))}}function fr(n,e,t){if(n.has(e))n.get(e).add(t);else{const r=new Set;r.add(t),n.set(e,r)}}function ob(n,e){return e.length=0,n.forEach(t=>{e.push(t)}),e}function ab(n,e,t){if(n.has(e)){const r=n.get(e);r.delete(t),r.size==0&&n.delete(e)}}let Gf=0;function rr(n,e){e.length=n.size,Gf=0;for(const t of n)e[Gf]=t,Gf++;return e}function zT(n,e,t){t.clear();for(const r of n)t.add(r);for(const r of e)t.add(r);return t}function sk(n,e,t){t.clear();for(const r of n)e.has(r)&&t.add(r);for(const r of e)n.has(r)&&t.add(r);return t}function HT(n,e,t){t.clear();for(const r of n)e.has(r)||t.add(r);return t}function _t(n){return Array.isArray(n)}function mr(n){return n===!0||n===!1}function Ye(n){return typeof n=="number"}function md(n){return Ye(n)&&!isNaN(n)}const av=isNaN;function zl(n){return n instanceof W||n instanceof T||n instanceof We}function Hl(n){return n instanceof xe}function jT(n){return n instanceof pr}function ik(n){return n instanceof Qt}function Ke(n){return typeof n=="string"}function Bd(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}function bp(n){var e=typeof n;return n!=null&&e=="function"}function ok(n){return n instanceof Promise}class yr{}yr.isNumber=Ye;yr.isNumberValid=md;yr.isVector=zl;yr.isColor=Hl;yr.isEuler=jT;yr.isQuaternion=ik;yr.isString=Ke;yr.isBoolean=mr;yr.isNaN=av;yr.isArray=_t;yr.isObject=Bd;yr.isFunction=bp;const ak=Math.PI/180,ck=180/Math.PI;function lk(n,e,t){return n<=e?0:n>=t?1:(n=(n-e)/(t-e),n*n*(3-2*n))}function uk(n,e,t){return n<=e?0:n>=t?1:(n=(n-e)/(t-e),n*n*n*(n*(n*6-15)+10))}function hk(n){return n*ak}function dk(n){return n*ck}const Cp=function(n){return function(e){return Math.pow(e,n)}},Ep=function(n){return function(e){return 1-Math.abs(Math.pow(e-1,n))}},cv=function(n){return function(e){return e<.5?Cp(n)(e*2)/2:Ep(n)(e*2-1)/2+.5}},pk=Cp(2),fk=Ep(2),mk=cv(2),_k=Cp(3),gk=Ep(3),vk=cv(3),yk=Cp(4),xk=Ep(4),bk=cv(4);function Ck(n){return 1+Math.sin(Math.PI/2*n-Math.PI/2)}function Ek(n){return Math.sin(Math.PI/2*n)}function Sk(n){return(1+Math.sin(Math.PI*n-Math.PI/2))/2}function Ak(n){return n==0?0:(.04-.04/n)*Math.sin(25*n)+1}function Tk(n){return n==1?1:.04*n/--n*Math.sin(25*n)}function Mk(n){return n==.5?0:(n-=.5)<0?(.02+.01/n)*Math.sin(50*n):(.02-.01/n)*Math.sin(50*n)+1}const WT={easeI2:pk,easeO2:fk,easeIO2:mk,easeI3:_k,easeO3:gk,easeIO3:vk,easeI4:yk,easeO4:xk,easeIO4:bk,easeSinI:Ck,easeSinO:Ek,easeSinIO:Sk,easeElasticI:Ak,easeElasticO:Tk,easeElasticIO:Mk},Rk=12.9898,wk=78.233,Ok=43758.5453,Pk=hk,XT=dk;function $T(n,e,t){return n<e?e:n>t?t:n}const Nk=lk,Ik=uk;function lv(n,e,t,r,s){const i=t-e,o=s-r;return(n-e)/i*o+r}function Dk(n,e,t){return lv(n,0,1,e,t)}function Lk(n,e,t,r,s){const i=lv(n,e,t,r,s);return $T(i,r,s)}function Fk(n,e,t){return(1-t)*n+t*e}const qT=n=>n-Math.floor(n),YT=136574,Vf={x:0,y:YT};function KT(n,e=YT){return Vf.x=n,Vf.y=e,uv(Vf)}function uv(n){const t=(n.x*Rk+n.y*wk)%Math.PI;return qT(Math.sin(t)*Ok)}function Uk(n){return Ye(n)?KT(n):uv(n)}function kk(n,e){const t=n/e;return(n<0?Math.ceil(t):Math.floor(t))*e}function Bk(n){return 2*Math.ceil(n*.5)}function ZT(n){return Math.pow(2,Math.ceil(Math.log(n)/Math.log(2)))}function Gk(n){return Math.log(n)/Math.log(2)}new T;new T;function Vk(n,e,t){return n*(1-t)+e*t}class yn{}yn.Easing=WT;yn.degToRad=Pk;yn.radToDeg=XT;yn.clamp=$T;yn.smoothstep=Nk;yn.smootherstep=Ik;yn.fit01=Dk;yn.fit=lv;yn.fitClamp=Lk;yn.mix=Fk;yn.fract=qT;yn.rand=Uk;yn.round=kk;yn.highestEven=Bk;yn.nearestPower2=ZT;yn.pow2Inverse=Gk;yn.randFloat=KT;yn.randVec2=uv;yn.lerpFloat=Vk;const Gd=new Set,JT=new Set,QT=new Set;function eM(n,e,t,r){e==null&&(e=n,n=0);const s=Math.floor((e-n)/t);r.length=s;for(let i=0;i<s;i++)r[i]=n+i*t;return r}function zk(n){const e=[];return eM(0,n,1,e),e}function Zs(n,e){e.length=0;for(const t of n)e.includes(t)||e.push(t);return e}function Js(n,e){e.length=0;for(const t of n)t!=null&&e.push(t);return e}function Hk(n){let e=0;for(const t of n)e+=t;return e}function jk(n,e,t){return zT(gs(n,JT),gs(e,QT),Gd),rr(Gd,t),t}function tM(n,e,t){return HT(gs(n,JT),gs(e,QT),Gd),rr(Gd,t),t}function gs(n,e){e.clear();for(const t of n)e.add(t);return e}function nM(n,e){if(n.length!=e.length)return!1;const t=n.length;for(let r=0;r<t;r++)if(n[r]!=e[r])return!1;return!0}function w_(n,e){if(n.length==0)return[];const t=new Map,r=new Set;for(const a of n){const c=e(a);r.add(c),dr(t,c,a)}const s=new Array(r.size);let i=0;r.forEach(a=>{s[i]=a,i++}),Ke(s[0])?s.sort():s.sort((a,c)=>a-c);const o=new Array(n.length);i=0;for(const a of s){const c=t.get(a);if(c)for(const l of c)o[i]=l,i++}return o}function O_(n){return[...n]}function zf(n,e,t){t.length=0;for(const r of n)t.push(e(r));return t}function Sp(n,e){for(const t of n)e.push(t)}function Ts(n,e){e.length=n.length;let t=0;for(const r of n)e[t]=r,t++}function Wk(){this.__data__=[],this.size=0}function rM(n,e){return n===e||n!==n&&e!==e}function Ap(n,e){for(var t=n.length;t--;)if(rM(n[t][0],e))return t;return-1}var Xk=Array.prototype,$k=Xk.splice;function qk(n){var e=this.__data__,t=Ap(e,n);if(t<0)return!1;var r=e.length-1;return t==r?e.pop():$k.call(e,t,1),--this.size,!0}function Yk(n){var e=this.__data__,t=Ap(e,n);return t<0?void 0:e[t][1]}function Kk(n){return Ap(this.__data__,n)>-1}function Zk(n,e){var t=this.__data__,r=Ap(t,n);return r<0?(++this.size,t.push([n,e])):t[r][1]=e,this}function ri(n){var e=-1,t=n==null?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}ri.prototype.clear=Wk;ri.prototype.delete=qk;ri.prototype.get=Yk;ri.prototype.has=Kk;ri.prototype.set=Zk;function Jk(){this.__data__=new ri,this.size=0}function Qk(n){var e=this.__data__,t=e.delete(n);return this.size=e.size,t}function eB(n){return this.__data__.get(n)}function tB(n){return this.__data__.has(n)}var nB=typeof global=="object"&&global&&global.Object===Object&&global;const sM=nB;var rB=typeof self=="object"&&self&&self.Object===Object&&self,sB=sM||rB||Function("return this")();const ws=sB;var iB=ws.Symbol;const ac=iB;var iM=Object.prototype,oB=iM.hasOwnProperty,aB=iM.toString,Gc=ac?ac.toStringTag:void 0;function cB(n){var e=oB.call(n,Gc),t=n[Gc];try{n[Gc]=void 0;var r=!0}catch{}var s=aB.call(n);return r&&(e?n[Gc]=t:delete n[Gc]),s}var lB=Object.prototype,uB=lB.toString;function hB(n){return uB.call(n)}var dB="[object Null]",pB="[object Undefined]",cb=ac?ac.toStringTag:void 0;function yu(n){return n==null?n===void 0?pB:dB:cb&&cb in Object(n)?cB(n):hB(n)}function xu(n){var e=typeof n;return n!=null&&(e=="object"||e=="function")}var fB="[object AsyncFunction]",mB="[object Function]",_B="[object GeneratorFunction]",gB="[object Proxy]";function oM(n){if(!xu(n))return!1;var e=yu(n);return e==mB||e==_B||e==fB||e==gB}var vB=ws["__core-js_shared__"];const Hf=vB;var lb=function(){var n=/[^.]+$/.exec(Hf&&Hf.keys&&Hf.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""}();function yB(n){return!!lb&&lb in n}var xB=Function.prototype,bB=xB.toString;function Bo(n){if(n!=null){try{return bB.call(n)}catch{}try{return n+""}catch{}}return""}var CB=/[\\^$.*+?()[\]{}|]/g,EB=/^\[object .+?Constructor\]$/,SB=Function.prototype,AB=Object.prototype,TB=SB.toString,MB=AB.hasOwnProperty,RB=RegExp("^"+TB.call(MB).replace(CB,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function wB(n){if(!xu(n)||yB(n))return!1;var e=oM(n)?RB:EB;return e.test(Bo(n))}function OB(n,e){return n==null?void 0:n[e]}function Go(n,e){var t=OB(n,e);return wB(t)?t:void 0}var PB=Go(ws,"Map");const jl=PB;var NB=Go(Object,"create");const Wl=NB;function IB(){this.__data__=Wl?Wl(null):{},this.size=0}function DB(n){var e=this.has(n)&&delete this.__data__[n];return this.size-=e?1:0,e}var LB="__lodash_hash_undefined__",FB=Object.prototype,UB=FB.hasOwnProperty;function kB(n){var e=this.__data__;if(Wl){var t=e[n];return t===LB?void 0:t}return UB.call(e,n)?e[n]:void 0}var BB=Object.prototype,GB=BB.hasOwnProperty;function VB(n){var e=this.__data__;return Wl?e[n]!==void 0:GB.call(e,n)}var zB="__lodash_hash_undefined__";function HB(n,e){var t=this.__data__;return this.size+=this.has(n)?0:1,t[n]=Wl&&e===void 0?zB:e,this}function Po(n){var e=-1,t=n==null?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}Po.prototype.clear=IB;Po.prototype.delete=DB;Po.prototype.get=kB;Po.prototype.has=VB;Po.prototype.set=HB;function jB(){this.size=0,this.__data__={hash:new Po,map:new(jl||ri),string:new Po}}function WB(n){var e=typeof n;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?n!=="__proto__":n===null}function Tp(n,e){var t=n.__data__;return WB(e)?t[typeof e=="string"?"string":"hash"]:t.map}function XB(n){var e=Tp(this,n).delete(n);return this.size-=e?1:0,e}function $B(n){return Tp(this,n).get(n)}function qB(n){return Tp(this,n).has(n)}function YB(n,e){var t=Tp(this,n),r=t.size;return t.set(n,e),this.size+=t.size==r?0:1,this}function Cc(n){var e=-1,t=n==null?0:n.length;for(this.clear();++e<t;){var r=n[e];this.set(r[0],r[1])}}Cc.prototype.clear=jB;Cc.prototype.delete=XB;Cc.prototype.get=$B;Cc.prototype.has=qB;Cc.prototype.set=YB;var KB=200;function ZB(n,e){var t=this.__data__;if(t instanceof ri){var r=t.__data__;if(!jl||r.length<KB-1)return r.push([n,e]),this.size=++t.size,this;t=this.__data__=new Cc(r)}return t.set(n,e),this.size=t.size,this}function Ec(n){var e=this.__data__=new ri(n);this.size=e.size}Ec.prototype.clear=Jk;Ec.prototype.delete=Qk;Ec.prototype.get=eB;Ec.prototype.has=tB;Ec.prototype.set=ZB;function JB(n,e){for(var t=-1,r=n==null?0:n.length;++t<r&&e(n[t],t,n)!==!1;);return n}var QB=function(){try{var n=Go(Object,"defineProperty");return n({},"",{}),n}catch{}}();const ub=QB;function aM(n,e,t){e=="__proto__"&&ub?ub(n,e,{configurable:!0,enumerable:!0,value:t,writable:!0}):n[e]=t}var e2=Object.prototype,t2=e2.hasOwnProperty;function cM(n,e,t){var r=n[e];(!(t2.call(n,e)&&rM(r,t))||t===void 0&&!(e in n))&&aM(n,e,t)}function Mp(n,e,t,r){var s=!t;t||(t={});for(var i=-1,o=e.length;++i<o;){var a=e[i],c=r?r(t[a],n[a],a,t,n):void 0;c===void 0&&(c=n[a]),s?aM(t,a,c):cM(t,a,c)}return t}function n2(n,e){for(var t=-1,r=Array(n);++t<n;)r[t]=e(t);return r}function bu(n){return n!=null&&typeof n=="object"}var r2="[object Arguments]";function hb(n){return bu(n)&&yu(n)==r2}var lM=Object.prototype,s2=lM.hasOwnProperty,i2=lM.propertyIsEnumerable,o2=hb(function(){return arguments}())?hb:function(n){return bu(n)&&s2.call(n,"callee")&&!i2.call(n,"callee")};const a2=o2;var c2=Array.isArray;const hv=c2;function l2(){return!1}var uM=typeof exports=="object"&&exports&&!exports.nodeType&&exports,db=uM&&typeof module=="object"&&module&&!module.nodeType&&module,u2=db&&db.exports===uM,pb=u2?ws.Buffer:void 0,h2=pb?pb.isBuffer:void 0,d2=h2||l2;const hM=d2;var p2=9007199254740991,f2=/^(?:0|[1-9]\d*)$/;function m2(n,e){var t=typeof n;return e=e??p2,!!e&&(t=="number"||t!="symbol"&&f2.test(n))&&n>-1&&n%1==0&&n<e}var _2=9007199254740991;function dM(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=_2}var g2="[object Arguments]",v2="[object Array]",y2="[object Boolean]",x2="[object Date]",b2="[object Error]",C2="[object Function]",E2="[object Map]",S2="[object Number]",A2="[object Object]",T2="[object RegExp]",M2="[object Set]",R2="[object String]",w2="[object WeakMap]",O2="[object ArrayBuffer]",P2="[object DataView]",N2="[object Float32Array]",I2="[object Float64Array]",D2="[object Int8Array]",L2="[object Int16Array]",F2="[object Int32Array]",U2="[object Uint8Array]",k2="[object Uint8ClampedArray]",B2="[object Uint16Array]",G2="[object Uint32Array]",Bt={};Bt[N2]=Bt[I2]=Bt[D2]=Bt[L2]=Bt[F2]=Bt[U2]=Bt[k2]=Bt[B2]=Bt[G2]=!0;Bt[g2]=Bt[v2]=Bt[O2]=Bt[y2]=Bt[P2]=Bt[x2]=Bt[b2]=Bt[C2]=Bt[E2]=Bt[S2]=Bt[A2]=Bt[T2]=Bt[M2]=Bt[R2]=Bt[w2]=!1;function V2(n){return bu(n)&&dM(n.length)&&!!Bt[yu(n)]}function dv(n){return function(e){return n(e)}}var pM=typeof exports=="object"&&exports&&!exports.nodeType&&exports,bl=pM&&typeof module=="object"&&module&&!module.nodeType&&module,z2=bl&&bl.exports===pM,jf=z2&&sM.process,H2=function(){try{var n=bl&&bl.require&&bl.require("util").types;return n||jf&&jf.binding&&jf.binding("util")}catch{}}();const cc=H2;var fb=cc&&cc.isTypedArray,j2=fb?dv(fb):V2;const W2=j2;var X2=Object.prototype,$2=X2.hasOwnProperty;function fM(n,e){var t=hv(n),r=!t&&a2(n),s=!t&&!r&&hM(n),i=!t&&!r&&!s&&W2(n),o=t||r||s||i,a=o?n2(n.length,String):[],c=a.length;for(var l in n)(e||$2.call(n,l))&&!(o&&(l=="length"||s&&(l=="offset"||l=="parent")||i&&(l=="buffer"||l=="byteLength"||l=="byteOffset")||m2(l,c)))&&a.push(l);return a}var q2=Object.prototype;function pv(n){var e=n&&n.constructor,t=typeof e=="function"&&e.prototype||q2;return n===t}function mM(n,e){return function(t){return n(e(t))}}var Y2=mM(Object.keys,Object);const K2=Y2;var Z2=Object.prototype,J2=Z2.hasOwnProperty;function Q2(n){if(!pv(n))return K2(n);var e=[];for(var t in Object(n))J2.call(n,t)&&t!="constructor"&&e.push(t);return e}function _M(n){return n!=null&&dM(n.length)&&!oM(n)}function fv(n){return _M(n)?fM(n):Q2(n)}function e3(n,e){return n&&Mp(e,fv(e),n)}function t3(n){var e=[];if(n!=null)for(var t in Object(n))e.push(t);return e}var n3=Object.prototype,r3=n3.hasOwnProperty;function s3(n){if(!xu(n))return t3(n);var e=pv(n),t=[];for(var r in n)r=="constructor"&&(e||!r3.call(n,r))||t.push(r);return t}function mv(n){return _M(n)?fM(n,!0):s3(n)}function i3(n,e){return n&&Mp(e,mv(e),n)}var gM=typeof exports=="object"&&exports&&!exports.nodeType&&exports,mb=gM&&typeof module=="object"&&module&&!module.nodeType&&module,o3=mb&&mb.exports===gM,_b=o3?ws.Buffer:void 0,gb=_b?_b.allocUnsafe:void 0;function a3(n,e){if(e)return n.slice();var t=n.length,r=gb?gb(t):new n.constructor(t);return n.copy(r),r}function c3(n,e){var t=-1,r=n.length;for(e||(e=Array(r));++t<r;)e[t]=n[t];return e}function l3(n,e){for(var t=-1,r=n==null?0:n.length,s=0,i=[];++t<r;){var o=n[t];e(o,t,n)&&(i[s++]=o)}return i}function vM(){return[]}var u3=Object.prototype,h3=u3.propertyIsEnumerable,vb=Object.getOwnPropertySymbols,d3=vb?function(n){return n==null?[]:(n=Object(n),l3(vb(n),function(e){return h3.call(n,e)}))}:vM;const _v=d3;function p3(n,e){return Mp(n,_v(n),e)}function yM(n,e){for(var t=-1,r=e.length,s=n.length;++t<r;)n[s+t]=e[t];return n}var f3=mM(Object.getPrototypeOf,Object);const xM=f3;var m3=Object.getOwnPropertySymbols,_3=m3?function(n){for(var e=[];n;)yM(e,_v(n)),n=xM(n);return e}:vM;const bM=_3;function g3(n,e){return Mp(n,bM(n),e)}function CM(n,e,t){var r=e(n);return hv(n)?r:yM(r,t(n))}function v3(n){return CM(n,fv,_v)}function y3(n){return CM(n,mv,bM)}var x3=Go(ws,"DataView");const P_=x3;var b3=Go(ws,"Promise");const N_=b3;var C3=Go(ws,"Set");const I_=C3;var E3=Go(ws,"WeakMap");const D_=E3;var yb="[object Map]",S3="[object Object]",xb="[object Promise]",bb="[object Set]",Cb="[object WeakMap]",Eb="[object DataView]",A3=Bo(P_),T3=Bo(jl),M3=Bo(N_),R3=Bo(I_),w3=Bo(D_),ho=yu;(P_&&ho(new P_(new ArrayBuffer(1)))!=Eb||jl&&ho(new jl)!=yb||N_&&ho(N_.resolve())!=xb||I_&&ho(new I_)!=bb||D_&&ho(new D_)!=Cb)&&(ho=function(n){var e=yu(n),t=e==S3?n.constructor:void 0,r=t?Bo(t):"";if(r)switch(r){case A3:return Eb;case T3:return yb;case M3:return xb;case R3:return bb;case w3:return Cb}return e});const gv=ho;var O3=Object.prototype,P3=O3.hasOwnProperty;function N3(n){var e=n.length,t=new n.constructor(e);return e&&typeof n[0]=="string"&&P3.call(n,"index")&&(t.index=n.index,t.input=n.input),t}var I3=ws.Uint8Array;const Sb=I3;function vv(n){var e=new n.constructor(n.byteLength);return new Sb(e).set(new Sb(n)),e}function D3(n,e){var t=e?vv(n.buffer):n.buffer;return new n.constructor(t,n.byteOffset,n.byteLength)}var L3=/\w*$/;function F3(n){var e=new n.constructor(n.source,L3.exec(n));return e.lastIndex=n.lastIndex,e}var Ab=ac?ac.prototype:void 0,Tb=Ab?Ab.valueOf:void 0;function U3(n){return Tb?Object(Tb.call(n)):{}}function k3(n,e){var t=e?vv(n.buffer):n.buffer;return new n.constructor(t,n.byteOffset,n.length)}var B3="[object Boolean]",G3="[object Date]",V3="[object Map]",z3="[object Number]",H3="[object RegExp]",j3="[object Set]",W3="[object String]",X3="[object Symbol]",$3="[object ArrayBuffer]",q3="[object DataView]",Y3="[object Float32Array]",K3="[object Float64Array]",Z3="[object Int8Array]",J3="[object Int16Array]",Q3="[object Int32Array]",eG="[object Uint8Array]",tG="[object Uint8ClampedArray]",nG="[object Uint16Array]",rG="[object Uint32Array]";function sG(n,e,t){var r=n.constructor;switch(e){case $3:return vv(n);case B3:case G3:return new r(+n);case q3:return D3(n,t);case Y3:case K3:case Z3:case J3:case Q3:case eG:case tG:case nG:case rG:return k3(n,t);case V3:return new r;case z3:case W3:return new r(n);case H3:return F3(n);case j3:return new r;case X3:return U3(n)}}var Mb=Object.create,iG=function(){function n(){}return function(e){if(!xu(e))return{};if(Mb)return Mb(e);n.prototype=e;var t=new n;return n.prototype=void 0,t}}();const oG=iG;function aG(n){return typeof n.constructor=="function"&&!pv(n)?oG(xM(n)):{}}var cG="[object Map]";function lG(n){return bu(n)&&gv(n)==cG}var Rb=cc&&cc.isMap,uG=Rb?dv(Rb):lG;const hG=uG;var dG="[object Set]";function pG(n){return bu(n)&&gv(n)==dG}var wb=cc&&cc.isSet,fG=wb?dv(wb):pG;const mG=fG;var _G=1,gG=2,vG=4,EM="[object Arguments]",yG="[object Array]",xG="[object Boolean]",bG="[object Date]",CG="[object Error]",SM="[object Function]",EG="[object GeneratorFunction]",SG="[object Map]",AG="[object Number]",AM="[object Object]",TG="[object RegExp]",MG="[object Set]",RG="[object String]",wG="[object Symbol]",OG="[object WeakMap]",PG="[object ArrayBuffer]",NG="[object DataView]",IG="[object Float32Array]",DG="[object Float64Array]",LG="[object Int8Array]",FG="[object Int16Array]",UG="[object Int32Array]",kG="[object Uint8Array]",BG="[object Uint8ClampedArray]",GG="[object Uint16Array]",VG="[object Uint32Array]",It={};It[EM]=It[yG]=It[PG]=It[NG]=It[xG]=It[bG]=It[IG]=It[DG]=It[LG]=It[FG]=It[UG]=It[SG]=It[AG]=It[AM]=It[TG]=It[MG]=It[RG]=It[wG]=It[kG]=It[BG]=It[GG]=It[VG]=!0;It[CG]=It[SM]=It[OG]=!1;function Cl(n,e,t,r,s,i){var o,a=e&_G,c=e&gG,l=e&vG;if(t&&(o=s?t(n,r,s,i):t(n)),o!==void 0)return o;if(!xu(n))return n;var u=hv(n);if(u){if(o=N3(n),!a)return c3(n,o)}else{var h=gv(n),d=h==SM||h==EG;if(hM(n))return a3(n,a);if(h==AM||h==EM||d&&!s){if(o=c||d?{}:aG(n),!a)return c?g3(n,i3(o,n)):p3(n,e3(o,n))}else{if(!It[h])return s?n:{};o=sG(n,h,a)}}i||(i=new Ec);var p=i.get(n);if(p)return p;i.set(n,o),mG(n)?n.forEach(function(f){o.add(Cl(f,e,t,f,n,i))}):hG(n)&&n.forEach(function(f,m){o.set(m,Cl(f,e,t,m,n,i))});var _=l?c?y3:v3:c?mv:fv,g=u?void 0:_(n);return JB(g||n,function(f,m){g&&(m=f,f=n[m]),cM(o,m,Cl(f,e,t,m,n,i))}),o}var zG=1,HG=4;function jG(n){return Cl(n,zG|HG)}var WG=4;function XG(n){return Cl(n,WG)}function $G(n){let e=new Set,t=n;do Object.getOwnPropertyNames(t).map(r=>e.add(r));while(t=Object.getPrototypeOf(t));return[...e.keys()].filter(r=>typeof n[r]=="function")}function Ob(n,e){if(mr(n)&&mr(e)||Ye(n)&&Ye(e)||Ke(n)&&Ke(e))return n==e;if(Bd(n)&&Bd(e)){const t=Object.keys(n),r=Object.keys(e);return nM(t,r)?JSON.stringify(n)==JSON.stringify(e):!1}return!1}function Vd(n){return XG(n)}function Ii(n){return jG(n)}const L_=new WeakMap;function qG(n,e){let t=L_.get(n);t||(t=new Set,L_.set(n,t)),t.add(e)}function YG(n,e){let t=L_.get(n);t&&t.delete(e)}const KG=new Set(["constructor","onDispose","dispose","__defineGetter__","__defineSetter__","hasOwnProperty","__lookupGetter__","__lookupSetter__","isPrototypeOf","propertyIsEnumerable","toString","valueOf","toLocaleString"]);class Pb{constructor(e){this._func=e,this._expectedEvaluatorMethodNames=new Set,this._evaluatorByObject=new Map}_createEvaluator(e){return this._func(e)}setExpectedEvaluatorMethodNames(e){this._expectedEvaluatorMethodNames.clear();const t=$G(e);for(const r of t)e[r]&&!KG.has(r)&&this._expectedEvaluatorMethodNames.add(r)}hasExpectedEvaluatorMethodName(e){return this._expectedEvaluatorMethodNames.has(e)}size(){return this._evaluatorByObject.size}disposeEvaluator(e){const t=this._evaluatorByObject.get(e);t&&(t.dispose(),this._evaluatorByObject.delete(e))}findOrCreateEvaluator(e){let t=this._evaluatorByObject.get(e);return t||(t=this._createEvaluator(e),this._evaluatorByObject.set(e,t),qG(e,this)),t}traverseEvaluator(e){this._evaluatorByObject.forEach(e)}clearObjects(){this._evaluatorByObject.forEach((e,t)=>{e.dispose(),YG(t,this)}),this._evaluatorByObject.clear()}}function Nb(n,e,t){let r=TM(n,t);r||(r=[],n.userData[t]=r);const s=e.graphNodeId();r.includes(s)||r.push(s)}const F_=new WeakMap;function Ib(n,e,t){let r=F_.get(n);r||(r=new Map,F_.set(n,r));let s=r.get(e);s||(s=new Set,r.set(e,s)),s.add(t)}function ZG(n,e){const t=F_.get(n);if(!t)return;const r=t.get(e);if(r)for(const s of r)s(n)}function TM(n,e){return n.userData[e]}function Db(n,e,t){const r=e.children;for(const s of r)s.traverse(i=>{U_(i,n,t)})}function U_(n,e,t){if(ZG(n,t),n.parent){const r=TM(n,t);if(!r)return;for(const s of r){const i=e.graph.nodeFromId(s);if(i&&!i.disposed())switch(t){case"onObjectAddHookHandlerNodeIds":{i.updateObjectOnAdd(n,n.parent);break}case"onObjectRemoveHookHandlerNodeIds":{i.updateObjectOnRemove(n,n.parent);break}}}}}class JG{assignOnAddHookHandler(e,t){Nb(e,t,"onObjectAddHookHandlerNodeIds")}assignOnRemoveHookHandler(e,t){Nb(e,t,"onObjectRemoveHookHandlerNodeIds")}assignOnAddHookCallback(e,t){Ib(e,"onObjectAddHookHandlerNodeIds",t)}assignOnRemoveHookCallback(e,t){Ib(e,"onObjectRemoveHookHandlerNodeIds",t)}runOnAddHooks(e,t){Db(e,t,"onObjectAddHookHandlerNodeIds")}runOnRemoveHooks(e,t){Db(e,t,"onObjectRemoveHookHandlerNodeIds")}runOnAddHookOnObject(e,t){U_(t,e,"onObjectAddHookHandlerNodeIds")}runOnRemoveHookOnObject(e,t){U_(t,e,"onObjectRemoveHookHandlerNodeIds")}}class QG{constructor(){this._map=new Map}registerHook(e,t){this._map.set(e,t),this._updateCache()}unregisterHook(e){this._map.delete(e),this._updateCache()}runHooks(){const e=this._hooks;if(e)for(let t of e)t()}hookedNodes(){return Array.from(this._map.keys())}_updateCache(){if(this._map.size==0)this._hooks=void 0;else{this._hooks=this._hooks||[],this._hooks.length=0;const e=this._hooks;this._map.forEach(t=>e.push(t))}}}class eV{constructor(){this._map=new Map}registerHook(e,t){this._map.set(e,t),this._updateCache()}_updateCache(){this._hooks=[];const e=this._hooks;this._map.forEach(t=>{e.push(t)})}runHooks(e,t,r,s){let i=!1;if(this._hooks)for(let o of this._hooks)o(e,t,r,s)&&(i=!0);return i}}class tV{constructor(e,t,r){this._name=e,this._callback=t,this._options=r}name(){return this._name}libraryName(){return this._options.libraryName}init(e){this._callback(e)}toJSON(){return{name:this._name,libraryName:this._options.libraryName,libraryImportPath:this._options.libraryImportPath}}}class nV{constructor(e){this.poly=e,this._pluginsByName=new Map,this._pluginNameByNodeContextByType=new Map,this._pluginNameByOperationContextByType=new Map}async wrapConfigurePolygonjs(e){this._configurePolygonjsPlugin=this._configurePolygonjsPlugin||new tV("configurePolygonjs",()=>{},{libraryImportPath:"../PolyConfig",libraryName:""}),this._currentPlugin=this._configurePolygonjsPlugin,this._pluginsByName.set(this._currentPlugin.name(),this._currentPlugin),await e(),this._currentPlugin=void 0}register(e){const t=this._currentPlugin;this._currentPlugin=e,this._pluginsByName.set(e.name(),e),e.init(this.poly),this._currentPlugin=t}pluginByName(e){return this._pluginsByName.get(e)}registerNode(e){if(!this._currentPlugin)return;const t=e.context(),r=e.type();let s=this._pluginNameByNodeContextByType.get(t);s||(s=new Map,this._pluginNameByNodeContextByType.set(t,s)),s.set(r,this._currentPlugin.name())}registerOperation(e){if(!this._currentPlugin)return;const t=e.context(),r=e.type();let s=this._pluginNameByOperationContextByType.get(t);s||(s=new Map,this._pluginNameByOperationContextByType.set(t,s)),s.set(r,this._currentPlugin.name())}toJson(){const e={plugins:{},nodes:{},operations:{}};return this._pluginsByName.forEach((t,r)=>{e.plugins[r]=t.toJSON()}),this._pluginNameByNodeContextByType.forEach((t,r)=>{e.nodes[r]={},t.forEach((s,i)=>{e.nodes[r][i]=s})}),this._pluginNameByOperationContextByType.forEach((t,r)=>{e.operations[r]={},t.forEach((s,i)=>{e.operations[r][i]=s})}),e}}class rV{constructor(e){this._cameraNodeTypes=[],this._registeredViewerCreateCallbackByCamera=new Map}registerNodeType(e){this._cameraNodeTypes.includes(e)||this._cameraNodeTypes.push(e)}registeredNodeTypes(){return this._cameraNodeTypes}register(e,t){this._registeredViewerCreateCallbackByCamera.set(e,t)}createViewer(e){const t=this._registeredViewerCreateCallbackByCamera.get(e.camera.constructor);if(!t){console.error("no createViewer callback available"),console.log("createViewer",e.camera,e.camera.constructor,this._registeredViewerCreateCallbackByCamera);return}return t(e)}objectRegistered(e){return this._registeredViewerCreateCallbackByCamera.get(e.constructor)!=null}}class sV{constructor(e){this.poly=e,this._moduleByName=new Map}register(e,t,r){let s=r==null?void 0:r.printWarnings;if(s==null&&(s=!0),this._moduleByName.has(e)&&s){console.warn("module already registered",e);return}this._moduleByName.set(e,t),t.onRegister(this.poly)}moduleNames(){const e=[];return this._moduleByName.forEach((t,r)=>{e.push(r)}),e}}class iV extends sV{}class oV{constructor(){this._methodsNames=[],this._methodsByName=new Map}register(e,t){this._methodsNames.push(t),this._methodsByName.set(t,e)}getMethod(e){return this._methodsByName.get(e)}availableMethods(){return this._methodsNames}}class aV extends oV{getMethod(e){return super.getMethod(e)}}var Rp=(n=>(n.GL_CLOTH="GL_CLOTH",n.GL_LINE="GL_LINE",n.GL_MESH_BASIC="GL_MESH_BASIC",n.GL_MESH_DEPTH="GL_MESH_DEPTH",n.GL_MESH_DISTANCE="GL_MESH_DISTANCE",n.GL_MESH_LAMBERT="GL_MESH_LAMBERT",n.GL_MESH_PHONG="GL_MESH_PHONG",n.GL_MESH_PHYSICAL="GL_MESH_PHYSICAL",n.GL_MESH_STANDARD="GL_MESH_STANDARD",n.GL_MESH_TOON="GL_MESH_TOON",n.GL_PARTICLES="GL_PARTICLES",n.GL_POINTS="GL_POINTS",n.GL_POST="GL_POST",n.GL_RAYMARCHING="GL_RAYMARCHING",n.GL_TEXTURE="GL_TEXTURE",n.GL_TEXTURE_2D_ARRAY="GL_TEXTURE_2D_ARRAY",n.GL_VOLUME="GL_VOLUME",n.JS_ACTOR="JS_ACTOR",n.JS_ENTITY_BUILDER="JS_ENTITY_BUILDER",n.JS_INSTANCE_BUILDER="JS_INSTANCE_BUILDER",n.JS_OBJECT_BUILDER="JS_OBJECT_BUILDER",n.JS_POINT_BUILDER="JS_POINT_BUILDER",n.JS_SDF="JS_SDF",n.JS_SOFT_BODY="JS_SOFT_BODY",n))(Rp||{});class cV{constructor(){this._controllerAssemblerByName=new Map}register(e,t,r){this._controllerAssemblerByName.set(e,{controller:t,assembler:r})}unregister(e){this._controllerAssemblerByName.delete(e)}traverse(e){this._controllerAssemblerByName.forEach(e)}}class lV extends cV{assembler(e,t){const r=this._controllerAssemblerByName.get(t);if(r){const{controller:s,assembler:i}=r;return new s(e,i)}return r}unregister(e){const t=this._controllerAssemblerByName.get(e);return super.unregister(e),t}}class Bs{constructor(e){this.poly=e,this._nodesRegister=new Map,this._nodesRegisterCategories=new Map,this._nodesRegisterOptions=new Map}static type(e){return this.filterType(e.type())}static filterType(e){return e.toLowerCase()}register(e,t,r){var s,i;const o=e.context(),a=Bs.type(e);let c=r==null?void 0:r.printWarnings;c==null&&(c=!0);let l=this._nodesRegister.get(o);if(l||(l=new Map,this._nodesRegister.set(o,l)),l.get(a)){const h=((i=(s=this._nodesRegisterOptions.get(o))==null?void 0:s.get(a))==null?void 0:i.polyNode)==!0,d=(r==null?void 0:r.polyNode)==!0;if(!(h&&d)){c&&console.warn(`node ${o}/${a} already registered`);return}}if(l.set(a,e),e.onRegister&&e.onRegister(this.poly),t){let h=this._nodesRegisterCategories.get(o);h||(h=new Map,this._nodesRegisterCategories.set(o,h));const d=_t(t)?t:[t];h.set(a,d)}if(r){let h=this._nodesRegisterOptions.get(o);h||(h=new Map,this._nodesRegisterOptions.set(o,h)),h.set(a,r)}this.poly.pluginsRegister.registerNode(e)}deregister(e,t){var r,s,i;t=Bs.filterType(t),(r=this._nodesRegister.get(e))==null||r.delete(t),(s=this._nodesRegisterCategories.get(e))==null||s.delete(t),(i=this._nodesRegisterOptions.get(e))==null||i.delete(t)}isRegistered(e,t){const r=this._nodesRegister.get(e);return r?(t=Bs.filterType(t),r.get(t)!=null):!1}nodeOptions(e,t){var r;return t=Bs.filterType(t),(r=this._nodesRegisterOptions.get(e))==null?void 0:r.get(t)}registeredNodesForParentNode(e){var t,r;const s=(t=e.childrenController)==null?void 0:t.context;if(!s)return[];if(this._nodesRegister.get(s)){const o=[];return(r=this._nodesRegister.get(s))==null||r.forEach((a,c)=>{o.push(a)}),o.filter(a=>{const c=Bs.type(a),l=this.nodeOptions(s,c);if(l){const u=this.nodeOptions(e.context(),e.type());if((u==null?void 0:u.polyNode)==!0)return!0;const h=l.only,d=l.except,p=`${e.context()}/${e.type()}`;return h?h.includes(p):d?!d.includes(p):!0}else return!0})}else return[]}registeredNodes(e){const t={},r=this.registeredNodesForParentNode(e);for(let s of r){const i=Bs.type(s);t[i]=s}return t}registeredCategory(e,t){var r;return t=Bs.filterType(t),(r=this._nodesRegisterCategories.get(e))==null?void 0:r.get(t)}map(){return this._nodesRegister}}class zd{constructor(e){this.poly=e,this._operation_register=new Map}static type(e){return this.filterType(e.type())}static filterType(e){return e.toLowerCase()}register(e,t){let r=t==null?void 0:t.printWarnings;r==null&&(r=!0);const s=e.context();let i=this._operation_register.get(s);i||(i=new Map,this._operation_register.set(s,i));const o=zd.type(e);if(i.get(o)){if(r){const c=`operation ${s}/${o} already registered`;console.warn(c)}return}i.set(o,e),e.onRegister&&e.onRegister(this.poly),this.poly.pluginsRegister.registerOperation(e)}registeredOperationsForContextAndParentType(e,t){var r;if(this._operation_register.get(e)){const i=[];return(r=this._operation_register.get(e))==null||r.forEach((o,a)=>{i.push(o)}),i}else return[]}registeredOperation(e,t){const r=this._operation_register.get(e);if(r)return t=zd.filterType(t),r.get(t)}}class uV{constructor(){this._functionByName=new Map}register(e,t){let r=t==null?void 0:t.printWarnings;r==null&&(r=!0);const s=e.type();this._functionByName.has(s)&&r&&console.warn("namedFunction already registered",s),this._functionByName.set(s,e)}}class hV extends uV{getFunction(e,t,r){const s=this._functionByName.get(e);return s||console.error(`function not registered:'${e}'`),new s(t,r)}}const dV="1.5.85";class yv{constructor(){this.renderersController=new bT(this),this.canvasRegister=new oU(this),this.scenesRegister=new hU,this.nodesRegister=new Bs(this),this.operationsRegister=new zd(this),this.expressionsRegister=new aV,this.assemblersRegister=new lV,this.pluginsRegister=new nV(this),this.camerasRegister=new rV(this),this.modulesRegister=new iV(this),this.namedFunctionsRegister=new hV,this.blobs=new cU(this),this.assetUrls=new lU,this.thirdParty=new fU,this.onObjectsAddRemoveHooks=new JG,this.onSceneUpdatedHooks=new QG,this.specializedChildren=new eV,this.performance=new uU,this.scenesByUuid={},this._playerMode=!0,this._logger=null}static _instance_(){if(globalThis.__POLYGONJS_POLY_INSTANCE__)return globalThis.__POLYGONJS_POLY_INSTANCE__;{const e=new yv;return globalThis.__POLYGONJS_POLY_INSTANCE__=e,globalThis.__POLYGONJS_POLY_INSTANCE__}}version(){return dV}setPlayerMode(e){this._playerMode=e}playerMode(){return this._playerMode}dispose(){this.scenesRegister.dispose(),this.renderersController.dispose()}registerNode(e,t,r){this.nodesRegister.register(e,t,r)}registerOperation(e,t){this.operationsRegister.register(e,t)}registerNamedFunction(e,t){this.namedFunctionsRegister.register(e,t)}registerCamera(e,t){this.camerasRegister.register(e,t)}registerCameraNodeType(e){this.camerasRegister.registerNodeType(e)}registerPlugin(e){this.pluginsRegister.register(e)}wrapConfigurePolygonjs(e){this.pluginsRegister.wrapConfigurePolygonjs(e)}registeredNodes(e){return this.nodesRegister.registeredNodes(e)}registeredOperation(e,t){return this.operationsRegister.registeredOperation(e,t)}registerModule(e,t){this.modulesRegister.register(e.moduleName,e,t)}inWorkerThread(){return!1}get libs(){return this._libs_controller=this._libs_controller||new aU}setEnv(e){this._env=e}env(){return this._env}setLogger(e){this._logger=e}logger(){return this._logger}log(e,...t){var r;(r=this._logger)==null||r.log(e,...t)}warn(e,...t){var r;(r=this._logger)==null||r.warn(e,...t)}error(e,...t){var r;(r=this._logger)==null||r.error(e,...t)}}const ve=yv._instance_();class pV{constructor(e){this.node=e,this._dirtyCount=0,this._dirty=!0,this._cooker=e.scene().cooker}dispose(){this._postDirtyHooks=void 0,this._postDirtyHookNames=void 0}isDirty(){return this._dirty===!0}dirtyTimestamp(){return this._dirtyTimestamp}dirtyCount(){return this._dirtyCount}hasPostDirtyHooks(){return this._postDirtyHookNames!=null&&this._postDirtyHookNames.length>0}addPostDirtyHook(e,t){this._postDirtyHookNames=this._postDirtyHookNames||[],this._postDirtyHooks=this._postDirtyHooks||[],this._postDirtyHookNames.includes(e)?console.warn(`hook with name ${e} already exists`,this.node):(this._postDirtyHookNames.push(e),this._postDirtyHooks.push(t))}removePostDirtyHook(e){if(this._postDirtyHookNames&&this._postDirtyHooks){const t=this._postDirtyHookNames.indexOf(e);t>=0&&(this._postDirtyHookNames.splice(t,1),this._postDirtyHooks.splice(t,1))}}hasHook(e){return this._postDirtyHookNames?this._postDirtyHookNames.includes(e):!1}removeDirtyState(){this._dirty=!1}setDirty(e,t=!0){e==null&&(e=this.node),!(e==this.node&&this.node.selfDirtyForbidden())&&(this._dirty=!0,this._dirtyTimestamp=ve.performance.performanceManager().now(),this._dirtyCount+=1,this.runPostDirtyHooks(e),t===!0&&this.setSuccessorsDirty(e))}runPostDirtyHooks(e){if(!(this._postDirtyHooks==null||this._postDirtyHooks.length==0))if(this._cooker.blocked())this._cooker.enqueue(this.node,e);else for(const t of this._postDirtyHooks)t(e)}setSuccessorsDirty(e){e==null&&(e=this.node),this._cooker.block();const t=this.node.graphAllSuccessors();for(const r of t)r.dirtyController.setDirty(e,!1);this._cooker.unblock()}}class _r{constructor(e,t){this._scene=e,this._name=t,this._dirtyController=new pV(this),this._allPredecessors=[],this._allSuccessors=[],this._allPredecessorsDirty=!0,this._allSuccessorsDirty=!0,this._disposed=!1,this._graphNodeId=e.graph.nextId(),e.graph.addNode(this),this._graph=e.graph}dispose(){this._dirtyController.dispose(),this._allPredecessors.length=0,this._allSuccessors.length=0,this.graphRemove(),this._disposed=!0}disposed(){return this._disposed}name(){return this._name}setName(e){this._name=e}scene(){return this._scene}graphNodeId(){return this._graphNodeId}get dirtyController(){return this._dirtyController}setDirty(e){e=e||this,this._dirtyController.setDirty(e)}setSuccessorsDirty(e){this._dirtyController.setSuccessorsDirty(e)}removeDirtyState(){this._dirtyController.removeDirtyState()}isDirty(){return this._dirtyController.isDirty()}addPostDirtyHook(e,t){this._dirtyController.addPostDirtyHook(e,t)}removePostDirtyHook(e){this._dirtyController.removePostDirtyHook(e)}graphRemove(){this._graph.removeNode(this)}addGraphInput(e,t=!0){return this._graph.connect(e,this,t)}removeGraphInput(e){this._graph.disconnect(e,this)}graphDisconnectPredecessors(){this._graph.disconnectPredecessors(this)}graphDisconnectSuccessors(){this._graph.disconnectSuccessors(this)}graphPredecessorIds(){return this._graph.predecessorIds(this._graphNodeId)}graphPredecessors(){return this._graph.predecessors(this)}graphSuccessorIds(){return this._graph.successorIds(this._graphNodeId)}graphSuccessors(){return this._graph.successors(this)}_clearAllPredecessors(){this._allPredecessorsDirty=!0}_clearAllSuccessors(){this._allSuccessorsDirty=!0}graphAllPredecessors(){return this._allPredecessorsDirty&&(this._graph.allPredecessors(this,this._allPredecessors),this._allPredecessorsDirty=!1),this._allPredecessors}graphAllSuccessors(){return this._allSuccessorsDirty&&(this._graph.allSuccessors(this,this._allSuccessors),this._allSuccessorsDirty=!1),this._allSuccessors}hasPredecessor(e){return this.graphAllPredecessors().includes(e)}clearCachesWithPredecessorsAndSuccessors(){const e=this.graphAllPredecessors(),t=this.graphAllSuccessors();for(const r of e)r._clearAllSuccessors();for(const r of t)r._clearAllPredecessors();this._clearAllPredecessors(),this._clearAllSuccessors()}setForbiddenTriggerNodes(e){this._graph.setForbiddenTriggerNodes(this,e),this._clearAllSuccessors()}clearForbiddenTriggerNodes(){this._graph.clearForbiddenTriggerNodes(this),this._clearAllSuccessors()}setSelfDirtyForbidden(e){this._graph.setSelfDirtyForbidden(this,e)}selfDirtyForbidden(){return this._graph.selfDirtyForbidden(this)}}var Cn=(n=>(n.VISIBLE_UPDATED="param_visible_updated",n.EDITABLE_UPDATED="param_editable_updated",n.RAW_INPUT_UPDATED="raw_input_updated",n.VALUE_UPDATED="param_value_updated",n.EXPRESSION_UPDATED="param_expression_update",n.ERROR_UPDATED="param_error_updated",n.DELETED="param_deleted",n.ASSET_RELOAD_REQUEST="param_asset_reload_request",n))(Cn||{}),Ys=(n=>(n.NONE="no conversion",n.SRGB_TO_LINEAR="sRGB -> linear",n.LINEAR_TO_SRGB="linear -> sRGB",n))(Ys||{});const Vc="callback",Wf="callbackString",fV="computeOnDirty",mV="cook",_V="fileBrowse",gV="extensions",vV="expression",yV="forEntities",xV="label",Lb="hideLabel",bV="level",CV="menu",EV="menuString",Fb="entries",SV="multiline",AV="language",TV="nodeSelection",MV="context",RV="types",Xf="objectMask",wV="inputIndex",Ub="dependentOnFoundNode",kb="dependentOnFoundParam",OV="range",PV="rangeLocked",NV="step",IV="spare",DV="texture",LV="env",Bb="hidden",FV="field",$f="visibleIf",UV="conversion",kV="separatorBefore",BV="separatorAfter",GV="joinToPreviousParam",VV="asQuaternion",_d="editable",zV=[_d];class Gb{constructor(e){this._param=e,this._programaticVisibleState=!0,this._callbackAllowed=!1,this._updateVisibilityAndRemoveDirtyBound=this.updateVisibilityAndRemoveDirty.bind(this),this._ui_data_dependency_set=!1}dispose(){var e;try{this._options[Vc]=void 0,this._options[Wf]=void 0}catch{}(e=this._visibility_graph_node)==null||e.dispose()}set(e){Ke(e)&&console.warn("options input invalid",e,typeof e),this._default_options=e,this._options=Ii(this._default_options),this.postSetOptions()}copy(e){this._default_options=Ii(e.default()),this._options=Ii(e.current()),this.postSetOptions()}setOption(e,t){if(this._validateOption(e,t)&&(this._options[e]=t,this._param.components))for(const r of this._param.components)r.options.setOption(e,t)}_validateOption(e,t){return e==Vc?bp(t):!0}postSetOptions(){this._handleComputeOnDirty()}param(){return this._param}node(){return this._param.node}default(){return this._default_options}current(){return this._options}hasOptionsOverridden(){return!Ob(this._options,this._default_options)}overriddenOptions(){const e={},t=Object.keys(this._options),r=[];tM(t,zV,r);for(const s of r)if(!Ob(this._options[s],this._default_options[s])){const i=Ii(this._options[s]);Object.assign(e,{[s]:i})}return e}overriddenOptionNames(){return Object.keys(this.overriddenOptions())}computeOnDirty(){return this._options[fV]||!1}_handleComputeOnDirty(){this.computeOnDirty()&&(this._computeOnDirtyCallbackAdded||(this.param().addPostDirtyHook("computeOnDirty",this._computeParam.bind(this)),this._computeOnDirtyCallbackAdded=!0))}async _computeParam(){await this.param().compute()}hasCallback(){return this._options[Vc]!=null||this._options[Wf]!=null}allowCallback(){this._callbackAllowed=!0}async executeCallback(){if(!this._callbackAllowed)return;const e=this.node();if(!e)return;const t=e.scene();if(!t)return;const r=this.getCallback(e,t);if(!r||!t.loadingController.loaded())return;const s=this.param().parentParam();s?s.options.executeCallback():await r(e,this.param())}getCallback(e,t){if(this.hasCallback())return this._options[Vc]=this._options[Vc]||this.createCallbackFromString(e,t)}createCallbackFromString(e,t){const r=this._options[Wf];if(r){const s=new Function("node","scene","window","location",r);return()=>{s(e,t,null,null)}}}colorConversion(){return this._options[UV]||Ys.NONE}makesNodeDirtyWhenDirty(){if(this.param().parentParam()!=null)return!1;const e=this._options[mV];return e??!0}fileBrowseOption(){return this._options[_V]}fileBrowseAllowed(){return this.fileBrowseOption()!=null}fileBrowseExtensions(){const e=this.fileBrowseOption();return e?e[gV]:null}separatorBefore(){return this._options[kV]}separatorAfter(){return this._options[BV]}joinToPreviousParam(){return this._options[GV]}setEditableState(e){const t=this._options[_d],r=this.param();if(t!=e&&(this._options[_d]=e,r.emit(Cn.EDITABLE_UPDATED)),r.components)for(const s of r.components)s.options.setEditableState(e)}editable(){const e=this._options[_d];return e??!0}isExpressionForEntities(){const e=this._options[vV];return e&&e[yV]||!1}level(){return this._options[bV]||0}hasMenu(){return this.menuOptions()!=null||this.menuStringOptions()!=null}menuOptions(){return this._options[CV]}menuStringOptions(){return this._options[EV]}menuEntries(){const e=this.menuOptions()||this.menuStringOptions();return e?e[Fb]:[]}ensureValueInMenuEntries(e){const t=this.menuOptions();if(!t)return e;const r=t[Fb];if(r.length==0)return e;for(const s of r)if(e==s.value)return e;return r[0].value}isMultiline(){return this._options[SV]===!0}language(){return this._options[AV]}isCode(){return this.language()!=null}nodeSelectionOptions(){return this._options[TV]}nodeSelectionContext(){const e=this.nodeSelectionOptions();if(e)return e[MV]}nodeSelectionTypes(){const e=this.nodeSelectionOptions();if(e)return e[RV]}displayObjectMaskSelection(){const e=this._options[Xf];return e!=null&&e!=!1}objectMaskInputIndex(){const e=this._options[Xf];return(e!=null?e[wV]:0)||0}objectMaskFromInputOnly(){return this._options[Xf].fromInputOnly!=!1}dependentOnFoundNode(){return Ub in this._options?this._options[Ub]:!0}dependentOnFoundParam(){return kb in this._options?this._options[kb]:!0}isSelectingParam(){return this.param().type()==J.PARAM_PATH}range(){return this._options[OV]||[0,1]}step(){return this._options[NV]}asQuaternion(){return this._options[VV]==!0}rangeLocked(){return this._options[PV]||[!1,!1]}ensureInRange(e){const t=this.range();return e>=t[0]&&e<=t[1]?e:e<t[0]?this.rangeLocked()[0]===!0?t[0]:e:this.rangeLocked()[1]===!0?t[1]:e}isSpare(){return this._options[IV]||!1}textureOptions(){return this._options[DV]}textureAsEnv(){const e=this.textureOptions();return e!=null?e[LV]===!0:!1}isHidden(){return this._options[Bb]===!0||this._programaticVisibleState===!1}isVisible(){return!this.isHidden()}setVisibleState(e){this._options[Bb]=!e,this.param().emit(Cn.VISIBLE_UPDATED)}label(){return this._options[xV]}isLabelHidden(){switch(this.param().type()){case J.BUTTON:return!0;case J.BOOLEAN:return this.isFieldHidden();case J.RAMP:return this._options[Lb]||!1;case J.STRING:return this.isCode()&&this._options[Lb]||!1}return!1}isFieldHidden(){return this._options[FV]===!1}uiDataDependsOnOtherParams(){return $f in this._options}visibilityPredecessors(){const e=this._options[$f];if(!e)return[];let t=[];_t(e)?Zs(e.map(i=>Object.keys(i)).flat(),t):t=Object.keys(e);const r=this.param().node,s=[];return Js(t.map(i=>{const o=r.params.get(i);if(o)return o;console.error(`param ${i} not found as visibility condition for ${this.param().name()} in node ${this.param().node.type()}`)}),s),s}setUiDataDependency(){if(this._ui_data_dependency_set)return;this._ui_data_dependency_set=!0;const e=this.visibilityPredecessors();if(e.length>0){this._visibility_graph_node=new _r(this.param().scene(),"param_visibility");for(const t of e)this._visibility_graph_node.addGraphInput(t);this._visibility_graph_node.addPostDirtyHook("_update_visibility_and_remove_dirty",this._updateVisibilityAndRemoveDirtyBound)}}updateVisibilityAndRemoveDirty(){this.updateVisibility(),this.param().removeDirtyState()}async updateVisibility(){const e=this._options[$f];if(e){const t=this.param().node,r=this.visibilityPredecessors(),s=r.map(i=>{if(i.isDirty())return i.compute()});if(this._programaticVisibleState=!1,await Promise.all(s),_t(e))for(const i of e){const o=Object.keys(i),a=[];Js(o.map(l=>t.params.get(l)),a),a.filter(l=>l.value==i[l.name()]).length==a.length&&(this._programaticVisibleState=!0)}else{const i=r.filter(o=>o.value==e[o.name()]);this._programaticVisibleState=i.length==r.length}this.param().emit(Cn.VISIBLE_UPDATED)}}}class Vb{constructor(e){this.param=e,this._blockedEmit=!1,this._blockedParentEmit=!1,this._countByEventName=new Map}emitAllowed(){return this._blockedEmit===!0||this.param.scene().loadingController.isLoading()?!1:this.param.scene().dispatchController.emitAllowed()}blockEmit(){if(this._blockedEmit=!0,this.param.isMultiple()&&this.param.components)for(const e of this.param.components)e.emitController.blockEmit();return!0}unblockEmit(){if(this._blockedEmit=!1,this.param.isMultiple()&&this.param.components)for(const e of this.param.components)e.emitController.unblockEmit();return!0}blockParentEmit(){return this._blockedParentEmit=!0,!0}unblockParentEmit(){return this._blockedParentEmit=!1,!0}incrementCount(e){const t=(this._countByEventName.get(e)||0)+1;this._countByEventName.set(e,t)}eventsCount(e){return this._countByEventName.get(e)||0}emit(e){if(this.emitAllowed()){this.param.emit(e);const t=this.param.parentParam();t!=null&&this._blockedParentEmit!==!0&&t.emit(e)}}}class HV{constructor(e){this.param=e}active(){var e;const t=this.param.scene().timeController.graphNode.graphNodeId();return((e=this.param.graphPredecessorIds())==null?void 0:e.includes(t))||!1}}class jV{constructor(e){this.param=e}set(e){this._message!=e&&(e?ve.error(`[${this.param.path()}] error: '${e}'`):ve.warn(`[${this.param.path()}] clear error`),this._message=e,this.param.emitController.emit(Cn.ERROR_UPDATED))}message(){return this._message}clear(){this.set(void 0)}active(){return this._message!=null}}class WV{constructor(e){this.param=e,this.timeDependent=new HV(this.param),this.error=new jV(this.param)}}class wp extends _r{constructor(e,t,r){var s;super(e.scene(),"MethodDependency"),this.param=e,this.pathArgs=t,this.decomposedPath=r,this._updateFromNameChangeBound=this._updateFromNameChange.bind(this),(s=e.expressionController)==null||s.registerMethodDependency(this),this.addPostDirtyHook("_updateFromNameChange",this._updateFromNameChangeBound)}_updateFromNameChange(e){if(e&&this.decomposedPath){const t=e;this.decomposedPath.updateFromNameChange(t);const r=this.decomposedPath.toPath(),s=this.jsep_node,{indexOrPath:i}=this.pathArgs;s&&Ke(i)&&(s.value=`${s.value}`.replace(`${i}`,r),s.raw=s.raw.replace(`${i}`,r)),this.param.expressionController&&this.param.expressionController.updateFromMethodDependencyNameChange()}}reset(){this.graphDisconnectPredecessors()}listen_for_name_changes(){if(this.jsep_node&&this.decomposedPath){const e=[];this.decomposedPath.namedNodes(e);for(const t of e)if(t){const r=t;r.nameController&&this.addGraphInput(r.nameController.graphNode())}}}set_jsep_node(e){this.jsep_node=e}set_resolved_graph_node(e){this.resolved_graph_node=e}set_unresolved_path(e){this.unresolved_path=e}static create(e,t,r,s){const i=new wp(e,t,s);if(r)i.set_resolved_graph_node(r);else{const{indexOrPath:o}=t;Ke(o)&&i.set_unresolved_path(o)}return i}}const XV=[];class Yi extends _r{constructor(e,t,r){super(e,"BaseParam"),this._options=new Gb(this),this._emitController=new Vb(this),this._isComputing=!1,r.serializerClass&&(this._serializer=new r.serializerClass(this)),this._node=t,this._initializeParam()}get options(){return this._options=this._options||new Gb(this)}get emitController(){return this._emitController=this._emitController||new Vb(this)}get expressionController(){return this._expression_controller}expressionParsedAsString(){return!1}get serializer(){return this._serializer}get states(){return this._states=this._states||new WV(this)}dispose(){var e,t;this.expressionController&&this.hasExpression()&&this.set(this.rawInputSerialized());const r=[],s=this.graphPredecessors();if(s){Ts(s,r);for(const o of r)o instanceof wp&&o.dispose()}const i=this.graphSuccessors();if(i){Ts(i,r);for(const o of r)if(o instanceof Yi){const a=o.rawInputSerialized();o.set(o.defaultValue()),o.set(a)}else o.setDirty()}this.scene().missingExpressionReferencesController.deregisterParam(this),(e=this._expression_controller)==null||e.dispose(),super.dispose(),(t=this._options)==null||t.dispose(),this._node=void 0,this._parent_param=void 0,this._runOnDisposeCallbacks()}_initializeParam(){}postOptionsInitialize(){}static type(){return J.FLOAT}type(){return this.constructor.type()}isNumeric(){return!1}setName(e){super.setName(e)}get value(){return this._value}copyValue(e){e.type()==this.type()?this._copyValue(e):console.warn(`cannot copy value from ${e.type()} to ${this.type()}`)}_copyValue(e){throw"abstract method param._copy_value"}valuePreConversionSerialized(){}convert(e){return null}static areRawInputEqual(e,t){return!1}isRawInputEqual(e){return this.constructor.areRawInputEqual(this._raw_input,e)}isDefaultValueEqual(e){return this.constructor.areRawInputEqual(this._default_value,e)}static areValuesEqual(e,t){return!1}isValueEqual(e){return this.constructor.areValuesEqual(this.value,e)}_cloneRawInput(e){return e}set(e){this._raw_input=this._cloneRawInput(this._prefilterInvalidRawInput(e)),this.emitController.emit(Cn.RAW_INPUT_UPDATED),this.processRawInput()}_prefilterInvalidRawInput(e){return e}defaultValue(){return this._default_value}isDefault(){return this._raw_input==this._default_value}rawInput(){return this._raw_input}processRawInput(){}isComputing(){return this._isComputing}async compute(){if(this.scene().loadingController.isLoading()&&ve.warn(`param attempt to compute ${this.path()} while scene is loading`),this.isDirty()){if(this._isComputing)return new Promise((e,t)=>{this._computeResolves=this._computeResolves||[],this._computeResolves.push(e)});if(this._isComputing=!0,await this.processComputation(),this._isComputing=!1,this._computeResolves){const e=[...this._computeResolves];this._computeResolves=void 0;for(const t of e)t()}}}async processComputation(){}setInitValue(e){this._default_value=this._cloneRawInput(this._prefilterInvalidRawInput(e))}_setupNodeDependencies(e){var t,r;if(e?(this.options.allowCallback(),this.parentParam()||(this.options.makesNodeDirtyWhenDirty()?(r=e.params.params_node)==null||r.addGraphInput(this,!1):this.dirtyController.addPostDirtyHook("run callback",async()=>{await this.compute(),await this.options.executeCallback()}))):this._node&&((t=this._node.params.params_node)==null||t.removeGraphInput(this)),this.components)for(const s of this.components)s._setupNodeDependencies(e)}get node(){return this._node}parent(){return this.node}set_parent_param(e){e.addGraphInput(this,!1),this._parent_param=e}parentParam(){return this._parent_param}has_parent_param(){return this._parent_param!=null}path(){var e;return((e=this.node)==null?void 0:e.path())+"/"+this.name()}pathRelativeTo(e){if(!this._node)return this.name();const t=bt.relativePath(e,this._node);return t.length>0?bt.sanitizePath(`${t}${bt.SEPARATOR}${this.name()}`):this.name()}emit(e){this.emitController.emitAllowed()&&(this.emitController.incrementCount(e),this.scene().dispatchController.dispatch(this,e))}get components(){return this._components}componentNames(){return XV}isMultiple(){return this.componentNames().length>0}initComponents(){}hasExpression(){return this.expressionController!=null&&this.expressionController.active()}toJSON(){if(this._serializer)return this._serializer.toJSON()}onDispose(e){this._onDisposeCallbacks=this._onDisposeCallbacks||new Set,this._onDisposeCallbacks.add(e)}deregisterOnDispose(e){this._onDisposeCallbacks&&this._onDisposeCallbacks.delete(e)}_runOnDisposeCallbacks(){this._onDisposeCallbacks&&(this._onDisposeCallbacks.forEach(e=>{e()}),this._onDisposeCallbacks.clear(),this._onDisposeCallbacks=void 0)}}class zi{constructor(e=0,t=0){this._position=e,this._value=t}toJSON(){return{position:this._position,value:this._value}}position(){return this._position}value(){return this._value}copy(e){this._position=e.position(),this._value=e.value()}clone(){const e=new zi;return e.copy(this),e}isEqual(e){return this._position==e.position()&&this._value==e.value()}isEqualJSON(e){return this._position==e.position&&this._value==e.value}fromJSON(e){this._position=e.position,this._value=e.value}static areEqualJSON(e,t){return e.position==t.position&&e.value==t.value}static fromJSON(e){return new zi(e.position,e.value)}}var MM=(n=>(n.CUBIC="cubic",n))(MM||{});class Ln{constructor(e="cubic",t=[]){this._interpolation=e,this._points=t,this._uuid=On.generateUUID()}uuid(){return this._uuid}interpolation(){return this._interpolation}points(){return this._points}static createInterpolantFromValues(e,t){const s=new Float32Array(1);return new JF(e,t,1,s)}createInterpolant(){return Ln.createInterpolant(this)}static createInterpolant(e){const t=e.points(),r=w_(t,a=>a.position()),s=new Float32Array(r.length),i=new Float32Array(r.length);let o=0;for(const a of r)s[o]=a.position(),i[o]=a.value(),o++;return this.createInterpolantFromValues(s,i)}static fromJSON(e){const t=[];for(const s of e.points)t.push(zi.fromJSON(s));let r=e.interpolation;return(r==null||r=="")&&(r="cubic"),new Ln(r,t)}toJSON(){return{interpolation:this._interpolation,points:this._points.map(e=>e.toJSON())}}clone(){const e=new Ln;return e.copy(this),e}copy(e){this._interpolation=e.interpolation();const t=e.points().length,r=this._points.length;if(r>t){const i=r-t,o=r-i;this._points.splice(o,i)}let s=0;for(const i of e.points()){const o=this._points[s];o?o.copy(i):this._points.push(i.clone()),s+=1}}isEqual(e){if(this._interpolation!=e.interpolation())return!1;const t=e.points();if(this._points.length!=t.length)return!1;let r=0;for(const s of this._points){const i=t[r];if(!s.isEqual(i))return!1;r+=1}return!0}isEqualJSON(e){if(this._interpolation!=e.interpolation||this._points.length!=e.points.length)return!1;let t=0;for(const r of this._points){const s=e.points[t];if(!r.isEqualJSON(s))return!1;t+=1}return!0}static are_json_equal(e,t){if(e.interpolation!=t.interpolation||e.points.length!=t.points.length)return!1;let r=0;for(const s of e.points){const i=t.points[r];if(!zi.areEqualJSON(s,i))return!1;r+=1}return!0}fromJSON(e){this._interpolation=e.interpolation;const t=e.points.length,r=this._points.length;if(r>t){const i=r-t,o=r-i;this._points.splice(o,i)}let s=0;for(const i of e.points){const o=this._points[s];o?o.fromJSON(i):this._points.push(zi.fromJSON(i)),s+=1}}}const zb=4,k_=1024,RM=1,Hb=k_*RM,$V=1,wM=class extends Yi{constructor(){super(...arguments),this._textureData=new Float32Array(zb*Hb),this._rampTexture=new xc(this._textureData,k_,RM,fn,jn)}static type(){return J.RAMP}defaultValueSerialized(){return this._default_value instanceof Ln?this._default_value.toJSON():this._default_value}_cloneRawInput(n){return n instanceof Ln?n.clone():Ln.fromJSON(n).toJSON()}rawInputSerialized(){return this._raw_input instanceof Ln?this._raw_input.toJSON():Ln.fromJSON(this._raw_input).toJSON()}valueSerialized(){return this.value.toJSON()}_copyValue(n){this.set(n.valueSerialized())}static areRawInputEqual(n,e){return n instanceof Ln?e instanceof Ln?n.isEqual(e):n.isEqualJSON(e):e instanceof Ln?e.isEqualJSON(n):Ln.are_json_equal(n,e)}static areValuesEqual(n,e){return n.isEqual(e)}isDefault(){return this._default_value instanceof Ln?this.value.isEqual(this._default_value):this.value.isEqualJSON(this._default_value)}processRawInput(){this._raw_input instanceof Ln?this._value?this._value.copy(this._raw_input):this._value=this._raw_input:this._value?this._value.fromJSON(this._raw_input):this._value=Ln.fromJSON(this._raw_input),this._resetRampInterpolant(),this._updateRampTexture(),this.options.executeCallback(),this.emitController.emit(Cn.VALUE_UPDATED),this.setSuccessorsDirty(this)}hasExpression(){return!1}_resetRampInterpolant(){this._rampInterpolant=void 0}rampTexture(){return this._rampTexture}_updateRampTexture(){this._updateRampTextureData(),this.rampTexture().needsUpdate=!0}_updateRampTextureData(){let n=0,e=0,t=0;for(var r=0;r<Hb;r++)n=r*zb,e=r/k_,t=this.valueAtPosition(e),this._textureData[n+0]=t*$V,this._textureData[n+1]=0,this._textureData[n+2]=0}interpolant(){return this._rampInterpolant=this._rampInterpolant||this._createInterpolant()}_createInterpolant(){return this.value.createInterpolant()}valueAtPosition(n){return this.interpolant().evaluate(n)[0]}};let vs=wM;vs.DEFAULT_VALUE=new Ln(MM.CUBIC,[new zi(0,0),new zi(1,1)]);vs.DEFAULT_VALUE_JSON=wM.DEFAULT_VALUE.toJSON();class Jn{constructor(e,t,r){this.type=e,this.init_value=t,this.options=r}}class A{static BUTTON(e,t){return new Jn(J.BUTTON,e,t)}static BOOLEAN(e,t){return new Jn(J.BOOLEAN,e,t)}static COLOR(e,t){return e instanceof xe&&(e=e.toArray()),new Jn(J.COLOR,e,t)}static FLOAT(e,t){return new Jn(J.FLOAT,e,t)}static FOLDER(e=null,t){return new Jn(J.FOLDER,e,t)}static INTEGER(e,t){return new Jn(J.INTEGER,e,t)}static RAMP(e=vs.DEFAULT_VALUE,t){return new Jn(J.RAMP,e,t)}static STRING(e="",t){return new Jn(J.STRING,e,t)}static VECTOR2(e,t){return e instanceof W&&(e=e.toArray()),new Jn(J.VECTOR2,e,t)}static VECTOR3(e,t){return e instanceof T&&(e=e.toArray()),new Jn(J.VECTOR3,e,t)}static VECTOR4(e,t){return e instanceof We&&(e=e.toArray()),new Jn(J.VECTOR4,e,t)}static NODE_PATH(e,t){return new Jn(J.NODE_PATH,e,t)}static PARAM_PATH(e,t){return new Jn(J.PARAM_PATH,e,t)}}class Et{}class qV extends Et{constructor(){super(...arguments),this.group=A.STRING("*",{objectMask:!0})}}class jb{constructor(e){this.nodes=e,this._remaining=new Set,Il.debugLoadProgress()&&console.log(e),this.totalCount=e.length,this._processed=new Set,gs(e,this._remaining)}markNodeAsProcessed(e){this._processed.add(e),this._remaining.delete(e),Il.debugLoadProgress()&&console.log("markNodeAsProcessed",e.path(),{processed:rr(this._processed,[]).map(t=>t.path()),remaining:rr(this._remaining,[]).map(t=>t.path())})}isNodeProcessed(e){return this._processed.has(e)}processedCount(){return this._processed.size}}function YV(n){return class extends n{constructor(){super(...arguments),this.nodesMask=A.STRING("*/image* */envMap*",{cook:!1,separatorBefore:!0,objectMask:!1}),this.printNodes=A.BUTTON(null,{cook:!1,callback:t=>{No.PARAM_CALLBACK_printResolve(t)}})}}}class No{constructor(e){this.node=e}static async PARAM_CALLBACK_printResolve(e){const t=await e.loadProgress.resolvedNodes();console.log(t);const r=t.map(s=>s.path()).sort();console.log(r)}async resolvedNodes(){const e=this.node.p.nodesMask;e.isDirty()&&await e.compute();const t=e.value,s=this.node.scene().nodesController.nodesFromMask(t||""),i=await this._loadDisplayNodes(),o=[];return Zs(s.concat(i),o),o}async _loadDisplayNodes(){const e=this.node.scene(),r=ve.camerasRegister.registeredNodeTypes().map(c=>e.nodesByType(c)).flat(),s=this._displayNodes(),i=r.concat(s),o=await this.cameraCreatorNode();o&&i.push(o);const a=[];return Zs(i,a),a}_displayNodes(){const e=this._objectNodesWithDisplayNodeController(),t=[];return Js(e.map(r=>r.displayNodeController.firstNonBypassedDisplayNode()),t),t}_objectNodesWithDisplayNodeController(){return this.node.scene().root().children().filter(r=>r.displayNodeController!=null).filter(r=>{var s,i;return(i=(s=r.flags)==null?void 0:s.display)==null?void 0:i.active()})}cameraCreatorNode(){return this.node.mainCameraController.cameraCreatorNode()}_runCallback(e,t){this._debug2("_runCallback",{progress:e,nodeTrigger:t}),this._onProgressUpdateCallback&&this._nodeGroups&&(this._debug2("_onProgressUpdateCallback",this._nodeGroups),this._onProgressUpdateCallback(e,{scene:this.node.scene(),triggerNode:void 0,groups:this._nodeGroups}))}_updateProgressAndRunCallback(e){if(!(this._onProgressUpdateCallback&&this._nodeGroups))return;const t=this._nodeGroups.toCook.totalCount+this._nodeGroups.sopGroupToUpdate.totalCount,s=(this._nodeGroups.toCook.processedCount()+this._nodeGroups.sopGroupToUpdate.processedCount())/t;this._runCallback(s,e)}async watchNodesProgress(e){this._onProgressUpdateCallback=e;const r=(await this.resolvedNodes()).filter(o=>o.isDirty());this._debug({nodesToCook:r});const s=this._objectNodesWithDisplayNodeController().filter(o=>{var a;const c=o.displayNodeController.displayNode();return c!=null&&!((a=c.flags.bypass)!=null&&a.active())}).filter(o=>o.isDirty());this._debug({nodesToUpdateSopGroup:s}),this._nodeGroups={toCook:new jb(r),sopGroupToUpdate:new jb(s)};const i=this._nodeGroups.toCook.totalCount+this._nodeGroups.sopGroupToUpdate.totalCount;if(this._debug({totalNodesCount:i}),i==0){this._runCallback(1);return}this._watchNodesWithSopGroup(),this._watchNodesToCook()}async _watchNodesToCook(){var e;const t=(e=this._nodeGroups)==null?void 0:e.toCook;if(!t)return;const r="RootLoadProgressController",s=i=>{t.isNodeProcessed(i)||(t.markNodeAsProcessed(i),this._updateProgressAndRunCallback(i),i.cookController.deregisterOnCookEnd(r))};for(const i of t.nodes)i.cookController.registerOnCookEnd(r,()=>{this._debug2("nodeToCook - completed",i.path()),s(i)}),this._debug2("nodeToCook - start",i.path()),i.compute()}_watchNodesWithSopGroup(){var e;const t=(e=this._nodeGroups)==null?void 0:e.sopGroupToUpdate;if(!t)return;const r="RootLoadProgressController",s=i=>{t.isNodeProcessed(i)||(t.markNodeAsProcessed(i),this._updateProgressAndRunCallback(i),i.childrenDisplayController.deregisterOnSopGroupUpdated(r))};for(const i of t.nodes){const o=i.childrenDisplayController;this._debug2("nodeWithSopGroup - watch",i.path()),o.registerOnSopGroupUpdated(r,()=>{this._debug2("nodeWithSopGroup - completed",i.path()),s(i)})}}static debugActive(){return Il.debugLoadProgress()}static debug(e){this.debugActive()&&console.log(e)}static debug2(e,t){this.debugActive()&&console.log(e,t)}_debug(e){No.debug(e)}_debug2(e,t){No.debug2(e,t)}}var po=(n=>(n.MAX_FRAME_UPDATED="scene_maxFrameUpdated",n.REALTIME_STATUS_UPDATED="scene_realtime_status_updated",n.FRAME_UPDATED="scene_frame_updated",n.PLAY_STATE_UPDATED="scene_play_state_updated",n))(po||{});class Op extends Event{constructor(e){super(e)}get type(){return super.type}}const KV={event:new Op(wi.SCENE_CREATED)},ZV={event:new Op(wi.SCENE_READY)},JV={event:new Op(wi.SCENE_PLAY)},QV={event:new Op(wi.SCENE_PAUSE)};class ez{constructor(){this._observersByEventType=new Map}dispatch(e){const t=e.event;if(!t)return;const r=this._observersByEventType.get(t.type);r&&r.forEach(s=>{s.processEvent(e)})}removeObserverFromAllEventTypes(e){this._observersByEventType.forEach((t,r)=>{t.delete(e)})}addObserver(e,t){fr(this._observersByEventType,t,e)}}const Wb=60,tz=60,Xb=.1,nz={updateClockDelta:!1},Ia=class{constructor(n){this.scene=n,this._frame=0,this._timeUniform=Pr(0),this._timeDeltaUniform=Pr(0),this._realtimeState=!0,this._maxFrame=600,this._maxFrameLocked=!1,this._playing=!1,this._clock=new rU,this._playAllowedWithoutAllNodesCooked=!0,this._onBeforeTickCallbacks=[],this._onAfterTickCallbacks=[],this._onPlayingStateChangeCallbacks=[],this._graphNode=new _r(n,"timeController")}get graphNode(){return this._graphNode}dispose(){this._graphNode.dispose()}updateClockDelta(){const n=this._clock.getDelta(),e=n>Xb?Xb:n;return this.setDelta(e)}delta(){return this._timeDeltaUniform.value}setDelta(n){return this._timeDeltaUniform.value=n}frame(){return this._frame}timeUniform(){return this._timeUniform}timeDeltaUniform(){return this._timeDeltaUniform}time(){return this._timeUniform.value}maxFrame(){return this._maxFrame}maxFrameLocked(){return this._maxFrameLocked}realtimeState(){return this._realtimeState}setMaxFrame(n){this._maxFrame=Math.floor(n),this.scene.dispatchController.dispatch(this._graphNode,po.MAX_FRAME_UPDATED)}setMaxFrameLocked(n){this._maxFrameLocked=n,this.scene.dispatchController.dispatch(this._graphNode,po.MAX_FRAME_UPDATED)}setRealtimeState(n){this._realtimeState=n,this.scene.dispatchController.dispatch(this._graphNode,po.REALTIME_STATUS_UPDATED)}setTime(n,e=!0){if(n==this._timeUniform.value)return;this._timeUniform.value=n,this.scene.cooker.block();const t=this.delta();for(const r of this._onBeforeTickCallbacks)r(t);if(this._playing==!0&&n>0&&this.scene.actorsManager.tick(),e){const r=Math.floor(this._timeUniform.value*Wb),s=this._ensureFrameWithinBounds(r);r!=s?this.setFrame(s,!0):this._frame=r}this.scene.dispatchController.dispatch(this._graphNode,po.FRAME_UPDATED),this.graphNode.setSuccessorsDirty(),this.scene.cooker.unblock();for(const r of this._onAfterTickCallbacks)r(t)}setFrame(n,e=!0){n!=this._frame&&(n=this._ensureFrameWithinBounds(n),n!=this._frame&&(this._frame=n,this._frame==Ia.START_FRAME&&this.scene.actorsManager.runOnEventSceneReset(),e&&this.setTime(this._frame/Wb,!1)))}setFrameToStart(){this.setFrame(Ia.START_FRAME,!0)}incrementTimeIfPlaying(n){this._playing&&(this.scene.root().areChildrenCooking()||this.incrementTime(n))}incrementTime(n){if((n==null?void 0:n.updateClockDelta)!=!1&&this.updateClockDelta(),this._realtimeState){const e=this._timeUniform.value+this.delta();this.setTime(e,!1),this.setFrame(this._frame+1,!1)}else this.setFrame(this.frame()+1)}_ensureFrameWithinBounds(n){if(this._playing){if(this._maxFrameLocked&&n>this._maxFrame)return Ia.START_FRAME}else{if(this._maxFrameLocked&&n>this._maxFrame)return this._maxFrame;if(n<Ia.START_FRAME)return Ia.START_FRAME}return n}playing(){return this._playing===!0}pause(){if(this._playing!=!1){this._playing=!1,this.scene.dispatchController.dispatch(this._graphNode,po.PLAY_STATE_UPDATED),this.scene.actorsManager.runOnEventScenePause(),this.scene.eventsDispatcher.sceneEventsController.dispatch(QV);for(const n of this._onPlayingStateChangeCallbacks)n()}}play(){if(!this._playAllowedWithoutAllNodesCooked&&!this.scene.cookController.allNodesHaveCookedAtLeastOnce()){ve.warn("play not allowed, some nodes have not completed cooking");return}if(this._playing!=!0){this._playing=!0,this.scene.actorsManager.runOnEventScenePlay(),this.scene.dispatchController.dispatch(this._graphNode,po.PLAY_STATE_UPDATED),this.scene.eventsDispatcher.sceneEventsController.dispatch(JV);for(const n of this._onPlayingStateChangeCallbacks)n()}}togglePlayPause(){this.playing()?this.pause():this.play()}forbidPlayUntilAllNodesCooked(){this._playAllowedWithoutAllNodesCooked=!1}registerOnBeforeTick(n,e){this._registerCallback(n,e,this.registeredBeforeTickCallbacks())}unRegisterOnBeforeTick(n){this._unregisterCallback(n,this._onBeforeTickCallbacksMap)}registeredBeforeTickCallbacks(){return this._onBeforeTickCallbacksMap=this._onBeforeTickCallbacksMap||new Map}hasBeforeTickCallback(n){var e;return((e=this._onBeforeTickCallbacksMap)==null?void 0:e.has(n))||!1}registerOnAfterTick(n,e){this._registerCallback(n,e,this.registeredAfterTickCallbacks())}unRegisterOnAfterTick(n){this._unregisterCallback(n,this._onAfterTickCallbacksMap)}registeredAfterTickCallbacks(){return this._onAfterTickCallbacksMap=this._onAfterTickCallbacksMap||new Map}hasAfterTickCallback(n){var e;return((e=this._onAfterTickCallbacksMap)==null?void 0:e.has(n))||!1}onPlayingStateChange(n){this._onPlayingStateChangeCallbacksMap=this._onPlayingStateChangeCallbacksMap||new Set,this._onPlayingStateChangeCallbacksMap.add(n),this._updateOnPlayingStateChangeCallbacks()}removeOnPlayingStateChange(n){this._onPlayingStateChangeCallbacksMap&&(this._onPlayingStateChangeCallbacksMap.delete(n),this._updateOnPlayingStateChangeCallbacks())}_updateOnPlayingStateChangeCallbacks(){this._onPlayingStateChangeCallbacks=[],this._onPlayingStateChangeCallbacksMap&&this._onPlayingStateChangeCallbacksMap.forEach(n=>{this._onPlayingStateChangeCallbacks.push(n)})}_registerCallback(n,e,t){if(t.has(n)){console.warn(`callback ${n} already registered`);return}t.set(n,e),this._updateCallbacks()}_unregisterCallback(n,e){e&&(e.delete(n),this._updateCallbacks())}_updateCallbacks(){var n,e;this._onBeforeTickCallbacks.length=0,(n=this._onBeforeTickCallbacksMap)==null||n.forEach(t=>{this._onBeforeTickCallbacks.push(t)}),this._onAfterTickCallbacks.length=0,(e=this._onAfterTickCallbacksMap)==null||e.forEach(t=>{this._onAfterTickCallbacks.push(t)})}};let Pp=Ia;Pp.START_FRAME=0;var _n=(n=>(n.CREATED="node_created",n.DELETED="node_deleted",n.NAME_UPDATED="node_name_update",n.OVERRIDE_CLONABLE_STATE_UPDATE="node_override_clonable_state_update",n.NAMED_OUTPUTS_UPDATED="node_named_outputs_updated",n.NAMED_INPUTS_UPDATED="node_named_inputs_updated",n.INPUTS_UPDATED="node_inputs_updated",n.PARAMS_UPDATED="node_params_updated",n.UI_DATA_POSITION_UPDATED="node_ui_data_position_updated",n.UI_DATA_COMMENT_UPDATED="node_ui_data_comment_updated",n.ERROR_UPDATED="node_error_updated",n.FLAG_BYPASS_UPDATED="bypass_flag_updated",n.FLAG_DISPLAY_UPDATED="display_flag_updated",n.FLAG_OPTIMIZE_UPDATED="optimize_flag_updated",n.SELECTION_UPDATED="selection_updated",n.POLY_NODE_LOCK_STATE_UPDATED="lock_state_updated",n))(_n||{});const rz=/[, ]/,OM=/\d+$/,sz=/^0+/,iz=/,| /,oz="0",az=" ",$b="-",cz=/^-?\d+\.?\d*$/;function lz(n){return n=="true"||n=="false"}function uz(n){return n=="true"}function hz(n){return cz.test(n)}function dz(n){return n=n.replace(/[^A-Za-z0-9]/g,"_"),n=n.replace(/^[0-9]/,"_"),n}let qf=[];function PM(n,e){const t=n.split(rz);qf.length=0;for(const r of t){const s=r.trim();s.length>0&&qf.push(s)}return Zs(qf,e),e}function NM(n){const e=n.match(OM);return e?parseInt(e[0]):0}function pz(n){const e=n.match(OM);if(e){let t=e[0],r="";const s=t.match(sz);s&&(r=s[0]);const i=parseInt(t);return i==0&&r.length>0&&r[r.length-1]==oz&&(r=r.slice(0,-1)),`${n.substring(0,n.length-e[0].length)}${r}${i+1}`}else return`${n}1`}function fz(n){return n[n.length-1]!=="s"?`${n}s`:n}function mz(n){const e=n.replace(/_/g," ").split(" ");let t="";for(let r=0;r<e.length;r++){let s=e[r].toLowerCase();r>0&&(s=xv(s)),t+=s}return t}function xv(n){return n.length==0?n:n[0].toUpperCase()+n.substring(1)}function _z(n){return n.split(/\s|_/g).map(xv).join(" ")}function gz(n,e=2){e=Math.max(e,0);const t=`${n}`.split(".");if(e<=0)return t[0];let r=t[1];if(r!==void 0)return r.length>e&&(r=r.substring(0,e)),r=r.padEnd(e,"0"),`${t[0]}.${r}`;{const s=`${n}.`,i=s.length+e;return s.padEnd(i,"0")}}function dn(n){const e=`${n}`;return e.indexOf(".")>=0?e:`${e}.0`}function B_(n){const e=`${n}`;return e.indexOf(".")>=0?e.split(".")[0]:e}function Qs(n,e){if(e==="*"||n==e)return!0;const t=e.split(az),r=[];for(const s of t)s.startsWith("^")&&r.push(s.substring(1));for(const s of r)if(Qs(n,s))return!1;if(t.length>1){for(const s of t)if(Qs(n,s))return!0;return!1}e=e.split("*").join(".*"),e=`^${e}$`;try{return new RegExp(e).test(n)}catch{return!1}}function vz(n,e){for(const t of e)if(Qs(n,t))return!0;return!1}let Yf=[],qb=[];function IM(n,e){e.length=0;const t=n.split(iz);if(t.length>1){Yf.length=0;for(const r of t)IM(r,qb),Sp(qb,Yf);return Zs(Yf,e),e.sort((r,s)=>r-s)}else{const r=t[0];if(r)if(r.indexOf($b)>0){const s=r.split($b),i=s[0],o=s[1],a=parseInt(i),c=parseInt(o);if(md(a)&&md(c))return eM(a,c+1,1,e)}else{const s=parseInt(r);if(md(s))return e.push(s),e}}return e}function yz(n){return n.replace(/(\r\n|\n|\r)/gm,"\\n")}class yt{}yt.isBoolean=lz;yt.toBoolean=uz;yt.isNumber=hz;yt.tailDigits=NM;yt.increment=pz;yt.pluralize=fz;yt.camelCase=mz;yt.upperFirst=xv;yt.titleize=_z;yt.precision=gz;yt.ensureFloat=dn;yt.ensureInteger=B_;yt.matchMask=Qs;yt.matchesOneMask=vz;yt.attribNames=PM;yt.indices=IM;yt.escapeLineBreaks=yz;yt.sanitizeName=dz;function Np(n){return n=n.replace(/'/g,"'"),n=yt.escapeLineBreaks(n),n}class DM{constructor(e,t){this._node=e,this.dispatcher=t}async data(e){var t,r,s,i,o,a;this._isRoot()||this._node.scene().nodesController.registerNodeContextSignature(this._node),this._data={type:this._node.type()},this._node.polyNodeController&&(this._data.polyNode={locked:this._node.polyNodeController.locked()});const c=await this.nodes_data(e);Object.keys(c).length>0&&(this._data.nodes=c);const l=this.params_data();if(Object.keys(l).length>0&&(this._data.params=l),!this._isRoot()){this._node.io.inputs.maxInputsCountOverriden()&&(this._data.maxInputsCount=this._node.io.inputs.maxInputsCount());const h=this.inputs_data();h.length>0&&(this._data.inputs=h);const d=this.connection_points_data();d&&(this._data.connection_points=d)}if(this._node.flags){const h={};(this._node.flags.hasBypass()||this._node.flags.hasDisplay()||this._node.flags.hasOptimize())&&(this._node.flags.hasBypass()&&(t=this._node.flags.bypass)!=null&&t.active()&&(h.bypass=this._node.flags.bypass.active()),this._node.flags.hasDisplay()&&((r=this._node.flags.display)!=null&&r.active()||!((s=this._node.parent())!=null&&s.displayNodeController))&&(h.display=(i=this._node.flags.display)==null?void 0:i.active()),this._node.flags.hasOptimize()&&(o=this._node.flags.optimize)!=null&&o.active()&&(h.optimize=(a=this._node.flags.optimize)==null?void 0:a.active())),Object.keys(h).length>0&&(this._data.flags=h)}if(this._node.io.inputs.overrideClonedStateAllowed()){const h=this._node.io.inputs.clonedStateOverriden();h&&(this._data.cloned_state_overriden=h)}if((e.withPersistedConfig==null?!0:e.withPersistedConfig)==!0){const h=this._node.persisted_config;if(h){const d=e.showPolyNodesData?await h.toData():await h.toDataWithoutShaders();d&&(this._data.persisted_config=d)}}return this.add_custom(),this._data}uiData(e){const t=this.ui_data_without_children(),r=this._node.children();if(r.length>0){const s={};for(let i of r){const o=this.dispatcher.dispatchNode(i);s[i.name()]=o.uiData(e)}t.nodes=s}return t}ui_data_without_children(){var e;const t={};if(!this._isRoot()){const r=this._node.uiData;t.pos=r.position().toArray();const s=r.comment();if(s&&(t.comment=Np(s)),this._node.childrenAllowed()){const i=(e=this._node.childrenController)==null?void 0:e.selection;if(i&&this._node.children().length>0){const o=[],a={},c=[];i.nodes(c);for(const u of c)a[u.graphNodeId()]=!0;for(const u of this._node.children())u.graphNodeId()in a&&o.push(u);const l=o.map(u=>u.name());l.length>0&&(t.selection=l)}}}return t}async persistedConfigData(e,t,r){const s=this._node.children();if(s.length>0)for(let i of s)await this.dispatcher.dispatchNode(i).persistedConfigData(e,t,r);if(this._node.persisted_config){const i=await this._node.persisted_config.toData();if(i){if(i.shaders){e[this._node.path()]=i.shaders;return}if(i.functionBody!=null)if(Ke(i.functionBody)){t[this._node.path()]=i.functionBody;return}else{const o={},a=Object.keys(i.functionBody);for(let c of a)o[c]=i.functionBody[c];t[this._node.path()]=o;return}console.warn("persisted config data not handled",i)}}}_isRoot(){return this._node.parent()===null&&this._node.graphNodeId()==this._node.root().graphNodeId()}inputs_data(){const e=[];return this._node.io.inputs.inputs().forEach((t,r)=>{var s,i;if(t){const o=this._node.io.connections.inputConnection(r);if(this._node.io.inputs.hasNamedInputs()){const a=this._node.io.inputs.namedInputConnectionPoints(),c=t.io.outputs.namedOutputConnectionPoints();if(a&&c){const l=(s=a[r])==null?void 0:s.name(),u=o.outputIndex(),h=(i=c[u])==null?void 0:i.name();h&&(e[r]={index:r,inputName:l,node:t.name(),output:h})}}else e[r]=t.name()}}),e}connection_points_data(){if(this._node.io.has_connection_points_controller&&this._node.io.connection_points.initialized()&&(this._node.io.inputs.hasNamedInputs()||this._node.io.outputs.hasNamedOutputs())){const e={};if(this._node.io.inputs.hasNamedInputs()){e.in=[];const t=this._node.io.inputs.namedInputConnectionPoints();if(t)for(let r of t)r&&e.in.push(r.toJSON())}if(this._node.io.outputs.hasNamedOutputs()){e.out=[];const t=this._node.io.outputs.namedOutputConnectionPoints();if(t)for(let r of t)r&&e.out.push(r.toJSON())}return e}}params_data(){const e={};for(let t of this._node.params.names){const r=this._node.params.get(t);if(r&&!r.parentParam()){const s=this.dispatcher.dispatchParam(r);if(s.required()){const i=s.data();e[r.name()]=i}}}return e}async nodes_data(e){const t={};for(let r of this._node.children()){const s=this.dispatcher.dispatchNode(r);t[r.name()]=await s.data(e)}return t}add_custom(){}}class Sc{constructor(e){this._param=e,this._complex_data={}}required(){const e=this._param.options.isSpare()&&!this._param.parentParam(),t=!this._param.isDefault();return e||t||this._param.options.hasOptionsOverridden()}data(){if(this._param.parentParam())throw console.warn("no component should be saved"),"no component should be saved";return this._require_data_complex()?this._data_complex():this._data_simple()}_data_simple(){return this._param.rawInputSerialized()}_data_complex(){if(this._complex_data={},this._param.options.isSpare()&&!this._param.parentParam()&&(this._complex_data.type=this._param.type(),this._complex_data.default_value=this._param.defaultValueSerialized(),this._complex_data.options=this._param.options.current()),this._param.isDefault()||(this._complex_data.raw_input=this._param.rawInputSerialized()),this._param.options.hasOptionsOverridden()){const e={},t=this._param.options.overriddenOptions();for(let r of Object.keys(t)){const s=t[r];Ke(s)||Ye(s)?e[r]=s:e[r]=JSON.stringify(s)}this._complex_data.overriden_options=e}return this._complex_data}_require_data_complex(){return!!(this._param.options.isSpare()||this._param.options.hasOptionsOverridden())}add_main(){}}class xz extends Sc{add_main(){if(this._require_data_complex())this._complex_data.raw_input=this._param.rawInputSerialized();else return this._param.rawInputSerialized()}}class bz extends Sc{add_main(){let e=this._param.rawInput();if(e=Np(e),this._require_data_complex())this._complex_data.raw_input=e;else return e}}class Cz extends Sc{add_main(){let e=this._param.rawInput();if(e=Np(e),this._require_data_complex())this._complex_data.raw_input=e;else return e}}class Ez extends Sc{add_main(){let e=this._param.rawInput();if(e=Np(e),this._require_data_complex())this._complex_data.raw_input=e;else return e}}class Sz extends Sc{add_main(){if(this._require_data_complex())this._complex_data.raw_input=this._param.rawInputSerialized();else return this._param.rawInputSerialized()}}class Az{add(e,t,r){if(typeof arguments[0]!="string")for(let s in arguments[0])this.add(s,arguments[0][s],arguments[1]);else(Array.isArray(e)?e:[e]).forEach(function(s){this[s]=this[s]||[],t&&this[s][r?"unshift":"push"](t)},this)}run(e,t){this[e]=this[e]||[],this[e].forEach(function(r){r.call(t&&t.context?t.context:t,t)})}}class Tz{constructor(e){this.jsep=e,this.registered={}}register(...e){e.forEach(t=>{if(typeof t!="object"||!t.name||!t.init)throw new Error("Invalid JSEP plugin format");this.registered[t.name]||(t.init(this.jsep),this.registered[t.name]=t)})}}class fe{static get version(){return"1.0.2"}static toString(){return"JavaScript Expression Parser (JSEP) v"+fe.version}static addUnaryOp(e){return fe.max_unop_len=Math.max(e.length,fe.max_unop_len),fe.unary_ops[e]=1,fe}static addBinaryOp(e,t){return fe.max_binop_len=Math.max(e.length,fe.max_binop_len),fe.binary_ops[e]=t,fe}static addIdentifierChar(e){return fe.additional_identifier_chars.add(e),fe}static addLiteral(e,t){return fe.literals[e]=t,fe}static removeUnaryOp(e){return delete fe.unary_ops[e],e.length===fe.max_unop_len&&(fe.max_unop_len=fe.getMaxKeyLen(fe.unary_ops)),fe}static removeAllUnaryOps(){return fe.unary_ops={},fe.max_unop_len=0,fe}static removeIdentifierChar(e){return fe.additional_identifier_chars.delete(e),fe}static removeBinaryOp(e){return delete fe.binary_ops[e],e.length===fe.max_binop_len&&(fe.max_binop_len=fe.getMaxKeyLen(fe.binary_ops)),fe}static removeAllBinaryOps(){return fe.binary_ops={},fe.max_binop_len=0,fe}static removeLiteral(e){return delete fe.literals[e],fe}static removeAllLiterals(){return fe.literals={},fe}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}constructor(e){this.expr=e,this.index=0}static parse(e){return new fe(e).parse()}static getMaxKeyLen(e){return Math.max(0,...Object.keys(e).map(t=>t.length))}static isDecimalDigit(e){return e>=48&&e<=57}static binaryPrecedence(e){return fe.binary_ops[e]||0}static isIdentifierStart(e){return e>=65&&e<=90||e>=97&&e<=122||e>=128&&!fe.binary_ops[String.fromCharCode(e)]||fe.additional_identifier_chars.has(String.fromCharCode(e))}static isIdentifierPart(e){return fe.isIdentifierStart(e)||fe.isDecimalDigit(e)}throwError(e){const t=new Error(e+" at character "+this.index);throw t.index=this.index,t.description=e,t}runHook(e,t){if(fe.hooks[e]){const r={context:this,node:t};return fe.hooks.run(e,r),r.node}return t}searchHook(e){if(fe.hooks[e]){const t={context:this};return fe.hooks[e].find(function(r){return r.call(t.context,t),t.node}),t.node}}gobbleSpaces(){let e=this.code;for(;e===fe.SPACE_CODE||e===fe.TAB_CODE||e===fe.LF_CODE||e===fe.CR_CODE;)e=this.expr.charCodeAt(++this.index);this.runHook("gobble-spaces")}parse(){this.runHook("before-all");const e=this.gobbleExpressions(),t=e.length===1?e[0]:{type:fe.COMPOUND,body:e};return this.runHook("after-all",t)}gobbleExpressions(e){let t=[],r,s;for(;this.index<this.expr.length;)if(r=this.code,r===fe.SEMCOL_CODE||r===fe.COMMA_CODE)this.index++;else if(s=this.gobbleExpression())t.push(s);else if(this.index<this.expr.length){if(r===e)break;this.throwError('Unexpected "'+this.char+'"')}return t}gobbleExpression(){const e=this.searchHook("gobble-expression")||this.gobbleBinaryExpression();return this.gobbleSpaces(),this.runHook("after-expression",e)}gobbleBinaryOp(){this.gobbleSpaces();let e=this.expr.substr(this.index,fe.max_binop_len),t=e.length;for(;t>0;){if(fe.binary_ops.hasOwnProperty(e)&&(!fe.isIdentifierStart(this.code)||this.index+e.length<this.expr.length&&!fe.isIdentifierPart(this.expr.charCodeAt(this.index+e.length))))return this.index+=t,e;e=e.substr(0,--t)}return!1}gobbleBinaryExpression(){let e,t,r,s,i,o,a,c,l;if(o=this.gobbleToken(),!o||(t=this.gobbleBinaryOp(),!t))return o;for(i={value:t,prec:fe.binaryPrecedence(t)},a=this.gobbleToken(),a||this.throwError("Expected expression after "+t),s=[o,i,a];t=this.gobbleBinaryOp();){if(r=fe.binaryPrecedence(t),r===0){this.index-=t.length;break}for(i={value:t,prec:r},l=t;s.length>2&&r<=s[s.length-2].prec;)a=s.pop(),t=s.pop().value,o=s.pop(),e={type:fe.BINARY_EXP,operator:t,left:o,right:a},s.push(e);e=this.gobbleToken(),e||this.throwError("Expected expression after "+l),s.push(i,e)}for(c=s.length-1,e=s[c];c>1;)e={type:fe.BINARY_EXP,operator:s[c-1].value,left:s[c-2],right:e},c-=2;return e}gobbleToken(){let e,t,r,s;if(this.gobbleSpaces(),s=this.searchHook("gobble-token"),s)return this.runHook("after-token",s);if(e=this.code,fe.isDecimalDigit(e)||e===fe.PERIOD_CODE)return this.gobbleNumericLiteral();if(e===fe.SQUOTE_CODE||e===fe.DQUOTE_CODE)s=this.gobbleStringLiteral();else if(e===fe.OBRACK_CODE)s=this.gobbleArray();else{for(t=this.expr.substr(this.index,fe.max_unop_len),r=t.length;r>0;){if(fe.unary_ops.hasOwnProperty(t)&&(!fe.isIdentifierStart(this.code)||this.index+t.length<this.expr.length&&!fe.isIdentifierPart(this.expr.charCodeAt(this.index+t.length)))){this.index+=r;const i=this.gobbleToken();return i||this.throwError("missing unaryOp argument"),this.runHook("after-token",{type:fe.UNARY_EXP,operator:t,argument:i,prefix:!0})}t=t.substr(0,--r)}fe.isIdentifierStart(e)?(s=this.gobbleIdentifier(),fe.literals.hasOwnProperty(s.name)?s={type:fe.LITERAL,value:fe.literals[s.name],raw:s.name}:s.name===fe.this_str&&(s={type:fe.THIS_EXP})):e===fe.OPAREN_CODE&&(s=this.gobbleGroup())}return s?(s=this.gobbleTokenProperty(s),this.runHook("after-token",s)):this.runHook("after-token",!1)}gobbleTokenProperty(e){this.gobbleSpaces();let t=this.code;for(;t===fe.PERIOD_CODE||t===fe.OBRACK_CODE||t===fe.OPAREN_CODE;)this.index++,t===fe.PERIOD_CODE?(this.gobbleSpaces(),e={type:fe.MEMBER_EXP,computed:!1,object:e,property:this.gobbleIdentifier()}):t===fe.OBRACK_CODE?(e={type:fe.MEMBER_EXP,computed:!0,object:e,property:this.gobbleExpression()},this.gobbleSpaces(),t=this.code,t!==fe.CBRACK_CODE&&this.throwError("Unclosed ["),this.index++):t===fe.OPAREN_CODE&&(e={type:fe.CALL_EXP,arguments:this.gobbleArguments(fe.CPAREN_CODE),callee:e}),this.gobbleSpaces(),t=this.code;return e}gobbleNumericLiteral(){let e="",t,r;for(;fe.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(this.code===fe.PERIOD_CODE)for(e+=this.expr.charAt(this.index++);fe.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(t=this.char,t==="e"||t==="E"){for(e+=this.expr.charAt(this.index++),t=this.char,(t==="+"||t==="-")&&(e+=this.expr.charAt(this.index++));fe.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);fe.isDecimalDigit(this.expr.charCodeAt(this.index-1))||this.throwError("Expected exponent ("+e+this.char+")")}return r=this.code,fe.isIdentifierStart(r)?this.throwError("Variable names cannot start with a number ("+e+this.char+")"):(r===fe.PERIOD_CODE||e.length===1&&e.charCodeAt(0)===fe.PERIOD_CODE)&&this.throwError("Unexpected period"),{type:fe.LITERAL,value:parseFloat(e),raw:e}}gobbleStringLiteral(){let e="",t=this.expr.charAt(this.index++),r=!1;for(;this.index<this.expr.length;){let s=this.expr.charAt(this.index++);if(s===t){r=!0;break}else if(s==="\\")switch(s=this.expr.charAt(this.index++),s){case"n":e+=`
`;break;case"r":e+="\r";break;case"t":e+="	";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=s}else e+=s}return r||this.throwError('Unclosed quote after "'+e+'"'),{type:fe.LITERAL,value:e,raw:t+e+t}}gobbleIdentifier(){let e=this.code,t=this.index;for(fe.isIdentifierStart(e)?this.index++:this.throwError("Unexpected "+this.char);this.index<this.expr.length&&(e=this.code,fe.isIdentifierPart(e));)this.index++;return{type:fe.IDENTIFIER,name:this.expr.slice(t,this.index)}}gobbleArguments(e){const t=[];let r=!1,s=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let i=this.code;if(i===e){r=!0,this.index++,e===fe.CPAREN_CODE&&s&&s>=t.length&&this.throwError("Unexpected token "+String.fromCharCode(e));break}else if(i===fe.COMMA_CODE){if(this.index++,s++,s!==t.length){if(e===fe.CPAREN_CODE)this.throwError("Unexpected token ,");else if(e===fe.CBRACK_CODE)for(let o=t.length;o<s;o++)t.push(null)}}else if(t.length!==s&&s!==0)this.throwError("Expected comma");else{const o=this.gobbleExpression();(!o||o.type===fe.COMPOUND)&&this.throwError("Expected comma"),t.push(o)}}return r||this.throwError("Expected "+String.fromCharCode(e)),t}gobbleGroup(){this.index++;let e=this.gobbleExpressions(fe.CPAREN_CODE);if(this.code===fe.CPAREN_CODE)return this.index++,e.length===1?e[0]:e.length?{type:fe.SEQUENCE_EXP,expressions:e}:!1;this.throwError("Unclosed (")}gobbleArray(){return this.index++,{type:fe.ARRAY_EXP,elements:this.gobbleArguments(fe.CBRACK_CODE)}}}const Mz=new Az;Object.assign(fe,{hooks:Mz,plugins:new Tz(fe),COMPOUND:"Compound",SEQUENCE_EXP:"SequenceExpression",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",ARRAY_EXP:"ArrayExpression",TAB_CODE:9,LF_CODE:10,CR_CODE:13,SPACE_CODE:32,PERIOD_CODE:46,COMMA_CODE:44,SQUOTE_CODE:39,DQUOTE_CODE:34,OPAREN_CODE:40,CPAREN_CODE:41,OBRACK_CODE:91,CBRACK_CODE:93,QUMARK_CODE:63,SEMCOL_CODE:59,COLON_CODE:58,unary_ops:{"-":1,"!":1,"~":1,"+":1},binary_ops:{"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},additional_identifier_chars:new Set(["$","_"]),literals:{true:!0,false:!1,null:null},this_str:"this"});fe.max_unop_len=fe.getMaxKeyLen(fe.unary_ops);fe.max_binop_len=fe.getMaxKeyLen(fe.binary_ops);const Xi=n=>new fe(n).parse(),Rz=Object.getOwnPropertyNames(fe);Rz.forEach(n=>{Xi[n]===void 0&&n!=="prototype"&&(Xi[n]=fe[n])});Xi.Jsep=fe;const Yb="ConditionalExpression";var wz={name:"ternary",init(n){n.hooks.add("after-expression",function(t){if(t.node&&this.code===n.QUMARK_CODE){this.index++;const r=t.node,s=this.gobbleExpression();if(s||this.throwError("Expected expression"),this.gobbleSpaces(),this.code===n.COLON_CODE){this.index++;const i=this.gobbleExpression();i||this.throwError("Expected expression"),t.node={type:Yb,test:r,consequent:s,alternate:i}}else s.operator===":"?t.node={type:Yb,test:r,consequent:s.left,alternate:s.right}:this.throwError("Expected :")}})}};Xi.plugins.register(wz);Xi.addUnaryOp("@");let Oz=10;Xi.addBinaryOp("**",Oz);const Pz="Identifier",Nz="Literal",Iz="CallExpression",Dz="`";function LM(n){return n!=null?Ke(n)?n.split(Dz):[]:[]}class Kb{constructor(e){this._param=e}node(){return this._node}errorMessage(){return this._errorMessage}parseExpression(e){try{this.reset(),this._node=Xi(e)}catch(t){const r=`could not parse the expression '${e}' (error: ${t})`;this._errorMessage=r}}parseExpressionForStringParam(e){try{this.reset();const t=LM(e),r=[];for(let s=0;s<t.length;s++){const i=t[s];let o;if(s%2==1)o=Xi(i);else{const a=i.replace(/\'/g,"\\'");o={type:Nz,value:`'${a}'`,raw:`'${a}'`},this._param.scene().missingExpressionReferencesController.registerToIgnore(o)}r.push(o)}this._node={type:Iz,arguments:r,callee:{type:Pz,name:"strConcat"}}}catch(t){const r=`could not parse the expression '${e}' (error: ${t})`;this._errorMessage=r}}reset(){this._node=void 0,this._errorMessage=void 0}}class Lz{static if(e){const t=e[0],r=e[1],s=e[2];return`((${t}) ? (${r}) : (${s}))`}}var Tt=(n=>(n.AMBIENT_LIGHT="AmbientLight",n.AREA_LIGHT="AreaLight",n.CUBE_CAMERA="CubeCamera",n.DIRECTIONAL_LIGHT="DirectionalLight",n.GROUP="Group",n.HEMISPHERE_LIGHT="HemisphereLight",n.INSTANCED_MESH="InstancedMesh",n.LIGHT_PROBE="LightProbe",n.LINE_SEGMENTS="LineSegments",n.LOD="LOD",n.MESH="Mesh",n.OBJECT3D="Object3D",n.ORTHOGRAPHIC_CAMERA="OrthographicCamera",n.PERSPECTIVE_CAMERA="PerspectiveCamera",n.PHYSICAL_CAMERA="PhysicalCamera",n.PHYSICAL_SPOT_LIGHT="PhysicalSpotLight",n.POINT_LIGHT="PointLight",n.POINTS="Points",n.SCENE="Scene",n.SHAPED_AREA_LIGHT="ShapedAreaLight",n.SPOT_LIGHT="SpotLight",n.UNKNOWN="Unknown",n.QUAD="Quad",n))(Tt||{});const Fz={type:"Unknown",checkFunc:n=>"Unknown",humanName:"Unknown",ctor:null};function Uz(){const t={objectTypeCheckFunctions:[],dataByObjectType:new Map};function r(s,i,o,a){UM(t,{type:s,checkFunc:i,ctor:o,humanName:a||s})}return r("Object3D",s=>s.isObject3D?"Object3D":void 0,wt,"Object3D"),r("Mesh",s=>s.isMesh?"Mesh":void 0,Jt,"Mesh"),r("Group",s=>s.isGroup?"Group":void 0,lr,"Group"),r("LineSegments",s=>s.isLineSegments?"LineSegments":void 0,ic,"LineSegments"),r("InstancedMesh",s=>s.isInstancedMesh?"InstancedMesh":void 0,_F,"InstancedMesh"),r("Points",s=>s.isPoints?"Points":void 0,vl,"Points"),r("Scene",s=>s.isScene?"Scene":void 0,gu,"Scene"),t}const{objectTypeCheckFunctions:FM,dataByObjectType:Hd}=Uz();function UM(n,e){n.objectTypeCheckFunctions.unshift(e.checkFunc),n.dataByObjectType.set(e.type,e)}function Ip(n){UM({objectTypeCheckFunctions:FM,dataByObjectType:Hd},n)}function kz(n){return kM(n).type}function kM(n){for(const e of FM){const t=e(n);if(t)return Hd.get(t)}return Fz}function Zb(n){const e=Hd.get(n);return e?e.ctor:(console.warn(`no constructor found for type '${n}'`),Hd.get("Mesh"))}const BM={MeshStandard:new kl({color:16777215,side:In,metalness:.5,roughness:.9}),Mesh:new kl({color:16777215,side:In,metalness:0,roughness:.9}),Points:new Pi({color:16777215,size:.1,depthTest:!0}),LineSegments:new Cs({color:16777215,linewidth:1})};var rt=(n=>(n.POINT="point",n.VERTEX="vertex",n.PRIMITIVE="primitive",n.OBJECT="object",n.CORE_GROUP="coreGroup",n))(rt||{}),Hn=(n=>(n.NUMERIC="numeric",n.STRING="string",n))(Hn||{}),Da=(n=>(n[n.FLOAT=1]="FLOAT",n[n.VECTOR2=2]="VECTOR2",n[n.VECTOR3=3]="VECTOR3",n[n.VECTOR4=4]="VECTOR4",n))(Da||{});const bv={x:0,y:1,z:2,w:3,r:0,g:1,b:2},Cv=".";var vt=(n=>(n.POINT_INDEX="ptnum",n.VERTEX_INDEX="vtxnum",n.PRIMITIVE_INDEX="primnum",n.OBJECT_INDEX="objnum",n.OBJECT_NAME="objname",n.COLOR="color",n.NORMAL="normal",n.POSITION="position",n.PSCALE="pscale",n.UP="up",n.UV="uv",n.SCALE="scale",n.TANGENT="tangent",n.ID="id",n))(vt||{});const Bz={P:"position",N:"normal",Cd:"color"},yh=[],Jb=[];class Dt{static remapName(e){return Bz[e]||e}static arrayToIndexedArrays(e){const t={};let r=0;const s=[],i=[];let o=0;for(;o<e.length;){const a=e[o],c=t[a];c!=null?s.push(c):(i.push(a),s.push(r),t[a]=r,r+=1),o++}return{indices:s,values:i}}static defaultValue(e){switch(e){case 1:return 0;case 2:return new W(0,0);case 3:return new T(0,0,0);default:throw`size ${e} not yet implemented`}}static copy(e,t,r=!0){const s=e==null?void 0:e.array,i=t==null?void 0:t.array;if(s&&i){const o=Math.min(s.length,i.length);for(let a=0;a<o;a++)i[a]=s[a];r&&(t.needsUpdate=!0)}}static attribSizeFromValue(e){if(Ke(e)||Ye(e))return Da.FLOAT;if(_t(e))return e.length;switch(e.constructor){case xe:return Da.VECTOR3;case W:return Da.VECTOR2;case T:return Da.VECTOR3;case We:return Da.VECTOR4}return null}static attribNamesMatchingMask(e,t){PM(e,Jb),yh.length=0;for(const s of Jb)for(const i of t)if(Qs(i,s))yh.push(i);else{const o=Dt.remapName(s);i==o&&yh.push(i)}return Zs(yh,[])}}const GM="$";class VM{constructor(e){this.param=e,this._set_error_from_error_bound=this._set_error_from_error.bind(this)}clearError(){this._errorMessage=void 0}setError(e){this._errorMessage=this._errorMessage||e}_set_error_from_error(e){Ke(e)?this._errorMessage=e:this._errorMessage=e.message}isErrored(){return this._errorMessage!=null}errorMessage(){return this._errorMessage}reset(){this._errorMessage=void 0}traverse_node(e){const t=`traverse_${e.type}`;if(this[t])return this[t](e);this.setError(`expression unknown node type: ${e.type}`)}traverse_BinaryExpression(e){return`${this.traverse_node(e.left)} ${e.operator} ${this.traverse_node(e.right)}`}traverse_MemberExpression(e){return`${this.traverse_node(e.object)}.${this.traverse_node(e.property)}`}traverse_ConditionalExpression(e){return`(${this.traverse_node(e.test)}) ? (${this.traverse_node(e.consequent)}) : (${this.traverse_node(e.alternate)})`}traverse_Compound(e){const t=e.body;let r=[];for(let s=0;s<t.length;s++){const i=t[s];i.type=="Identifier"?i.name[0]==GM?r.push("`${"+this.traverse_node(i)+"}`"):r.push(`'${i.name}'`):r.push("`${"+this.traverse_node(i)+"}`")}return r.join(" + ")}traverse_Literal(e){return`${e.raw}`}}const G_="geometry",zc="entity",Di="entities",Gz=`corePointClassFactory(${G_})`,Vz="ThreejsPoint",zM="getEntitiesAttribute",Qb="getEntityAttributeValue",HM="getEntityAttributeValueFunc";class ds{constructor(){}reset(){this._attributeNames&&this._attributeNames.clear()}assignAttributesLines(){if(this._attributeNames){const e=[];for(const t of this._attributeNames)e.push(ds.assignAttributeLine(t));return e.join(`;
`)}else return""}assignArraysLines(){if(this._attributeNames){const e=[];if(this._attributeNames.size>0){const t=`const ${G_} = entities[0].object()`;e.push(t)}for(const t of this._attributeNames)e.push(ds.assignItemSizeLine(t)),e.push(ds.assignArrayLine(t));return e.join(`;
`)}else return""}attributePresenceCheckLine(){if(this._attributeNames){const e=[];for(const t of this._attributeNames){const r=ds._varAttribute(t);e.push(r)}if(e.length>0)return e.join(" && ")}return"true"}missingAttributesLine(){if(this._attributeNames){let e=["(()=>{","const missingAttributes = [];"];for(const t of this._attributeNames){const r=ds._varAttribute(t);e.push(`if( !${r} ) {	missingAttributes.push('${t}'); }`)}return e.push("return missingAttributes;","})"),e.join("")}return"[]"}add(e){this._attributeNames=this._attributeNames||new Set,this._attributeNames.add(e)}static assignAttributeLine(e){return`const ${this._varAttribute(e)} = ${zM}(${Di},'${e}')`}static assignItemSizeLine(e){const t=this._varAttribute(e);return`const ${this._varAttribSize(e)} = ${t}.itemSize`}static assignArrayLine(e){const t=this._varAttribute(e),r=this._varArray(e),s=`(${Di}[0] && ${Di}[0] instanceof ${Vz} && ${Gz}.isAttribIndexed(${G_}, '${e}'))`,i=`${Di}.map(e=>e.indexedAttribValue('${e}'))`,o=`${t}.array`;return`const ${r} = ${s} ? ${i} : ${o};`}static _varAttribute(e){return`attrib_${e}`}static _varAttribSize(e){return`attribSize_${e}`}static _varArray(e){return`array_${e}`}varAttributeSize(e){return ds._varAttribSize(e)}varArray(e){return ds._varArray(e)}}class St{static unreachable(e){throw new Error("Didn't expect to get here")}}const Kf=[],Zf=[],Jf=[];class jM{constructor(e,t){this._index=0,t!=null&&(this._index=t)}index(){return this._index}setIndex(e){return this._index=e,this}}class Dp extends jM{constructor(e,t){super(e,t),this._object=e}object(){return this._object}static relatedPrimitiveIds(e,t,r,s){r.length=0}static relatedVertexIds(e,t,r,s){r.length=0}static relatedPointIds(e,t,r,s){r.length=0}relatedPrimitiveIds(e,t){this.constructor.relatedPrimitiveIds(this._object,this._index,e,t)}relatedVertexIds(e,t){this.constructor.relatedVertexIds(this._object,this._index,e,t)}relatedPointIds(e,t){this.constructor.relatedPointIds(this._object,this._index,e,t)}static relatedPointClass(e){return this.constructor}static relatedVertexClass(e){return this.constructor}static relatedPrimitiveClass(e){return this.constructor}static relatedObjectClass(e){return this.constructor}static relatedEntityClass(e,t){switch(t){case rt.POINT:return this.relatedPointClass(e);case rt.VERTEX:return this.relatedVertexClass(e);case rt.PRIMITIVE:return this.relatedPrimitiveClass(e);case rt.OBJECT:return this.relatedObjectClass(e)}St.unreachable(t)}static relatedPoints(e,t,r,s){this.relatedPointIds(e,t,Kf,s),r.length=Kf.length;let i=0;const o=this.relatedPointClass(e);for(const a of Kf)r[i]=new o(e,a),i++}static relatedVertices(e,t,r,s){this.relatedVertexIds(e,t,Zf,s),r.length=Zf.length;let i=0;const o=this.relatedVertexClass(e);for(const a of Zf)r[i]=new o(e,a),i++}static relatedPrimitives(e,t,r,s){this.relatedPrimitiveIds(e,t,Jf,s),r.length=Jf.length;let i=0;const o=this.relatedPrimitiveClass(e);for(const a of Jf)r[i]=new o(e,a),i++}static relatedObjects(e,t,r,s){r.length=1;const i=this.relatedObjectClass(e);r[0]=new i(e)}relatedPoints(e,t){this.constructor.relatedPoints(this._object,this._index,e,t)}relatedVertices(e,t){this.constructor.relatedVertices(this._object,this._index,e,t)}relatedPrimitives(e,t){this.constructor.relatedPrimitives(this._object,this._index,e,t)}relatedObjects(e,t){this.constructor.relatedObjects(this._object,this._index,e,t)}}var Ev=(n=>(n.THREEJS="Object3D",n.CAD="CADObject",n.CSG="CSGObject",n.QUAD="QUADObject",n.SDF="SDFObject",n.TET="TetObject",n))(Ev||{});function Xn(n){return n instanceof wt||n.isObject3D==!0}function zz(n,e,t){e.visible=n.visible,e.name=n.name,(t==null||t.castShadow==null||t.castShadow==!0)&&(e.castShadow=n.castShadow),(t==null||t.receiveShadow==null||t.receiveShadow==!0)&&(e.receiveShadow=n.receiveShadow),e.renderOrder=n.renderOrder,e.frustumCulled=n.frustumCulled,e.matrixAutoUpdate=n.matrixAutoUpdate,n.material&&(t==null?void 0:t.material)==null&&(e.material=n.material),e.userData=Ii(n.userData)}function la(n){console.warn(`CoreVertex.${n} needs to be overloaded`)}class Hz extends Dp{builder(){}static addAttribute(e,t,r){la("addAttribute")}static addNumericAttribute(e,t,r=1,s=0){la("addNumericAttribute")}static entitiesCount(e){return 0}static attributes(e){la("attributes")}attributes(){return this.constructor.attributes(this._object)}static attribute(e,t){const r=this.attributes(e);if(r)return r[t]}attribute(e){return this.constructor.attribute(this._object,e)}static indexAttribute(e){la("indexAttribute")}static setIndexAttribute(e,t){console.warn("CoreVertex.setIndexAttribute needs to be overloaded")}static renameAttribute(e,t,r){const s=this.attributes(e);if(!s)return;const i=this.attribute(e,t);i&&(s[r]=i,delete s[t])}static deleteAttribute(e,t){const r=this.attributes(e);r&&delete r[t]}static attribSize(e,t){const r=this.attributes(e);return r?(t=Dt.remapName(t),r[t].itemSize||0):-1}attribSize(e){return this.constructor.attribSize(this._object,e)}static hasAttribute(e,t){return this.attribute(e,t)!=null}hasAttribute(e){return this.constructor.hasAttribute(this._object,e)}static attributeNames(e){const t=this.attributes(e);return t?Object.keys(t):[]}static attributeNamesMatchingMask(e,t){return Dt.attribNamesMatchingMask(t,this.attributeNames(e))}static attribValue(e,t,r,s){if(r===vt.VERTEX_INDEX)return t;{let i=null,o=null;r[r.length-2]===Cv&&(i=r[r.length-1],o=bv[i],r=r.substring(0,r.length-2));const a=Dt.remapName(r),c=this.attribute(e,a);if(c){const{array:l}=c,u=c.itemSize,h=t*u;if(o==null)switch(u){case 1:return l[h];case 2:return s=s||new W,s.fromArray(l,h),s;case 3:return s=s||new T,s.fromArray(l,h),s;case 4:return s=s||new We,s.fromArray(l,h),s;default:throw`size not valid (${u})`}else switch(u){case 1:return l[h];default:return l[h+o]}}else{const l=this.attributes()||{},u=Object.keys(l),h=`attrib ${r} not found. availables are: ${u.join(",")}`;throw console.warn(h),h}}}attribValue(e,t){return this.constructor.attribValue(this._object,this._index,e,t)}attribValueNumber(e){const t=this.attribute(e);return t?t.array[this._index]:0}attribValueVector2(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*2),t}attribValueVector3(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*3),t}attribValueVector4(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*4),t}static attribType(e,t){const r=e?this.attribute(e,t):null;return r&&(r==null?void 0:r.isString)==!0?Hn.STRING:Hn.NUMERIC}attribType(e){return this.constructor.attribType(this._object,e)}static stringAttribValue(e,t,r){return this.attribValue(e,t,r)}stringAttribValue(e){return this.attribValue(e)}position(e){return la("position"),e}setPosition(e){this.setAttribValueFromVector3(vt.POSITION,e)}normal(e){return la("normal"),e}setNormal(e){return this.setAttribValueFromVector3(vt.NORMAL,e)}setAttribValue(e,t){const r=this.attribute(e);if(!r){console.warn(`no attribute ${e}`);return}const s=r.array,i=r.itemSize;if(_t(t)){for(let o=0;o<i;o++)s[this._index*i+o]=t[o];return}switch(i){case 1:s[this._index]=t;break;case 2:const o=t,a=this._index*2;s[a+0]=o.x,s[a+1]=o.y;break;case 3:const c=t.r!=null,l=this._index*3;if(c){const d=t;s[l+0]=d.r,s[l+1]=d.g,s[l+2]=d.b}else{const d=t;s[l+0]=d.x,s[l+1]=d.y,s[l+2]=d.z}break;case 4:const u=t,h=this._index*4;s[h+0]=u.x,s[h+1]=u.y,s[h+2]=u.z,s[h+3]=u.w;break;default:throw console.warn(`CoreVertex.setAttribValue does not yet allow attrib size ${i}`),`attrib size ${i} not implemented`}}setAttribValueFromNumber(e,t){const r=this.attribute(e);if(!r)return;const s=r.array;s[this._index]=t}setAttribValueFromVector2(e,t){const r=this.attribute(e);!r||r.isString==!0||t.toArray(r.array,this._index*2)}setAttribValueFromVector3(e,t){const r=this.attribute(e);!r||r.isString==!0||t.toArray(r.array,this._index*3)}setAttribValueFromVector4(e,t){const r=this.attribute(e);!r||r.isString==!0||t.toArray(r.array,this._index*4)}static relatedObjectClass(e){return this.relatedPrimitiveClass(e).relatedObjectClass(e)}relatedEntities(e,t,r,s){switch(e){case rt.POINT:{this.relatedPoints(r,s);return}case rt.VERTEX:{r.length=1,r[0]=this;return}case rt.PRIMITIVE:{this.relatedPrimitives(r,s);return}case rt.OBJECT:{this.relatedObjects(r,s);return}case rt.CORE_GROUP:{r.length=1,r[0]=t;return}}St.unreachable(e)}}function jz(n){return uR(n).entitiesCount(n)}function eC(n,e,t){t.length=0;const r=new Map;for(const s of n){const i=e(s);for(const o of i){let a=r.get(o.index());a||(a=o,r.set(a.index(),a))}}r.forEach(s=>{t.push(s)})}const tC=[],Qf=new Set;function jd(n,e,t){t.length=0,Qf.clear();for(const r of n){e(r,tC);for(const s of tC)Qf.add(s)}Qf.forEach(r=>{t.push(r)})}function Xl(n){return n instanceof xe||n instanceof W||n instanceof T||n instanceof We}function WM(n,e){e instanceof xe&&n instanceof xe&&e.copy(n),e instanceof W&&n instanceof W&&e.copy(n),e instanceof T&&n instanceof T&&e.copy(n),e instanceof We&&n instanceof We&&e.copy(n)}function XM(n){if(n instanceof xe||n instanceof W||n instanceof T||n instanceof We)return n.clone()}function Sv(n,e,t=1,r=0,s){s.values.length=0;const i=s.values,o=e(n);if(Ye(r)){for(let a=0;a<o;a++)for(let c=0;c<t;c++)i.push(r);s.attributeAdded=!0}else if(t>1)if(_t(r)){for(let a=0;a<o;a++)for(let c=0;c<t;c++)i.push(r[c]);s.attributeAdded=!0}else{const a=r;if(t==2&&a.x!=null&&a.y!=null){for(let h=0;h<o;h++)i.push(a.x),i.push(a.y);s.attributeAdded=!0}const c=r;if(t==3&&c.x!=null&&c.y!=null&&c.z!=null){for(let h=0;h<o;h++)i.push(c.x),i.push(c.y),i.push(c.z);s.attributeAdded=!0}const l=r;if(t==3&&l.r!=null&&l.g!=null&&l.b!=null){for(let h=0;h<o;h++)i.push(l.r),i.push(l.g),i.push(l.b);s.attributeAdded=!0}const u=r;if(t==4&&u.x!=null&&u.y!=null&&u.z!=null&&u.w!=null){for(let h=0;h<o;h++)i.push(u.x),i.push(u.y),i.push(u.z),i.push(u.w);s.attributeAdded=!0}}}const em={attributeAdded:!1,values:[]};class Vo extends Hz{constructor(e,t){super(e,t),this._updateGeometry()}setIndex(e,t){return this._index=e,t&&(this._object=t,this._updateGeometry()),this}_updateGeometry(){const e=this._object.geometry;e&&(this._geometry=e)}geometry(){return this._geometry}static addAttribute(e,t,r){const s=this.attributes(e);s&&(s[t]=r)}static addNumericAttribute(e,t,r=1,s=0){const i=this.entitiesCount(e);em.values=new Array(i*r),Sv(e,jz,r,s,em);const o={isString:!1,array:em.values,itemSize:r};this.addAttribute(e,t,o)}static attributes(e){const t=e.geometry;if(t)return t.userData.vertexAttributes||(t.userData.vertexAttributes={}),t.userData.vertexAttributes}static indexAttribute(e){const t=e.geometry;if(t)return t.getIndex()}static setIndexAttribute(e,t){const r=e.geometry;r&&r.setIndex(t)}static entitiesCount(e){const t=e.geometry;if(!t)return 0;const r=t.getIndex();return r?r.count:0}position(e){return console.warn("CoreThreejsVertex.position not implemented"),e}normal(e){return console.warn("CoreThreejsVertex.normal not implemented"),e}static relatedPrimitiveIds(e,t,r){r.length=1;const s=Math.floor(t/dj(e));r[0]=s}static relatedPointIds(e,t,r){r.length=0;const s=e.geometry;if(!s)return;const i=s.getIndex();if(!i)return;const a=i.array[t];r[0]=a}static relatedPointClass(e){return Vr}static relatedPrimitiveClass(e){return Al(e)}}function Wz(n){const e=n.clone();return n.userData&&(e.userData=Ii(n.userData)),e}function Xz(n,e,t){n.forEach((r,s)=>{(!t&&r||t&&!r)&&e.add(s.index())})}const ua=new Set,ha=new Set,tm="groups";class Lp{constructor(e){this._object=e,this.selectedIndices=new Set}attributesDictionary(){return Lp.attributesDictionary(this._object)}static attributesDictionary(e){return e.userData[tm]||this._createAttributesDictionaryIfNone(e)}static _createAttributesDictionaryIfNone(e){if(!e.userData[tm])return e.userData[tm]={}}findOrCreateGroup(e,t){const r=this.attributesDictionary();let s=r[e];s||(s={},r[e]=s);let i=s[t];return i||(i=[],s[t]=i),i}deleteGroup(e,t){const r=this.attributesDictionary(),s=r[e];s&&(delete s[t],Object.keys(s).length==0&&delete r[e])}static data(e){const t=this.attributesDictionary(e),r=Object.keys(t),s={};for(const i of r){const o=[];s[i]=o;const a=t[i],c=Object.keys(a);for(const l of c){const u=a[l],h={name:l,entitiesCount:u.length};o.push(h)}}return s}indicesSet(e,t,r){const i=this.attributesDictionary()[e];if(r.clear(),i){const o=i[t];o&&gs(o,r)}}updateGroup(e,t){const{type:r,groupName:s,operation:i,invert:o}=e,a=this.findOrCreateGroup(r,s),c=l=>{const u=this.attributesDictionary();let h=u[r];h||(h={},u[r]=h);const d=[];h[s]=rr(l,d)};switch(this.selectedIndices.clear(),Xz(t,this.selectedIndices,o),i){case"replace existing":{c(this.selectedIndices);return}case"add to existing":{gs(a,ua),zT(ua,this.selectedIndices,ha),c(ha);return}case"subtract from existing":{gs(a,ua),HT(ua,this.selectedIndices,ha),c(ha);return}case"intersect with existing":{gs(a,ua),sk(ua,this.selectedIndices,ha),c(ha);return}}St.unreachable(i)}}function $M(n){const e=Xn(n)?n.children.length:0,t=Xn(n)?kz(n):n.type,r=Lp.data(n);return{type:t,name:n.name,childrenCount:e,groupData:r,verticesCount:0,pointsCount:0,primitivesCount:0,primitiveName:"no name"}}function $z(n){const e=new Map;for(const r of n){const s=r.attribNames();for(const i of s){const o=r.attribSize(i);fr(e,i,o)}}const t={};return e.forEach((r,s)=>{t[s]=rr(r,[])}),t}function qz(n){const e=new Map;for(const r of n){const s=r.attribNames();for(const i of s){const o=r.attribType(i);fr(e,i,o)}}const t={};return e.forEach((r,s)=>{t[s]=rr(r,[])}),t}function Yz(n){const e=new Set;for(const t of n){const r=t.attribNames();for(const s of r)e.add(s)}return rr(e,[])}var be=(n=>(n.ANIM="anim",n.AUDIO="audio",n.COP="cop",n.EVENT="event",n.GL="gl",n.JS="js",n.MANAGER="manager",n.MAT="mat",n.OBJ="obj",n.POST="post",n.ROP="rop",n.SOP="sop",n))(be||{}),Ac=(n=>(n.ACTOR="actorsNetwork",n.ANIM="animationsNetwork",n.AUDIO="audioNetwork",n.COP="copNetwork",n.CSG="csgNetwork",n.EVENT="eventsNetwork",n.MAT="materialsNetwork",n.POST="postProcessNetwork",n.ROP="renderersNetwork",n.SOLVER="solver",n.SUBNET="subnet",n.DECOMPOSE="decompose",n))(Ac||{}),V_=(n=>(n.INPUT="subnetInput",n.OUTPUT="subnetOutput",n))(V_||{}),lc=(n=>(n.CUBE="cubeCamera",n.MAPBOX="mapboxCamera",n.ORTHOGRAPHIC="orthographicCamera",n.PERSPECTIVE="perspectiveCamera",n))(lc||{}),zo=(n=>(n.CONTROLS="cameraControls",n.CSS_RENDERER="cameraCSSRenderer",n.FPS="cameraFPS",n.FRAME_MODE="cameraFrameMode",n.POST_PROCESS="cameraPostProcess",n.RENDER_SCENE="cameraRenderScene",n.RENDERER="cameraRenderer",n.VIEWER_CODE="cameraViewerCode",n.VIEW_OFFSET="cameraViewOffset",n.WEBXR_AR="cameraWebXRAR",n.WEBXR_VR="cameraWebXRVR",n.WEBXR_AR_MARKER_TRACKING="cameraWebXRARMarkerTracking",n))(zo||{}),qM=(n=>(n.MAP="cameraMapControls",n.ORBIT="cameraOrbitControls",n.PAN_ZOOM="cameraPanZoomControls",n.FIRST_PERSON="firstPersonControls",n.PLAYER="playerControls",n.MOBILE_JOYSTICK="mobileJoystickControls",n))(qM||{});class Fp{constructor(e,t,r){if(this._type=e,this._name=t,this._defaultValue=r,t==""||t==null)throw new Error("name must not be an empty string")}static fromParam(e){return new Fp(e.type(),e.name(),e.defaultValue())}type(){return this._type}name(){return this._name}defaultValue(){return this._defaultValue}paramOptions(){const e=this._callback.bind(this);switch(this._type){case J.NODE_PATH:return{callback:e,nodeSelection:{context:be.COP}};default:return{callback:e}}}applyToNode(e){if(!e.params.has(this._name))return;const t=e.params.get(this._name);if(!t)return;const r=this.paramOptions(),s=Object.keys(r);for(const i of s)t.options.setOption(i,r[i]);this.executeCallback(e,t),t.type()==J.NODE_PATH&&setTimeout(async()=>{t.isDirty()&&await t.compute(),t.options.executeCallback()},200)}executeCallback(e,t){this._callback(e,t)}_callback(e,t){}}class bo extends Fp{constructor(e,t,r,s){super(e,t,r),this._uniformName=s}toJSON(){return{type:this._type,name:this._name,defaultValue:this._defaultValue,uniformName:this._uniformName}}static fromJSON(e){return new bo(e.type,e.name,e.defaultValue,e.uniformName)}uniformName(){return this._uniformName}uniform(){return this._uniform=this._uniform||this._createUniform()}_createUniform(){return bo.uniformByType(this._type)}_callback(e,t){bo.callback(t,this.uniform())}static callback(e,t){switch(e.type()){case J.RAMP:t.value=e.rampTexture();return;case J.NODE_PATH:bo.setUniformValueFromTextureFromNodePathParam(e,t);return;default:t.value=e.value}}static uniformByType(e){switch(e){case J.BOOLEAN:return{value:0};case J.BUTTON:return{value:0};case J.COLOR:return{value:new xe(0,0,0)};case J.FLOAT:return{value:0};case J.FOLDER:return{value:0};case J.INTEGER:return{value:0};case J.NODE_PATH:return{value:0};case J.PARAM_PATH:return{value:0};case J.RAMP:return{value:null};case J.STRING:return{value:null};case J.VECTOR2:return{value:new W(0,0)};case J.VECTOR3:return{value:new T(0,0,0)};case J.VECTOR4:return{value:new We(0,0,0,0)}}St.unreachable(e)}static async setUniformValueFromTextureFromNodePathParam(e,t){e.isDirty()&&await e.compute();const r=e.value.nodeWithContext(be.COP);if(r){r.isDirty()&&await r.compute();const i=r.containerController.container().texture();t.value=i}else t.value=null}}function Kz(n,e,t){const r=$l.getUniforms(n);if(r){const s=r[e];s?s.value=t.value:r[e]=t}else uc.addAdditionalTexture(n,e,t)}class $l{static getUniforms(e){var t;return((t=e.userData)==null?void 0:t.uniforms)||e.uniforms}static setUniforms(e,t){e.userData.uniforms=t}static removeUniforms(e){const t=this.getUniforms(e);if(t){const r=e.userData;delete r.uniforms}return t}}function z_(n,e,t){uc.setData(e,t),e.onBeforeCompile=Jz(n,e);const r=`${e.uuid}:${performance.now()}`;e.customProgramCacheKey=()=>r}function Zz(n,e){const{src:t,dest:r,shareCustomUniforms:s}=e,i=uc.getData(t);if(i){const a=s?i:function(c){const l=Va.toJSON(c);return Va.fromJSON(l)}(i);z_(n,r,a)}}function Jz(n,e){return r=>{const s=uc.getData(e);if(!s)return;const{vertexShader:i,fragmentShader:o,paramConfigs:a,additionalTextureUniforms:c,timeDependent:l,resolutionDependent:u,raymarchingLightsWorldCoordsDependent:h}=s;r.vertexShader=i,r.fragmentShader=o,n.uniformsController.addUniforms(r.uniforms,{paramConfigs:a,additionalTextureUniforms:c,timeDependent:l,resolutionDependent:u,raymarchingLightsWorldCoordsDependent:h});const d=e;d.vertexShader=r.vertexShader,d.fragmentShader=r.fragmentShader,$l.setUniforms(e,r.uniforms)}}class uc{static setData(e,t){e.userData.onBeforeCompileData=t}static addAdditionalTexture(e,t,r){const s=this.getData(e);s?s.additionalTextureUniforms[t]==null&&(s.additionalTextureUniforms[t]=r):console.warn("no data found on material",e)}static getData(e){return e.userData.onBeforeCompileData}static removeData(e){const t=this.getData(e);if(t){const r=e.userData;delete r.onBeforeCompileData}return t}}class Va{static toJSON(e){return{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,timeDependent:e.timeDependent,resolutionDependent:e.resolutionDependent,raymarchingLightsWorldCoordsDependent:e.raymarchingLightsWorldCoordsDependent,paramConfigs:e.paramConfigs.map(r=>r.toJSON())}}static fromJSON(e){return{...e,additionalTextureUniforms:{},paramConfigs:e.paramConfigs.map(r=>bo.fromJSON(r))}}}var gd=(n=>(n.DISTANCE="customDistanceMaterial",n.DEPTH="customDepthMaterial",n.DEPTH_DOF="customDepthDOFMaterial",n))(gd||{});const Qz="POLY_render_hook",eH=(n,e,t,r,s,i)=>{};function Av(n,e,t){const r=e.clone(),s=e.uniforms;if(s&&(r.uniforms=XA.clone(s)),Zz(n,{src:e,dest:r,shareCustomUniforms:t.shareCustomUniforms}),e.customMaterials&&t.addCustomMaterials){const i=Object.keys(e.customMaterials);i.length>0&&(r.customMaterials={});for(const o of i){const a=o,c=e.customMaterials[a];if(c){const l=Av(n,c,{...t,addCustomMaterials:!1});r.customMaterials[a]=l}}}return r}function Tv(n,e){const t=e;if(t.customMaterials)for(const r of Object.keys(t.customMaterials)){const s=r,i=t.customMaterials[s];i&&(n[s]=i,i.needsUpdate=!0)}}function tH(n,e){if(e.userData){const t=e.userData[Qz];if(t){n.onBeforeRender=(r,s,i,o,a,c)=>{t(r,s,i,o,a,c,n)};return}}n.onBeforeRender=eH}function nH(n,e,t,r){Kz(n,e,t),r&&YM(n,e,t,r)}function YM(n,e,t,r){r.addAdditionalTextureUniforms(e,t)}class Cu{static node(e,t){return e.node(t.name)}}Cu.clone=Av;Cu.applyCustomMaterials=Tv;Cu.assignUniforms=nH;Cu.assignUniformForOnBeforeCompile=YM;const Mv=0,rH=1,sH=2,nC=2,nm=1.25,rC=1,El=6*4+4+4,Up=65535,iH=Math.pow(2,-24),rm=Symbol("SKIP_GENERATION");function oH(n){return n.index?n.index.count:n.attributes.position.count}function Tc(n){return oH(n)/3}function aH(n,e=ArrayBuffer){return n>65535?new Uint32Array(new e(4*n)):new Uint16Array(new e(2*n))}function cH(n,e){if(!n.index){const t=n.attributes.position.count,r=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=aH(t,r);n.setIndex(new Lt(s,1));for(let i=0;i<t;i++)s[i]=i}}function KM(n){const e=Tc(n),t=n.drawRange,r=t.start/3,s=(t.start+t.count)/3,i=Math.max(0,r),o=Math.min(e,s)-i;return[{offset:Math.floor(i),count:Math.floor(o)}]}function ZM(n){if(!n.groups||!n.groups.length)return KM(n);const e=[],t=new Set,r=n.drawRange,s=r.start/3,i=(r.start+r.count)/3;for(const a of n.groups){const c=a.start/3,l=(a.start+a.count)/3;t.add(Math.max(s,c)),t.add(Math.min(i,l))}const o=Array.from(t.values()).sort((a,c)=>a-c);for(let a=0;a<o.length-1;a++){const c=o[a],l=o[a+1];e.push({offset:Math.floor(c),count:Math.floor(l-c)})}return e}function lH(n){if(n.groups.length===0)return!1;const e=Tc(n),t=ZM(n).sort((i,o)=>i.offset-o.offset),r=t[t.length-1];r.count=Math.min(e-r.offset,r.count);let s=0;return t.forEach(({count:i})=>s+=i),e!==s}function sm(n,e,t,r,s){let i=1/0,o=1/0,a=1/0,c=-1/0,l=-1/0,u=-1/0,h=1/0,d=1/0,p=1/0,_=-1/0,g=-1/0,f=-1/0;for(let m=e*6,y=(e+t)*6;m<y;m+=6){const v=n[m+0],b=n[m+1],x=v-b,E=v+b;x<i&&(i=x),E>c&&(c=E),v<h&&(h=v),v>_&&(_=v);const S=n[m+2],R=n[m+3],C=S-R,M=S+R;C<o&&(o=C),M>l&&(l=M),S<d&&(d=S),S>g&&(g=S);const G=n[m+4],F=n[m+5],X=G-F,N=G+F;X<a&&(a=X),N>u&&(u=N),G<p&&(p=G),G>f&&(f=G)}r[0]=i,r[1]=o,r[2]=a,r[3]=c,r[4]=l,r[5]=u,s[0]=h,s[1]=d,s[2]=p,s[3]=_,s[4]=g,s[5]=f}function uH(n,e=null,t=null,r=null){const s=n.attributes.position,i=n.index?n.index.array:null,o=Tc(n),a=s.normalized;let c;e===null?(c=new Float32Array(o*6*4),t=0,r=o):(c=e,t=t||0,r=r||o);const l=s.array,u=s.offset||0;let h=3;s.isInterleavedBufferAttribute&&(h=s.data.stride);const d=["getX","getY","getZ"];for(let p=t;p<t+r;p++){const _=p*3,g=p*6;let f=_+0,m=_+1,y=_+2;i&&(f=i[f],m=i[m],y=i[y]),a||(f=f*h+u,m=m*h+u,y=y*h+u);for(let v=0;v<3;v++){let b,x,E;a?(b=s[d[v]](f),x=s[d[v]](m),E=s[d[v]](y)):(b=l[f+v],x=l[m+v],E=l[y+v]);let S=b;x<S&&(S=x),E<S&&(S=E);let R=b;x>R&&(R=x),E>R&&(R=E);const C=(R-S)/2,M=v*2;c[g+M+0]=S+C,c[g+M+1]=C+(Math.abs(S)+C)*iH}}return c}function Kt(n,e,t){return t.min.x=e[n],t.min.y=e[n+1],t.min.z=e[n+2],t.max.x=e[n+3],t.max.y=e[n+4],t.max.z=e[n+5],t}function sC(n){let e=-1,t=-1/0;for(let r=0;r<3;r++){const s=n[r+3]-n[r];s>t&&(t=s,e=r)}return e}function iC(n,e){e.set(n)}function oC(n,e,t){let r,s;for(let i=0;i<3;i++){const o=i+3;r=n[i],s=e[i],t[i]=r<s?r:s,r=n[o],s=e[o],t[o]=r>s?r:s}}function xh(n,e,t){for(let r=0;r<3;r++){const s=e[n+2*r],i=e[n+2*r+1],o=s-i,a=s+i;o<t[r]&&(t[r]=o),a>t[r+3]&&(t[r+3]=a)}}function Hc(n){const e=n[3]-n[0],t=n[4]-n[1],r=n[5]-n[2];return 2*(e*t+t*r+r*e)}const ks=32,hH=(n,e)=>n.candidate-e.candidate,fi=new Array(ks).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),bh=new Float32Array(6);function dH(n,e,t,r,s,i){let o=-1,a=0;if(i===Mv)o=sC(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(i===rH)o=sC(n),o!==-1&&(a=pH(t,r,s,o));else if(i===sH){const c=Hc(n);let l=nm*s;const u=r*6,h=(r+s)*6;for(let d=0;d<3;d++){const p=e[d],f=(e[d+3]-p)/ks;if(s<ks/4){const m=[...fi];m.length=s;let y=0;for(let b=u;b<h;b+=6,y++){const x=m[y];x.candidate=t[b+2*d],x.count=0;const{bounds:E,leftCacheBounds:S,rightCacheBounds:R}=x;for(let C=0;C<3;C++)R[C]=1/0,R[C+3]=-1/0,S[C]=1/0,S[C+3]=-1/0,E[C]=1/0,E[C+3]=-1/0;xh(b,t,E)}m.sort(hH);let v=s;for(let b=0;b<v;b++){const x=m[b];for(;b+1<v&&m[b+1].candidate===x.candidate;)m.splice(b+1,1),v--}for(let b=u;b<h;b+=6){const x=t[b+2*d];for(let E=0;E<v;E++){const S=m[E];x>=S.candidate?xh(b,t,S.rightCacheBounds):(xh(b,t,S.leftCacheBounds),S.count++)}}for(let b=0;b<v;b++){const x=m[b],E=x.count,S=s-x.count,R=x.leftCacheBounds,C=x.rightCacheBounds;let M=0;E!==0&&(M=Hc(R)/c);let G=0;S!==0&&(G=Hc(C)/c);const F=rC+nm*(M*E+G*S);F<l&&(o=d,l=F,a=x.candidate)}}else{for(let v=0;v<ks;v++){const b=fi[v];b.count=0,b.candidate=p+f+v*f;const x=b.bounds;for(let E=0;E<3;E++)x[E]=1/0,x[E+3]=-1/0}for(let v=u;v<h;v+=6){let E=~~((t[v+2*d]-p)/f);E>=ks&&(E=ks-1);const S=fi[E];S.count++,xh(v,t,S.bounds)}const m=fi[ks-1];iC(m.bounds,m.rightCacheBounds);for(let v=ks-2;v>=0;v--){const b=fi[v],x=fi[v+1];oC(b.bounds,x.rightCacheBounds,b.rightCacheBounds)}let y=0;for(let v=0;v<ks-1;v++){const b=fi[v],x=b.count,E=b.bounds,R=fi[v+1].rightCacheBounds;x!==0&&(y===0?iC(E,bh):oC(E,bh,bh)),y+=x;let C=0,M=0;y!==0&&(C=Hc(bh)/c);const G=s-y;G!==0&&(M=Hc(R)/c);const F=rC+nm*(C*y+M*G);F<l&&(o=d,l=F,a=b.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${i} used.`);return{axis:o,pos:a}}function pH(n,e,t,r){let s=0;for(let i=e,o=e+t;i<o;i++)s+=n[i*6+r*2];return s/t}class im{constructor(){this.boundingData=new Float32Array(6)}}function fH(n,e,t,r,s,i){let o=r,a=r+s-1;const c=i.pos,l=i.axis*2;for(;;){for(;o<=a&&t[o*6+l]<c;)o++;for(;o<=a&&t[a*6+l]>=c;)a--;if(o<a){for(let u=0;u<3;u++){let h=e[o*3+u];e[o*3+u]=e[a*3+u],e[a*3+u]=h}for(let u=0;u<6;u++){let h=t[o*6+u];t[o*6+u]=t[a*6+u],t[a*6+u]=h}o++,a--}else return o}}function mH(n,e,t,r,s,i){let o=r,a=r+s-1;const c=i.pos,l=i.axis*2;for(;;){for(;o<=a&&t[o*6+l]<c;)o++;for(;o<=a&&t[a*6+l]>=c;)a--;if(o<a){let u=n[o];n[o]=n[a],n[a]=u;for(let h=0;h<6;h++){let d=t[o*6+h];t[o*6+h]=t[a*6+h],t[a*6+h]=d}o++,a--}else return o}}function tr(n,e){return e[n+15]===65535}function ur(n,e){return e[n+6]}function Nr(n,e){return e[n+14]}function Ir(n){return n+8}function Dr(n,e){return e[n+6]}function JM(n,e){return e[n+7]}let QM,cl,vd,eR;const _H=Math.pow(2,32);function H_(n){return"count"in n?1:1+H_(n.left)+H_(n.right)}function gH(n,e,t){return QM=new Float32Array(t),cl=new Uint32Array(t),vd=new Uint16Array(t),eR=new Uint8Array(t),j_(n,e)}function j_(n,e){const t=n/4,r=n/2,s="count"in e,i=e.boundingData;for(let o=0;o<6;o++)QM[t+o]=i[o];if(s)if(e.buffer){const o=e.buffer;eR.set(new Uint8Array(o),n);for(let a=n,c=n+o.byteLength;a<c;a+=El){const l=a/2;tr(l,vd)||(cl[a/4+6]+=t)}return n+o.byteLength}else{const o=e.offset,a=e.count;return cl[t+6]=o,vd[r+14]=a,vd[r+15]=Up,n+El}else{const o=e.left,a=e.right,c=e.splitAxis;let l;if(l=j_(n+El,o),l/4>_H)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return cl[t+6]=l/4,l=j_(l,a),cl[t+7]=c,l}}function vH(n,e){const t=(n.index?n.index.count:n.attributes.position.count)/3,r=t>2**16,s=r?4:2,i=e?new SharedArrayBuffer(t*s):new ArrayBuffer(t*s),o=r?new Uint32Array(i):new Uint16Array(i);for(let a=0,c=o.length;a<c;a++)o[a]=a;return o}function yH(n,e,t,r,s){const{maxDepth:i,verbose:o,maxLeafTris:a,strategy:c,onProgress:l,indirect:u}=s,h=n._indirectBuffer,d=n.geometry,p=d.index?d.index.array:null,_=u?mH:fH,g=Tc(d),f=new Float32Array(6);let m=!1;const y=new im;return sm(e,t,r,y.boundingData,f),b(y,t,r,f),y;function v(x){l&&l(x/g)}function b(x,E,S,R=null,C=0){if(!m&&C>=i&&(m=!0,o&&(console.warn(`MeshBVH: Max depth of ${i} reached when generating BVH. Consider increasing maxDepth.`),console.warn(d))),S<=a||C>=i)return v(E+S),x.offset=E,x.count=S,x;const M=dH(x.boundingData,R,e,E,S,c);if(M.axis===-1)return v(E+S),x.offset=E,x.count=S,x;const G=_(h,p,e,E,S,M);if(G===E||G===E+S)v(E+S),x.offset=E,x.count=S;else{x.splitAxis=M.axis;const F=new im,X=E,N=G-E;x.left=F,sm(e,X,N,F.boundingData,f),b(F,X,N,f,C+1);const j=new im,K=G,$=S-N;x.right=j,sm(e,K,$,j.boundingData,f),b(j,K,$,f,C+1)}return x}}function xH(n,e){const t=n.geometry;e.indirect&&(n._indirectBuffer=vH(t,e.useSharedArrayBuffer),lH(t)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),n._indirectBuffer||cH(t,e);const r=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=uH(t),i=e.indirect?KM(t):ZM(t);n._roots=i.map(o=>{const a=yH(n,s,o.offset,o.count,e),c=H_(a),l=new r(El*c);return gH(0,a,l),l})}class ei{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let r=1/0,s=-1/0;for(let i=0,o=e.length;i<o;i++){const c=e[i][t];r=c<r?c:r,s=c>s?c:s}this.min=r,this.max=s}setFromPoints(e,t){let r=1/0,s=-1/0;for(let i=0,o=t.length;i<o;i++){const a=t[i],c=e.dot(a);r=c<r?c:r,s=c>s?c:s}this.min=r,this.max=s}isSeparated(e){return this.min>e.max||e.min>this.max}}ei.prototype.setFromBox=function(){const n=new T;return function(t,r){const s=r.min,i=r.max;let o=1/0,a=-1/0;for(let c=0;c<=1;c++)for(let l=0;l<=1;l++)for(let u=0;u<=1;u++){n.x=s.x*c+i.x*(1-c),n.y=s.y*l+i.y*(1-l),n.z=s.z*u+i.z*(1-u);const h=t.dot(n);o=Math.min(h,o),a=Math.max(h,a)}this.min=o,this.max=a}}();const bH=function(){const n=new T,e=new T,t=new T;return function(s,i,o){const a=s.start,c=n,l=i.start,u=e;t.subVectors(a,l),n.subVectors(s.end,s.start),e.subVectors(i.end,i.start);const h=t.dot(u),d=u.dot(c),p=u.dot(u),_=t.dot(c),f=c.dot(c)*p-d*d;let m,y;f!==0?m=(h*d-_*p)/f:m=0,y=(h+m*d)/p,o.x=m,o.y=y}}(),Rv=function(){const n=new W,e=new T,t=new T;return function(s,i,o,a){bH(s,i,n);let c=n.x,l=n.y;if(c>=0&&c<=1&&l>=0&&l<=1){s.at(c,o),i.at(l,a);return}else if(c>=0&&c<=1){l<0?i.at(0,a):i.at(1,a),s.closestPointToPoint(a,!0,o);return}else if(l>=0&&l<=1){c<0?s.at(0,o):s.at(1,o),i.closestPointToPoint(o,!0,a);return}else{let u;c<0?u=s.start:u=s.end;let h;l<0?h=i.start:h=i.end;const d=e,p=t;if(s.closestPointToPoint(h,!0,e),i.closestPointToPoint(u,!0,t),d.distanceToSquared(h)<=p.distanceToSquared(u)){o.copy(d),a.copy(h);return}else{o.copy(u),a.copy(p);return}}}}(),CH=function(){const n=new T,e=new T,t=new ar,r=new qs;return function(i,o){const{radius:a,center:c}=i,{a:l,b:u,c:h}=o;if(r.start=l,r.end=u,r.closestPointToPoint(c,!0,n).distanceTo(c)<=a||(r.start=l,r.end=h,r.closestPointToPoint(c,!0,n).distanceTo(c)<=a)||(r.start=u,r.end=h,r.closestPointToPoint(c,!0,n).distanceTo(c)<=a))return!0;const g=o.getPlane(t);if(Math.abs(g.distanceToPoint(c))<=a){const m=g.projectPoint(c,e);if(o.containsPoint(m))return!0}return!1}}(),EH=1e-15;function om(n){return Math.abs(n)<EH}class Jr extends Fn{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new T),this.satBounds=new Array(4).fill().map(()=>new ei),this.points=[this.a,this.b,this.c],this.sphere=new vr,this.plane=new ar,this.needsUpdate=!0}intersectsSphere(e){return CH(e,this)}update(){const e=this.a,t=this.b,r=this.c,s=this.points,i=this.satAxes,o=this.satBounds,a=i[0],c=o[0];this.getNormal(a),c.setFromPoints(a,s);const l=i[1],u=o[1];l.subVectors(e,t),u.setFromPoints(l,s);const h=i[2],d=o[2];h.subVectors(t,r),d.setFromPoints(h,s);const p=i[3],_=o[3];p.subVectors(r,e),_.setFromPoints(p,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}Jr.prototype.closestPointToSegment=function(){const n=new T,e=new T,t=new qs;return function(s,i=null,o=null){const{start:a,end:c}=s,l=this.points;let u,h=1/0;for(let d=0;d<3;d++){const p=(d+1)%3;t.start.copy(l[d]),t.end.copy(l[p]),Rv(t,s,n,e),u=n.distanceToSquared(e),u<h&&(h=u,i&&i.copy(n),o&&o.copy(e))}return this.closestPointToPoint(a,n),u=a.distanceToSquared(n),u<h&&(h=u,i&&i.copy(n),o&&o.copy(a)),this.closestPointToPoint(c,n),u=c.distanceToSquared(n),u<h&&(h=u,i&&i.copy(n),o&&o.copy(c)),Math.sqrt(h)}}();Jr.prototype.intersectsTriangle=function(){const n=new Jr,e=new Array(3),t=new Array(3),r=new ei,s=new ei,i=new T,o=new T,a=new T,c=new T,l=new T,u=new qs,h=new qs,d=new qs,p=new T;function _(g,f,m){const y=g.points;let v=0,b=-1;for(let x=0;x<3;x++){const{start:E,end:S}=u;E.copy(y[x]),S.copy(y[(x+1)%3]),u.delta(o);const R=om(f.distanceToPoint(E));if(om(f.normal.dot(o))&&R){m.copy(u),v=2;break}const C=f.intersectLine(u,p);if(!C&&R&&p.copy(E),(C||R)&&!om(p.distanceTo(S))){if(v<=1)(v===1?m.start:m.end).copy(p),R&&(b=v);else if(v>=2){(b===1?m.start:m.end).copy(p),v=2;break}if(v++,v===2&&b===-1)break}}return v}return function(f,m=null,y=!1){this.needsUpdate&&this.update(),f.isExtendedTriangle?f.needsUpdate&&f.update():(n.copy(f),n.update(),f=n);const v=this.plane,b=f.plane;if(Math.abs(v.normal.dot(b.normal))>1-1e-10){const x=this.satBounds,E=this.satAxes;t[0]=f.a,t[1]=f.b,t[2]=f.c;for(let C=0;C<4;C++){const M=x[C],G=E[C];if(r.setFromPoints(G,t),M.isSeparated(r))return!1}const S=f.satBounds,R=f.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let C=0;C<4;C++){const M=S[C],G=R[C];if(r.setFromPoints(G,e),M.isSeparated(r))return!1}for(let C=0;C<4;C++){const M=E[C];for(let G=0;G<4;G++){const F=R[G];if(i.crossVectors(M,F),r.setFromPoints(i,e),s.setFromPoints(i,t),r.isSeparated(s))return!1}}return m&&(y||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),m.start.set(0,0,0),m.end.set(0,0,0)),!0}else{const x=_(this,b,h);if(x===1&&f.containsPoint(h.end))return m&&(m.start.copy(h.end),m.end.copy(h.end)),!0;if(x!==2)return!1;const E=_(f,v,d);if(E===1&&this.containsPoint(d.end))return m&&(m.start.copy(d.end),m.end.copy(d.end)),!0;if(E!==2)return!1;if(h.delta(a),d.delta(c),a.dot(c)<0){let X=d.start;d.start=d.end,d.end=X}const S=h.start.dot(a),R=h.end.dot(a),C=d.start.dot(a),M=d.end.dot(a),G=R<C,F=S<M;return S!==M&&C!==R&&G===F?!1:(m&&(l.subVectors(h.start,d.start),l.dot(a)>0?m.start.copy(h.start):m.start.copy(d.start),l.subVectors(h.end,d.end),l.dot(a)<0?m.end.copy(h.end):m.end.copy(d.end)),!0)}}}();Jr.prototype.distanceToPoint=function(){const n=new T;return function(t){return this.closestPointToPoint(t,n),t.distanceTo(n)}}();Jr.prototype.distanceToTriangle=function(){const n=new T,e=new T,t=["a","b","c"],r=new qs,s=new qs;return function(o,a=null,c=null){const l=a||c?r:null;if(this.intersectsTriangle(o,l))return(a||c)&&(a&&l.getCenter(a),c&&l.getCenter(c)),0;let u=1/0;for(let h=0;h<3;h++){let d;const p=t[h],_=o[p];this.closestPointToPoint(_,n),d=_.distanceToSquared(n),d<u&&(u=d,a&&a.copy(n),c&&c.copy(_));const g=this[p];o.closestPointToPoint(g,n),d=g.distanceToSquared(n),d<u&&(u=d,a&&a.copy(g),c&&c.copy(n))}for(let h=0;h<3;h++){const d=t[h],p=t[(h+1)%3];r.set(this[d],this[p]);for(let _=0;_<3;_++){const g=t[_],f=t[(_+1)%3];s.set(o[g],o[f]),Rv(r,s,n,e);const m=n.distanceToSquared(e);m<u&&(u=m,a&&a.copy(n),c&&c.copy(e))}}return Math.sqrt(u)}}();class Zn{constructor(e,t,r){this.isOrientedBox=!0,this.min=new T,this.max=new T,this.matrix=new qe,this.invMatrix=new qe,this.points=new Array(8).fill().map(()=>new T),this.satAxes=new Array(3).fill().map(()=>new T),this.satBounds=new Array(3).fill().map(()=>new ei),this.alignedSatBounds=new Array(3).fill().map(()=>new ei),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),r&&this.matrix.copy(r)}set(e,t,r){this.min.copy(e),this.max.copy(t),this.matrix.copy(r),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}Zn.prototype.update=function(){return function(){const e=this.matrix,t=this.min,r=this.max,s=this.points;for(let l=0;l<=1;l++)for(let u=0;u<=1;u++)for(let h=0;h<=1;h++){const d=1*l|2*u|4*h,p=s[d];p.x=l?r.x:t.x,p.y=u?r.y:t.y,p.z=h?r.z:t.z,p.applyMatrix4(e)}const i=this.satBounds,o=this.satAxes,a=s[0];for(let l=0;l<3;l++){const u=o[l],h=i[l],d=1<<l,p=s[d];u.subVectors(a,p),h.setFromPoints(u,s)}const c=this.alignedSatBounds;c[0].setFromPointsField(s,"x"),c[1].setFromPointsField(s,"y"),c[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();Zn.prototype.intersectsBox=function(){const n=new ei;return function(t){this.needsUpdate&&this.update();const r=t.min,s=t.max,i=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(n.min=r.x,n.max=s.x,a[0].isSeparated(n)||(n.min=r.y,n.max=s.y,a[1].isSeparated(n))||(n.min=r.z,n.max=s.z,a[2].isSeparated(n)))return!1;for(let c=0;c<3;c++){const l=o[c],u=i[c];if(n.setFromBox(l,t),u.isSeparated(n))return!1}return!0}}();Zn.prototype.intersectsTriangle=function(){const n=new Jr,e=new Array(3),t=new ei,r=new ei,s=new T;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(n.copy(o),n.update(),o=n);const a=this.satBounds,c=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let d=0;d<3;d++){const p=a[d],_=c[d];if(t.setFromPoints(_,e),p.isSeparated(t))return!1}const l=o.satBounds,u=o.satAxes,h=this.points;for(let d=0;d<3;d++){const p=l[d],_=u[d];if(t.setFromPoints(_,h),p.isSeparated(t))return!1}for(let d=0;d<3;d++){const p=c[d];for(let _=0;_<4;_++){const g=u[_];if(s.crossVectors(p,g),t.setFromPoints(s,e),r.setFromPoints(s,h),t.isSeparated(r))return!1}}return!0}}();Zn.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();Zn.prototype.distanceToPoint=function(){const n=new T;return function(t){return this.closestPointToPoint(t,n),t.distanceTo(n)}}();Zn.prototype.distanceToBox=function(){const n=["x","y","z"],e=new Array(12).fill().map(()=>new qs),t=new Array(12).fill().map(()=>new qs),r=new T,s=new T;return function(o,a=0,c=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(c||l)&&(o.getCenter(s),this.closestPointToPoint(s,r),o.closestPointToPoint(r,s),c&&c.copy(r),l&&l.copy(s)),0;const u=a*a,h=o.min,d=o.max,p=this.points;let _=1/0;for(let f=0;f<8;f++){const m=p[f];s.copy(m).clamp(h,d);const y=m.distanceToSquared(s);if(y<_&&(_=y,c&&c.copy(m),l&&l.copy(s),y<u))return Math.sqrt(y)}let g=0;for(let f=0;f<3;f++)for(let m=0;m<=1;m++)for(let y=0;y<=1;y++){const v=(f+1)%3,b=(f+2)%3,x=m<<v|y<<b,E=1<<f|m<<v|y<<b,S=p[x],R=p[E];e[g].set(S,R);const M=n[f],G=n[v],F=n[b],X=t[g],N=X.start,j=X.end;N[M]=h[M],N[G]=m?h[G]:d[G],N[F]=y?h[F]:d[G],j[M]=d[M],j[G]=m?h[G]:d[G],j[F]=y?h[F]:d[G],g++}for(let f=0;f<=1;f++)for(let m=0;m<=1;m++)for(let y=0;y<=1;y++){s.x=f?d.x:h.x,s.y=m?d.y:h.y,s.z=y?d.z:h.z,this.closestPointToPoint(s,r);const v=s.distanceToSquared(r);if(v<_&&(_=v,c&&c.copy(r),l&&l.copy(s),v<u))return Math.sqrt(v)}for(let f=0;f<12;f++){const m=e[f];for(let y=0;y<12;y++){const v=t[y];Rv(m,v,r,s);const b=r.distanceToSquared(s);if(b<_&&(_=b,c&&c.copy(r),l&&l.copy(s),b<u))return Math.sqrt(b)}}return Math.sqrt(_)}}();class wv{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class SH extends wv{constructor(){super(()=>new Jr)}}const Lr=new SH;class AH{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=r=>{t&&e.push(t),t=r,this.float32Array=new Float32Array(r),this.uint16Array=new Uint16Array(r),this.uint32Array=new Uint32Array(r)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const Vt=new AH;let Li,za;const da=[],Ch=new wv(()=>new Ht);function TH(n,e,t,r,s,i){Li=Ch.getPrimitive(),za=Ch.getPrimitive(),da.push(Li,za),Vt.setBuffer(n._roots[e]);const o=W_(0,n.geometry,t,r,s,i);Vt.clearBuffer(),Ch.releasePrimitive(Li),Ch.releasePrimitive(za),da.pop(),da.pop();const a=da.length;return a>0&&(za=da[a-1],Li=da[a-2]),o}function W_(n,e,t,r,s=null,i=0,o=0){const{float32Array:a,uint16Array:c,uint32Array:l}=Vt;let u=n*2;if(tr(u,c)){const d=ur(n,l),p=Nr(u,c);return Kt(n,a,Li),r(d,p,!1,o,i+n,Li)}else{let M=function(F){const{uint16Array:X,uint32Array:N}=Vt;let j=F*2;for(;!tr(j,X);)F=Ir(F),j=F*2;return ur(F,N)},G=function(F){const{uint16Array:X,uint32Array:N}=Vt;let j=F*2;for(;!tr(j,X);)F=Dr(F,N),j=F*2;return ur(F,N)+Nr(j,X)};const d=Ir(n),p=Dr(n,l);let _=d,g=p,f,m,y,v;if(s&&(y=Li,v=za,Kt(_,a,y),Kt(g,a,v),f=s(y),m=s(v),m<f)){_=p,g=d;const F=f;f=m,m=F,y=v}y||(y=Li,Kt(_,a,y));const b=tr(_*2,c),x=t(y,b,f,o+1,i+_);let E;if(x===nC){const F=M(_),N=G(_)-F;E=r(F,N,!0,o+1,i+_,y)}else E=x&&W_(_,e,t,r,s,i,o+1);if(E)return!0;v=za,Kt(g,a,v);const S=tr(g*2,c),R=t(v,S,m,o+1,i+g);let C;if(R===nC){const F=M(g),N=G(g)-F;C=r(F,N,!0,o+1,i+g,v)}else C=R&&W_(g,e,t,r,s,i,o+1);return!!C}}const jc=new T,am=new T;function MH(n,e,t={},r=0,s=1/0){const i=r*r,o=s*s;let a=1/0,c=null;if(n.shapecast({boundsTraverseOrder:u=>(jc.copy(e).clamp(u.min,u.max),jc.distanceToSquared(e)),intersectsBounds:(u,h,d)=>d<a&&d<o,intersectsTriangle:(u,h)=>{u.closestPointToPoint(e,jc);const d=e.distanceToSquared(jc);return d<a&&(am.copy(jc),a=d,c=h),d<i}}),a===1/0)return null;const l=Math.sqrt(a);return t.point?t.point.copy(am):t.point=am.clone(),t.distance=l,t.faceIndex=c,t}const pa=new T,fa=new T,ma=new T,Eh=new W,Sh=new W,Ah=new W,aC=new T,cC=new T,lC=new T,Th=new T;function RH(n,e,t,r,s,i){let o;return i===bn?o=n.intersectTriangle(r,t,e,!0,s):o=n.intersectTriangle(e,t,r,i!==er,s),o===null?null:{distance:n.origin.distanceTo(s),point:s.clone()}}function wH(n,e,t,r,s,i,o,a,c){pa.fromBufferAttribute(e,i),fa.fromBufferAttribute(e,o),ma.fromBufferAttribute(e,a);const l=RH(n,pa,fa,ma,Th,c);if(l){r&&(Eh.fromBufferAttribute(r,i),Sh.fromBufferAttribute(r,o),Ah.fromBufferAttribute(r,a),l.uv=Fn.getInterpolation(Th,pa,fa,ma,Eh,Sh,Ah,new W)),s&&(Eh.fromBufferAttribute(s,i),Sh.fromBufferAttribute(s,o),Ah.fromBufferAttribute(s,a),l.uv1=Fn.getInterpolation(Th,pa,fa,ma,Eh,Sh,Ah,new W)),t&&(aC.fromBufferAttribute(t,i),cC.fromBufferAttribute(t,o),lC.fromBufferAttribute(t,a),l.normal=Fn.getInterpolation(Th,pa,fa,ma,aC,cC,lC,new T),l.normal.dot(n.direction)>0&&l.normal.multiplyScalar(-1));const u={a:i,b:o,c:a,normal:new T,materialIndex:0};Fn.getNormal(pa,fa,ma,u.normal),l.face=u,l.faceIndex=i}return l}function kp(n,e,t,r,s){const i=r*3;let o=i+0,a=i+1,c=i+2;const l=n.index;n.index&&(o=l.getX(o),a=l.getX(a),c=l.getX(c));const{position:u,normal:h,uv:d,uv1:p}=n.attributes,_=wH(t,u,h,d,p,o,a,c,e);return _?(_.faceIndex=r,s&&s.push(_),_):null}function mn(n,e,t,r){const s=n.a,i=n.b,o=n.c;let a=e,c=e+1,l=e+2;t&&(a=t.getX(a),c=t.getX(c),l=t.getX(l)),s.x=r.getX(a),s.y=r.getY(a),s.z=r.getZ(a),i.x=r.getX(c),i.y=r.getY(c),i.z=r.getZ(c),o.x=r.getX(l),o.y=r.getY(l),o.z=r.getZ(l)}function OH(n,e,t,r,s,i){const{geometry:o,_indirectBuffer:a}=n;for(let c=r,l=r+s;c<l;c++)kp(o,e,t,c,i)}function PH(n,e,t,r,s){const{geometry:i,_indirectBuffer:o}=n;let a=1/0,c=null;for(let l=r,u=r+s;l<u;l++){let h;h=kp(i,e,t,l),h&&h.distance<a&&(c=h,a=h.distance)}return c}function NH(n,e,t,r,s,i,o){const{geometry:a}=t,{index:c}=a,l=a.attributes.position;for(let u=n,h=e+n;u<h;u++){let d;if(d=u,mn(o,d*3,c,l),o.needsUpdate=!0,r(o,d,s,i))return!0}return!1}function IH(n,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=n.geometry,r=t.index?t.index.array:null,s=t.attributes.position;let i,o,a,c,l=0;const u=n._roots;for(let d=0,p=u.length;d<p;d++)i=u[d],o=new Uint32Array(i),a=new Uint16Array(i),c=new Float32Array(i),h(0,l),l+=i.byteLength;function h(d,p,_=!1){const g=d*2;if(a[g+15]===Up){const m=o[d+6],y=a[g+14];let v=1/0,b=1/0,x=1/0,E=-1/0,S=-1/0,R=-1/0;for(let C=3*m,M=3*(m+y);C<M;C++){let G=r[C];const F=s.getX(G),X=s.getY(G),N=s.getZ(G);F<v&&(v=F),F>E&&(E=F),X<b&&(b=X),X>S&&(S=X),N<x&&(x=N),N>R&&(R=N)}return c[d+0]!==v||c[d+1]!==b||c[d+2]!==x||c[d+3]!==E||c[d+4]!==S||c[d+5]!==R?(c[d+0]=v,c[d+1]=b,c[d+2]=x,c[d+3]=E,c[d+4]=S,c[d+5]=R,!0):!1}else{const m=d+8,y=o[d+6],v=m+p,b=y+p;let x=_,E=!1,S=!1;e?x||(E=e.has(v),S=e.has(b),x=!E&&!S):(E=!0,S=!0);const R=x||E,C=x||S;let M=!1;R&&(M=h(m,p,x));let G=!1;C&&(G=h(y,p,x));const F=M||G;if(F)for(let X=0;X<3;X++){const N=m+X,j=y+X,K=c[N],$=c[N+3],q=c[j],ne=c[j+3];c[d+X]=K<q?K:q,c[d+X+3]=$>ne?$:ne}return F}}}const uC=new Ht;function $i(n,e,t,r){return Kt(n,e,uC),t.intersectBox(uC,r)}function DH(n,e,t,r,s,i){const{geometry:o,_indirectBuffer:a}=n;for(let c=r,l=r+s;c<l;c++){let u=a?a[c]:c;kp(o,e,t,u,i)}}function LH(n,e,t,r,s){const{geometry:i,_indirectBuffer:o}=n;let a=1/0,c=null;for(let l=r,u=r+s;l<u;l++){let h;h=kp(i,e,t,o?o[l]:l),h&&h.distance<a&&(c=h,a=h.distance)}return c}function FH(n,e,t,r,s,i,o){const{geometry:a}=t,{index:c}=a,l=a.attributes.position;for(let u=n,h=e+n;u<h;u++){let d;if(d=t.resolveTriangleIndex(u),mn(o,d*3,c,l),o.needsUpdate=!0,r(o,d,s,i))return!0}return!1}const hC=new T;function UH(n,e,t,r,s){Vt.setBuffer(n._roots[e]),X_(0,n,t,r,s),Vt.clearBuffer()}function X_(n,e,t,r,s){const{float32Array:i,uint16Array:o,uint32Array:a}=Vt,c=n*2;if(tr(c,o)){const u=ur(n,a),h=Nr(c,o);OH(e,t,r,u,h,s)}else{const u=Ir(n);$i(u,i,r,hC)&&X_(u,e,t,r,s);const h=Dr(n,a);$i(h,i,r,hC)&&X_(h,e,t,r,s)}}const dC=new T,kH=["x","y","z"];function BH(n,e,t,r){Vt.setBuffer(n._roots[e]);const s=$_(0,n,t,r);return Vt.clearBuffer(),s}function $_(n,e,t,r){const{float32Array:s,uint16Array:i,uint32Array:o}=Vt;let a=n*2;if(tr(a,i)){const l=ur(n,o),u=Nr(a,i);return PH(e,t,r,l,u)}else{const l=JM(n,o),u=kH[l],d=r.direction[u]>=0;let p,_;d?(p=Ir(n),_=Dr(n,o)):(p=Dr(n,o),_=Ir(n));const f=$i(p,s,r,dC)?$_(p,e,t,r):null;if(f){const v=f.point[u];if(d?v<=s[_+l]:v>=s[_+l+3])return f}const y=$i(_,s,r,dC)?$_(_,e,t,r):null;return f&&y?f.distance<=y.distance?f:y:f||y||null}}const Mh=new Ht,_a=new Jr,ga=new Jr,Wc=new qe,pC=new Zn,Rh=new Zn;function GH(n,e,t,r){Vt.setBuffer(n._roots[e]);const s=q_(0,n,t,r);return Vt.clearBuffer(),s}function q_(n,e,t,r,s=null){const{float32Array:i,uint16Array:o,uint32Array:a}=Vt;let c=n*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),pC.set(t.boundingBox.min,t.boundingBox.max,r),s=pC),tr(c,o)){const u=e.geometry,h=u.index,d=u.attributes.position,p=t.index,_=t.attributes.position,g=ur(n,a),f=Nr(c,o);if(Wc.copy(r).invert(),t.boundsTree)return Kt(n,i,Rh),Rh.matrix.copy(Wc),Rh.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:y=>Rh.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(r),y.b.applyMatrix4(r),y.c.applyMatrix4(r),y.needsUpdate=!0;for(let v=g*3,b=(f+g)*3;v<b;v+=3)if(mn(ga,v,h,d),ga.needsUpdate=!0,y.intersectsTriangle(ga))return!0;return!1}});for(let m=g*3,y=(f+g)*3;m<y;m+=3){mn(_a,m,h,d),_a.a.applyMatrix4(Wc),_a.b.applyMatrix4(Wc),_a.c.applyMatrix4(Wc),_a.needsUpdate=!0;for(let v=0,b=p.count;v<b;v+=3)if(mn(ga,v,p,_),ga.needsUpdate=!0,_a.intersectsTriangle(ga))return!0}}else{const u=n+8,h=a[n+6];return Kt(u,i,Mh),!!(s.intersectsBox(Mh)&&q_(u,e,t,r,s)||(Kt(h,i,Mh),s.intersectsBox(Mh)&&q_(h,e,t,r,s)))}}const wh=new qe,cm=new Zn,Xc=new Zn,VH=new T,zH=new T,HH=new T,jH=new T;function WH(n,e,t,r={},s={},i=0,o=1/0){e.boundingBox||e.computeBoundingBox(),cm.set(e.boundingBox.min,e.boundingBox.max,t),cm.needsUpdate=!0;const a=n.geometry,c=a.attributes.position,l=a.index,u=e.attributes.position,h=e.index,d=Lr.getPrimitive(),p=Lr.getPrimitive();let _=VH,g=zH,f=null,m=null;s&&(f=HH,m=jH);let y=1/0,v=null,b=null;return wh.copy(t).invert(),Xc.matrix.copy(wh),n.shapecast({boundsTraverseOrder:x=>cm.distanceToBox(x),intersectsBounds:(x,E,S)=>S<y&&S<o?(E&&(Xc.min.copy(x.min),Xc.max.copy(x.max),Xc.needsUpdate=!0),!0):!1,intersectsRange:(x,E)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:R=>Xc.distanceToBox(R),intersectsBounds:(R,C,M)=>M<y&&M<o,intersectsRange:(R,C)=>{for(let M=R,G=R+C;M<G;M++){mn(p,3*M,h,u),p.a.applyMatrix4(t),p.b.applyMatrix4(t),p.c.applyMatrix4(t),p.needsUpdate=!0;for(let F=x,X=x+E;F<X;F++){mn(d,3*F,l,c),d.needsUpdate=!0;const N=d.distanceToTriangle(p,_,f);if(N<y&&(g.copy(_),m&&m.copy(f),y=N,v=F,b=M),N<i)return!0}}}});{const S=Tc(e);for(let R=0,C=S;R<C;R++){mn(p,3*R,h,u),p.a.applyMatrix4(t),p.b.applyMatrix4(t),p.c.applyMatrix4(t),p.needsUpdate=!0;for(let M=x,G=x+E;M<G;M++){mn(d,3*M,l,c),d.needsUpdate=!0;const F=d.distanceToTriangle(p,_,f);if(F<y&&(g.copy(_),m&&m.copy(f),y=F,v=M,b=R),F<i)return!0}}}}}),Lr.releasePrimitive(d),Lr.releasePrimitive(p),y===1/0?null:(r.point?r.point.copy(g):r.point=g.clone(),r.distance=y,r.faceIndex=v,s&&(s.point?s.point.copy(m):s.point=m.clone(),s.point.applyMatrix4(wh),g.applyMatrix4(wh),s.distance=g.sub(s.point).length(),s.faceIndex=b),r)}function XH(n,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=n.geometry,r=t.index?t.index.array:null,s=t.attributes.position;let i,o,a,c,l=0;const u=n._roots;for(let d=0,p=u.length;d<p;d++)i=u[d],o=new Uint32Array(i),a=new Uint16Array(i),c=new Float32Array(i),h(0,l),l+=i.byteLength;function h(d,p,_=!1){const g=d*2;if(a[g+15]===Up){const m=o[d+6],y=a[g+14];let v=1/0,b=1/0,x=1/0,E=-1/0,S=-1/0,R=-1/0;for(let C=m,M=m+y;C<M;C++){const G=3*n.resolveTriangleIndex(C);for(let F=0;F<3;F++){let X=G+F;X=r?r[X]:X;const N=s.getX(X),j=s.getY(X),K=s.getZ(X);N<v&&(v=N),N>E&&(E=N),j<b&&(b=j),j>S&&(S=j),K<x&&(x=K),K>R&&(R=K)}}return c[d+0]!==v||c[d+1]!==b||c[d+2]!==x||c[d+3]!==E||c[d+4]!==S||c[d+5]!==R?(c[d+0]=v,c[d+1]=b,c[d+2]=x,c[d+3]=E,c[d+4]=S,c[d+5]=R,!0):!1}else{const m=d+8,y=o[d+6],v=m+p,b=y+p;let x=_,E=!1,S=!1;e?x||(E=e.has(v),S=e.has(b),x=!E&&!S):(E=!0,S=!0);const R=x||E,C=x||S;let M=!1;R&&(M=h(m,p,x));let G=!1;C&&(G=h(y,p,x));const F=M||G;if(F)for(let X=0;X<3;X++){const N=m+X,j=y+X,K=c[N],$=c[N+3],q=c[j],ne=c[j+3];c[d+X]=K<q?K:q,c[d+X+3]=$>ne?$:ne}return F}}}const fC=new T;function $H(n,e,t,r,s){Vt.setBuffer(n._roots[e]),Y_(0,n,t,r,s),Vt.clearBuffer()}function Y_(n,e,t,r,s){const{float32Array:i,uint16Array:o,uint32Array:a}=Vt,c=n*2;if(tr(c,o)){const u=ur(n,a),h=Nr(c,o);DH(e,t,r,u,h,s)}else{const u=Ir(n);$i(u,i,r,fC)&&Y_(u,e,t,r,s);const h=Dr(n,a);$i(h,i,r,fC)&&Y_(h,e,t,r,s)}}const mC=new T,qH=["x","y","z"];function YH(n,e,t,r){Vt.setBuffer(n._roots[e]);const s=K_(0,n,t,r);return Vt.clearBuffer(),s}function K_(n,e,t,r){const{float32Array:s,uint16Array:i,uint32Array:o}=Vt;let a=n*2;if(tr(a,i)){const l=ur(n,o),u=Nr(a,i);return LH(e,t,r,l,u)}else{const l=JM(n,o),u=qH[l],d=r.direction[u]>=0;let p,_;d?(p=Ir(n),_=Dr(n,o)):(p=Dr(n,o),_=Ir(n));const f=$i(p,s,r,mC)?K_(p,e,t,r):null;if(f){const v=f.point[u];if(d?v<=s[_+l]:v>=s[_+l+3])return f}const y=$i(_,s,r,mC)?K_(_,e,t,r):null;return f&&y?f.distance<=y.distance?f:y:f||y||null}}const Oh=new Ht,va=new Jr,ya=new Jr,$c=new qe,_C=new Zn,Ph=new Zn;function KH(n,e,t,r){Vt.setBuffer(n._roots[e]);const s=Z_(0,n,t,r);return Vt.clearBuffer(),s}function Z_(n,e,t,r,s=null){const{float32Array:i,uint16Array:o,uint32Array:a}=Vt;let c=n*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),_C.set(t.boundingBox.min,t.boundingBox.max,r),s=_C),tr(c,o)){const u=e.geometry,h=u.index,d=u.attributes.position,p=t.index,_=t.attributes.position,g=ur(n,a),f=Nr(c,o);if($c.copy(r).invert(),t.boundsTree)return Kt(n,i,Ph),Ph.matrix.copy($c),Ph.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:y=>Ph.intersectsBox(y),intersectsTriangle:y=>{y.a.applyMatrix4(r),y.b.applyMatrix4(r),y.c.applyMatrix4(r),y.needsUpdate=!0;for(let v=g,b=f+g;v<b;v++)if(mn(ya,3*e.resolveTriangleIndex(v),h,d),ya.needsUpdate=!0,y.intersectsTriangle(ya))return!0;return!1}});for(let m=g,y=f+g;m<y;m++){const v=e.resolveTriangleIndex(m);mn(va,3*v,h,d),va.a.applyMatrix4($c),va.b.applyMatrix4($c),va.c.applyMatrix4($c),va.needsUpdate=!0;for(let b=0,x=p.count;b<x;b+=3)if(mn(ya,b,p,_),ya.needsUpdate=!0,va.intersectsTriangle(ya))return!0}}else{const u=n+8,h=a[n+6];return Kt(u,i,Oh),!!(s.intersectsBox(Oh)&&Z_(u,e,t,r,s)||(Kt(h,i,Oh),s.intersectsBox(Oh)&&Z_(h,e,t,r,s)))}}const Nh=new qe,lm=new Zn,qc=new Zn,ZH=new T,JH=new T,QH=new T,e4=new T;function t4(n,e,t,r={},s={},i=0,o=1/0){e.boundingBox||e.computeBoundingBox(),lm.set(e.boundingBox.min,e.boundingBox.max,t),lm.needsUpdate=!0;const a=n.geometry,c=a.attributes.position,l=a.index,u=e.attributes.position,h=e.index,d=Lr.getPrimitive(),p=Lr.getPrimitive();let _=ZH,g=JH,f=null,m=null;s&&(f=QH,m=e4);let y=1/0,v=null,b=null;return Nh.copy(t).invert(),qc.matrix.copy(Nh),n.shapecast({boundsTraverseOrder:x=>lm.distanceToBox(x),intersectsBounds:(x,E,S)=>S<y&&S<o?(E&&(qc.min.copy(x.min),qc.max.copy(x.max),qc.needsUpdate=!0),!0):!1,intersectsRange:(x,E)=>{if(e.boundsTree){const S=e.boundsTree;return S.shapecast({boundsTraverseOrder:R=>qc.distanceToBox(R),intersectsBounds:(R,C,M)=>M<y&&M<o,intersectsRange:(R,C)=>{for(let M=R,G=R+C;M<G;M++){const F=S.resolveTriangleIndex(M);mn(p,3*F,h,u),p.a.applyMatrix4(t),p.b.applyMatrix4(t),p.c.applyMatrix4(t),p.needsUpdate=!0;for(let X=x,N=x+E;X<N;X++){const j=n.resolveTriangleIndex(X);mn(d,3*j,l,c),d.needsUpdate=!0;const K=d.distanceToTriangle(p,_,f);if(K<y&&(g.copy(_),m&&m.copy(f),y=K,v=X,b=M),K<i)return!0}}}})}else{const S=Tc(e);for(let R=0,C=S;R<C;R++){mn(p,3*R,h,u),p.a.applyMatrix4(t),p.b.applyMatrix4(t),p.c.applyMatrix4(t),p.needsUpdate=!0;for(let M=x,G=x+E;M<G;M++){const F=n.resolveTriangleIndex(M);mn(d,3*F,l,c),d.needsUpdate=!0;const X=d.distanceToTriangle(p,_,f);if(X<y&&(g.copy(_),m&&m.copy(f),y=X,v=M,b=R),X<i)return!0}}}}}),Lr.releasePrimitive(d),Lr.releasePrimitive(p),y===1/0?null:(r.point?r.point.copy(g):r.point=g.clone(),r.distance=y,r.faceIndex=v,s&&(s.point?s.point.copy(m):s.point=m.clone(),s.point.applyMatrix4(Nh),g.applyMatrix4(Nh),s.distance=g.sub(s.point).length(),s.faceIndex=b),r)}function n4(){return typeof SharedArrayBuffer<"u"}const Sl=new Vt.constructor,Wd=new Vt.constructor,Ei=new wv(()=>new Ht),xa=new Ht,ba=new Ht,um=new Ht,hm=new Ht;let dm=!1;function r4(n,e,t,r){if(dm)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");dm=!0;const s=n._roots,i=e._roots;let o,a=0,c=0;const l=new qe().copy(t).invert();for(let u=0,h=s.length;u<h;u++){Sl.setBuffer(s[u]),c=0;const d=Ei.getPrimitive();Kt(0,Sl.float32Array,d),d.applyMatrix4(l);for(let p=0,_=i.length;p<_&&(Wd.setBuffer(i[u]),o=$r(0,0,t,l,r,a,c,0,0,d),Wd.clearBuffer(),c+=i[p].length,!o);p++);if(Ei.releasePrimitive(d),Sl.clearBuffer(),a+=s[u].length,o)break}return dm=!1,o}function $r(n,e,t,r,s,i=0,o=0,a=0,c=0,l=null,u=!1){let h,d;u?(h=Wd,d=Sl):(h=Sl,d=Wd);const p=h.float32Array,_=h.uint32Array,g=h.uint16Array,f=d.float32Array,m=d.uint32Array,y=d.uint16Array,v=n*2,b=e*2,x=tr(v,g),E=tr(b,y);let S=!1;if(E&&x)u?S=s(ur(e,m),Nr(e*2,y),ur(n,_),Nr(n*2,g),c,o+e,a,i+n):S=s(ur(n,_),Nr(n*2,g),ur(e,m),Nr(e*2,y),a,i+n,c,o+e);else if(E){const R=Ei.getPrimitive();Kt(e,f,R),R.applyMatrix4(t);const C=Ir(n),M=Dr(n,_);Kt(C,p,xa),Kt(M,p,ba);const G=R.intersectsBox(xa),F=R.intersectsBox(ba);S=G&&$r(e,C,r,t,s,o,i,c,a+1,R,!u)||F&&$r(e,M,r,t,s,o,i,c,a+1,R,!u),Ei.releasePrimitive(R)}else{const R=Ir(e),C=Dr(e,m);Kt(R,f,um),Kt(C,f,hm);const M=l.intersectsBox(um),G=l.intersectsBox(hm);if(M&&G)S=$r(n,R,t,r,s,i,o,a,c+1,l,u)||$r(n,C,t,r,s,i,o,a,c+1,l,u);else if(M)if(x)S=$r(n,R,t,r,s,i,o,a,c+1,l,u);else{const F=Ei.getPrimitive();F.copy(um).applyMatrix4(t);const X=Ir(n),N=Dr(n,_);Kt(X,p,xa),Kt(N,p,ba);const j=F.intersectsBox(xa),K=F.intersectsBox(ba);S=j&&$r(R,X,r,t,s,o,i,c,a+1,F,!u)||K&&$r(R,N,r,t,s,o,i,c,a+1,F,!u),Ei.releasePrimitive(F)}else if(G)if(x)S=$r(n,C,t,r,s,i,o,a,c+1,l,u);else{const F=Ei.getPrimitive();F.copy(hm).applyMatrix4(t);const X=Ir(n),N=Dr(n,_);Kt(X,p,xa),Kt(N,p,ba);const j=F.intersectsBox(xa),K=F.intersectsBox(ba);S=j&&$r(C,X,r,t,s,o,i,c,a+1,F,!u)||K&&$r(C,N,r,t,s,o,i,c,a+1,F,!u),Ei.releasePrimitive(F)}}return S}const Ih=new Zn,gC=new Ht,s4={strategy:Mv,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0};class Ov{static serialize(e,t={}){t={cloneBuffers:!0,...t};const r=e.geometry,s=e._roots,i=e._indirectBuffer,o=r.getIndex();let a;return t.cloneBuffers?a={roots:s.map(c=>c.slice()),index:o.array.slice(),indirectBuffer:i?i.slice():null}:a={roots:s,index:o.array,indirectBuffer:i},a}static deserialize(e,t,r={}){r={setIndex:!0,indirect:!!e.indirectBuffer,...r};const{index:s,roots:i,indirectBuffer:o}=e,a=new Ov(t,{...r,[rm]:!0});if(a._roots=i,a._indirectBuffer=o||null,r.setIndex){const c=t.getIndex();if(c===null){const l=new Lt(e.index,1,!1);t.setIndex(l)}else c.array!==s&&(c.array.set(s),c.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({...s4,[rm]:!1},t),t.useSharedArrayBuffer&&!n4())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[rm]||(xH(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new Ht)));const{_indirectBuffer:r}=this;this.resolveTriangleIndex=t.indirect?s=>r[s]:s=>s}refit(e=null){return(this.indirect?XH:IH)(this,e)}traverse(e,t=0){const r=this._roots[t],s=new Uint32Array(r),i=new Uint16Array(r);o(0);function o(a,c=0){const l=a*2,u=i[l+15]===Up;if(u){const h=s[a+6],d=i[l+14];e(c,u,new Float32Array(r,a*4,6),h,d)}else{const h=a+El/4,d=s[a+6],p=s[a+7];e(c,u,new Float32Array(r,a*4,6),p)||(o(h,c+1),o(d,c+1))}}}raycast(e,t=In){const r=this._roots,s=this.geometry,i=[],o=t.isMaterial,a=Array.isArray(t),c=s.groups,l=o?t.side:t,u=this.indirect?$H:UH;for(let h=0,d=r.length;h<d;h++){const p=a?t[c[h].materialIndex].side:l,_=i.length;if(u(this,h,p,e,i),a){const g=c[h].materialIndex;for(let f=_,m=i.length;f<m;f++)i[f].face.materialIndex=g}}return i}raycastFirst(e,t=In){const r=this._roots,s=this.geometry,i=t.isMaterial,o=Array.isArray(t);let a=null;const c=s.groups,l=i?t.side:t,u=this.indirect?YH:BH;for(let h=0,d=r.length;h<d;h++){const p=o?t[c[h].materialIndex].side:l,_=u(this,h,p,e);_!=null&&(a==null||_.distance<a.distance)&&(a=_,o&&(_.face.materialIndex=c[h].materialIndex))}return a}intersectsGeometry(e,t){let r=!1;const s=this._roots,i=this.indirect?KH:GH;for(let o=0,a=s.length;o<a&&(r=i(this,o,e,t),!r);o++);return r}shapecast(e){const t=Lr.getPrimitive(),r=this.indirect?FH:NH;let{boundsTraverseOrder:s,intersectsBounds:i,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const h=o;o=(d,p,_,g,f)=>h(d,p,_,g,f)?!0:r(d,p,this,a,_,g,t)}else o||(a?o=(h,d,p,_)=>r(h,d,this,a,p,_,t):o=(h,d,p)=>p);let c=!1,l=0;const u=this._roots;for(let h=0,d=u.length;h<d;h++){const p=u[h];if(c=TH(this,h,i,o,s,l),c)break;l+=p.byteLength}return Lr.releasePrimitive(t),c}bvhcast(e,t,r){let{intersectsRanges:s,intersectsTriangles:i}=r;const o=Lr.getPrimitive(),a=this.geometry.index,c=this.geometry.attributes.position,l=this.indirect?_=>{const g=this.resolveTriangleIndex(_);mn(o,g*3,a,c)}:_=>{mn(o,_*3,a,c)},u=Lr.getPrimitive(),h=e.geometry.index,d=e.geometry.attributes.position,p=e.indirect?_=>{const g=e.resolveTriangleIndex(_);mn(u,g*3,h,d)}:_=>{mn(u,_*3,h,d)};if(i){const _=(g,f,m,y,v,b,x,E)=>{for(let S=m,R=m+y;S<R;S++){p(S),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let C=g,M=g+f;C<M;C++)if(l(C),o.needsUpdate=!0,i(o,u,C,S,v,b,x,E))return!0}return!1};if(s){const g=s;s=function(f,m,y,v,b,x,E,S){return g(f,m,y,v,b,x,E,S)?!0:_(f,m,y,v,b,x,E,S)}}else s=_}return r4(this,e,t,s)}intersectsBox(e,t){return Ih.set(e.min,e.max,t),Ih.needsUpdate=!0,this.shapecast({intersectsBounds:r=>Ih.intersectsBox(r),intersectsTriangle:r=>Ih.intersectsTriangle(r)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,r={},s={},i=0,o=1/0){return(this.indirect?t4:WH)(this,e,t,r,s,i,o)}closestPointToPoint(e,t={},r=0,s=1/0){return MH(this,e,t,r,s)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(r=>{Kt(0,new Float32Array(r),gC),e.union(gC)}),e}}function vC(n,e,t){return n===null||(n.point.applyMatrix4(e.matrixWorld),n.distance=n.point.distanceTo(t.ray.origin),n.object=e,n.distance<t.near||n.distance>t.far)?null:n}const pm=new ni,yC=new qe,i4=Jt.prototype.raycast;function xC(n,e){if(this.geometry.boundsTree){if(this.material===void 0)return;yC.copy(this.matrixWorld).invert(),pm.copy(n.ray).applyMatrix4(yC);const t=this.geometry.boundsTree;if(n.firstHitOnly===!0){const r=vC(t.raycastFirst(pm,this.material),this,n);r&&e.push(r)}else{const r=t.raycast(pm,this.material);for(let s=0,i=r.length;s<i;s++){const o=vC(r[s],this,n);o&&e.push(o)}}}else i4.call(this,n,e)}class Pv{static assignBVH(e,t){e.raycast=xC,e.geometry.boundsTree=t}static assignDefaultBVHIfNone(e){let t=e.geometry.boundsTree||this.defaultBVH(e);this.assignBVH(e,t)}static createBVH(e,t){return new Ov(e.geometry,t)}static defaultBVH(e){return this.createBVH(e,{strategy:Mv,maxLeafTris:10,maxDepth:40,verbose:!1})}static copyBVH(e,t){const r=t.geometry.boundsTree;r&&(e.raycast=xC,this.assignBVH(e,r))}static updateRaycaster(e){e.firstHitOnly=!0}}function Eu(n,e=!1){const t=n[0].index!==null,r=new Set(Object.keys(n[0].attributes)),s=new Set(Object.keys(n[0].morphAttributes)),i={},o={},a=n[0].morphTargetsRelative,c=new sn;let l=0;for(let u=0;u<n.length;++u){const h=n[u];let d=0;if(t!==(h.index!==null))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+u+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const p in h.attributes){if(!r.has(p))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+u+'. All geometries must have compatible attributes; make sure "'+p+'" attribute exists among all geometries, or in none of them.'),null;i[p]===void 0&&(i[p]=[]),i[p].push(h.attributes[p]),d++}if(d!==r.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+u+". Make sure all geometries have the same number of attributes."),null;if(a!==h.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+u+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const p in h.morphAttributes){if(!s.has(p))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+u+".  .morphAttributes must be consistent throughout all geometries."),null;o[p]===void 0&&(o[p]=[]),o[p].push(h.morphAttributes[p])}if(e){let p;if(t)p=h.index.count;else if(h.attributes.position!==void 0)p=h.attributes.position.count;else return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+u+". The geometry must have either an index or a position attribute"),null;c.addGroup(l,p,u),l+=p}}if(t){let u=0;const h=[];for(let d=0;d<n.length;++d){const p=n[d].index;for(let _=0;_<p.count;++_)h.push(p.getX(_)+u);u+=n[d].attributes.position.count}c.setIndex(h)}for(const u in i){const h=bC(i[u]);if(!h)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+u+" attribute."),null;c.setAttribute(u,h)}for(const u in o){const h=o[u][0].length;if(h===0)break;c.morphAttributes=c.morphAttributes||{},c.morphAttributes[u]=[];for(let d=0;d<h;++d){const p=[];for(let g=0;g<o[u].length;++g)p.push(o[u][g][d]);const _=bC(p);if(!_)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+u+" morphAttribute."),null;c.morphAttributes[u].push(_)}}return c}function bC(n){let e,t,r,s=-1,i=0;for(let l=0;l<n.length;++l){const u=n[l];if(u.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(e===void 0&&(e=u.array.constructor),e!==u.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(t===void 0&&(t=u.itemSize),t!==u.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(r===void 0&&(r=u.normalized),r!==u.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(s===-1&&(s=u.gpuType),s!==u.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;i+=u.array.length}const o=new e(i);let a=0;for(let l=0;l<n.length;++l)o.set(n[l].array,a),a+=n[l].array.length;const c=new Lt(o,t,r);return s!==void 0&&(c.gpuType=s),c}const o4="position";class tR{static createIndexIfNone(e){if(!e.index){const t=e.getAttribute(o4);if(t){const r=t.array;e.setIndex(zk(r.length/3))}}}}const a4=["Quad"],c4=new Set(a4);function nR(n){return c4.has(n.type)}function l4(n){return nR(n)||Xn(n)}new T(1,1,1),new T(0,0,0),new T(0,1,0);new T(1,1,1);new W(0,0);new T;var Nv=(n=>(n.POSITION="instancePosition",n.SCALE="instanceScale",n.QUATERNION="instanceQuaternion",n.COLOR="instanceColor",n.UV="instanceUv",n))(Nv||{});vt.COLOR+"",vt.NORMAL+"",vt.POSITION+"",vt.PSCALE+"",vt.SCALE+"";new T;new W;new T(0,0,0);new T(1,1,1);new qe;function u4(n){return n.geometry!=null}function rR(n){return n.getAttribute(Nv.POSITION)!=null}function sR(n){return rR(n)?Nv.POSITION:vt.POSITION}function iR(n){const e=sR(n);if(!e)return 0;const t=n.getAttribute(e);return t?t.count:0}function h4(n){const e=iR(n.geometry),t=new Array(e);for(let r=0;r<e;r++)t[r]=new Vr(n,r);return t}const Dh=new Jt;class d4{static merge(e){if(e.length===0)return;for(const i of e)tR.createIndexIfNone(i);Dh.geometry=e[0];const t=Vr.indexedAttributeNames(Dh),r={};for(const i of t){const o=new Map,a=new Set,c=[];for(const u of e){const h=new Jt(u),d=h4(h);for(const p of d){c.push(p);const _=p.indexedAttribValue(i);_!=null&&(a.has(_)||(o.set(_,a.size),a.add(_)))}}for(const u of c){const h=u.indexedAttribValue(i);if(h!=null){const d=o.get(h);d!=null&&u.setAttribIndex(i,d)}}const l=[];rr(a,l),r[i]=l}const s=Eu(e);return Dh.geometry=s,Object.keys(r).forEach(i=>{const o=r[i];Vr.setIndexedAttributeValues(Dh,i,o)}),s&&delete s.userData.mergedUserData,s}}const J_=new WeakMap;function p4(n,e){var t;return(t=J_.get(n))==null?void 0:t.get(e)}function CC(n,e){Xl(n)&&Xl(e.value)?WM(n,e.value):e.value=n}function f4(n,e,t){const r=p4(n,e);r&&(CC(r.current.value,r.previous),CC(t,r.current))}class Iv{constructor(e,t,r){this._name=e,this._type=t,this._init_value=r,this._inNodeDefinition=!1}get init_value(){return this._init_value}name(){return this._name}type(){return this._type}are_types_matched(e,t){return!0}inNodeDefinition(){return this._inNodeDefinition}toJSON(){return this._json=this._json||this._createJSON()}_createJSON(){return{name:this._name,type:this._type}}}var wn=(n=>(n.ANIMATION_MIXER="AnimationMixer",n.ANIMATION_ACTION="AnimationAction",n.BOOLEAN="boolean",n.BOOLEAN_ARRAY="boolean[]",n.BOX3="Box3",n.CAMERA="Camera",n.CATMULL_ROM_CURVE3="CatmullRomCurve3",n.COLOR="Color",n.COLOR_ARRAY="Color[]",n.EULER="Euler",n.EULER_ARRAY="Euler[]",n.FLOAT="float",n.FLOAT_ARRAY="float[]",n.INT="int",n.INT_ARRAY="int[]",n.INTERSECTION="Intersection",n.INTERSECTION_ARRAY="Intersection[]",n.MATERIAL="Material",n.MATRIX4="Matrix4",n.MATRIX4_ARRAY="Matrix4[]",n.NODE="Node",n.OBJECT_3D="Object3D",n.OBJECT_3D_ARRAY="Object3D[]",n.PARAM="Param",n.PLANE="Plane",n.QUATERNION="Quaternion",n.QUATERNION_ARRAY="Quaternion[]",n.RAY="Ray",n.SPHERE="Sphere",n.STRING="string",n.STRING_ARRAY="string[]",n.TEXTURE="Texture",n.TEXTURE_ARRAY="Texture[]",n.TRIGGER="trigger",n.VECTOR2="Vector2",n.VECTOR2_ARRAY="Vector2[]",n.VECTOR3="Vector3",n.VECTOR3_ARRAY="Vector3[]",n.VECTOR4="Vector4",n.VECTOR4_ARRAY="Vector4[]",n))(wn||{});const m4=["boolean[]","Color[]","float[]","int[]","Intersection[]","Matrix4[]","Object3D[]","Quaternion[]","string[]","Texture[]","Vector2[]","Vector3[]","Vector4[]"],_4=new Set(m4),g4={AnimationMixer:J.BUTTON,AnimationAction:J.BUTTON,boolean:J.BOOLEAN,"boolean[]":J.BUTTON,Box3:J.BUTTON,Camera:J.BUTTON,CatmullRomCurve3:J.BUTTON,Color:J.COLOR,"Color[]":J.BUTTON,Euler:J.BUTTON,"Euler[]":J.BUTTON,float:J.FLOAT,"float[]":J.BUTTON,int:J.INTEGER,"int[]":J.BUTTON,Intersection:J.BUTTON,"Intersection[]":J.BUTTON,Material:J.BUTTON,Matrix4:J.BUTTON,"Matrix4[]":J.BUTTON,Node:J.NODE_PATH,Object3D:J.BUTTON,"Object3D[]":J.BUTTON,Param:J.PARAM_PATH,Plane:J.BUTTON,Quaternion:J.BUTTON,"Quaternion[]":J.BUTTON,Ray:J.BUTTON,Sphere:J.BUTTON,string:J.STRING,"string[]":J.BUTTON,Texture:J.BUTTON,"Texture[]":J.BUTTON,trigger:J.BUTTON,Vector2:J.VECTOR2,"Vector2[]":J.BUTTON,Vector3:J.VECTOR3,"Vector3[]":J.BUTTON,Vector4:J.VECTOR4,"Vector4[]":J.BUTTON},v4={[J.BOOLEAN]:"boolean",[J.COLOR]:"Color",[J.FLOAT]:"float",[J.INTEGER]:"int",[J.FOLDER]:void 0,[J.VECTOR2]:"Vector2",[J.VECTOR3]:"Vector3",[J.VECTOR4]:"Vector4",[J.BUTTON]:void 0,[J.NODE_PATH]:"Node",[J.PARAM_PATH]:"Param",[J.RAMP]:void 0,[J.STRING]:"string"},y4={AnimationAction:null,AnimationMixer:null,boolean:!1,"boolean[]":null,Box3:null,Camera:null,CatmullRomCurve3:null,Color:[1,1,1],"Color[]":null,Euler:null,"Euler[]":null,float:0,"float[]":null,int:0,"int[]":null,Intersection:null,"Intersection[]":null,Material:null,Matrix4:null,"Matrix4[]":null,Node:"",Object3D:null,"Object3D[]":null,Param:"",Plane:null,Quaternion:null,"Quaternion[]":null,Ray:null,Sphere:null,string:"","string[]":null,Texture:null,"Texture[]":null,trigger:null,Vector2:[0,0],"Vector2[]":null,Vector3:[0,0,0],"Vector3[]":null,Vector4:[0,0,0,0],"Vector4[]":null};class x4 extends Iv{constructor(e,t,r){super(e,t),this._type=t,this._options=r,this._isArray=_4.has(t),this._init_value=y4[this._type],r&&(this._inNodeDefinition=r.inNodeDefinition==!0,r.init_value!=null&&(this._init_value=r.init_value))}type(){return this._type}are_types_matched(e,t){return e==t}get param_type(){return g4[this._type]}get init_value(){return this._init_value}toJSON(){return this._json=this._json||this._createJSON()}_createJSON(){return{name:this._name,type:this._type,isArray:this._isArray}}}function b4(n){switch(n){case wn.BOOLEAN:return!1;case wn.COLOR:return new xe;case wn.FLOAT:return 0;case wn.INT:return 0;case wn.STRING:return"";case wn.VECTOR2:return new W;case wn.VECTOR3:return new T;case wn.VECTOR4:return new We}St.unreachable(n)}function C4(n,e){switch(e){case wn.BOOLEAN:return n;case wn.COLOR:return n.clone();case wn.FLOAT:return n;case wn.INT:return n;case wn.STRING:return n;case wn.VECTOR2:return n.clone();case wn.VECTOR3:return n.clone();case wn.VECTOR4:return n.clone()}St.unreachable(e)}function E4(n,e,t,r){let s=J_.get(n);s||(s=new Map,J_.set(n,s));let i=s.get(e);if(!i){let o=r??b4(t),a=C4(o,t);const c=Q_.attribValue(n,e,0,o),l=Q_.attribValue(n,e,0,a);c==null||l==null?i={current:Pr(o),previous:Pr(a)}:i={current:Pr(c),previous:Pr(l)},s.set(e,i)}return i}const Lh="attributes",S4=new T(0,0,0);function A4(n){switch(n.length){case 1:return n[0];case 2:return new W(n[0],n[1]);case 3:return new T(n[0],n[1],n[2]);case 4:return new We(n[0],n[1],n[2],n[3])}}const T4=new T,EC=[0,0,0],M4=[],R4=[];class Q_ extends Dp{dispose(){}geometry(){var e;return((e=this._object)==null?void 0:e.geometry)||null}builder(){}static attributeRef(e,t,r,s){return E4(e,t,r,s)}attributeRef(e,t,r){if(this._object)return this.constructor.attributeRef(this._object,e,t,r)}static onAttribChange(e,t,r,s,i){const o=this.attributeRef(e,t,r,s);return GT(o.current,i)}onAttribChange(e,t,r,s){if(this._object)return this.constructor.onAttribChange(this._object,e,t,r,s)}static setAttribute(e,t,r){this.addAttribute(e,t,r)}static addAttribute(e,t,r){if(_t(r)&&!A4(r)){const a="value invalid";throw console.error(a,r),new Error(a)}const s=this._attributesDictionary(e),i=s[t];if(Xl(r))if(i==null){const o=XM(r);o&&(s[t]=o)}else Xl(i)&&WM(r,i);else s[t]=r;f4(e,t,r)}static addNumericAttribute(e,t,r=1,s=0){this.addAttribute(e,t,s)}addAttribute(e,t){this._object&&this.constructor.addAttribute(this._object,e,t)}addNumericAttrib(e,t){this._object&&this.constructor.addNumericAttribute(this._object,e,1,t)}setAttribValue(e,t){this.addAttribute(e,t)}static _attributesDictionary(e){return e.userData[Lh]||this._createAttributesDictionaryIfNone(e)}static attributesDictionaryEntry(e,t,r){const s=e.userData[Lh]||this._createAttributesDictionaryIfNone(e);let i=s[t];return i==null&&r!=null&&(i=r,s[t]=i),i}static _createAttributesDictionaryIfNone(e){if(!e.userData[Lh])return e.userData[Lh]={}}_attributesDictionary(){return this.constructor._attributesDictionary(this._object)}static attributes(e){return this._attributesDictionary(e)}attributes(){if(this._object)return this.constructor.attributes(this._object)}attributeNames(){return this.attribNames()}static attribNames(e){return Object.keys(this._attributesDictionary(e))}attribNames(){return this.constructor.attribNames(this._object)}static hasAttribute(e,t){return t in this._attributesDictionary(e)}hasAttribute(e){return this.constructor.hasAttribute(this._object,e)}static attributeNames(e){const t=this.attributes(e);return t?Object.keys(t):[]}static attributeNamesMatchingMask(e,t){return Dt.attribNamesMatchingMask(t,this.attributeNames(e))}renameAttribute(e,t){return this.constructor.renameAttribute(this._object,e,t)}static renameAttribute(e,t,r){const s=this.attribValue(e,t);s!=null?(this.addAttribute(e,r,s),this.deleteAttribute(e,t)):console.warn(`attribute ${t} not found`)}deleteAttribute(e){delete this._attributesDictionary()[e]}static deleteAttribute(e,t){delete this._attributesDictionary(e)[t]}static position(e,t){t.copy(S4)}position(e){return this.constructor.position(this._object,e),e}static boundingBox(e,t){t.makeEmpty()}boundingBox(e){this.constructor.boundingBox(this._object,e)}static geometryBoundingBox(e,t){this.boundingBox(e,t)}geometryBoundingBox(e){this.constructor.geometryBoundingBox(this._object,e)}static boundingSphere(e,t){t.makeEmpty()}boundingSphere(e){this.constructor.boundingSphere(this._object,e)}static geometryBoundingSphere(e,t){t.makeEmpty()}geometryBoundingSphere(e){this.constructor.geometryBoundingSphere(this._object,e)}static attribValue(e,t,r=0,s){const i=()=>{if(t=="name")return e.name;if(t=="position"){const o=s instanceof T?s:T4;return this.position(e,o),o.toArray(EC),EC}};if(t===vt.OBJECT_INDEX)return r;if(t===vt.OBJECT_NAME)return e.name;if(e.userData){const o=this.attributesDictionaryEntry(e,t);return o==null?i():zl(o)&&s&&(o instanceof W&&s instanceof W||o instanceof T&&s instanceof T||o instanceof We&&s instanceof We)||Hl(o)&&s&&o instanceof xe&&s instanceof xe?s.copy(o):_t(o)&&s?(s.fromArray(o),s):o}return i()}static stringAttribValue(e,t,r=0){const s=this.attribValue(e,t,r);return s!=null?Ke(s)?s:`${s}`:null}attribValue(e,t){return this.constructor.attribValue(this._object,e,this._index,t)}stringAttribValue(e){return this.constructor.stringAttribValue(this._object,e,this._index)}name(){return this.attribValue("name")}humanType(){return this._object.type}attribTypes(){const e={};for(const t of this.attribNames()){const r=this.attribType(t);r!=null&&(e[t]=r)}return e}static attribType(e,t){const r=this.attribValue(e,t);return Ke(r)?Hn.STRING:Hn.NUMERIC}attribType(e){return this.constructor.attribType(this._object,e)}attribSizes(){const e={},t=this.attribNames();for(const r of t){const s=this.attribSize(r);s!=null&&(e[r]=s)}return e}static attribSize(e,t){const r=this.attribValue(e,t);return r==null?null:Dt.attribSizeFromValue(r)}attribSize(e){return this.constructor.attribSize(this._object,e)}static objectData(e){return $M(e)}clone(){const e=this.constructor.clone(this._object);return new this.constructor(e,this._index)}static clone(e){return e.clone()}static applyMatrix(e,t,r,s,i){console.warn("applyMatrix.override required",this)}static mergeCompact(e){console.warn("mergeCompact.override required",this)}groupCollection(){return new Lp(this._object)}static relatedVertexIds(e,t,r,s){const i=s?s[rt.PRIMITIVE].ids:M4;this.relatedPrimitiveIds(e,t,i,s),jd(i,(o,a)=>{this.relatedPrimitiveClass(e).relatedVertexIds(e,o,a)},r)}static relatedPointIds(e,t,r,s){const i=s?s[rt.VERTEX].ids:R4;this.relatedVertexIds(e,t,i,s),jd(i,(o,a)=>{this.relatedVertexClass(e).relatedPointIds(e,o,a)},r)}relatedEntities(e,t,r,s){switch(e){case rt.POINT:{this.relatedPoints(r,s);return}case rt.VERTEX:{this.relatedVertices(r,s);return}case rt.PRIMITIVE:{this.relatedPrimitives(r,s);return}case rt.OBJECT:{r.length=1,r[0]=this;return}case rt.CORE_GROUP:{r.length=1,r[0]=t;return}}St.unreachable(e)}static relatedPointClass(e){return this.relatedVertexClass(e).relatedPointClass(e)}static relatedVertexClass(e){return this.relatedPrimitiveClass(e).relatedVertexClass(e)}}var hr=(n=>(n.OBJECT="object",n.GEOMETRY="geometry",n))(hr||{});const nr=["geometry","object"];var Dv=(n=>(n.XYZ="XYZ",n.XZY="XZY",n.YXZ="YXZ",n.YZX="YZX",n.ZYX="ZYX",n.ZXY="ZXY",n))(Dv||{});const Io=["XYZ","XZY","YXZ","YZX","ZXY","ZYX"],SC=[0,0,0],AC=new qe,TC=new Qt,MC=new T,RC=new T;class Pn{constructor(){this._translation_matrix=new qe,this._translation_matrix_q=new Qt,this._translation_matrix_s=new T(1,1,1),this._matrix=new qe().identity(),this._matrixQ=new Qt,this._matrixEuler=new pr,this._matrixS=new T}static setParamsFromMatrix(e,t,r={}){let s=r.scale;s==null&&(s=!0),e.decompose(this.set_params_from_matrix_position,this.set_params_from_matrix_quaternion,this.set_params_from_matrix_scale),this.set_params_from_matrix_euler.setFromQuaternion(this.set_params_from_matrix_quaternion),this.set_params_from_matrix_euler.toArray(SC),this.set_params_from_matrix_rotation.fromArray(SC),this.set_params_from_matrix_rotation.divideScalar(Math.PI/180),this.set_params_from_matrix_position.toArray(this.set_params_from_matrix_t),this.set_params_from_matrix_rotation.toArray(this.set_params_from_matrix_r),this.set_params_from_matrix_scale.toArray(this.set_params_from_matrix_s),t.scene().batchUpdates(()=>{t.params.set_vector3("t",this.set_params_from_matrix_t),t.params.set_vector3("r",this.set_params_from_matrix_r),t.params.set_vector3("s",this.set_params_from_matrix_s),s&&t.params.set_float("scale",1)})}static setParamsFromObject(e,t){e.position.toArray(this.set_params_from_object_position_array),e.rotation.toArray(this.set_params_from_object_rotation_array),this.set_params_from_object_rotation_deg.fromArray(this.set_params_from_object_rotation_array),this.set_params_from_object_rotation_deg.multiplyScalar(180/Math.PI),this.set_params_from_object_rotation_deg.toArray(this.set_params_from_object_rotation_array),t.scene().batchUpdates(()=>{t.params.set_vector3("t",this.set_params_from_object_position_array),t.params.set_vector3("r",this.set_params_from_object_rotation_array)})}translationMatrix(e){return this._translation_matrix.compose(e,this._translation_matrix_q,this._translation_matrix_s),this._translation_matrix}matrix(e,t,r,s,i){return this._matrixEuler.set(On.degToRad(t.x),On.degToRad(t.y),On.degToRad(t.z),i),this._matrixQ.setFromEuler(this._matrixEuler),this._matrixS.copy(r).multiplyScalar(s),this._matrix.compose(e,this._matrixQ,this._matrixS),this._matrix}static rotateObject(e,t,r){RC.copy(r).normalize(),MC.copy(t).normalize(),TC.setFromUnitVectors(MC,RC),AC.makeRotationFromQuaternion(TC),e.matrix.multiply(AC),e.matrix.decompose(e.position,e.quaternion,e.scale)}static decomposeMatrix(e){e.matrix.decompose(e.position,e.quaternion,e.scale)}}Pn.set_params_from_matrix_position=new T;Pn.set_params_from_matrix_quaternion=new Qt;Pn.set_params_from_matrix_scale=new T;Pn.set_params_from_matrix_euler=new pr;Pn.set_params_from_matrix_rotation=new T;Pn.set_params_from_matrix_t=[0,0,0];Pn.set_params_from_matrix_r=[0,0,0];Pn.set_params_from_matrix_s=[0,0,0];Pn.set_params_from_object_position_array=[0,0,0];Pn.set_params_from_object_rotation_deg=new T;Pn.set_params_from_object_rotation_array=[0,0,0];var Lv=(n=>(n.PARENT="parent",n.LOCAL="local",n))(Lv||{}),Co=(n=>(n.SET="set matrix",n.MULT="multiply matrix",n))(Co||{});const Xd=["parent","local"],ql=["set matrix","multiply matrix"],w4=[{name:"parent",value:Xd.indexOf("parent")},{name:"local",value:Xd.indexOf("local")}];function oR(n,e,t,r){switch(t){case"parent":{Xn(n)?(n.updateMatrix(),n.applyMatrix4(e),n.matrix.decompose(n.position,n.quaternion,n.scale)):n.applyMatrix4(e);return}case"local":{Xn(n)?(n.updateMatrix(),r=="set matrix"?n.matrix.copy(e):n.matrix.multiply(e),n.matrix.decompose(n.position,n.quaternion,n.scale)):n.applyMatrix4(e);return}}St.unreachable(t)}const wC=[],eg=[];function O4(n,e){e.length=0;for(const t of n)$d(t,eg),Sp(eg,e);return e}function Su(n){return Os(n).entitiesCount(n)}function $d(n,e){const r=Os(n).entitiesCount(n);e.length=r;for(let s=0;s<r;s++)e[s]=lR(n,s);return e}function P4(n,e,t){if(e){yt.indices(e,wC);const r=$d(n,eg),s=[],i=Js(wC.map(o=>r[o]),s);t.length=0,Sp(i,t)}else $d(n,t)}function N4(n,e){const r=Os(n).attributes(n);return r?e in r:!1}function I4(n){const t=Os(n).attributes(n);return t?Object.keys(t):[]}function D4(n,e){const r=Os(n).attributes(n);return r?r[e].itemSize:0}function L4(n){const t=Os(n).attributes(n);if(!t)return{};const r=Object.keys(t),s={};for(const i of r)s[i]=t[i].itemSize;return s}function F4(n,e){const t=Os(n);return t.attributes(n)?t.attribType(n,e):Hn.NUMERIC}var qr=(n=>(n.POINT_2D="CADPoint2D",n.CURVE_2D="CADCurve2D",n.VERTEX="CADVertex",n.EDGE="CADEdge",n.WIRE="CADWire",n.FACE="CADFace",n.SHELL="CADShell",n.SOLID="CADSolid",n.COMPSOLID="CADCompsolid",n.COMPOUND="CADCompound",n))(qr||{});const U4=["CADPoint2D","CADCurve2D","CADVertex","CADEdge","CADWire","CADFace","CADShell","CADSolid","CADCompsolid","CADCompound"],k4=new Set(U4),B4=["CADVertex","CADEdge","CADWire","CADFace","CADShell","CADSolid","CADCompsolid","CADCompound"],G4=new Set(B4);function V4(n){return k4.has(n.type)}class z4{static isPoint2d(e){return e.type==qr.POINT_2D}static isGeom2dCurve(e){return e.type==qr.CURVE_2D}static isVertex(e){return e.type==qr.VERTEX}static isEdge(e){return e.type==qr.EDGE}static isWire(e){return e.type==qr.WIRE}static isFace(e){return e.type==qr.FACE}static isShell(e){return e.type==qr.SHELL}static isSolid(e){return e.type==qr.SOLID}static isCompsolid(e){return e.type==qr.COMPSOLID}static isCompound(e){return e.type==qr.COMPOUND}static isShape(e){return G4.has(e.type)}static isGeometryShape(e){return bp(e.ShapeType)}}const H4=["CSGPath2","CSGGeom2","CSGGeom3"],j4=new Set(H4);function W4(n){return j4.has(n.type)}function X4(n){return n.type==Ev.TET}const OC=new Ht,PC=new T,NC=[],IC=[],DC=[],Fh=[],LC=[],FC=[];function $4(n){let e=0;return n.traverse(t=>{e+=Su(t)}),e}class hc extends jM{constructor(){super(void 0,0),this._allObjects=[],this._attributes={},this.touch()}dispose(){if(this._allObjects)for(const e of this._allObjects)e.dispose&&e.dispose();this._allObjects.length=0}geometry(){return null}builder(){}timestamp(){return this._timestamp}touch(){const e=ve.performance.performanceManager();this._timestamp=e.now()}resetBoundingBox(){}clone(){const e=new hc;if(this._allObjects){const r=this.allCoreObjects(),s=[];for(const i of r){const o=i.clone().object();o&&s.push(o)}e.setAllObjects(s)}const t=this.attribNames();for(const r of t){const s=this.attribValue(r);e.addAttribute(r,s)}return e}setAllObjects(e){this._allObjects=e,this.touch()}allObjects(){return this._allObjects}allCoreObjects(){var e;return(e=this.allObjects())==null?void 0:e.map((t,r)=>Vs(t,r))}cadObjects(){var e;return((e=this._allObjects)==null?void 0:e.filter(V4))||void 0}cadObjectsWithShape(){var e;return(e=this.cadObjects())==null?void 0:e.filter(t=>z4.isShape(t))}cadCoreObjects(){var e;return(e=this.cadObjects())==null?void 0:e.map((t,r)=>Vs(t,r))}csgObjects(){var e;return((e=this._allObjects)==null?void 0:e.filter(W4))||void 0}csgCoreObjects(){var e;return(e=this.csgObjects())==null?void 0:e.map((t,r)=>Vs(t,r))}quadObjects(){var e;return((e=this._allObjects)==null?void 0:e.filter(nR))||void 0}quadCoreObjects(){var e;return(e=this.quadObjects())==null?void 0:e.map((t,r)=>Vs(t,r))}threejsOrQuadObjects(){return this._allObjects?this._allObjects.filter(l4):[]}threejsOrQuadCoreObjects(){return this.threejsOrQuadObjects().map((e,t)=>Vs(e,t))}tetObjects(){var e;return((e=this._allObjects)==null?void 0:e.filter(X4))||void 0}tetCoreObjects(){var e;return(e=this.tetObjects())==null?void 0:e.map((t,r)=>Vs(t,r))}threejsObjects(){return this._allObjects?this._allObjects.filter(Xn):[]}threejsObjectsWithGeo(){return this.threejsObjects().filter(u4)}threejsCoreObjects(){return this.threejsObjects().map((e,t)=>new Gt(e,t))}geometries(){return this.threejsObjectsWithGeo().map(e=>e.geometry)}points(e){return O4(this.allObjects(),e)}pointsCount(){return Hk(this.allObjects().map(e=>Su(e)))}totalPointsCount(){const e=this.threejsObjects();let t=0;for(const r of e)t+=$4(r);return t}pointsFromGroup(e,t){if(e){yt.indices(e,NC),this.points(IC);const r=[],s=Js(NC.map(i=>IC[i]),r);return t.length=0,Sp(s,t),t}else return this.points(t)}pointAttribNames(){const e=this.allObjects()[0];return e?I4(e):[]}hasPointAttrib(e){const t=this.allObjects()[0];return t?N4(t,e):!1}pointAttribType(e){const t=this.allObjects()[0];return t?F4(t,e):Hn.NUMERIC}pointAttribNamesMatchingMask(e){return Dt.attribNamesMatchingMask(e,this.pointAttribNames())}pointAttribSizes(){const e=this.allObjects()[0];return e?L4(e):{}}pointAttribSize(e){const t=this.allObjects()[0];return t?D4(t,e):0}static _fromObjects(e){const t=new hc;return t.setAllObjects(e),t}objectAttribTypesByName(){return qz(this.allCoreObjects())}objectAttribNames(){return Yz(this.allCoreObjects())}objectAttribNamesMatchingMask(e){return Dt.attribNamesMatchingMask(e,this.objectAttribNames())}objectAttribSizesByName(){return $z(this.allCoreObjects())}renameAttribute(e,t){const r=this.attribValue(e);r!=null&&(this.addAttribute(t,r),this.deleteAttribute(e))}attribNamesMatchingMask(e){return Dt.attribNamesMatchingMask(e,this.attribNames())}hasAttribute(e){return this.attribValue(e)!=null}addAttribute(e,t){this.attributes()[e]=t}addNumericAttribute(e,t=1,r=0){const s=this.attributes();if(r!=null)if(Xl(r)){const i=XM(r);i!=null&&(s[e]=i)}else s[e]=r;else switch(t){case 1:return this.attributes()[e]=0;case 2:return this.attributes()[e]=new W(0,0);case 3:return this.attributes()[e]=new T(0,0,0);case 4:return this.attributes()[e]=new We(0,0,0,0)}}deleteAttribute(e){delete this.attributes()[e]}attribValue(e){return this._attributes&&this._attributes[e]}attribNames(){return this._attributes?Object.keys(this._attributes):[]}attribType(e){const t=this.attribValue(e);return Ke(t)?Hn.STRING:Hn.NUMERIC}attribSizes(){const e={};for(const t of this.attribNames()){const r=this.attribSize(t);r!=null&&(e[t]=r)}return e}attribSize(e){const t=this.attribValue(e);return t==null?null:Dt.attribSizeFromValue(t)}attributes(){return this._attributes||this._createAttributesDictionaryIfNone()}_createAttributesDictionaryIfNone(){return this._attributes||(this._attributes={}),this._attributes}setAttribValue(e,t){this.addAttribute(e,t)}stringAttribValue(e){return this.attribValue(e)}position(e){const t=this._allObjects.length;e.set(0,0,0);for(const r of this._allObjects)Ut(r).position(r,PC),e.add(PC);return e.divideScalar(t),e}attributeNames(){const e=this.attributes();return e?Object.keys(e):[]}attributeNamesMatchingMask(e){return Dt.attribNamesMatchingMask(e,this.attributeNames())}relatedObjects(e,t){Ts(this.allCoreObjects(),e)}relatedPrimitives(e,t){e.length=0;const r=this.allObjects();let s=0;for(const i of r){Ut(i).relatedPrimitives(i,s,FC);for(const o of FC)e.push(o);s++}}relatedVertices(e,t){this.relatedPrimitives(LC),eC(LC,r=>(r.relatedVertices(Fh),Fh),e)}relatedPoints(e,t){return this.relatedVertices(Fh),eC(Fh,r=>(r.relatedPoints(DC),DC),e)}relatedEntities(e,t,r,s){switch(e){case rt.POINT:{this.relatedPoints(r,s);return}case rt.VERTEX:{this.relatedVertices(r,s);return}case rt.PRIMITIVE:{this.relatedPrimitives(r,s);return}case rt.OBJECT:{this.relatedObjects(r,s);return}case rt.CORE_GROUP:{r.length=1,r[0]=t;return}}St.unreachable(e)}objectsData(){var e;return((e=this._allObjects)==null?void 0:e.map(t=>Ut(t).objectData(t)))||[]}boundingBox(e){e.makeEmpty();const t=this.allCoreObjects();for(const r of t)r.boundingBox(OC),e.union(OC)}static geometryFromObject(e){return e.isMesh||e.isLine||e.isPoints?e.geometry:null}}const q4="operationsComposer";class Fv{constructor(e,t,r){this._scene=e,this.states=t,this._node=r}static type(){throw"type to be overriden"}type(){return this.constructor.type()}static context(){throw console.error("operation has no node_context",this),"context requires override"}context(){return this.constructor.context()}scene(){return this._scene}cook(e,t){}convertExportParamData(e){const{params:t,paramName:r,paramData:s}=e,i=t[r];if(mr(s))return s;if(Ye(s))return mr(i)?s>=1:s;if(Ke(s))return i&&(i instanceof Zr||i instanceof vp)?i.setPath(s):s;_t(s)&&t[r].fromArray(s)}}Fv.DEFAULT_PARAMS={};Fv.INPUT_CLONED_STATE=[];class Ft extends Fv{static context(){return be.SOP}cook(e,t){}createCoreGroupFromObjects(e){const t=new hc;return t.setAllObjects(e),t}createCoreGroupFromGeometry(e,t=Tt.MESH){const r=Ft.createObject(e,t);return this.createCoreGroupFromObjects(r?[r]:[])}createObject(e,t,r){return Ft.createObject(e,t,r)}static createObject(e,t,r){this.createIndexIfNone(e);const s=Zb(t)||Zb(Tt.MESH);r=r||BM[t];const i=new s(e,r);return this.applyObjectDefault(i),i}static applyObjectDefault(e){e.castShadow=!0,e.receiveShadow=!0,e.frustumCulled=!1,e.matrixAutoUpdate=!1}createIndexIfNone(e){Ft.createIndexIfNone(e)}static createIndexIfNone(e){tR.createIndexIfNone(e)}}const Y4=!0,UC=new vr(new T(0,0,0),0);class Gt extends Q_{constructor(e,t){super(e,t),this._object=e}humanType(){return kM(this._object).humanName}object(){return this._object}geometry(){return this._object.geometry}static objectData(e){const t=$M(e);t.verticesCount=Vo.entitiesCount(e),t.pointsCount=Vr.entitiesCount(e);const r=Al(e);return t.primitivesCount=(r==null?void 0:r.entitiesCount(e))||0,t.primitiveName=(r==null?void 0:r.primitiveName())||"",t}static position(e,t){t.copy(e.position)}static boundingBox(e,t){t.setFromObject(e,Y4)}static geometryBoundingBox(e,t){const r=e.geometry;r?(r.boundingBox||r.computeBoundingBox(),r.boundingBox&&t.copy(r.boundingBox)):t.makeEmpty()}static boundingSphere(e,t){const r=e.geometry;if(!r){t.copy(UC);return}r.computeBoundingSphere();const s=r.boundingSphere;if(!s){t.copy(UC);return}t.copy(s)}static geometryBoundingSphere(e,t){this.boundingSphere(e,t)}static clone(e){const t=e.clone();var r=new Map,s=new Map;return Gt.parallelTraverse(e,t,function(i,o){r.set(o,i),s.set(i,o)}),t.traverse(function(i){const o=r.get(i),a=i;if(a.geometry&&o&&o.geometry){const h=o.geometry;a.geometry=Wz(h),Pv.copyBVH(a,o)}if(a.material){Tv(i,a.material);const h=a.material;h.color==null&&(h.color=new xe(1,1,1))}if(o){o.userData&&(i.userData=Ii(o.userData));const h=o;h.animations&&(i.animations=h.animations.map(p=>p.clone()));const d=i;if(d.isSkinnedMesh){var c=d,l=o,u=l.skeleton.bones;c.skeleton=l.skeleton.clone(),c.bindMatrix.copy(l.bindMatrix);const p=u.map(function(_){return s.get(_)});c.skeleton.bones=p,c.bind(c.skeleton,c.bindMatrix)}}}),t}static parallelTraverse(e,t,r){r(e,t);for(var s=0;s<e.children.length;s++){const i=e.children[s],o=t.children[s];i&&o&&this.parallelTraverse(i,o,r)}}static applyMatrix(e,t,r,s,i){switch(r){case hr.OBJECT:{oR(e,t,s,i);return}case hr.GEOMETRY:{const o=e.geometry;o&&o.applyMatrix4(t);return}}St.unreachable(r)}static mergeCompact(e){const{objects:t,material:r,objectType:s,mergedObjects:i,onError:o}=e,a=t[0];if(!a)return;const c=[];for(const l of t){const u=l.geometry;u&&(u.applyMatrix4(l.matrix),c.push(u))}try{const l=d4.merge(c);if(l){const u=Ft.createObject(l,s,r);u&&(zz(a,u),i.push(u))}else o("merge failed, check that input geometries have the same attributes")}catch(l){o(l.message||"unknown error")}}static relatedPrimitiveIds(e,t,r,s){const i=Al(e);if(!i){r.length=0;return}const o=i==null?void 0:i.entitiesCount(e);r.length=o;for(let a=0;a<o;a++)r[a]=a;s&&s[rt.PRIMITIVE].ids!=r&&Ts(r,s[rt.PRIMITIVE].ids)}static relatedPrimitiveClass(e){return Al(e)}}function Ca(n){console.warn(`CorePrimitive.${n} needs to be overloaded`)}const K4=[];class Z4 extends Dp{builder(){}static entitiesCount(e){return 0}static addAttribute(e,t,r){Ca("addAttribute")}static addNumericAttribute(e,t,r=1,s=0){Ca("addNumericAttribute")}static attributes(e){Ca("attributes")}attributes(){if(this._object)return this.constructor.attributes(this._object)}static attribute(e,t){const r=this.attributes(e);if(r)return r[t]}attribute(e){if(this._object)return this.constructor.attribute(this._object,e)}static renameAttribute(e,t,r){const s=this.attributes(e);if(!s)return;const i=this.attribute(e,t);i&&(s[r]=i,delete s[t])}static deleteAttribute(e,t){const r=this.attributes(e);r&&delete r[t]}static attribSize(e,t){const r=this.attributes(e);return r?(t=Dt.remapName(t),r[t].itemSize||0):-1}attribSize(e){return this._object?this.constructor.attribSize(this._object,e):0}static hasAttribute(e,t){const r=Dt.remapName(t);return this.attributes(e)?this.attributes(e)[r]!=null:!1}hasAttribute(e){return this._object?this.constructor.hasAttribute(this._object,e):!1}static attributeNames(e){const t=this.attributes(e);return t?Object.keys(t):[]}static attributeNamesMatchingMask(e,t){return Dt.attribNamesMatchingMask(t,this.attributeNames(e))}static attribValue(e,t,r,s){if(r===vt.PRIMITIVE_INDEX)return t;let i=null,o=null;r[r.length-2]===Cv&&(i=r[r.length-1],o=bv[i],r=r.substring(0,r.length-2));const a=Dt.remapName(r);if(a==vt.POSITION)return this.position(e,t,s);if(a==vt.NORMAL)return this.normal(e,t,s);const c=this.attribute(e,a);if(c){const{array:l}=c,u=c.itemSize,h=t*u;if(o==null)switch(u){case 1:return l[h];case 2:return s=s||new W,s.fromArray(l,h),s;case 3:return s=s||new T,s.fromArray(l,h),s;case 4:return s=s||new We,s.fromArray(l,h),s;default:throw`size not valid (${u})`}else switch(u){case 1:return l[h];default:return l[h+o]}}else{const l=this.attributes(e)||{},u=Object.keys(l),h=`attrib ${r} not found. availables are: ${u.join(",")}`;throw console.warn(h),h}}attribValue(e,t){return this._object?this.constructor.attribValue(this._object,this._index,e,t):0}attribValueNumber(e){const t=this.attribute(e);return t?t.array[this._index]:0}attribValueVector2(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*2),t}attribValueVector3(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*3),t}attribValueVector4(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*4),t}static attribType(e,t){const r=e?this.attribute(e,t):null;return r&&(r==null?void 0:r.isString)==!0?Hn.STRING:Hn.NUMERIC}attribType(e){return this.constructor.attribType(this._object,e)}static stringAttribValue(e,t,r){return this.attribValue(e,t,r)}stringAttribValue(e){return this.attribValue(e)}static position(e,t,r){return Ca("position"),r}static normal(e,t,r){return Ca("normal"),r}static computeVertexNormalsIfAttributeVersionChanged(e){Ca("computeVertexNormalsIfAttributeVersionChanged")}setAttribValue(e,t){const r=this.attribute(e);if(!r){console.warn(`no attribute ${e}`);return}const s=r.array,i=r.itemSize;if(_t(t)){for(let o=0;o<i;o++)s[this._index*i+o]=t[o];return}switch(i){case 1:s[this._index]=t;break;case 2:const o=t,a=this._index*2;s[a+0]=o.x,s[a+1]=o.y;break;case 3:const c=t.r!=null,l=this._index*3;if(c){const d=t;s[l+0]=d.r,s[l+1]=d.g,s[l+2]=d.b}else{const d=t;s[l+0]=d.x,s[l+1]=d.y,s[l+2]=d.z}break;case 4:const u=t,h=this._index*4;s[h+0]=u.x,s[h+1]=u.y,s[h+2]=u.z,s[h+3]=u.w;break;default:throw console.warn(`CorePrimitive.setAttribValue does not yet allow attribSize ${i}`),`attrib size ${i} not implemented`}}setAttribValueFromNumber(e,t){const r=this.attribute(e);if(!r)return;const s=r.array;s[this._index]=t}setAttribValueFromVector2(e,t){const r=this.attribute(e);!r||r.isString==!0||t.toArray(r.array,this._index*2)}setAttribValueFromVector3(e,t){const r=this.attribute(e);!r||r.isString==!0||t.toArray(r.array,this._index*3)}setAttribValueFromVector4(e,t){const r=this.attribute(e);!r||r.isString==!0||t.toArray(r.array,this._index*4)}static relatedPointIds(e,t,r,s){const i=s?s[rt.VERTEX].ids:K4;this.relatedVertexIds(e,t,i),jd(i,(o,a)=>{this.relatedVertexClass(e).relatedPointIds(e,o,a)},r)}static relatedPointClass(e){return this.relatedVertexClass(e).relatedPointClass(e)}relatedEntities(e,t,r,s){switch(e){case rt.POINT:{this.relatedPoints(r,s);return}case rt.VERTEX:{this.relatedVertices(r,s);return}case rt.PRIMITIVE:{r.length=1,r[0]=this;return}case rt.OBJECT:{this.relatedObjects(r,s);return}case rt.CORE_GROUP:{r.length=1,r[0]=t;return}}St.unreachable(e)}static graph(e){console.warn("CorePrimitive.graph needs to be overriden")}}function J4(n){return kv(n).entitiesCount(n)}const fm={attributeAdded:!1,values:[]};class Uv extends Z4{constructor(e,t){super(e,t),this._updateGeometry()}setIndex(e,t){return this._index=e,t&&(this._object=t,this._updateGeometry()),this}_updateGeometry(){const e=this._object.geometry;e&&(this._geometry=e)}geometry(){return this._geometry}static addAttribute(e,t,r){const s=this.attributes(e);s&&(s[t]=r)}static addNumericAttribute(e,t,r=1,s=0){const i=this.entitiesCount(e);fm.values=new Array(i*r),Sv(e,J4,r,s,fm);const o={isString:!1,array:fm.values,itemSize:r};this.addAttribute(e,t,o)}static attributes(e){const t=e.geometry;if(t)return t.userData.primAttributes||(t.userData.primAttributes={}),t.userData.primAttributes}static stride(){return 3}static relatedVertexIds(e,t,r){if(!e.geometry){r.length=0;return}const i=this.stride();r.length=i;for(let o=0;o<i;o++)r[o]=t*i+o}static relatedVertexClass(e){return Vo}static relatedObjectClass(e){return Gt}}const kC=new T,mm=3,Q4=(n,e)=>{const t=n,r=t.geometry;if(!r)return;const s=r.getIndex();if(!s)return;const i=s.array,o=e,a=new Array(o.length*mm);let c=0;for(const l of o)kC.fromArray(i,l.index()*mm),kC.toArray(a,c*mm),c++;return r.setIndex(a),t},Uh=new Fn,BC=new T,GC=new T,VC=new T,zC=new Map;class Yl extends Uv{constructor(e,t){super(e,t),this._geometry=e.geometry}static primitiveName(){return"triangle"}static entitiesCount(e){const t=e.geometry;if(!t)return 0;const r=t.getIndex();return r?r.count/3:0}static position(e,t,r){if(!(e&&e.geometry))return r;const s=e.geometry.getAttribute(vt.POSITION);if(!s)return r;const i=s.array;return BC.fromArray(i,t*3+0),GC.fromArray(i,t*3+1),VC.fromArray(i,t*3+2),r.copy(BC).add(GC).add(VC).divideScalar(3),r}static normal(e,t,r){if(!(e&&e.geometry))return r;const s=e.geometry.getAttribute(vt.POSITION);if(!s)return r;const i=s.array;return Uh.a.fromArray(i,t*3+0),Uh.b.fromArray(i,t*3+1),Uh.c.fromArray(i,t*3+2),Uh.getNormal(r),r}position(e){return this.constructor.position(this._object,this._index,e)}normal(e){return this.constructor.normal(this._object,this._index,e)}static computeVertexNormalsIfAttributeVersionChanged(e){const t=e.geometry;if(!t)return null;const r=t.getAttribute(vt.POSITION);if(!r||!(r instanceof Lt))return;let s=zC.get(t.uuid);(s==null||s!=r.version)&&(t.computeVertexNormals(),zC.set(t.uuid,r.version))}builder(){return Q4}static stride(){return 3}}const _m=new T,Yc=new T;class aR extends Uv{constructor(e,t){super(e,t),this._geometry=e.geometry}static primitiveName(){return"line"}static entitiesCount(e){const t=e.geometry;if(!t)return 0;const r=t.getIndex();return r?r.count/2:0}static position(e,t,r){if(!(e&&e.geometry))return r;const s=e.geometry.getAttribute(vt.POSITION);if(!s)return r;const i=s.array;return _m.fromArray(i,t*3+0),Yc.fromArray(i,t*3+1),r.copy(_m).add(Yc).divideScalar(2),r}static normal(e,t,r){if(!(e&&e.geometry))return r;const s=e.geometry.getAttribute(vt.POSITION);if(!s)return r;const i=s.array;return _m.fromArray(i,t*3+0),Yc.fromArray(i,t*3+1),r.copy(Yc).sub(Yc).normalize(),r}position(e){return this.constructor.position(this._object,this._index,e)}normal(e){return this.constructor.normal(this._object,this._index,e)}static computeVertexNormalsIfAttributeVersionChanged(e){}static stride(){return 2}}const HC=new T;class cR extends Uv{constructor(e,t){super(e,t),this._geometry=e.geometry}static primitiveName(){return"point"}static entitiesCount(e){const t=e.geometry;if(!t)return 0;const r=t.getIndex();return r?r.count:0}static position(e,t,r){if(!(e&&e.geometry))return r;const s=e.geometry.getAttribute(vt.POSITION);if(!s)return r;const i=s.array;return HC.fromArray(i,t*3+0),r.copy(HC),r}static normal(e,t,r){return r.set(0,1,0)}position(e){return this.constructor.position(this._object,this._index,e)}normal(e){return this.constructor.normal(this._object,this._index,e)}static computeVertexNormalsIfAttributeVersionChanged(e){}static stride(){return 1}}const ej=n=>{if(Xn(n))return Vr},tj=()=>Vr,nj=(n,e=0)=>{if(Xn(n))return new Vr(n,e)},rj=(n,e=0)=>new Vr(n,e),sj=n=>{if(Xn(n))return Vo},ij=()=>Vo,oj=(n,e=0)=>{if(Xn(n))return new Vo(n,e)},aj=(n,e=0)=>new Vo(n,e),Al=n=>{if(Xn(n))return n.isMesh?Yl:n.isLineSegments?aR:n.isPoints?cR:Yl},cj=()=>Yl,lj=Al,uj=(n,e=0)=>{if(Xn(n)){if(n.isMesh)return new Yl(n,e);if(n.isLineSegments)return new aR(n,e);if(n.isPoints)return new cR(n,e)}},hj=(n,e=0)=>new Yl(n,e),dj=n=>{if(Xn(n)){if(n.isMesh)return 3;if(n.isLineSegments)return 2;if(n.isPoints)return 1}return 0},pj=n=>{if(Xn(n)||n.isObject3D)return Gt},fj=()=>Gt,mj=(n,e=0)=>{if(Xn(n))return new Gt(n,e)},_j=(n,e=0)=>new Gt(n,e),si={pointClass:ej,pointInstance:nj,vertexClass:sj,vertexInstance:oj,primitiveClass:lj,primitiveInstance:uj,objectClass:pj,objectInstance:mj},Ki=[si];function Os(n){for(const e of Ki){const t=e.pointClass(n);if(t)return t}return si.pointClass(n)||tj()}function lR(n,e=0){for(const t of Ki){const r=t.pointInstance(n,e);if(r)return r}return si.pointInstance(n,e)||rj(n,e)}function uR(n){for(const e of Ki){const t=e.vertexClass(n);if(t)return t}return si.vertexClass(n)||ij()}function gj(n,e=0){for(const t of Ki){const r=t.vertexInstance(n,e);if(r)return r}return si.vertexInstance(n,e)||aj(n,e)}function kv(n){for(const e of Ki){const t=e.primitiveClass(n);if(t)return t}return si.primitiveClass(n)||cj()}function vj(n,e=0){for(const t of Ki){const r=t.primitiveInstance(n,e);if(r)return r}return si.primitiveInstance(n,e)||hj(n,e)}function Ut(n){for(const e of Ki){const t=e.objectClass(n);if(t)return t}return si.objectClass(n)||fj()}function Vs(n,e=0){for(const t of Ki){const r=t.objectInstance(n,e);if(r)return r}return si.objectInstance(n,e)||_j(n)}rt.POINT+"",rt.VERTEX+"",rt.PRIMITIVE+"",rt.OBJECT+"",rt.CORE_GROUP+"";rt.POINT+"",rt.VERTEX+"",rt.PRIMITIVE+"",rt.OBJECT+"",rt.CORE_GROUP+"";const yj=[];function as(n){console.warn(`CorePoint.${n} needs to be overloaded`)}class xj extends Dp{builder(){}static addAttribute(e,t,r){as("addAttribute")}static entitiesCount(e){return 0}static attributes(e){as("attributes")}attributes(){return this.constructor.attributes(this._object)}static attribute(e,t){const r=this.attributes(e);if(r)return r[t]}attribute(e){return this.constructor.attribute(this._object,e)}static attribSize(e,t){const r=this.attributes(e);return r?(t=Dt.remapName(t),r[t].itemSize||0):-1}attribSize(e){return this.constructor.attribSize(this._object,e)}static hasAttribute(e,t){const r=Dt.remapName(t);return this.attributes(e)?this.attributes(e)[r]!=null:!1}hasAttribute(e){return this.constructor.hasAttribute(this._object,e)}static userDataAttribs(e){return as("userDataAttribs"),{}}userDataAttribs(){return this._object?this.constructor.userDataAttribs(this._object):{}}static userDataAttrib(e,t){return t=Dt.remapName(t),this.userDataAttribs(e)[t]}userDataAttrib(e){return e=Dt.remapName(e),this.userDataAttribs()[e]}static attributeNames(e){const t=this.attributes(e);return t?Object.keys(t):[]}static attributeNamesMatchingMask(e,t){return Dt.attribNamesMatchingMask(t,this.attributeNames(e))}static indexedAttributeNames(e){return e?Object.keys(this.userDataAttribs(e)||{}):[]}indexedAttributeNames(){return this._object?this.constructor.indexedAttributeNames(this._object):[]}static isAttribIndexed(e,t){return t=Dt.remapName(t),this.userDataAttrib(e,t)!=null}isAttribIndexed(e){return e=Dt.remapName(e),this.userDataAttrib(e)!=null}static setIndexedAttributeValues(e,t,r){this.userDataAttribs(e)[t]=r}setIndexedAttributeValues(e,t){return this.constructor.setIndexedAttributeValues(this._object,e,t)}static setIndexedAttribute(e,t,r,s){as("setIndexedAttribute")}setIndexedAttribute(e,t,r){return this.constructor.setIndexedAttribute(this._object,e,t,r)}static indexedAttribValue(e,t,r){const s=this.attribValueIndex(e,t,r),i=this.userDataAttrib(e,r);return i?i[s]:null}indexedAttribValue(e){return this.constructor.indexedAttribValue(this._object,this._index,e)}static stringAttribValue(e,t,r){return this.indexedAttribValue(e,t,r)}stringAttribValue(e){return this.indexedAttribValue(e)}static attribValueIndex(e,t,r){return as("attribValueIndex"),0}attribValueIndex(e){return this.constructor.attribValueIndex(this._object,this._index,e)}static attribType(e,t){return this.isAttribIndexed(e,t)?Hn.STRING:Hn.NUMERIC}attribType(e){return this.constructor.attribType(this._object,e)}isStringAttribute(e){return this.attribType(e)==Hn.STRING}setAttribIndex(e,t){const r=this.attribute(e);if(!r)return;const s=r.array;s[this._index]=t}static renameAttribute(e,t,r){const s=this.attributes(e);if(!s)return;const i=this.attribute(e,t);i&&(s[r]=i,delete s[t])}static deleteAttribute(e,t){const r=this.attributes(e);r&&delete r[t]}static attribValue(e,t,r,s){if(r===vt.POINT_INDEX)return t;{let i=null,o=null;r[r.length-2]===Cv&&(i=r[r.length-1],o=bv[i],r=r.substring(0,r.length-2));const a=Dt.remapName(r),c=this.attribute(e,a);if(c){const{array:l}=c;if(this.isAttribIndexed(e,a))return this.indexedAttribValue(e,t,a);{const u=c.itemSize,h=t*u;if(o==null)switch(u){case 1:return l[h];case 2:return s=s||new W,s.fromArray(l,h),s;case 3:return s=s||new T,s.fromArray(l,h),s;case 4:return s=s||new We,s.fromArray(l,h),s;default:throw`size not valid (${u})`}else switch(u){case 1:return l[h];default:return l[h+o]}}}else{const l=this.attributes()||{},u=Object.keys(l),h=`attrib ${r} not found. availables are: ${u.join(",")}`;throw console.warn(h),h}}}attribValue(e,t){return this.constructor.attribValue(this._object,this._index,e,t)}attribValueNumber(e){const t=this.attribute(e);return t?t.array[this._index]:0}attribValueVector2(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*2),t}attribValueVector3(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*3),t}attribValueVector4(e,t){const r=this.attribute(e);if(r)return t.fromArray(r.array,this._index*4),t}position(e){return as("position"),e}setPosition(e){this.setAttribValueFromVector3(vt.POSITION,e)}normal(e){return as("normal"),e}setNormal(e){return this.setAttribValueFromVector3(vt.NORMAL,e)}static computeNormals(e){as("computeNormals")}setAttribValue(e,t){const r=this.attribute(e);if(!r)return;const s=r.array,i=r.itemSize;if(_t(t)){for(let o=0;o<i;o++)s[this._index*i+o]=t[o];return}switch(i){case 1:s[this._index]=t;break;case 2:const o=t,a=this._index*2;s[a+0]=o.x,s[a+1]=o.y;break;case 3:const c=t.r!=null,l=this._index*3;if(c){const d=t;s[l+0]=d.r,s[l+1]=d.g,s[l+2]=d.b}else{const d=t;s[l+0]=d.x,s[l+1]=d.y,s[l+2]=d.z}break;case 4:const u=t,h=this._index*4;s[h+0]=u.x,s[h+1]=u.y,s[h+2]=u.z,s[h+3]=u.w;break;default:throw console.warn(`CorePoint.setAttribValue does not yet allow attrib size ${i}`),`attrib size ${i} not implemented`}}setAttribValueFromNumber(e,t){const r=this.attribute(e);if(!r)return;const s=r.array;s[this._index]=t}setAttribValueFromVector2(e,t){const r=this.attribute(e);!r||this.isStringAttribute(e)||t.toArray(r.array,this._index*2)}setAttribValueFromVector3(e,t){const r=this.attribute(e);!r||this.isStringAttribute(e)||t.toArray(r.array,this._index*3)}setAttribValueFromVector4(e,t){const r=this.attribute(e);!r||this.isStringAttribute(e)||t.toArray(r.array,this._index*4)}static addAttributeFromAttribData(e,t,r){switch(r.type()){case Hn.STRING:return console.log("TODO: to implement");case Hn.NUMERIC:return this.addNumericAttribute(e,t,r.size())}}static addNumericAttribute(e,t,r=1,s=0){as("addNumericAttribute")}static markAttribAsNeedsUpdate(e,t){as("markAttribAsNeedsUpdate")}static relatedPrimitiveIds(e,t,r,s){const i=s?s[rt.VERTEX].ids:yj;this.relatedVertexIds(e,t,i),jd(i,(o,a)=>{this.relatedVertexClass(e).relatedPrimitiveIds(e,o,a)},r)}static relatedPrimitiveClass(e){return this.relatedVertexClass(e).relatedPrimitiveClass(e)}static relatedObjectClass(e){return this.relatedPrimitiveClass(e).relatedObjectClass(e)}relatedEntities(e,t,r,s){switch(e){case rt.POINT:{r.length=1,r[0]=this;return}case rt.VERTEX:return this.relatedVertices(r,s);case rt.PRIMITIVE:return this.relatedPrimitives(r,s);case rt.OBJECT:{this._object?(r.length=1,r[0]=Vs(this._object)):r.length=0;return}case rt.CORE_GROUP:{r.length=1,r[0]=t;return}}St.unreachable(e)}}const jC="indexedAttribValues",kh={attributeAdded:!1,values:[]};class Vr extends xj{constructor(e,t){super(e,t),this._updateGeometry()}setIndex(e,t){return this._index=e,t&&(this._object=t,this._updateGeometry()),this}_updateGeometry(){const e=this._object.geometry;e&&(this._geometry=e)}geometry(){return this._geometry}static addAttribute(e,t,r){const s=e.geometry;s&&s.setAttribute(t,r)}static attributes(e){const t=e.geometry;if(t)return t.attributes}static entitiesCount(e){const t=e.geometry;return t?iR(t):0}static positionAttributeName(e){const t=e.geometry;return t?sR(t):null}static position(e,t,r){const s=e.geometry;if(!s)return null;const{array:i}=s.getAttribute(vt.POSITION);return r.fromArray(i,t*3)}position(e){if(!this._geometry)return e;const{array:t}=this._geometry.getAttribute(vt.POSITION);return e.fromArray(t,this._index*3)}normal(e){if(!this._geometry)return e;const{array:t}=this._geometry.getAttribute(vt.NORMAL);return e.fromArray(t,this._index*3)}static computeNormals(e){const t=e.geometry;if(!t)return null;t.computeVertexNormals()}static markAttribAsNeedsUpdate(e,t){const r=e.geometry;if(!r)return null;const s=r.getAttribute(t);s&&(s.needsUpdate=!0)}static userDataAttribs(e){const t=e.geometry;return t?t.userData[jC]=t.userData[jC]||{}:{}}static setIndexedAttribute(e,t,r,s){const i=e.geometry;i&&(this.setIndexedAttributeValues(e,t,r),i.setAttribute(t,new MN(s,1)),i.getAttribute(t).needsUpdate=!0)}static attribValueIndex(e,t,r){if(this.isAttribIndexed(e,r)){const s=e.geometry;if(s)return s.getAttribute(r).array[t]}return-1}static renameAttribute(e,t,r){const s=e.geometry;if(!s)return;this.isAttribIndexed(e,t)&&(this.userDataAttribs(e)[r]=Ii(this.userDataAttribs(e)[t]),delete this.userDataAttribs(e)[t]);const i=s.getAttribute(t);return s.setAttribute(r,new gt(i.array,i.itemSize)),s.deleteAttribute(t)}static deleteAttribute(e,t){const r=e.geometry;if(r)return this.isAttribIndexed(e,t)&&delete this.userDataAttribs(e)[t],r.deleteAttribute(t)}static addNumericAttribute(e,t,r=1,s=0){const i=e.geometry;if(i)if(Sv(e,Su,r,s,kh),kh.attributeAdded)if(rR(i)){const o=new Float32Array(kh.values);i.setAttribute(t.trim(),new f_(o,r))}else i.setAttribute(t.trim(),new gt(kh.values,r));else throw console.warn(s),`CoreThreejsPoint.addNumericAttrib error: no other default value allowed for now (default given: ${s})`}static relatedVertexIds(e,t,r,s){const i=e.geometry;if(!i)return;const o=i.getIndex();if(!o)return;const a=o.array;let c=0;for(const l of a)l==t&&r.push(c),c++}static relatedVertexClass(e){return Vo}}const Bh="'",WC=", ",bj="@",Cj=["abs","acos","acosh","asin","asinh","atan","atan2","atanh","ceil","cos","cosh","exp","expm1","floor","log","log1p","log2","log10","max","min","pow","round","sign","sin","sinh","sqrt","tan","tanh"],Ej=["cbrt","hypot","log10","trunc"],XC={math_random:"random"},Sj=["fit","fit01","fract","deg2rad","rad2deg","rand","clamp"],Aj=Object.keys(WT),Tj=["precision"],Mj=["E","LN2","LN10","LOG10E","LOG2E","PI","SQRT1_2","SQRT2"],Ho={};Cj.forEach(n=>{Ho[n]=`Math.${n}`});Ej.forEach(n=>{Ho[n]=`Math.${n}`});Object.keys(XC).forEach(n=>{const e=XC[n];Ho[n]=`Math.${e}`});Sj.forEach(n=>{Ho[n]=`Core.Math.${n}`});Aj.forEach(n=>{Ho[n]=`Core.Math.Easing.${n}`});Tj.forEach(n=>{Ho[n]=`Core.String.${n}`});const Rj={if:Lz.if},hR={};Mj.forEach(n=>{hR[n]=`Math.${n}`});const wj={x:0,y:1,z:2,w:3,r:0,g:1,b:2},Oj={Math:yn,String:yt};function Pj(n,e){const t=n[0];return t&&t instanceof Vr?t.attribute(e):n.map(r=>r.attribValue(e,new We))}function Nj(n,e,t,r,s){return t[n.index()*r+s]}const Ij={0:"x",1:"y",2:"z",3:"w"},Dj={0:"r",1:"g",2:"b",3:"r"},Lj=new We;function Fj(n,e,t,r,s){const i=n.attribValue(e,Lj);return _t(i)?i[s]:zl(i)?i[Ij[s]]:Hl(i)?i[Dj[s]]:i}function Uj(n){return n instanceof Vr?Nj:Fj}const dR={corePointClassFactory:Os,ThreejsPoint:Vr,Core:Oj,CoreType:yr,[zM]:Pj,[HM]:Uj},pR=Object.keys(dR),kj=pR.map(n=>dR[n]);class Bj extends VM{constructor(e){super(e),this.param=e,this._entitiesDependent=!1,this._attribute_requirements_controller=new ds,this.methods=[],this.method_index=-1,this.methodDependencies=[],this.immutableDependencies=[]}entitiesDependent(){return this._entitiesDependent}parseTree(e){if(this.reset(),e.errorMessage())this.setError("cannot parse expression");else{try{this._attribute_requirements_controller=new ds;const t=e.node();if(t){const r=this.traverse_node(t);r&&!this.isErrored()&&(this.function_main_string=r)}else console.warn("no parsedTree.node")}catch(t){console.warn(`error in expression for param ${this.param.path()}`),console.warn(t)}if(this.function_main_string)try{const t=this._functionBody();this.function=new Function(...pR,"param","methods","_set_error_from_error",`
					try {
						${t}
					} catch(e) {
						_set_error_from_error(e)
						return null;
					}`)}catch(t){console.warn(t),this.setError("cannot generate function")}else this.setError("cannot generate function body")}}reset(){super.reset(),this.function_main_string=void 0,this.methods=[],this.method_index=-1,this.function=void 0,this._entitiesDependent=!1,this.methodDependencies=[],this.immutableDependencies=[]}_functionBody(){return this._entitiesDependent?`
			const ${Di} = param.expressionController.entities();
			
			if(${Di} && ${Di}.length > 0){
				return new Promise( async (resolve, reject)=>{
					try {
						const entityCallback = param.expressionController.entityCallback();
						// assign_attributes_lines
						${this._attribute_requirements_controller.assignAttributesLines()}
						// check if attributes are present
						if( ${this._attribute_requirements_controller.attributePresenceCheckLine()} ){
							// assign function
							const ${Qb} = ${HM}(entities[0]);
							// assign_arrays_lines
							${this._attribute_requirements_controller.assignArraysLines()}
							for(const ${zc} of ${Di}){
								result = ${this.function_main_string};
								entityCallback(${zc}, result);
							}
							resolve()
						} else {
							const missingAttributes = ${this._attribute_requirements_controller.missingAttributesLine()}().join(', ');
							const error = new Error('attribute ' + missingAttributes + ' not found')
							_set_error_from_error(error)
							reject(error)
						}
					}catch(e){
						_set_error_from_error(e)
						reject(e)
					}
				})
			}
			return []`:`
			return new Promise( async (resolve, reject)=>{
				try {
					const value = ${this.function_main_string}
					resolve(value)
				} catch(e) {
					_set_error_from_error(e)
					reject()
				}
			})
			`}evalAllowed(){return this.function!=null}evalFunction(){if(this.function)return this.clearError(),this.function(...kj,this.param,this.methods,this._set_error_from_error_bound)}traverse_CallExpression(e){const t=e.arguments.map(i=>this.traverse_node(i)),s=e.callee.name;if(s){const i=Rj[s];if(i)return i(t);const o=`${t.join(WC)}`,a=Ho[s];if(a)return`${a}(${o})`;const c=ve.expressionsRegister;if(c.getMethod(s)){const u=e.arguments[0],h=`return ${t[0]}`;let d,p;try{d=new Function(h),p=d()}catch{}return this._createMethodAndDependencies(s,p,u),`(await methods[${this.method_index}].processArguments([${o}]))`}else{const u=c.availableMethods().join(", "),h=`method not found (${s}), available methods are: ${u}`;ve.warn(h)}}this.setError(`unknown method: ${s}`)}traverse_BinaryExpression(e){return`(${this.traverse_node(e.left)} ${e.operator} ${this.traverse_node(e.right)})`}traverse_UnaryExpression(e){if(e.operator===bj){this._entitiesDependent=!0;let t=e.argument,r,s;switch(t.type){case"Identifier":{r=t.name;break}case"MemberExpression":{const i=t,o=i.object,a=i.property;r=o.name,s=a.name;break}}if(r){if(r=Dt.remapName(r),r==vt.POINT_INDEX||r==vt.OBJECT_INDEX)return`((${zc} != null) ? ${zc}.index() : 0)`;{const i=this._attribute_requirements_controller.varAttributeSize(r),o=this._attribute_requirements_controller.varArray(r);this._attribute_requirements_controller.add(r);let a=s?wj[s]:0;return a==null&&(a=0),`${Qb}(${zc}, '${r}', ${o}, ${i}, ${a})`}}else return console.warn("attribute not found"),""}else return`${e.operator}${this.traverse_node(e.argument)}`}traverse_Identifier(e){if(e.name[0]==GM){const r=e.name.substring(1),s=hR[r];if(s)return s;const i=`traverse_Identifier_${r}`;if(this[i])return this[i]();this.setError(`identifier unknown: ${e.name}`)}else return e.name}traverse_Identifier_F(){return this.immutableDependencies.push(this.param.scene().timeController.graphNode),"param.scene().timeController.frame()"}traverse_Identifier_T(){return this.immutableDependencies.push(this.param.scene().timeController.graphNode),"param.scene().timeController.time()"}traverse_Identifier_OS(){const e=this.param.node.nameController.graphNode();return this.param.addGraphInput(e),"param.node.name()"}traverse_Identifier_CH(){return`${Bh}${this.param.name()}${Bh}`}traverse_Identifier_CEX(){return this._method_centroid("x")}traverse_Identifier_CEY(){return this._method_centroid("y")}traverse_Identifier_CEZ(){return this._method_centroid("z")}_method_centroid(e){const r=[0,`${Bh}${e}${Bh}`].join(WC);return this._createMethodAndDependencies("centroid",0),`(await methods[${this.method_index}].processArguments([${r}]))`}_createMethodAndDependencies(e,t,r){const s=ve.expressionsRegister,i=s.getMethod(e);if(!i){const c=s.availableMethods(),l=`method not found (${e}), available methods are: ${c.join(", ")}`;this.setError(l),ve.warn(l);return}const o=new i(this.param);this.method_index+=1,this.methods[this.method_index]=o;const a=o.findDependency({indexOrPath:t});a?(r&&a.set_jsep_node(r),this.methodDependencies.push(a)):r&&Ke(t)&&this.param.scene().missingExpressionReferencesController.register(this.param,t,r)}}const Gj=", ";class Vj extends VM{constructor(e){super(e),this.param=e}parseTree(e){const t=e.node();if(e.errorMessage()==null&&t)try{return this.traverse_node(t)}catch{this.setError("could not traverse tree")}else this.setError("cannot parse tree")}traverse_CallExpression(e){const r=`${e.arguments.map(i=>this.traverse_node(i)).join(Gj)}`;return`${e.callee.name}(${r})`}traverse_UnaryExpression(e){return`${e.operator}${this.traverse_node(e.argument)}`}traverse_Identifier(e){return`${e.name}`}}class zj{constructor(e){this.param=e,this._cyclicGraphDetected=!1,this.methodDependencies=[]}setError(e){this._errorMessage=this._errorMessage||e}errorMessage(){return this._errorMessage}reset(){this.param.graphDisconnectPredecessors(),this.methodDependencies.forEach(e=>{e.reset()}),this.methodDependencies=[]}update(e){this._cyclicGraphDetected=!1,this._connectImmutableDependencies(e),this.methodDependencies=e.methodDependencies,this._handleMethodDependencies(),this._listenForNameChanges()}_connectImmutableDependencies(e){const t=e.immutableDependencies;for(const r of t)if(this._cyclicGraphDetected==!1&&this.param.addGraphInput(r)==!1){this._cyclicGraphDetected=!0,this.setError("cannot create expression, infinite graph detected"),this.reset();return}}_handleMethodDependencies(){this.methodDependencies.forEach(e=>{this._cyclicGraphDetected==!1&&this._handleMethodDependency(e)})}_handleMethodDependency(e){const t=e.resolved_graph_node;if(t&&!this.param.addGraphInput(t)){this._cyclicGraphDetected=!0,this.setError("cannot create expression, infinite graph detected"),this.reset();return}}_listenForNameChanges(){this.methodDependencies.forEach(e=>{e.listen_for_name_changes()})}}class Hj{constructor(e){this.param=e,this._parseStarted=!1,this.parsedTree=new Kb(this.param),this._functionGenerator=new Bj(this.param),this.dependenciesController=new zj(this.param)}generatedFunctionEntitiesDependent(){return this._functionGenerator.entitiesDependent()}parseExpression(e){if(this._parseStarted)throw new Error(`parse in progress for param ${this.param.path()}`);if(this._parseStarted=!0,this.parsedTree=this.parsedTree||new Kb(this.param),this.reset(),this.param.expressionParsedAsString()?this.parsedTree.parseExpressionForStringParam(e):this.parsedTree.parseExpression(e),this._functionGenerator.parseTree(this.parsedTree),this._functionGenerator.errorMessage()==null){this.dependenciesController.update(this._functionGenerator);const t=this.dependenciesController.errorMessage();t?this.param.states.error.set(t):this._parseStarted=!1}}async computeFunction(){if(this._computeAllowed())try{return await this._functionGenerator.evalFunction()}catch(e){ve.error("error while evaluating expression",e)}else ve.error("compute not allowed")}reset(){this._parseStarted=!1,this.dependenciesController.reset(),this._functionGenerator.reset()}isErrored(){return this._functionGenerator.isErrored()}errorMessage(){return this._functionGenerator.errorMessage()}_computeAllowed(){return this._functionGenerator.evalAllowed()}updateFromMethodDependencyNameChange(){this._expressionStringGenerator=this._expressionStringGenerator||new Vj(this.param);const e=this._expressionStringGenerator.parseTree(this.parsedTree);e?this.param.set(e):console.warn("failed to regenerate expression")}}class fR{constructor(e){this.param=e}dispose(){this.param.scene().expressionsController.deregisterParam(this.param),this._resetMethodDependencies(),this._manager=void 0}_resetMethodDependencies(){var e,t;(e=this._methodDependenciesByGraphNodeId)==null||e.forEach(r=>{r.dispose()}),(t=this._methodDependenciesByGraphNodeId)==null||t.clear()}registerMethodDependency(e){this._methodDependenciesByGraphNodeId=this._methodDependenciesByGraphNodeId||new Map,this._methodDependenciesByGraphNodeId.set(e.graphNodeId(),e)}active(){return this._expression!=null}expression(){return this._expression}isErrored(){return this._manager?this._manager.isErrored():!1}errorMessage(){return this._manager?this._manager.errorMessage():null}entitiesDependent(){var e;const t=((e=this._manager)==null?void 0:e.generatedFunctionEntitiesDependent())||!1;return this.param.options.isExpressionForEntities()&&t}setExpression(e,t=!0){var r;if(this.param.disposed()){this._resetMethodDependencies(),this._expression=void 0;return}this.param.scene().missingExpressionReferencesController.deregisterParam(this.param),this.param.scene().expressionsController.deregisterParam(this.param),this._expression!=e&&(this._resetMethodDependencies(),this._expression=e,this._expression?(this._manager=this._manager||new Hj(this.param),this._manager.parseExpression(this._expression)):(r=this._manager)==null||r.reset(),t&&this.param.setDirty())}updateFromMethodDependencyNameChange(){this._manager&&this.active()&&this._manager.updateFromMethodDependencyNameChange()}computeExpression(){if(this._manager&&this.active())return this._manager.computeFunction()}async computeExpressionForEntities(e,t){var r;this._setEntities(e,t),await this.computeExpression();const s=(r=this._manager)==null?void 0:r.errorMessage();s&&this.param.node.states.error.set(`expression evaluation error: ${s}`),this._resetEntities()}computeExpressionForPoints(e,t){return this.computeExpressionForEntities(e,t)}computeExpressionForVertices(e,t){return this.computeExpressionForEntities(e,t)}computeExpressionForPrimitives(e,t){return this.computeExpressionForEntities(e,t)}computeExpressionForObjects(e,t){return this.computeExpressionForEntities(e,t)}computeExpressionForCoreGroup(e,t){return this.computeExpressionForEntities([e],t)}entities(){return this._entities}entityCallback(){return this._entityCallback}_setEntities(e,t){this._entities=e,this._entityCallback=t}_resetEntities(){this._entities=void 0,this._entityCallback=void 0}}class Bp extends Yi{isNumeric(){return!0}isDefault(){return this._raw_input==this._default_value}_prefilterInvalidRawInput(e){return _t(e)?e[0]:e}processRawInput(){const e=this.convert(this._raw_input);if(e!=null){this._expression_controller&&(this._expression_controller.setExpression(void 0,!1),this.emitController.emit(Cn.EXPRESSION_UPDATED));const t=this.states.error.active();this.states.error.clear(),(e!=this._value||t)&&(this._updateValue(e),this.setSuccessorsDirty(this))}else Ke(this._raw_input)?(this.states.error.clear(),this._expression_controller=this._expression_controller||new fR(this),this._raw_input!=this._expression_controller.expression()&&(this._expression_controller.setExpression(this._raw_input),this.emitController.emit(Cn.EXPRESSION_UPDATED))):this.states.error.set(`param input is invalid (${this.path()})`)}async processComputation(){var e;if((e=this.expressionController)!=null&&e.active()&&!this.expressionController.entitiesDependent()){const t=await this.expressionController.computeExpression();if(this.expressionController.isErrored())this.states.error.set(`expression error: "${this.expressionController.expression()}" (${this.expressionController.errorMessage()})`);else{const r=this.convert(t);r!=null?(this.states.error.active()&&this.states.error.clear(),this._updateValue(r)):this.states.error.set(`expression returns an invalid type (${t}) (${this.expressionController.expression()})`)}}}_updateValue(e){this._value=e;const t=this.parentParam();t&&t.setValueFromComponents(),this.options.executeCallback(),this.emitController.emit(Cn.VALUE_UPDATED),this.removeDirtyState()}}class Gp{constructor(){this._index=-1,this._pathElements=[],this._namedNodes=[],this._graphNodeIds=[],this._nodeElementByGraphNodeId=new Map,this._absolutePath="/"}reset(){this._index=-1,this._pathElements=[],this._namedNodes=[],this._graphNodeIds=[],this._nodeElementByGraphNodeId.clear()}addNamedNode(e){this._index+=1,e.name==e.node.name()&&(this._namedNodes[this._index]=e),this._graphNodeIds[this._index]=e.node.graphNodeId(),this._nodeElementByGraphNodeId.set(e.node.graphNodeId(),e.name),this._absolutePath=[this._absolutePath,e.name].join(bt.SEPARATOR)}addPathElement(e){this._index+=1,this._pathElements[this._index]=e,e.node&&(this._absolutePath=e.node.path())}namedGraphNodes(){return this._namedNodes}namedNodes(e){e.length=0;for(const t of this._namedNodes)if(t){const r=t.node;r.nameController&&e.push(r)}return e}updateFromNameChange(e){this._namedNodes.map(r=>r==null?void 0:r.node.graphNodeId()).includes(e.graphNodeId())&&this._nodeElementByGraphNodeId.set(e.graphNodeId(),e.name())}toPath(){const e=new Array(this._index);for(let s=0;s<=this._index;s++){const i=this._namedNodes[s];if(i){const o=this._nodeElementByGraphNodeId.get(i.node.graphNodeId());o&&(e[s]=o)}else{const o=this._pathElements[s];o&&(e[s]=o.path)}}let t=e.join(bt.SEPARATOR);const r=t[0];return r&&(bt.NON_LETTER_PREFIXES.includes(r)||(t=`${bt.SEPARATOR}${t}`)),t}toAbsolutePath(){return this._absolutePath}}class mR extends Yi{expressionParsedAsString(){return!0}processRawInput(){LM(this._raw_input).length>=3?(this._expression_controller=this._expression_controller||new fR(this),this._raw_input!=this._expression_controller.expression()&&(this.states.error.clear(),this._expression_controller.setExpression(this._raw_input,!1),this.setDirty(),this.emitController.emit(Cn.EXPRESSION_UPDATED))):this.processRawInputWithoutExpression()}async processComputation(){var e;if((e=this.expressionController)!=null&&e.active()&&!this.expressionController.entitiesDependent()){const t=await this.expressionController.computeExpression();if(this.expressionController.isErrored())this.states.error.set(`expression error: "${this.expressionController.expression()}" (${this.expressionController.errorMessage()})`);else{const r=this.convert(t);r!=null?(this.states.error.clear(),this._assignValue(r),this.emitController.emit(Cn.VALUE_UPDATED),this.options.executeCallback()):this.states.error.set(`expression returns an invalid type (${t})`),this.removeDirtyState()}}}}class _R extends mR{constructor(){super(...arguments),this.decomposedPath=new Gp}dispose(){this.scene().referencesController.resetReferenceFromParam(this),super.dispose()}_handleReferences(e,t){t!=""&&(this.scene().referencesController.setNamedNodesFromParam(this),e?(this.scene().referencesController.setReferenceFromParam(this,e),this.scene().missingExpressionReferencesController.deregisterParam(this)):this.scene().missingExpressionReferencesController.register(this,t))}async processComputation(){var e;(e=this.expressionController)!=null&&e.active()&&!this.expressionController.entitiesDependent()?await super.processComputation():this._findTarget()}processRawInputWithoutExpression(){const e=this.states.error.active();(this._value.path()!=this._raw_input||this._expression_controller||e)&&(this._setValuePathAndFindTarget(this._raw_input,!0),this.states.error.clear(),this.emitController.emit(Cn.VALUE_UPDATED),this.options.executeCallback(),this._expression_controller&&(this._expression_controller.setExpression(void 0,!1),this._expression_controller=void 0,this.emitController.emit(Cn.EXPRESSION_UPDATED)))}_setValuePathAndFindTarget(e,t){this._value.setPath(e),this._findTarget(),t&&this.setDirty(),this.emitController.emit(Cn.VALUE_UPDATED)}}const $C=new Zr;class Bv extends _R{static type(){return J.NODE_PATH}_initializeParam(){this._value=new Zr}defaultValueSerialized(){return this._default_value}rawInputSerialized(){return`${this._raw_input}`}valueSerialized(){return`${this.value}`}_copyValue(e){this.set(e.valueSerialized())}static areRawInputEqual(e,t){return e==t}static areValuesEqual(e,t){return e==t}isDefault(){return this._raw_input==this._default_value}setNode(e,t){if((t==null?void 0:t.relative)==!0){const r=bt.relativePath(this.node,e);this.set(r)}else this.set(e.path())}_assignValue(e){const t=Ke(e)?e:e.path();this._value.path()!=t&&this._setValuePathAndFindTarget(t,!1)}convert(e){return Ke(e)?($C.setPath(e),$C):null}_findTarget(){if(!this.node)return;const e=this._value.path();let t=null;const r=e!=null&&e!=="";this.scene().referencesController.resetReferenceFromParam(this),this.decomposedPath.reset(),r&&(t=bt.findNode(this.node,e,this.decomposedPath));const s=this._value.node(),i=t;if(i&&i.graphNodeId()==this.node.graphNodeId()){this.states.error.set("param cannot refer to its own node");return}if(this._handleReferences(t,e),(s==null?void 0:s.graphNodeId())!==(i==null?void 0:i.graphNodeId())){const o=this.options.dependentOnFoundNode(),a=this._value.node();a&&o&&this.removeGraphInput(a),t?this._assignFoundNode(t):this._value.setNode(null),this.options.executeCallback()}r&&!t&&this.scene().loadingController.loaded()&&r&&this.states.error.set(`no node found at path '${e}'`),this.removeDirtyState()}_assignFoundNode(e){const t=this.options.dependentOnFoundNode();this._isNodeExpectedContext(e)?this._isNodeExpectedType(e)?(this.states.error.clear(),this._value.setNode(e),t&&this.addGraphInput(e)):this.states.error.set(`node type is ${e.type()} but the params expects one of ${(this._expectedNodeTypes()||[]).join(", ")}`):this.states.error.set(`node context is ${e.context()} but the params expects a ${this._expectedContext()}`)}_expectedContext(){return this.options.nodeSelectionContext()}_isNodeExpectedContext(e){const t=this._expectedContext();return t==null?!0:t==e.context()}_expectedNodeTypes(){return this.options.nodeSelectionTypes()}_isNodeExpectedType(e){const t=this._expectedNodeTypes();return t==null?!0:t==null?void 0:t.includes(e.type())}notifyPathRebuildRequired(e){this.decomposedPath.updateFromNameChange(e);const t=this.decomposedPath.toPath();this.set(t)}notifyTargetParamOwnerParamsUpdated(e){this.setDirty()}}const qC=new vp;class gR extends _R{constructor(){super(...arguments),this._onResolvedParamDisposeBound=this._onResolvedParamDispose.bind(this)}static type(){return J.PARAM_PATH}_initializeParam(){this._value=new vp}defaultValueSerialized(){return this._default_value}rawInputSerialized(){return`${this._raw_input}`}valueSerialized(){return`${this.value}`}_copyValue(e){this.set(e.valueSerialized())}static areRawInputEqual(e,t){return e==t}static areValuesEqual(e,t){return e==t}isDefault(){return this._raw_input==this._default_value}setParam(e){this.set(e.path())}_assignValue(e){const t=Ke(e)?e:e.path();this._value.path()!=t&&this._setValuePathAndFindTarget(t,!1)}convert(e){return Ke(e)?(qC.setPath(e),qC):null}_findTarget(){if(!this.node)return;const e=this._value.path();let t=null;const r=e!=null&&e!=="";this.scene().referencesController.resetReferenceFromParam(this),this.decomposedPath.reset(),r&&(t=bt.findParam(this.node,e,this.decomposedPath));const s=this._value.param(),i=t;if(i&&i.graphNodeId()==this.graphNodeId()){this.states.error.set("param cannot refer to itself");return}if(this._handleReferences(t,e),(s==null?void 0:s.graphNodeId())!==(i==null?void 0:i.graphNodeId())){const o=this.options.dependentOnFoundParam(),a=this._value.param();a&&(o&&this.removeGraphInput(a),a.deregisterOnDispose(this._onResolvedParamDisposeBound)),t?this._assignFoundParam(t):this._value.setParam(null),this.options.executeCallback()}this.removeDirtyState()}_assignFoundParam(e){const t=this.options.dependentOnFoundParam();this._value.setParam(e),t&&this.addGraphInput(e),e.onDispose(this._onResolvedParamDisposeBound)}notifyPathRebuildRequired(e){this.decomposedPath.updateFromNameChange(e);const t=this.decomposedPath.toPath();this.set(t)}notifyTargetParamOwnerParamsUpdated(e){this.setDirty()}async _onResolvedParamDispose(){this.setDirty(),await this.compute()}}class Gv extends mR{static type(){return J.STRING}defaultValueSerialized(){return this._default_value}_cloneRawInput(e){return`${e}`}rawInputSerialized(){return`${this._raw_input}`}valueSerialized(){return`${this.value}`}_copyValue(e){this.set(e.value)}static areRawInputEqual(e,t){return e==t}static areValuesEqual(e,t){return e==t}isDefault(){return this._raw_input==this._default_value}convert(e){return Ke(e)?e:`${e}`}rawInput(){return this._raw_input}_assignValue(e){this._value=e}async processRawInputWithoutExpression(){const e=this.states.error.active();(this._raw_input!=this._value||this._expression_controller||e)&&(this._assignValue(this._raw_input),this.states.error.clear(),this.removeDirtyState(),this.setSuccessorsDirty(this),this.emitController.emit(Cn.VALUE_UPDATED),this.options.executeCallback(),this._expression_controller&&(this._expression_controller.setExpression(void 0,!1),this._expression_controller=void 0,this.emitController.emit(Cn.EXPRESSION_UPDATED)))}}class jj extends DM{async nodes_data(e){var t;return e.showPolyNodesData||!((t=this._node.polyNodeController)!=null&&t.locked())?await super.nodes_data(e):{}}uiData(e){var t;return e.showPolyNodesData||!((t=this._node.polyNodeController)!=null&&t.locked())?super.uiData(e):this.ui_data_without_children()}async persistedConfigData(e,t,r){var s;if(r.showPolyNodesData||!((s=this._node.polyNodeController)!=null&&s.locked()))return await super.persistedConfigData(e,t,r)}}class Wj{dispatchNode(e){return e.polyNodeController?new jj(e,this):new DM(e,this)}dispatchParam(e){return e instanceof Bp?new xz(e):e instanceof Bv?new bz(e):e instanceof gR?new Cz(e):e instanceof Gv?new Ez(e):e instanceof vs?new Sz(e):new Sc(e)}}const Xj=["overriden_options","type"];class vR{constructor(e,t,r){this._node=e,this.dispatcher=t,this.nodesImporter=r}process_data(e,t){if(this._node.sceneReadonly()&&e.report.markAsLoadedWithoutAssemblers(),this.set_connection_points(t.connection_points),this._node.childrenAllowed()&&this.create_nodes(e,t.nodes,t),this._node.io.inputs.overrideClonedStateAllowed()){const r=t.cloned_state_overriden;r&&this._node.io.inputs.overrideClonedState(r)}if(this.set_flags(t),this.set_params(t),t.persisted_config){const r=e.shadersData(),s=e.jsFunctionBodiesData();if(r){let i=r[this._node.path()];i||(i={}),t.persisted_config.shaders=i}if(s){const i=s[this._node.path()];i&&(Ke(i),t.persisted_config.functionBody=i)}this.set_persisted_config(t.persisted_config)}this.setCustomData(t)}process_inputs_data(e,t){const r=t.maxInputsCount;if(r!=null){const s=this._node.io.inputs.minCount();this._node.io.inputs.setCount(s,r)}try{this.setInputs(t.inputs)}catch(s){const i=s.message||`failed connecting inputs of node ${t.type}`;e.report.addWarning(i),console.warn(t.inputs)}}process_ui_data(e,t){if(!t||ve.playerMode())return;const r=this._node.uiData,s=t.pos;if(s){const a=new W().fromArray(s);r.setPosition(a)}const i=t.comment;i&&r.setComment(i);const o=t.selection;if(o&&this.set_selection(o),this._node.childrenAllowed()){const a=t.nodes;a&&this.processNodesUiData(e,a)}}create_nodes(e,t,r){t&&this.nodesImporter.process_data(e,t)}set_selection(e){if(this._node.childrenAllowed()&&this._node.childrenController&&e&&e.length>0){const t=[];e.forEach(r=>{const s=this._node.node(r);s&&t.push(s)}),this._node.childrenController.selection.set(t)}}set_flags(e){var t,r,s,i,o,a;const c=e.flags;if(c){const l=c.bypass;l!=null&&((r=(t=this._node.flags)==null?void 0:t.bypass)==null||r.set(l));const u=c.display;u!=null&&((i=(s=this._node.flags)==null?void 0:s.display)==null||i.set(u));const h=c.optimize;h!=null&&((a=(o=this._node.flags)==null?void 0:o.optimize)==null||a.set(h))}}set_connection_points(e){e&&(e.in&&this._node.io.saved_connection_points_data.set_in(e.in),e.out&&this._node.io.saved_connection_points_data.set_out(e.out),this._node.io.has_connection_points_controller&&this._node.io.connection_points.update_signature_if_required())}setInputs(e){if(!e)return;let t;for(let r=0;r<e.length;r++)if(t=e[r],t&&this._node.parent())if(Ke(t)){const s=t,i=this._node.nodeSibling(s);this._node.setInput(r,i)}else{const s=this._node.nodeSibling(t.node);let i=t.index;const o=t.inputName;let a=t.output;if(o!=null){const c=this._node.io.inputs.namedInputConnectionPoints();if(c){const l=c.map(u=>u==null?void 0:u.name().toLowerCase()).indexOf(o.toLowerCase());l>=0&&(i=l)}}if(s!=null&&a!=null){const c=s.io.outputs.namedOutputConnectionPoints();if(c)for(let l of c)l&&l.name().toLowerCase()==a.toLowerCase()&&(a=l.name())}i!=null&&this._node.setInput(i,s,a)}}processNodesUiData(e,t){if(!t||ve.playerMode())return;const r=Object.keys(t);for(let s of r){const i=this._node.node(s);if(i){const o=t[s];this.dispatcher.dispatchNode(i).process_ui_data(e,o)}}}set_params(e){const t=e.params;if(!t)return;const r=Object.keys(t),s={};for(let a of r){const c=t[a];if(c!=null){const l=c.options;let u=c.type;const h=this._node.params.has_param(a);let d=!1,p;h&&(p=this._node.params.get(a),(p&&p.type()==u||u==null)&&(d=!0)),d?this._is_param_data_complex(c)?this._process_param_data_complex(a,c):this._process_param_data_simple(a,c):(s.namesToDelete=s.namesToDelete||[],s.namesToDelete.push(a),s.toAdd=s.toAdd||[],s.toAdd.push({name:a,type:u,initValue:c.default_value,rawInput:c.raw_input,options:l}))}}const i=s.namesToDelete&&s.namesToDelete.length>0,o=s.toAdd&&s.toAdd.length>0;if(i||o){this._node.params.updateParams(s);for(let a of this._node.params.spare){const c=t[a.name()];!a.parentParam()&&c&&(this._is_param_data_complex(c)?this._process_param_data_complex(a.name(),c):this._process_param_data_simple(a.name(),c))}}this._node.params.runOnSceneLoadHooks()}_process_param_data_simple(e,t){var r;(r=this._node.params.get(e))==null||r.set(t)}_process_param_data_complex(e,t){const r=this._node.params.get(e);r&&this.dispatcher.dispatchParam(r).process_data(t)}_is_param_data_complex(e){if(Ke(e)||Ye(e)||_t(e)||mr(e))return!1;if(Bd(e)){const t=Object.keys(e);for(let r of Xj)if(t.includes(r))return!0}return!1}set_persisted_config(e){this._node.persisted_config&&this._node.persisted_config.load(e)}setCustomData(e){}}class jo{constructor(e){this._param=e}process_data(e){const t=e.raw_input;t!==void 0&&this._param.set(t),this.add_main(e)}add_main(e){}static spare_params_data(e){return this.params_data(!0,e)}static non_spare_params_data_value(e){return this.params_data_value(!1,e)}static params_data(e,t){let r;if(t){r={};const s=Object.keys(t);let i;for(let o of s)i=t[o],i&&(r[o]=t)}return r}static params_data_value(e,t){let r;if(t){r={};const s=Object.keys(t);let i;for(let o of s)if(i=t[o],i!=null){const a=i.options,c=i.overriden_options;if(a||c){const l=i;a&&a.spare==e?l.raw_input!=null&&(r[o]={complex_data:l}):c&&(r[o]={complex_data:l})}else{const l=i;(c||l!=null)&&(r[o]={simple_data:l})}}}return r}}class $j extends jo{add_main(e){}}const qj=/\\n+/g;class Yj extends jo{add_main(e){let t=e.raw_input;t!==void 0&&(t=t.replace(qj,`
`),this._param.set(t))}}class Kj extends jo{add_main(e){const t=e.raw_input;t&&this._param.set(t)}}class Vp extends Bp{static type(){return J.FLOAT}defaultValueSerialized(){return this._default_value}rawInputSerialized(){return this._raw_input}valueSerialized(){return this.value}_copyValue(e){this.set(e.valueSerialized())}_prefilterInvalidRawInput(e){if(_t(e))return e[0];if(Ke(e)&&yt.isNumber(e)){const t=parseFloat(e);if(t!=null){const r=this.convert(t);if(r!=null)return r}}if(Ye(e)){const t=this.convert(e);if(t!=null)return t}return e}static areRawInputEqual(e,t){return e==t}static areValuesEqual(e,t){return e==t}static convert(e){if(Ye(e))return e;if(mr(e))return e?1:0;if(yt.isNumber(e)){const t=parseFloat(e);if(Ye(t))return t}return null}convert(e){const t=Vp.convert(e);return t!=null?this.options.ensureInRange(t):t}}class Au extends Yi{constructor(){super(...arguments),this._components_contructor=Vp,this._componentsCount=0}get components(){return this._components}isNumeric(){return!0}isDefault(){for(const e of this.components)if(!e.isDefault())return!1;return!0}rawInput(){return this._components.map(e=>e.rawInput())}rawInputSerialized(){return this._components.map(e=>e.rawInputSerialized())}_copyValue(e){for(let t=0;t<this.components.length;t++){const r=this.components[t],s=e.components[t];r.copyValue(s)}}initComponents(){var e;if(this._components!=null)return;let t=0;this._components=new Array(this.componentNames().length);for(const r of this.componentNames()){const s=new this._components_contructor(this.scene(),this.node,{serializerClass:(e=this._serializer)==null?void 0:e.constructor});let i;_t(this._default_value)?i=this._default_value[t]:i=this._default_value[r],s.options.copy(this.options),s.setInitValue(i),s.setName(`${this.name()}${r}`),s.set_parent_param(this),this._components[t]=s,t++}this._componentsCount=this._components.length}async processComputation(){await this.computeComponents(),this.setValueFromComponents()}hasExpression(){var e;for(const t of this.components)if((e=t.expressionController)!=null&&e.active())return!0;return!1}async computeComponents(){const e=this.components;for(const t of e)t.isDirty()&&await t.compute();this.removeDirtyState()}_prefilterInvalidRawInput(e){if(_t(e))return e;{const t=e;return this.componentNames().map(()=>t)}}processRawInput(){const e=this.scene().cooker;e.block();const t=this.components;for(const i of t)i.emitController.blockParentEmit();const r=this._raw_input;let s=0;if(_t(r))for(let i=0;i<this._componentsCount;i++){let o=r[i];o==null&&(o=s),t[i].set(o),s=o}else for(let i=0;i<this._componentsCount;i++){const o=this.componentNames()[i];let a=r[o];a==null&&(a=s),t[i].set(a),s=a}e.unblock();for(const i of this.components)i.emitController.unblockParentEmit();this.emitController.emit(Cn.VALUE_UPDATED)}}class Zj extends vR{create_nodes(e,t,r){const i=this._node.polyNodeController;i.setLockedState(!1),this._isDataLocked(r)?i.createChildNodesFromDefinition():super.create_nodes(e,t,r)}setCustomData(e){this._node.polyNodeController&&this._node.polyNodeController.setLockedState(this._isDataLocked(e))}_isDataLocked(e){return e.polyNode?e.polyNode.locked:!1}}class Ai{constructor(e){this._node=e,this._nodes=[],this._optimized_root_node_names=new Set,this._operation_containers_by_name=new Map,this._node_inputs=[]}nodes(){return this._nodes}process_data(e,t){var r,s,i;if(!t||!(this._node.childrenAllowed()&&this._node.childrenController))return;const{optimized_names:o}=Ai.child_names_by_optimized_state(t);this._nodes=[],this._optimized_root_node_names=new Set;for(let a of o)Ai.is_optimized_root_node(t,a)&&this._optimized_root_node_names.add(a);for(let a of this._optimized_root_node_names){const c=t[a],l={nodeName:a},u=this._node.createNode(q4,l);if(u){this._nodes.push(u),(r=c.flags)!=null&&r.display&&((i=(s=u.flags)==null?void 0:s.display)==null||i.set(!0));const h=this._createOperationContainer(e,u,c,u.name());u.setOutputOperationContainer(h)}}for(let a of this._nodes){const c=a.outputOperationContainer();if(c){this._node_inputs=[],this._add_optimized_node_inputs(e,a,t,a.name(),c),a.io.inputs.setCount(this._node_inputs.length);for(let l=0;l<this._node_inputs.length;l++)a.setInput(l,this._node_inputs[l])}}}_add_optimized_node_inputs(e,t,r,s,i){var o;const a=r[s],c=a.inputs;if(c){for(let l of c)if(Ke(l)){const u=r[l];if(u)if(Ai.is_node_optimized(u)&&!this._optimized_root_node_names.has(l)){let h=this._operation_containers_by_name.get(l);h||(h=this._createOperationContainer(e,t,u,l),h&&this._add_optimized_node_inputs(e,t,r,l,h)),i.addInput(h)}else{const h=(o=t.parent())==null?void 0:o.node(l);if(h){this._node_inputs.push(h);const d=this._node_inputs.length-1;t.addInputConfig(i,{operation_input_index:i.currentInputIndex(),node_input_index:d}),i.incrementInputIndex()}}}a.cloned_state_overriden==!0&&i.overrideInputCloneState(a.cloned_state_overriden)}}static child_names_by_optimized_state(e){const t=Object.keys(e),r=[],s=[];for(let i of t){const o=e[i];ve.playerMode()&&this.is_node_optimized(o)?r.push(i):s.push(i)}return{optimized_names:r,non_optimized_names:s}}static is_optimized_root_node_generic(e){return e.outputs_count==0||e.non_optimized_count>0}static is_optimized_root_node(e,t){const r=this.node_outputs(e,t);let s=0;return r.forEach(i=>{const o=e[i];this.is_node_optimized(o)||s++}),this.is_optimized_root_node_generic({outputs_count:r.size,non_optimized_count:s})}static is_optimized_root_node_from_node(e){var t,r,s,i;if(!((r=(t=e.flags)==null?void 0:t.optimize)!=null&&r.active()))return!1;const o=[];e.io.connections.outputConnections(o);const a=o.map(l=>l.nodeDest());let c=0;for(let l of a)(i=(s=l.flags)==null?void 0:s.optimize)!=null&&i.active()||c++;return this.is_optimized_root_node_generic({outputs_count:a.length,non_optimized_count:c})}static node_outputs(e,t){const r=Object.keys(e),s=new Set;for(let i of r)if(i!=t){const a=e[i].inputs;if(a)for(let c of a)Ke(c)&&c==t&&s.add(i)}return s}_createOperationContainer(e,t,r,s){const i=jo.non_spare_params_data_value(r.params),o=Ai.operation_type(r),a={paramsInitValueOverrides:i},c=this._node.createOperationContainer(o,s,a);return c&&(this._operation_containers_by_name.set(s,c),c.pathParamResolveRequired()&&(t.addOperationContainerWithPathParamResolveRequired(c),e.add_operations_composer_node_with_path_param_resolve_required(t))),c}static operation_type(e){return Ai.is_node_bypassed(e)?"null":e.type}static is_node_optimized(e){const t=e.flags;return!!(t&&t.optimize)}static is_node_bypassed(e){const t=e.flags;return!!(t&&t.bypass)}}class YC{constructor(e,t){this._node=e,this.dispatcher=t}process_data(e,t){var r;if(!t||!(this._node.childrenAllowed()&&this._node.childrenController))return;const{optimized_names:s,non_optimized_names:i}=Ai.child_names_by_optimized_state(t),o=[],a=e.migrateHelper();for(let l of i){const u=t[l],h=a?a.migrateNodeType(this._node,u):u.type;a==null||a.migrateParams(this._node,u);const p={paramsInitValueOverrides:jo.non_spare_params_data_value(u.params),nodeName:l},_=(f,m)=>{try{const y=this._node.createNode(f,m);if(y)return y}catch(y){console.error(`error importing node: cannot create with type ${f}`,y)}};let g=_(h,p);if(!g){const f=yt.camelCase(h);g=_(f,p)}if(!g){const f=`${h}Network`;g=_(f,p)}if(g)o.push(g);else{const f=`failed to create node with type '${h}' (in '${this._node.path()}')`;e.report.addWarning(f),ve.warn(f)}}if(s.length>0){const l=new Ai(this._node);if(l.process_data(e,t),this._node.childrenController.context==be.SOP){const u=Object.keys(t);let h;for(let d of u)(r=t[d].flags)!=null&&r.display&&(h=d);if(h){const d=o.map(_=>_.name()),p=l.nodes();for(let _ of p)d.push(_.name());if(!d.includes(h)){const f=`node '${`${this._node.path()}/${h}`}' with display flag has been optimized and does not exist in player mode`;console.error(f)}}}}const c=new Map;for(let l of o)if(t[l.name()]){const h=this.dispatcher.dispatchNode(l);c.set(l.name(),h),h.process_data(e,t[l.name()])}else ve.warn(`possible import error for node ${l.name()}`),ve.log("available names are",Object.keys(t).sort(),t);for(let l of o){const u=c.get(l.name());u&&u.process_inputs_data(e,t[l.name()])}}}class yR{dispatchNode(e){return e.polyNodeController?this._dispatchPolyNode(e):this.dispatchNonPolyNode(e)}_dispatchPolyNode(e){const t=new YC(e,this);return new Zj(e,this,t)}dispatchNonPolyNode(e){const t=new YC(e,this);return new vR(e,this,t)}dispatchParam(e){return e instanceof Au?new $j(e):e instanceof Gv?new Yj(e):e instanceof vs?new Kj(e):new jo(e)}}const xR=class{constructor(n,e){this.node=n,this._definition=e,this._locked=!0}static registerCreatePolyNodeFunctionForContext(n,e){this._createPolyNodeFunctionByContext.set(n,e)}initializeNode(){this._initInputs(),this.node.lifecycle.onAfterCreated(()=>{this.createChildNodesFromDefinition()})}locked(){return this._locked}setLockedState(n){n!=this._locked&&(this._locked=n,this.node.emit(_n.POLY_NODE_LOCK_STATE_UPDATED))}_initInputs(){const n=this._definition.inputs;if(!n)return;const e=n.simple;e&&this.node.io.inputs.setCount(e.min,e.max)}static setupParamsConfig(n,e){if(e.params)for(const t of e.params){const r=t.name,s=t.type,i=t.initValue,o=t.options;n[r]=new Jn(s,i,o)}}createChildNodesFromDefinition(){const n=this._definition.nodes;if(!n)return;const e=this.node.scene().loadingController.loaded();e&&this.node.scene().loadingController.markAsLoading();const t=this.locked();this.setLockedState(!1);const r=new jp({}),i=new yR().dispatchNonPolyNode(this.node),o={type:this.node.type(),polyNode:{locked:!0}};i.create_nodes(r,n,o);const a=this._definition.ui;a&&i.processNodesUiData(r,a),e&&this.node.scene().loadingController.markAsLoaded(),this.setLockedState(t)}static inputsData(n){if(n.io.inputs.hasNamedInputs()){const e=n.io.inputs,t=[],r=e.namedInputConnectionPoints();return r&&Js(r,t),{typed:{types:t.map(s=>({name:s.name(),type:s.type()}))}}}else return{simple:{min:n.io.inputs.minCount(),max:n.io.inputs.maxInputsCount(),names:n.displayedInputNames()}}}static async polyNodeData(n,e){const r=new Wj().dispatchNode(n),s=await r.data({showPolyNodesData:!0}),i=r.uiData({showPolyNodesData:!0}),o=e||this.inputsData(n);return{metadata:{version:{polygonjs:"1"},createdAt:1},nodeContext:n.context(),inputs:o,params:n.params.non_spare.filter(c=>c.parentParam()==null).map(c=>({name:c.name(),type:c.type(),initValue:c.defaultValueSerialized(),rawInput:c.rawInputSerialized(),options:c.options.current()})),nodes:s.nodes,ui:i.nodes}}static _createNodeClass(n,e,t){const r=this._createPolyNodeFunctionByContext.get(n);if(r)return r(e,t,xR)}static createNodeClassAndRegister(n){const{node_context:e,node_type:t,data:r}=n,s=this._createNodeClass(e,t,r);if(s){let i=this._definitionRegister.get(e);i||(i=new Map,this._definitionRegister.set(e,i)),i.set(t,r),ve.registerNode(s,"polyNodes",{polyNode:!0})}else console.warn("failed to create node from definition",e,t,r)}static definition(n,e){var t;return(t=this._definitionRegister.get(n))==null?void 0:t.get(e)}static register(){return this._definitionRegister}};let zp=xR;zp._createPolyNodeFunctionByContext=new Map;zp._definitionRegister=new Map;class Jj{constructor(e){this.actorsManager=e,this._scene=e.scene}runTriggerFromFunctionNode(e,t){this._scene.threejsScene().traverse(r=>{const s=this.actorsManager.objectActorNodeIds(r);s&&s.includes(e.graphNodeId())&&this.actorsManager.triggerEventNode(e,r,t)})}}class Qj{constructor(e){this.actorsManager=e,this._triggeredEvaluatorGeneratorsByMethodName=new Map,this._scene=e.scene}addTriggeredEvaluators(e,t){e.forEach(r=>{fr(this._triggeredEvaluatorGeneratorsByMethodName,t,r)})}runTriggers(){this._triggeredEvaluatorGeneratorsByMethodName.forEach((e,t)=>{e.forEach(r=>{r.traverseEvaluator(s=>{s[t]&&s[t]()})})}),this._triggeredEvaluatorGeneratorsByMethodName.clear()}}var Le=(n=>(n.ANIMATION_MIXER="animationMixer",n.ANIMATION_MIXER_UPDATE="animationMixerUpdate",n.ATTRIBUTE="attribute",n.CODE="code",n.CURSOR="cursor",n.FOR_LOOP="forLoop",n.GEOLOCATION_CURRENT_POSITION="geolocationCurrentPosition",n.GET_INSTANCE_ATTRIBUTE="getInstanceAttribute",n.GET_INSTANCE_PROPERTY="getInstanceProperty",n.GET_OBJECT_ATTRIBUTE="getObjectAttribute",n.GET_OBJECT_PROPERTY="getObjectProperty",n.GET_OBJECT_USER_DATA="getObjectUserData",n.GET_NODE="getNode",n.GET_PARAM="getParam",n.GET_POINT_ATTRIBUTE="getPointAttribute",n.GET_POINT_PROPERTY="getPointProperty",n.GET_PRIMITIVE_ATTRIBUTE="getPrimitiveAttribute",n.GLOBALS="globals",n.GLOBALS_AMBIENT_LIGHT="globalsAmbientLight",n.GLOBALS_AREA_LIGHT="globalsAreaLight",n.GLOBALS_DIRECTIONAL_LIGHT="globalsDirectionalLight",n.GLOBALS_HEMISPHERE_LIGHT="globalsHemisphereLight",n.GLOBALS_POINT_LIGHT="globalsPointLight",n.GLOBALS_SPOT_LIGHT="globalsSpotLight",n.IMPORT_ATTRIBUTE="importAttribute",n.KEYFRAMES="keyframes",n.ON_CHILD_ATTRIBUTE_UPDATE="onChildAttributeUpdate",n.ON_KEY="onKey",n.ON_KEYDOWN="onKeydown",n.ON_KEYPRESS="onKeypress",n.ON_KEYUP="onKeyup",n.ON_MAPBOX_CAMERA_MOVE="onMapboxCameraMove",n.ON_MAPBOX_CAMERA_MOVE_START="onMapboxCameraMoveStart",n.ON_MAPBOX_CAMERA_MOVE_END="onMapboxCameraMoveEnd",n.ON_OBJECT_ATTRIBUTE_UPDATE="onObjectAttributeUpdate",n.ON_OBJECT_BEFORE_DELETE="onObjectBeforeDelete",n.ON_OBJECT_CLICK="onObjectClick",n.ON_OBJECT_CLICK_GPU="onObjectClickGPU",n.ON_OBJECT_CONTEXT_MENU="onObjectContextMenu",n.ON_OBJECT_CONTEXT_MENU_GPU="onObjectContextMenuGPU",n.ON_OBJECT_DOUBLE_CLICK="onObjectDoubleClick",n.ON_OBJECT_DISPATCH_EVENT="onObjectDispatchEvent",n.ON_OBJECT_HOVER="onObjectHover",n.ON_OBJECT_HOVER_GPU="onObjectHoverGPU",n.ON_OBJECT_LONG_PRESS="onObjectLongPress",n.ON_OBJECT_LONG_PRESS_GPU="onObjectLongPressGPU",n.ON_OBJECT_MOUSE_CLICK="onObjectMouseClick",n.ON_OBJECT_POINTERDOWN="onObjectPointerdown",n.ON_OBJECT_POINTERDOWN_GPU="onObjectPointerdownGPU",n.ON_OBJECT_POINTERUP="onObjectPointerup",n.ON_OBJECT_POINTERUP_GPU="onObjectPointerupGPU",n.ON_OBJECT_SWIPE="onObjectSwipe",n.ON_OBJECT_SWIPE_GPU="onObjectSwipeGPU",n.ON_OBJECT_SWIPEDOWN="onObjectSwipedown",n.ON_OBJECT_SWIPELEFT="onObjectSwipeleft",n.ON_OBJECT_SWIPERIGHT="onObjectSwiperight",n.ON_OBJECT_SWIPEUP="onObjectSwipeup",n.ON_POINTERDOWN="onPointerdown",n.ON_POINTERUP="onPointerup",n.ON_SCENE_PAUSE="onScenePause",n.ON_SCENE_PLAY="onScenePlay",n.ON_SCENE_RESET="onSceneReset",n.ON_SCROLL="onScroll",n.ON_MANUAL_TRIGGER="onManualTrigger",n.ON_TICK="onTick",n.ON_PERFORMANCE_CHANGE="onPerformanceChange",n.ON_VIDEO_EVENT="onVideoEvent",n.ON_VIEWER_CONTROLS_EVENT="onViewerControlsEvent",n.ON_WEBXR_CONTROLLER_EVENT="onWebXRControllerEvent",n.OUTPUT="output",n.OUTPUT_AMBIENT_LIGHT="outputAmbientLight",n.OUTPUT_AREA_LIGHT="outputAreaLight",n.OUTPUT_DIRECTIONAL_LIGHT="outputDirectionalLight",n.OUTPUT_HEMISPHERE_LIGHT="outputHemisphereLight",n.OUTPUT_POINT_LIGHT="outputPointLight",n.OUTPUT_SPOT_LIGHT="outputSpotLight",n.PARAM="param",n.RAY_FROM_CURSOR="rayFromCursor",n.RAY_FROM_CAMERA="rayFromCamera",n.SDF_2D_BOX="SDF2DBox",n.SDF_2D_CIRCLE="SDF2DCircle",n.SDF_2D_CROSS="SDF2DCross",n.SDF_2D_HEART="SDF2DHeart",n.SDF_2D_ROUNDED_X="SDF2DRoundedX",n.SDF_BOX="SDFBox",n.SDF_ELONGATE="SDFElongate",n.SDF_ONION="SDFOnion",n.SDF_PLANE="SDFPlane",n.SDF_REVOLUTION="SDFRevolution",n.SDF_SPHERE="SDFSphere",n.SDF_TORUS="SDFTorus",n.SDF_TRANSFORM="SDFTransform",n.SDF_TUBE="SDFTube",n.SET_INSTANCE_ATTRIBUTE="setInstanceAttribute",n.SET_INSTANCE_LOOK_AT="setInstanceLookAt",n.SET_INSTANCE_POSITION="setInstancePosition",n.SET_INSTANCE_QUATERNION="setInstanceQuaternion",n.SET_INSTANCE_SCALE="setInstanceScale",n.SET_OBJECT_ATTRIBUTE="setObjectAttribute",n.SET_OBJECT_LOOK_AT="setObjectLookAt",n.SET_OBJECT_POSITION="setObjectPosition",n.SET_OBJECT_QUATERNION="setObjectQuaternion",n.SET_OBJECT_ROTATION="setObjectRotation",n.SET_OBJECT_SCALE="setObjectScale",n.SET_PARAM="setParam",n.SET_PHYSICS_RBD_POSITION="setPhysicsRBDPosition",n.SET_PLAYER_INPUT="setPlayerInput",n.SET_POINT_ATTRIBUTE="setPointAttribute",n.SET_POINT_POSITION="setPointPosition",n.SET_SOFT_BODY_CONSTRAINT_POSITION="setSoftBodyConstraintPosition",n.SET_SOFT_BODY_POSITION="setSoftBodyPosition",n.SET_SOFT_BODY_VELOCITY="setSoftBodyVelocity",n.SET_WFC_SOFT_CONSTRAINT="setWFCSoftConstraint",n.WFC_BUILD="WFCBuild",n))(Le||{});class eW{constructor(e){this.node=e,this._watchStopHandles=[],this.scene=e.scene(),this.timeController=this.scene.timeController}onDispose(e){this._onDisposeCallbacks=this._onDisposeCallbacks||[],this._onDisposeCallbacks.push(e)}dispose(){const e=()=>{if(!this._watchStopHandles)return;let r;for(;r=this._watchStopHandles.pop();)r()};(()=>{if(!this._onDisposeCallbacks)return;let r;for(;r=this._onDisposeCallbacks.pop();)r()})(),e()}}const bR=[Le.ON_KEY,Le.ON_KEYDOWN,Le.ON_KEYPRESS,Le.ON_KEYUP,Le.ON_MAPBOX_CAMERA_MOVE,Le.ON_MAPBOX_CAMERA_MOVE_START,Le.ON_MAPBOX_CAMERA_MOVE_END,Le.ON_OBJECT_ATTRIBUTE_UPDATE,Le.ON_OBJECT_DISPATCH_EVENT,Le.ON_PERFORMANCE_CHANGE,Le.ON_POINTERDOWN,"onPointermove",Le.ON_POINTERUP,Le.ON_SCENE_PAUSE,Le.ON_SCENE_PLAY,Le.ON_SCENE_RESET,Le.ON_TICK,Le.ON_VIDEO_EVENT,Le.ON_WEBXR_CONTROLLER_EVENT];class CR extends eW{constructor(e,t){super(e),this.node=e,this.object3D=t}}class tW{constructor(e,t=0,r=0){this.node=e,this._position=new W,this._width=50,this._color=new xe(.75,.75,.75),this._layoutVertical=!0,this._json={x:0,y:0},this._position.x=t,this._position.y=r}dispose(){this._comment=void 0}setComment(e){this._comment=e,this.node.emit(_n.UI_DATA_COMMENT_UPDATED)}comment(){return this._comment}setColor(e){this._color=e}color(){return this._color}setLayoutHorizontal(){this._layoutVertical=!1}isLayoutVertical(){return this._layoutVertical}copy(e){this._position.copy(e.position()),this._color.copy(e.color())}position(){return this._position}setPosition(e,t=0){if(Ye(e)){const r=e;this._position.set(r,t)}else this._position.copy(e);return this.node.emit(_n.UI_DATA_POSITION_UPDATED),this}translate(e,t=!1){return this._position.add(e),t&&(this._position.x=Math.round(this._position.x),this._position.y=Math.round(this._position.y)),this.node.emit(_n.UI_DATA_POSITION_UPDATED),this}toJSON(){return this._json.x=this._position.x,this._json.y=this._position.y,this._json.comment=this._comment,this._json}}class Vv{constructor(e){this.node=e,this._state=!0,this._hooks=null}onUpdate(e){this._hooks=this._hooks||[],this._hooks.push(e)}_onUpdate(){}set(e){if(this._state!=e){if(this.node.insideALockedParent()){const t=this.node.lockedParent();console.warn(`node '${this.node.path()}' cannot have its flag changed, since it is inside '${t?t.path():""}', which is locked`);return}this._state=e,this._onUpdate(),this.runHooks()}}active(){return this._state}toggle(){this.set(!this._state)}runHooks(){if(this._hooks)for(const e of this._hooks)e()}}class nW extends Vv{constructor(){super(...arguments),this._state=!1}_onUpdate(){this.node.emit(_n.FLAG_BYPASS_UPDATED),this.node.setDirty()}}class rW extends Vv{_onUpdate(){this.node.emit(_n.FLAG_DISPLAY_UPDATED)}}class sW extends Vv{constructor(){super(...arguments),this._state=!1}_onUpdate(){this.node.emit(_n.FLAG_OPTIMIZE_UPDATED)}}class zv{constructor(e){this.node=e}hasDisplay(){return!1}hasBypass(){return!1}hasOptimize(){return!1}}function ER(n){return class extends n{constructor(){super(...arguments),this.display=new rW(this.node)}hasDisplay(){return!0}}}function iW(n){return class extends n{constructor(){super(...arguments),this.bypass=new nW(this.node)}hasBypass(){return!0}}}function oW(n){return class extends n{constructor(){super(...arguments),this.optimize=new sW(this.node)}hasOptimize(){return!0}}}class aW extends ER(zv){}class cW extends oW(iW(ER(zv))){}class SR{constructor(e){this.node=e}}class lW extends SR{active(){return this.paramsTimeDependent()||this.inputsTimeDependent()}paramsTimeDependent(){const e=this.node.params.names;for(const t of e){const r=this.node.params.get(t);if(r&&r.states.timeDependent.active())return!0}return!1}inputsTimeDependent(){const e=this.node.io.inputs.inputs();for(const t of e)if(t&&t.states.timeDependent.active())return!0;return!1}forceTimeDependent(){const e=this.node.graphPredecessorIds(),t=this.node.scene().timeController.graphNode;(e==null||!e.includes(t.graphNodeId()))&&this.node.addGraphInput(t,!1)}unforceTimeDependent(){const e=this.node.scene().timeController.graphNode;this.node.removeGraphInput(e)}}class uW extends SR{set(e){this._message!=e&&(e?ve.error(`[${this.node.path()}] error: '${e}' (from '${this._message}')`):ve.warn(`[${this.node.path()}] clear error`),this._message=e,this.onUpdate())}message(){return this._message}clear(){this.set(void 0)}active(){return this._message!=null}onUpdate(){this._message!=null&&this.node._setContainer(null),this.node.emit(_n.ERROR_UPDATED)}}class hW{constructor(e){this.node=e,this.timeDependent=new lW(this.node),this.error=new uW(this.node)}}class dW{constructor(e){this.node=e,this._parent=null}parent(){return this._parent}setParent(e){e!=this.node.parentController.parent()&&(this._parent=e,this._parent&&this.node.nameController.requestNameToParent(this.node.name()))}firstAncestorWithContext(e){return this._parent?this._parent.context()==e?this._parent:this._parent.parentController.firstAncestorWithContext(e):null}findParent(e){return this._parent?e(this._parent)==!0?this._parent:this._parent.parentController.findParent(e):null}path(e){const t=bt.SEPARATOR;if(this._parent!=null){if(this._parent==e)return this.node.name();{const r=this._parent.path(e);return r===t?r+this.node.name():r+t+this.node.name()}}else return t}onSetParent(){if(this._on_set_parent_hooks)for(const e of this._on_set_parent_hooks)e()}findNode(e){if(e==null)return null;if(e==bt.CURRENT||e==bt.CURRENT_WITH_SLASH)return this.node;if(e==bt.PARENT||e==bt.PARENT_WITH_SLASH)return this.node.parent();const t=bt.SEPARATOR;if(e===t)return this.node.scene().root();if(e[0]===t)return e=e.substring(1,e.length),this.node.scene().root().node(e);if(e.split){const r=e.split(t);if(r.length===1){const s=r[0];return this.node.childrenController?this.node.childrenController.childByName(s):null}else return bt.findNode(this.node,e)}else return console.error("unexpected path given:",e),null}}const Kc=[],ro=[];class pW{constructor(e){this._node=e,this._nodeIds=[]}node(){return this._node}nodeIds(){return this._nodeIds}nodeFromIndex(e){return this._node.scene().graph.nodesFromIds(this._nodeIds,Kc),Kc[e]}nodes(e){return this._node.scene().graph.nodesFromIds(this._nodeIds,e),e}contains(e){return this._nodeIds.includes(e.graphNodeId())}equals(e){return zf(e,t=>t.graphNodeId(),ro),ro.sort(),nM(ro,this._nodeIds)}clear(){this._nodeIds.length=0,this._sendUpdateEvent()}set(e){this._nodeIds.length=0,this.add(e)}add(e){zf(e,t=>t.graphNodeId(),ro),jk(this._nodeIds,ro,this._nodeIds),this._sendUpdateEvent()}remove(e){zf(e,t=>t.graphNodeId(),ro),tM(this._nodeIds,ro,this._nodeIds),this._sendUpdateEvent()}_checkValidity(){if(this.nodes(Kc),Kc.length!=this._nodeIds.length){console.error("selection invalid: at least one node is not part of the graph");return}for(const e of Kc)e.parent()!=this._node&&console.error("selection invalid: at least one node is not has another parent")}_sendUpdateEvent(){this._checkValidity(),this._node.emit(_n.SELECTION_UPDATED)}toJSON(e){Ts(this._nodeIds,e)}}var Mt=(n=>(n.ALWAYS="always",n.NEVER="never",n.FROM_NODE="from_node",n))(Mt||{});let fW=class{constructor(e){this.inputs_controller=e,this._clone_required_states=[],this._overridden=!1}initInputsClonedState(e){_t(e)?this._cloned_states=e:this._cloned_state=e,this._update_clone_required_state()}override_cloned_state_allowed(){if(this._cloned_states){for(let e of this._cloned_states)if(e==Mt.FROM_NODE)return!0}return this._cloned_state?this._cloned_state==Mt.FROM_NODE:!1}clone_required_state(e){return this._clone_required_states[e]}clone_required_states(){return this._clone_required_states}_get_clone_required_state(e){const t=this._cloned_states;if(t){const r=t[e];if(r!=null)return this.clone_required_from_state(r)}return this._cloned_state?this.clone_required_from_state(this._cloned_state):!0}clone_required_from_state(e){switch(e){case Mt.ALWAYS:return!0;case Mt.NEVER:return!1;case Mt.FROM_NODE:return!this._overridden}return St.unreachable(e)}override_cloned_state(e){this._overridden=e,this._update_clone_required_state()}overriden(){return this._overridden}_update_clone_required_state(){if(this._cloned_states){const e=[];for(let t=0;t<this._cloned_states.length;t++)e[t]=this._get_clone_required_state(t);this._clone_required_states=e;return}if(this._cloned_state){const e=this.inputs_controller.inputsCount(),t=[];for(let r=0;r<e;r++)t[r]=this._get_clone_required_state(r);this._clone_required_states=t;return}}};class mW{constructor(e){this.operationContainer=e}inputsCount(){return this.operationContainer.inputsCount()}initInputsClonedState(e){this._clonedStatesController||(this._clonedStatesController=new fW(this),this._clonedStatesController.initInputsClonedState(e))}cloneRequired(e){var t;const r=(t=this._clonedStatesController)==null?void 0:t.clone_required_state(e);return r??!0}override_cloned_state(e){var t;(t=this._clonedStatesController)==null||t.override_cloned_state(e)}}class _W{constructor(e,t,r){this.operation=e,this.name=t,this.params={},this._applyDefaultParams(),this._applyInitParams(r),this._initClonedStates()}pathParamResolveRequired(){return this._path_params!=null}resolvePathParams(e){if(this._path_params)for(let t of this._path_params)t.resolve(e)}_applyDefaultParams(){const e=this.operation.constructor.DEFAULT_PARAMS,t=Object.keys(e);for(let r of t){const s=e[r],i=this._convertParamData(r,s);i!=null&&(this.params[r]=i)}}_applyInitParams(e){const t=Object.keys(e);for(let r of t){const s=e[r];if(s.simple_data!=null){const i=s.simple_data,o=this.operation.convertExportParamData({paramName:r,paramData:i,params:this.params});o!=null&&(this.params[r]=o)}}}_convertParamData(e,t){if(Ye(t)||mr(t)||Ke(t))return t;if(t instanceof Zr){const r=t.clone();return this._path_params||(this._path_params=[]),this._path_params.push(r),r}if(t instanceof xe||t instanceof W||t instanceof T||t instanceof We)return t.clone()}setInput(e,t){this._inputs=this._inputs||[],this._inputs[e]=t}inputsCount(){return this._inputs?this._inputs.length:0}inputsController(){return this._inputsController=this._inputsController||new mW(this)}_initClonedStates(){const e=this.operation.constructor.INPUT_CLONED_STATE;this.inputsController().initInputsClonedState(e)}inputCloneRequired(e){return this._inputsController?this._inputsController.cloneRequired(e):!0}overrideInputCloneState(e){this.inputsController().override_cloned_state(e)}cook(e){return this.operation.cook(e,this.params)}}class gW extends _W{constructor(e,t,r){super(e,t,r),this.operation=e,this.name=t,this.init_params=r,this._inputs=[],this._currentInputIndex=0,this._dirty=!0}operationType(){return this.operation.type()}addInput(e){super.setInput(this._currentInputIndex,e),this.incrementInputIndex()}incrementInputIndex(){this._currentInputIndex++}currentInputIndex(){return this._currentInputIndex}setDirty(){if(!this._dirty){this._computeResult=void 0;for(let e=0;e<this._inputs.length;e++)this._inputs[e].setDirty()}}async compute(e,t){if(this._computeResult)return this._computeResult;const r=[],s=t.get(this);s&&s.forEach((o,a)=>{r[a]=e[o]});for(let o=0;o<this._inputs.length;o++){let c=await this._inputs[o].compute(e,t);c&&(this.inputCloneRequired(o)&&(c=c.clone()),r[o]=c)}const i=this.operation.cook(r,this.params);return i?i instanceof Promise?this._computeResult=await i:this._computeResult=i:this._computeResult=void 0,this._dirty=!1,this._computeResult}}class AR{constructor(e){this.node=e,this._graphNode=new _r(e.scene(),"nodeNameController")}dispose(){this._graphNode.dispose(),this._onSetNameHooks=void 0,this._onSetFullPathHooks=void 0}graphNode(){return this._graphNode}static baseName(e){let t=e.type();const r=t[t.length-1];return av(parseInt(r))||(t+="_"),`${t}1`}requestNameToParent(e){const t=this.node.parent();t&&t.childrenAllowed()&&t.childrenController?t.childrenController.setChildName(this.node,e):console.warn("requestNameToParent failed, no parent found")}setName(e){if(e!=this.node.name()){if(this.node.insideALockedParent()){const t=this.node.lockedParent();console.warn(`node '${this.node.path()}' cannot have its name changed, since it is inside '${t?t.path():""}', which is locked`);return}this.requestNameToParent(e)}}updateNameFromParent(e){var t;if(this.node._setCoreName(e),this._postSetName(),this.runPostSetFullPathHooks(),this.node.childrenAllowed()){const r=(t=this.node.childrenController)==null?void 0:t.children();if(r)for(const s of r)s.nameController.runPostSetFullPathHooks()}this.node.lifecycle.creationCompleted()&&this.node.scene().loadingController.loaded()&&(this.node.scene().missingExpressionReferencesController.checkForMissingNodeReferences(this.node),this.node.scene().expressionsController.regenerateReferringExpressions(this.node)),this.node.scene().referencesController.notifyNameUpdated(this.node),this.node.emit(_n.NAME_UPDATED)}add_post_set_name_hook(e){this._onSetNameHooks=this._onSetNameHooks||[],this._onSetNameHooks.push(e)}add_post_set_fullPath_hook(e){this._onSetFullPathHooks=this._onSetFullPathHooks||[],this._onSetFullPathHooks.push(e)}_postSetName(){if(this._onSetNameHooks)for(const e of this._onSetNameHooks)e()}runPostSetFullPathHooks(){if(this._onSetFullPathHooks)for(const e of this._onSetFullPathHooks)e()}}class vW{constructor(e,t){this.node=e,this._context=t,this._childrenByName=new Map,this._childrenIdByType=new Map,this._childrenByType=new Map,this._childrenAndGrandchildrenByContext=new Map,this._children=[],this._childrenNames=[]}get selection(){return this._selection=this._selection||new pW(this.node)}dispose(){const e=[];Ts(this.children(),e);for(const t of e)this.node.removeNode(t);e.length=0,this._selection=void 0}get context(){return this._context}setOutputNodeFindMethod(e){this._outputNodeFindMethod=e}outputNode(){if(this._outputNodeFindMethod)return this._outputNodeFindMethod()}setChildName(e,t){let r;if(t=yt.sanitizeName(t),(r=this._childrenByName.get(t))!=null)return e.name()===t&&r.graphNodeId()===e.graphNodeId()?void 0:(t=yt.increment(t),this.setChildName(e,t));{const s=e.name();this._childrenByName.get(s)&&this._childrenByName.delete(s),this._childrenByName.set(t,e),this._updateCache(),e.nameController.updateNameFromParent(t),this.node.scene().nodesController.addToInstanciatedNode(e),this.node.scene().graphNodesController.notifyNodePathChanged(e)}}_nextAvailableChildName(e){return e=yt.sanitizeName(e),this._childrenByName.get(e)?this._nextAvailableChildName(yt.increment(e)):e}nodeContextSignature(){return`${this.node.context()}/${this.node.type()}`}availableChildrenClasses(){return ve.registeredNodes(this.node)}isValidChildType(e){return this.availableChildrenClasses()[e]!=null}createNode(e,t){if(typeof e=="string"){const r=this._findNodeClass(e);return this._createAndInitNode(r,t)}else return this._createAndInitNode(e,t)}_createAndInitNode(e,t){var r;const s=(t==null?void 0:t.nodeName)||AR.baseName(e),i=this._nextAvailableChildName(s),o=new e(this.node.scene(),i,{...t,serializerClass:(r=this.node.serializer)==null?void 0:r.constructor});return o.initializeBaseAndNode(),this._addNode(o),o.lifecycle.setCreationCompleted(),o}_findNodeClass(e){const t=this.availableChildrenClasses()[e.toLowerCase()];if(t==null){const r=`child node type '${e}' not found for node '${this.node.path()}'. Available types are: ${Object.keys(this.availableChildrenClasses()).join(", ")}, ${this._context}, ${this.node.type()}`;throw console.error(r),r}return t}createOperationContainer(e,t,r){const s=ve.registeredOperation(this._context,e);if(s==null){const i=`no operation found with context ${this._context}/${e}`;throw console.error(i),i}else{const i=new s(this.node.scene());return new gW(i,t,(r==null?void 0:r.paramsInitValueOverrides)||{})}}_addNode(e){if(e.setParent(this.node),this._addToNodesByType(e),e.params.init(),e.parentController.onSetParent(),e.nameController.runPostSetFullPathHooks(),e.childrenAllowed()&&e.childrenController)for(const t of e.childrenController.children())t.nameController.runPostSetFullPathHooks();if(this.node.serializer){const t=e.toJSON();t&&this.node.emit(_n.CREATED,{child_node_json:t})}return this.node.scene().lifecycleController.onAfterCreatedCallbackAllowed()&&e.lifecycle.runOnAfterCreatedCallbacks(),e.lifecycle.runOnAfterAddedCallbacks(),this.node.lifecycle.runOnChildAddCallbacks(e),e.requireWebGL2()&&this.node.scene().webglController.setRequireWebGL2(),this.node.scene().missingExpressionReferencesController.checkForMissingNodeReferences(e),e}removeNode(e){var t;if(this.node.lockedOrInsideALockedParent()){const r=this.node.selfOrLockedParent(),s=r==this.node?"it is locked":`it is inside '${r?r.path():""}', which is locked`;console.warn(`node '${this.node.path()}' cannot remove nodes, since ${s}`),console.log(this.node.graphNodeId(),this.node.name());return}if(e.parent()!=this.node)return console.warn(`node ${e.name()} not under parent ${this.node.path()}`);{(t=e.polyNodeController)==null||t.setLockedState(!1),e.lifecycle.runOnBeforeDeleteCallbacks(),this.selection.contains(e)&&this.selection.remove([e]);const r=e.io.connections.firstInputConnection(),s=e.io.connections.inputConnections(),i=[];if(e.io.connections.outputConnections(i),s)for(const o of s)o&&o.disconnect({setInput:!0});if(i){for(const o of i)if(o&&(o.disconnect({setInput:!0}),r)){const a=r.nodeSrc(),c=r.outputIndex(),l=o.nodeDest(),u=o.inputIndex();l.io.inputs.setInput(u,a,c)}}e.setParent(null),this._childrenByName.delete(e.name()),this._updateCache(),this._removeFromNodesByType(e),this.node.scene().nodesController.removeFromInstanciatedNode(e),e.setSuccessorsDirty(this.node),e.graphDisconnectSuccessors(),this.node.lifecycle.runOnChildRemoveCallbacks(e),e.lifecycle.runOnDeleteCallbacks(),e.dispose(),e.emit(_n.DELETED,{parent_id:this.node.graphNodeId()}),this.node.scene().graphNodesController.notifyNodePathChanged(e)}}_addToNodesByType(e){const t=e.graphNodeId(),r=e.type();fr(this._childrenIdByType,r,t),dr(this._childrenByType,r,e),this._addToChildrenAndGrandchildrenByContext(e)}_removeFromNodesByType(e){const t=e.graphNodeId(),r=e.type();ab(this._childrenIdByType,r,t),R_(this._childrenByType,r,e),this._removeFromChildrenAndGrandchildrenByContext(e)}_addToChildrenAndGrandchildrenByContext(e){var t;const r=e.graphNodeId(),s=e.context();fr(this._childrenAndGrandchildrenByContext,s,r);const i=this.node.parent();i&&i.childrenAllowed()&&((t=i.childrenController)==null||t._addToChildrenAndGrandchildrenByContext(e))}_removeFromChildrenAndGrandchildrenByContext(e){var t;const r=e.graphNodeId(),s=e.context();ab(this._childrenAndGrandchildrenByContext,s,r);const i=this.node.parent();i&&i.childrenAllowed()&&((t=i.childrenController)==null||t._removeFromChildrenAndGrandchildrenByContext(e))}nodesByType(e,t=[]){const r=this._childrenByType.get(e);if(t.length=r?r.length:0,r)for(let s=0;s<r.length;s++)t[s]=r[s];return t}childByName(e){return this._childrenByName.get(e)||null}hasChildrenAndGrandchildrenWithContext(e){return this._childrenAndGrandchildrenByContext.get(e)!=null}_updateCache(){this._children.length=0,this._childrenNames.length=0,this._childrenByName.forEach(e=>{this._children.push(e),this._childrenNames.push(e.name())})}children(){return this._children}childrenNames(){return this._childrenNames}traverseChildren(e,t){this._childrenByName.forEach(r=>{var s;e(r),(t==null||t(r)==!0)&&((s=r.childrenController)==null||s.traverseChildren(e))})}}class yW{constructor(e){this.node=e,this._creationCompleted=!1}dispose(){this._onChildAddCallbacks=void 0,this._onChildRemoveCallbacks=void 0,this._onAfterCreatedCallbacks=void 0,this._onAfterAddedCallbacks=void 0,this._onBeforeDeletedCallbacks=void 0,this._onAfterDeletedCallbacks=void 0}setCreationCompleted(){this._creationCompleted||(this._creationCompleted=!0)}creationCompleted(){return this.node.scene().loadingController.loaded()&&this._creationCompleted}onChildAdd(e){this._onChildAddCallbacks=this._onChildAddCallbacks||[],this._onChildAddCallbacks.push(e)}runOnChildAddCallbacks(e){this._runCallbacksWithChildNode(this._onChildAddCallbacks,e)}onChildRemove(e){this._onChildRemoveCallbacks=this._onChildRemoveCallbacks||[],this._onChildRemoveCallbacks.push(e)}runOnChildRemoveCallbacks(e){this._runCallbacksWithChildNode(this._onChildRemoveCallbacks,e)}onAfterCreated(e){this._onAfterCreatedCallbacks=this._onAfterCreatedCallbacks||[],this._onAfterCreatedCallbacks.push(e)}runOnAfterCreatedCallbacks(){this._runCallbacks(this._onAfterCreatedCallbacks)}onAfterAdded(e){this._onAfterAddedCallbacks=this._onAfterAddedCallbacks||[],this._onAfterAddedCallbacks.push(e)}runOnAfterAddedCallbacks(){this._runCallbacks(this._onAfterAddedCallbacks)}onBeforeDeleted(e){this._onBeforeDeletedCallbacks=this._onBeforeDeletedCallbacks||[],this._onBeforeDeletedCallbacks.push(e)}runOnBeforeDeleteCallbacks(){this._runCallbacks(this._onBeforeDeletedCallbacks)}onAfterDeleted(e){this._onAfterDeletedCallbacks=this._onAfterDeletedCallbacks||[],this._onAfterDeletedCallbacks.push(e)}runOnDeleteCallbacks(){this._runCallbacks(this._onAfterDeletedCallbacks)}_runCallbacks(e){if(!e)return;let t;for(t of e)t()}_runCallbacksWithChildNode(e,t){if(!e)return;let r;for(r of e)r(t)}}var TR=(n=>(n.NONE="none",n.POWER1="power1",n.POWER2="power2",n.POWER3="power3",n.POWER4="power4",n.BACK="back",n.ELASTIC="elastic",n.BOUNCE="bounce",n.SLOW="slow",n.STEPS="steps",n.CIRC="circ",n.EXPO="expo",n.SINE="sine",n))(TR||{});function Mc(n){const t={duration:n.duration()},r=n.easing()||TR.NONE;r&&(t.ease=r);const s=n.delay();s!=null&&(t.delay=s);const i=n.repeatParams();return i&&(t.repeat=i.count,t.repeatDelay=i.delay,t.yoyo=i.yoyo),t}class Hv{constructor(){this._propertiesMap=new Map}static instance(){return this._instance=this._instance||new Hv}registerProp(e,t){this._propertiesMap.set(this._convert(e),t)}deRegisterProp(e){this._propertiesMap.delete(this._convert(e))}registeredTimelineForProperty(e){return this._propertiesMap.get(this._convert(e))}registeredPropertiesCount(){let e=0;return this._propertiesMap.forEach(()=>{e++}),e}_convert(e){if(e.object){const t=e;return`${t.object.uuid}:${t.propertyName}`}else return e}}const Gh=Hv.instance();function Rc(n){const{timelineBuilder:e,timeline:t,vars:r,target:s,registerableProp:i,registerproperties:o}=n,a=e.position(),c=a?a.toParameter():void 0,l=Gh.registeredTimelineForProperty(i),u=t.to(s,r,c),h=()=>{if(l)if(l.stoppable)l.timeline.kill(),Gh.deRegisterProp(i);else{u.kill();return}o&&Gh.registerProp(i,{timeline:u,stoppable:e.stoppable()})},d=()=>{Gh.deRegisterProp(i)};if(r.onStart){const p=r.onStart;r.onStart=()=>{h(),p()}}else r.onStart=h;if(r.onComplete){const p=r.onComplete;r.onComplete=()=>{d(),p()}}else r.onComplete=d}class xW{constructor(e){this.param=e,this.proxyValue=e.value}update(e){if(e){const t=e.evaluate(this.proxyValue)[0];this.param.set(t)}else this.param.set(this.proxyValue)}}class bW{constructor(e){this.param=e,this.proxyValue=e.value}update(){this.param.set(this.proxyValue)}}class CW{constructor(e){this.param=e,this.proxyValue=new W,this._array=[0,0],this.proxyValue.copy(e.value)}update(){this.proxyValue.toArray(this._array),this.param.set(this._array)}}class EW{constructor(e){this.param=e,this.proxyValue=new T,this._array=[0,0,0],this.proxyValue.copy(e.value)}update(){this.proxyValue.toArray(this._array),this.param.set(this._array)}}class SW{constructor(e){this.param=e,this.proxyValue=new We,this._array=[0,0,0,0],this.proxyValue.copy(e.value)}update(){this.proxyValue.toArray(this._array),this.param.set(this._array)}}class AW{constructor(e){this.param=e,this.proxyValue=new xe,this._array=[0,0,0],this.proxyValue.copy(e.valuePreConversion())}update(){this.proxyValue.toArray(this._array),this.param.set(this._array)}}class TW{constructor(e){this._map=new Map;const t=e.params.all;for(const r of t){const s=this._createParamProxy(r);s&&this._map.set(r,s)}}_createParamProxy(e){switch(e.type()){case J.INTEGER:return new bW(e);case J.FLOAT:return new xW(e);case J.VECTOR2:return new CW(e);case J.VECTOR3:return new EW(e);case J.COLOR:return new AW(e);case J.VECTOR4:return new SW(e)}}getParamProxy(e){return this._map.get(e)}}class jv{constructor(){this._map=new Map}static instance(){return this._instance=this._instance||new jv}nodeProxy(e){const t=this._map.get(e);if(t)return t;const r=new TW(e);return this._map.set(e,r),r}paramProxy(e){return this.nodeProxy(e.node).getParamProxy(e)}}const Tu=jv.instance();var Tl=(n=>(n.SET="set",n.ADD="add",n.SUBTRACT="subtract",n))(Tl||{});function Bn(n,e,t){switch(t){case Tl.SET:return e;case Tl.ADD:return n+e;case Tl.SUBTRACT:return n-e}St.unreachable(t)}function MW(n,e,t){if(!(e instanceof We)){ve.warn(`TimelineBuilderProperty error: cannot animate vector4 param '${n.path()}' with targetValue`,e);return}const r=Tu.paramProxy(n);if(!r)return;const s=Mc(t.timelineBuilder);s.onUpdate=()=>{r.update()};const i=t.timelineBuilder.operation();s.x=Bn(n.value.x,e.x,i),s.y=Bn(n.value.y,e.y,i),s.z=Bn(n.value.z,e.z,i),s.w=Bn(n.value.w,e.w,i),Rc({...t,vars:s,target:r.proxyValue,registerableProp:n})}function RW(n,e,t){if(!(e instanceof xe||e instanceof T)){ve.warn(`TimelineBuilderProperty error: cannot animate color param '${n.path()}' with targetValue`,e);return}const r=Tu.paramProxy(n);if(!r)return;const s=Mc(t.timelineBuilder);s.onUpdate=()=>{r.update()};const i=t.timelineBuilder.operation(),o=e instanceof xe?e.r:e.x,a=e instanceof xe?e.g:e.y,c=e instanceof xe?e.b:e.z;s.r=Bn(n.value.r,o,i),s.g=Bn(n.value.g,a,i),s.b=Bn(n.value.b,c,i),Rc({...t,vars:s,target:r.proxyValue,registerableProp:n})}function wW(n){const{vars:e,targetValue:t,targetProperty:r,propertyNames:s,operation:i}=n;for(const o of s)e[o]=Bn(r[o],t[o],i)}function OW(n,e,t){if(!(e instanceof T)){ve.warn(`TimelineBuilderProperty error: cannot animate vector3 param '${n.path()}' with targetValue`,e);return}const r=Tu.paramProxy(n);if(!r)return;const s=Mc(t.timelineBuilder);s.onUpdate=()=>{r.update()};const i=t.timelineBuilder.operation();s.x=Bn(n.value.x,e.x,i),s.y=Bn(n.value.y,e.y,i),s.z=Bn(n.value.z,e.z,i),Rc({...t,vars:s,target:r.proxyValue,registerableProp:n})}function PW(n,e,t){if(!(e instanceof W)){ve.warn(`TimelineBuilderProperty error: cannot animate vector2 param '${n.path()}' with targetValue`,e);return}const r=Tu.paramProxy(n);if(!r)return;const s=Mc(t.timelineBuilder);s.onUpdate=()=>{r.update()};const i=t.timelineBuilder.operation();s.x=Bn(n.value.x,e.x,i),s.y=Bn(n.value.y,e.y,i),Rc({...t,vars:s,target:r.proxyValue,registerableProp:n})}function NW(n,e,t){if(!Ye(e)){ve.warn(`TimelineBuilderProperty error: cannot animate float/integer param '${n.path()}' with targetValue`,e);return}const r=Tu.paramProxy(n);if(!r)return;const s=t.timelineBuilder.keyframes(),i=s?s.createInterpolant():void 0,o=Mc(t.timelineBuilder);o.onUpdate=()=>{r.update(i)},s&&(e=1);const a=t.timelineBuilder.operation();o.proxyValue=Bn(n.value,e,a),Rc({...t,vars:o,target:r,registerableProp:n})}function IW(n){const{vars:e,targetValue:t,targetProperty:r,propertyNames:s,operation:i}=n;for(const o of s)e[o]=Bn(r,t,i)}function DW(n){const{vars:e,targetValue:t,targetProperty:r,propertyNames:s,operation:i}=n;for(const o of s)e[o]=Bn(r[o],t[o],i)}function LW(n){const{vars:e,targetValue:t,targetProperty:r}=n,s={value:0},i=r,o=new Qt().copy(r),a=t;return e.onUpdate=()=>{i.slerpQuaternions(o,a,s.value)},e.value=1,s}function FW(n){const{vars:e,targetValue:t,targetProperty:r,propertyNames:s,operation:i}=n;for(const o of s)e[o]=Bn(r[o],t[o],i)}const KC=".";class Wv{constructor(){this._debug=!1}setName(e){this._propertyName=e}setTargetValue(e){this._targetValue=e}name(){return this._propertyName}targetValue(){return this._targetValue}setDebug(e){this._debug=e}_printDebug(e){this._debug&&console.log(e)}clone(){const e=new Wv;if(this._propertyName&&e.setName(this._propertyName),this._targetValue!=null){const t=Ye(this._targetValue)?this._targetValue:this._targetValue.clone();e.setTargetValue(t)}return e}addToTimeline(e){const t=e.propertyTarget||e.target,r=t.objects(),s=t.node();this._printDebug(["addToTimeline",t,r,s]),r&&this._populateWithObjects(r,e),s&&this._populateWithNode(s,e)}_populateWithObjects(e,t){const{timelineBuilder:r}=t;if(this._printDebug(["_populateWithObjects",e]),!this._propertyName){ve.warn("no property name given");return}if(this._targetValue==null){ve.warn("no target value given");return}const s=r.operation(),i=r.updateCallback();for(const o of e){const a=this._sceneGraphProps(o,this._propertyName);if(a){const c={object:o,propertyName:this._propertyName};let{targetProperty:l,toTarget:u,propertyNames:h}=a;const d=Mc(r);if(i&&i.updateMatrix()){const p=o.matrixAutoUpdate;d.onUpdate=()=>{o.matrixAutoUpdate=!0},d.onComplete=()=>{o.matrixAutoUpdate=p,o.matrixAutoUpdate||o.updateMatrix()}}l instanceof Qt&&this._targetValue instanceof Qt&&(u=LW({targetValue:this._targetValue,vars:d,targetProperty:l})),this._populateVarsForObjectProperty({targetValue:this._targetValue,vars:d,targetProperty:l,propertyNames:h,operation:s}),u&&Rc({...t,vars:d,target:u,registerableProp:c})}}}_populateVarsForObjectProperty(e){const{vars:t,targetValue:r,targetProperty:s,propertyNames:i,operation:o}=e;function a(c){ve.warn(`mismatch between targetValue and targetProperty (expected ${c})`,r,s)}if(Ye(s))return Ye(r)?IW({targetValue:r,vars:t,targetProperty:s,propertyNames:i,operation:o}):a("number");if(jT(s))return r instanceof T?FW({targetValue:r,vars:t,targetProperty:s,propertyNames:i,operation:o}):a("euler");if(zl(s))return zl(r)?DW({targetValue:r,vars:t,targetProperty:s,propertyNames:i,operation:o}):a("vector");if(Hl(s))return Hl(r)?wW({targetValue:r,vars:t,targetProperty:s,propertyNames:i,operation:o}):a("color");ve.warn("targetValue and targetProp are not recognized types",r,s)}_sceneGraphProps(e,t){const r=t.split(KC);if(r.length>1){const s=r.shift(),i=e[s];if(i){const o=r.join(KC);return this._sceneGraphProps(i,o)}else ve.warn(`property ${s} not found on object`,e)}else{const s=e[t];let i=null;const o=[];return Ye(s)?(i=e,o.push(t)):(i=s,this._targetValue instanceof W&&o.push("x","y"),this._targetValue instanceof T&&o.push("x","y","z"),this._targetValue instanceof We&&o.push("x","y","z","w"),this._targetValue instanceof xe&&o.push("r","g","b"),this._targetValue instanceof Qt),{targetProperty:s,toTarget:i,propertyNames:o}}}_populateWithNode(e,t){this._printDebug(["_populateWithNode",e]);const r=e.p[this._propertyName];if(this._printDebug(["targetParam",r]),!r){ve.warn(`${this._propertyName} not found on node ${e.path()}`);return}r&&this._populateVarsForParam(r,t)}_populateVarsForParam(e,t){if(this._printDebug(["_populateVarsForParam",e]),this._targetValue!=null){switch(e.type()){case J.INTEGER:case J.FLOAT:return NW(e,this._targetValue,t);case J.VECTOR2:return PW(e,this._targetValue,t);case J.VECTOR3:return OW(e,this._targetValue,t);case J.COLOR:return RW(e,this._targetValue,t);case J.VECTOR4:return MW(e,this._targetValue,t)}ve.warn(`param type cannot be animated (yet): '${e.type()}' '${e.path()}'`)}}}const UW={gsap:void 0,timeline:n=>{}};function kW(n){return UW.timeline(n)}class Xv{constructor(){this._timelineBuilders=[],this._duration=1,this._operation=Tl.SET,this._delay=0,this._stoppable=!0,this._debug=!1}setDebug(e){this._debug=e}_printDebug(e){this._debug&&console.log(e)}addTimelineBuilder(e){this._timelineBuilders.push(e),e.setParent(this)}timelineBuilders(){return this._timelineBuilders}setParent(e){this._parent=e}parent(){return this._parent}setTarget(e){this._target=e;for(const t of this._timelineBuilders)t.setTarget(e)}target(){return this._target}setDuration(e){if(e>=0){this._duration=e;for(const t of this._timelineBuilders)t.setDuration(e)}}duration(){return this._duration}setKeyframes(e){this._keyframes=e}keyframes(){return this._keyframes}setEasing(e){this._easing=e;for(const t of this._timelineBuilders)t.setEasing(e)}easing(){return this._easing}setOperation(e){this._operation=e;for(const t of this._timelineBuilders)t.setOperation(e)}operation(){return this._operation}setRepeatParams(e){this._repeatParams=e;for(const t of this._timelineBuilders)t.setRepeatParams(e)}repeatParams(){return this._repeatParams}setDelay(e){this._delay=e;for(const t of this._timelineBuilders)t.setDelay(e)}delay(){return this._delay}setPosition(e){this._position=e}position(){return this._position}setStoppable(e){this._stoppable=e}stoppable(){return this._stoppable}setUpdateCallback(e){this._updateCallback=e}updateCallback(){return this._updateCallback}clone(){const e=new Xv;if(e.setDuration(this._duration),e.setOperation(this._operation),e.setDelay(this._delay),this._target&&e.setTarget(this._target.clone()),this._easing&&e.setEasing(this._easing),this._keyframes&&e.setKeyframes(this._keyframes),this._delay&&e.setDelay(this._delay),this._updateCallback&&e.setUpdateCallback(this._updateCallback.clone()),this._repeatParams&&e.setRepeatParams({count:this._repeatParams.count,delay:this._repeatParams.delay,yoyo:this._repeatParams.yoyo}),this._property){const t=this._property.name();t&&e.setPropertyName(t);const r=this._property.targetValue();r!=null&&e.setPropertyValue(r)}this._position&&e.setPosition(this._position.clone()),e.setStoppable(this._stoppable);for(const t of this._timelineBuilders){const r=t.clone();e.addTimelineBuilder(r)}return e}setPropertyName(e){this.property().setName(e)}property(){return this._property=this._property||new Wv}propertyName(){return this.property().name()}setPropertyValue(e){this.property().setTargetValue(e)}propertyValue(){var e;return(e=this._property)==null?void 0:e.targetValue()}populate(e,t){var r;this._printDebug(["populate",this,e,this._timelineBuilders]);for(const s of this._timelineBuilders){const i=kW();if(!i)continue;s.setDebug(this._debug),s.populate(i,t);const o=((r=s.position())==null?void 0:r.toParameter())||void 0;e.add(i,o)}this._property&&this._target&&(this._property.setDebug(this._debug),this._property.addToTimeline({timelineBuilder:this,timeline:e,target:this._target,...t}))}}class $v{setAudioNode(e){this._audioNode=e}audioNode(){return this._audioNode}setSource(e){this._source=e,this._audioNode||this.setAudioNode(e)}source(){return this._source}setInstrument(e){this._instrument=e,this._audioNode||this.setAudioNode(e)}instrument(){return this._instrument}setOscillatorParams(e){this._oscillatorParams=e}oscillatorParams(){return this._oscillatorParams}setEnvelopeParams(e){this._envelopeParams=e}envelopeParams(){return this._envelopeParams}clone(){const e=new $v;return e.setAudioNode(this._audioNode),e.setSource(this._source),e.setInstrument(this._instrument),e.setEnvelopeParams(this._envelopeParams),e}}const BW={[be.ANIM]:Xv,[be.AUDIO]:$v,[be.COP]:Wn,[be.EVENT]:String,[be.GL]:String,[be.JS]:String,[be.MANAGER]:Boolean,[be.MAT]:gn,[be.OBJ]:wt,[be.ROP]:String,[be.POST]:Number,[be.SOP]:hc};class zr{constructor(e){this._node=e}set_node(e){this._node=e}node(){return this._node}set_content(e){this._content=e,this._post_set_content()}has_content(){return this._content!=null}content(){return this._content}_post_set_content(){}coreContent(){return this._content}coreContentCloned(){return this._content}infos(){return[]}}class GW extends zr{set_content(e){super.set_content(e)}setTimelineBuilder(e){return this.set_content(e)}timelineBuilder(){return this.content()}coreContentCloned(){if(this._content)return this._content.clone()}}class VW extends zr{setContent(e){super.set_content(e)}setAudioBuilder(e){return this.set_content(e)}audioBuilder(){return this.content()}coreContentCloned(){if(this._content)return this._content.clone()}}class zW extends zr{set_content(e){super.set_content(e)}}class HW extends zr{coreContentCloned(){if(this._content)return this._content.clone()}set_content(e){super.set_content(e)}}class jW extends zr{object(){return this._content}}class WW extends zr{object(){return this._content}}class XW extends zr{set_content(e){super.set_content(e)}}class $W extends zr{set_content(e){super.set_content(e)}coreContentCloned(){if(this._content)return Cu.clone(this._node.scene(),this._content,{shareCustomUniforms:!0,addCustomMaterials:!0})}set_material(e){this._content!=null&&this._content.dispose(),this.set_content(e)}has_material(){return this.has_content()}material(){return this.content()}}class qW extends zr{set_content(e){super.set_content(e)}set_object(e){return this.set_content(e)}has_object(){return this.has_content()}object(){return this.content()}}class YW extends zr{set_content(e){super.set_content(e)}texture(){return this._content}coreContent(){return this._content}coreContentCloned(){var e;const t=(e=this._content)==null?void 0:e.clone();return t&&(t.needsUpdate=!0),t}object(){return this.texture()}infos(){if(this._content!=null)return[this._content]}resolution(){function e(t){return[t.videoWidth,t.videoHeight]}if(this._content){const t=this._content.image;if(t){if(t instanceof HTMLImageElement||t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement)return[t.width,t.height];if(t instanceof HTMLVideoElement)return e(t);if(Ye(t.width)&&Ye(t.height))return[t.width,t.height]}const r=this._content.source;if(r){if(r instanceof HTMLVideoElement)return e(r);const s=r.data;if(s&&Ye(s.width)&&Ye(s.height))return[s.width,s.height]}}return[-1,-1]}}class KW extends zr{set_content(e){super.set_content(e)}render_pass(){return this._content}object(e={}){return this.render_pass()}}class ZW extends zr{set_content(e){super.set_content(e)}renderer(){return this._content}}const JW={[be.ANIM]:GW,[be.AUDIO]:VW,[be.COP]:YW,[be.EVENT]:zW,[be.GL]:jW,[be.JS]:WW,[be.MANAGER]:XW,[be.MAT]:$W,[be.OBJ]:qW,[be.ROP]:ZW,[be.POST]:KW,[be.SOP]:HW};class QW{constructor(e){this.node=e,this._callbacks=[],this._callbacksTmp=[],this._container=this._createContainer()}container(){return this._container}_createContainer(){const e=JW[this.node.context()];return new e(this.node)}_createContainerWithContent(){const e=this._createContainer(),t=BW[this.node.context()],r=new t;return e.set_content(r),e}firstNonBypassedNode(){var e,t;return(t=(e=this.node.flags)==null?void 0:e.bypass)!=null&&t.active()?this.node.io.inputs.input(0):this.node}containerUnlessBypassed(){var e,t;if((t=(e=this.node.flags)==null?void 0:e.bypass)!=null&&t.active()){this.node.states.error.clear();const r=this.node.io.inputs.input(0);return r?r.containerController.containerUnlessBypassed():this._createContainerWithContent()}else return this.container()}async compute(){var e,t;if(this.node.disposed()&&console.warn(".compute() requested from a disposed node",this.node),(t=(e=this.node.flags)==null?void 0:e.bypass)!=null&&t.active())if(this.node.states.error.clear(),this.node.io.inputs.input(0)){const s=await this.requestInputContainer(0)||this._container;return this.node.cookController.endCook(),s}else return this._createContainerWithContent();return this.node.isDirty()?new Promise((r,s)=>{var i,o;if(this._callbacks.push(r),(o=(i=this.node.flags)==null?void 0:i.bypass)!=null&&o.active())throw"we should not be here";this.node.cookController.cookMain()}):this._container}async requestInputContainer(e){const t=this.node.io.inputs.input(e);return t?await t.compute():(this.node.states.error.set(`input ${e} required`),this.notifyRequesters(),null)}notifyRequesters(e){this._callbacksTmp=this._callbacks.slice(),this._callbacks.splice(0,this._callbacks.length),e||(e=this.node.containerController.container());let t;for(;t=this._callbacksTmp.pop();)t(e);this.node.scene().cookController.removeNode(this.node)}}const Ea=ve.performance.performanceManager();class e5{constructor(e){this.cookController=e,this._inputsStart=0,this._inputsTime=0,this._paramsStart=0,this._paramsTime=0,this._cookStart=0,this._cookTime=0,this._cooksCount=0,this._data={inputsTime:0,paramsTime:0,cookTime:0}}cooksCount(){return this._cooksCount}data(){return this._data.inputsTime=this._inputsTime,this._data.paramsTime=this._paramsTime,this._data.cookTime=this._cookTime,this._data}active(){return this.cookController.performanceRecordStarted()}recordInputsStart(){this.active()&&(this._inputsStart=Ea.now())}recordInputsEnd(){this.active()&&(this._inputsTime=Ea.now()-this._inputsStart)}recordParamsStart(){this.active()&&(this._paramsStart=Ea.now())}recordParamsEnd(){this.active()&&(this._paramsTime=Ea.now()-this._paramsStart)}recordCookStart(){this.active()&&(this._cookStart=Ea.now())}recordCookEnd(){this.active()&&(this._cookTime=Ea.now()-this._cookStart,this._cooksCount+=1)}}const t5=new Map;function n5(n){return t5.get(n)}function r5(n){const e=n5(n);e&&VT(e)}class s5{constructor(e){this.node=e,this._cooking=!1,this._performanceController=new e5(this),this._inputContainers=[],this._inputContents=[],this._EMPTY_ARRAY=[],this._inputsEvaluationRequired=!0,this._corePerformance=this.node.scene().performance}performanceRecordStarted(){return this._corePerformance.started()}dispose(){this._clearHooks()}disallowInputsEvaluation(){this._inputsEvaluationRequired=!1}isCooking(){return this._cooking===!0}_startCookIfNoErrors(e){if(this.node.states.error.active()||this.node.disposed()==!0)this.endCook();else try{this._performanceController.recordCookStart();const t=this.node.cook(e);t!=null&&t.catch(r=>{this._onError(r,"node internal error",!1)})}catch(t){this._onError(t,"node internal error")}}async cookMain(){if(!this.isCooking()&&this.node.disposed()!=!0){this._initCookingState(),this.node.states.error.clear(),this.node.scene().cookController.addNode(this.node);try{this._inputContents.length=0,this._inputsEvaluationRequired&&await this._evaluateInputs(this._inputContents),this.node.params.paramsEvalRequired()&&await this._evaluateParams(),this._startCookIfNoErrors(this._inputContents)}catch(e){this._onError(e,"node inputs error")}}}_onError(e,t,r=!0){if(r||!this.node.states.error.active()){const s=this.node.processError(e);this.node.states.error.set(`${t}: '${s}'.`),ve.warn(e)}this.endCook()}async cookMainWithoutInputs(){if(this.node.scene().cookController.addNode(this.node),this.isCooking()){ve.warn("cook_main_without_inputs already cooking",this.node.path());return}this._initCookingState(),this.node.states.error.clear(),this.node.params.paramsEvalRequired()&&await this._evaluateParams(),this._startCookIfNoErrors(this._EMPTY_ARRAY)}endCook(){var e,t;this._finalizeCookPerformance();const r=this.node.dirtyController.dirtyTimestamp();if(r==null||r===this._cookingDirtyTimestamp||(t=(e=this.node.flags)==null?void 0:e.bypass)!=null&&t.active())this.node.removeDirtyState(),this._terminateCookProcess();else{if(this.node.disposed()==!0)return;ve.log("COOK AGAIN",r,this._cookingDirtyTimestamp,this.node.path()),this._cooking=!1,this.cookMain()}}_initCookingState(){this._cooking=!0,this._cookingDirtyTimestamp=this.node.dirtyController.dirtyTimestamp()}_terminateCookProcess(){var e,t;if(this.isCooking()||(t=(e=this.node.flags)==null?void 0:e.bypass)!=null&&t.active()){if(this._cooking=!1,this.node.containerController.notifyRequesters(),this._runOnCookCompleteHooks(),this.node.disposed()==!0)return;r5(this.node.path())}}async _evaluateInputs(e){this._performanceController.recordInputsStart();const t=this.node.io.inputs;this._inputContainers.length=0,this._inputsEvaluationRequired&&(t.isGraphNodeDirty()?await t.evalRequiredInputs(this._inputContainers):t.containersWithoutEvaluation(this._inputContainers));const r=t.inputs();let s;for(let i=0;i<r.length;i++)s=this._inputContainers[i],s&&(t.cloneRequired(i)?e[i]=s.coreContentCloned():e[i]=s.coreContent());return this._performanceController.recordInputsEnd(),e}async _evaluateParams(){this._performanceController.recordParamsStart(),await this.node.params.evalAll(),this._performanceController.recordParamsEnd()}cooksCount(){return this._performanceController.cooksCount()}cookTime(){return this._performanceController.data().cookTime}_finalizeCookPerformance(){this._corePerformance.started()&&(this._performanceController.recordCookEnd(),this._corePerformance.recordNodeCookData(this.node,this._performanceController.data()))}registerOnCookEnd(e,t){this._onCookCompleteHookNames=this._onCookCompleteHookNames||[],this._onCookCompleteHooks=this._onCookCompleteHooks||[],this._onCookCompleteHookNames.push(e),this._onCookCompleteHooks.push(t)}_clearHooks(){if(!(!this._onCookCompleteHookNames||!this._onCookCompleteHooks))for(const e of this._onCookCompleteHookNames)this.deregisterOnCookEnd(e)}deregisterOnCookEnd(e){var t;if(!this._onCookCompleteHookNames||!this._onCookCompleteHooks)return;const r=(t=this._onCookCompleteHookNames)==null?void 0:t.indexOf(e);this._onCookCompleteHookNames.splice(r,1),this._onCookCompleteHooks.splice(r,1),this._onCookCompleteHookNames.length==0&&(this._onCookCompleteHookNames=void 0),this._onCookCompleteHooks.length==0&&(this._onCookCompleteHooks=void 0)}_runOnCookCompleteHooks(){if(this._onCookCompleteHooks){const e=[...this._onCookCompleteHooks];for(let t of e)t()}}onCookEndCallbackNames(){return this._onCookCompleteHookNames}}class i5 extends Bp{static type(){return J.BOOLEAN}defaultValueSerialized(){return Ke(this._default_value)?this._default_value:this.convert(this._default_value)||!1}rawInputSerialized(){return this._raw_input}valueSerialized(){return this.value}_copyValue(e){this.set(e.value)}static areRawInputEqual(e,t){return e==t}static areValuesEqual(e,t){return e==t}convert(e){if(mr(e))return e;if(Ye(e))return e>=1;if(Ke(e)){if(yt.isBoolean(e))return yt.toBoolean(e);if(yt.isNumber(e))return parseFloat(e)>=1}return null}}class o5 extends Yi{static type(){return J.BUTTON}defaultValueSerialized(){return this._default_value}rawInputSerialized(){return this._raw_input}valueSerialized(){return this.value}_copyValue(e){}static areRawInputEqual(e,t){return!0}static areValuesEqual(e,t){return!0}async pressButton(){(this.node.isDirty()||this.node.cookController.isCooking())&&await this.node.compute(),await this.options.executeCallback()}}const a5=["r","g","b"],ZC=[0,0,0];function JC(n,e){return n.r==e[0]&&n.g==e[1]&&n.b==e[2]}function c5(n,e){return n[0]==e[0]&&n[1]==e[1]&&n[2]==e[2]}class l5 extends Au{constructor(){super(...arguments),this._value=new xe,this._valuePreConversion=new xe,this._valueSerializedDirty=!1,this._valueSerialized=[0,0,0],this._valuePreConversionSerialized=[0,0,0],this._copiedValue=[0,0,0]}static type(){return J.COLOR}componentNames(){return a5}defaultValueSerialized(){return _t(this._default_value)?this._default_value:this._default_value.toArray()}_prefilterInvalidRawInput(e){return e instanceof xe?(e.toArray(ZC),ZC):super._prefilterInvalidRawInput(e)}valueSerialized(){return this._updateValueSerializedIfRequired(),this._valueSerialized}valuePreConversionSerialized(){return this._updateValueSerializedIfRequired(),this._valuePreConversionSerialized}_copyValue(e){e.value.toArray(this._copiedValue),this.set(this._copiedValue)}_cloneRawInput(e){if(e instanceof xe)return e.clone();{const t=[e[0],e[1],e[2]];return t[0]==null&&(t[0]=t[0]||0),t[1]==null&&(t[1]=t[1]||t[0]),t[2]==null&&(t[2]=t[2]||t[1]),t}}static areRawInputEqual(e,t){return e instanceof xe?t instanceof xe?e.equals(t):JC(e,t):t instanceof xe?JC(t,e):c5(e,t)}static areValuesEqual(e,t){return e.equals(t)}initComponents(){super.initComponents(),this.r=this.components[0],this.g=this.components[1],this.b=this.components[2],this._valueSerializedDirty=!0}postOptionsInitialize(){this.setValueFromComponents()}_updateValueSerializedIfRequired(){this._valueSerializedDirty&&(this._valueSerialized[0]=this._value.r,this._valueSerialized[1]=this._value.g,this._valueSerialized[2]=this._value.b,this._valuePreConversionSerialized[0]=this._valuePreConversion.r,this._valuePreConversionSerialized[1]=this._valuePreConversion.g,this._valuePreConversionSerialized[2]=this._valuePreConversion.b)}valuePreConversion(){return this._valuePreConversion}async setConversion(e){this.options.setOption("conversion",e),this.setDirty(),await this.options.executeCallback()}setValueFromComponents(){this._valuePreConversion.r=this.r.value,this._valuePreConversion.g=this.g.value,this._valuePreConversion.b=this.b.value,this._value.copy(this._valuePreConversion),this._applyColorConversion(),this._valueSerializedDirty=!0}_applyColorConversion(){const e=this.options.colorConversion();switch(e){case Ys.NONE:return;case Ys.SRGB_TO_LINEAR:{this._value.convertSRGBToLinear();return}case Ys.LINEAR_TO_SRGB:{this._value.convertLinearToSRGB();return}}St.unreachable(e)}}class u5 extends Yi{static type(){return J.FOLDER}defaultValueSerialized(){return this._default_value}rawInputSerialized(){return this._raw_input}valueSerialized(){return this.value}_copyValue(e){}static areRawInputEqual(e,t){return!0}static areValuesEqual(e,t){return!0}}class qv extends Bp{static type(){return J.INTEGER}defaultValueSerialized(){return this._default_value}rawInputSerialized(){return this._raw_input}valueSerialized(){return this.value}_copyValue(e){this.set(e.valueSerialized())}_prefilterInvalidRawInput(e){if(_t(e))return e[0];if(Ke(e)&&yt.isNumber(e)){const t=parseInt(e);if(t!=null){const r=this.convert(t);if(r!=null)return r}}if(Ye(e)){const t=this.convert(e);if(t!=null)return t}return e}static areRawInputEqual(e,t){return e==t}static areValuesEqual(e,t){return e==t}static convert(e){if(Ye(e))return Math.round(e);if(mr(e))return e?1:0;if(yt.isNumber(e)){const t=parseInt(e);if(Ye(t))return t}return null}convert(e){const t=qv.convert(e);if(t!=null){let r=this.options.ensureInRange(t);return r=this.options.ensureValueInMenuEntries(r),r}else return t}}const h5=["x","y"],QC=[0,0];function eE(n,e){return n.x==e[0]&&n.y==e[1]}function d5(n,e){return n[0]==e[0]&&n[1]==e[1]}class p5 extends Au{constructor(){super(...arguments),this._value=new W,this._copied_value=[0,0]}static type(){return J.VECTOR2}componentNames(){return h5}defaultValueSerialized(){return _t(this._default_value)?this._default_value:this._default_value.toArray()}_prefilterInvalidRawInput(e){return e instanceof W?(e.toArray(QC),QC):super._prefilterInvalidRawInput(e)}valueSerialized(){return this.value.toArray()}_copyValue(e){e.value.toArray(this._copied_value),this.set(this._copied_value)}_cloneRawInput(e){if(e instanceof W)return e.clone();{const t=[e[0],e[1]];return t[0]==null&&(t[0]=t[0]||0),t[1]==null&&(t[1]=t[1]||t[0]),t}}static areRawInputEqual(e,t){return e instanceof W?t instanceof W?e.equals(t):eE(e,t):t instanceof W?eE(t,e):d5(e,t)}static areValuesEqual(e,t){return e.equals(t)}initComponents(){super.initComponents(),this.x=this.components[0],this.y=this.components[1]}setValueFromComponents(){this._value.x=this.x.value,this._value.y=this.y.value}}const f5=["x","y","z"],tE=[0,0,0];function nE(n,e){return n.x==e[0]&&n.y==e[1]&&n.z==e[2]}function m5(n,e){return n[0]==e[0]&&n[1]==e[1]&&n[2]==e[2]}class _5 extends Au{constructor(){super(...arguments),this._value=new T,this._copied_value=[0,0,0]}static type(){return J.VECTOR3}componentNames(){return f5}defaultValueSerialized(){return _t(this._default_value)?this._default_value:this._default_value.toArray()}_prefilterInvalidRawInput(e){return e instanceof T?(e.toArray(tE),tE):super._prefilterInvalidRawInput(e)}valueSerialized(){return this.value.toArray()}_copyValue(e){e.value.toArray(this._copied_value),this.set(this._copied_value)}_cloneRawInput(e){if(e instanceof T)return e.clone();{const t=[e[0],e[1],e[2]];return t[0]==null&&(t[0]=t[0]||0),t[1]==null&&(t[1]=t[1]||t[0]),t[2]==null&&(t[2]=t[2]||t[1]),t}}static areRawInputEqual(e,t){return e instanceof T?t instanceof T?e.equals(t):nE(e,t):t instanceof T?nE(t,e):m5(e,t)}static areValuesEqual(e,t){return e.equals(t)}initComponents(){super.initComponents(),this.x=this.components[0],this.y=this.components[1],this.z=this.components[2]}setValueFromComponents(){this._value.x=this.x.value,this._value.y=this.y.value,this._value.z=this.z.value}}const g5=["x","y","z","w"],rE=[0,0,0,0];function sE(n,e){return n.x==e[0]&&n.y==e[1]&&n.z==e[2]&&n.w==e[3]}function v5(n,e){return n[0]==e[0]&&n[1]==e[1]&&n[2]==e[2]&&n[3]==e[3]}class y5 extends Au{constructor(){super(...arguments),this._value=new We,this._copied_value=[0,0,0,0]}static type(){return J.VECTOR4}componentNames(){return g5}defaultValueSerialized(){return _t(this._default_value)?this._default_value:this._default_value.toArray()}_prefilterInvalidRawInput(e){return e instanceof We?(e.toArray(rE),rE):super._prefilterInvalidRawInput(e)}valueSerialized(){return this.value.toArray()}_copyValue(e){e.value.toArray(this._copied_value),this.set(this._copied_value)}_cloneRawInput(e){if(e instanceof We)return e.clone();{const t=[e[0],e[1],e[2],e[3]];return t[0]==null&&(t[0]=t[0]||0),t[1]==null&&(t[1]=t[1]||t[0]),t[2]==null&&(t[2]=t[2]||t[1]),t[3]==null&&(t[3]=t[3]||t[2]),t}}static areRawInputEqual(e,t){return e instanceof We?t instanceof We?e.equals(t):sE(e,t):t instanceof We?sE(t,e):v5(e,t)}static areValuesEqual(e,t){return e.equals(t)}initComponents(){super.initComponents(),this.x=this.components[0],this.y=this.components[1],this.z=this.components[2],this.w=this.components[3]}setValueFromComponents(){this._value.x=this.x.value,this._value.y=this.y.value,this._value.z=this.z.value,this._value.w=this.w.value}}const x5={[J.BOOLEAN]:i5,[J.BUTTON]:o5,[J.COLOR]:l5,[J.FLOAT]:Vp,[J.FOLDER]:u5,[J.INTEGER]:qv,[J.PARAM_PATH]:gR,[J.NODE_PATH]:Bv,[J.RAMP]:vs,[J.STRING]:Gv,[J.VECTOR2]:p5,[J.VECTOR3]:_5,[J.VECTOR4]:y5},b5="params",iE=[];class C5{constructor(e){this.node=e,this._param_create_mode=!1,this._params_created=!1,this._paramsByName=new Map,this._paramsList=[],this._paramNames=[],this._non_spare_params=[],this._spare_params=[],this._non_spare_param_names=[],this._spare_param_names=[],this._params_added_since_last_params_eval=!1,this._promises=[]}dispose(){this._params_node&&this._params_node.dispose(),Ts(this.all,iE);for(const e of iE)e.dispose();this._post_create_params_hook_names=void 0,this._post_create_params_hooks=void 0,this._on_scene_load_hooks=void 0,this._on_scene_load_hook_names=void 0}initDependencyNode(){this._params_node||(this._params_node=new _r(this.node.scene(),b5),this.node.addGraphInput(this._params_node,!1))}init(){this.initDependencyNode(),this._param_create_mode=!0,this._initFromParamsConfig(),this.node.createParams(),this._postCreateParams()}_postCreateParams(){this._updateCaches(),this._initParamAccessors(),this._param_create_mode=!1,this._params_created=!0,this._runPostCreateParamsHooks()}postCreateSpareParams(){this._updateCaches(),this._initParamAccessors(),this.node.scene().referencesController.notifyParamsUpdated(this.node),this.node.emit(_n.PARAMS_UPDATED)}updateParams(e){let t=!1,r=!1;const s=[];if(e.namesToDelete)for(const i of e.namesToDelete)this.has(i)&&(this._deleteParam(i),r=!0);if(e.toAdd)for(const i of e.toAdd){const o=this.addParam(i.type,i.name,i.initValue,i.options);o&&(i.rawInput!=null&&o.set(i.rawInput),t=!0,s.push(o))}(r||t)&&this.postCreateSpareParams();for(const i of s)this.node.scene().missingExpressionReferencesController.checkForMissingParamReferences(i)}_initFromParamsConfig(){var e;const t=this.node.paramsConfig;let r=!1;if(t){const s=(e=this.node.createOptions)==null?void 0:e.paramsInitValueOverrides,i=Object.keys(t);for(const o of i){const a=t[o];let c;s&&(c=s[o],r=!0),this.addParam(a.type,o,a.init_value,a.options,c)}}r&&this.node.setDirty(),this.node.createOptions&&(this.node.createOptions.paramsInitValueOverrides=void 0)}_initParamAccessors(){let e=Object.getOwnPropertyNames(this.node.pv);this._removeUnneededAccessors(e),e=Object.getOwnPropertyNames(this.node.pv);const t=this.all;for(const r of t){const s=r.options.isSpare(),i=!e.includes(r.name());try{(i||s)&&(Object.defineProperty(this.node.pv,r.name(),{get:()=>r.value,configurable:s}),Object.defineProperty(this.node.p,r.name(),{get:()=>r,configurable:s}))}catch{}}}_removeUnneededAccessors(e){const t=this._paramNames,r=[];for(const s of e)t.includes(s)||r.push(s);for(const s of r)Object.defineProperty(this.node.pv,s,{get:()=>{},configurable:!0}),Object.defineProperty(this.node.p,s,{get:()=>{},configurable:!0})}get params_node(){return this._params_node}get all(){return this._paramsList}get non_spare(){return this._non_spare_params}get spare(){return this._spare_params}get names(){return this._paramNames}get non_spare_names(){return this._non_spare_param_names}get spare_names(){return this._spare_param_names}set_with_type(e,t,r){const s=this.paramWithType(e,r);s?s.set(t):ve.warn(`param ${e} not found with type ${r}`)}set_float(e,t){this.set_with_type(e,t,J.FLOAT)}set_vector3(e,t){this.set_with_type(e,t,J.VECTOR3)}has_param(e){return this._paramsByName.has(e)}has(e){return this.has_param(e)}get(e){return this.param(e)}paramWithType(e,t){const r=this.param(e);if(r&&r.type()==t)return r}getFloat(e){return this.paramWithType(e,J.FLOAT)}value(e){var t;return(t=this.param(e))==null?void 0:t.value}valueWithType(e,t){var r;return(r=this.paramWithType(e,t))==null?void 0:r.value}boolean(e){return this.valueWithType(e,J.BOOLEAN)}float(e){return this.valueWithType(e,J.FLOAT)}integer(e){return this.valueWithType(e,J.INTEGER)}string(e){return this.valueWithType(e,J.STRING)}vector2(e){return this.valueWithType(e,J.VECTOR2)}vector3(e){return this.valueWithType(e,J.VECTOR3)}color(e){return this.valueWithType(e,J.COLOR)}param(e){const t=this._paramsByName.get(e);return t??(ve.warn(`tried to access param '${e}' in node ${this.node.path()}, but existing params are: ${this.names} on node ${this.node.path()}`),null)}_deleteParam(e){const t=this._paramsByName.get(e);if(t){if(this._params_node&&this._params_node.removeGraphInput(t),t._setupNodeDependencies(null),this._paramsByName.delete(e),t.isMultiple()&&t.components)for(const r of t.components){const s=r.name();this._paramsByName.delete(s)}t.dispose(),t.scene().graphNodesController.notifyParamPathChanged(t)}else throw new Error(`param '${e}' does not exist on node ${this.node.path()}`)}addParam(e,t,r,s={},i){const o=s.spare||!1;this._param_create_mode===!1&&!o&&ve.warn(`node ${this.node.path()} (${this.node.type()}) param '${t}' cannot be created outside of createParams`),this.node.scene()==null&&ve.warn(`node ${this.node.path()} (${this.node.type()}) has no scene assigned`);const a=x5[e];if(a!=null){const c=this._paramsByName.get(t);c&&(o?c.type()!=e&&this._deleteParam(c.name()):ve.warn(`a param named ${t} already exists`,this.node));const l=new a(this.node.scene(),this.node,{serializerClass:this.node.scene().paramSerializerClass()});if(l.options.set(s),l.setName(t),l.setInitValue(r),l.initComponents(),i==null)l.set(r);else if(l.options.isExpressionForEntities()&&l.set(r),i.raw_input!=null)l.set(i.raw_input);else if(i.simple_data!=null)l.set(i.simple_data);else if(i.complex_data!=null){const u=i.complex_data.raw_input;u?l.set(u):l.set(r);const h=i.complex_data.overriden_options;if(h!=null){const d=Object.keys(h);for(const p of d)l.options.setOption(p,h[p])}}if(l.postOptionsInitialize(),l._setupNodeDependencies(this.node),this._paramsByName.set(l.name(),l),l.isMultiple()&&l.components)for(const u of l.components)this._paramsByName.set(u.name(),u);return this._params_added_since_last_params_eval=!0,l.scene().graphNodesController.notifyParamPathChanged(l),l}}_updateCaches(){this._paramsList.splice(0,this._paramsList.length),this._paramsByName.forEach(e=>{this._paramsList.push(e)}),this._paramNames=this._paramsList.map(e=>e.name()),this._non_spare_params=this._paramsList.filter(e=>!e.options.isSpare()),this._spare_params=this._paramsList.filter(e=>e.options.isSpare()),this._non_spare_param_names=this._non_spare_params.map(e=>e.name()),this._spare_param_names=this._spare_params.map(e=>e.name())}async _evalParam(e){e.isDirty()&&(await e.compute(),e.states.error.active()&&e.disposed()==!1&&this.node.states.error.set(`param '${e.name()}' error: ${e.states.error.message()}`))}async evalParams(e){let t=0;for(const s of e)s.isDirty()&&(t+=1);this._promises.length=t;let r=0;for(const s of e)s.isDirty()&&(this._promises[r]=this._evalParam(s),r+=1);await Promise.all(this._promises),this.node.states.error.active()&&this.node._setContainer(null)}paramsEvalRequired(){return this._params_node!=null&&(this._params_node.isDirty()||this._params_added_since_last_params_eval)}async evalAll(){var e;this.paramsEvalRequired()&&(await this.evalParams(this._paramsList),(e=this._params_node)==null||e.removeDirtyState(),this._params_added_since_last_params_eval=!1)}onParamsCreated(e,t){if(this._params_created)t();else{if(this._post_create_params_hook_names&&this._post_create_params_hook_names.includes(e)){ve.error(`hook name ${e} already exists`);return}this._post_create_params_hook_names=this._post_create_params_hook_names||[],this._post_create_params_hook_names.push(e),this._post_create_params_hooks=this._post_create_params_hooks||[],this._post_create_params_hooks.push(t)}}addOnSceneLoadHook(e,t){this._on_scene_load_hook_names=this._on_scene_load_hook_names||[],this._on_scene_load_hooks=this._on_scene_load_hooks||[],this._on_scene_load_hook_names.includes(e)?ve.warn(`hook with name ${e} already exists`,this.node):(this._on_scene_load_hook_names.push(e),this._on_scene_load_hooks.push(t))}_runPostCreateParamsHooks(){if(this._post_create_params_hooks)for(const e of this._post_create_params_hooks)e()}runOnSceneLoadHooks(){if(this._on_scene_load_hooks)for(const e of this._on_scene_load_hooks)e()}}class E5{constructor(){}}const S5="triggered",A5={type:S5},MR=class{constructor(n,e,t=0,r=0){if(this._nodeSrc=n,this._nodeDest=e,this._outputIndex=t,this._inputIndex=r,this._outputIndex==null)throw"bad output index";if(this._inputIndex==null)throw"bad input index";this._id=MR._nextId++,this._nodeSrc.io.connections&&this._nodeDest.io.connections&&(this._nodeSrc.io.connections.addOutputConnection(this),this._nodeDest.io.connections.addInputConnection(this))}id(){return this._id}nodeSrc(){return this._nodeSrc}nodeDest(){return this._nodeDest}outputIndex(){return this._outputIndex}inputIndex(){return this._inputIndex}srcConnectionPoint(){const n=this._nodeSrc.io.outputs.namedOutputConnectionPoints();if(n)return n[this._outputIndex]}destConnectionPoint(){const n=this._nodeDest.io.inputs.namedInputConnectionPoints();if(n)return n[this._inputIndex]}disconnect(n={}){this._nodeSrc.io.connections&&this._nodeDest.io.connections&&(this._nodeSrc.io.connections.removeOutputConnection(this),this._nodeDest.io.connections.removeInputConnection(this)),n.setInput===!0&&this._nodeDest.io.inputs.setInput(this._inputIndex,null,void 0,{ignoreLockedState:n.ignoreLockedState})}_eventDispatcher(){return this.__eventDispatcher}eventDispatcher(){return this.__eventDispatcher=this.__eventDispatcher||new Ms}};let RR=MR;RR._nextId=0;class T5{constructor(e){this.inputsController=e,this._cloneRequiredStates=[],this._overridden=!1,this.node=e.node}initInputsClonedState(e){_t(e)?this._clonedStates=e:this._clonedState=e,this.updateCloneRequiredState()}overrideClonedStateAllowed(){if(this._clonedStates){for(const e of this._clonedStates)if(e==Mt.FROM_NODE)return!0}return this._clonedState?this._clonedState==Mt.FROM_NODE:!1}cloneRequiredState(e){return this._cloneRequiredStates[e]}cloneRequiredStates(){return this._cloneRequiredStates}_getCloneRequiredState(e){const t=this._clonedStates;if(t){const r=t[e];if(r!=null)return this._cloneRequiredFromState(r)}return this._clonedState?this._cloneRequiredFromState(this._clonedState):!0}_cloneRequiredFromState(e){switch(e){case Mt.ALWAYS:return!0;case Mt.NEVER:return!1;case Mt.FROM_NODE:return!this._overridden}return St.unreachable(e)}overrideClonedState(e){this._overridden=e,this.updateCloneRequiredState()}overriden(){return this._overridden}updateCloneRequiredState(){if(this._clonedStates){const e=[];for(let t=0;t<this._clonedStates.length;t++)e[t]=this._getCloneRequiredState(t);this._cloneRequiredStates=e}else if(this._clonedState){const e=this.inputsController.maxInputsCount(),t=[];for(let r=0;r<e;r++)t[r]=this._getCloneRequiredState(r);this._cloneRequiredStates=t}this.node.parent()&&(this.node.emit(_n.OVERRIDE_CLONABLE_STATE_UPDATE),this.node.setDirty())}}const Zc=[],gm=0;class M5{constructor(e){this.node=e,this._graphNodeInputs=[],this._inputs=[],this._has_named_inputs=!1,this._minInputsCount=0,this._maxInputsCount=gm,this._maxInputsCountOnInput=gm,this._depends_on_inputs=!0,this._singleInputIndexListenedTo=null}dispose(){this._graphNode&&this._graphNode.dispose();for(const e of this._graphNodeInputs)e&&e.dispose();this._on_update_hooks=void 0,this._on_update_hook_names=void 0}setDependsOnInputs(e){this._depends_on_inputs=e}setMinCount(e){this._minInputsCount=e}minCount(){return this._minInputsCount}setMaxCount(e){this._maxInputsCount==gm&&(this._maxInputsCountOnInput=e),this._maxInputsCount=e,this._initGraphNodeInputs(),this._updateCloneRequiredState()}listenToSingleInputIndex(e){this._singleInputIndexListenedTo=e}onEnsureListenToSingleInputIndexUpdated(e){this._onEnsureListenToSingleInputIndexUpdatedCallback=e}namedInputConnectionPointsByName(e){if(this._named_input_connection_points){for(const t of this._named_input_connection_points)if(t&&t.name()==e)return t}}setNamedInputConnectionPoints(e){var t;this._has_named_inputs=!0;const r=((t=this._named_input_connection_points)==null?void 0:t.filter(a=>a==null?void 0:a.inNodeDefinition()))||[],s=O_(r),i=new Set;for(const a of r)a&&i.add(a.name());for(const a of e)a&&(i.has(a.name())||(i.add(a.name()),s.push(a)));const o=this.node.io.connections.inputConnections();if(o)for(const a of o)a&&a.inputIndex()>=s.length&&a.disconnect({setInput:!0,ignoreLockedState:!0});this._named_input_connection_points=s,this.setMinCount(0),this.setMaxCount(this._named_input_connection_points.length),this._initGraphNodeInputs(),this.node.emit(_n.NAMED_INPUTS_UPDATED)}hasNamedInputs(){return this._has_named_inputs}namedInputConnectionPoints(){return this._named_input_connection_points}_initGraphNodeInputs(){for(let e=0;e<this._maxInputsCount;e++)this._graphNodeInputs[e]=this._graphNodeInputs[e]||this._createGraphNodeInput(e)}_createGraphNodeInput(e){const t=new _r(this.node.scene(),`input_${e}`);return this.graphNode().addGraphInput(t,!1),t}graphNode(){return this._graphNode=this._graphNode||this._createGraphNode()}_createGraphNode(){const e=new _r(this.node.scene(),"inputs");return this.node.addGraphInput(e,!1),e}maxInputsCount(){return this._maxInputsCount||0}maxInputsCountOverriden(){return this._maxInputsCount!=this._maxInputsCountOnInput}inputGraphNode(e){return this._graphNodeInputs[e]}setCount(e,t){t==null&&(t=e),this.setMinCount(e),this.setMaxCount(t),this._initConnectionControllerInputs()}_initConnectionControllerInputs(){this.node.io.connections.initInputs()}isGraphNodeDirty(){var e;return((e=this._graphNode)==null?void 0:e.isDirty())||!1}_isAnyInputDirty(){for(const e of this._inputs)if(e&&e.isDirty())return!0;return!1}containersWithoutEvaluation(e){e.length=0;for(let t=0;t<this._inputs.length;t++){const r=this._inputs[t];let s=null;r&&(s=r.containerController.containerUnlessBypassed()),e.push(s)}return e}_existingInputIndices(e){if(e.length=0,this._maxInputsCount>0)for(let t=0;t<this._inputs.length;t++)this._inputs[t]&&e.push(t);return e}async evalRequiredInputs(e){var t;if(e.length=0,this.node.disposed()==!0)return e;if(this._maxInputsCount>0){if(this._existingInputIndices(Zc),Zc.length<this._minInputsCount)this.node.states.error.set("inputs are missing");else if(Zc.length>0){if(this._onEnsureListenToSingleInputIndexUpdatedCallback&&await this._onEnsureListenToSingleInputIndexUpdatedCallback(),this._maxInputsCount==1){const r=await this.evalRequiredInput(0);e.push(r)}else{const r=[];if(this._singleInputIndexListenedTo!=null)r.push(this.evalRequiredInput(this._singleInputIndexListenedTo));else{const i=Zc[Zc.length-1];for(let o=0;o<this._inputs.length;o++)this._inputs[o]?r.push(this.evalRequiredInput(o)):o<=i&&r.push(void 0)}const s=await Promise.all(r);for(const i of s)e.push(i)}this._isAnyInputDirty()||(t=this._graphNode)==null||t.removeDirtyState()}}return e}async evalRequiredInput(e){let t;const r=this.input(e);if(r&&(t=await r.compute(),this._graphNodeInputs[e].removeDirtyState()),!(t&&t.coreContent())){if(r){const s=r.states.error.message();s&&this.node.disposed()==!1&&this.node.states.error.set(`input ${e} is invalid (error: ${s})`)}}return t}getNamedInputIndex(e){var t;if(this._named_input_connection_points){for(let r=0;r<this._named_input_connection_points.length;r++)if(((t=this._named_input_connection_points[r])==null?void 0:t.name())==e)return r}return-1}getInputIndex(e){if(Ke(e)){if(this.hasNamedInputs())return this.getNamedInputIndex(e);throw new Error(`node ${this.node.path()} has no named inputs`)}else return e}setInput(e,t,r,s){if(((s==null?void 0:s.ignoreLockedState)||!1)==!1&&this.node.insideALockedParent()){const p=this.node.lockedParent();console.warn(`node '${this.node.path()}' cannot have its inputs changed, since it is inside '${p?p.path():""}', which is locked`);return}r==null&&(r=0);const o=(s==null?void 0:s.noExceptionOnInvalidInput)||!1,a=this.getInputIndex(e)||0;if(a<0){const p=`invalid input (${e}) for node ${this.node.path()}`;if(o)return;throw console.warn(p),new Error(p)}let c=0;if(t){if(t.io.outputs.hasNamedOutputs()&&(c=t.io.outputs.getOutputIndex(r),c==null||c<0)){const g=t.io.outputs.namedOutputConnectionPoints(),f=g?g.map(m=>m.name()):[];console.warn(`node ${t.path()} does not have an output named ${r}. inputs are: ${f.join(", ")}`);return}const p=t.parent(),_=this.node.parent();if(!(p&&_&&p.graphNodeId()==_.graphNodeId())){console.warn(`node ${t.path()} does not have the same parent as ${this.node.path()}`);return}}const l=this._graphNodeInputs[a];if(l==null){const p=`no input at index ${a} (name: ${e}) for node '${this.node.name()}' at path '${this.node.path()}'`;throw console.warn(p),new Error(p)}if(t&&this.node.parent()!=t.parent())return;const u=this._inputs[a];let h=null,d;this.node.io.connections&&(d=this.node.io.connections.inputConnection(a)),d&&(h=d.outputIndex()),(t!==u||c!=h)&&(u!=null&&this._depends_on_inputs&&l.removeGraphInput(u),t!=null?l.addGraphInput(t)?(this._depends_on_inputs||l.removeGraphInput(t),d&&d.disconnect({setInput:!1}),this._inputs[a]=t,new RR(t,this.node,c,a)):console.warn(`cannot connect ${t.path()} to ${this.node.path()}`):(this._inputs[a]=null,d&&d.disconnect({setInput:!1})),this._run_on_set_input_hooks(),l.setSuccessorsDirty(),this.node.emit(_n.INPUTS_UPDATED))}input(e){return this._inputs[e]}named_input(e){if(this.hasNamedInputs()){const t=this.getInputIndex(e);return this._inputs[t]}else return null}named_input_connection_point(e){if(this.hasNamedInputs()&&this._named_input_connection_points){const t=this.getInputIndex(e);return this._named_input_connection_points[t]}}has_named_input(e){return this.getNamedInputIndex(e)>=0}hasInput(e){return this._inputs[e]!=null}inputs(){return this._inputs}initInputsClonedState(e){this._clonedStatesController||(this._clonedStatesController=new T5(this),this._clonedStatesController.initInputsClonedState(e))}overrideClonedStateAllowed(){var e;return((e=this._clonedStatesController)==null?void 0:e.overrideClonedStateAllowed())||!1}overrideClonedState(e){var t;(t=this._clonedStatesController)==null||t.overrideClonedState(e)}clonedStateOverriden(){var e;return((e=this._clonedStatesController)==null?void 0:e.overriden())||!1}cloneRequired(e){var t;const r=(t=this._clonedStatesController)==null?void 0:t.cloneRequiredState(e);return r??!0}cloneRequiredStates(){var e;const t=(e=this._clonedStatesController)==null?void 0:e.cloneRequiredStates();return t??!0}_updateCloneRequiredState(){var e;(e=this._clonedStatesController)==null||e.updateCloneRequiredState()}add_on_set_input_hook(e,t){this._on_update_hooks=this._on_update_hooks||[],this._on_update_hook_names=this._on_update_hook_names||[],this._on_update_hook_names.includes(e)?console.warn(`hook with name ${e} already exists`,this.node):(this._on_update_hooks.push(t),this._on_update_hook_names.push(e))}_run_on_set_input_hooks(){if(this._on_update_hooks)for(const e of this._on_update_hooks)e()}}const oE=[],vm=[];class R5{constructor(e){this.node=e,this._has_outputs=!1,this._has_named_outputs=!1,this._connections=[],this._onPlayingStateChangeBound=this._onPlayingStateChange.bind(this),this._outputIndexCache=new Map,this.node.scene().timeController.onPlayingStateChange(this._onPlayingStateChangeBound)}_onPlayingStateChange(){this._clearCache()}_clearCache(){this._outputIndexCache.clear()}dispose(){this.node.scene().timeController.removeOnPlayingStateChange(this._onPlayingStateChangeBound),this._named_output_connection_points&&this._named_output_connection_points.splice(0,this._named_output_connection_points.length)}setHasOneOutput(){this._has_outputs=!0}setHasNoOutput(){this._has_outputs=!1}hasOutputs(){return this._has_outputs}hasNamedOutputs(){return this._has_named_outputs}hasNamedOutput(e){return this.getNamedOutputIndex(e)>=0}namedOutputConnectionPoints(){return this._named_output_connection_points}namedOutputConnection(e){if(this._named_output_connection_points)return this._named_output_connection_points[e]}getNamedOutputIndex(e){if(this._named_output_connection_points){let t=0;for(const r of this._named_output_connection_points){if(r&&r.name()==e)return t;t++}}return-1}getOutputIndex(e){let t=this._outputIndexCache.get(e);return t==null&&(t=this._getOutputIndex(e),this._outputIndexCache.set(e,t)),t}_getOutputIndex(e){return e!=null?Ke(e)?this.hasNamedOutputs()?this.getNamedOutputIndex(e):(console.warn(`node ${this.node.path()} has no named outputs`),-1):e:-1}namedOutputConnectionPointsByName(e){if(this._named_output_connection_points){for(const t of this._named_output_connection_points)if((t==null?void 0:t.name())==e)return t}}setNamedOutputConnectionPoints(e,t=!0){this._has_named_outputs=!0,this.node.io.connections.outputConnections(this._connections);for(const r of this._connections)r&&r.outputIndex()>=e.length&&r.disconnect({setInput:!0});this._named_output_connection_points=e,t&&this.node.scene()&&this.node.setDirty(this.node),this.node.emit(_n.NAMED_OUTPUTS_UPDATED)}used_output_names(){var e;const t=[],r=this.node.io.connections;if(r){r.outputConnections(this._connections),Zs(this._connections.map(i=>i?i.outputIndex():null),oE),vm.length=0;for(const i of oE)Ye(i)&&vm.push(i);const s=this.namedOutputConnectionPoints();if(s)for(const i of vm){const o=(e=s[i])==null?void 0:e.name();o&&t.push(o)}}return t}}class w5{constructor(e){this._node=e,this._outputConnections=new Map}initInputs(){const e=this._node.io.inputs.maxInputsCount();for(this._inputConnections=this._inputConnections||new Array(e);this._inputConnections.length<e;)this._inputConnections.push(void 0)}dispose(){this._inputConnections&&this._inputConnections.splice(0,this._inputConnections.length),this._outputConnections&&this._outputConnections.clear()}addInputConnection(e){this._inputConnections?this._inputConnections[e.inputIndex()]=e:console.warn("input connections array not initialized")}removeInputConnection(e){if(this._inputConnections)if(e.inputIndex()<this._inputConnections.length){this._inputConnections[e.inputIndex()]=void 0;let t=!0;for(let r=e.inputIndex();r<this._inputConnections.length;r++)this._inputConnections[r]&&(t=!1);t&&(this._inputConnections=this._inputConnections.slice(0,e.inputIndex()))}else console.warn(`attempt to remove an input connection at index ${e.inputIndex()}`);else console.warn("input connections array not initialized")}inputConnection(e){if(this._inputConnections)return this._inputConnections[e]}firstInputConnection(){if(this._inputConnections){for(const e of this._inputConnections)if(e)return e}return null}inputConnections(){return this._inputConnections}existingInputConnections(){const e=this._inputConnections;if(e)for(;e.length>1&&e[e.length-1]===void 0;)e.pop();return e}addOutputConnection(e){const t=e.outputIndex(),r=e.id();let s=this._outputConnections.get(t);s||(s=new Map,this._outputConnections.set(t,s)),s.set(r,e)}removeOutputConnection(e){const t=e.outputIndex(),r=e.id();let s=this._outputConnections.get(t);s&&s.delete(r)}outputConnectionsByOutputIndex(e){return this._outputConnections.get(e)}outputConnections(e){return e.length=0,this._outputConnections.forEach((t,r)=>{t.forEach((s,i)=>{s&&e.push(s)})}),e}}class O5{constructor(e){this._node=e}set_in(e){this._in=e}set_out(e){this._out=e}clear(){this._in=void 0,this._out=void 0}in(){return this._in}out(){return this._out}}var xt=(n=>(n.BOOL="bool",n.INT="int",n.FLOAT="float",n.MAT3="mat3",n.MAT4="mat4",n.VEC2="vec2",n.VEC3="vec3",n.VEC4="vec4",n.SAMPLER_2D="sampler2D",n.SAMPLER_2D_ARRAY="sampler2DArray",n.SAMPLER_3D="sampler3D",n.SAMPLER_CUBE="samplerCube",n.SSS_MODEL="SSSModel",n.SDF_CONTEXT="SDFContext",n.SDF_MATERIAL="SDFMaterial",n))(xt||{});const P5={bool:J.BOOLEAN,int:J.INTEGER,float:J.FLOAT,vec2:J.VECTOR2,vec3:J.VECTOR3,vec4:J.VECTOR4,mat3:J.BUTTON,mat4:J.BUTTON,sampler2D:J.RAMP,sampler2DArray:J.RAMP,sampler3D:J.RAMP,samplerCube:J.RAMP,SSSModel:J.STRING,SDFContext:J.STRING,SDFMaterial:J.STRING},N5={[J.BOOLEAN]:"bool",[J.COLOR]:"vec3",[J.INTEGER]:"int",[J.FLOAT]:"float",[J.FOLDER]:void 0,[J.VECTOR2]:"vec2",[J.VECTOR3]:"vec3",[J.VECTOR4]:"vec4",[J.BUTTON]:void 0,[J.PARAM_PATH]:void 0,[J.NODE_PATH]:void 0,[J.RAMP]:void 0,[J.STRING]:void 0},I5={bool:!1,int:0,float:0,vec2:[0,0],vec3:[0,0,0],vec4:[0,0,0,0],mat3:null,mat4:null,sampler2D:vs.DEFAULT_VALUE_JSON,sampler2DArray:vs.DEFAULT_VALUE_JSON,sampler3D:vs.DEFAULT_VALUE_JSON,samplerCube:vs.DEFAULT_VALUE_JSON,SSSModel:"SSSModel()",SDFContext:"DefaultSDFContext()",SDFMaterial:"DefaultSDFMaterial()"},Jc={bool:1,int:1,float:1,vec2:2,vec3:3,vec4:4,mat3:9,mat4:16,sampler2D:1,sampler2DArray:1,sampler3D:1,samplerCube:1,SSSModel:1,SDFContext:1,SDFMaterial:1};class D5 extends Iv{constructor(e,t,r){super(e,t),this._name=e,this._type=t,this._init_value=r,this._init_value=this._init_value||I5[this._type]}type(){return this._type}are_types_matched(e,t){return e==t}get param_type(){return P5[this._type]}get init_value(){return this._init_value}toJSON(){return this._json=this._json||this._createJSON()}_createJSON(){return{name:this._name,type:this._type}}}var Ml=(n=>(n.BASE="base",n.DRAG="drag",n.KEYBOARD="keyboard",n.MOUSE="mouse",n.POINTER="pointer",n))(Ml||{});class yd extends Iv{constructor(e,t,r){super(e,t),this._name=e,this._type=t,this._event_listener=r}type(){return this._type}get param_type(){return J.FLOAT}are_types_matched(e,t){return t=="base"?!0:e==t}get event_listener(){return this._event_listener}toJSON(){return this._json=this._json||this._createJSON()}_createJSON(){return{name:this._name,type:this._type,isArray:!1}}}const L5={[be.ANIM]:void 0,[be.AUDIO]:void 0,[be.COP]:void 0,[be.EVENT]:Ml.BASE,[be.GL]:xt.FLOAT,[be.JS]:wn.FLOAT,[be.MANAGER]:void 0,[be.MAT]:void 0,[be.OBJ]:void 0,[be.POST]:void 0,[be.ROP]:void 0,[be.SOP]:void 0};function wR(n,e,t){switch(n){case be.EVENT:return new yd(e,t);case be.GL:return new D5(e,t);case be.JS:return new x4(e,t);default:return}}function F5(n){switch(n){case be.EVENT:return;case be.GL:return N5;case be.JS:return v4;default:return}}class U5{constructor(e,t){this.node=e,this._context=t,this._raw_input_serialized_by_param_name=new Map,this._default_value_serialized_by_param_name=new Map,this._initialized=!1}initializeNode(){if(this._initialized){console.warn("already initialized",this.node);return}this._initialized=!0,this.node.params.onParamsCreated("createInputsFromParams",this._createInputsFromParams.bind(this))}initialized(){return this._initialized}_createInputsFromParams(){const e=F5(this._context);if(!e)return;const t=[];for(const r of this.node.params.names){let s=!0;if(this._inputlessParamNames&&this._inputlessParamNames.length>0&&this._inputlessParamNames.includes(r)&&(s=!1),s&&this.node.params.has(r)){const i=this.node.params.get(r);if(i&&!i.parentParam()){const o=e[i.type()];if(o){const a=wR(this._context,i.name(),o);a&&t.push(a)}}}}this.node.io.inputs.setNamedInputConnectionPoints(t)}setInputlessParamNames(e){return this._inputlessParamNames=e}createSpareParameters(){if(this.node.scene().loadingController.isLoading())return;const e=this.node.params.spare_names,t={};for(const s of e)if(this.node.params.has(s)){const i=this.node.params.get(s);i&&(this._raw_input_serialized_by_param_name.set(s,i.rawInputSerialized()),this._default_value_serialized_by_param_name.set(s,i.defaultValueSerialized()),t.namesToDelete=t.namesToDelete||[],t.namesToDelete.push(s))}const r=this.node.io.inputs.namedInputConnectionPoints();if(r){let s=0;for(const i of r){if(i){const o=this.node.io.inputs.input(s)!=null,a=i.name(),c=i.param_type;if(c){let l=i.init_value;const u=this._default_value_serialized_by_param_name.get(a);let h=this.node.paramDefaultValue(a);if(h!=null?l=h:u!=null?l=u:l=i.init_value,_t(i.init_value))if(Ye(l)){const d=new Array(i.init_value.length);d.fill(l),l=d}else _t(l)&&l.length==i.init_value.length&&u!=null&&(l=i.init_value);l!=null&&c!=J.BUTTON&&(t.toAdd=t.toAdd||[],t.toAdd.push({name:a,type:c,initValue:Vd(l),rawInput:Vd(l),options:{spare:!0,editable:!o,computeOnDirty:c!=J.PARAM_PATH,dependentOnFoundParam:!1}}))}}s++}}this.node.params.updateParams(t);for(const s of this.node.params.spare)if(!s.parentParam()){const i=this._raw_input_serialized_by_param_name.get(s.name());i&&s.set(i)}}}function Vh(n,e){if(n.length!=e.length)return!1;for(let t=0;t<n.length;t++)if(n[t]!=e[t])return!1;return!0}class k5{constructor(e,t){this.node=e,this._context=t,this._create_spare_params_from_inputs=!0,this._functions_overridden=!1,this._input_name_function=r=>`in${r}`,this._output_name_function=r=>r==0?"val":`val${r}`,this._expected_input_types_function=()=>{const r=this.first_input_connection_type()||this.default_connection_type();return[r,r]},this._expected_output_types_function=()=>[this._expected_input_types_function()[0]],this._update_signature_if_required_bound=this.update_signature_if_required.bind(this),this._initialized=!1,this._successorsCopy=[],this._spare_params_controller=new U5(this.node,this._context)}default_connection_type(){return L5[this._context]}createConnectionPoint(e,t){return wR(this._context,e,t)}functions_overridden(){return this._functions_overridden}initialized(){return this._initialized}set_create_spare_params_from_inputs(e){this._create_spare_params_from_inputs=e}set_input_name_function(e){this._initialize_if_required(),this._input_name_function=e}set_output_name_function(e){this._initialize_if_required(),this._output_name_function=e}set_expected_input_types_function(e){this._initialize_if_required(),this._functions_overridden=!0,this._expected_input_types_function=e}set_expected_output_types_function(e){this._initialize_if_required(),this._functions_overridden=!0,this._expected_output_types_function=e}input_name(e){return this._wrapped_input_name_function(e)}output_name(e){return this._wrapped_output_name_function(e)}initializeNode(){if(this._initialized){console.warn("already initialized",this.node);return}this._initialized=!0,this.node.io.inputs.add_on_set_input_hook("_update_signature_if_required",this._update_signature_if_required_bound),this.node.params.addOnSceneLoadHook("_update_signature_if_required",this._update_signature_if_required_bound),this.node.params.onParamsCreated("_update_signature_if_required_bound",this._update_signature_if_required_bound),this.node.addPostDirtyHook("_update_signature_if_required",this._update_signature_if_required_bound),this._spare_params_controller.initialized()||this._spare_params_controller.initializeNode()}_initialize_if_required(){this._initialized||this.initializeNode()}get spare_params(){return this._spare_params_controller}update_signature_if_required(){(!this.node.lifecycle.creationCompleted()||!this._inputsOutputsMatchExpectations())&&(this.update_connection_types(),this.node.removeDirtyState(),this.node.scene().loadingController.isLoading()||this.make_successors_update_signatures())}make_successors_update_signatures(){const e=this.node.graphAllSuccessors();if(Ts(e,this._successorsCopy),this.node.childrenAllowed()){const t=this.node.nodesByType(V_.INPUT),r=this.node.nodesByType(V_.OUTPUT);for(const s of t)this._successorsCopy.push(s);for(const s of r)this._successorsCopy.push(s)}for(const t of this._successorsCopy){const r=t;r.io&&r.io.has_connection_points_controller&&r.io.connection_points.initialized()&&r.io.connection_points.update_signature_if_required()}}update_connection_types(){const t=this._wrapped_expected_input_types_function(),r=this._wrapped_expected_output_types_function(),s=[];for(let o=0;o<t.length;o++){const a=t[o],c=this.createConnectionPoint(this._wrapped_input_name_function(o),a);s.push(c)}const i=[];for(let o=0;o<r.length;o++){const a=r[o],c=this.createConnectionPoint(this._wrapped_output_name_function(o),a);i.push(c)}this.node.io.inputs.setNamedInputConnectionPoints(s),this.node.io.outputs.setNamedOutputConnectionPoints(i,!1),this._create_spare_params_from_inputs&&this._spare_params_controller.createSpareParameters()}_inputsOutputsMatchExpectations(){const e=this.node.io.inputs.namedInputConnectionPoints(),t=this.node.io.outputs.namedOutputConnectionPoints();if(!(e&&t))return!1;const r=Vh(e.filter(a=>!(a!=null&&a.inNodeDefinition())).map(a=>a==null?void 0:a.type()),this._wrapped_expected_input_types_function()),s=Vh(t.map(a=>a==null?void 0:a.type()),this._wrapped_expected_output_types_function()),i=Vh(e.filter(a=>!(a!=null&&a.inNodeDefinition())).map(a=>a==null?void 0:a.name()),e.filter(a=>!(a!=null&&a.inNodeDefinition())).map((a,c)=>this._wrapped_input_name_function(c))),o=Vh(t.map(a=>a==null?void 0:a.name()),t.map((a,c)=>this._wrapped_output_name_function(c)));return r&&s&&i&&o}_wrapped_expected_input_types_function(){if(this.node.scene().loadingController.isLoading()){const e=this.node.io.saved_connection_points_data.in();if(e)return e.map(t=>t.type)}return this._expected_input_types_function()}_wrapped_expected_output_types_function(){if(this.node.scene().loadingController.isLoading()){const e=this.node.io.saved_connection_points_data.out();if(e)return e.map(t=>t.type)}return this._expected_output_types_function()}_wrapped_input_name_function(e){if(this.node.scene().loadingController.isLoading()){const t=this.node.io.saved_connection_points_data.in();if(t)return t[e].name}return this._input_name_function(e)}_wrapped_output_name_function(e){if(this.node.scene().loadingController.isLoading()){const t=this.node.io.saved_connection_points_data.out();if(t)return t[e].name}return this._output_name_function(e)}first_input_connection_type(){return this.input_connection_type(0)}input_connection_type(e){const t=this.node.io.connections.inputConnections();if(!t)return;const r=t[e];if(!r)return;const s=r.srcConnectionPoint();if(s)return s.type()}}class B5{constructor(e){this.node=e,this._connections=new w5(this.node)}dispose(){this.inputs.dispose(),this.outputs.dispose(),this.connections.dispose()}get connections(){return this._connections}get inputs(){return this._inputs=this._inputs||new M5(this.node)}hasInputs(){return this._inputs!=null}get outputs(){return this._outputs=this._outputs||new R5(this.node)}has_outputs(){return this._outputs!=null}get connection_points(){return this._connection_points=this._connection_points||new k5(this.node,this.node.context())}get has_connection_points_controller(){return this._connection_points!=null}get saved_connection_points_data(){return this._saved_connection_points_data=this._saved_connection_points_data||new O5(this.node)}clear_saved_connection_points_data(){this._saved_connection_points_data&&(this._saved_connection_points_data.clear(),this._saved_connection_points_data=void 0)}}class G5{constructor(){}}const V5="default";class rs extends _r{constructor(e,t="BaseNode",r){super(e,t),this.createOptions=r,this.containerController=new QW(this),this.pv=new E5,this.p=new G5,this._initialized=!1;const s=r==null?void 0:r.serializerClass;s&&(this._serializer=new s(this))}copy_param_values(e){const t=this.params.non_spare;for(const r of t){const s=e.params.get(r.name());s&&r.copyValue(s)}}dataType(){return V5}get parentController(){return this._parentController=this._parentController||new dW(this)}static displayedInputNames(){}displayedInputNames(){return this.constructor.displayedInputNames()}childrenControllerContext(){return this._childrenControllerContext}_create_childrenController(){if(this._childrenControllerContext)return new vW(this,this._childrenControllerContext)}get childrenController(){return this._childrenController=this._childrenController||this._create_childrenController()}childrenAllowed(){return this._childrenControllerContext!=null}sceneReadonly(){return!1}get uiData(){return this._uiData=this._uiData||new tW(this)}get states(){return this._states=this._states||new hW(this)}get lifecycle(){return this._lifecycle=this._lifecycle||new yW(this)}get serializer(){return this._serializer}get cookController(){return this._cookController=this._cookController||new s5(this)}get io(){return this._io=this._io||new B5(this)}get nameController(){return this._nameController=this._nameController||new AR(this)}setName(e){this.nameController.setName(e)}_setCoreName(e){this._name=e}get params(){return this._paramsController=this._paramsController||new C5(this)}initializeBaseAndNode(){var e;this._initialized?console.warn("node already initialized"):(this._initialized=!0,(e=this.displayNodeController)==null||e.initializeNode(),this.initializeBaseNode(),this.initializeNode(),this.polyNodeController&&this.polyNodeController.initializeNode())}initializeBaseNode(){}initializeNode(){}static type(){throw"type to be overriden"}type(){return this.constructor.type()}static context(){throw console.error("node has no node_context",this),"context requires override"}context(){return this.constructor.context()}static requireWebGL2(){return!1}requireWebGL2(){return this.constructor.requireWebGL2()}setParent(e){this.parentController.setParent(e)}parent(){return this.parentController.parent()}insideALockedParent(){return this.lockedParent()!=null}lockedOrInsideALockedParent(){var e;return((e=this.polyNodeController)==null?void 0:e.locked())||this.insideALockedParent()}selfOrLockedParent(){var e;return(e=this.polyNodeController)!=null&&e.locked()?this:this.lockedParent()}lockedParent(){const e=this.parent();return e?e.polyNodeController&&e.polyNodeController.locked()?e:e.lockedParent():null}firstAncestorWithContext(e){return this.parentController.firstAncestorWithContext(e)}root(){return this._scene.root()}path(e){return this.parentController.path(e)}createParams(){}addParam(e,t,r,s){var i;return(i=this._paramsController)==null?void 0:i.addParam(e,t,r,s)}paramDefaultValue(e){return null}cook(e){return null}onCookEnd(e,t){this.cookController.registerOnCookEnd(e,t)}async compute(){var e,t;return this.isDirty()||(t=(e=this.flags)==null?void 0:e.bypass)!=null&&t.active()?await this.containerController.compute():this.containerController.container()}_setContainer(e){this.containerController.container().set_content(e),this.cookController.endCook()}createNode(e,t){var r;return(r=this.childrenController)==null?void 0:r.createNode(e,t)}createOperationContainer(e,t,r){var s;return(s=this.childrenController)==null?void 0:s.createOperationContainer(e,t,r)}removeNode(e){var t;(t=this.childrenController)==null||t.removeNode(e)}dispose(){super.dispose(),this.setParent(null),this._nameController&&(this._nameController.dispose(),this._nameController=void 0),this._io&&(this._io.dispose(),this._io=void 0),this._lifecycle&&(this._lifecycle.dispose(),this._lifecycle=void 0),this.displayNodeController&&this.displayNodeController.dispose(),this._childrenController&&(this._childrenController.dispose(),this._childrenController=void 0),this._paramsController&&(this._paramsController.dispose(),this._paramsController=void 0),this._cookController&&(this._cookController.dispose(),this._cookController=void 0),this._serializer&&(this._serializer.dispose(),this._serializer=void 0),this._uiData&&(this._uiData.dispose(),this._uiData=void 0)}children(){var e;return((e=this.childrenController)==null?void 0:e.children())||[]}node(e){var t;return((t=this.parentController)==null?void 0:t.findNode(e))||null}nodeSibling(e){var t;const r=this.parent();if(r){const s=(t=r.childrenController)==null?void 0:t.childByName(e);if(s)return s}return null}nodesByType(e){var t;return((t=this.childrenController)==null?void 0:t.nodesByType(e))||[]}setInput(e,t,r,s){this.io.inputs.setInput(e,t,r,s)}emit(e,t=null){this.scene().dispatchController.dispatch(this,e,t)}_eventsDispatcher(){return this.__eventsDispatcher=this.__eventsDispatcher||new Ms}dispatchEvent(e){this._eventsDispatcher().dispatchEvent(e)}addEventListener(e,t){this._eventsDispatcher().addEventListener(e,t)}removeEventListener(e,t){this._eventsDispatcher().removeEventListener(e,t)}toJSON(e=!1){if(this._serializer)return this._serializer.toJSON(e)}requiredModules(){}usedAssembler(){}integrationData(){}processError(e){return e}updateObjectOnAdd(e,t){}updateObjectOnRemove(e,t){}}function La(n,e){e(n);const t=n.children.length;for(let r=0;r<t;r++){const s=n.children[r];s&&La(s,e)}}class z5{static findOutputNodes(e){const t=e.nodesByType(Le.OUTPUT),r=e.nodesByType(Le.OUTPUT_AMBIENT_LIGHT),s=e.nodesByType(Le.OUTPUT_AREA_LIGHT),i=e.nodesByType(Le.OUTPUT_DIRECTIONAL_LIGHT),o=e.nodesByType(Le.OUTPUT_HEMISPHERE_LIGHT),a=e.nodesByType(Le.OUTPUT_POINT_LIGHT),c=e.nodesByType(Le.OUTPUT_SPOT_LIGHT);return t.concat(r).concat(s).concat(i).concat(o).concat(a).concat(c)}static findParamGeneratingNodes(e){var t;const r=[];return(t=e.childrenController)==null||t.traverseChildren(s=>{const i=s;i.paramsGenerating()&&r.push(i)},s=>s.childrenController?s.context()==be.GL&&s.childrenController.context==be.GL:s.context()==be.GL),r}static findAttributeExportNodes(e){return e.nodesByType(Le.ATTRIBUTE).filter(r=>r.isExporting())}}const H5="pointsCountFromObject",j5="corePrimitiveClassFactory",OR={[H5]:Su,[j5]:kv,ActorEvaluator:CR,computed:QU,ref:Pr,watch:GT},PR=Object.keys(OR),W5=PR.map(n=>OR[n]),X5="ActorCompilationController-DUMMY";function $5(){const n=new wt;return n.name=X5,n}const Kl=$5();class q5{constructor(e){this.node=e,this._evaluatorGenerator=new Pb(t=>new CR(this.node,t))}compileIfRequired(){var e;(e=this.node.assemblerController())!=null&&e.compileRequired()&&this.compile(),this._evaluatorGenerator.clearObjects()}evaluatorGenerator(){return this._evaluatorGenerator}functionData(){return this._functionData}_resetFunctionData(){this._functionData=void 0}updateFromFunctionData(e){this._functionData=e;const{functionBody:t,variableNames:r,variablesByName:s,functionNames:i,functionsByName:o,paramConfigs:a,eventDatas:c}=this._functionData,l=`
			try {
				${t}
			} catch(e) {
				console.log(e);
				_setErrorFromError(e)
				return null
			}`,u=f=>{this.node.states.error.set(f.message)},h=[],d=[];for(const f of r){const m=s[f];h.push(m)}for(const f of i){const m=o[f];d.push(m)}const p=a.map(f=>f.uniformName());a.forEach(f=>f.applyToNode(this.node));const _=[...PR,"_setErrorFromError",...r,...i,...p,l],g=()=>[...W5,u,...h.map(f=>f.clone()),...d];try{const f=new Function(..._),m=b=>{const x=f(...g());return new x(this.node,b)},y=new Pb(b=>{const x=m(b);return this.node.scene().dispatchController.processActorEvaluator(x)||x}),v=m(Kl);y.setExpectedEvaluatorMethodNames(v),y.eventDatas=y.eventDatas||new Set,gs(c,y.eventDatas),this._setEvaluatorGenerator(y)}catch(f){console.warn(f),console.log(`failed to compile actor node ${this.node.path()}`),console.log({functionData:e}),this.node.states.error.set("failed to compile")}}_setEvaluatorGenerator(e){this.node.scene().actorsManager.unregisterEvaluatorGenerator(this._evaluatorGenerator),this._evaluatorGenerator.clearObjects(),this._evaluatorGenerator=e,this.node.scene().actorsManager.registerEvaluatorGenerator(e)}compile(){const e=this.node.assemblerController();if(!e)return;this.node.states.error.clear(),e.assembler.updateFunction();const t=z5.findParamGeneratingNodes(this.node);try{const r=e.assembler.createFunctionData(t);if(!r){this._resetFunctionData();return}this.updateFromFunctionData(r),e.post_compile()}catch(r){console.log(r),this._resetFunctionData()}this._runOnCompilationCompletedCallbacks()}addOnCompilationCompleted(e){this._onCompilationCompletedCallbacks=this._onCompilationCompletedCallbacks||new Set,this._onCompilationCompletedCallbacks.add(e)}removeOnCompilationCompleted(e){this._onCompilationCompletedCallbacks&&(this._onCompilationCompletedCallbacks.delete(e),this._onCompilationCompletedCallbacks.size==0&&(this._onCompilationCompletedCallbacks=void 0))}_runOnCompilationCompletedCallbacks(){this._onCompilationCompletedCallbacks&&this._onCompilationCompletedCallbacks.forEach(e=>e())}}function NR(n){var e;return n.root().mainCameraController.cameraSync()||((e=n.viewersRegister.lastRenderedViewer())==null?void 0:e.camera())||n.root().mainCameraController.dummyPerspectiveCamera()}const Y5=`varying vec2 vUv;

void main() {
	vUv = uv;
	gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}`,K5=`#include <packing>

varying vec2 vUv;
uniform sampler2D tDiffuse;
uniform sampler2D tDepth;
uniform float cameraNear;
uniform float cameraFar;


float readDepth( sampler2D depthSampler, vec2 coord ) {
	float fragCoordZ = texture2D( depthSampler, coord ).x;
	float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );
	return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );
}

void main() {
	float alpha = texture2D( tDiffuse, vUv ).a;
	float depth = readDepth( tDepth, vUv );

	gl_FragColor.rgb = vec3( depth );
	gl_FragColor.a = alpha;
}`;function Z5(){const n=new kg(-1,1,1,-1,0,1),e=new Kn({vertexShader:Y5,fragmentShader:K5,uniforms:{cameraNear:{value:n.near},cameraFar:{value:n.far},tDiffuse:{value:null},tDepth:{value:null}}}),t=new fp(2,2),r=new Jt(t,e),s=new gu;return s.add(r),{scene:s,camera:n,material:e}}function J5(n,e,t){e.isPerspectiveCamera||e.isOrthographicCamera?(n.material.uniforms.cameraNear.value=e.near,n.material.uniforms.cameraFar.value=e.far,n.material.uniforms.tDiffuse.value=t.texture,n.material.uniforms.tDepth.value=t.depthTexture):console.warn("camera is not a PerspectiveCamera or OrthographicCamera")}function Q5(n,e){e.x=.5*(n.x+1),e.y=.5*(1-n.y)}function eX(){const n=new Gg(1,1);return n.type=Gi,n}class tX{constructor(){this._colorWriteRenderTarget=new Br(1,1,{minFilter:jt,magFilter:jt,format:fn,type:jn,colorSpace:xn,depthTexture:eX()}),this._depthReadRenderTarget=new Br(1,1,{minFilter:jt,magFilter:jt,format:fn,type:jn,colorSpace:xn}),this._renderScene=new gu,this._depthReadSetup=Z5(),this._restoreContext={object:{parent:null},renderer:{toneMapping:Fr,outputColorSpace:xn}},this._read=new Float32Array(4)}renderColor(e,t,r,s,i,o,a){return this._doRender(e,t,s,r,i,o,a,!1),a}renderDepth(e,t,r,s,i,o){return this._doRender(e,t,r,null,s,i,o,!0),o}_doRender(e,t,r,s,i,o,a,c){const l=e.renderersRegister.lastRegisteredRenderer();return l?l instanceof bs?(r==null&&(r=NR(e)),this._prepare(t,s,i,l),this._render(o,r,l,a,c),this._restore(t,l),a):(console.log("renderPixel: renderer found is not WebGLRenderer"),a):a}_prepare(e,t,r,s){this._restoreContext.renderer.outputColorSpace=s.outputColorSpace,this._restoreContext.renderer.toneMapping=s.toneMapping,this._restoreContext.object.parent=e.parent,this._renderScene.background=r,this._renderScene.overrideMaterial=t||null,this._renderScene.attach(e),s.toneMapping=Fr,s.outputColorSpace=xn}_render(e,t,r,s,i){t.setViewOffset(r.domElement.width,r.domElement.height,e.x*r.domElement.width,e.y*r.domElement.height,1,1),r.setRenderTarget(this._colorWriteRenderTarget),r.clear(),r.render(this._renderScene,t),i?(J5(this._depthReadSetup,t,this._colorWriteRenderTarget),r.setRenderTarget(this._depthReadRenderTarget),r.render(this._depthReadSetup.scene,this._depthReadSetup.camera),r.readRenderTargetPixels(this._depthReadRenderTarget,0,0,1,1,this._read)):r.readRenderTargetPixels(this._colorWriteRenderTarget,0,0,1,1,this._read),r.setRenderTarget(null),t.clearViewOffset(),s.fromArray(this._read)}_restore(e,t){var r;t.outputColorSpace=this._restoreContext.renderer.outputColorSpace,t.toneMapping=this._restoreContext.renderer.toneMapping,(r=this._restoreContext.object.parent)==null||r.attach(e)}}var Ur=(n=>(n[n.LEFT=0]="LEFT",n[n.MIDDLE=1]="MIDDLE",n[n.RIGHT=2]="RIGHT",n))(Ur||{}),Yr=(n=>(n[n.NONE=0]="NONE",n[n.LEFT=1]="LEFT",n[n.RIGHT=2]="RIGHT",n[n.LEFT_RIGHT=3]="LEFT_RIGHT",n[n.MIDDLE=4]="MIDDLE",n[n.LEFT_MIDDLE=5]="LEFT_MIDDLE",n[n.MIDDLE_RIGHT=6]="MIDDLE_RIGHT",n[n.LEFT_MIDDLE_RIGHT=7]="LEFT_MIDDLE_RIGHT",n))(Yr||{});function nX(n){for(const e of n)if(e.cpu!=null)return!0;return!1}function aE(n){for(const e of n)if(e.gpu!=null)return!0;return!1}function rX(n){for(const e of n)if(e.gpu!=null&&e.gpu.worldPosMaterial==null)return!0;return!1}function sX(n,e){return n.traverseChildren==e.traverseChildren&&n.pointsThreshold==e.pointsThreshold&&n.lineThreshold==e.lineThreshold}function iX(n){let e;for(const t of n)if(t.cpu!=null){if(e==null)e=t.cpu;else if(!sX(e,t.cpu))return!1}return!0}function oX(n,e){e.traverseChildren=!1,e.pointsThreshold=-1,e.lineThreshold=-1;for(const t of n)t.cpu!=null&&(e.traverseChildren==!1&&t.cpu.traverseChildren==!0&&(e.traverseChildren=t.cpu.traverseChildren),e.pointsThreshold<t.cpu.pointsThreshold&&(e.pointsThreshold=t.cpu.pointsThreshold),e.lineThreshold<t.cpu.lineThreshold&&(e.lineThreshold=t.cpu.lineThreshold));return e}function ym(n,e){switch(n){case 0:return e==!0;case 1:return!0;case 2:return e==!1}St.unreachable(n)}function Hp(n,e){return ym(n.modifier.ctrl,e.ctrl)&&ym(n.modifier.shift,e.shift)&&ym(n.modifier.alt,e.alt)}function wc(n,e){switch(e.button){case Ur.LEFT:{if(n.button.left==!1)return!1;break}case Ur.MIDDLE:{if(n.button.middle==!1)return!1;break}case Ur.RIGHT:{if(n.button.right==!1)return!1;break}}return Hp(n,e)}function IR(n,e){switch(e.buttons){case Yr.LEFT:{if(n.button.left==2||n.button.middle==0||n.button.right==0)return!1;break}case Yr.MIDDLE:{if(n.button.left==0||n.button.middle==2||n.button.right==0)return!1;break}case Yr.RIGHT:{if(n.button.left==0||n.button.middle==0||n.button.right==2)return!1;break}case Yr.LEFT_RIGHT:{if(n.button.left==2||n.button.middle==0||n.button.right==2)return!1;break}case Yr.LEFT_MIDDLE:{if(n.button.left==2||n.button.middle==2||n.button.right==0)return!1;break}case Yr.MIDDLE_RIGHT:{if(n.button.left==0||n.button.middle==2||n.button.right==2)return!1;break}case Yr.LEFT_MIDDLE_RIGHT:{if(n.button.left==2||n.button.middle==2||n.button.right==2)return!1;break}}return Hp(n,e)}function aX(n,e){for(const t of n)if(wc(t.config,e))return!0;return!1}function cX(n,e){for(const t of n)if(IR(t.config,e))return!0;return!1}function lX(n,e){for(const t of n)if(Hp(t.config,e))return!0;return!1}function Wo(n,e){e.button=n.button||Ur.LEFT,e.ctrl=n.ctrlKey,e.shift=n.shiftKey,e.alt=n.altKey}function Yv(n,e){e.buttons=n.buttons||Yr.LEFT,e.ctrl=n.ctrlKey,e.shift=n.shiftKey,e.alt=n.altKey}const cE={button:Ur.LEFT,ctrl:!1,shift:!1,alt:!1},qd={buttons:Yr.LEFT,ctrl:!1,shift:!1,alt:!1};function Mu(n,e,t,r){r.length=0,Wo(n,cE);for(const s of e){const i=t.get(s);i&&aX(i,cE)&&r.push(s)}}function uX(n,e,t,r){r.length=0,Yv(n,qd);for(const s of e){const i=t.get(s);i&&cX(i,qd)&&r.push(s)}}function hX(n,e,t,r){r.length=0,Yv(n,qd);for(const s of e){const i=t.get(s);i&&lX(i,qd)&&r.push(s)}}const xm={pointsThreshold:.1,lineThreshold:.1},dX={traverseChildren:!1,pointsThreshold:.1,lineThreshold:.1,intersectionRef:Pr(null)};function pX(n,e){return n.distance-e.distance}const bm=new W,so=new We,fX=new T,lE=new T,uE=new T,Cm=new T;class ii{constructor(e){this.actorsManager=e,this._objects=[],this._propertiesListByObject=new Map,this._intersectsByObject=new WeakMap,this._closestIntersects=new Map,this._objectByClosestIntersect=new Map,this._closestIntersectsSorted=[],this._renderPixelController=new tX,this._scene=e.scene}objects(e){Ts(this._objects,e)}_setIntersectedState(e,t){if(e.length==0)return;this._closestIntersects.clear(),this._objectByClosestIntersect.clear();const r=this._scene.eventsDispatcher.pointerEventsController,s=r.raycaster().value;r.updateRaycast(xm);const i=this._gpuObjectsPresent(),o=i==!0?NR(this._scene):null;if(i==!0&&o){const c=r.cursor().value;Q5(c,bm),this._gpuDepthBufferReadRequired()&&(fX.copy(s.ray.direction).normalize(),lE.set(c.x,c.y,-1).unproject(o),uE.set(c.x,c.y,1).unproject(o))}for(const c of e){t.set(c,!1);const l=this._propertiesListByObject.get(c),u=this._intersectsByObject.get(c);if(l&&u){if(u.length=0,nX(l)){const h=iX(l)?l[0].cpu:oX(l,dX);xm.pointsThreshold=h.pointsThreshold,xm.lineThreshold=h.lineThreshold,s.intersectObject(c,h.traverseChildren,u);const d=u[0];this._closestIntersects.set(c,d),d&&this._objectByClosestIntersect.set(d,c)}if(aE(l)){const h=l[0].gpu;if(h&&o){const d=h.worldPosMaterial;if(d!=null?this._renderPixelController.renderColor(this._scene,c,h.worldPosMaterial,o,null,bm,so):this._renderPixelController.renderDepth(this._scene,c,o,null,bm,so),so.w>0){d?Cm.set(so.x,so.y,so.z):Cm.copy(lE).lerp(uE,so.x);const _={distance:Cm.distanceTo(s.ray.origin)};this._closestIntersects.set(c,_),_&&this._objectByClosestIntersect.set(_,c)}else this._closestIntersects.set(c,void 0)}}}}this._closestIntersectsSorted.length=0;for(const c of e){const l=this._closestIntersects.get(c);l&&this._closestIntersectsSorted.push(l);const u=this._propertiesListByObject.get(c);if(u)for(const h of u){const d=h.cpu;if(d)d.intersectionRef.value=l||null;else{const p=h.gpu;p&&(p.distanceRef.value=l?l.distance:-1)}}}this._closestIntersectsSorted.sort(pX);let a=!1;for(const c of this._closestIntersectsSorted){const l=this._objectByClosestIntersect.get(c);if(l){const u=this._propertiesListByObject.get(l);if(u){let h=!1;for(const d of u)(a==!1||d.priority.skipIfObjectsInFront==!0)&&t.set(l,!0),d.priority.blockObjectsBehind==!0&&(h=!0);a=h}}}this._objectByClosestIntersect.clear()}_gpuObjectsPresent(){const e=this._objects;for(const t of e){const r=this._propertiesListByObject.get(t);if(r&&aE(r))return!0}return!1}_gpuDepthBufferReadRequired(){const e=this._objects;for(const t of e){const r=this._propertiesListByObject.get(t);if(r&&rX(r))return!0}return!1}addPropertiesForObject(e,t){if(e==Kl)return;dr(this._propertiesListByObject,e,t),this._objects.indexOf(e)<0&&(this._objects.push(e),this._intersectsByObject.set(e,[]))}removePropertiesForObject(e,t){if(e==Kl)return;const r=this._propertiesListByObject.get(e);if(r){const s=r.indexOf(t);if(r.splice(s,1),r.length==0){const i=this._objects.indexOf(e);i>=0&&(this._objects.splice(i,1),this._intersectsByObject.delete(e),this._propertiesListByObject.delete(e))}}}}class mX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateByObject=new Map}process(){this._setIntersectedState(this._objects,this._intersectedStateByObject);const e=this._objects;for(const t of e){const r=this._propertiesListByObject.get(t);if(r)for(const s of r){const i=s.hover.hoveredStateRef.value,o=this._intersectedStateByObject.get(t)||!1;o!=i&&(s.hover.hoveredStateRef.value=o,s.hover.onHoveredStateChange())}}}}const hE={button:Ur.LEFT,ctrl:!1,shift:!1,alt:!1};class _X extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateByObject=new Map,this._objectsMatchingEventConfig=[]}onPointerdown(e){if(Mu(e,this._objects,this._propertiesListByObject,this._objectsMatchingEventConfig),this._objectsMatchingEventConfig.length==0)return;this._setIntersectedState(this._objectsMatchingEventConfig,this._intersectedStateByObject),Wo(e,hE);const t=this._objects;for(const r of t){const s=this._propertiesListByObject.get(r);if(s&&this._intersectedStateByObject.get(r)==!0)for(const o of s)wc(o.config,hE)&&o.pointerdown.callback()}}}const dE={button:Ur.LEFT,ctrl:!1,shift:!1,alt:!1};class gX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateByObject=new Map,this._objectsMatchingEventConfig=[]}onPointerup(e){if(Mu(e,this._objects,this._propertiesListByObject,this._objectsMatchingEventConfig),this._objectsMatchingEventConfig.length==0)return;this._setIntersectedState(this._objectsMatchingEventConfig,this._intersectedStateByObject),Wo(e,dE);const t=this._objects;for(const r of t){const s=this._propertiesListByObject.get(r);if(s&&this._intersectedStateByObject.get(r)==!0)for(const o of s)wc(o.config,dE)&&o.pointerup.callback()}}}const pE=new W,Em=new W;class Kv{constructor(){this._lastCursorPosSet=!1,this._movedCursorDistance=0,this._lastCursorPos=new W,this._bound={pointermove:this._onPointermove.bind(this)}}addPointermoveEventListener(e){this.cursorRef=e,this._movedCursorDistance=0,this._lastCursorPosSet=!1,document.addEventListener("pointermove",this._bound.pointermove),document.addEventListener("touchmove",this._bound.pointermove)}removeEventListener(){document.removeEventListener("pointermove",this._bound.pointermove),document.removeEventListener("touchmove",this._bound.pointermove)}movedCursorDistance(){return this._movedCursorDistance}_onPointermove(){if(!this.cursorRef)return;const e=this.cursorRef.value;this._lastCursorPosSet==!1&&(this._lastCursorPos.copy(e),this._lastCursorPosSet=!0),Em.copy(e),pE.copy(Em).sub(this._lastCursorPos),this._movedCursorDistance+=pE.manhattanLength()/2,this._lastCursorPos.copy(Em)}}const fE={button:Ur.LEFT,ctrl:!1,shift:!1,alt:!1};function vX(n,e){for(const t of n)if(e<t.click.maxCursorMoveDistance)return!0;return!1}class yX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateOnPointerdownByObject=new Map,this._intersectedStateOnPointerupByObject=new Map,this._objectsMatchingEventConfig=[],this._objectsIntersectedOnPointerdown=[],this._cursorMoveMonitor=new Kv,this._pointerdownReceivedAt=0,this._bound={pointerup:this._onPointerup.bind(this)}}onPointerdown(e){this._pointerdownEvent=e,this._pointerdownReceivedAt=performance.now(),this._objects.length!=0&&(Mu(e,this._objects,this._propertiesListByObject,this._objectsMatchingEventConfig),this._objectsMatchingEventConfig.length!=0&&(document.addEventListener("pointerup",this._bound.pointerup),document.addEventListener("touchend",this._bound.pointerup),this._cursorMoveMonitor.addPointermoveEventListener(this._scene.eventsDispatcher.pointerEventsController.cursor()),this._setIntersectedState(this._objectsMatchingEventConfig,this._intersectedStateOnPointerdownByObject)))}_onPointerup(){document.removeEventListener("pointerup",this._bound.pointerup),document.removeEventListener("touchend",this._bound.pointerup),this._cursorMoveMonitor.removeEventListener();const e=this._pointerdownEvent;if(!e)return;this._pointerdownEvent=void 0;const t=performance.now()-this._pointerdownReceivedAt,r=this._cursorMoveMonitor.movedCursorDistance(),s=this._objectsMatchingEventConfig;this._objectsIntersectedOnPointerdown.length=0;for(const o of s){const a=this._propertiesListByObject.get(o);a&&vX(a,r)&&this._intersectedStateOnPointerdownByObject.get(o)&&this._objectsIntersectedOnPointerdown.push(o)}if(this._objectsIntersectedOnPointerdown.length==0)return;this._setIntersectedState(s,this._intersectedStateOnPointerupByObject),Wo(e,fE);const i=this._objectsIntersectedOnPointerdown;for(const o of i){const a=this._propertiesListByObject.get(o);if(a&&this._intersectedStateOnPointerupByObject.get(o)==!0)for(const l of a)r<l.click.maxCursorMoveDistance&&t<l.click.maxDuration&&wc(l.config,fE)&&l.click.callback()}}}const mE={buttons:Yr.LEFT,ctrl:!1,shift:!1,alt:!1};function xX(n,e){for(const t of n)if(e<t.click.maxCursorMoveDistance)return!0;return!1}class bX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateOnMousedownByObject=new Map,this._intersectedStateOnMouseupByObject=new Map,this._objectsMatchingEventConfig=[],this._objectsIntersectedOnMousedown=[],this._cursorMoveMonitor=new Kv,this._mousedownReceivedAt=0,this._bound={mouseup:this._onMouseup.bind(this)}}onMousedown(e){this._mousedownEvent=e,this._mousedownReceivedAt=performance.now(),this._objects.length!=0&&(uX(e,this._objects,this._propertiesListByObject,this._objectsMatchingEventConfig),this._objectsMatchingEventConfig.length!=0&&(document.addEventListener("mouseup",this._bound.mouseup),document.addEventListener("touchend",this._bound.mouseup),this._cursorMoveMonitor.addPointermoveEventListener(this._scene.eventsDispatcher.pointerEventsController.cursor()),this._setIntersectedState(this._objectsMatchingEventConfig,this._intersectedStateOnMousedownByObject)))}_onMouseup(){document.removeEventListener("mouseup",this._bound.mouseup),document.removeEventListener("touchend",this._bound.mouseup),this._cursorMoveMonitor.removeEventListener();const e=this._mousedownEvent;if(!e)return;this._mousedownEvent=void 0;const t=performance.now()-this._mousedownReceivedAt,r=this._cursorMoveMonitor.movedCursorDistance(),s=this._objectsMatchingEventConfig;this._objectsIntersectedOnMousedown.length=0;for(const o of s){const a=this._propertiesListByObject.get(o);a&&xX(a,r)&&this._intersectedStateOnMousedownByObject.get(o)&&this._objectsIntersectedOnMousedown.push(o)}if(this._objectsIntersectedOnMousedown.length==0)return;this._setIntersectedState(s,this._intersectedStateOnMouseupByObject),Yv(e,mE);const i=this._objectsIntersectedOnMousedown;for(const o of i){const a=this._propertiesListByObject.get(o);if(a&&this._intersectedStateOnMouseupByObject.get(o)==!0)for(const l of a)r<l.click.maxCursorMoveDistance&&t<l.click.maxDuration&&IR(l.config,mE)&&l.click.callback()}}}class CX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateByObject=new Map}onContextmenu(e){this._setIntersectedState(this._objects,this._intersectedStateByObject);const t=this._objects;for(const r of t){const s=this._propertiesListByObject.get(r);if(s&&this._intersectedStateByObject.get(r)==!0)for(const o of s)o.contextmenu.callback()}}}const _E={button:Ur.LEFT,ctrl:!1,shift:!1,alt:!1};function EX(n,e){for(const t of n)if(e<t.longPress.maxCursorMoveDistance)return!0;return!1}class SX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateOnPointerdownByObject=new Map,this._intersectedStateOnTimeoutByObject=new Map,this._objectsMatchingEventConfig=[],this._objectsByLongPressDuration=new Map,this._timerByDuration=new Map,this._cursorMoveMonitor=new Kv,this._bound={pointerup:this._onPointerup.bind(this)}}onPointerdown(e){if(this._objects.length==0||(Mu(e,this._objects,this._propertiesListByObject,this._objectsMatchingEventConfig),this._objectsMatchingEventConfig.length==0))return;document.addEventListener("pointerup",this._bound.pointerup),document.addEventListener("touchend",this._bound.pointerup),this._cursorMoveMonitor.addPointermoveEventListener(this._scene.eventsDispatcher.pointerEventsController.cursor()),this._objectsByLongPressDuration.clear(),this._timerByDuration.clear(),this._setIntersectedState(this._objectsMatchingEventConfig,this._intersectedStateOnPointerdownByObject),(()=>{const r=this._objects;for(const s of r){const i=this._propertiesListByObject.get(s);if(i&&this._intersectedStateOnPointerdownByObject.get(s)==!0)for(const a of i)dr(this._objectsByLongPressDuration,a.longPress.duration,s)}})(),Wo(e,_E),this._objectsByLongPressDuration.forEach((r,s)=>{const o=setTimeout(()=>{const a=this._cursorMoveMonitor.movedCursorDistance();this._timerByDuration.delete(s),this._setIntersectedState(this._objects,this._intersectedStateOnTimeoutByObject);for(const c of r){const l=this._propertiesListByObject.get(c);if(l&&EX(l,a)&&this._intersectedStateOnTimeoutByObject.get(c))for(const h of l)a<h.longPress.maxCursorMoveDistance&&wc(h.config,_E)&&h.longPress.callback()}},s);this._timerByDuration.set(s,o)})}_onPointerup(){document.removeEventListener("pointerup",this._bound.pointerup),document.removeEventListener("touchend",this._bound.pointerup),this._cursorMoveMonitor.removeEventListener(),this._timerByDuration.forEach((e,t)=>{clearTimeout(e)}),this._timerByDuration.clear()}}const zh=new W,gE={button:Ur.LEFT,ctrl:!1,shift:!1,alt:!1};function ll(n){return n>Math.PI&&(n-=Math.PI*2),XT(n)}ll(zh.set(-1,0).angle()),ll(zh.set(1,0).angle()),ll(zh.set(0,1).angle()),ll(zh.set(0,-1).angle());function AX(n,e){return e>=n.angle-n.angleMargin&&e<=n.angle+n.angleMargin}const Sm=new W;class TX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateOnPointerdownByObject=new Map,this._intersectedStateOnPointerupByObject=new Map,this._objectsMatchingEventConfig=[],this._objectsIntersectedOnPointerdown=[],this._cursorOnPointerdown=new W,this._cursorOnPointerup=new W,this._bound={pointerup:this._onPointerup.bind(this)}}onPointerdown(e){this._pointerdownEvent=e,this._objects.length!=0&&(Mu(e,this._objects,this._propertiesListByObject,this._objectsMatchingEventConfig),this._objectsMatchingEventConfig.length!=0&&(document.addEventListener("pointerup",this._bound.pointerup),document.addEventListener("touchend",this._bound.pointerup),this._setIntersectedState(this._objectsMatchingEventConfig,this._intersectedStateOnPointerdownByObject),this._getCursor(this._cursorOnPointerdown)))}_onPointerup(e){document.removeEventListener("pointerup",this._bound.pointerup),document.removeEventListener("touchend",this._bound.pointerup);const t=this._pointerdownEvent;if(!t)return;this._pointerdownEvent=void 0;const r=this._objects;this._objectsIntersectedOnPointerdown.length=0;for(const c of r)this._propertiesListByObject.get(c)&&this._intersectedStateOnPointerdownByObject.get(c)&&this._objectsIntersectedOnPointerdown.push(c);if(this._objectsIntersectedOnPointerdown.length==0)return;this._getCursor(this._cursorOnPointerup),Sm.copy(this._cursorOnPointerup).sub(this._cursorOnPointerdown);let s=Sm.angle();const i=ll(s),o=Sm.manhattanLength();this._setIntersectedState(r,this._intersectedStateOnPointerupByObject),Wo(t,gE);const a=this._objectsIntersectedOnPointerdown;for(const c of a){const l=this._propertiesListByObject.get(c);if(l&&this._intersectedStateOnPointerupByObject.get(c)==!0)for(const h of l)o>h.swipe.minDistance&&AX(h.swipe,i)&&wc(h.config,gE)&&h.swipe.callback()}}_getCursor(e){const r=this._scene.eventsDispatcher.pointerEventsController.cursor().value;e.copy(r)}}class DR{constructor(e){this.actorsManager=e,this._objects=[],this._propertiesListByObject=new Map,this._scene=e.scene}addPropertiesForObject(e,t){if(e==Kl)return;dr(this._propertiesListByObject,e,t),this._objects.indexOf(e)<0&&this._objects.push(e)}removePropertiesForObject(e,t){if(e==Kl)return;const r=this._propertiesListByObject.get(e);if(!r)return;const s=r.indexOf(t);if(r.splice(s,1),r.length==0){const i=this._objects.indexOf(e);i>=0&&(this._objects.splice(i,1),this._propertiesListByObject.delete(e))}}}class MX extends DR{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateByObject=new Map}onPointerdown(e){const t=this._objects;for(const r of t){const s=this._propertiesListByObject.get(r);if(s)for(const i of s)i.pointerdown.callback()}}}class RX extends DR{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateByObject=new Map}onPointerup(e){const t=this._objects;for(const r of t){const s=this._propertiesListByObject.get(r);if(s)for(const i of s)i.pointerup.callback()}}}const vE={button:Ur.LEFT,ctrl:!1,shift:!1,alt:!1};class wX extends ii{constructor(){super(...arguments),this._propertiesListByObject=new Map,this._intersectedStateOnDoubleClickByObject=new Map,this._objectsMatchingEventConfig=[]}onDoubleClick(e){if(this._objects.length!=0&&(hX(e,this._objects,this._propertiesListByObject,this._objectsMatchingEventConfig),this._objectsMatchingEventConfig.length!=0)){this._setIntersectedState(this._objectsMatchingEventConfig,this._intersectedStateOnDoubleClickByObject),Wo(e,vE);for(const t of this._objectsMatchingEventConfig){const r=this._propertiesListByObject.get(t);if(r&&this._intersectedStateOnDoubleClickByObject.get(t)==!0)for(const i of r)Hp(i.config,vE)&&i.doubleClick.callback()}}}}const yE="actorBuilderNodeIds",LR={[Le.ON_KEY]:"onTick",[Le.ON_KEYDOWN]:"onTick",[Le.ON_KEYPRESS]:"onTick",[Le.ON_KEYUP]:"onTick",[Le.ON_MAPBOX_CAMERA_MOVE]:"onTick",[Le.ON_MAPBOX_CAMERA_MOVE_START]:"onTick",[Le.ON_MAPBOX_CAMERA_MOVE_END]:"onTick",[Le.ON_OBJECT_ATTRIBUTE_UPDATE]:"onTick",onContextMenu:"onTick",[Le.ON_OBJECT_DISPATCH_EVENT]:"instant",onPointermove:"onTick",[Le.ON_PERFORMANCE_CHANGE]:"instant",[Le.ON_POINTERDOWN]:"onTick",[Le.ON_POINTERUP]:"onTick",[Le.ON_SCENE_PAUSE]:"instant",[Le.ON_SCENE_PLAY]:"instant",[Le.ON_SCENE_RESET]:"instant",[Le.ON_TICK]:"onTick",[Le.ON_VIDEO_EVENT]:"onTick",[Le.ON_WEBXR_CONTROLLER_EVENT]:"onTick"};new Set(bR.filter(n=>LR[n]=="onTick"));new Set(bR.filter(n=>LR[n]=="instant"));class OX{constructor(e){this.scene=e,this.rayObjectIntersectionClick=new yX(this),this.rayObjectIntersectionDoubleClick=new wX(this),this.rayObjectIntersectionMouseClick=new bX(this),this.rayObjectIntersectionContextmenu=new CX(this),this.rayObjectIntersectionHover=new mX(this),this.rayObjectIntersectionLongPress=new SX(this),this.rayObjectIntersectionPointerdown=new _X(this),this.rayObjectIntersectionPointerup=new gX(this),this.rayObjectIntersectionSwipe=new TX(this),this.pointerdown=new MX(this),this.pointerup=new RX(this),this._onEventTickBound=this._onEventTick.bind(this),this._onEventSceneResetBound=this._onEventSceneReset.bind(this),this._onEventScenePlayBound=this._onEventScenePlay.bind(this),this._onEventScenePauseBound=this._onEventScenePause.bind(this),this._onEventPerformanceChangeBound=this._onEventPerformanceChange.bind(this)}registerEvaluatorGenerator(e){this.scene.eventsDispatcher.registerEvaluatorGenerator(e)}unregisterEvaluatorGenerator(e){this.scene.eventsDispatcher.unregisterEvaluatorGenerator(e)}assignActorBuilder(e,t){let r=this.objectActorNodeIds(e);r||(r=[],e.userData[yE]=r);const s=t.graphNodeId();r.includes(s)||r.push(s),ve.onObjectsAddRemoveHooks.assignOnRemoveHookHandler(e,t)}objectActorNodeIds(e){return e.userData[yE]}get keyboardEventsController(){return this._keyboardEventsController=this._keyboardEventsController||new Qj(this)}get manualTriggerController(){return this._manualTriggerController=this._manualTriggerController||new Jj(this)}tick(){var e;this.rayObjectIntersectionHover.process(),(e=this._keyboardEventsController)==null||e.runTriggers(),La(this.scene.threejsScene(),t=>{this.triggerEventNodes(t,"onPointermove"),this._onEventTickBound(t)})}runOnEventSceneReset(){this._onEventSceneResetTraverse()}runOnEventScenePlay(){this._onEventScenePlayTraverse()}runOnEventScenePause(){this._onEventScenePauseTraverse()}runOnEventPerformanceChange(){this._onEventPerformanceChangeTraverse()}_onEventTick(e){this.triggerEventNodes(e,Le.ON_TICK)}_onEventSceneReset(e){this.triggerEventNodes(e,Le.ON_SCENE_RESET)}_onEventSceneResetTraverse(){La(this.scene.threejsScene(),this._onEventSceneResetBound)}_onEventScenePlay(e){this.triggerEventNodes(e,Le.ON_SCENE_PLAY)}_onEventScenePlayTraverse(){La(this.scene.threejsScene(),this._onEventScenePlayBound)}_onEventScenePause(e){this.triggerEventNodes(e,Le.ON_SCENE_PAUSE)}_onEventScenePauseTraverse(){La(this.scene.threejsScene(),this._onEventScenePauseBound)}_onEventPerformanceChange(e){this.triggerEventNodes(e,Le.ON_PERFORMANCE_CHANGE)}_onEventPerformanceChangeTraverse(){La(this.scene.threejsScene(),this._onEventPerformanceChangeBound)}triggerEventNodes(e,t){const r=this.objectActorNodeIds(e);if(r)for(const s of r){if(e.parent==null)return;const i=this.scene.graph.nodeFromId(s);i&&this.triggerEventNode(i,e,t)}}triggerEventNode(e,t,r){const s=e.compilationController.evaluatorGenerator();this._triggerEvaluatorGenerator(s,t,r)}_triggerEvaluatorGenerator(e,t,r){const s=e.findOrCreateEvaluator(t);s[r]&&s[r]()}}const xE=[];class PX{constructor(e){this.scene=e,this._cameraObjectsRecentlyUpdated=[],this._errorMessageDisplayed=!1,this._onCameraObjectsUpdatedCallbacks=[],this._coreGraphNode=new _r(this.scene,"SceneCamerasController")}coreGraphNode(){return this._coreGraphNode}dispose(){this._coreGraphNode.dispose()}updateFromChangeInObject(e){this._cameraObjects(e,this._cameraObjectsRecentlyUpdated),this._cameraObjectsRecentlyUpdated.length>0&&this._coreGraphNode.setDirty();for(const t of this._onCameraObjectsUpdatedCallbacks)t()}cameraObjects(e){return this._cameraObjects(this.scene.threejsScene(),e),e}_cameraObjects(e,t){t.splice(0,t.length),e.traverse(r=>{ve.camerasRegister.objectRegistered(r)&&t.push(r)})}cameraObjectsRecentlyUpdated(){return this._cameraObjectsRecentlyUpdated}setMainCamera(e){this.scene.root().mainCameraController.setCamera(e)}setMainCameraPath(e){this.scene.root().mainCameraController.setCameraPath(e)}mainCameraPath(){return this.scene.root().mainCameraController.rawCameraPath()}async mainCamera(e){if(this.scene.disposed())return null;let t=!0;(e==null?void 0:e.printCameraNotFoundError)!=null&&(t=e.printCameraNotFoundError);const r=e==null?void 0:e.cameraMaskOverride;r!=null&&this.scene.root().mainCameraController.setCameraPath(r);const s=l=>{this._errorMessageDisplayed!=!0&&t&&(console.error(l),this._errorMessageDisplayed=!0)},i=await this.scene.root().mainCameraController.camera();if(i)return i;let o=!0;(e==null?void 0:e.findAnyCamera)!=null&&(o=e.findAnyCamera);const c=`No camera found at path '${await this.scene.root().mainCameraController.cameraPath()}'. Make sure to set the root parameter 'mainCameraPath' to match a camera (from the top menu Windows->Root Node Params)`;if(o){const l=this._findAnyCameraObject();if(l)return s(c),l}return s(c),null}_findAnyCameraObject(){return this.cameraObjects(xE),xE[0]}async createMainViewer(e){const t=await this.mainCamera({cameraMaskOverride:e==null?void 0:e.cameraMaskOverride});if(t)return ve.camerasRegister.createViewer({...e,camera:t,scene:this.scene})}onCameraObjectsUpdated(e){this._onCameraObjectsUpdatedCallbacks.indexOf(e)>=0||this._onCameraObjectsUpdatedCallbacks.push(e)}removeOnCameraObjectsUpdated(e){const t=this._onCameraObjectsUpdatedCallbacks.indexOf(e);t>=0&&this._onCameraObjectsUpdatedCallbacks.splice(t,1)}}class NX{constructor(e){this._scene=e,this._queue=new Map,this._nodeIdsInFlushingQueue=new Set,this._blockLevel=0}block(){this._blockLevel+=1}unblock(){this._blockLevel-=1,!(this._blockLevel>0)&&(this._blockLevel<0&&(this._blockLevel=0),this._processQueue())}blocked(){return this._blockLevel>0||this._scene.loadingController.isLoading()}enqueue(e,t){e.dirtyController.hasPostDirtyHooks()&&(this._queue.has(e.graphNodeId())||this._nodeIdsInFlushingQueue.has(e.graphNodeId())||this._queue.set(e.graphNodeId(),t))}_processQueue(){if(this.blocked()||this._queue.size==0)return;const e=[],t=[];this._queue.forEach((s,i)=>{e.push(s),t.push(i),this._nodeIdsInFlushingQueue.add(i)}),this._queue.clear();let r=0;for(const s of e){const i=t[r];this._processItem(s,i),this._nodeIdsInFlushingQueue.delete(i),r++}}_processItem(e,t){const r=this._scene.graph.nodeFromId(t);r&&r.dirtyController.runPostDirtyHooks(e)}}class IX{constructor(){this._cookingNodesById=new Map,this._nodeIdsHavingCookedAtLeastOnce=new Set,this._nodeIdsCookingMoreThanOnce=new Set,this._resolves=[]}addNode(e){const t=e.graphNodeId();this._cookingNodesById.set(t,e),this._nodeIdsHavingCookedAtLeastOnce.has(t)||this._nodeIdsCookingMoreThanOnce.add(t),this._nodeIdsHavingCookedAtLeastOnce.add(t)}removeNode(e){const t=e.graphNodeId();this._cookingNodesById.delete(t),this._nodeIdsCookingMoreThanOnce.delete(t),this._cookingNodesById.size==0&&this.flush()}cookingNodes(e=[]){return e.length=0,this._cookingNodesById.forEach((t,r)=>{e.push(t)}),e}allNodesHaveCookedAtLeastOnce(){return this._nodeIdsCookingMoreThanOnce.size==0}flush(){let e;for(;e=this._resolves.pop();)e()}async waitForCooksCompleted(){if(this._cookingNodesById.size!=0)return new Promise((e,t)=>{this._resolves.push(e)})}}const hn=[],Ar=new Set;class DX{constructor(){this._nextId=0,this._successors=new Map,this._predecessors=new Map,this._nodesById=new Map,this._forbiddenTriggerNodeIds=new Map,this._selfDirtyForbidden=new Set,this._nodesCount=0,this._debugging=!1,this._addedNodesDuringDebugging=new Map,this._boundPredecessorIds=this.predecessorIds.bind(this),this._boundSuccessorIds=this.successorIds.bind(this)}startDebugging(){this._debugging=!0}stopDebugging(){this._debugging=!1}printDebug(){this._addedNodesDuringDebugging.forEach((e,t)=>{console.log(t,e,e.graphPredecessors(),e.graphSuccessors())})}setScene(e){this._scene=e}scene(){return this._scene}nextId(){return this._nextId+=1,this._nextId}nodesFromIds(e,t){t.length=0;for(const r of e){const s=this.nodeFromId(r);s&&t.push(s)}}nodeFromId(e){return this._nodesById.get(e)}hasNode(e){return this._nodesById.get(e.graphNodeId())!=null}addNode(e){this._nodesById.set(e.graphNodeId(),e),this._nodesCount+=1,this._debugging&&this._addedNodesDuringDebugging.set(e.graphNodeId(),e)}removeNode(e){this.disconnectPredecessors(e),this.disconnectSuccessors(e);const t=e.graphNodeId();this._nodesById.delete(t),this._successors.delete(t),this._predecessors.delete(t),this._nodesCount-=1,this._forbiddenTriggerNodeIds.delete(t),this._forbiddenTriggerNodeIds.forEach((r,s)=>{r.has(s)&&r.delete(s)}),this._selfDirtyForbidden.delete(t),this._debugging&&this._addedNodesDuringDebugging.delete(t)}nodesCount(){return this._nodesCount}connect(e,t,r=!0){const s=e.graphNodeId(),i=t.graphNodeId();return this.hasNode(e)&&this.hasNode(t)?(r&&(r=!(this._scene?this._scene.loadingController.isLoading():!0)),(r?e.hasPredecessor(t):!1)?!1:(this._createConnection(s,i),e.clearCachesWithPredecessorsAndSuccessors(),!0)):(console.warn(`attempt to connect non existing node ${s} or ${i}`),!1)}disconnect(e,t){this._removeConnection(e.graphNodeId(),t.graphNodeId()),e.clearCachesWithPredecessorsAndSuccessors(),t.clearCachesWithPredecessorsAndSuccessors()}disconnectPredecessors(e){const t=this.predecessors(e);if(t)for(const r of t)this.disconnect(r,e)}disconnectSuccessors(e){const t=this.successors(e);if(t)for(const r of t)this.disconnect(e,r)}predecessorIds(e){var t;return(t=this._predecessors.get(e))==null?void 0:t.idsArray}predecessors(e){var t;return(t=this._predecessors.get(e.graphNodeId()))==null?void 0:t.nodes}successorIds(e){var t;return(t=this._successors.get(e))==null?void 0:t.idsArray}successors(e){var t;return(t=this._successors.get(e.graphNodeId()))==null?void 0:t.nodes}allPredecessorIds(e,t){for(t.length=0,Ar.clear(),hn.length=1,hn[0]=e.graphNodeId();hn.length>0;){const r=hn.pop(),s=this._boundPredecessorIds(r);if(s)for(const i of s)Ar.has(i)||(Ar.add(i),t.push(i),hn.push(i))}}allSuccessorIds(e,t){t.length=0,Ar.clear(),hn.length=1,hn[0]=e.graphNodeId();const r=this._forbiddenTriggerNodeIds.get(e.graphNodeId());for(;hn.length>0;){const s=hn.pop(),i=this._boundSuccessorIds(s);if(i)for(const o of i)Ar.has(o)||(Ar.add(o),(r==null||!r.has(o))&&(t.push(o),hn.push(o)))}}allPredecessors(e,t){for(t.length=0,Ar.clear(),hn.length=1,hn[0]=e.graphNodeId();hn.length>0;){const r=hn.pop(),s=this._boundPredecessorIds(r);if(s){for(const i of s)if(!Ar.has(i)){Ar.add(i);const o=this._nodesById.get(i);o&&t.push(o),hn.push(i)}}}}allSuccessors(e,t){t.length=0,Ar.clear(),hn.length=1,hn[0]=e.graphNodeId();const r=this._forbiddenTriggerNodeIds.get(e.graphNodeId());for(;hn.length>0;){const s=hn.pop(),i=this._boundSuccessorIds(s);if(i){for(const o of i)if(!Ar.has(o)&&(Ar.add(o),r==null||!r.has(o))){const a=this._nodesById.get(o);a&&t.push(a),hn.push(o)}}}}_createConnection(e,t){let r=this._successors.get(e),s=this._predecessors.get(t);if(r||(r={idsSet:new Set,idsArray:[],nodes:[]},this._successors.set(e,r)),s||(s={idsSet:new Set,idsArray:[],nodes:[]},this._predecessors.set(t,s)),!r.idsSet.has(t)){r.idsSet.add(t),r.idsArray.push(t);const i=this._nodesById.get(t);if(i)r.nodes.push(i);else throw new Error(`creating connection with node not in graph ${t}`)}if(!s.idsSet.has(e)){s.idsSet.add(e),s.idsArray.push(e);const i=this._nodesById.get(e);if(i)s.nodes.push(i);else throw new Error(`creating connection with node not in graph ${e}`)}}_removeConnection(e,t){const r=this._successors.get(e);if(r&&r.idsSet.has(t)){r.idsSet.delete(t);const i=r.idsArray.indexOf(t);i>=0?(r.idsArray.splice(i,1),r.nodes.splice(i,1)):console.warn(`could not find id ${t} in successorsData.idsArray`,r.idsArray)}const s=this._predecessors.get(t);if(s&&s.idsSet.has(e)){s.idsSet.delete(e);const i=s.idsArray.indexOf(e);i>=0?(s.idsArray.splice(i,1),s.nodes.splice(i,1)):console.warn(`could not find id ${e} in predecessorsData.idsArray`,s.idsArray)}}setForbiddenTriggerNodes(e,t){var r;if((r=this._forbiddenTriggerNodeIds.get(e.graphNodeId()))==null||r.clear(),_t(t))for(const s of t)fr(this._forbiddenTriggerNodeIds,e.graphNodeId(),s.graphNodeId());else fr(this._forbiddenTriggerNodeIds,e.graphNodeId(),t.graphNodeId())}clearForbiddenTriggerNodes(e){this._forbiddenTriggerNodeIds.delete(e.graphNodeId())}setSelfDirtyForbidden(e,t){t?this._selfDirtyForbidden.add(e.graphNodeId()):this._selfDirtyForbidden.delete(e.graphNodeId())}selfDirtyForbidden(e){return this._selfDirtyForbidden.has(e.graphNodeId())}}class LX{constructor(e){this._node=e,this._cooks_count=0,this._total_cook_time=0,this._total_inputs_time=0,this._total_params_time=0}update_cook_data(e){this._cooks_count+=1,this._total_cook_time+=e.cookTime,this._total_inputs_time+=e.inputsTime,this._total_params_time+=e.paramsTime}total_time(){return this._total_cook_time+this._total_inputs_time+this._total_params_time}total_cook_time(){return this._total_cook_time}cook_time_per_iteration(){return this._cooks_count>0?this._total_cook_time/this._cooks_count:0}total_inputs_time(){return this._total_inputs_time}inputs_time_per_iteration(){return this._cooks_count>0?this._total_inputs_time/this._cooks_count:0}total_params_time2(){return this._total_params_time}params_time_per_iteration2(){return this._cooks_count>0?this._total_params_time/this._cooks_count:0}cooks_count(){return this._cooks_count}print_object(){return{fullPath:this._node.path(),cooks_count:this.cooks_count(),total_time:this.total_time(),total_cook_time:this.total_cook_time(),cook_time_per_iteration:this.cook_time_per_iteration(),inputs_time_per_iteration:this.inputs_time_per_iteration(),params_time_per_iteration:this.params_time_per_iteration2()}}}class FX{constructor(){this._started=!1,this._start_time=0,this._previous_timestamp=0,this._nodes_cook_data={},this._durations_by_name={},this._durations_count_by_name={}}profile(e,t){const r=ve.performance.performanceManager(),s=r.now();t();const i=r.now()-s;console.log(`${e}: ${i}`)}start(){if(!this._started){this.reset(),this._started=!0;const e=ve.performance.performanceManager();this._start_time=e.now(),this._nodes_cook_data={},this._previous_timestamp=this._start_time}}stop(){this.reset()}reset(){this._started=!1,this._start_time=null,this._durations_by_name={},this._durations_count_by_name={},this._nodes_cook_data={}}started(){return this._started}recordNodeCookData(e,t){const r=e.graphNodeId();this._nodes_cook_data[r]==null&&(this._nodes_cook_data[r]=new LX(e)),this._nodes_cook_data[r].update_cook_data(t)}record(e){this.started()||this.start();const t=performance.now();return this._durations_by_name[e]==null&&(this._durations_by_name[e]=0),this._durations_by_name[e]+=t-this._previous_timestamp,this._durations_count_by_name[e]==null&&(this._durations_count_by_name[e]=0),this._durations_count_by_name[e]+=1,this._previous_timestamp=t}print(){this.print_node_cook_data(),this.print_recordings()}print_node_cook_data(){let e=Object.values(this._nodes_cook_data);e=w_(e,i=>i.total_cook_time());const t=e.map(i=>i.print_object());console.log("--------------- NODES COOK TIME -----------");const r=[],s=w_(t,i=>-i.total_cook_time);for(const i of s)r.push(i);return console.table(r),t}print_recordings(){const e=Vd(this._durations_by_name),t=Vd(this._durations_count_by_name),r=[],s={};for(const a of Object.keys(e)){const c=e[a];r.push(c),s[c]==null&&(s[c]=[]),s[c].push(a)}r.sort((a,c)=>a-c);const i=[];Zs(r,i),console.log("--------------- PERF RECORDINGS -----------");const o=[];for(const a of i){const c=s[a];for(const l of c){const u=t[l],h=a/u,d={duration:a,name:l,count:u,duration_per_iteration:h};o.push(d)}}return console.table(o),o}}class UX{constructor(e){this.scene=e}setListener(e){this._eventsListener?console.warn("scene already has a listener"):(this._eventsListener=e,this._runOnAddListenerCallbacks())}onAddListener(e){this._eventsListener?e():(this._onAddListenerCallbacks=this._onAddListenerCallbacks||[],this._onAddListenerCallbacks.push(e))}_runOnAddListenerCallbacks(){if(this._onAddListenerCallbacks){let e;for(;e=this._onAddListenerCallbacks.pop();)e();this._onAddListenerCallbacks=void 0}}dispatch(e,t,r){var s;(s=this._eventsListener)==null||s.processEvents(e,t,r)}emitAllowed(){return this._eventsListener!=null&&this.scene.loadingController.loaded()&&this.scene.loadingController.autoUpdating()}processActorEvaluator(e){var t;return(t=this._eventsListener)==null?void 0:t.processActorEvaluator(e)}actorEvaluatorDebug(e){var t;return(t=this._eventsListener)==null?void 0:t.actorEvaluatorDebug(e)}}class kX{constructor(){this._paramsById=new Map}registerParam(e){this._paramsById.set(e.graphNodeId(),e)}deregisterParam(e){this._paramsById.delete(e.graphNodeId())}regenerateReferringExpressions(e){e.nameController.graphNode().setSuccessorsDirty(e)}}class BX{constructor(e){this.scene=e,this._lifecycleOnAfterCreatedAllowed=!0}onAfterCreatedCallbackAllowed(){return this.scene.loadingController.loaded()&&this._lifecycleOnAfterCreatedAllowed}onAfterCreatedPrevent(e){this._lifecycleOnAfterCreatedAllowed=!1,e(),this._lifecycleOnAfterCreatedAllowed=!0}}class GX{constructor(e){this.scene=e,this._loadingState=!0,this._autoUpdating=!1}markAsLoading(){this._setLoadingState(!0)}markAsLoaded(){this.scene.missingExpressionReferencesController.resolveMissingReferences(),this._setLoadingState(!1),this._triggerLoadedEvent()}dispatchReadyEvent(){globalThis.Event&&this.scene.eventsDispatcher.sceneEventsController.dispatch(ZV)}_triggerLoadedEvent(){globalThis.Event&&this.scene.eventsDispatcher.sceneEventsController.dispatch(KV)}_setLoadingState(e){this._loadingState=e,this.setAutoUpdate(!this._loadingState),this.scene.cooker.unblock()}isLoading(){return this._loadingState}loaded(){return!this._loadingState}autoUpdating(){return this._autoUpdating}setAutoUpdate(e){if(this._autoUpdating!==e&&(this._autoUpdating=e,this._autoUpdating)){const t=this.scene.root();t&&t.processQueue()}}}class VX{constructor(e,t){this.param=e,this.path=t}absolutePath(){if(this.param.node)return bt.makeAbsolutePath(this.param.node,this.path)}matchesPath(e){return this.absolutePath()==e}resolveMissingDependencies(){const e=this.param.rawInputSerialized();this.param.set(this.param.defaultValue()),this.param.set(e)}}const Am=[],Hh=[],jh=[];class zX{constructor(e){this.scene=e,this.references=new Map,this._toIgnore=new WeakMap}register(e,t,r){if(r&&this._toIgnore.get(r)==!0)return;const s=new VX(e,t);return fr(this.references,e.graphNodeId(),s),s}deregisterParam(e){this.references.delete(e.graphNodeId())}registerToIgnore(e){this._toIgnore.set(e,!0)}resolveMissingReferences(){Am.length=0,this.references.forEach(e=>{e.forEach(t=>{this._isReferenceResolvable(t)&&Am.push(t)})});for(const e of Am)e.resolveMissingDependencies()}_isReferenceResolvable(e){const t=e.absolutePath();if(t){if(this.scene.node(t))return!0;{const s=bt.splitParentChild(t);if(s.child){const i=this.scene.node(s.parent);if(i&&i.params.get(s.child))return!0}}}}checkForMissingNodeReferences(e){if(e.scene().loadingController.loaded()){this._checkForMissingReferencesForNode(e);for(const t of e.params.all)this._checkForMissingReferencesForParam(t)}}checkForMissingParamReferences(e){e.scene().loadingController.loaded()&&this._checkForMissingReferencesForParam(e)}_checkForMissingReferencesForNode(e){const t=e.graphNodeId();ob(this.references,jh);for(const r of jh){let s=!1;rr(r,Hh);for(const i of Hh)i.matchesPath(e.path())&&(s=!0,i.resolveMissingDependencies());s&&this.references.delete(t)}}_checkForMissingReferencesForParam(e){const t=e.graphNodeId();ob(this.references,jh);for(const r of jh){let s=!1;rr(r,Hh);for(const i of Hh)i.matchesPath(e.path())&&(s=!0,i.resolveMissingDependencies());s&&this.references.delete(t)}}}class HX{constructor(e){this.scene=e,this._graphNodeIdByPath=new Map,this._pathByGraphNodeId=new Map}notifyNodePathChanged(e){var t;this._notifyGraphNodePathChanged(e);const r=e.params.all;for(const s of r)this.notifyParamPathChanged(s);(t=e.childrenController)==null||t.traverseChildren(s=>{this._notifyGraphNodePathChanged(s)})}notifyParamPathChanged(e){this._notifyGraphNodePathChanged(e)}_notifyGraphNodePathChanged(e){const t=e.graphNodeId(),r=e.path(),s=this._pathByGraphNodeId.get(t);if(s!=null){const o=this._graphNodeIdByPath.get(s);o&&(o.value=null)}if(e.disposed())return;const i=this._findOrCreateRef(r);i.value=t,this._pathByGraphNodeId.set(t,r)}pathRef(e){return this._findOrCreateRef(e)}_findOrCreateRef(e){let t=this._graphNodeIdByPath.get(e);return t||(t=Pr(null),this._graphNodeIdByPath.set(e,t)),t}}class jX extends rs{static context(){return be.MANAGER}}const WX=/\/+/g;function XX(n,e){return Zv(n,e)}function Zv(n,e,t=""){for(const r of e.children){const s=dc(r.name),i=dc(`${t}/${s}`);if(Qs(i,n))return r;const o=Zv(n,r,i);if(o)return o}}function FR(n,e,t=!1){const r=[];return Jv(n,s=>{r.push(s)},e,t),r}function $X(n,e,t=[],r=""){return Jv(n,s=>{t.push(s)},e),t}function Jv(n,e,t,r=!1){Qv(n,t,e,r)}function Qv(n,e,t,r,s){const i=dc(e.name),o=dc(s!=null?`${s}/${i}`:i);let a=Qs(o,n);r&&(a=!a),a&&t(e);for(const c of e.children)Qv(n,c,t,r,o)}function dc(n){return n.replace(WX,"/")}function UR(n,e){const t=n.parent;if(t&&n!=e){const r=UR(t,e);return dc(`${r}/${n.name}`)}else return n.name}class gr{}gr.findObjectByMask=XX;gr.findObjectByMaskInObject=Zv;gr.objectsByMask=FR;gr.objectsByMaskInObject=$X;gr.traverseObjectsWithMask=Jv;gr.traverseObjectsWithMaskInObject=Qv;gr.objectPath=UR;gr.sanitizePath=dc;const qX="/";class YX{constructor(e){this.scene=e}findObjectByMask(e){return gr.findObjectByMask(e,this.scene.threejsScene())}objectsByMask(e,t){return FR(e,t||this.scene.threejsScene(),!1)}traverseObjectsWithMask(e,t,r,s=!1){gr.traverseObjectsWithMaskInObject(e,r||this.scene.threejsScene(),t,s)}}const Tm={computeOnDirty:!1,callback:n=>{kR.update(n)}};function KX(n){return class extends n{constructor(){super(...arguments),this.displayAudioIcon=A.BOOLEAN(0,{...Tm,separatorBefore:!0}),this.audioIconColor=A.COLOR([0,0,0],{...Tm,visibleIf:{displayAudioIcon:1}}),this.audioIconStyle=A.STRING("position: absolute; top: 10px; right: 10px; width: 24px; height: 24px; cursor: pointer",{...Tm,visibleIf:{displayAudioIcon:1}})}}}class kR{constructor(e){this.node=e,this._callbacksByName=new Map}async toggleSound(){this.audioListeners().forEach(e=>{e.toggleSound()}),this.update(),this._runOnToggleSoundCallbacks()}soundOn(){const e=this.audioListeners()[0];return e&&e.pv.soundOn||!1}update(){this._updateViewers()}audioListeners(){return this.node.nodesByType("audioListener")}_updateViewers(){this.node.scene().viewersRegister.traverseViewers(e=>{e.audioController().update()})}static update(e){e.audioController.update()}onToggleSound(e,t){if(this._callbacksByName.get(e)){console.warn(`callback already registered ith name '${e}'`);return}this._callbacksByName.set(e,t)}_runOnToggleSoundCallbacks(){const e=this.soundOn();this._callbacksByName.forEach(t=>{t(e)})}}const ZX={computeOnDirty:!1,callback:n=>{BR.update(n)}};function JX(n){return class extends n{constructor(){super(...arguments),this.autoUpdate=A.BOOLEAN(1,{...ZX,separatorBefore:!0})}}}class BR{constructor(e){this.node=e}async update(){const e=this.node.object,t=this.node.pv;t.autoUpdate!=e.matrixWorldAutoUpdate&&(e.matrixWorldAutoUpdate=t.autoUpdate)}static async update(e){e.sceneAutoUpdateController.update()}}const Si=["none","color","texture"],Qc={cook:!1,callback:n=>{GR.update(n)}};function QX(n){return class extends n{constructor(){super(...arguments),this.backgroundMode=A.INTEGER(Si.indexOf("color"),{menu:{entries:Si.map((t,r)=>({name:t,value:r}))},...Qc,separatorBefore:!0}),this.bgColor=A.COLOR([.01,.01,.01],{visibleIf:{backgroundMode:Si.indexOf("color")},...Qc}),this.bgTexture=A.NODE_PATH("",{visibleIf:{backgroundMode:Si.indexOf("texture")},nodeSelection:{context:be.COP},...Qc}),this.bgBlur=A.FLOAT(0,{visibleIf:{backgroundMode:Si.indexOf("texture")},range:[0,1],rangeLocked:[!0,!1],...Qc}),this.bgIntensity=A.FLOAT(1,{visibleIf:{backgroundMode:Si.indexOf("texture")},range:[0,2],rangeLocked:[!0,!1],...Qc})}}}const e6="SceneBackgroundController";class GR{constructor(e){this.node=e,this._updateBound=this.update.bind(this)}addHooks(){const e=this.node.p,t=[e.backgroundMode,e.bgColor,e.bgTexture];for(const r of t)r.addPostDirtyHook(e6,this._updateBound)}setMode(e){this.node.p.backgroundMode.set(Si.indexOf(e))}backgroundMode(){return Si[this.node.pv.backgroundMode]}async update(){const e=this.backgroundMode();switch(e){case"none":return this._setBackgroundNone();case"color":return await this._setBackgroundColor();case"texture":return await this._setBackgroundTexture()}St.unreachable(e)}_setBackgroundNone(){const e=this.node.object;e.background=null}async _setBackgroundColor(){const e=this.node.object,t=this.node.pv;await this.node.p.bgColor.compute(),e.background&&e.background instanceof xe?e.background.copy(t.bgColor):e.background=t.bgColor}async _setBackgroundTexture(){const e=this.node.object,t=this.node.pv,r=t.bgTexture.nodeWithContext(be.COP);if(r){const s=await r.compute();e.background=s.texture()}else this.node.states.error.set("bgTexture node not found"),e.background=null;e.backgroundBlurriness=t.bgBlur,e.backgroundIntensity=t.bgIntensity}static update(e){e.sceneBackgroundController.update()}}const bE={cook:!1,callback:n=>{VR.update(n)}};function t6(n){return class extends n{constructor(){super(...arguments),this.useEnvironment=A.BOOLEAN(0,{...bE,separatorBefore:!0}),this.environment=A.NODE_PATH("",{visibleIf:{useEnvironment:1},nodeSelection:{context:be.COP},...bE})}}}const n6="SceneEnvController";class VR{constructor(e){this.node=e,this._updateBound=this.update.bind(this)}addHooks(){const e=this.node.p,t=[e.useEnvironment,e.environment];for(const r of t)r.addPostDirtyHook(n6,this._updateBound)}async update(){const e=this.node.object,t=this.node.pv;if(t.useEnvironment){const r=t.environment.nodeWithContext(be.COP);r?r.compute().then(s=>{e.environment=s.texture()}):(e.environment=null,this.node.states.error.set("environment node not found"))}else e.environment=null}static async update(e){e.sceneEnvController.update()}}const Sa={computeOnDirty:!1,callback:n=>{zR.update(n)}},Fa=["linear","exponential"];function r6(n){return class extends n{constructor(){super(...arguments),this.useFog=A.BOOLEAN(0,{...Sa,separatorBefore:!0}),this.fogType=A.INTEGER(Fa.indexOf("exponential"),{visibleIf:{useFog:1},menu:{entries:Fa.map((t,r)=>({name:t,value:r}))},...Sa}),this.fogColor=A.COLOR([1,1,1],{visibleIf:{useFog:1},...Sa}),this.fogNear=A.FLOAT(1,{range:[0,100],rangeLocked:[!0,!1],visibleIf:{useFog:1,fogType:Fa.indexOf("linear")},...Sa}),this.fogFar=A.FLOAT(100,{range:[0,100],rangeLocked:[!0,!1],visibleIf:{useFog:1,fogType:Fa.indexOf("linear")},...Sa}),this.fogDensity=A.FLOAT(25e-5,{visibleIf:{useFog:1,fogType:Fa.indexOf("exponential")},...Sa})}}}class zR{constructor(e){this.node=e}async update(){const e=this.node.object,t=this.node.pv;if(t.useFog)if(t.fogType==Fa.indexOf("linear")){const r=this.fog2(t);e.fog=r,r.color=t.fogColor,r.near=t.fogNear,r.far=t.fogFar}else{const r=this.fogExp2(t);e.fog=this.fogExp2(t),r.color=t.fogColor,r.density=t.fogDensity}else e.fog&&(e.fog=null)}fog2(e){return this._fog=this._fog||new jg(16777215,e.fogNear,e.fogFar)}fogExp2(e){return this._fogExp2=this._fogExp2||new Hg(16777215,e.fogDensity)}static async update(e){e.sceneFogController.update()}}const CE={computeOnDirty:!1,callback:n=>{HR.update(n)}};function s6(n){return class extends n{constructor(){super(...arguments),this.useOverrideMaterial=A.BOOLEAN(0,{...CE,separatorBefore:!0}),this.overrideMaterial=A.NODE_PATH("",{visibleIf:{useOverrideMaterial:1},nodeSelection:{context:be.MAT},dependentOnFoundNode:!1,...CE})}}}class HR{constructor(e){this.node=e}async update(){const e=this.node.object,t=this.node.pv;if(t.useOverrideMaterial){const r=t.overrideMaterial.nodeWithContext(be.MAT);if(r){const s=await r.compute();e.overrideMaterial=s.material()}else e.overrideMaterial=null,this.node.states.error.set("overrideMaterial node not found")}else e.overrideMaterial=null}static async update(e){e.sceneMaterialOverrideController.update()}}let EE;function i6(){return EE=EE||new Un}function o6(n){return class extends n{constructor(){super(...arguments),this.mainCameraPath=A.STRING("",{cook:!1,separatorBefore:!0,objectMask:!0})}}}class a6{constructor(e){this.node=e}setCamera(e){const t=gr.objectPath(e);this.setCameraPath(t)}setCameraPath(e){this.mainCameraPathParam().set(e)}mainCameraPathParam(){return this.node.p.mainCameraPath}rawCameraPath(){return this.mainCameraPathParam().rawInput()}async cameraPath(){const e=this.mainCameraPathParam();return e.isDirty()&&await e.compute(),e.value}_cameraPathSync(){return this.mainCameraPathParam().value}cameraSync(){const e=this._cameraPathSync();return this.node.scene().objectsController.findObjectByMask(e)}dummyPerspectiveCamera(){return i6()}cameraSyncOrDummy(){return this.cameraSync()}async camera(){const e=await this.cameraPath();return this.node.scene().objectsController.findObjectByMask(e)}async cameraCreatorNode(){const t=(await this.cameraPath()).split(bt.SEPARATOR),r=t[1],s=this.node.node(r);return s&&t.length!=2&&s.displayNodeController&&s.displayNodeController.displayNode()||s}}const jR="RootNode";class c6 extends YV(KX(s6(t6(r6(o6(QX(JX(Et)))))))){}const l6=new c6;class u6 extends jX{constructor(){super(...arguments),this.paramsConfig=l6,this._object=this._createScene(),this._queuedNodesById=new Map,this.audioController=new kR(this),this.sceneAutoUpdateController=new BR(this),this.sceneBackgroundController=new GR(this),this.sceneEnvController=new VR(this),this.sceneFogController=new zR(this),this.loadProgress=new No(this),this.sceneMaterialOverrideController=new HR(this),this.mainCameraController=new a6(this),this._childrenControllerContext=be.OBJ}static type(){return"root"}cook(){this.cookController.endCook()}initializeNode(){this.params.onParamsCreated("init controllers",()=>{this.sceneEnvController.addHooks(),this.sceneBackgroundController.addHooks()}),this.lifecycle.onChildAdd(this._onChildAdd.bind(this)),this.lifecycle.onChildRemove(this._onChildRemove.bind(this))}_createScene(){const e=new gu;return e.name=qX,e.matrixAutoUpdate=!0,e}get object(){return this._object}createNode(e,t){return super.createNode(e,t)}children(){return super.children()}nodesByType(e){return super.nodesByType(e)}_updateScene(){this.sceneAutoUpdateController.update(),this.sceneBackgroundController.update(),this.sceneEnvController.update(),this.sceneFogController.update(),this.sceneMaterialOverrideController.update()}_addToQueue(e){const t=e.graphNodeId();return this._queuedNodesById.has(t)||this._queuedNodesById.set(t,e),e}processQueue(){this._updateScene();const e=new Map,t=[];this._queuedNodesById.forEach((r,s)=>{const i=`_____${r.renderOrder}__${r.path()}`;t.push(i),e.set(i,r)}),this._queuedNodesById.clear();for(const r of t){const s=e.get(r);s&&(e.delete(r),this._addToScene(s))}}_updateObject(e){return this.scene().loadingController.autoUpdating()?(e.isDisplayed()&&!e.cookController.isCooking()&&e.compute(),this._addToScene(e)):this._addToQueue(e)}getParentForNode(e){if(e.attachableToHierarchy()){const t=e.io.inputs.input(0);return t?t.childrenGroup():this._object}else return null}_addToScene(e){if(e.attachableToHierarchy()){const t=this.getParentForNode(e);t&&(e.usedInScene()?(e.childrenDisplayController?e.childrenDisplayController.requestDisplayNodeContainer():e.compute(),e.addObjectToParent(t)):e.removeObjectFromParent())}}_removeFromScene(e){e.removeObjectFromParent()}areChildrenCooking(){const e=this.children();for(const t of e)if(t.cookController.isCooking()||t.isDisplayNodeCooking())return!0;return!1}addToParentTransform(e){this._updateObject(e)}removeFromParentTransform(e){this._updateObject(e)}_onChildAdd(e){e&&this._updateObject(e)}_onChildRemove(e){e&&this._removeFromScene(e)}}class h6{constructor(e){this.scene=e,this._nodeContextSignatures={},this._instanciatedNodesByContextAndType=new Map}createRoot(e){this._root=new u6(this.scene,jR,e),this._root.initializeBaseAndNode(),this._root.params.init()}root(){return this._root}_traverseNode(e,t){const r=e.children();if(!(!r||r.length==0))for(const s of r)s.childrenController&&this._traverseNode(s,t),t(s)}traverseNodes(e){this._traverseNode(this._root,e)}clear(){var e;const t=this.root().children();for(const r of t)(e=this.root().childrenController)==null||e.removeNode(r)}node(e){return e==="/"?this.root():this.root().node(e)}allNodes(){let e=[this.root()],t=[this.root()],r=0;for(;t.length>0&&r<10;){const s=t.map(i=>i.childrenAllowed()?i.children():[]).flat();e=e.concat(s),t=s,r+=1}return e.flat()}nodesFromMask(e){const t=this.allNodes(),r=[];for(const s of t){const i=s.path();Qs(i,e)&&r.push(s)}return r}resetNodeContextSignatures(){this._nodeContextSignatures={}}registerNodeContextSignature(e){e.childrenAllowed()&&e.childrenController&&(this._nodeContextSignatures[e.childrenController.nodeContextSignature()]=!0)}nodeContextSignatures(){return Object.keys(this._nodeContextSignatures).sort().map(e=>e.toLowerCase())}addToInstanciatedNode(e){const t=e.context(),r=e.type();let s=this._instanciatedNodesByContextAndType.get(t);s||(s=new Map,this._instanciatedNodesByContextAndType.set(t,s));let i=s.get(r);i||(i=new Map,s.set(r,i)),i.set(e.graphNodeId(),e)}removeFromInstanciatedNode(e){const t=e.context(),r=e.type(),s=this._instanciatedNodesByContextAndType.get(t);if(!s)return;const i=s.get(r);i&&i.delete(e.graphNodeId())}nodesByType(e){const t=[];return this._traverseNode(this.scene.root(),r=>{r.type()==e&&t.push(r)}),t}nodesByContextAndType(e,t){const r=[],s=this._instanciatedNodesByContextAndType.get(e);if(s){const i=s.get(t);i&&i.forEach(o=>{r.push(o)})}return r}hasNodesByContextAndType(e,t){const r=this._instanciatedNodesByContextAndType.get(e);if(!r)return!1;const s=r.get(t);return s?s.size!=0:!1}}var Eo=(n=>(n.contextmenu="contextmenu",n.pointerdown="pointerdown",n.pointermove="pointermove",n.pointerup="pointerup",n.touchstart="touchstart",n.touchmove="touchmove",n.touchend="touchend",n))(Eo||{});const d6=["contextmenu","pointerdown","pointermove","pointerup"];var Yd=(n=>(n.CANVAS="canvas",n.DOCUMENT="document",n))(Yd||{});class Oc{constructor(e){this.dispatcher=e,this._activeEventDatas=[],this._activeEventDataTypes=new Set,this._eventNodes=new Set,this._requireCanvasEventListeners=!1,this._actorEvaluators=new Set,this._actorEvaluatorsByEventNames=new Map}registerEventNode(e){this._eventNodes.add(e),this.updateViewerEventListeners()}unregisterEventNode(e){this._eventNodes.delete(e),this.updateViewerEventListeners()}registerEvaluatorGenerator(e){this._actorEvaluators.add(e),this._updateActorEvaluatorCache(),this.updateViewerEventListeners()}unregisterEvaluatorGenerator(e){this._actorEvaluators.delete(e),this._updateActorEvaluatorCache(),this.updateViewerEventListeners()}_updateActorEvaluatorCache(){this._actorEvaluatorsByEventNames.clear(),this._actorEvaluators.forEach(e=>{const t=e.eventDatas;t&&t.forEach(r=>{const s=r.type,i=r.emitter;let o=this._actorEvaluatorsByEventNames.get(s);o||(o=new Map,this._actorEvaluatorsByEventNames.set(s,o)),fr(o,i,e)})})}processEvent(e){var t;if(this._activeEventDatas.length==0)return;const r=(t=e.event)==null?void 0:t.type;r&&!this._activeEventDataTypes.has(r)||this._eventNodes.forEach(s=>{s.processEvent(e)})}updateViewerEventListeners(){this._updateActiveEventTypes(),this._requireCanvasEventListeners&&this.dispatcher.scene.viewersRegister.traverseViewers(e=>{e.eventsController().updateEvents(this)})}activeEventDatas(){return this._activeEventDatas}_updateActiveEventTypes(){const e=o=>{this._activeEventDatas.push(o),this._activeEventDataTypes.add(o.type)},t=()=>{this._activeEventDatas.splice(0,this._activeEventDatas.length),this._activeEventDataTypes.clear()},r=()=>{let o=new Map;this._actorEvaluatorsByEventNames.forEach((c,l)=>{c.forEach((u,h)=>{u.forEach(d=>{fr(o,h,l)})})});const a=[];return o.forEach((c,l)=>{for(const u of c){const h={type:u,emitter:l};a.push(h)}}),a},s=()=>{const o=r();if(o)for(const a of o)e(a)},i=()=>{const o=new Set;this._eventNodes.forEach(a=>{if(a.parent()){const c=a.activeEventDatas();for(const l of c)o.add(l)}}),o.forEach((a,c)=>{e(c)})};t(),e({type:Eo.pointermove,emitter:Yd.DOCUMENT}),e({type:Eo.touchmove,emitter:Yd.DOCUMENT}),s(),i()}}const p6=["dragover"];class f6 extends Oc{constructor(){super(...arguments),this._requireCanvasEventListeners=!0}type(){return"drag"}acceptedEventTypes(){return new Set([...p6])}}var xd=(n=>(n.keydown="keydown",n.keypress="keypress",n.keyup="keyup",n))(xd||{});const WR=["keydown","keypress","keyup"],m6={[xd.keydown]:[Le.ON_KEY,Le.ON_KEYDOWN],[xd.keypress]:[Le.ON_KEYPRESS],[xd.keyup]:[Le.ON_KEY,Le.ON_KEYUP]};class _6 extends Oc{constructor(e){super(e),this._requireCanvasEventListeners=!0,this._currentEvents=[],this._lastProcessedFrame=-1,this.timeController=this.dispatcher.scene.timeController,this.keyboardEventsController=this.dispatcher.scene.actorsManager.keyboardEventsController}type(){return"keyboard"}acceptedEventTypes(){return new Set(WR.map(e=>`${e}`))}currentEvents(){return this._currentEvents}processEvent(e){super.processEvent(e);const{event:t}=e;if(!t)return;const r=t.type,s=this._actorEvaluatorsByEventNames.get(r);if(!s)return;if(this.timeController.playing()){const c=this.timeController.frame();c!=this._lastProcessedFrame&&(this._lastProcessedFrame=c,this._currentEvents.length=0),this._currentEvents.push(t)}else this._currentEvents[0]=t;const i=e.emitter;if(!i)return;const o=s.get(i);if(!o)return;const a=m6[r];if(a)for(const c of a)this.keyboardEventsController.addTriggeredEvaluators(o,c)}}var tg=(n=>(n.auxclick="auxclick",n.click="click",n.contextmenu="contextmenu",n.dblclick="dblclick",n.mousedown="mousedown",n.mouseenter="mouseenter",n.mouseleave="mouseleave",n.mousemove="mousemove",n.mouseover="mouseover",n.mouseout="mouseout",n.mouseup="mouseup",n.pointerlockchange="pointerlockchange",n.pointerlockerror="pointerlockerror",n.select="select",n.wheel="wheel",n))(tg||{});const g6=["auxclick","click","contextmenu","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseover","mouseout","mouseup","pointerlockchange","pointerlockerror","select","wheel"];class v6 extends Oc{constructor(){super(...arguments),this._requireCanvasEventListeners=!0}type(){return"mouse"}acceptedEventTypes(){return new Set([...g6])}}var ng=(n=>(n.touchstart="touchstart",n.touchmove="touchmove",n.touchend="touchend",n))(ng||{});const y6=["touchstart","touchmove","touchend"];function XR(){const n=new _T;return Pv.updateRaycaster(n),n}function x6(n){return!isNaN(n.x)&&!isNaN(n.y)&&isFinite(n.x)&&isFinite(n.y)}class e0{constructor(){this._rectByCanvas=new Map,this._resetCacheBound=this._resetCache.bind(this),globalThis.addEventListener("resize",this._resetCacheBound),document.addEventListener("scroll",this._resetCacheBound)}static instance(){return this._instance=this._instance||new e0}setEventOffset(e,t,r){let s=this._rectByCanvas.get(t);s||(s=t.getBoundingClientRect(),this._rectByCanvas.set(t,s)),r.offsetX=e.clientX-s.left,r.offsetY=e.clientY-s.top}_resetCache(){this._rectByCanvas.clear()}resetCacheForCanvas(e){this._rectByCanvas.delete(e)}}const rg=e0.instance(),Aa={offsetX:0,offsetY:0};class b6{setCursorForCPU(e,t){this.setCursor(e,t),t.x=t.x*2-1,t.y=-t.y*2+1}setCursorForGPU(e,t){this.setCursor(e,t),t.y=1-t.y}setCursor(e,t){var r;const s=(r=e.viewer)==null?void 0:r.canvas();if(!s)return;const i=e.event;if((i instanceof PointerEvent||i instanceof MouseEvent||i instanceof DragEvent)&&rg.setEventOffset(i,s,Aa),globalThis.TouchEvent&&i instanceof TouchEvent){const o=i.touches[0];o&&rg.setEventOffset(o,s,Aa)}this._updateFromCursor(s,t)}_updateFromCursor(e,t){if(e.offsetWidth<=0||e.offsetHeight<=0?(console.warn("_updateFromCursor: zero size canvas"),t.set(0,0)):(t.x=Aa.offsetX/e.offsetWidth,t.y=Aa.offsetY/e.offsetHeight),!x6(t)){console.warn("invalid number detected"),console.warn(t.toArray(),Aa.offsetX,Aa.offsetY,e.offsetWidth,e.offsetHeight);return}}}class C6 extends Oc{constructor(e){super(e),this._requireCanvasEventListeners=!0,this._cursorHelper=new b6,this._cursor0=Pr(new W(-1e3,-1e3)),this._raycaster0=Pr(XR())}type(){return"pointer"}acceptedEventTypes(){return new Set([...d6])}setRaycaster(e){this._raycaster0.value=e}processEvent(e){this._cursorHelper.setCursorForCPU(e,this._cursor0.value),super.processEvent(e);const{viewer:t,event:r}=e;if(!(r&&t)){console.log("either event or viewer missing");return}t.raycastersController.setCursor0(this._cursor0.value),t.raycastersController.updateRaycasters();const s=r.type;if(s==Eo.pointermove||s==ng.touchmove)return;const i=this._actorEvaluatorsByEventNames.get(s);if(!i)return;const o=e.emitter;if(!(!o||!i.get(o))&&e.event){const c=this.dispatcher.scene.actorsManager;switch(s){case tg.mousedown:{c.rayObjectIntersectionMouseClick.onMousedown(e.event);return}case tg.dblclick:c.rayObjectIntersectionDoubleClick.onDoubleClick(e.event);case Eo.pointerdown:{c.rayObjectIntersectionClick.onPointerdown(e.event),c.rayObjectIntersectionLongPress.onPointerdown(e.event),c.rayObjectIntersectionPointerdown.onPointerdown(e.event),c.pointerdown.onPointerdown(e.event),c.rayObjectIntersectionSwipe.onPointerdown(e.event);return}case Eo.pointerup:{c.rayObjectIntersectionPointerup.onPointerup(e.event),c.pointerup.onPointerup(e.event);return}case Eo.contextmenu:{c.rayObjectIntersectionContextmenu.onContextmenu(e.event);return}case ng.touchend:{c.rayObjectIntersectionPointerup.onPointerup(e.event),c.pointerup.onPointerup(e.event);return}}}}raycaster(){return this._raycaster0}cursor(){return this._cursor0}updateRaycast(e){const t=this._raycaster0.value.params.Points;t&&(t.threshold=e.pointsThreshold);const r=this._raycaster0.value.params.Line;r&&(r.threshold=e.lineThreshold)}}const E6=["resize"];class S6 extends Oc{constructor(){super(...arguments),this._requireCanvasEventListeners=!0}type(){return"window"}acceptedEventTypes(){return new Set(E6.map(e=>`${e}`))}}class A6 extends Oc{constructor(){super(...arguments),this._requireCanvasEventListeners=!0}type(){return"touch"}acceptedEventTypes(){return new Set([...y6])}}class T6{constructor(){}dispatchTrigger(e){var t;(t=e._eventDispatcher())==null||t.dispatchEvent(A5)}}var fo=(n=>(n.DRAG="drag",n.KEYBOARD="keyboard",n.MOUSE="mouse",n.POINTER="pointer",n.TOUCH="touch",n.WINDOW="window",n))(fo||{});class M6{constructor(e){this.scene=e,this._controllers=[],this.sceneEventsController=new ez,this.pointerEventsController=this._createController(C6)}registerEvaluatorGenerator(e){const t=this._findOrCreateControllerForEvaluator(e);t&&t.forEach(r=>r.registerEvaluatorGenerator(e))}unregisterEvaluatorGenerator(e){const t=this._findOrCreateControllerForEvaluator(e);t&&t.forEach(r=>r.unregisterEvaluatorGenerator(e))}registerEventNode(e){const t=this._findOrCreateControllerForEventNode(e);t&&t.registerEventNode(e)}unregisterEventNode(e){const t=this._findOrCreateControllerForEventNode(e);t&&t.unregisterEventNode(e)}updateViewerEventListeners(e){const t=this._findOrCreateControllerForEventNode(e);t&&t.updateViewerEventListeners()}traverseControllers(e){for(const t of this._controllers)e(t)}setRaycaster(e){this.pointerEventsController.setRaycaster(e)}_findOrCreateControllerForEventNode(e){return this._findOrCreateControllerForEventInputType(e.type())}_findOrCreateControllerForEvaluator(e){const t=e.eventDatas;if(!t)return;const r=new Set;return t.forEach(s=>{const i=this._findOrCreateControllerForJsType(s.jsType);i&&r.add(i)}),r}_findOrCreateControllerForEventInputType(e){switch(e){case fo.KEYBOARD:return this.keyboardEventsController;case fo.MOUSE:return this.mouseEventsController;case fo.DRAG:return this.dragEventsController;case fo.POINTER:return this.pointerEventsController;case fo.TOUCH:return this.touchEventsController;case fo.WINDOW:return this.windowEventsController}}_findOrCreateControllerForJsType(e){switch(e){case Le.CURSOR:case Le.ON_OBJECT_CLICK:case Le.ON_OBJECT_CONTEXT_MENU:case Le.ON_OBJECT_HOVER:case Le.ON_OBJECT_LONG_PRESS:case Le.ON_OBJECT_MOUSE_CLICK:case Le.ON_OBJECT_POINTERDOWN:case Le.ON_OBJECT_POINTERUP:case Le.ON_POINTERDOWN:case Le.ON_POINTERUP:case Le.RAY_FROM_CURSOR:return this.pointerEventsController;case Le.ON_KEY:case Le.ON_KEYDOWN:case Le.ON_KEYPRESS:case Le.ON_KEYUP:return this.keyboardEventsController}console.warn("no event controller defined for jsType",e)}get keyboardEventsController(){return this._keyboardEventsController=this._keyboardEventsController||this._createController(_6)}get mouseEventsController(){return this._mouseEventsController=this._mouseEventsController||this._createController(v6)}get dragEventsController(){return this._dragEventsController=this._dragEventsController||this._createController(f6)}get windowEventsController(){return this._windowEventsController=this._windowEventsController||this._createController(S6)}get touchEventsController(){return this._touchEventsController=this._touchEventsController||this._createController(A6)}_createController(e){const t=new e(this);return this._controllers.includes(t)||this._controllers.push(t),t}get connectionTriggerDispatcher(){return this._connectionTriggerDispatcher=this._connectionTriggerDispatcher||new T6}}class R6{constructor(e){this.scene=e,this._performanceRef=Pr(1)}ref(){return this._performanceRef}onPerformanceChange(e){this._performanceRef.value=e}}const Mm=[],Wh=[];class w6{constructor(e){this.scene=e,this._referenced_nodes_by_src_param_id=new Map,this._referencing_params_by_referenced_node_id=new Map,this._referencing_params_by_all_named_node_ids=new Map}setReferenceFromParam(e,t){this._referenced_nodes_by_src_param_id.set(e.graphNodeId(),t),dr(this._referencing_params_by_referenced_node_id,t.graphNodeId(),e)}setNamedNodesFromParam(e){e.decomposedPath.namedNodes(Wh);for(const t of Wh)dr(this._referencing_params_by_all_named_node_ids,t.graphNodeId(),e)}resetReferenceFromParam(e){const t=this._referenced_nodes_by_src_param_id.get(e.graphNodeId());if(t){R_(this._referencing_params_by_referenced_node_id,t.graphNodeId(),e),e.decomposedPath.namedNodes(Wh);for(const r of Wh)R_(this._referencing_params_by_all_named_node_ids,r.graphNodeId(),e);this._referenced_nodes_by_src_param_id.delete(e.graphNodeId())}}referencing_params(e){return this._referencing_params_by_referenced_node_id.get(e.graphNodeId())}referencingNodes(e,t){const r=this._referencing_params_by_referenced_node_id.get(e.graphNodeId());if(t.length=0,r){const s=new Map;for(const i of r){const o=i.node;s.set(o.graphNodeId(),o)}s.forEach(i=>{t.push(i)})}return t}nodesReferencedBy(e,t){const r=new Set([J.NODE_PATH]);Mm.length=0;for(const o of e.params.all)r.has(o.type())&&Mm.push(o);const s=new Map,i=[];for(const o of Mm)this._check_param(o,s,i);for(const o of i)s.set(o.node.graphNodeId(),o.node);return t.length=0,s.forEach(o=>{t.push(o)}),t}_check_param(e,t,r){if(e instanceof Bv){const s=e.value.node();s&&t.set(s.graphNodeId(),s);return}}notifyNameUpdated(e){const t=this._referencing_params_by_all_named_node_ids.get(e.graphNodeId());if(t){const r=O_(t);for(const s of r)s.notifyPathRebuildRequired(e)}}notifyParamsUpdated(e){const t=this._referencing_params_by_all_named_node_ids.get(e.graphNodeId());if(t){const r=O_(t);for(const s of r)s.options.isSelectingParam()&&s.notifyTargetParamOwnerParamsUpdated(e)}}}var mo=(n=>(n.TIME="time",n.RESOLUTION="resolution",n.SPOTLIGHTS_RAYMARCHING="spotLightsRayMarching",n.DIRECTIONALLIGHTS_RAYMARCHING="directionalLightsRayMarching",n.POINTLIGHTS_RAYMARCHING="pointLightsRayMarching",n))(mo||{});const SE={resolution:{value:new W(1e3,1e3)}};class O6{constructor(e){this.scene=e}addUniforms(e,t){const{paramConfigs:r,additionalTextureUniforms:s,timeDependent:i,resolutionDependent:o,raymarchingLightsWorldCoordsDependent:a}=t;for(const l of r)e[l.uniformName()]=l.uniform();const c=Object.keys(s);for(const l of c){const u=s[l];e[l]=u}i?this.addTimeUniform(e):this.removeTimeUniform(e),o?this.addResolutionUniforms(e):this.removeResolutionUniform(e),a?this.addRaymarchingUniforms(e):this.removeRaymarchingUniform(e)}addTimeUniform(e){e.time=this.scene.timeController.timeUniform()}removeTimeUniform(e){delete e.time}timeUniformValue(){return this.scene.timeController.timeUniform().value}addResolutionUniforms(e){e.resolution=SE.resolution}removeResolutionUniform(e){delete e.resolution}updateResolution(e,t){SE.resolution.value.copy(e).multiplyScalar(t)}addRaymarchingUniforms(e){this.scene.sceneTraverser.addLightsRayMarchingUniform(e)}removeRaymarchingUniform(e){this.scene.sceneTraverser.removeLightsRayMarchingUniform(e)}}class P6{constructor(e){this._scene=e,this._viewersById=new Map}registerViewer(e){this._viewersById.set(e.id(),e),this._updateCache()}unregisterViewer(e){this._viewersById.delete(e.id()),this._updateCache()}traverseViewers(e){this._viewersById.forEach(e)}viewer(e){const t={camera:e.camera,canvas:e.canvas,scene:this._scene};return ve.camerasRegister.createViewer(t)}firstViewer(){return this._firstViewer}markViewerAsRendered(e){this._lastRenderedViewer=e}lastRenderedViewer(){return this._lastRenderedViewer}_updateCache(){this._firstViewer=void 0,this._viewersById.forEach(e=>{this._firstViewer=this._firstViewer||e})}graphNode(){return this._graphNode=this._graphNode||this._createGraphNode()}_createGraphNode(){return new _r(this._scene,"SceneViewersRegister")}markViewerAsSizeUpdated(e){var t;this._viewersById.has(e.id())&&((t=this._graphNode)==null||t.setDirty())}}class N6{constructor(){this._requireWebGL2=!1}requireWebGL2(){return this._requireWebGL2}setRequireWebGL2(){this._requireWebGL2||(this._requireWebGL2=!0,ve.renderersController.setRequireWebGL2())}}class I6{constructor(e){this._scene=e,this._onWindowResizeBound=this._onWindowResize.bind(this)}graphNode(){return this._graphNode=this._graphNode||this._createGraphNode()}_createGraphNode(){const e=new _r(this._scene,"SceneWindowController");return globalThis.addEventListener("resize",this._onWindowResizeBound),e}_onWindowResize(){this.graphNode().setSuccessorsDirty()}dispose(){globalThis.removeEventListener("resize",this._onWindowResizeBound)}}class D6{constructor(){this._params_by_id=new Map,this._assetsRoot=null}register_param(e){this._params_by_id.set(e.graphNodeId(),e)}deregister_param(e){this._params_by_id.delete(e.graphNodeId())}traverse_params(e){this._params_by_id.forEach((t,r)=>{e(t)})}root(){return this._assetsRoot}setRoot(e){e==""&&(e=null),this._assetsRoot=e}}var Ws=(n=>(n.PENUMBRA="raymarchingPenumbra",n.SHADOW_BIAS_ANGLE="raymarchingShadowBiasAngle",n.SHADOW_BIAS_DISTANCE="raymarchingShadowBiasDistance",n))(Ws||{}),wo=(n=>(n[n.SPOT=0]="SPOT",n[n.DIRECTIONAL=1]="DIRECTIONAL",n[n.HEMISPHERE=2]="HEMISPHERE",n[n.POINT=3]="POINT",n))(wo||{});function $R(n){if(n.isSpotLight)return 0;if(n.isDirectionalLight)return 1;if(n.isHemisphereLight)return 2;if(n.isPointLight)return 3}function t0(n,e,t,r){e.value[t]=e.value[t]||r();const s=Ws.PENUMBRA;e.value[t].penumbra!=n.userData[s]&&(e.value[t].penumbra=n.userData[s],e.value.needsUpdate=!0)}function n0(n,e,t,r){e.value[t]=e.value[t]||r(),e.value[t].shadowBiasAngle!=n.userData[Ws.SHADOW_BIAS_ANGLE]&&(e.value[t].shadowBiasAngle=n.userData[Ws.SHADOW_BIAS_ANGLE],e.value.needsUpdate=!0),e.value[t].shadowBiasDistance!=n.userData[Ws.SHADOW_BIAS_DISTANCE]&&(e.value[t].shadowBiasDistance=n.userData[Ws.SHADOW_BIAS_DISTANCE],e.value.needsUpdate=!0)}function AE(){return{penumbra:0,shadowBiasAngle:0,shadowBiasDistance:0}}let bd=0;const L6=(n,e)=>{t0(n,e,bd,AE),n0(n,e,bd,AE),bd++};function F6(){bd=0}function TE(){return{penumbra:0,shadowBiasAngle:0,shadowBiasDistance:0}}let Cd=0;const U6=(n,e)=>{t0(n,e,Cd,TE),n0(n,e,Cd,TE),Cd++};function k6(){Cd=0}function ME(){return{penumbra:0,shadowBiasAngle:0,shadowBiasDistance:0}}let Ed=0;const B6=(n,e)=>{t0(n,e,Ed,ME),n0(n,e,Ed,ME),Ed++};function G6(){Ed=0}function V6(n){switch($R(n)){case wo.SPOT:return L6;case wo.DIRECTIONAL:return U6;case wo.POINT:return B6}}class z6{constructor(e){this.scene=e,this._spotLightsRayMarching={value:[]},this._directionalLightsRayMarching={value:[]},this._pointLightsRayMarching={value:[]},this._updateUniformsFunctionByLight=new WeakMap,this._uniformsByLight=new WeakMap,this._onObjectTraverseBound=this._onObjectTraverse.bind(this)}traverseScene(e){F6(),k6(),G6(),e=e||this.scene.threejsScene(),e.traverse(this._onObjectTraverseBound)}_onObjectTraverse(e){let t=this._updateUniformsFunctionByLight.get(e);if(t||e.isLight&&(t=V6(e),t&&this._updateUniformsFunctionByLight.set(e,t)),!t)return t;let r=this._uniformsByLight.get(e);r||(r=this._updateUniformsForLight(e),r&&this._uniformsByLight.set(e,r)),r&&t(e,r)}_updateUniformsForLight(e){switch($R(e)){case wo.SPOT:return this._spotLightsRayMarching;case wo.DIRECTIONAL:return this._directionalLightsRayMarching;case wo.POINT:return this._pointLightsRayMarching}}addLightsRayMarchingUniform(e){e[mo.SPOTLIGHTS_RAYMARCHING]=this._spotLightsRayMarching,e[mo.DIRECTIONALLIGHTS_RAYMARCHING]=this._directionalLightsRayMarching,e[mo.POINTLIGHTS_RAYMARCHING]=this._pointLightsRayMarching}removeLightsRayMarchingUniform(e){delete e[mo.SPOTLIGHTS_RAYMARCHING],delete e[mo.DIRECTIONALLIGHTS_RAYMARCHING],delete e[mo.POINTLIGHTS_RAYMARCHING]}}const RE=[];class H6{constructor(e){this.scene=e,this._renderersById=new Map,this._registerTimeByRenderer=new Map,this._resolves=[]}registerRenderer(e,t){let r=!0;(t==null?void 0:t.assignId)==!1&&(r=!1),r&&ve.renderersController.assignIdToRenderer(e);const s=ve.renderersController.rendererId(e);s!=null&&(this._renderersById.set(s,e),this._registerTimeByRenderer.set(e,performance.now()),this._updateCache(),this._renderersById.size==1&&this._flushCallbacksWithRenderer(e))}dispose(){this.renderers(RE);for(const e of RE)this.deregisterRenderer(e)}deregisterRenderer(e){const t=ve.renderersController.rendererId(e);t!=null&&(this._renderersById.delete(t),e.dispose(),this._updateCache())}lastRegisteredRenderer(){return this._lastRegisteredRenderer}renderers(e){return this._renderersById.forEach(t=>{e.push(t)}),e}_updateCache(){this._lastRegisteredRenderer=void 0,this._registerTimeByRenderer.forEach((e,t)=>{if(this._lastRegisteredRenderer==null)this._lastRegisteredRenderer=t;else{const r=this._registerTimeByRenderer.get(this._lastRegisteredRenderer);r!=null&&e>r&&(this._lastRegisteredRenderer=t)}})}_flushCallbacksWithRenderer(e){const t=[];Ts(this._resolves,t),this._resolves.length=0;for(const r of t)r(e)}async waitForAbstractRenderer(){return this._lastRegisteredRenderer?this._lastRegisteredRenderer:new Promise((e,t)=>{this._resolves.push(e)})}async waitForRenderer(){let e=await this.waitForAbstractRenderer();if(e instanceof bs||(e=e.webGLRenderer,e&&e instanceof bs))return e;e&&(e instanceof bs||console.log("unexpected renderer:",{renderer:e}))}}class j6{constructor(e){this.scene=e,this._activeXRController=null,this._activeARController=null,this._activeVRController=null}_setActiveXRController(e){this._activeXRController=e}activeXRController(){return this._activeXRController}setARControllerCreationFunction(e){this._ARControllerCreateFunction=e}ARControllerCreateFunction(){return this._ARControllerCreateFunction}setActiveARController(e){this._activeARController=e,this._setActiveXRController(e)}activeARController(){return this._activeARController}setVRControllerCreationFunction(e){this._VRControllerCreateFunction=e}VRControllerCreateFunction(){return this._VRControllerCreateFunction}setActiveVRController(e){this._activeVRController=e,this._setActiveXRController(e)}activeVRController(){return this._activeVRController}}class r0{constructor(e){this._cooker=new NX(this),this.cookController=new IX,this._graph=new DX,this.lifecycleController=new BX(this),this.loadingController=new GX(this),this.missingExpressionReferencesController=new zX(this),this.expressionsController=new kX,this.nodesController=new h6(this),this.graphNodesController=new HX(this),this.renderersRegister=new H6(this),this._objectsController=new YX(this),this._referencesController=new w6(this),this.perfMonitor=new R6(this),this.sceneTraverser=new z6(this),this.timeController=new Pp(this),this._disposed=!1,this._graph.setScene(this),this._paramSerializerClass=e==null?void 0:e.paramsSerializerClass,this.nodesController.createRoot(e==null?void 0:e.root),ve.scenesRegister.registerScene(this)}threejsScene(){return this.root().object}setUuid(e){return this._uuid=e}get uuid(){return this._uuid}setName(e){return this._name=r0.sanitizeName(e)}static sanitizeName(e){return e=yt.sanitizeName(e),e=e.toLowerCase(),e}name(){return this._name}get camerasController(){return this._camerasController=this._camerasController||new PX(this)}mainCamera(){return this.camerasController.mainCamera()}get cooker(){return this._cooker}get actorsManager(){return this._actorsManager=this._actorsManager||new OX(this)}get assets(){return this._assetsController=this._assetsController||new D6}async waitForCooksCompleted(){return await this.cookController.waitForCooksCompleted()}get dispatchController(){return this._dispatchController=this._dispatchController||new UX(this)}get eventsDispatcher(){return this._eventsDispatcher=this._eventsDispatcher||new M6(this)}get webXR(){return this._webXRController=this._webXRController||new j6(this)}setRaycaster(e){this.eventsDispatcher.setRaycaster(e)}get graph(){return this._graph}createNode(e,t){return this.root().createNode(e,t)}nodesByType(e){return this.nodesController.nodesByType(e)}get objectsController(){return this._objectsController}findObjectByMask(e){return this._objectsController.findObjectByMask(e)}objectsByMask(e,t){return this._objectsController.objectsByMask(e,t)}get referencesController(){return this._referencesController}get performance(){return this._performance=this._performance||new FX}get viewersRegister(){return this._viewersRegister=this._viewersRegister||new P6(this)}update(e,t){this.timeController.setDelta(e),this.timeController.incrementTimeIfPlaying(nz),this.sceneTraverser.traverseScene(t==null?void 0:t.scene)}setFrame(e){this.timeController.setFrame(e)}setFrameToStart(){this.timeController.setFrameToStart()}frame(){return this.timeController.frame()}time(){return this.timeController.time()}maxFrame(){return this.timeController.maxFrame()}play(){this.timeController.play()}pause(){this.timeController.pause()}incrementTime(e){this.timeController.incrementTime(e)}incrementTimeIfPlaying(e){this.timeController.incrementTimeIfPlaying(e)}registerRenderer(e,t){return this.renderersRegister.registerRenderer(e,t)}get uniformsController(){return this._uniformsController=this._uniformsController||new O6(this)}get webglController(){return this._webglController=this._webglController||new N6}get windowController(){return this._windowController=this._windowController||new I6(this)}dispose(){this._disposed!=!0&&(this._disposed=!0,this.batchUpdates(()=>{this.nodesController.traverseNodes(e=>{var t;(t=e.parent())==null||t.removeNode(e)})}),this._windowController&&(this._windowController.dispose(),this._windowController=void 0),this.timeController.dispose(),this.renderersRegister.dispose(),this.camerasController.dispose(),this.root().dispose(),ve.scenesRegister.deregisterScene(this))}disposed(){return this._disposed}paramSerializerClass(){return this._paramSerializerClass}async batchUpdates(e){this._cooker.block(),await e(),this._cooker.unblock()}node(e){return this.nodesController.node(e)}root(){return this.nodesController.root()}traverseNodes(e){this.nodesController.traverseNodes(e)}registerOnBeforeTick(e,t){this.timeController.registerOnBeforeTick(e,t)}unRegisterOnBeforeTick(e){this.timeController.unRegisterOnBeforeTick(e)}registeredBeforeTickCallbacks(){return this.timeController.registeredBeforeTickCallbacks()}hasBeforeTickCallback(e){return this.timeController.hasBeforeTickCallback(e)}registerOnAfterTick(e,t){this.timeController.registerOnAfterTick(e,t)}unRegisterOnAfterTick(e){this.timeController.unRegisterOnAfterTick(e)}registeredAfterTickCallbacks(){return this.timeController.registeredAfterTickCallbacks()}hasAfterTickCallback(e){return this.timeController.hasAfterTickCallback(e)}}class W6{constructor(e){this._warnings=[],this._readonly=!1,this._loadedWithoutAssemblers=!1}warnings(){return this._warnings}readonly(){return this._readonly}loadedWithoutAssemblers(){return this._loadedWithoutAssemblers}reset(){this._warnings=[]}markAsLoadedWithoutAssemblers(){this._readonly=!0,this._loadedWithoutAssemblers=!0}addWarning(e){this._warnings.push(e),Il.debugLoadProgress()&&console.warn(e)}}class jp{constructor(e,t){this._data=e,this._options=t,this.report=new W6(this)}static async loadData(e,t){return await new jp(e,t).scene(t==null?void 0:t.serializers)}setMigrateHelper(e){this._migrateHelper=e}migrateHelper(){return this._migrateHelper}oldPolygonjsSceneVersion(){var e;const t=this._data.properties;if(t)return(e=t.versions)==null?void 0:e.polygonjs}scene(e){this._migrateHelper&&(this._data=this._migrateHelper.migrateData(this._data)),Il.debugLoadProgress()&&console.log(`polygonjs version:${this.oldPolygonjsSceneVersion()}`);const t=this._data.root,s={paramsInitValueOverrides:jo.non_spare_params_data_value(t.params),nodeName:jR,serializerClass:e==null?void 0:e.nodeSerializerClass},i=this._data.embeddedPolyNodes;if(i){const h=Object.keys(i);for(let d of h){const p=d.split("/"),_=p[0],g=p[1],f=i[d];zp.createNodeClassAndRegister({node_context:_,node_type:g,data:f})}}const o=new r0({root:s,paramsSerializerClass:e==null?void 0:e.paramsSerializerClass});this._options&&(this._options.sceneName&&o.setName(this._options.sceneName),this._options.measurePerformanceOnLoad==!0&&o.performance.start()),o.loadingController.markAsLoading();const a=this._data.properties;if(a){const h=a.maxFrame||600;o.timeController.setMaxFrame(h);const d=a.maxFrameLocked;d&&o.timeController.setMaxFrameLocked(d);const p=a.realtimeState;p!=null&&o.timeController.setRealtimeState(p),o.setFrame(a.frame||Pp.START_FRAME);const _=a.mainCameraNodePath||a.mainCameraPath;_&&o.camerasController.setMainCameraPath(_)}o.cooker.block(),this._base_operations_composer_nodes_with_resolve_required=void 0;const l=new yR().dispatchNode(o.root());t&&l.process_data(this,t);const u=this._data.ui;return u&&l.process_ui_data(this,u),this._resolve_operation_containers_with_path_param_resolve(),this._options&&(this._options.nodeCookWatcher&&this._options.nodeCookWatcher(o),this._options.configureScene&&this._options.configureScene(o)),o.loadingController.markAsLoaded(),o.cooker.unblock(),o}shadersData(){return this._data.shaders}jsFunctionBodiesData(){return this._data.jsFunctionBodies}add_operations_composer_node_with_path_param_resolve_required(e){this._base_operations_composer_nodes_with_resolve_required||(this._base_operations_composer_nodes_with_resolve_required=[]),this._base_operations_composer_nodes_with_resolve_required.push(e)}_resolve_operation_containers_with_path_param_resolve(){if(this._base_operations_composer_nodes_with_resolve_required)for(let e of this._base_operations_composer_nodes_with_resolve_required)e.resolveOperationContainersPathParams()}}class Rl{constructor(e){this.options=e,this._onLoadCompleteCalled=!1,this._progress=0,this._viewerMarkedAsReady=!1,this._sceneMarkedAsReady=!1,this._debug2("new ScenePlayerImporter",e)}static async loadSceneData(e){const t=new Rl(e);return{scene:await t.loadScene(e.serializers),viewer:t._viewer}}async _onLoadComplete(e){this._onLoadCompleteCalled!=!0&&(this._onLoadCompleteCalled=!0,this._viewer&&this._markViewerAsReady(this._viewer),await this._markSceneAsReady(e))}_markViewerAsReady(e){this._viewerMarkedAsReady||(this._viewerMarkedAsReady=!0,e.markAsReady(),this._dispatchEvent(wi.VIEWER_READY))}async _markSceneAsReady(e){this._sceneMarkedAsReady||(this._sceneMarkedAsReady=!0,await e.cookController.waitForCooksCompleted(),e.setFrame(Pp.START_FRAME),this.options.autoPlay!=!1&&e.play(),e.loadingController.dispatchReadyEvent(),this._dispatchEvent(wi.SCENE_READY))}_onNodesCookProgress(e,t){const r=oP.nodes;((i,o)=>{var a;const c=r.start+r.mult*i;this._progress=c,this.options.onProgress&&this.options.onProgress(c,o),iP.dispatchProgressEvent(c,(a=this._scene)==null?void 0:a.name())})(e,t),e>=1&&this._onLoadComplete(t.scene)}async _watchNodesProgress(e){e.root().loadProgress.watchNodesProgress((t,r)=>{this._onNodesCookProgress(t,r)})}async loadScene(e){const t=()=>new Promise(async i=>{const o=this.options.configureScene,c=new jp(this.options.sceneData,{sceneName:this.options.sceneName,configureScene:o,nodeCookWatcher:u=>{this._watchNodesProgress(u)}}).scene(e);c.timeController.forbidPlayUntilAllNodesCooked(),this._scene=c,this._dispatchEvent(wi.SCENE_CREATED),this.options.renderer&&c.renderersRegister.registerRenderer(this.options.renderer);const l=async()=>{const u=await c.camerasController.mainCamera({findAnyCamera:!1,printCameraNotFoundError:this._progress>=1,cameraMaskOverride:this.options.cameraMaskOverride});this._debug2("scene.camerasController:",{camera:u,cameraPath:c.root().mainCameraController.rawCameraPath()}),u&&this._onCameraCreatorNodeLoadedResolve&&this._onCameraCreatorNodeLoadedResolve()};this._onCameraCreatorNodeLoadedResolve=()=>{c.camerasController.removeOnCameraObjectsUpdated(l),i(c)},c.camerasController.onCameraObjectsUpdated(l)});this._scene=await t();const r=this._scene;return await(async()=>{const i=this._domElement();let o=!1;this.options.createViewer!=null&&(o=this.options.createViewer),(i||o)&&(this._viewer=await r.camerasController.createMainViewer({autoRender:!1,renderer:this.options.renderer,cameraMaskOverride:this.options.cameraMaskOverride}),this._viewer&&(i&&this._viewer.mount(i),this._sceneMarkedAsReady==!0&&this._markViewerAsReady(this._viewer),this._dispatchEvent(wi.VIEWER_MOUNTED)))})(),r}_domElement(){const e=this.options.domElement;if(e)if(Ke(e)){const t=document.getElementById(e);if(t)return t}else return e}_dispatchEvent(e){this._debug2("_dispatchEvent",{eventName:e,scene:this._scene,viewer:this._viewer});const t=[this._domElement(),document];if(!this._scene){console.warn("no event emitted as no scene preset");return}const r={scene:this._scene,viewer:this._viewer},s=i=>new CustomEvent(i,{detail:r});for(let i of t)i&&(i.dispatchEvent(s(e)),this._scene&&i.dispatchEvent(s(`${e}-${this._scene.name()}`)))}_debug(e){Rl._debug(e)}_debug2(e,t){Rl._debug2(e,t)}static _debug(e){No.debug(e)}static _debug2(e,t){No.debug2(e,t)}}class mt{constructor(e){this.param=e}node(){return this._node=this._node||this.param.node}static requiredArguments(){return console.warn("Expression.Method._Base.required_arguments virtual method call. Please override"),[]}static optionalArguments(){return[]}static minAllowedArgumentsCount(){return this.requiredArguments().length}static maxAllowedArgumentsCount(){return this.minAllowedArgumentsCount()+this.optionalArguments().length}static allowedArgumentsCount(e){return e>=this.minAllowedArgumentsCount()&&e<=this.maxAllowedArgumentsCount()}processArguments(e){throw"Expression.Method._Base.process_arguments virtual method call. Please override"}async getReferencedNodeContainer(e){var t,r;const s=this.getReferencedNode(e);if(s){let i;if(s.isDirty()||(r=(t=s.flags)==null?void 0:t.bypass)!=null&&r.active()?i=await s.compute():i=s.containerController.container(),i&&i.coreContent()!=null)return i;throw`referenced node invalid: ${s.path()}`}else throw`invalid input (${e})`}getReferencedParam(e,t){const r=this.node();return r?bt.findParam(r,e,t):null}findReferencedGraphNode(e,t){if(Ye(e)){const s=e,i=this.node();if(i)return i.io.inputs.inputGraphNode(s)}else{const s=e;return this.getReferencedNode(s,t)}return null}getReferencedNode(e,t){let r=null;const s=this.node();if(Ke(e)){if(s){const i=e;r=bt.findNode(s,i,t)}}else if(s){const i=e;r=s.io.inputs.input(i)}return r||null}findDependency(e){return null}createDependencyFromIndexOrPath(e){if(this.param.disposed()==!0)return null;const{indexOrPath:t}=e,r=new Gp,s=t!=null?this.findReferencedGraphNode(t,r):e.node;return s?this.createDependency(s,e,r):(ve.warn(`node not found for path '${t}' from param '${this.param.path()}'`),null)}createDependency(e,t,r){return wp.create(this.param,t,e,r)}}class X6 extends mt{static requiredArguments(){return[["string","path to node"],["number","object index (optional)"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}processArguments(e){return new Promise(async(t,r)=>{if(e.length==1||e.length==2){const s=e[0];let i=parseInt(e[1]);(isNaN(i)||i==null)&&(i=0);let o;try{o=await this.getReferencedNodeContainer(s)}catch(a){r(a);return}if(o){const a=o.coreContent();if(a){const c=a.threejsObjects()[i];if(c){const l=c.animations;if(!l)return[];const u=new Array(l.length);let h=0;for(const d of l)u[h]=d.name,h++;t(u)}}else t([])}}else t([])})}}class $6 extends mt{static requiredArguments(){return[["string","arguments list"],["number","index"]]}async processArguments(e){if(e.length==2){const t=e[0],r=e[1];return t.split(" ")[r]}return 0}}class q6 extends mt{static requiredArguments(){return[["string","arguments list"]]}async processArguments(e){return e.length==1?e[0].split(" ").length:0}}const Ta=new Ht,Y6=["min","max","size","center"],K6=["x","y","z"];class Z6 extends mt{static requiredArguments(){return[["string","path to node"],["string","vector name, min, max, size or center"],["string","component_name, x,y or z"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length>=1){const t=e[0],r=e[1],s=e[2],i=await this.getReferencedNodeContainer(t);if(i)return this._get_value_from_container(i,r,s)}return 0}_get_value_from_container(e,t,r){const s=e.coreContent();if(s?s.boundingBox(Ta):Ta.makeEmpty(),!t)return Ta;if(Y6.indexOf(t)>=0){let i=new T;switch(t){case"size":Ta.getSize(i);break;case"center":Ta.getCenter(i);break;default:i=Ta[t]}return r?K6.indexOf(r)>=0?i[r]:-1:i}else return-1}}async function J6(n){const t=await(await fetch(n)).blob();return(globalThis.URL||globalThis.webkitURL).createObjectURL(t)}class Q6 extends mt{static requiredArguments(){return[["string","url"]]}async processArguments(e){if(e.length>=1){const t=e[0];return await J6(t)}return""}}class e$ extends mt{static requiredArguments(){return[["string","path to node"],["number","object index"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==2){const t=e[0];let r=parseInt(e[1]);isNaN(r)&&(r=0);const s=await this.getReferencedNodeContainer(t);if(s){const i=s.coreContent();if(i){const o=i.threejsObjects().filter(a=>ve.camerasRegister.objectRegistered(a))[r];if(o)return o.name}}}return""}}class t$ extends mt{static requiredArguments(){return[["string","path to node"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==1){const t=e[0],r=await this.getReferencedNodeContainer(t);if(r){const s=r.coreContent();if(s){const i=s.threejsObjects().filter(c=>ve.camerasRegister.objectRegistered(c)),o=new Array(i.length);let a=0;for(const c of i)o[a]=c.name,a++;return o}}}return[]}}class n$ extends mt{static requiredArguments(){return[["string","path to node"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==1){const t=e[0],r=await this.getReferencedNodeContainer(t);if(r){const s=r.coreContent();if(s)return s.threejsObjects().filter(o=>ve.camerasRegister.objectRegistered(o)).length}}return 0}}const wE=new Ht,Rm=new T;class r$ extends mt{static requiredArguments(){return[["string","path to node"],["string","component_name, x,y or z"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length>=1){const t=e[0],r=e[1],s=await this.getReferencedNodeContainer(t);if(s){const i=s.coreContent();if(i)if(i.boundingBox(wE),wE.getCenter(Rm),r){const o=Rm[r];return o??0}else return Rm}}return 0}}class s$ extends mt{static requiredArguments(){return[["string","path to param"]]}findDependency(e){const{indexOrPath:t}=e;if(t==null||!Ke(t))return null;const r=new Gp,s=this.getReferencedParam(t,r);return s?(this._referencedParam=s,this.createDependency(s,{indexOrPath:t},r)):null}async processArguments(e){return new Promise(async(t,r)=>{let s=0;if(e.length==1){const i=e[0],o=this._referencedParam||this.getReferencedParam(i);if(o){o.isDirty()&&await o.compute();const a=o.value;a!=null&&(s=a,t(s))}else r(0)}})}}class i$ extends mt{static requiredArguments(){return[["string","path to param"]]}findDependency(e){const{indexOrPath:t}=e;if(t==null||!Ke(t))return null;const r=new Gp,s=this.getReferencedParam(t,r);return s?(this._referencedParam=s,this.createDependency(s,{indexOrPath:t},r)):null}async processArguments(e){if(e.length==1){const t=e[0],r=this._referencedParam||this.getReferencedParam(t);if(r){r.isDirty()&&await r.compute();const s=r.value;if(s instanceof vp||s instanceof Zr){const i=s.graphNodePath();if(i!=null)return i}}}return""}}var rn=(n=>(n.ACTOR="actor",n.ACTOR_INSTANCE="actorInstance",n.ACTOR_POINT="actorPoint",n.ADD="add",n.ADJACENCY="adjacency",n.ANIMATION_COPY="animationCopy",n.ATTRIB_ADD_MULT="attribAddMult",n.ATTRIB_COPY="attribCopy",n.ATTRIB_CREATE="attribCreate",n.ATTRIB_DELETE="attribDelete",n.ATTRIB_ID="attribId",n.ATTRIB_PROMOTE="attribPromote",n.ATTRIB_RENAME="attribRename",n.ATTRIB_SET_AT_INDEX="attribSetAtIndex",n.ATTRIB_TRANSFER="attribTransfer",n.AUDIO_NOTES="audioNotes",n.AXES_HELPER="axesHelper",n.BBOX_SCATTER="bboxScatter",n.BLEND="blend",n.BOX="box",n.BOX_LINES="boxLines",n.BVH="BVH",n.BVH_VISUALIZER="BVHVisualizer",n.CACHE="cache",n.CAD_BOOLEAN="CADBoolean",n.CAD_BOX="CADBox",n.CAD_CIRCLE="CADCircle",n.CAD_CIRCLE_2D="CADCircle2D",n.CAD_CIRCLE_3_POINTS="CADCircle3Points",n.CAD_CONE="CADCone",n.CAD_CONVERT_DIMENSION="CADConvertDimension",n.CAD_CURVE_2D_TO_SURFACE="CADCurve2DToSurface",n.CAD_CURVE_FROM_POINTS="CADCurveFromPoints",n.CAD_CURVE_FROM_POINTS_2D="CADCurveFromPoints2D",n.CAD_CURVE_TRIM="CADCurveTrim",n.CAD_ELLIPSE="CADEllipse",n.CAD_ELLIPSE_2D="CADEllipse2D",n.CAD_EXPORTER_STEP="CADExporterSTEP",n.CAD_EXTRUDE="CADExtrude",n.CAD_FILE_STEP="CADFileSTEP",n.CAD_FILLET="CADFillet",n.CAD_GROUP="CADGroup",n.CAD_LOFT="CADLoft",n.CAD_MIRROR="CADMirror",n.CAD_PIPE="CADPipe",n.CAD_POINT="CADPoint",n.CAD_POINT_2D="CADPoint2D",n.CAD_POINTS_FROM_CURVE="CADPointsFromCurve",n.CAD_RECTANGLE="CADRectangle",n.CAD_REVOLUTION="CADRevolution",n.CAD_SEGMENT="CADSegment",n.CAD_SPHERE="CADSphere",n.CAD_THICKNESS="CADThickness",n.CAD_TORUS="CADTorus",n.CAD_TRANSFORM="CADTransform",n.CAD_TRANSFORM_2D="CADTransform2D",n.CAD_TRIANGULATE="CADTriangulate",n.CAD_TUBE="CADTube",n.CAD_UNPACK="CADUnpack",n.CAD_WEDGE="CADWedge",n.CAMERA_PROJECT="cameraProject",n.CAPSULE="capsule",n.CIRCLE="circle",n.CIRCLE_3_POINTS="circle3Points",n.CLOTH_PREPARE="clothPrepare",n.CLOTH_SOLVER="clothSolver",n.COLOR="color",n.CONE="cone",n.CONTACT_SHADOWS="contactShadows",n.COPY="copy",n.CURVE_FROM_POINTS="curveFromPoints",n.CSG_ARC="CSGArc",n.CSG_BOOLEAN="CSGBoolean",n.CSG_CENTER="CSGCenter",n.CSG_CIRCLE="CSGCircle",n.CSG_BOX="CSGBox",n.CSG_DODECAHEDRON="CSGDodecahedron",n.CSG_ELLIPSE="CSGEllipse",n.CSG_ELLIPSOID="CSGEllipsoid",n.CSG_EXPAND="CSGExpand",n.CSG_EXTRUDE_LINEAR="CSGExtrudeLinear",n.CSG_EXTRUDE_RECTANGULAR="CSGExtrudeRectangular",n.CSG_EXTRUDE_ROTATE="CSGExtrudeRotate",n.CSG_HULL="CSGHull",n.CSG_LINE="CSGLine",n.CSG_MIRROR="CSGMirror",n.CSG_OFFSET="CSGOffset",n.CSG_POLYGON="CSGPolygon",n.CSG_POLYHEDRON="CSGPolyhedron",n.CSG_PROJECT="CSGProject",n.CSG_RECTANGLE="CSGRectangle",n.CSG_SPHERE="CSGSphere",n.CSG_STAR="CSGStar",n.CSG_TORUS="CSGTorus",n.CSG_TRANSFORM_2D="CSGTransform2D",n.CSG_TRANSFORM_RESET="CSGTransformReset",n.CSG_TRIANGLE="CSGTriangle",n.CSG_TRIANGULATE="CSGTriangulate",n.CSG_TUBE="CSGTube",n.CSG_TUBE_ELLIPTIC="CSGTubeElliptic",n.CSS2D_OBJECT="CSS2DObject",n.CSS3D_OBJECT="CSS3DObject",n.DATA="data",n.DATA_URL="dataUrl",n.DECAL="decal",n.DELETE="delete",n.DELETE_BY_NAME="deleteByName",n.ENTITY_BUILDER="entityBuilder",n.FACET="facet",n.FUSE="fuse",n.GROUND_PROJECTED_SKYBOX="groundProjectedSkybox",n.HIERARCHY="hierarchy",n.ICOSAHEDRON="icosahedron",n.IFC_FILTER_CATEGORIES="IFCFilterCategories",n.INSTANCE="instance",n.INSTANCE_BUILDER="instanceBuilder",n.INSTANCED_MESH_TO_MESH="instancedMeshToMesh",n.INSTANCE_UPDATE="instanceUpdate",n.JITTER="jitter",n.LATTICE="lattice",n.LAYER="layer",n.LOD="lod",n.LOOK_AT="lookAt",n.MAPBOX_TRANSFORM="mapboxTransform",n.MATERIAL="material",n.MATERIAL_PROPERTIES="materialProperties",n.MERGE="merge",n.METABALL="metaball",n.MIRROR="mirror",n.NOISE="noise",n.NORMALS="normals",n.NORMALS_HELPER="normalsHelper",n.OBJECT_BUILDER="objectBuilder",n.OBJECT_PROPERTIES="objectProperties",n.OBJECTS_LAYOUT="objectsLayout",n.PALETTE="palette",n.PARTICLES_SYSTEM_GPU="particlesSystemGpu",n.PARTICLES_SYSTEM_GPU_ATTRIBUTES="particlesSystemGpuAttributes",n.PARTICLES_SYSTEM_GPU_MATERIAL="particlesSystemGpuMaterial",n.PHYSICS_DEBUG="physicsDebug",n.PHYSICS_GROUND="physicsGround",n.PHYSICS_RBD_ATTRIBUTES="physicsRBDAttributes",n.PHYSICS_RBD_JOINTS="physicsRBDJoints",n.PHYSICS_WORLD="physicsWorld",n.PHYSICS_PLAYER="physicsPlayer",n.PLANE="plane",n.POINT="point",n.POINT_BUILDER="pointBuilder",n.POLAR_TRANSFORM="polarTransform",n.POLYWIRE="polywire",n.QUAD_CONNECTION="quadConnection",n.QUAD_CORNERS="quadCorners",n.QUAD_EXTRUDE="quadExtrude",n.QUAD_FUSE="quadFuse",n.QUAD_MIRROR="quadMirror",n.QUAD_PLANE="quadPlane",n.QUAD_SMOOTH="quadSmooth",n.QUAD_TRIANGULATE="quadTriangulate",n.QUAD_UNIQUE_NEIGHBOUR_ID="quadUniqueNeighbourId",n.QUADRANGULATE="quadrangulate",n.RAY="ray",n.REFLECTOR="reflector",n.RING="ring",n.ROUNDED_BOX="roundedBox",n.SCATTER="scatter",n.SDF_BUILDER="SDFBuilder",n.SET_CHILDREN="setChildren",n.SET_GEOMETRY="setGeometry",n.SHEAR="shear",n.SHORTEST_PATH="shortestPath",n.SKELETON_HELPER="skeletonHelper",n.SKIN="skin",n.SORT="sort",n.SPHERE="sphere",n.SPLIT="split",n.SUBDIVIDE="subdivide",n.SWITCH="switch",n.TANGENT="tangent",n.TANGENTS_HELPER="tangentsHelper",n.TET_DELETE="tetDelete",n.TET_EMBED="tetEmbed",n.TET_SOFT_BODY_SOLVER="tetSoftBodySolver",n.TET_TRIANGULATE="tetTriangulate",n.TETRAHEDRALIZE="tetrahedralize",n.TETRAHEDRON="tetrahedron",n.TEXT="text",n.TEXTURE_COPY="textureCopy",n.TEXTURE_PROPERTIES="textureProperties",n.TORUS="torus",n.TORUS_KNOT="torusKnot",n.TRANSFORM="transform",n.TRANSFORM_COPY="transformCopy",n.TRANSFORM_MULTI="transformMulti",n.TRANSFORM_RESET="transformReset",n.TUBE="tube",n.UV_LAYOUT="uvLayout",n.UV_TRANSFORM="uvTransform",n.UV_UNWRAP="uvUnwrap",n.WEB_XR_AR_ESTIMATED_LIGHT="webXRAREstimatedLight",n.WFC_BUILDER="WFCBuilder",n.WFC_DEBUG="WFCDebug",n.WFC_SOLVER="WFCSolver",n.WFC_RULE_FROM_PROXIMITY="WFCRuleFromProximity",n.WFC_RULE_CONNECTION_FROM_SIDE_NAME="WFCRuleConnectionFromSideName",n.WFC_RULE_CONNECTION_TO_GRID_BORDER="WFCRuleConnectionToGridBorder",n.WFC_RULE_TILE_WEIGHT="WFCRuleTileWeight",n.WFC_TILE_EMPTY_OBJECT="WFCTileEmptyObject",n.WFC_TILE_ERROR_OBJECT="WFCTileErrorObject",n.WFC_TILE_UNRESOLVED_OBJECT="WFCTileUnresolvedObject",n.WFC_TILE_PROPERTIES="WFCTileProperties",n.WFC_TILE_SIDE_NAME="WFCTileSideName",n.WFC_TILE_TRANSFORM="WFCTileTransform",n))(rn||{}),Rn=(n=>(n.FILE_3DS="file3DS",n.FILE_DRC="fileDRC",n.FILE_FBX="fileFBX",n.FILE_GEOJSON="fileGEOJSON",n.FILE_GLTF="fileGLTF",n.FILE_JSON="fileJSON",n.FILE_MPD="fileMPD",n.FILE_OBJ="fileOBJ",n.FILE_PDB="filePDB",n.FILE_PLY="filePLY",n.FILE_STL="fileSTL",n.FILE_SVG="fileSVG",n.FILE_USDZ="fileUSDZ",n.FILE_VOX="fileVOX",n))(Rn||{}),sg=(n=>(n.FILE_DRC="fileMultiDRC",n.FILE_FBX="fileMultiFBX",n.FILE_GLTF="fileMultiGLTF",n.FILE_JSON="fileMultiJSON",n.FILE_MPD="fileMultiMPD",n.FILE_OBJ="fileMultiOBJ",n.FILE_PDB="fileMultiPDB",n.FILE_PLY="fileMultiPLY",n.FILE_STL="fileMultiSTL",n.FILE_SVG="fileMultiSVG",n))(sg||{}),ul=(n=>(n.EXPORTER_GLTF="exporterGLTF",n.EXPORTER_OBJ="exporterOBJ",n.EXPORTER_PLY="exporterPLY",n.EXPORTER_STL="exporterSTL",n.EXPORTER_USDZ="exporterUSDZ",n))(ul||{}),qR=(n=>(n.COPY="copy",n.EASING="easing",n.PLAY="play",n.TARGET="target",n))(qR||{});function OE(n){return n&&n.type()==rn.COPY&&n.type()==qR.COPY}class o$ extends mt{static requiredArguments(){return[["string","path to copy"],["integer","default value"]]}static optionalArguments(){return[["string","attribute name (optional)"]]}findDependency(e){if(e.indexOrPath==null)return null;const t=this.findReferencedGraphNode(e.indexOrPath);if(OE(t)){const r=t.stampNode();return this.createDependency(r,{indexOrPath:e.indexOrPath})}return null}processArguments(e){return new Promise((t,r)=>{if(e.length>=1){const s=e[0],i=e[1]||0,o=e[2],a=this.node(),c=a?bt.findNode(a,s):null;let l;OE(c)&&(l=c.stampValue(o)),l==null&&(l=i),t(l)}else t(0)})}}const a$=[0,"0","x"],c$=[1,"1","y"];class l$ extends mt{constructor(){super(...arguments),this._resolution=new W}static requiredArguments(){return[["string","path to node"],["string","component_name: x or y"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==1||e.length==2){const t=e[0],r=e[1],s=await this.getReferencedNodeContainer(t);if(s){const i=s.resolution();if(r){if(a$.includes(r))return i[0];if(c$.includes(r))return i[1]}else return this._resolution.set(i[0],i[1]),this._resolution}return this._resolution.set(1,1),e.length==1?1:this._resolution}return 1}}function YR(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}function KR(){return/(iPad|iPhone|iPod)/g.test(navigator.userAgent)}function ZR(){return/(Android)/g.test(navigator.userAgent)}function u$(){return YR()||KR()||ZR()||"ontouchstart"in globalThis||globalThis.DocumentTouch!=null&&document instanceof globalThis.DocumentTouch}function h$(){return navigator&&navigator.userAgent!=null&&navigator.userAgent.indexOf("Chrome")!=-1}function d$(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function JR(){return globalThis.innerHeight>globalThis.innerWidth}function p$(){return!JR()}function f$(){var n,e;const t=globalThis.orientation;return t??(((e=(n=globalThis==null?void 0:globalThis.screen)==null?void 0:n.orientation)==null?void 0:e.angle)||0)}class Do{static isChrome(){return this._isChrome==null&&(this._isChrome=h$()),this._isChrome}static isSafari(){return this._isSafari==null&&(this._isSafari=d$()),this._isSafari}static isMobile(){return this._isMobile==null&&(this._isMobile=YR()),this._isMobile}static isiOS(){return this._isiOS==null&&(this._isiOS=KR()),this._isiOS}static isAndroid(){return this._isAndroid==null&&(this._isAndroid=ZR()),this._isAndroid}static isTouchDevice(){return this._isTouchDevice==null&&(this._isTouchDevice=u$()),this._isTouchDevice}}Do.isPortrait=JR;Do.isLandscape=p$;Do.screenOrientation=f$;class m$ extends mt{static requiredArguments(){return[]}async processArguments(e){return Do.isMobile()}}class _$ extends mt{static requiredArguments(){return[]}async processArguments(e){return Do.isTouchDevice()}}class g$ extends mt{static requiredArguments(){return[["array_or_string","array or string to count elements of"]]}async processArguments(e){if(e.length==1){const t=e[0];if(Ke(t)||_t(t))return t.length}return 0}}class v$ extends mt{static requiredArguments(){return[["array","array to join the elements of"],["separator","separator used to join the elements"]]}async processArguments(e){if(e.length==1||e.length==2){const t=e[0];let r=e[1];if(r==null&&(r=" "),_t(t))return t.join(r)}return""}}class y$ extends mt{static requiredArguments(){return[["string","javascript expression"]]}async processArguments(e){let t=0;if(e.length==1){const r=e[0];if(this._function=this._function||this._create_function(r),this._function)try{t=this._function(this.param.scene(),this.param.node,this.param)}catch(s){console.warn("expression error"),console.warn(s)}}return t}_create_function(e){return new Function("scene","node","param",`return ${e}`)}}class x$ extends mt{static requiredArguments(){return[["string","path to node"],["string","attribute name"],["index","object index"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}processArguments(e){return new Promise(async(t,r)=>{if(e.length==2||e.length==3){const s=e[0],i=e[1],o=e[2]||0;let a=null;try{a=await this.getReferencedNodeContainer(s)}catch(c){r(c)}if(a){const c=this._get_value_from_container(a,i,o);t(c)}}else console.warn(`${e.length} given when 2 or 3 expected`),t(0)})}_get_value_from_container(e,t,r){const s=e.coreContent();if(s){const i=s.allCoreObjects()[r];return i?i.attribValue(t):0}else return null}}class b$ extends mt{static requiredArguments(){return[["string","path to node"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==1){const t=e[0],r=await this.getReferencedNodeContainer(t);if(r){const s=r.coreContent();if(s)return s.allObjects().length}}return 0}}class C$ extends mt{static requiredArguments(){return[["string","path to node"],["number","object index"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==2){const t=e[0];let r=parseInt(e[1]);isNaN(r)&&(r=0);const s=await this.getReferencedNodeContainer(t);if(s){const i=s.coreContent();if(i){const o=i.allObjects()[r];if(o)return o.name}}}return""}}class E$ extends mt{static requiredArguments(){return[["string","path to node"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==1){const t=e[0],r=await this.getReferencedNodeContainer(t);if(r){const s=r.coreContent();if(s){const i=s.allObjects(),o=new Array(i.length);let a=0;for(const c of i)o[a]=c.name,a++;return o}}}return[]}}class S$ extends mt{static requiredArguments(){return[["string","path to node"]]}findDependency(e){const{indexOrPath:t}=e;if(t==null)return null;const r=this.findReferencedGraphNode(t);if(r){const s=r;if(s.nameController){const i=s.nameController.graphNode();return this.createDependency(i,{indexOrPath:t})}}return null}async processArguments(e){if(e.length==1){const t=e[0],r=this.getReferencedNode(t);if(r){const s=r.name();return NM(s)}}return 0}}class A$ extends mt{static requiredArguments(){return[["string","path to node"]]}findDependency(e){const{indexOrPath:t}=e;if(t==null)return null;const r=this.findReferencedGraphNode(t);if(r){const s=r;if(s.nameController){const i=s.nameController.graphNode();return this.createDependency(i,{indexOrPath:t})}}return null}async processArguments(e){if(e.length==1){const t=e[0],r=this.getReferencedNode(t);if(r)return r.name()}return""}}class T$ extends mt{static requiredArguments(){return[["string","number"]]}async processArguments(e){const t=e[0]||2;return`${e[1]||0}`.padStart(t,"0")}}class M$ extends mt{static requiredArguments(){return[]}async processArguments(e){return ve.playerMode()}}const PE=3,NE=[];class R$ extends mt{static requiredArguments(){return[["string","path to node"],["string","attribute name"],["index","point index"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}processArguments(e){return new Promise(async(t,r)=>{if(e.length==PE){const s=e[0],i=e[1],o=e[2];let a=null;try{a=await this.getReferencedNodeContainer(s)}catch(c){r(c)}if(a){const c=this._get_value_from_container(a,i,o);t(c)}}else console.warn(`${e.length} given when expected ${PE}`),t(0)})}_get_value_from_container(e,t,r){const s=e.coreContent();if(s){s.points(NE);const i=NE[r];return i?i.attribValue(t):0}else return null}}class w$ extends mt{static requiredArguments(){return[["string","path to node"]]}findDependency(e){return this.createDependencyFromIndexOrPath(e)}async processArguments(e){if(e.length==1){const t=e[0],r=await this.getReferencedNodeContainer(t);if(r){const s=r.coreContent();if(s)return s.pointsCount()}}return 0}}class O$ extends mt{static requiredArguments(){return[,["x","value"],["min","range min"],["max","range max"]]}async processArguments(e){if(e.length==3){const t=e[0],r=e[1],s=e[2];return On.smoothstep(t,r,s)}return 0}}class P$ extends mt{static requiredArguments(){return[,["x","value"],["min","range min"],["max","range max"]]}async processArguments(e){if(e.length==3){const t=e[0],r=e[1],s=e[2];return On.smootherstep(t,r,s)}return 0}}function IE(n){return n&&n.type()==Ac.SOLVER}class N$ extends mt{static requiredArguments(){return[]}static optionalArguments(){return[["string","path to solver node"]]}_solverNode(){return this.param.node.parentController.findParent(t=>t.type()==Ac.SOLVER)}findDependency(e){const{indexOrPath:t}=e,r=t?this.findReferencedGraphNode(t):this._solverNode();if(IE(r)){const s=r.iterationStamp();return this.createDependency(s,{indexOrPath:t,node:r})}return null}async processArguments(e){const t=e[0]||"..",r=await this.getReferencedNode(t);return r&&IE(r)?r.iterationStamp().iteration():0}}class I$ extends mt{static requiredArguments(){return[["string","string to count characters of"]]}async processArguments(e){if(e.length==1){const t=e[0];if(Ke(t))return t.length}return 0}}class D$ extends mt{static requiredArguments(){return[]}async processArguments(e){let t="";for(let r of e)r==null&&(r=""),t+=`${r}`;return t}}class L$ extends mt{static requiredArguments(){return[["string","string to get index from"],["string","char to find index of"]]}async processArguments(e){if(e.length==2){const t=e[0],r=e[1];return t.indexOf(r)}return-1}}function F$(n){return n==null?"":Ke(n)?n:`${n}`}function DE(n,e){return n==null?e:Ye(n)?n:parseInt(n)}class U$ extends mt{static requiredArguments(){return[["string","string to get range from"],["integer","range start"],["integer","range size"]]}async processArguments(e){const t=F$(e[0]),r=DE(e[1],0);let s=DE(e[2],1);return t?t.substring(r,r+s):""}}class k$ extends mt{constructor(){super(...arguments),this._size=new W}static requiredArguments(){return[[]]}findDependency(e){return this.param.addGraphInput(this.param.scene().viewersRegister.graphNode()),null}async processArguments(e){var t;return(t=this.param.scene().viewersRegister.lastRenderedViewer())==null||t.size(this._size),this._size}}class B$ extends mt{constructor(){super(...arguments),this._windowSize=new W}static requiredArguments(){return[[]]}findDependency(e){return this.param.addGraphInput(this.param.scene().windowController.graphNode()),null}async processArguments(e){return this._windowSize.set(globalThis.innerWidth,globalThis.innerHeight),this._windowSize}}var dt=(n=>(n.animationNames="animationNames",n.arg="arg",n.argc="argc",n.bbox="bbox",n.blob="blob",n.cameraName="cameraName",n.cameraNames="cameraNames",n.camerasCount="camerasCount",n.centroid="centroid",n.ch="ch",n.chsop="chsop",n.copy="copy",n.copRes="copRes",n.isDeviceMobile="isDeviceMobile",n.isDeviceTouch="isDeviceTouch",n.len="len",n.join="join",n.js="js",n.object="object",n.objectsCount="objectsCount",n.objectName="objectName",n.objectNames="objectNames",n.opdigits="opdigits",n.opname="opname",n.padzero="padzero",n.playerMode="playerMode",n.point="point",n.pointsCount="pointsCount",n.smoothstep="smoothstep",n.smootherstep="smootherstep",n.solverIteration="solverIteration",n.strCharsCount="strCharsCount",n.strConcat="strConcat",n.strIndex="strIndex",n.strSub="strSub",n.viewerSize="viewerSize",n.windowSize="windowSize",n))(dt||{});class G${static run(e){e.expressionsRegister.register(X6,dt.animationNames),e.expressionsRegister.register($6,dt.arg),e.expressionsRegister.register(q6,dt.argc),e.expressionsRegister.register(Z6,dt.bbox),e.expressionsRegister.register(Q6,dt.blob),e.expressionsRegister.register(e$,dt.cameraName),e.expressionsRegister.register(t$,dt.cameraNames),e.expressionsRegister.register(n$,dt.camerasCount),e.expressionsRegister.register(r$,dt.centroid),e.expressionsRegister.register(s$,dt.ch),e.expressionsRegister.register(i$,dt.chsop),e.expressionsRegister.register(o$,dt.copy),e.expressionsRegister.register(l$,dt.copRes),e.expressionsRegister.register(m$,dt.isDeviceMobile),e.expressionsRegister.register(_$,dt.isDeviceTouch),e.expressionsRegister.register(g$,dt.len),e.expressionsRegister.register(v$,dt.join),e.expressionsRegister.register(y$,dt.js),e.expressionsRegister.register(x$,dt.object),e.expressionsRegister.register(b$,dt.objectsCount),e.expressionsRegister.register(C$,dt.objectName),e.expressionsRegister.register(E$,dt.objectNames),e.expressionsRegister.register(S$,dt.opdigits),e.expressionsRegister.register(A$,dt.opname),e.expressionsRegister.register(T$,dt.padzero),e.expressionsRegister.register(M$,dt.playerMode),e.expressionsRegister.register(R$,dt.point),e.expressionsRegister.register(w$,dt.pointsCount),e.expressionsRegister.register(O$,dt.smoothstep),e.expressionsRegister.register(P$,dt.smootherstep),e.expressionsRegister.register(N$,dt.solverIteration),e.expressionsRegister.register(I$,dt.strCharsCount),e.expressionsRegister.register(D$,dt.strConcat),e.expressionsRegister.register(L$,dt.strIndex),e.expressionsRegister.register(U$,dt.strSub),e.expressionsRegister.register(k$,dt.viewerSize),e.expressionsRegister.register(B$,dt.windowSize)}}class V$ extends rs{constructor(){super(...arguments),this._cookWithoutInputsBound=this._cookWithoutInputs.bind(this)}static context(){return be.EVENT}initializeBaseNode(){this.uiData.setLayoutHorizontal(),this.addPostDirtyHook("cookWithoutInputsOnDirty",this._cookWithoutInputsBound),this.io.inputs.setDependsOnInputs(!1),this.io.connections.initInputs(),this.io.connection_points.spare_params.initializeNode()}_cookWithoutInputs(){this.cookController.cookMainWithoutInputs()}cook(){this.cookController.endCook()}processEventViaConnectionPoint(e,t){t.event_listener?t.event_listener(e):this.processEvent(e)}processEvent(e){}async dispatchEventToOutput(e,t){this.run_on_dispatch_hook(e,t);const r=this.io.outputs.getOutputIndex(e);if(r>=0){const s=this.io.connections.outputConnectionsByOutputIndex(r);if(s){let i;if(!ve.playerMode()){const o=this.scene().eventsDispatcher.connectionTriggerDispatcher;s.forEach(a=>{o.dispatchTrigger(a)})}s.forEach(o=>{i=o.nodeDest();const a=i.io.inputs.namedInputConnectionPoints();if(a){const c=a[o.inputIndex()];i.processEventViaConnectionPoint(t,c)}})}}else console.warn(`requested output '${e}' does not exist on node '${this.path()}'`)}onDispatch(e,t){this._on_dispatch_hooks_by_output_name=this._on_dispatch_hooks_by_output_name||new Map,dr(this._on_dispatch_hooks_by_output_name,e,t)}run_on_dispatch_hook(e,t){if(this._on_dispatch_hooks_by_output_name){const r=this._on_dispatch_hooks_by_output_name.get(e);if(r)for(const s of r)s(t)}}}class z$ extends V${constructor(){super(...arguments),this._controls_by_viewer=new Map}async applyControls(e,t){const r=t.canvas();if(!r)return;await(async()=>{let l;for(const u of this.params.all)u.isDirty()&&!u.parentParam()&&(l=l||[],l.push(u.compute()));l&&await Promise.all(l)})();const i=await this.createControlsInstance(e,r),o=this._controls_by_viewer.get(t);o&&o.dispose(),this._controls_by_viewer.set(t,i);const c=ve.performance.performanceManager().now();return i.name=`${this.path()}:${e.name}:${c}:${this.controls_id()}`,await this.params.evalAll(),this.setupControls(i),i}controls_id(){return JSON.stringify(this.params.all.map(e=>e.valueSerialized()))}cook(){this._controls_by_viewer.forEach(e=>{this.setupControls(e)}),this.cookController.endCook()}}const LE={type:"change"},wm={type:"start"},FE={type:"end"},Xh=new ni,UE=new ar,H$=Math.cos(70*On.DEG2RAD);class j$ extends Ms{constructor(e,t){super(),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new T,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.clampPosition=!1,this.positionBounds=new Ht(new T(-1/0,-1/0,-1/0),new T(1/0,1/0,1/0)),this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:Gs.ROTATE,MIDDLE:Gs.DOLLY,RIGHT:Gs.PAN},this.touches={ONE:fs.ROTATE,TWO:fs.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null;const r=new T(0,0,0),s=new T(0,0,0);this.getPolarAngle=function(){return l.phi},this.getAzimuthalAngle=function(){return l.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(k){k.addEventListener("keydown",Se),this._domElementKeyEvents=k},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Se),this._domElementKeyEvents=null},this.saveState=function(){i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=function(){i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(LE),i.update(),a=o.NONE},this.update=function(){const k=new T,we=new Qt().setFromUnitVectors(e.up,new T(0,1,0)),je=we.clone().invert(),Be=new T,Ge=new Qt,De=new T,st=2*Math.PI;return function(Ue=null){const Te=i.object.position;if(k.copy(Te).sub(i.target),k.applyQuaternion(we),l.setFromVector3(k),i.autoRotate&&a===o.NONE&&X(G(Ue)),i.enableDamping){const Xt=u.theta*i.dampingFactor,Ct=u.phi*i.dampingFactor;l.theta+=Xt,l.phi+=Ct}else l.theta+=u.theta,l.phi+=u.phi;let pe=i.minAzimuthAngle,Me=i.maxAzimuthAngle;isFinite(pe)&&isFinite(Me)&&(pe<-Math.PI?pe+=st:pe>Math.PI&&(pe-=st),Me<-Math.PI?Me+=st:Me>Math.PI&&(Me-=st),pe<=Me?l.theta=Math.max(pe,Math.min(Me,l.theta)):l.theta=l.theta>(pe+Me)/2?Math.max(pe,l.theta):Math.min(Me,l.theta)),l.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,l.phi)),l.makeSafe(),i.enableDamping===!0?i.target.addScaledVector(d,i.dampingFactor):i.target.add(d);function Je(){i.clampPosition&&i.target.clamp(i.positionBounds.min,i.positionBounds.max)}function ft(){i.clampPosition&&Te.clamp(i.positionBounds.min,i.positionBounds.max)}Je(),i.zoomToCursor&&R||i.object.isOrthographicCamera?l.radius=ue(l.radius):l.radius=ue(l.radius*h),k.setFromSpherical(l),k.applyQuaternion(je),Te.copy(i.target).add(k),ft(),i.object.lookAt(i.target),i.enableDamping===!0?(u.theta*=1-i.dampingFactor,u.phi*=1-i.dampingFactor,d.multiplyScalar(1-i.dampingFactor)):(u.set(0,0,0),d.set(0,0,0));let Wt=!1;if(i.zoomToCursor&&R){let Xt=null;if(i.object.isPerspectiveCamera){const Ct=k.length();Xt=ue(Ct*h);const Dn=Ct-Xt;i.object.position.addScaledVector(E,Dn),ft(),i.object.updateMatrixWorld()}else i.object.isOrthographicCamera?(r.x=S.x,r.y=S.y,r.z=0,r.unproject(i.object),i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/h)),i.object.updateProjectionMatrix(),Wt=!0,s.x=S.x,s.y=S.y,s.z=0,s.unproject(i.object),i.object.position.sub(s).add(r),ft(),i.object.updateMatrixWorld(),Xt=k.length()):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),i.zoomToCursor=!1);Xt!==null&&(this.screenSpacePanning?(i.target.set(0,0,-1).transformDirection(i.object.matrix).multiplyScalar(Xt).add(i.object.position),Je()):(Xh.origin.copy(i.object.position),Xh.direction.set(0,0,-1).transformDirection(i.object.matrix),Math.abs(i.object.up.dot(Xh.direction))<H$?e.lookAt(i.target):(UE.setFromNormalAndCoplanarPoint(i.object.up,i.target),Xh.intersectPlane(UE,i.target),Je())))}else i.object.isOrthographicCamera&&(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/h)),i.object.updateProjectionMatrix(),Wt=!0);return h=1,R=!1,Wt||Be.distanceToSquared(i.object.position)>c||8*(1-Ge.dot(i.object.quaternion))>c||De.distanceToSquared(i.target)>0?(i.dispatchEvent(LE),Be.copy(i.object.position),Ge.copy(i.object.quaternion),De.copy(i.target),Wt=!1,!0):!1}}(),this.dispose=function(){i.domElement.removeEventListener("contextmenu",Ve),i.domElement.removeEventListener("pointerdown",ye),i.domElement.removeEventListener("pointercancel",ot),i.domElement.removeEventListener("wheel",re),i.domElement.ownerDocument.removeEventListener("pointermove",Ie),i.domElement.ownerDocument.removeEventListener("pointerup",ot),i._domElementKeyEvents!==null&&(i._domElementKeyEvents.removeEventListener("keydown",Se),i._domElementKeyEvents=null)};const i=this,o={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let a=o.NONE;const c=1e-6,l=new qx,u=new qx;let h=1;const d=new T,p=new W,_=new W,g=new W,f=new W,m=new W,y=new W,v=new W,b=new W,x=new W,E=new T,S=new W;let R=!1;const C=[],M={};function G(k){return k!==null?2*Math.PI/60*i.autoRotateSpeed*k:2*Math.PI/60/60*i.autoRotateSpeed}function F(){return Math.pow(.95,i.zoomSpeed)}function X(k){u.theta-=k}function N(k){u.phi-=k}const j=function(){const k=new T;return function(je,Be){k.setFromMatrixColumn(Be,0),k.multiplyScalar(-je),d.add(k)}}(),K=function(){const k=new T;return function(je,Be){i.screenSpacePanning===!0?k.setFromMatrixColumn(Be,1):(k.setFromMatrixColumn(Be,0),k.crossVectors(i.object.up,k)),k.multiplyScalar(je),d.add(k)}}(),$=function(){const k=new T;return function(je,Be){const Ge=i.domElement;if(i.object.isPerspectiveCamera){const De=i.object.position;k.copy(De).sub(i.target);let st=k.length();st*=Math.tan(i.object.fov/2*Math.PI/180),j(2*je*st/Ge.clientHeight,i.object.matrix),K(2*Be*st/Ge.clientHeight,i.object.matrix)}else i.object.isOrthographicCamera?(j(je*(i.object.right-i.object.left)/i.object.zoom/Ge.clientWidth,i.object.matrix),K(Be*(i.object.top-i.object.bottom)/i.object.zoom/Ge.clientHeight,i.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),i.enablePan=!1)}}();function q(k){i.object.isPerspectiveCamera||i.object.isOrthographicCamera?h/=k:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function ne(k){i.object.isPerspectiveCamera||i.object.isOrthographicCamera?h*=k:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function le(k){if(!i.zoomToCursor)return;R=!0;const we=i.domElement.getBoundingClientRect(),je=k.clientX-we.left,Be=k.clientY-we.top,Ge=we.width,De=we.height;S.x=je/Ge*2-1,S.y=-(Be/De)*2+1,E.set(S.x,S.y,1).unproject(i.object).sub(i.object.position).normalize()}function ue(k){return Math.max(i.minDistance,Math.min(i.maxDistance,k))}function Ee(k){p.set(k.clientX,k.clientY)}function de(k){le(k),v.set(k.clientX,k.clientY)}function V(k){f.set(k.clientX,k.clientY)}function B(k){_.set(k.clientX,k.clientY),g.subVectors(_,p).multiplyScalar(i.rotateSpeed);const we=i.domElement;X(2*Math.PI*g.x/we.clientHeight),N(2*Math.PI*g.y/we.clientHeight),p.copy(_),i.update()}function P(k){b.set(k.clientX,k.clientY),x.subVectors(b,v),x.y>0?q(F()):x.y<0&&ne(F()),v.copy(b),i.update()}function O(k){m.set(k.clientX,k.clientY),y.subVectors(m,f).multiplyScalar(i.panSpeed),$(y.x,y.y),f.copy(m),i.update()}function se(k){le(k),k.deltaY<0?ne(F()):k.deltaY>0&&q(F()),i.update()}function _e(k){let we=!1;switch(k.code){case i.keys.UP:k.ctrlKey||k.metaKey||k.shiftKey?N(2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):$(0,i.keyPanSpeed),we=!0;break;case i.keys.BOTTOM:k.ctrlKey||k.metaKey||k.shiftKey?N(-2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):$(0,-i.keyPanSpeed),we=!0;break;case i.keys.LEFT:k.ctrlKey||k.metaKey||k.shiftKey?X(2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):$(i.keyPanSpeed,0),we=!0;break;case i.keys.RIGHT:k.ctrlKey||k.metaKey||k.shiftKey?X(-2*Math.PI*i.rotateSpeed/i.domElement.clientHeight):$(-i.keyPanSpeed,0),we=!0;break}we&&(k.preventDefault(),i.update())}function Z(){if(C.length===1)p.set(C[0].pageX,C[0].pageY);else{const k=.5*(C[0].pageX+C[1].pageX),we=.5*(C[0].pageY+C[1].pageY);p.set(k,we)}}function me(){if(C.length===1)f.set(C[0].pageX,C[0].pageY);else{const k=.5*(C[0].pageX+C[1].pageX),we=.5*(C[0].pageY+C[1].pageY);f.set(k,we)}}function L(){const k=C[0].pageX-C[1].pageX,we=C[0].pageY-C[1].pageY,je=Math.sqrt(k*k+we*we);v.set(0,je)}function oe(){i.enableZoom&&L(),i.enablePan&&me()}function H(){i.enableZoom&&L(),i.enableRotate&&Z()}function Q(k){if(C.length==1)_.set(k.pageX,k.pageY);else{const je=pt(k),Be=.5*(k.pageX+je.x),Ge=.5*(k.pageY+je.y);_.set(Be,Ge)}g.subVectors(_,p).multiplyScalar(i.rotateSpeed);const we=i.domElement;X(2*Math.PI*g.x/we.clientHeight),N(2*Math.PI*g.y/we.clientHeight),p.copy(_)}function ee(k){if(C.length===1)m.set(k.pageX,k.pageY);else{const we=pt(k),je=.5*(k.pageX+we.x),Be=.5*(k.pageY+we.y);m.set(je,Be)}y.subVectors(m,f).multiplyScalar(i.panSpeed),$(y.x,y.y),f.copy(m)}function ge(k){const we=pt(k),je=k.pageX-we.x,Be=k.pageY-we.y,Ge=Math.sqrt(je*je+Be*Be);b.set(0,Ge),x.set(0,Math.pow(b.y/v.y,i.zoomSpeed)),q(x.y),v.copy(b)}function z(k){i.enableZoom&&ge(k),i.enablePan&&ee(k)}function D(k){i.enableZoom&&ge(k),i.enableRotate&&Q(k)}function ye(k){i.enabled!==!1&&(C.length===0&&(i.domElement.setPointerCapture(k.pointerId),i.domElement.ownerDocument.addEventListener("pointermove",Ie),i.domElement.ownerDocument.addEventListener("pointerup",ot)),Re(k),k.pointerType==="touch"?Ce(k):U(k))}function Ie(k){i.enabled!==!1&&(k.pointerType==="touch"?Ae(k):w(k))}function ot(k){Ne(k),C.length===0&&(i.domElement.releasePointerCapture(k.pointerId),i.domElement.ownerDocument.removeEventListener("pointermove",Ie),i.domElement.ownerDocument.removeEventListener("pointerup",ot)),i.dispatchEvent(FE),a=o.NONE}function U(k){let we;switch(k.button){case 0:we=i.mouseButtons.LEFT;break;case 1:we=i.mouseButtons.MIDDLE;break;case 2:we=i.mouseButtons.RIGHT;break;default:we=-1}switch(we){case Gs.DOLLY:if(i.enableZoom===!1)return;de(k),a=o.DOLLY;break;case Gs.ROTATE:if(i.enablePan===!0&&(k.ctrlKey||k.metaKey||k.shiftKey))V(k),a=o.PAN;else{if(i.enableRotate===!1)return;Ee(k),a=o.ROTATE}break;case Gs.PAN:if(k.ctrlKey||k.metaKey||k.shiftKey){if(i.enableRotate===!1)return;Ee(k),a=o.ROTATE}else{if(i.enablePan===!1)return;V(k),a=o.PAN}break;default:a=o.NONE}a!==o.NONE&&i.dispatchEvent(wm)}function w(k){switch(a){case o.ROTATE:if(i.enableRotate===!1)return;B(k);break;case o.DOLLY:if(i.enableZoom===!1)return;P(k);break;case o.PAN:if(i.enablePan===!1)return;O(k);break}}function re(k){i.enabled===!1||i.enableZoom===!1||a!==o.NONE||(k.preventDefault(),i.dispatchEvent(wm),se(k),i.dispatchEvent(FE))}function Se(k){i.enabled===!1||i.enablePan===!1||_e(k)}function Ce(k){switch(Ze(k),C.length){case 1:switch(i.touches.ONE){case fs.ROTATE:if(i.enableRotate===!1)return;Z(),a=o.TOUCH_ROTATE;break;case fs.PAN:if(i.enablePan===!1)return;me(),a=o.TOUCH_PAN;break;default:a=o.NONE}break;case 2:switch(i.touches.TWO){case fs.DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;oe(),a=o.TOUCH_DOLLY_PAN;break;case fs.DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;H(),a=o.TOUCH_DOLLY_ROTATE;break;default:a=o.NONE}break;default:a=o.NONE}a!==o.NONE&&i.dispatchEvent(wm)}function Ae(k){switch(Ze(k),a){case o.TOUCH_ROTATE:if(i.enableRotate===!1)return;Q(k),i.update();break;case o.TOUCH_PAN:if(i.enablePan===!1)return;ee(k),i.update();break;case o.TOUCH_DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;z(k),i.update();break;case o.TOUCH_DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;D(k),i.update();break;default:a=o.NONE}}function Ve(k){i.enabled!==!1&&k.preventDefault()}function Re(k){C.push(k)}function Ne(k){delete M[k.pointerId];for(let we=0;we<C.length;we++)if(C[we].pointerId==k.pointerId){C.splice(we,1);return}}function Ze(k){let we=M[k.pointerId];we===void 0&&(we=new W,M[k.pointerId]=we),we.set(k.pageX,k.pageY)}function pt(k){const we=k.pointerId===C[0].pointerId?C[1]:C[0];return M[we.pointerId]}i.domElement.addEventListener("contextmenu",Ve),i.domElement.addEventListener("pointerdown",ye),i.domElement.addEventListener("pointercancel",ot),i.domElement.addEventListener("wheel",re,{passive:!1}),this.update()}}const kE="start",BE="change",GE="end",VE=[0,0,0],zs=["rotate","dolly","pan"],Ha=["rotate","pan","dolly + pan","dolly + rotate"],Om={rotate:Gs.ROTATE,dolly:Gs.DOLLY,pan:Gs.PAN},zE={rotate:fs.ROTATE,pan:fs.PAN,"dolly + pan":fs.DOLLY_PAN,"dolly + rotate":fs.DOLLY_ROTATE};class W$ extends Et{constructor(){super(...arguments),this.main=A.FOLDER(),this.enabled=A.BOOLEAN(1),this.allowPan=A.BOOLEAN(1),this.allowRotate=A.BOOLEAN(1),this.allowZoom=A.BOOLEAN(1),this.zoomSpeed=A.FLOAT(1,{range:[0,2],rangeLocked:[!0,!1],visibleIf:{allowZoom:1}}),this.zoomToCursor=A.BOOLEAN(1,{visibleIf:{allowZoom:1}}),this.tdamping=A.BOOLEAN(1),this.damping=A.FLOAT(.1,{visibleIf:{tdamping:!0}}),this.screenSpacePanning=A.BOOLEAN(1),this.rotateSpeed=A.FLOAT(.5),this.limits=A.FOLDER(),this.minDistance=A.FLOAT(.1,{range:[.1,100],rangeLocked:[!0,!1]}),this.maxDistance=A.FLOAT(50,{range:[0,100],rangeLocked:[!0,!1]}),this.minZoom=A.FLOAT(.01,{range:[.01,100],rangeLocked:[!0,!1]}),this.maxZoom=A.FLOAT(50,{range:[0,100],rangeLocked:[!0,!1]}),this.limitAzimuthAngle=A.BOOLEAN(0),this.azimuthAngleRange=A.VECTOR2(["-2*$PI","2*$PI"],{visibleIf:{limitAzimuthAngle:1}}),this.polarAngleRange=A.VECTOR2([0,"$PI"]),this.clampPosition=A.BOOLEAN(!1),this.positionMin=A.VECTOR3([-10,-10,-10],{visibleIf:{clampPosition:1}}),this.positionMax=A.VECTOR3([10,10,10],{visibleIf:{clampPosition:1}}),this.controls=A.FOLDER(),this.leftMouseButton=A.INTEGER(zs.indexOf("rotate"),{menu:{entries:zs.map((e,t)=>({name:e,value:t}))}}),this.middleMouseButton=A.INTEGER(zs.indexOf("dolly"),{menu:{entries:zs.map((e,t)=>({name:e,value:t}))}}),this.rightMouseButton=A.INTEGER(zs.indexOf("pan"),{menu:{entries:zs.map((e,t)=>({name:e,value:t}))}}),this.oneFingerTouch=A.INTEGER(Ha.indexOf("rotate"),{menu:{entries:Ha.map((e,t)=>({name:e,value:t}))},separatorBefore:!0}),this.twoFingersTouch=A.INTEGER(Ha.indexOf("dolly + pan"),{menu:{entries:Ha.map((e,t)=>({name:e,value:t}))}}),this.misc=A.FOLDER(),this.updateTargetEndMoveEnd=A.BOOLEAN(1),this.target=A.VECTOR3([0,0,0],{cook:!1,computeOnDirty:!0,callback:e=>{QR.PARAM_CALLBACK_updateTarget(e)}})}}const X$=new W$;class QR extends z${constructor(){super(...arguments),this.paramsConfig=X$,this._controlsByElementId=new Map}static type(){return qM.ORBIT}endEventName(){return"end"}initializeNode(){this.io.outputs.setNamedOutputConnectionPoints([new yd(kE,Ml.BASE),new yd(BE,Ml.BASE),new yd(GE,Ml.BASE)])}_createControls(e,t){return new j$(e,t)}async createControlsInstance(e,t){const r=this._createControls(e,t);return r.addEventListener("end",()=>{this._on_controls_end(r)}),this._controlsByElementId.set(t.id,r),this._updateCache(),this._bind_listeners_to_controls_instance(r),r}_bind_listeners_to_controls_instance(e){e.addEventListener("start",()=>{this.dispatchEventToOutput(kE,{})}),e.addEventListener("change",()=>{this.dispatchEventToOutput(BE,{})}),e.addEventListener("end",()=>{this.dispatchEventToOutput(GE,{})})}setupControls(e){e.enabled=this.pv.enabled,e.enablePan=this.pv.allowPan,e.enableRotate=this.pv.allowRotate,e.enableZoom=this.pv.allowZoom,e.zoomSpeed=this.pv.zoomSpeed,e.zoomToCursor=this.pv.zoomToCursor,e.enableDamping=this.pv.tdamping,e.dampingFactor=this.pv.damping,e.rotateSpeed=this.pv.rotateSpeed,e.screenSpacePanning=this.pv.screenSpacePanning,e.minDistance=this.pv.minDistance,e.maxDistance=this.pv.maxDistance,e.minZoom=this.pv.minZoom,e.maxZoom=this.pv.maxZoom,e.clampPosition=this.pv.clampPosition,e.positionBounds.min.copy(this.pv.positionMin),e.positionBounds.max.copy(this.pv.positionMax),this._set_azimuth_angle(e),e.minPolarAngle=this.pv.polarAngleRange.x,e.maxPolarAngle=this.pv.polarAngleRange.y,e.target.copy(this.pv.target),e.enabled&&e.update(),e.mouseButtons.LEFT=Om[zs[this.pv.leftMouseButton]],e.mouseButtons.MIDDLE=Om[zs[this.pv.middleMouseButton]],e.mouseButtons.RIGHT=Om[zs[this.pv.rightMouseButton]],e.touches.ONE=zE[Ha[this.pv.oneFingerTouch]],e.touches.TWO=zE[Ha[this.pv.twoFingersTouch]]}_set_azimuth_angle(e){this.pv.limitAzimuthAngle?(e.minAzimuthAngle=this.pv.azimuthAngleRange.x,e.maxAzimuthAngle=this.pv.azimuthAngleRange.y):(e.minAzimuthAngle=1/0,e.maxAzimuthAngle=1/0)}updateRequired(){return this.pv.tdamping}_on_controls_end(e){this.pv.updateTargetEndMoveEnd&&this.pv.allowPan&&(e.target.toArray(VE),this.p.target.set(VE))}static PARAM_CALLBACK_updateTarget(e){e._updateTarget()}_updateTarget(){this.setTarget(this.pv.target)}target(e){this._firstControls&&e.copy(this._firstControls.target)}setTarget(e){this._controlsByElementId.forEach((t,r)=>{const s=t.target;s.equals(e)||(s.copy(e),t.update())})}disposeControlsForHtmlElementId(e){this._controlsByElementId.get(e)&&this._controlsByElementId.delete(e),this._updateCache()}_updateCache(){this._firstControls=void 0,this._controlsByElementId.forEach(e=>{this._firstControls=this._firstControls||e})}}class $$ extends rs{constructor(){super(...arguments),this._cookWhenDirtyBound=this._cookMainWithoutInputsWhenDirty.bind(this)}static context(){return be.MAT}initializeBaseNode(){super.initializeBaseNode(),this.io.outputs.setHasOneOutput(),this.addPostDirtyHook("_cookWhenDirty",()=>{setTimeout(this._cookWhenDirtyBound,0)})}async _cookMainWithoutInputsWhenDirty(){await this.cookController.cookMainWithoutInputs()}setMaterial(e){ve.onSceneUpdatedHooks.runHooks(),this._setContainer(e)}}class s0 extends $${constructor(){super(...arguments),this.controllersList=[]}__materialSync__(){return this._material=this._material||this.createMaterial()}async material(){return(await this.compute()).material()}initializeBaseNode(){super.initializeBaseNode(),this.nameController.add_post_set_fullPath_hook(this.set_material_name.bind(this))}set_material_name(){this._material&&(this._material.name=this.path())}setMaterial(e){this._material=e,super.setMaterial(e)}getTextures(e,t){for(const r of this.controllersList)r.getTextures(e,t)}setParamsFromMaterial(e,t){for(const r of this.controllersList)r.setParamsFromMaterial(e,t)}controllersPromises(e){const t=this.controllersList.map(s=>s.updateMaterial(e)),r=[];return Js(t,r),r}initializeNode(){this.params.onParamsCreated("init controllers",()=>{for(const e of this.controllersList)e.initializeNode()})}}class oi{constructor(e){this.node=e}initializeNode(){}setParamsFromMaterial(e,t){}getTextures(e,t){}}function ew(n){return class extends n{constructor(){super(...arguments),this.color=A.COLOR([1,1,1],{}),this.useVertexColors=A.BOOLEAN(0,{separatorAfter:!0}),this.transparent=A.BOOLEAN(0),this.opacity=A.FLOAT(1),this.alphaTest=A.FLOAT(0)}}}function q$(n){return n?n.color!=null:!1}const Y$=new xe,HE=[0,0,0];class tw extends oi{constructor(e){super(e),this.node=e}static async update(e){const r=(await e.compute()).material();q$(r)&&e.controllers.colors.updateMaterial(r)}updateMaterial(e){const t=this.node.pv;e.color.copy(t.color);const r=t.useVertexColors;r!=e.vertexColors&&(e.vertexColors=r,e.needsUpdate=!0),e.opacity=t.opacity,e.transparent=t.transparent,e.alphaTest=t.alphaTest}setParamsFromMaterial(e,t){const r=this.node.p;Y$.copy(e.color).toArray(HE),r.color.set(HE),r.color.setConversion(Ys.NONE),r.useVertexColors.set(e.vertexColors),r.opacity.set(e.opacity),r.transparent.set(e.transparent),r.alphaTest.set(e.alphaTest)}}function nw(n){return class extends n{constructor(){super(...arguments),this.useFog=A.BOOLEAN(0)}}}function K$(n){return n?n.fog!=null:!1}class rw extends oi{constructor(e){super(e),this.node=e}static async update(e){const r=(await e.compute()).material();K$(r)&&e.controllers.fog.updateMaterial(r)}updateMaterial(e){const t=this.node.pv;e.fog=t.useFog}}function Z$(n,e){const t=e.front?In:bn,r=e.doubleSided?er:t;r!=n.side&&(n.side=r,n.forceSinglePass=!e.doubleSided,n.needsUpdate=!0)}function J$(n,e){switch(n.side){case In:{e.doubleSided.set(!1),e.front.set(!0);return}case bn:{e.doubleSided.set(!1),e.front.set(!1);return}case er:{e.doubleSided.set(!0),e.front.set(!0);return}}}function sw(n,e){if(Z$(n,e),e.overrideShadowSide){const r=e.shadowFront?In:bn,s=e.shadowDoubleSided?er:r;s!=n.shadowSide&&(n.shadowSide=s,n.needsUpdate=!0)}else n.shadowSide=null;const t=n.customMaterials;if(t){const r=Object.keys(t);for(const s of r){const i=t[s];i&&sw(i,e)}}}function iw(n,e){if(J$(n,e),n.shadowSide!=null)switch(e.overrideShadowSide.set(!0),n.shadowSide){case In:{e.shadowDoubleSided.set(!1),e.shadowFront.set(!0);return}case bn:{e.shadowDoubleSided.set(!1),e.shadowFront.set(!1);return}case er:{e.shadowDoubleSided.set(!0),e.shadowFront.set(!0);return}}const t=n.customMaterials;if(t){const r=Object.keys(t);for(const s of r){const i=t[s];i&&iw(i,e)}}}const ow={NoBlending:$s,NormalBlending:ki,AdditiveBlending:r_,SubtractiveBlending:s_,MultiplyBlending:i_},Q$=Object.keys(ow);function i0(n){return class extends n{constructor(){super(...arguments),this.doubleSided=A.BOOLEAN(0),this.front=A.BOOLEAN(1,{visibleIf:{doubleSided:!1}}),this.overrideShadowSide=A.BOOLEAN(0),this.shadowDoubleSided=A.BOOLEAN(0,{visibleIf:{overrideShadowSide:!0}}),this.shadowFront=A.BOOLEAN(1,{visibleIf:{overrideShadowSide:!0,shadowDoubleSided:!1}}),this.colorWrite=A.BOOLEAN(1,{separatorBefore:!0,cook:!1,callback:(t,r)=>{Za.update(t)}}),this.depthWrite=A.BOOLEAN(1,{cook:!1,callback:(t,r)=>{Za.update(t)}}),this.depthTest=A.BOOLEAN(1,{cook:!1,callback:(t,r)=>{Za.update(t)}}),this.premultipliedAlpha=A.BOOLEAN(!1,{separatorAfter:!0}),this.blending=A.INTEGER(ki,{menu:{entries:Q$.map(t=>({name:t,value:ow[t]}))}}),this.dithering=A.BOOLEAN(0),this.polygonOffset=A.BOOLEAN(!1,{separatorBefore:!0}),this.polygonOffsetFactor=A.INTEGER(0,{range:[0,1e3],visibleIf:{polygonOffset:1}}),this.polygonOffsetUnits=A.INTEGER(0,{range:[0,1e3],visibleIf:{polygonOffset:1}})}}}class Za extends oi{constructor(e){super(e),this.node=e}static async update(e){const t=await e.material();t&&e.controllers.advancedCommon.updateMaterial(t)}updateMaterial(e){const t=this.node.pv;sw(e,t),e.colorWrite=t.colorWrite,e.depthWrite=t.depthWrite,e.depthTest=t.depthTest,e.blending=t.blending,e.premultipliedAlpha=t.premultipliedAlpha,e.dithering=t.dithering,e.polygonOffset=t.polygonOffset,e.polygonOffset&&(e.polygonOffsetFactor=t.polygonOffsetFactor,e.polygonOffsetUnits=t.polygonOffsetUnits,e.needsUpdate=!0)}setParamsFromMaterial(e,t){const r=this.node.p;iw(e,r),r.colorWrite.set(e.colorWrite),r.depthWrite.set(e.depthWrite),r.depthTest.set(e.depthTest),r.blending.set(e.blending),r.premultipliedAlpha.set(e.premultipliedAlpha),r.dithering.set(e.dithering),r.polygonOffset.set(e.polygonOffset),e.polygonOffset&&(r.polygonOffsetFactor.set(e.polygonOffsetFactor),r.polygonOffsetUnits.set(e.polygonOffsetUnits))}}function kn(n){return{cook:!1,callback:(e,t)=>{n.update(e)}}}function ln(n,e,t){return{visibleIf:{[e]:1},nodeSelection:{context:be.COP,types:t==null?void 0:t.types},cook:!1,callback:(r,s)=>{n.update(r)}}}const jE="TextureController";class Hr extends oi{constructor(e){super(e),this.node=e,this.updateBound=this.update.bind(this)}add_hooks(e,t){e.addPostDirtyHook(jE,this.updateBound),t.addPostDirtyHook(jE,this.updateBound)}static async update(e){}async update(){}async _update(e,t,r,s){const i=e,o=t;await this._update_texture_on_material(i,o,r,s)}async _update_texture_on_material(e,t,r,s){await this._update_required_attribute(e,e,t,r,s,this._apply_texture_on_material.bind(this),this._remove_texture_from_material.bind(this))}_apply_texture_on_material(e,t,r,s){const i=t[r];let o=!1;i&&i.uuid!=s.uuid&&(o=!0),(i==null||o)&&(t[r]=s,e.needsUpdate=!0),ve.onSceneUpdatedHooks.runHooks()}_remove_texture_from_material(e,t,r){t[r]&&(t[r]=null,e.needsUpdate=!0),ve.onSceneUpdatedHooks.runHooks()}async _update_required_attribute(e,t,r,s,i,o,a){if(s.isDirty()&&await s.compute(),s.value){i.isDirty()&&await i.compute();const l=i.value.nodeWithContext(be.COP);if(l){const h=(await l.compute()).texture();if(h){await o(e,t,r,h);return}}}a(e,t,r)}}function o0(n){return class extends n{constructor(){super(...arguments),this.useMap=A.BOOLEAN(0,{...kn(Zl),separatorBefore:!0}),this.map=A.NODE_PATH("",ln(Zl,"useMap"))}}}function eq(n){return!!n}class Zl extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useMap,this.node.p.map)}static async update(e){e.controllers.map.update()}async update(){const e=await this.node.material();if(!eq(e)){console.warn("invalid mat for TextureMapController",e);return}await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"map",this.node.p.useMap,this.node.p.map)}getTextures(e,t){t.set("map",e.map)}setParamsFromMaterial(e,t){const r=t.get("map");this.node.p.useMap.set(r!=null),r&&this.node.p.map.setNode(r,{relative:!0})}}function a0(n){return class extends n{constructor(){super(...arguments),this.useAlphaMap=A.BOOLEAN(0,{separatorBefore:!0,...kn(Jl)}),this.alphaMap=A.NODE_PATH("",ln(Jl,"useAlphaMap"))}}}function tq(n){return!!n}class Jl extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useAlphaMap,this.node.p.alphaMap)}static async update(e){e.controllers.alphaMap.update()}async update(){const e=await this.node.material();tq(e)&&await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"alphaMap",this.node.p.useAlphaMap,this.node.p.alphaMap)}getTextures(e,t){t.set("alphaMap",e.alphaMap)}setParamsFromMaterial(e,t){const r=t.get("aoMap");this.node.p.useAlphaMap.set(r!=null),r&&this.node.p.alphaMap.setNode(r,{relative:!0})}}function c0(n){return class extends n{constructor(){super(...arguments),this.useAOMap=A.BOOLEAN(0,{separatorBefore:!0,...kn(Ql)}),this.aoMap=A.NODE_PATH("",ln(Ql,"useAOMap")),this.aoMapIntensity=A.FLOAT(1,{range:[0,1],rangeLocked:[!1,!1],visibleIf:{useAOMap:1}})}}}function nq(n){return n?n.aoMapIntensity!=null:!1}class Ql extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useAOMap,this.node.p.aoMap)}static async update(e){e.controllers.aoMap.update()}async update(){const e=await this.node.material();nq(e)&&await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"aoMap",this.node.p.useAOMap,this.node.p.aoMap),e.aoMapIntensity=this.node.pv.aoMapIntensity}getTextures(e,t){t.set("aoMap",e.aoMap)}setParamsFromMaterial(e,t){const r=t.get("aoMap");this.node.p.useAOMap.set(r!=null),r&&this.node.p.aoMap.setNode(r,{relative:!0}),this.node.p.aoMapIntensity.set(e.aoMapIntensity)}}var _s=(n=>(n.BUILDER="builder",n.BUILDER_2D_ARRAY="builder2DArray",n.CUBE_MAP="cubeMap",n.CUBE_CAMERA="cubeCamera",n.CUBE_MAP_FROM_SCENE="cubeMapFromScene",n.ENV_MAP="envMap",n.GIF="gif",n.LIGHT_MAP="lightMap",n.LUT="lut",n.RENDER="render",n.SDF_BLUR="SDFBlur",n.SDF_FROM_OBJECT="SDFFromObject",n.SDF_FROM_URL="SDFFromUrl",n.SNAPSHOT="snapshot",n.TEXT="text",n.VIDEO="video",n.WEB_CAM="webCam",n))(_s||{}),hl=(n=>(n.IMAGE="image",n.IMAGE_EXR="imageEXR",n.IMAGE_HDR="imageHDR",n.IMAGE_KTX2="imageKTX2",n))(hl||{});const ig=["mult","add","mix"],rq={mult:_c,add:Ng,mix:Pg},sq={[_c]:"mult",[Ng]:"add",[Pg]:"mix"};function iq(n){return class extends n{constructor(){super(...arguments),this.useEnvMap=A.BOOLEAN(0,{separatorBefore:!0,...kn(og)}),this.envMap=A.NODE_PATH("",ln(og,"useEnvMap",{types:[_s.CUBE_MAP,_s.CUBE_MAP_FROM_SCENE,_s.CUBE_CAMERA]})),this.combine=A.INTEGER(0,{visibleIf:{useEnvMap:1},menu:{entries:ig.map((t,r)=>({name:t,value:r}))}}),this.reflectivity=A.FLOAT(1,{visibleIf:{useEnvMap:1}}),this.refractionRatio=A.FLOAT(.98,{range:[-1,1],rangeLocked:[!1,!1],visibleIf:{useEnvMap:1}})}}}function oq(n){return n?n.reflectivity!=null:!1}class og extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useEnvMap,this.node.p.envMap)}static async update(e){e.controllers.envMap.update()}async update(){const e=await this.node.material();oq(e)&&await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"envMap",this.node.p.useEnvMap,this.node.p.envMap);const t=rq[ig[this.node.pv.combine]];e.combine=t,e.reflectivity=this.node.pv.reflectivity,e.refractionRatio=this.node.pv.refractionRatio}getTextures(e,t){t.set("envMap",e.envMap)}setParamsFromMaterial(e,t){const r=t.get("envMap");this.node.p.useEnvMap.set(r!=null),r&&this.node.p.envMap.setNode(r,{relative:!0}),this.node.p.combine.set(ig.indexOf(sq[e.combine])),this.node.p.reflectivity.set(e.reflectivity),this.node.p.refractionRatio.set(e.refractionRatio)}}function l0(n){return class extends n{constructor(){super(...arguments),this.useLightMap=A.BOOLEAN(0,{separatorBefore:!0,...kn(eu)}),this.lightMap=A.NODE_PATH("",ln(eu,"useLightMap")),this.lightMapIntensity=A.FLOAT(1,{visibleIf:{useLightMap:1}})}}}function aq(n){return n?n.lightMapIntensity!=null:!1}class eu extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useLightMap,this.node.p.lightMap)}static async update(e){e.controllers.lightMap.update()}async update(){const e=await this.node.material();aq(e)&&await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"lightMap",this.node.p.useLightMap,this.node.p.lightMap),e.lightMapIntensity=this.node.pv.lightMapIntensity}getTextures(e,t){t.set("lightMap",e.lightMap)}setParamsFromMaterial(e,t){const r=t.get("lightMap");this.node.p.useLightMap.set(r!=null),r&&this.node.p.lightMap.setNode(r,{relative:!0}),this.node.p.lightMapIntensity.set(e.lightMapIntensity)}}const ag=["round","butt","square"],cg=["round","bevel","miter"];function aw(n){return class extends n{constructor(){super(...arguments),this.wireframe=A.BOOLEAN(0,{separatorBefore:!0}),this.wireframeLinewidth=A.FLOAT(1,{range:[0,5],rangeLocked:[!0,!1],visibleIf:{wireframe:1}}),this.wireframeLinecap=A.INTEGER(0,{menu:{entries:ag.map((t,r)=>({name:t,value:r}))},visibleIf:{wireframe:1}}),this.wireframeLinejoin=A.INTEGER(0,{menu:{entries:cg.map((t,r)=>({name:t,value:r}))},visibleIf:{wireframe:1},separatorAfter:!0})}}}function cq(n){return n?n.wireframe!=null:!1}class cw extends oi{constructor(e){super(e),this.node=e}static async update(e){const t=await e.material();cq(t)&&e.controllers.wireframe.updateMaterial(t)}updateMaterial(e){const t=this.node.pv;e.wireframe=t.wireframe,e.wireframeLinewidth=t.wireframeLinewidth,e.wireframeLinecap=ag[t.wireframeLinecap],e.wireframeLinejoin=cg[t.wireframeLinejoin],e.needsUpdate=!0}getTextures(e,t){}setParamsFromMaterial(e,t){this.node.p.wireframe.set(e.wireframe),this.node.p.wireframeLinewidth.set(e.wireframeLinewidth),this.node.p.wireframeLinecap.set(ag.indexOf(e.wireframeLinecap)),this.node.p.wireframeLinejoin.set(cg.indexOf(e.wireframeLinejoin))}}function u0(n){return class extends n{constructor(){super(...arguments),this.default=A.FOLDER(null)}}}function h0(n){return class extends n{constructor(){super(...arguments),this.textures=A.FOLDER(null)}}}function d0(n){return class extends n{constructor(){super(...arguments),this.advanced=A.FOLDER(null)}}}var Wp=(n=>(n.LINE_BASIC="lineBasic",n.LINE_BASIC_BUILDER="lineBasicBuilder",n.MESH_BASIC="meshBasic",n.MESH_BASIC_BUILDER="meshBasicBuilder",n.MESH_DEPTH_BUILDER="meshDepthBuilder",n.MESH_DISTANCE_BUILDER="meshDistanceBuilder",n.MESH_LAMBERT="meshLambert",n.MESH_LAMBERT_BUILDER="meshLambertBuilder",n.MESH_MATCAP="meshMatcap",n.MESH_NORMAL="meshNormal",n.MESH_PHONG="meshPhong",n.MESH_PHONG_BUILDER="meshPhongBuilder",n.MESH_PHYSICAL="meshPhysical",n.MESH_PHYSICAL_BUILDER="meshPhysicalBuilder",n.MESH_STANDARD="meshStandard",n.MESH_STANDARD_BUILDER="meshStandardBuilder",n.MESH_TOON="meshToon",n.MESH_TOON_BUILDER="meshToonBuilder",n.POINTS="points",n.POINTS_BUILDER="pointsBuilder",n.RAY_MARCHING_BUILDER="rayMarchingBuilder",n.SHADOW="shadow",n.SKY="sky",n.VOLUME="volume",n.VOLUME_BUILDER="volumeBuilder",n))(Wp||{});class lq extends nw(aw(i0(d0(l0(iq(c0(a0(o0(h0(ew(u0(Et)))))))))))){}const uq=new lq;class hq extends s0{constructor(){super(...arguments),this.paramsConfig=uq,this.controllers={colors:new tw(this),advancedCommon:new Za(this),alphaMap:new Jl(this),aoMap:new Ql(this),envMap:new og(this),fog:new rw(this),lightMap:new eu(this),map:new Zl(this),wireframe:new cw(this)},this.controllersList=Object.values(this.controllers)}static type(){return Wp.MESH_BASIC}createMaterial(){return new _u({vertexColors:!1,side:In,color:16777215,opacity:1})}async cook(){this._material=this._material||this.createMaterial(),await Promise.all(this.controllersPromises(this._material)),this.setMaterial(this._material)}}const dq={useEnvMap:!1,envMap:new Zr(""),envMapIntensity:1},WE=dq;function lw(n){return class extends n{constructor(){super(...arguments),this.useEnvMap=A.BOOLEAN(WE.useEnvMap,{separatorBefore:!0,...kn(Kd)}),this.envMap=A.NODE_PATH("",ln(Kd,"useEnvMap")),this.envMapIntensity=A.FLOAT(WE.envMapIntensity,{visibleIf:{useEnvMap:1}})}}}function pq(n){return n?n.isMeshStandardMaterial||n.isMeshPhysicalMaterial:!1}class Kd extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useEnvMap,this.node.p.envMap)}static async update(e){e.controllers.envMap.update()}async update(){const e=await this.node.material();pq(e)&&this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"envMap",this.node.p.useEnvMap,this.node.p.envMap),e.envMapIntensity=this.node.pv.envMapIntensity}getTextures(e,t){t.set("envMap",e.envMap)}setParamsFromMaterial(e,t){const r=t.get("envMap");this.node.p.useEnvMap.set(r!=null),r&&this.node.p.envMap.setNode(r,{relative:!0}),this.node.p.envMapIntensity.set(e.envMapIntensity)}}function uw(n){return class extends n{constructor(){super(...arguments),this.useBumpMap=A.BOOLEAN(0,{separatorBefore:!0,...kn(ja)}),this.bumpMap=A.NODE_PATH("",ln(ja,"useBumpMap")),this.bumpScale=A.FLOAT(1,{range:[0,1],rangeLocked:[!1,!1],...ln(ja,"useBumpMap")}),this.bumpBias=A.FLOAT(0,{range:[0,1],rangeLocked:[!1,!1],...ln(ja,"useBumpMap")})}}}function fq(n){return n?n.bumpScale!=null:!1}class ja extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useBumpMap,this.node.p.bumpMap)}static async update(e){e.controllers.bumpMap.update()}async update(){const e=await this.node.material();fq(e)&&await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"bumpMap",this.node.p.useBumpMap,this.node.p.bumpMap),e.bumpScale=this.node.pv.bumpScale}getTextures(e,t){t.set("bumpMap",e.bumpMap)}setParamsFromMaterial(e,t){const r=t.get("emissiveMap");this.node.p.useBumpMap.set(r!=null),r&&this.node.p.bumpMap.setNode(r,{relative:!0}),this.node.p.bumpScale.set(e.bumpScale)}}const lg=["tangent","object"],mq={tangent:ti,object:Dg},_q={[ti]:"tangent",[Dg]:"object"};function hw(n){return class extends n{constructor(){super(...arguments),this.useNormalMap=A.BOOLEAN(0,{separatorBefore:!0,...kn(Zd)}),this.normalMap=A.NODE_PATH("",ln(Zd,"useNormalMap")),this.normalMapType=A.INTEGER(0,{visibleIf:{useNormalMap:1},menu:{entries:lg.map((t,r)=>({name:t,value:r}))}}),this.normalScale=A.VECTOR2([1,1],{visibleIf:{useNormalMap:1}}),this.normalScaleMult=A.FLOAT(1,{range:[0,1],rangeLocked:[!1,!1],visibleIf:{useNormalMap:1}})}}}function gq(n){return n?n.normalScale!=null:!1}const XE=[0,0];class Zd extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useNormalMap,this.node.p.normalMap)}static async update(e){e.controllers.normalMap.update()}async update(){const e=await this.node.material();gq(e)&&await this.updateMaterial(e)}async updateMaterial(e){const{p:t,pv:r}=this.node;await this._update(e,"normalMap",t.useNormalMap,t.normalMap);const s=mq[lg[r.normalMapType]],i=e;i.normalMapType=s,i.normalScale.copy(r.normalScale).multiplyScalar(r.normalScaleMult)}getTextures(e,t){t.set("normalMap",e.normalMap)}setParamsFromMaterial(e,t){const r=t.get("normalMap"),s=this.node.p;s.useNormalMap.set(r!=null),r&&s.normalMap.setNode(r,{relative:!0}),e.normalScale.toArray(XE),s.normalScale.set(XE),s.normalMapType.set(lg.indexOf(_q[e.normalMapType]))}}function dw(n){return class extends n{constructor(){super(...arguments),this.emissive=A.COLOR([0,0,0],{separatorBefore:!0}),this.useEmissiveMap=A.BOOLEAN(0,kn(Jd)),this.emissiveMap=A.NODE_PATH("",ln(Jd,"useEmissiveMap")),this.emissiveIntensity=A.FLOAT(1)}}}function vq(n){return n?n.emissive!=null:!1}const $E=[0,0,0];class Jd extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useEmissiveMap,this.node.p.emissiveMap)}static async update(e){e.controllers.emissiveMap.update()}async update(){const e=await this.node.material();vq(e)&&await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"emissiveMap",this.node.p.useEmissiveMap,this.node.p.emissiveMap),e.emissive.copy(this.node.pv.emissive),e.emissiveIntensity=this.node.pv.emissiveIntensity}getTextures(e,t){t.set("emissiveMap",e.emissiveMap)}setParamsFromMaterial(e,t){const r=t.get("emissiveMap");this.node.p.useEmissiveMap.set(r!=null),r&&this.node.p.emissiveMap.setNode(r,{relative:!0}),e.emissive.toArray($E),this.node.p.emissive.set($E),this.node.p.emissive.setConversion(Ys.NONE),this.node.p.emissiveIntensity.set(e.emissiveIntensity)}}const yq={useMetalnessMap:!1,metalnessMap:new Zr(""),metalness:0,useRoughnessMap:!1,roughnessMap:new Zr(""),roughness:1},$h=yq;function pw(n){return class extends n{constructor(){super(...arguments),this.useMetalnessMap=A.BOOLEAN($h.useMetalnessMap,{separatorBefore:!0,...kn(Wa)}),this.metalnessMap=A.NODE_PATH("",ln(Wa,"useMetalnessMap")),this.metalness=A.FLOAT($h.metalness),this.useRoughnessMap=A.BOOLEAN($h.useRoughnessMap,{separatorBefore:!0,...kn(Wa)}),this.roughnessMap=A.NODE_PATH("",ln(Wa,"useRoughnessMap")),this.roughness=A.FLOAT($h.roughness)}}}function xq(n){return n?n.metalness!=null:!1}class Wa extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useMetalnessMap,this.node.p.metalnessMap)}static async update(e){e.controllers.metalnessRoughnessMap.update()}async update(){const e=await this.node.material();xq(e)&&await this.updateMaterial(e)}async updateMaterial(e){e.metalness=this.node.pv.metalness,e.roughness=this.node.pv.roughness,await Promise.all([this._update(e,"metalnessMap",this.node.p.useMetalnessMap,this.node.p.metalnessMap),this._update(e,"roughnessMap",this.node.p.useRoughnessMap,this.node.p.roughnessMap)])}getTextures(e,t){t.set("metalnessMap",e.metalnessMap),t.set("roughnessMap",e.roughnessMap)}setParamsFromMaterial(e,t){const r=t.get("metalnessMap"),s=t.get("roughnessMap");this.node.p.useMetalnessMap.set(r!=null),this.node.p.useRoughnessMap.set(s!=null),r&&this.node.p.metalnessMap.setNode(r,{relative:!0}),s&&this.node.p.roughnessMap.setNode(s,{relative:!0}),this.node.p.metalness.set(e.metalness),this.node.p.roughness.set(e.roughness)}}const bq=1e-4;function fw(n){return class extends n{constructor(){super(...arguments),this.clearcoat=A.FLOAT(0,{separatorBefore:!0}),this.useClearCoatMap=A.BOOLEAN(0,kn(Rr)),this.clearcoatMap=A.NODE_PATH("",ln(Rr,"useClearCoatMap")),this.useClearCoatNormalMap=A.BOOLEAN(0,kn(Rr)),this.clearcoatNormalMap=A.NODE_PATH("",ln(Rr,"useClearCoatNormalMap")),this.clearcoatNormalScale=A.VECTOR2([1,1],{visibleIf:{useClearCoatNormalMap:1}}),this.clearcoatRoughness=A.FLOAT(0),this.useClearCoatRoughnessMap=A.BOOLEAN(0,kn(Rr)),this.clearcoatRoughnessMap=A.NODE_PATH("",ln(Rr,"useClearCoatRoughnessMap")),this.useSheen=A.BOOLEAN(0,{separatorBefore:!0}),this.sheen=A.FLOAT(0,{range:[0,1],rangeLocked:[!0,!1],visibleIf:{useSheen:1}}),this.sheenRoughness=A.FLOAT(1,{range:[0,1],rangeLocked:[!0,!1],visibleIf:{useSheen:1}}),this.sheenColor=A.COLOR([1,1,1],{visibleIf:{useSheen:1}}),this.useIridescence=A.BOOLEAN(0,{separatorBefore:!0}),this.iridescence=A.FLOAT(1,{range:[0,10],rangeLocked:[!0,!1],visibleIf:{useIridescence:1}}),this.iridescenceIOR=A.FLOAT(1.3,{range:[1,10],rangeLocked:[!1,!1],visibleIf:{useIridescence:1}}),this.iridescenceThicknessRange=A.VECTOR2([0,1],{visibleIf:{useIridescence:1}}),this.useIridescenceMap=A.BOOLEAN(0,{...kn(Rr),visibleIf:{useIridescence:1}}),this.iridescenceMap=A.NODE_PATH("",{...ln(Rr,"useIridescenceMap"),visibleIf:{useIridescence:1,useIridescenceMap:1}}),this.useIridescenceThicknessMap=A.BOOLEAN(0,{...kn(Rr),visibleIf:{useIridescence:1}}),this.iridescenceThicknessMap=A.NODE_PATH("",{...ln(Rr,"useIridescenceThicknessMap"),visibleIf:{useIridescence:1,useIridescenceThicknessMap:1}}),this.transmission=A.FLOAT(0,{separatorBefore:!0,range:[0,1]}),this.useTransmissionMap=A.BOOLEAN(0),this.transmissionMap=A.NODE_PATH("",{visibleIf:{useTransmissionMap:1}}),this.ior=A.FLOAT(1.5,{range:[1,2.3333],rangeLocked:[!0,!0]}),this.thickness=A.FLOAT(.01,{range:[0,10],rangeLocked:[!0,!1]}),this.useThicknessMap=A.BOOLEAN(0),this.thicknessMap=A.NODE_PATH("",{visibleIf:{useThicknessMap:1}}),this.attenuationDistance=A.FLOAT(100,{range:[bq,100],rangeLocked:[!0,!1],step:.01}),this.attenuationColor=A.COLOR([1,1,1])}}}function Cq(n){return n?n.clearcoatRoughness!=null:!1}const qE=new gp,YE=[0,0],qh=[0,0,0];class Rr extends Hr{constructor(e){super(e),this.node=e,this._sheenColorClone=new xe,this._iridescenceRange=[0,0]}initializeNode(){this.add_hooks(this.node.p.useClearCoatMap,this.node.p.clearcoatMap),this.add_hooks(this.node.p.useClearCoatNormalMap,this.node.p.clearcoatNormalMap),this.add_hooks(this.node.p.useClearCoatRoughnessMap,this.node.p.clearcoatRoughnessMap),this.add_hooks(this.node.p.useTransmissionMap,this.node.p.transmissionMap),this.add_hooks(this.node.p.useThicknessMap,this.node.p.thicknessMap),this.add_hooks(this.node.p.useIridescenceMap,this.node.p.iridescenceMap)}static async update(e){const r=(await e.compute()).material();Cq(r)&&e.controllers.physical.updateMaterial(r)}async updateMaterial(e){const t=this.node.pv,r=e;qE.ior=t.ior,r.reflectivity=qE.reflectivity,r.clearcoat=t.clearcoat,r.clearcoatNormalScale!=null&&r.clearcoatNormalScale.copy(t.clearcoatNormalScale),r.clearcoatRoughness=t.clearcoatRoughness,t.useSheen?(this._sheenColorClone.copy(t.sheenColor),r.sheen=t.sheen,r.sheenRoughness=t.sheenRoughness,r.sheenColor=this._sheenColorClone):r.sheen=0,t.useIridescence?(r.iridescence=t.iridescence,r.iridescenceIOR=t.iridescenceIOR,r.iridescenceThicknessRange=t.iridescenceThicknessRange.toArray(this._iridescenceRange)):r.iridescence=0,r.transmission=t.transmission,r.thickness=t.thickness,r.attenuationDistance=t.attenuationDistance,r.attenuationColor=t.attenuationColor,await Promise.all([this._update(e,"clearcoatMap",this.node.p.useClearCoatMap,this.node.p.clearcoatMap),this._update(e,"clearcoatNormalMap",this.node.p.useClearCoatNormalMap,this.node.p.clearcoatNormalMap),this._update(e,"clearcoatRoughnessMap",this.node.p.useClearCoatRoughnessMap,this.node.p.clearcoatRoughnessMap),this._update(e,"transmissionMap",this.node.p.useTransmissionMap,this.node.p.transmissionMap),this._update(e,"thicknessMap",this.node.p.useThicknessMap,this.node.p.thicknessMap),this._update(e,"iridescenceMap",this.node.p.useIridescenceMap,this.node.p.iridescenceMap),this._update(e,"iridescenceThicknessMap",this.node.p.useIridescenceThicknessMap,this.node.p.iridescenceThicknessMap)])}getTextures(e,t){t.set("clearcoatMap",e.clearcoatMap),t.set("clearcoatNormalMap",e.clearcoatNormalMap),t.set("clearcoatRoughnessMap",e.clearcoatRoughnessMap),t.set("transmissionMap",e.transmissionMap),t.set("thicknessMap",e.thicknessMap),t.set("iridescenceMap",e.iridescenceMap),t.set("iridescenceThicknessMap",e.iridescenceThicknessMap)}setParamsFromMaterial(e,t){const r=()=>{const h=t.get("clearcoatMap");this.node.p.useClearCoatMap.set(h!=null),h&&this.node.p.clearcoatMap.setNode(h,{relative:!0})},s=()=>{const h=t.get("clearcoatNormalMap");this.node.p.useClearCoatNormalMap.set(h!=null),h&&this.node.p.clearcoatNormalMap.setNode(h,{relative:!0})},i=()=>{const h=t.get("clearcoatRoughnessMap");this.node.p.useClearCoatRoughnessMap.set(h!=null),h&&this.node.p.clearcoatRoughnessMap.setNode(h,{relative:!0})},o=()=>{const h=t.get("transmissionMap");this.node.p.useTransmissionMap.set(h!=null),h&&this.node.p.transmissionMap.setNode(h,{relative:!0})},a=()=>{const h=t.get("thicknessMap");this.node.p.useThicknessMap.set(h!=null),h&&this.node.p.thicknessMap.setNode(h,{relative:!0})},c=()=>{const h=t.get("iridescenceMap");this.node.p.useIridescenceMap.set(h!=null),h&&this.node.p.iridescenceMap.setNode(h,{relative:!0})},l=()=>{const h=t.get("iridescenceThicknessMap");this.node.p.useIridescenceThicknessMap.set(h!=null),h&&this.node.p.iridescenceThicknessMap.setNode(h,{relative:!0})};r(),s(),i(),o(),a(),c(),l();const u=this.node.p;u.ior.set(e.ior),u.clearcoat.set(e.clearcoat),e.clearcoatNormalScale.toArray(YE),u.clearcoatNormalScale.set(YE),u.clearcoatRoughness.set(e.clearcoatRoughness),e.sheenColor.toArray(qh),u.sheenColor.set(qh),u.sheenColor.setConversion(Ys.NONE),u.sheen.set(e.sheen),u.sheenRoughness.set(e.sheenRoughness),u.transmission.set(e.transmission),u.thickness.set(e.thickness),u.attenuationDistance.set(e.attenuationDistance),e.attenuationColor.toArray(qh),u.attenuationColor.set(qh),u.attenuationColor.setConversion(Ys.NONE),u.iridescence.set(e.iridescence),u.iridescenceIOR.set(e.iridescenceIOR),u.iridescenceThicknessRange.set(e.iridescenceThicknessRange)}}function mw(n){return class extends n{constructor(){super(...arguments),this.useDisplacementMap=A.BOOLEAN(0,{separatorBefore:!0,...kn(Xa)}),this.displacementMap=A.NODE_PATH("",ln(Xa,"useDisplacementMap")),this.displacementScale=A.FLOAT(1,{range:[0,1],rangeLocked:[!1,!1],...ln(Xa,"useDisplacementMap")}),this.displacementBias=A.FLOAT(0,{range:[0,1],rangeLocked:[!1,!1],...ln(Xa,"useDisplacementMap")})}}}function Eq(n){return n?n.displacementScale!=null:!1}class Xa extends Hr{constructor(e){super(e),this.node=e}initializeNode(){this.add_hooks(this.node.p.useDisplacementMap,this.node.p.displacementMap)}static async update(e){e.controllers.displacementMap.update()}async update(){const e=await this.node.material();Eq(e)&&await this.updateMaterial(e)}async updateMaterial(e){await this._update(e,"displacementMap",this.node.p.useDisplacementMap,this.node.p.displacementMap),e.displacementScale=this.node.pv.displacementScale,e.displacementBias=this.node.pv.displacementBias}getTextures(e,t){t.set("displacementMap",e.displacementMap)}setParamsFromMaterial(e,t){const r=t.get("emissiveMap");this.node.p.useDisplacementMap.set(r!=null),r&&this.node.p.displacementMap.setNode(r,{relative:!0}),this.node.p.displacementScale.set(e.displacementScale),this.node.p.displacementBias.set(e.displacementBias)}}class Sq extends nw(aw(i0(d0(fw(pw(hw(l0(lw(dw(mw(uw(c0(a0(o0(h0(ew(u0(Et)))))))))))))))))){}const Aq=new Sq;class Tq extends s0{constructor(){super(...arguments),this.paramsConfig=Aq,this.controllers={colors:new tw(this),advancedCommon:new Za(this),alphaMap:new Jl(this),aoMap:new Ql(this),bumpMap:new ja(this),displacementMap:new Xa(this),emissiveMap:new Jd(this),envMap:new Kd(this),fog:new rw(this),lightMap:new eu(this),map:new Zl(this),metalnessRoughnessMap:new Wa(this),normalMap:new Zd(this),physical:new Rr(this),wireframe:new cw(this)},this.controllersList=Object.values(this.controllers)}static type(){return Wp.MESH_PHYSICAL}createMaterial(){return new gp({vertexColors:!1,side:In,color:16777215,opacity:1,metalness:1,roughness:0})}async cook(){this._material=this._material||this.createMaterial(),await Promise.all(this.controllersPromises(this._material)),this.setMaterial(this._material)}}function Mq(n){return class extends n{constructor(){super(...arguments),this.transparent=A.BOOLEAN(0),this.opacity=A.FLOAT(1),this.alphaTest=A.FLOAT(0)}}}class Rq extends oi{constructor(e){super(e),this.node=e}static async update(e){const t=await e.material();t&&e.controllers.uniformTransparency.updateMaterial(t)}updateMaterial(e){const t=this.node.pv;this._updateTransparency(e,t)}_updateTransparency(e,t){e.transparent=t.transparent,this._updateCommon(e,t)}_updateCommon(e,t){const r=e;r.uniforms&&r.uniforms.opacity&&(r.uniforms.opacity.value=t.opacity),e.opacity=t.opacity,r.uniforms&&r.uniforms.alphaTest&&(r.uniforms.alphaTest.value=t.alphaTest),e.alphaTest=t.alphaTest;const s=e.customMaterials;if(s){const i=Object.keys(s);for(const o of i){const a=s[o];a&&this._updateCommon(a,t)}}}}function wq(){const n={ShadowMaterial:lT,SpriteMaterial:tT,RawShaderMaterial:Zg,ShaderMaterial:Kn,PointsMaterial:Pi,MeshPhysicalMaterial:gp,MeshStandardMaterial:kl,MeshPhongMaterial:Jg,MeshToonMaterial:uT,MeshNormalMaterial:hT,MeshLambertMaterial:dT,MeshDepthMaterial:Vg,MeshDistanceMaterial:zg,MeshBasicMaterial:_u,MeshMatcapMaterial:pT,LineDashedMaterial:fT,LineBasicMaterial:Cs,Material:gn};gn.fromType=function(e){return new n[e]}}const Oq=new Set(["shaders","functionBody"]);class p0{constructor(e){this.node=e}load(e){}async toDataWithoutShaders(){const e=await this.toData();if(!e)return;const t={},r=Object.keys(e);for(const s of r)Oq.has(s)||(t[s]=e[s]);return t}_materialToJson(e,t){let r;return this._withPreparedMaterial(e,()=>{try{if(r=e.toJSON({}),r){const s=e.depthPacking;r.depthPacking=s}}catch(s){console.error("failed to save material data"),console.log(e),console.log(s)}r&&e.lights!=null&&(r.lights=e.lights),r&&(r.uuid=`${t.node.path()}-${t.suffix}`)}),r}_withPreparedMaterial(e,t){this._withUnassignedUniformTextures(e,()=>{this._withUnassignedBasePropertyTextures(e,()=>{this._withUnassignedOnBeforeCompileData(e,()=>{t()})})})}_withUnassignedOnBeforeCompileData(e,t){const r=$l.removeUniforms(e),s=uc.removeData(e);t(),r&&$l.setUniforms(e,r),s&&uc.setData(e,s)}_withUnassignedUniformTextures(e,t){const r=new Map,s=e.uniforms;if(s){const i=Object.keys(s);for(const o of i){const a=s[o].value;if(a&&a.uuid){const c=a;r.set(o,c),s[o].value=null}}}t(),s&&r.forEach((i,o)=>{s[o].value=i})}_withUnassignedBasePropertyTextures(e,t){const r=new Map,s=Object.keys(e);for(const i of s){const o=e[i];o&&o.uuid&&o instanceof Wn&&(r.set(i,o),e[i]=null)}t(),r.forEach((i,o)=>{e[o]=i})}_loadMaterial(e){e.color=void 0;const t=new ev;wq();const r=t.parse(e);e.depthPacking&&(r.depthPacking=e.depthPacking),e.lights!=null&&(r.lights=e.lights);const s=r.uniforms;if(s){const i=s.uv2Transform;i&&this.mat4ToMat3(i);const o=s.uvTransform;o&&this.mat4ToMat3(o)}return r}mat4ToMat3(e){const t=e.value;if(t.elements[t.elements.length-1]==null){const s=new nt;for(let i=0;i<s.elements.length;i++)s.elements[i]=t.elements[i];e.value=s}}}function KE(n){return{paramConfigs:n.paramConfigs,timeDependent:n.timeDependent,resolutionDependent:n.resolutionDependent,raymarchingLightsWorldCoordsDependent:n.raymarchingLightsWorldCoordsDependent}}function ZE(n,e){return{paramConfigs:n.paramConfigs,timeDependent:n.timeDependent,resolutionDependent:n.resolutionDependent,raymarchingLightsWorldCoordsDependent:n.raymarchingLightsWorldCoordsDependent,fragmentShader:e.fragment,vertexShader:e.vertex}}function mi(n,e){return e?`${e}.${n}`:n}class Pq extends p0{constructor(e){super(e),this.node=e}async toData(){const e=this.node.assemblerController();if(!e)return;const t=e.assembler,r=t.onBeforeCompileData();if(!r)return;const s=Va.toJSON(r),i=KE(s),o={[mi("vertex")]:s.vertexShader,[mi("fragment")]:s.fragmentShader},a={},c=await this.node.material();if(!c)return;const l=c.customMaterials;l&&t.traverseCustomAssemblers((d,p)=>{const _=d.onBeforeCompileData();if(_){const g=l[p];if(g){const f=this._materialToJson(g,{node:this.node,suffix:p});if(f){const m=Va.toJSON(_),y=KE(m);a[p]={material:f,onBeforeCompileDataJSONWithoutShaders:y},o[mi("vertex",p)]=m.vertexShader,o[mi("fragment",p)]=m.fragmentShader}}}});const u=this._materialToJson(c,{node:this.node,suffix:"main"});return u||console.warn("failed to save material from node",this.node.path()),{material:u||{},onBeforeCompileDataJSONWithoutShaders:i,customMaterials:a,shaders:o}}load(e){if(this.node.assemblerController()||(this._material=this._loadMaterial(e.material),!this._material))return;const r=e.shaders;if(!r){console.warn(`${this.node.path()}: persisted config has no shaders`);return}const s=ZE(e.onBeforeCompileDataJSONWithoutShaders,{vertex:r[mi("vertex")],fragment:r[mi("fragment")]}),i=Va.fromJSON(s),o=this._material;z_(this.node.scene(),o,i);for(let a of i.paramConfigs)a.applyToNode(this.node);if(this._material.customMaterials=this._material.customMaterials||{},e.customMaterials){const a=Object.keys(e.customMaterials);for(const c of a){const l=e.customMaterials[c],u=this._loadMaterial(l.material);if(u){const h=ZE(l.onBeforeCompileDataJSONWithoutShaders,{vertex:r[mi("vertex",c)],fragment:r[mi("fragment",c)]}),d=Va.fromJSON(h);d.paramConfigs=i.paramConfigs,z_(this.node.scene(),u,d),this._material.customMaterials[c]=u}}}}material(){return this._material}}function Nq(n){return class extends n{constructor(){super(...arguments),this.setBuilderNode=A.BOOLEAN(0,{callback:t=>{ug.PARAM_CALLBACK_setCompileRequired(t)}}),this.builderNode=A.NODE_PATH("",{visibleIf:{setBuilderNode:!0},callback:t=>{ug.PARAM_CALLBACK_setCompileRequired(t)}})}}}class ug extends s0{constructor(){super(...arguments),this._childrenControllerContext=be.GL,this.persisted_config=new Pq(this)}createMaterial(){var e;let t;return this.persisted_config&&(t=this.persisted_config.material()),t||(t=(e=this.assemblerController())==null?void 0:e.assembler.createMaterial()),t}assemblerController(){return this._assemblerController=this._assemblerController||this._createAssemblerController()}customMaterialRequested(e){return!0}createNode(e,t){return super.createNode(e,t)}children(){return super.children()}nodesByType(e){return super.nodesByType(e)}childrenAllowed(){return this.assemblerController()?super.childrenAllowed():!1}sceneReadonly(){return this.assemblerController()==null}compileIfRequired(e){var t;if((t=this.assemblerController())!=null&&t.compileRequired())try{this._compile(e)}catch(r){const s=r.message||"failed to compile";this.states.error.set(s)}}_compile(e){const t=this.assemblerController();e&&t&&(t.assembler.setGlParentNode(this),this._setAssemblerGlParentNode(t),t.assembler.compileMaterial(e),t.post_compile())}_setAssemblerGlParentNode(e){if(!this.pv.setBuilderNode)return;const t=this.pv.builderNode.nodeWithContext(be.MAT);if(!t)return;const r=t;if(!r.assemblerController()){this.states.error.set(`resolved node '${t.path()}' is not a builder node`);return}if(r.type()!=this.type()){this.states.error.set(`resolved node '${t.path()}' does not have the same type '${t.type()}' as current node '${this.type()}'`);return}e.assembler.setGlParentNode(r)}static PARAM_CALLBACK_setCompileRequired(e){e.PARAM_CALLBACK_setCompileRequired()}PARAM_CALLBACK_setCompileRequired(){var e;(e=this.assemblerController())==null||e.setCompilationRequired(!0)}}function Iq(n){return class extends n{constructor(){super(...arguments),this.useFog=A.BOOLEAN(0)}}}function Dq(n){return n?n.fog!=null:!1}class Lq extends oi{constructor(e){super(e),this.node=e}static async update(e){const t=await e.material();Dq(t)&&e.controllers.uniformFog.updateMaterial(t)}updateMaterial(e){const t=this.node.pv;e.fog=t.useFog}getTextures(e,t){}setParamsFromMaterial(e,t){this.node.p.useFog.set(e.fog)}}function Fq(n){return class extends n{constructor(){super(...arguments),this.wireframe=A.BOOLEAN(0),this.wireframeLinewidth=A.FLOAT(1,{range:[0,5],rangeLocked:[!0,!1],visibleIf:{wireframe:1}})}}}class Uq extends oi{constructor(e){super(e),this.node=e}static async update(e){const t=await e.material();t&&e.controllers.wireframeShader.updateMaterial(t)}updateMaterial(e){const t=this.node.pv,r=e;r.wireframe!=null&&(r.wireframe=t.wireframe,r.wireframeLinewidth=t.wireframeLinewidth,r.needsUpdate=!0)}}const kq=`#define LIGHT_WORLD_SIZE 0.005
// #define LIGHT_FRUSTUM_WIDTH 1.0
// #define PCSS_FILTER_SIZE 1.0
#define LIGHT_SIZE_UV (PCSS_FILTER_SIZE * LIGHT_WORLD_SIZE)
#define NEAR_PLANE 9.5

#define NUM_SAMPLES 17
#define NUM_RINGS 11
#define BLOCKER_SEARCH_NUM_SAMPLES NUM_SAMPLES

vec2 poissonDisk[NUM_SAMPLES];

void initPoissonSamples( const in vec2 randomSeed ) {
	float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );
	float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );

	// jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/
	float angle = rand( randomSeed ) * PI2;
	float radius = INV_NUM_SAMPLES;
	float radiusStep = radius;

	for( int i = 0; i < NUM_SAMPLES; i ++ ) {
		poissonDisk[i] = vec2( cos( angle ), sin( angle ) ) * pow( radius, 0.75 );
		radius += radiusStep;
		angle += ANGLE_STEP;
	}
}

float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
	return (zReceiver - zBlocker) / zBlocker;
}

float findBlocker( sampler2D shadowMap, const in vec2 uv, const in float zReceiver ) {
	// This uses similar triangles to compute what
	// area of the shadow map we should search
	float searchRadius = LIGHT_SIZE_UV * ( zReceiver - NEAR_PLANE ) / zReceiver;
	float blockerDepthSum = 0.0;
	int numBlockers = 0;

	for( int i = 0; i < BLOCKER_SEARCH_NUM_SAMPLES; i++ ) {
		float shadowMapDepth = unpackRGBAToDepth(texture2D(shadowMap, uv + poissonDisk[i] * searchRadius));
		if ( shadowMapDepth < zReceiver ) {
			blockerDepthSum += shadowMapDepth;
			numBlockers ++;
		}
	}

	if( numBlockers == 0 ) return -1.0;

	return blockerDepthSum / float( numBlockers );
}

float PCF_Filter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius ) {
	float sum = 0.0;
	float depth;
	#pragma unroll_loop_start
	for( int i = 0; i < 17; i ++ ) {
		depth = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );
		if( zReceiver <= depth ) sum += 1.0;
	}
	#pragma unroll_loop_end
	#pragma unroll_loop_start
	for( int i = 0; i < 17; i ++ ) {
		depth = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );
		if( zReceiver <= depth ) sum += 1.0;
	}
	#pragma unroll_loop_end
	return sum / ( 2.0 * float( 17 ) );
}

float PCSS ( sampler2D shadowMap, vec4 coords ) {
	vec2 uv = coords.xy;
	float zReceiver = coords.z; // Assumed to be eye-space z in this code

	initPoissonSamples( uv );
	// STEP 1: blocker search
	float avgBlockerDepth = findBlocker( shadowMap, uv, zReceiver );

	//There are no occluders so early out (this saves filtering)
	if( avgBlockerDepth == -1.0 ) return 1.0;

	// STEP 2: penumbra size
	float penumbraRatio = penumbraSize( zReceiver, avgBlockerDepth );
	float filterRadius = penumbraRatio * LIGHT_SIZE_UV * NEAR_PLANE / zReceiver;

	// STEP 3: filtering
	//return avgBlockerDepth;
	return PCF_Filter( shadowMap, uv, zReceiver, filterRadius );
}`,Bq="return PCSS( shadowMap, shadowCoord );",Gq=`
#if NUM_SPOT_LIGHT_COORDS > 0

	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];

#endif

#if NUM_SPOT_LIGHT_MAPS > 0

	uniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];

#endif

#ifdef USE_SHADOWMAP

	#if NUM_DIR_LIGHT_SHADOWS > 0

		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];

		struct DirectionalLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};

		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];

	#endif

	#if NUM_SPOT_LIGHT_SHADOWS > 0

		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];

		struct SpotLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};

		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];

	#endif

	#if NUM_POINT_LIGHT_SHADOWS > 0

		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];

		struct PointLightShadow {
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};

		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];

	#endif

	/*
	#if NUM_RECT_AREA_LIGHTS > 0

		// TODO (abelnation): create uniforms for area light shadows

	#endif
	*/

	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {

		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );

	}

	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {

		return unpackRGBATo2Half( texture2D( shadow, uv ) );

	}

	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){

		float occlusion = 1.0;

		vec2 distribution = texture2DDistribution( shadow, uv );

		float hard_shadow = step( compare , distribution.x ); // Hard Shadow

		if (hard_shadow != 1.0 ) {

			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance ); // Chebeyshevs inequality
			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 ); // 0.3 reduces light bleed
			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );

		}
		return occlusion;

	}

	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {

		float shadow = 1.0;

		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;

		bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
		bool frustumTest = inFrustum && shadowCoord.z <= 1.0;

		if ( frustumTest ) {

		#if defined( SHADOWMAP_TYPE_PCF )

			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;

			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;

			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );

		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )

			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;

			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;

			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );

		#elif defined( SHADOWMAP_TYPE_VSM )

			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );

		#else // no percentage-closer filtering:

			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );

		#endif

		}

		return shadow;

	}

	// cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D
	// vector suitable for 2D texture mapping. This code uses the following layout for the
	// 2D texture:
	//
	// xzXZ
	//  y Y
	//
	// Y - Positive y direction
	// y - Negative y direction
	// X - Positive x direction
	// x - Negative x direction
	// Z - Positive z direction
	// z - Negative z direction
	//
	// Source and test bed:
	// https://gist.github.com/tschw/da10c43c467ce8afd0c4

	vec2 cubeToUV( vec3 v, float texelSizeY ) {

		// Number of texels to avoid at the edge of each square

		vec3 absV = abs( v );

		// Intersect unit cube

		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;

		// Apply scale to avoid seams

		// two texels less per square (one texel will do for NEAREST)
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );

		// Unwrap

		// space: -1 ... 1 range for each square
		//
		// #X##		dim    := ( 4 , 2 )
		//  # #		center := ( 1 , 1 )

		vec2 planar = v.xy;

		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;

		if ( absV.z >= almostOne ) {

			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;

		} else if ( absV.x >= almostOne ) {

			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;

		} else if ( absV.y >= almostOne ) {

			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;

		}

		// Transform to UV space

		// scale := 0.5 / dim
		// translate := ( center + 0.5 ) / dim
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );

	}

	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {

		vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );

		// for point lights, the uniform @vShadowCoord is re-purposed to hold
		// the vector from the light to the world-space position of the fragment.
		vec3 lightToPosition = shadowCoord.xyz;

		// dp = normalized distance from light to fragment position
		float dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?
		dp += shadowBias;

		// bd3D = base direction 3D
		vec3 bd3D = normalize( lightToPosition );

		#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )

			vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;

			return (
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
				texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
			) * ( 1.0 / 9.0 );

		#else // no percentage-closer filtering

			return texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );

		#endif

	}

#endif
`;xt.BOOL+"",xt.INT+"",xt.FLOAT+"",xt.VEC2+"",xt.VEC3+"",xt.VEC4+"",xt.MAT3+"",xt.MAT4+"",xt.SAMPLER_2D+"",xt.SAMPLER_2D_ARRAY+"",xt.SAMPLER_3D+"",xt.SAMPLER_CUBE+"",xt.SSS_MODEL+"",xt.SDF_CONTEXT+"",xt.SDF_MATERIAL+"";class hg{static glType(e,t){switch(e){case xt.BOOL:return this.bool(t);case xt.INT:return this.integer(t);case xt.FLOAT:return this.float(t);case xt.VEC2:return this.vector2(t);case xt.VEC3:return this.vector3(t);case xt.VEC4:return this.vector4(t)}return`no matching implementation for glType '${e}' in ThreeToGl.glType`}static any(e){return Ke(e)?e:mr(e)?`${e}`:Ye(e)?`${dn(e)}`:_t(e)?this.numeric_array(e):e instanceof W||e instanceof T||e instanceof We||e instanceof xe?this.numeric_array(e.toArray()):`ThreeToGl error: unknown value type '${e}'`}static numeric_array(e){const t=new Array(e.length);for(let s=0;s<e.length;s++)t[s]=`${dn(e[s])}`;return`${`vec${e.length}`}(${t.join(", ")})`}static mat4(e){return Ke(e)?e:`mat4(${e.toArray().map(r=>`${dn(r)}`).join(", ")})`}static mat3(e){return Ke(e)?e:`mat3(${e.toArray().map(r=>`${dn(r)}`).join(", ")})`}static vector4(e){return Ke(e)?e:`vec4(${e.toArray().map(r=>`${dn(r)}`).join(", ")})`}static vector3(e){return Ke(e)?e:`vec3(${e.toArray().map(r=>`${dn(r)}`).join(", ")})`}static vector2(e){return Ke(e)?e:`vec2(${e.toArray().map(r=>`${dn(r)}`).join(", ")})`}static vector3_float(e,t){return Ye(t)&&(t=dn(t)),`vec4(${this.vector3(e)}, ${t})`}static float4(e,t,r,s){return Ye(e)&&(e=dn(e)),Ye(t)&&(t=dn(t)),Ye(r)&&(r=dn(r)),Ye(s)&&(s=dn(s)),`vec4(${e}, ${t}, ${r}, ${s})`}static float3(e,t,r){return Ye(e)&&(e=dn(e)),Ye(t)&&(t=dn(t)),Ye(r)&&(r=dn(r)),`vec3(${e}, ${t}, ${r})`}static float2(e,t){return Ye(e)&&(e=dn(e)),Ye(t)&&(t=dn(t)),`vec2(${e}, ${t})`}static float(e){if(Ye(e))return dn(e);{const t=parseFloat(e);return isNaN(t)?e:dn(t)}}static integer(e){if(Ye(e))return B_(e);{const t=parseInt(e);return isNaN(t)?e:B_(t)}}static bool(e){return mr(e)?`${e}`:e}}function Vq(n){return class extends n{constructor(){super(...arguments),this.shadowPCSS=A.BOOLEAN(0,{callback:t=>{tu.PARAM_CALLBACK_setRecompileRequired(t)},separatorBefore:!0}),this.shadowPCSSFilterSize=A.FLOAT(1,{visibleIf:{shadowPCSS:1},range:[0,10],rangeLocked:[!0,!1]})}}}function zq(n){return!!n}class tu extends oi{constructor(e){super(e),this.node=e}static filterFragmentShader(e,t){const r=`
#define PCSS_FILTER_SIZE ${hg.float(e.pv.shadowPCSSFilterSize)}
${kq}
`;let s=Gq;return s=s.replace("#ifdef USE_SHADOWMAP",`#ifdef USE_SHADOWMAP
${r}
				`),s=s.replace("#if defined( SHADOWMAP_TYPE_PCF )",`
				${Bq}
				#if defined( SHADOWMAP_TYPE_PCF )`),t=t.replace("#include <shadowmap_pars_fragment>",s),t}static async update(e){const t=await e.material();zq(t)&&e.controllers.PCSS.updateMaterial(t)}async update(){tu.update(this.node)}updateMaterial(e){var t,r;const s=this.node;if(!s.assemblerController)return;const i="PCSS";this.node.pv.shadowPCSS?(t=s.assemblerController())==null||t.addFilterFragmentShaderCallback(i,o=>tu.filterFragmentShader(this.node,o)):(r=s.assemblerController())==null||r.removeFilterFragmentShaderCallback(i)}static PARAM_CALLBACK_setRecompileRequired(e){e.controllers.PCSS.update()}}function Hq(n){var e;(e=n.assemblerController())==null||e.setCompilationRequired()}const Yh={callback:n=>Hq(n)};function jq(n){return class extends n{constructor(){super(...arguments),this.overrideCustomMaterials=A.BOOLEAN(0,{...Yh,separatorBefore:!0,separatorAfter:!0}),this.createCustomMatDistance=A.BOOLEAN(1,{visibleIf:{overrideCustomMaterials:1},...Yh}),this.createCustomMatDepth=A.BOOLEAN(1,{visibleIf:{overrideCustomMaterials:1},...Yh}),this.createCustomMatDepthDOF=A.BOOLEAN(1,{visibleIf:{overrideCustomMaterials:1},...Yh,separatorAfter:!0})}}}function Wq(n,e){if(!n.p.overrideCustomMaterials)return console.warn(`param overrideCustomMaterials not found on ${n.path()}, creating all customMaterials`),!0;if(!n.pv.overrideCustomMaterials)return!0;switch(e){case gd.DISTANCE:return n.pv.createCustomMatDistance;case gd.DEPTH:return n.pv.createCustomMatDepth;case gd.DEPTH_DOF:return n.pv.createCustomMatDepthDOF}St.unreachable(e)}function Xq(n){return class extends Vq(Iq(Fq(i0(Nq(n))))){}}class $q extends jq(Xq(d0(fw(pw(hw(l0(lw(dw(mw(uw(c0(a0(o0(h0(Mq(u0(Et))))))))))))))))){}const qq=new $q;class Yq extends ug{constructor(){super(...arguments),this.paramsConfig=qq,this.controllers={advancedCommon:new Za(this),alphaMap:new Jl(this),aoMap:new Ql(this),bumpMap:new ja(this),displacementMap:new Xa(this),emissiveMap:new Jd(this),envMap:new Kd(this),uniformFog:new Lq(this),lightMap:new eu(this),map:new Zl(this),metalnessRoughnessMap:new Wa(this),normalMap:new Zd(this),physical:new Rr(this),PCSS:new tu(this),uniformTransparency:new Rq(this),wireframeShader:new Uq(this)},this.controllersList=Object.values(this.controllers)}static type(){return Wp.MESH_PHYSICAL_BUILDER}usedAssembler(){return Rp.GL_MESH_PHYSICAL}_createAssemblerController(){return ve.assemblersRegister.assembler(this,this.usedAssembler())}customMaterialRequested(e){return Wq(this,e)}createMaterial(){const e=super.createMaterial();return e.isMeshStandardMaterial=!0,e.isMeshPhysicalMaterial=!0,e}async cook(){this._material=this._material||this.createMaterial(),await Promise.all(this.controllersPromises(this._material)),this.compileIfRequired(this._material),this.setMaterial(this._material)}}class Kq extends rs{constructor(){super(...arguments),this.renderOrder=0,this._children_group=this._create_children_group(),this._attachableToHierarchy=!0,this._usedInScene=!0}static context(){return be.OBJ}_create_children_group(){const e=new lr;return e.matrixAutoUpdate=!1,e}attachableToHierarchy(){return this._attachableToHierarchy}usedInScene(){return this._usedInScene&&this.disposed()==!1}addObjectToParent(e){this.attachableToHierarchy()&&(e.add(this.object),ve.onObjectsAddRemoveHooks.runOnAddHookOnObject(this._scene,this.object))}removeObjectFromParent(){if(this.attachableToHierarchy()){const e=this.object.parent;e&&(ve.onObjectsAddRemoveHooks.runOnRemoveHookOnObject(this._scene,this.object),e.remove(this.object))}}dispose(){var e;super.dispose(),(e=this.childrenDisplayController)==null||e.dispose()}initializeBaseNode(){this._object=this._create_object_with_attributes(),this.nameController.add_post_set_fullPath_hook(this.set_object_name.bind(this)),this.set_object_name()}childrenGroup(){return this._children_group}get object(){return this._object}_create_object_with_attributes(){const e=this.createObject();return e.node=this,e.add(this._children_group),e}set_object_name(){this._object&&(this._object.name=this.path(),this._children_group.name=`${this.path()}:parentedOutputs`)}createObject(){const e=new wt;return e.matrixAutoUpdate=!1,e}isDisplayNodeCooking(){var e,t,r;if((t=(e=this.flags)==null?void 0:e.display)!=null&&t.active()){const s=(r=this.displayNodeController)==null?void 0:r.displayNode();if(s)return s.cookController.isCooking()}return!1}isDisplayed(){var e,t;return((t=(e=this.flags)==null?void 0:e.display)==null?void 0:t.active())||!1}}const Zq={dependsOnDisplayNode:!0};function JE(n){console.error("displayNodeController not initialized",n)}function Jq(n){console.error("displayNodeController already initialed",n)}class Qq{constructor(e,t,r=Zq){this.node=e,this.options=r,this._initialized=!1,this._displayNode=void 0,this._displayNodeOverride=void 0,this._graphNode=new _r(e.scene(),`DisplayNodeController-${e.name()}`),this._onDisplayNodeRemoveCallback=t.onDisplayNodeRemove,this._onDisplayNodeSetCallback=t.onDisplayNodeSet,this._onDisplayNodeUpdateCallback=t.onDisplayNodeUpdate}dispose(){this._graphNode.dispose()}displayNode(){return this._displayNodeOverride||this._displayNode}firstNonBypassedDisplayNode(){var e;return(e=this.displayNode())==null?void 0:e.containerController.firstNonBypassedNode()}initializeNode(){if(this._initialized){Jq(this.node);return}this._initialized=!0,this.node.lifecycle.onChildAdd(e=>{var t,r;this._displayNode||(r=(t=e.flags)==null?void 0:t.display)==null||r.set(!0)}),this.node.lifecycle.onChildRemove(e=>{var t,r;if(e.graphNodeId()==((t=this._displayNode)==null?void 0:t.graphNodeId())){const s=this.node.children();for(let i=s.length-1;i>=0;i--){const a=(r=s[i].flags)==null?void 0:r.display;if(a){a.set(!0);return}}this.setDisplayNode(void 0)}}),this._graphNode.dirtyController.addPostDirtyHook("_requestDisplayNodeContainer",()=>{this._onDisplayNodeUpdateCallback&&this._onDisplayNodeUpdateCallback()})}setDisplayNodeOverride(e){this._initialized||JE(this.node);const t=this._displayNodeOverride;if(t!=e){const r=t;r&&(this.options.dependsOnDisplayNode&&this._graphNode.removeGraphInput(r),this._onDisplayNodeRemoveCallback&&this._onDisplayNodeRemoveCallback()),this._displayNodeOverride=e,e?(this.options.dependsOnDisplayNode&&this._graphNode.addGraphInput(e),this._onDisplayNodeSetCallback&&this._onDisplayNodeSetCallback()):this._displayNode&&this._commitDisplayNode(this._displayNode)}}setDisplayNode(e){this._initialized||JE(this.node);const t=this._displayNode;if(t!=e){const r=t;r&&(r.flags.display.set(!1),this.options.dependsOnDisplayNode&&this._graphNode.removeGraphInput(r),this._onDisplayNodeRemoveCallback&&this._onDisplayNodeRemoveCallback()),this._displayNode=e,e&&this._commitDisplayNode(e)}}_commitDisplayNode(e){this.options.dependsOnDisplayNode&&this._graphNode.addGraphInput(e),this._onDisplayNodeSetCallback&&this._onDisplayNodeSetCallback()}}function _w(n,e){const t=(e==null?void 0:e.matrixAutoUpdate)||!1;return class extends n{constructor(){super(...arguments),this.transform=A.FOLDER(),this.keepPosWhenParenting=A.BOOLEAN(0),this.rotationOrder=A.INTEGER(Io.indexOf(Dv.XYZ),{menu:{entries:Io.map((s,i)=>({name:s,value:i}))}}),this.t=A.VECTOR3([0,0,0]),this.r=A.VECTOR3([0,0,0]),this.s=A.VECTOR3([1,1,1]),this.scale=A.FLOAT(1),this.matrixAutoUpdate=A.BOOLEAN(t?1:0),this.updateTransformFromObject=A.BUTTON(null,{callback:s=>{f0.PARAM_CALLBACK_update_transform_from_object(s)}})}}}class Pne extends _w(Et){}const QE="_cook_main_without_inputs_when_dirty";class f0{constructor(e){this.node=e,this._cook_main_without_inputs_when_dirty_bound=this._cook_main_without_inputs_when_dirty.bind(this),this._core_transform=new Pn,this._keep_pos_when_parenting_m_object=new qe,this._keep_pos_when_parenting_m_new_parent_inv=new qe}initializeNode(){this.node.dirtyController.hasHook(QE)||this.node.dirtyController.addPostDirtyHook(QE,this._cook_main_without_inputs_when_dirty_bound)}async _cook_main_without_inputs_when_dirty(){await this.node.cookController.cookMainWithoutInputs()}update(){this.update_transform_with_matrix();const e=this.node.object;e.matrixAutoUpdate=this.node.pv.matrixAutoUpdate,ve.onSceneUpdatedHooks.runHooks()}update_transform_with_matrix(e){const t=this.node.object;e!=null&&!e.equals(t.matrix)?(t.matrix.copy(e),t.dispatchEvent({type:"change"})):this._update_matrix_from_params_with_core_transform()}_update_matrix_from_params_with_core_transform(){const e=this.node.object;let t=e.matrixAutoUpdate;t&&(e.matrixAutoUpdate=!1);const r=this._core_transform.matrix(this.node.pv.t,this.node.pv.r,this.node.pv.s,this.node.pv.scale,Io[this.node.pv.rotationOrder]);e.matrix.identity(),e.applyMatrix4(r),this._apply_look_at(),e.updateMatrix(),t&&(e.matrixAutoUpdate=!0),e.dispatchEvent({type:"change"})}_apply_look_at(){}set_params_from_matrix(e,t={}){Pn.setParamsFromMatrix(e,this.node,t)}static update_node_transform_params_if_required(e,t){e.transformController.update_node_transform_params_if_required(t)}update_node_transform_params_if_required(e){if(!this.node.pv.keepPosWhenParenting||!this.node.scene().loadingController.loaded()||e==this.node.object.parent)return;const t=this.node.object;t.updateMatrixWorld(!0),e.updateMatrixWorld(!0),this._keep_pos_when_parenting_m_object.copy(t.matrixWorld),this._keep_pos_when_parenting_m_new_parent_inv.copy(e.matrixWorld),this._keep_pos_when_parenting_m_new_parent_inv.invert(),this._keep_pos_when_parenting_m_object.premultiply(this._keep_pos_when_parenting_m_new_parent_inv),Pn.setParamsFromMatrix(this._keep_pos_when_parenting_m_object,this.node,{scale:!0})}update_node_transform_params_from_object(e=!1){const t=this.node.object;e&&t.updateMatrix(),Pn.setParamsFromMatrix(t.matrix,this.node,{scale:!0})}static PARAM_CALLBACK_update_transform_from_object(e){e.transformController.update_node_transform_params_from_object()}}class m0{constructor(e){this.node=e}initializeNode(){this.node.io.inputs.setCount(0,1),this.node.io.inputs.setDependsOnInputs(!1),this.node.io.outputs.setHasOneOutput(),this.node.io.inputs.add_on_set_input_hook("on_input_updated:update_parent",()=>{this.on_input_updated()})}static on_input_updated(e){const t=e.root().getParentForNode(e);e.transformController&&t&&f0.update_node_transform_params_if_required(e,t),e.io.inputs.input(0)!=null?e.root().addToParentTransform(e):e.root().removeFromParentTransform(e)}on_input_updated(){m0.on_input_updated(this.node)}}const eS="display";class e8{constructor(e){this.node=e,this._childrenUuids=new Set,this._sopGroup=this._createSopGroup(),this._newSpecializedObjects=[],this._newObjectsAreDifferent=!1,this._scene=this.node.scene()}_createSopGroup(){const e=new lr;return e.matrixAutoUpdate=!1,e}sopGroup(){return this._sopGroup}setSopGroupName(){this._sopGroup.name=`${this.node.name()}:sopGroup`}dispose(){this._clearHooks()}displayNodeControllerCallbacks(){return{onDisplayNodeRemove:()=>{this.removeChildren()},onDisplayNodeSet:()=>{setTimeout(()=>{this.requestDisplayNodeContainer()},0)},onDisplayNodeUpdate:()=>{this.node.scene().loadingController.loaded()&&this.requestDisplayNodeContainer()}}}initializeNode(){var e;this.node.object.add(this.sopGroup()),this.node.nameController.add_post_set_fullPath_hook(this.setSopGroupName.bind(this)),this._createSopGroup();const t=(e=this.node.flags)==null?void 0:e.display;t&&t.onUpdate(()=>{this._updateSopGroupHierarchy(),t.active()&&this.requestDisplayNodeContainer()})}_updateSopGroupHierarchy(){var e;if((e=this.node.flags)==null?void 0:e.display){const r=this.sopGroup();this.usedInScene()?(r.visible=!0,this.node.object.add(r),r.updateMatrix()):(r.visible=!1,this.node.object.remove(r)),ve.onSceneUpdatedHooks.runHooks()}}usedInScene(){var e,t;const r=this.node;if(r.disposed()==!0||!r.usedInScene()||!(((t=(e=r.flags)==null?void 0:e.display)==null?void 0:t.active())||!1))return!1;const a=r.params.has(eS),c=r.params.boolean(eS);return!a||c}async requestDisplayNodeContainer(){this._scene.loadingController.loaded()&&this.usedInScene()&&await this._setContentUnderSopGroup()}removeChildren(){if(this._sopGroup.children.length==0)return;let e;for(ve.onObjectsAddRemoveHooks.runOnRemoveHooks(this._scene,this._sopGroup);e=this._sopGroup.children[0];)this._sopGroup.remove(e);this._childrenUuids.clear(),this._notifyCamerasController()}async _setContentUnderSopGroup(){var e;const t=this.node.displayNodeController.displayNode();if(t&&((e=t.parent())==null?void 0:e.graphNodeId())==this.node.graphNodeId()){const s=(await t.compute()).coreContent();if(s){const i=s.threejsObjects(),o=()=>{if(i.length!=this._childrenUuids.size)return!0;for(const c of i)if(!this._childrenUuids.has(c.uuid))return!0;return!1};if(this._newObjectsAreDifferent=o(),this._newSpecializedObjects.length=0,this._addSpecializedObjects(t,s,this._newSpecializedObjects),this._newObjectsAreDifferent){this.removeChildren();const a=c=>{this._sopGroup.add(c),c.updateMatrix(),this._childrenUuids.add(c.uuid)};for(const c of i)a(c);for(const c of this._newSpecializedObjects)a(c)}this._notifyCamerasController(),this._runOnSopGroupUpdatedHooks(),this._scene.loadingController.loaded()&&(ve.onObjectsAddRemoveHooks.runOnAddHooks(this._scene,this._sopGroup),ve.onSceneUpdatedHooks.runHooks());return}}this.removeChildren(),this._runOnSopGroupUpdatedHooks(),this._scene.loadingController.loaded()&&ve.onSceneUpdatedHooks.runHooks()}_notifyCamerasController(){this._scene.camerasController.updateFromChangeInObject(this._sopGroup)}_addSpecializedObjects(e,t,r){}registerOnSopGroupUpdated(e,t){this._onSopGroupUpdatedHookNames=this._onSopGroupUpdatedHookNames||[],this._onSopGroupUpdatedHooks=this._onSopGroupUpdatedHooks||[],this._onSopGroupUpdatedHookNames.push(e),this._onSopGroupUpdatedHooks.push(t)}_clearHooks(){if(!(!this._onSopGroupUpdatedHookNames||!this._onSopGroupUpdatedHooks))for(const e of this._onSopGroupUpdatedHookNames)this.deregisterOnSopGroupUpdated(e)}deregisterOnSopGroupUpdated(e){var t;if(!this._onSopGroupUpdatedHookNames||!this._onSopGroupUpdatedHooks)return;const r=(t=this._onSopGroupUpdatedHookNames)==null?void 0:t.indexOf(e);this._onSopGroupUpdatedHookNames.splice(r,1),this._onSopGroupUpdatedHooks.splice(r,1),this._onSopGroupUpdatedHookNames.length==0&&(this._onSopGroupUpdatedHookNames=void 0),this._onSopGroupUpdatedHooks.length==0&&(this._onSopGroupUpdatedHooks=void 0)}_runOnSopGroupUpdatedHooks(){if(this._onSopGroupUpdatedHooks){const e=[...this._onSopGroupUpdatedHooks];for(const t of e)t()}}onSopGroupUpdatedCallbackNames(){return this._onSopGroupUpdatedHookNames}}class t8 extends e8{constructor(e){super(e),this.node=e}_addSpecializedObjects(e,t,r){const s=ve.specializedChildren.runHooks(e,t,r,this.node.pv);s&&(this._newObjectsAreDifferent=s)}}var _0=(n=>(n.GEO="geo",n.CUBE_CAMERA="cubeCamera",n.AUDIO_LISTENER="audioListener",n.POSITIONAL_AUDIO="positionalAudio",n.SCENE="scene",n))(_0||{});const n8={edgesColor:[.1,.7,.2]};function r8(n){return class extends n{constructor(){super(...arguments),this.CADLinearTolerance=A.FLOAT(.1,{range:[.001,1],rangeLocked:[!0,!1]}),this.CADAngularTolerance=A.FLOAT(.1,{range:[.001,1],rangeLocked:[!0,!1]}),this.CADCurveAbscissa=A.FLOAT(.1,{range:[.001,1],rangeLocked:[!0,!1]}),this.CADCurveTolerance=A.FLOAT(.1,{range:[.001,1],rangeLocked:[!0,!1]}),this.CADDisplayEdges=A.BOOLEAN(!0,{separatorBefore:!0}),this.CADEdgesColor=A.COLOR(n8.edgesColor,{visibleIf:{CADDisplayEdges:!0}}),this.CADDisplayMeshes=A.BOOLEAN(!0),this.CADMeshesColor=A.COLOR([1,1,1],{visibleIf:{CADDisplayMeshes:!0}}),this.CADWireframe=A.BOOLEAN(!1,{visibleIf:{CADDisplayMeshes:!0}})}}}const s8=new Set(["CADLinearTolerance","CADAngularTolerance","CADCurveAbscissa","CADCurveTolerance","CADDisplayEdges","CADEdgesColor","CADDisplayMeshes","CADMeshesColor","CADWireframe"]);function i8(n,e){n.params.onParamsCreated("CADtesselationParamsHooks",()=>{const t=n.params.all;for(const r of t)s8.has(r.name())&&r.options.setOption("callback",e)})}const tS={facetAngle:45,linesColor:[.4,.1,.6]};function o8(n){return class extends n{constructor(){super(...arguments),this.CSGFacetAngle=A.FLOAT(tS.facetAngle,{range:[0,180],rangeLocked:[!0,!1]}),this.CSGLinesColor=A.COLOR(tS.linesColor),this.CSGMeshesColor=A.COLOR([1,1,1]),this.CSGWireframe=A.BOOLEAN(!1)}}}const a8=new Set(["CSGFacetAngle","CSGLinesColor","CSGMeshesColor","CSGWireframe"]);function c8(n,e){n.params.onParamsCreated("CSGtesselationParamsHooks",()=>{const t=n.params.all;for(const r of t)a8.has(r.name())&&r.options.setOption("callback",e)})}function l8(n){return class extends n{constructor(){super(...arguments),this.QUADTriangles=A.BOOLEAN(!0),this.QUADWireframe=A.BOOLEAN(!0,{separatorBefore:!0}),this.QUADUnsharedEdges=A.BOOLEAN(!1,{visibleIf:{wireframe:!0}}),this.QUADWireframeColor=A.COLOR([0,0,0],{visibleIf:{QUADWireframe:!0}}),this.QUADConnections=A.BOOLEAN(!1,{separatorBefore:!0}),this.QUADConnectionsBetweenQuadsSharingEdge=A.BOOLEAN(!0,{visibleIf:{QuadConnections:!0}}),this.QUADConnectionsBetweenQuadsSharingPointOnly=A.BOOLEAN(!0,{visibleIf:{QuadConnections:!0}}),this.QUADConnectionsColor=A.COLOR([0,0,0],{visibleIf:{QuadConnections:!0}}),this.QUADCenter=A.BOOLEAN(!1,{separatorBefore:!0}),this.QUADInnerRadius=A.BOOLEAN(!1,{visibleIf:{QUADCenter:!0}}),this.QUADOuterRadius=A.BOOLEAN(!1,{visibleIf:{QUADCenter:!0}}),this.QUADEdgeCenterVectors=A.BOOLEAN(!1,{visibleIf:{QUADCenter:!0}}),this.QUADEdgeNearestPointVectors=A.BOOLEAN(!1,{visibleIf:{QUADCenter:!0}}),this.QUADSplitQuads=A.BOOLEAN(!1,{separatorBefore:!0,visibleIf:[{QUADTriangles:!0},{QUADWireframe:!0}]}),this.QUADPointAttributes=A.STRING("*",{visibleIf:[{QUADTriangles:!0}]}),this.QUADPrimitiveAttributes=A.STRING("*")}}}const u8=new Set(["QUADTriangles","QUADWireframe"]);function h8(n,e){n.params.onParamsCreated("QUADtesselationParamsHooks",()=>{const t=n.params.all;for(const r of t)u8.has(r.name())&&r.options.setOption("callback",e)})}const _i={scale:1,displayOuterMesh:!1,displayTetMesh:!0,displayLines:!1,displaySharedFaces:!1,displayPoints:!1,displayCenter:!1,displaySphere:!1};function d8(n){return class extends n{constructor(){super(...arguments),this.TetScale=A.FLOAT(_i.scale,{range:[0,1],rangeLocked:[!0,!0]}),this.TetDisplayOuterMesh=A.BOOLEAN(_i.displayOuterMesh),this.TetDisplayTetMesh=A.BOOLEAN(_i.displayTetMesh),this.TetDisplayLines=A.BOOLEAN(_i.displayLines),this.TetDisplaySharedFaces=A.BOOLEAN(_i.displaySharedFaces),this.TetDisplayPoints=A.BOOLEAN(_i.displayPoints),this.TetDisplayCenter=A.BOOLEAN(_i.displayCenter),this.TetDisplaySphere=A.BOOLEAN(_i.displaySphere)}}}const p8=new Set(["TetScale","TetDisplayMesh","TetDisplayLines","TetDisplaySharedFaces","TetDisplayPoints","TetDisplayCenter","TetDisplaySphere"]);function f8(n,e){n.params.onParamsCreated("TettesselationParamsHooks",()=>{const t=n.params.all;for(const r of t)p8.has(r.name())&&r.options.setOption("callback",e)})}function m8(n){return class extends n{constructor(){super(...arguments),this.CAD=A.FOLDER()}}}function _8(n){return class extends n{constructor(){super(...arguments),this.CSG=A.FOLDER()}}}function g8(n){return class extends n{constructor(){super(...arguments),this.QUAD=A.FOLDER()}}}function v8(n){return class extends n{constructor(){super(...arguments),this.TET=A.FOLDER()}}}function y8(n){return class extends d8(v8(l8(g8(o8(_8(r8(m8(n)))))))){}}function x8(n){return class extends n{constructor(){super(...arguments),this.display=A.BOOLEAN(1),this.renderOrder=A.INTEGER(0,{range:[0,10],rangeLocked:[!0,!1]})}}}class b8 extends y8(x8(_w(Et))){}const C8=new b8;class E8 extends Kq{constructor(){super(...arguments),this.paramsConfig=C8,this.hierarchyController=new m0(this),this.transformController=new f0(this),this.flags=new aW(this),this.childrenDisplayController=new t8(this),this.displayNodeController=new Qq(this,this.childrenDisplayController.displayNodeControllerCallbacks()),this._childrenControllerContext=be.SOP,this._onChildAddBound=this._onChildAdd.bind(this)}static type(){return _0.GEO}createObject(){const e=new lr;return e.matrixAutoUpdate=!1,e}initializeNode(){this.lifecycle.onChildAdd(this._onChildAddBound),this.hierarchyController.initializeNode(),this.transformController.initializeNode(),this.childrenDisplayController.initializeNode();const e=()=>{this.childrenDisplayController.requestDisplayNodeContainer()};i8(this,e),c8(this,e),h8(this,e),f8(this,e)}createNode(e,t){return super.createNode(e,t)}children(){return super.children()}nodesByType(e){return super.nodesByType(e)}_onChildAdd(e){var t,r;this.scene().loadingController.loaded()&&this.children().length==1&&((r=(t=e.flags)==null?void 0:t.display)==null||r.set(!0))}cook(){this.transformController.update(),this.object.visible=this.pv.display,this.object.renderOrder=this.pv.renderOrder,this.cookController.endCook()}}function g0(n,e,t){return yw(e.group,t||n.allCoreObjects()).map(r=>r.object(),e.invert)}function gw(n,e,t){return yw(e.group,t||n.allCoreObjects())}function vw(n,e){const t=n.trim();if(t.length==0||e.object.name==t||Qs(e.name(),t))return!0;const r=t.split("="),s=r[0];if(s[0]=="@"){const i=s.substring(1),o=r[1],a=e.attribValue(i);return o==a}return!1}function yw(n,e){if(n=n.trim(),n=="")return e;const t=parseInt(n);if(!av(t)){const s=e[t];return s?[s]:[]}const r=[];for(const s of e){let i=!1;const o=s.object();if(o){const a=gr.objectsByMask(n,o);for(const l of a){const u=l.parent,h=u?u.children.indexOf(l):0,d=Vs(l,h);r.push(d),i=!0}vw(n,s)&&!i&&r.push(s)}}return r}function S8(n,e){return g0(n,e,n.threejsCoreObjects())}function A8(n,e){return g0(n,{group:e.group})}class Qr{}Qr.filterObjects=g0;Qr.filterCoreObjects=gw;Qr.filterThreejsObjects=S8;Qr.isInGroup=vw;class zt extends rs{constructor(){super(...arguments),this.flags=new cW(this)}static context(){return be.SOP}dataType(){return Ev.THREEJS}initializeBaseNode(){this.flags.display.set(!1),this.flags.display.onUpdate(()=>{if(!this.flags.display.active())return;const e=this.parent();e&&e.displayNodeController&&e.displayNodeController.setDisplayNode(this)}),this.io.outputs.setHasOneOutput()}setCoreGroup(e){this._setContainer(e)}setObject(e){this._setContainerObjects([e])}setObjects(e){this._setContainerObjects(e)}setGeometry(e,t=Tt.MESH){const r=this.createObject(e,t);this._setContainerObjects(r?[r]:[])}setGeometries(e,t=Tt.MESH){const r=[];for(const s of e){const i=this.createObject(s,t);i&&r.push(i)}this._setContainerObjects(r)}_setContainerObjects(e){const t=this.containerController.container().coreContent()||new hc;t.setAllObjects(e),this._setContainer(t)}static createObject(e,t,r){return Ft.createObject(e,t,r)}createObject(e,t,r){return zt.createObject(e,t,r)}static createIndexIfNone(e){Ft.createIndexIfNone(e)}_createIndexIfNone(e){zt.createIndexIfNone(e)}}const T8=new Map;function M8(n,e){var t;return(t=T8.get(n.path()))==null?void 0:t.get(e)}function R8(n,e){const t=M8(n,e);t&&VT(t)}class Qd extends Fp{constructor(e,t,r,s){super(e,t,r),this._uniformName=s}toJSON(){return{type:this._type,name:this._name,defaultValue:this._defaultValue,uniformName:this._uniformName}}static fromJSON(e){return new Qd(e.type,e.name,e.defaultValue,e.uniformName)}uniformName(){return this._uniformName}_callback(e,t){Qd.callback(e,t.name())}static callback(e,t){R8(e,t)}}class Sd{constructor(e){this._elements=e,this.isPrimitiveArray=!0}elements(){return this._elements}clone(){return this._elements.map(e=>e)}}class bi{constructor(e){this._elements=e,this.isVectorArray=!0}elements(){return this._elements}clone(){return this._elements.map(e=>e.clone())}}function w8(n){return n instanceof Ht||n instanceof xe||n instanceof pr||n instanceof qe||n instanceof ar||n instanceof Qt||n instanceof ni||n instanceof vr||n instanceof W||n instanceof T||n instanceof We||n instanceof Sd||n instanceof bi?!0:(console.warn("not serializable",n),!1)}function O8(n){if(n instanceof Ht)return{type:"Box3",data:{min:n.min.toArray(),max:n.min.toArray()}};if(n instanceof xe)return{type:"Color",data:n.toArray()};if(n instanceof pr)return{type:"Euler",data:{rotation:n.toArray(),rotationOrder:n.order}};if(n instanceof qe)return{type:"Matrix4",data:n.toArray()};if(n instanceof ar)return{type:"Plane",data:{normal:n.normal.toArray(),constant:n.constant}};if(n instanceof Qt)return{type:"Quaternion",data:n.toArray()};if(n instanceof ni)return{type:"Ray",data:{origin:n.origin.toArray(),direction:n.direction.toArray()}};if(n instanceof vr)return{type:"Sphere",data:{center:n.center.toArray(),radius:n.radius}};if(n instanceof W)return{type:"Vector2",data:n.toArray()};if(n instanceof T)return{type:"Vector3",data:n.toArray()};if(n instanceof We)return{type:"Vector4",data:n.toArray()};if(n.isPrimitiveArray){const t=n.elements(),r=t[0];if(mr(r))return{type:"boolean[]",data:t.map(i=>i)};if(Ye(r))return{type:"number[]",data:t.map(i=>i)};if(Ke(r))return{type:"string[]",data:t.map(i=>i)}}if(n.isVectorArray){const t=n.elements(),r=t[0];if(r instanceof xe)return{type:"Color[]",data:t.map(i=>i.toArray())};if(r instanceof pr)return{type:"Euler[]",data:t.map(i=>({rotation:i.toArray(),rotationOrder:i.order}))};if(r instanceof qe)return{type:"Matrix4[]",data:t.map(i=>i.toArray())};if(r instanceof Qt)return{type:"Quaternion[]",data:t.map(i=>i.toArray())};if(r instanceof W)return{type:"Vector2[]",data:t.map(i=>i.toArray())};if(r instanceof T)return{type:"Vector3[]",data:t.map(i=>i.toArray())};if(r instanceof We)return{type:"Vector4[]",data:t.map(i=>i.toArray())};console.log("array variable serialization not implemeted",n,r)}return console.log("variable serialization not implemeted",n),{type:"Vector3",data:new T().toArray()}}function P8(n){const e=n.type;switch(e){case"Box3":{const t=n.data,r=new Ht;return r.min.set(t.min[0],t.min[1],t.min[2]),r.max.set(t.max[0],t.max[1],t.max[2]),r}case"Color":{const t=n.data,r=new xe;return r.r=t[0],r.g=t[1],r.b=t[2],r}case"Euler":{const t=n.data;return new pr(t.rotation[0],t.rotation[1],t.rotation[2],t.rotationOrder)}case"Matrix4":{const t=n.data,r=new qe;return r.set(...t),r}case"Plane":{const t=n.data,r=new ar;return r.normal.set(...t.normal),r.constant=t.constant,r}case"Quaternion":{const t=n.data,r=new Qt;return r.set(...t),r}case"Ray":{const t=n.data,r=new ni;return r.origin.set(...t.origin),r.direction.set(...t.direction),r}case"Sphere":{const t=n.data,r=new vr;return r.center.set(...t.center),r.radius=t.radius,r}case"Vector2":{const t=n.data,r=new W;return r.set(...t),r}case"Vector3":{const t=n.data,r=new T;return r.set(...t),r}case"Vector4":{const t=n.data,r=new We;return r.set(...t),r}case"boolean[]":{const r=[...n.data];return new Sd(r)}case"number[]":{const r=[...n.data];return new Sd(r)}case"string[]":{const r=[...n.data];return new Sd(r)}case"Color[]":{const r=n.data.map(i=>{const o=new xe;return o.r=i[0],o.g=i[1],o.b=i[2],o});return new bi(r)}case"Euler[]":{const r=n.data.map(i=>new pr(i.rotation[0],i.rotation[1],i.rotation[2],i.rotationOrder));return new bi(r)}case"Matrix4[]":{const r=n.data.map(i=>{const o=new qe;return o.set(...i),o});return new bi(r)}case"Quaternion[]":{const r=n.data.map(i=>{const o=new Qt;return o.set(...i),o});return new bi(r)}case"Vector2[]":{const r=n.data.map(i=>{const o=new W;return o.set(...i),o});return new bi(r)}case"Vector3[]":{const r=n.data.map(i=>{const o=new T;return o.set(...i),o});return new bi(r)}case"Vector4[]":{const r=n.data.map(i=>{const o=new We;return o.set(...i),o});return new bi(r)}}St.unreachable(e)}function N8(n){const{variableNames:e,variablesByName:t}=n,r=[];for(const s of e){const i=t[s];if(i!=null&&w8(i)){const o=O8(i);r.push(o)}}return r}function I8(n){const{variableNames:e,variables:t}=n,r={};let s=0;for(const i of e){const o=t[s],a=P8(o);r[i]=a,s++}return r}function D8(n,e){const{functionNames:t}=n,r={};for(const s of t){const i=ve.namedFunctionsRegister.getFunction(s,e);i&&(r[s]=i.func.bind(i))}return r}class L8 extends p0{constructor(e){super(e),this.node=e}async toData(){if(await this.node.compilationController.compileIfRequired(),!this.node.assemblerController())return;const t=this.node.compilationController.functionData();if(!t)return;const{functionBody:r,variableNames:s,functionNames:i,paramConfigs:o,eventDatas:a}=t;return{functionBody:r,variableNames:s,variables:N8(t),functionNames:i,serializedParamConfigs:o.map(l=>l.toJSON()),eventDatas:a}}load(e){if(this.node.assemblerController())return;const{functionBody:r,variableNames:s,functionNames:i,serializedParamConfigs:o,eventDatas:a}=e,c={functionBody:r,variableNames:s,variablesByName:I8(e),functionNames:i,functionsByName:D8(e,this.node),paramConfigs:o.map(l=>Qd.fromJSON(l)),eventDatas:a};this.node.compilationController.updateFromFunctionData(c)}}class F8 extends zt{constructor(){super(...arguments),this._childrenControllerContext=be.JS,this.persisted_config=new L8(this),this._assemblerController=this._createAssemblerController(),this.compilationController=new q5(this)}createNode(e,t){return super.createNode(e,t)}children(){return super.children()}nodesByType(e){return super.nodesByType(e)}childrenAllowed(){return this.assemblerController()?super.childrenAllowed():!1}sceneReadonly(){return this.assemblerController()==null}assemblerController(){return this._assemblerController}usedAssembler(){return Rp.JS_ACTOR}_createAssemblerController(){return ve.assemblersRegister.assembler(this,this.usedAssembler())}compile(){this.compilationController.compile()}functionData(){return this.compilationController.functionData()}updateObjectOnRemove(e,t){this.compilationController.evaluatorGenerator().disposeEvaluator(e)}}class U8 extends Et{constructor(){super(...arguments),this.group=A.STRING("",{objectMask:!0}),this.useThisNode=A.BOOLEAN(1,{separatorAfter:!0}),this.node=A.NODE_PATH("",{visibleIf:{useThisNode:0},nodeSelection:{types:[Ac.ACTOR]},dependentOnFoundNode:!1,separatorAfter:!0})}}const k8=new U8;class B8 extends F8{constructor(){super(...arguments),this.paramsConfig=k8}static type(){return rn.ACTOR}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(Mt.FROM_NODE)}async cook(e){this.compilationController.compileIfRequired();const t=e[0],r=A8(t,this.pv),s=await this._findActorNode();if(s){const i=this.scene().actorsManager;for(const o of r)i.assignActorBuilder(o,s)}this.setCoreGroup(t)}async _findActorNode(){if(this.pv.useThisNode)return this;{const e=this.pv.node.node();return e&&await e.compute(),e}}}const nS={near:.1,far:100};var et=(n=>(n.NODE_ID="_Camera_nodeGeneratorId__",n.CONTROLS_NODE_ID="_Camera_controlsNodeId",n.CSS_RENDERER_NODE_ID="_Camera_CSSRendererNodeId",n.FRAME_MODE="_Camera_frameMode",n.FRAME_MODE_EXPECTED_ASPECT_RATIO="_Camera_frameModeExpectedAspectRatio",n.MAX_FPS="maxFPS",n.MAX_FPS_DYNAMIC_CHANGE="_Camera_maxFPSDynamicChange",n.VIEW_OFFSET_MIN="_Camera_viewOffsetMin",n.VIEW_OFFSET_MAX="_Camera_viewOffsetMax",n.POST_PROCESS_NODE_ID="_Camera_postProcessNodeId",n.RENDER_SCENE_NODE_ID="_Camera_renderSceneNodeId",n.RENDERER_NODE_ID="_Camera_rendererNodeId",n.VIEWER_ID="_Camera_viewerId",n.VIEWER_HTML="_Camera_viewerHTML",n.WEBXR_AR="_Camera_WebXR_AR",n.WEBXR_VR="_Camera_WebXR_VR",n.WEBXR_AR_FEATURES_OPTIONAL="_Camera_WebXR_AR_Features_Optional",n.WEBXR_AR_FEATURES_REQUIRED="_Camera_WebXR_AR_Features_Required",n.WEBXR_AR_OVERRIDE_REFERENCE_SPACE_TYPE="_Camera_WebXR_AR_overrideReferenceSpaceType",n.WEBXR_AR_REFERENCE_SPACE_TYPE="_Camera_WebXR_AR_referenceSpaceType",n.WEBXR_VR_FEATURES_OPTIONAL="_Camera_WebXR_VR_Features_Optional",n.WEBXR_VR_FEATURES_REQUIRED="_Camera_WebXR_VR_Features_Required",n.WEBXR_VR_OVERRIDE_REFERENCE_SPACE_TYPE="_Camera_WebXR_VR_overrideReferenceSpaceType",n.WEBXR_VR_REFERENCE_SPACE_TYPE="_Camera_WebXR_VR_referenceSpaceType",n.WEBXR_AR_MARKER_TRACKING="_Camera_WebXR_AR_markerTracking",n.WEBXR_AR_MARKER_TRACKING_SOURCE_MODE="_Camera_WebXR_AR_markerTracking_sourceMode",n.WEBXR_AR_MARKER_TRACKING_SOURCE_URL="_Camera_WebXR_AR_markerTracking_sourceUrl",n.WEBXR_AR_MARKER_TRACKING_BAR_CODE_TYPE="_Camera_WebXR_AR_markerTracking_barCodeType",n.WEBXR_AR_MARKER_TRACKING_BAR_CODE_VALUE="_Camera_WebXR_AR_markerTracking_barCodeValue",n.WEBXR_AR_MARKER_TRACKING_TRANSFORM_MODE="_Camera_WebXR_AR_markerTracking_transformMode",n.WEBXR_AR_MARKER_TRACKING_SMOOTH="_Camera_WebXR_AR_markerTracking_smooth",n.WEBXR_AR_MARKER_TRACKING_SMOOTH_COUNT="_Camera_WebXR_AR_markerTracking_smoothCount",n))(et||{}),v0=(n=>(n.FOV="_PerspectiveCamera_fov",n))(v0||{});const xw=class extends Ft{static type(){return zo.CONTROLS}cook(n,e){const t=n[0],r=Qr.filterObjects(t,{group:e.group});return this._node&&xw.updateObject({objects:r,params:e,node:this._node,active:!0,errorIfNodeNotFound:!0}),t}static updateObject(n){const{objects:e,params:t,node:r,active:s,errorIfNodeNotFound:i}=n,o=t.node.path(),a=r.node(o);if(a&&s){const c=a.graphNodeId();for(let l of e)Gt.addAttribute(l,et.CONTROLS_NODE_ID,c)}else{for(let c of e)Gt.deleteAttribute(c,et.CONTROLS_NODE_ID);i&&r.states.error.set("controls node not found")}}};let ep=xw;ep.DEFAULT_PARAMS={group:"",node:new Zr("")};ep.INPUT_CLONED_STATE=Mt.FROM_NODE;class G8 extends qV{constructor(){super(...arguments),this.node=A.NODE_PATH("",{nodeSelection:{context:be.EVENT},dependentOnFoundNode:!0})}}const V8=new G8;class z8 extends zt{constructor(){super(...arguments),this.paramsConfig=V8,this._childrenControllerContext=be.EVENT}static type(){return zo.CONTROLS}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(ep.INPUT_CLONED_STATE)}cook(e){this._operation=this._operation||new ep(this._scene,this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}createNode(e,t){return super.createNode(e,t)}children(){return super.children()}nodesByType(e){return super.nodesByType(e)}}const el=new T;function Tr(n,e,t,r,s,i){const o=2*Math.PI*s/4,a=Math.max(i-2*s,0),c=Math.PI/4;el.copy(e),el[r]=0,el.normalize();const l=.5*o/(o+a),u=1-el.angleTo(n)/c;return Math.sign(el[t])===1?u*l:a/(o+a)+l+l*(1-u)}class H8 extends vc{constructor(e=1,t=1,r=1,s=2,i=.1){if(s=s*2+1,i=Math.min(e/2,t/2,r/2,i),super(1,1,1,s,s,s),s===1)return;const o=this.toNonIndexed();this.index=null,this.attributes.position=o.attributes.position,this.attributes.normal=o.attributes.normal,this.attributes.uv=o.attributes.uv;const a=new T,c=new T,l=new T(e,t,r).divideScalar(2).subScalar(i),u=this.attributes.position.array,h=this.attributes.normal.array,d=this.attributes.uv.array,p=u.length/6,_=new T,g=.5/s;for(let f=0,m=0;f<u.length;f+=3,m+=2)switch(a.fromArray(u,f),c.copy(a),c.x-=Math.sign(c.x)*g,c.y-=Math.sign(c.y)*g,c.z-=Math.sign(c.z)*g,c.normalize(),u[f+0]=l.x*Math.sign(a.x)+c.x*i,u[f+1]=l.y*Math.sign(a.y)+c.y*i,u[f+2]=l.z*Math.sign(a.z)+c.z*i,h[f+0]=c.x,h[f+1]=c.y,h[f+2]=c.z,Math.floor(f/p)){case 0:_.set(1,0,0),d[m+0]=Tr(_,c,"z","y",i,r),d[m+1]=1-Tr(_,c,"y","z",i,t);break;case 1:_.set(-1,0,0),d[m+0]=1-Tr(_,c,"z","y",i,r),d[m+1]=1-Tr(_,c,"y","z",i,t);break;case 2:_.set(0,1,0),d[m+0]=1-Tr(_,c,"x","z",i,e),d[m+1]=Tr(_,c,"z","x",i,r);break;case 3:_.set(0,-1,0),d[m+0]=1-Tr(_,c,"x","z",i,e),d[m+1]=1-Tr(_,c,"z","x",i,r);break;case 4:_.set(0,0,1),d[m+0]=1-Tr(_,c,"x","y",i,e),d[m+1]=1-Tr(_,c,"y","x",i,t);break;case 5:_.set(0,0,-1),d[m+0]=Tr(_,c,"x","y",i,e),d[m+1]=1-Tr(_,c,"y","x",i,t);break}}}function j8(n){const{radius:e,height:t,divisions:r,center:s}=n,i=2*e,o=e,a=i,c=t,l=new H8(a,c+i,a,r,o);return l.translate(s.x,s.y,s.z),l}class y0 extends Ft{static type(){return"capsule"}cook(e,t){return this.createCoreGroupFromGeometry(j8(t))}}y0.DEFAULT_PARAMS={radius:.2,height:.6,divisions:2,center:new T(0,0,0)};const Kh=y0.DEFAULT_PARAMS;class W8 extends Et{constructor(){super(...arguments),this.radius=A.FLOAT(Kh.radius,{range:[0,1],rangeLocked:[!0,!1]}),this.height=A.FLOAT(Kh.height,{range:[0,2],rangeLocked:[!0,!1]}),this.divisions=A.INTEGER(Kh.divisions,{range:[1,10],rangeLocked:[!0,!1]}),this.center=A.VECTOR3(Kh.center)}}const X8=new W8;class $8 extends zt{constructor(){super(...arguments),this.paramsConfig=X8}static type(){return rn.CAPSULE}initializeNode(){this.io.inputs.setCount(0)}cook(e){this._operation=this._operation||new y0(this._scene,this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}}var tp=(n=>(n.OBJECT="ClothIdAttribute_object",n))(tp||{}),nu=(n=>(n.VISCOSITY="viscosity",n.SPRING="spring",n))(nu||{});const rS=new W,sS=new T,iS=new We;let Ad=class{constructor(e,t,r){this.positionAttribute=e,this.index=t,this.originalPosition=new T,this.snappedPosition=new T,this.originalPosition.fromBufferAttribute(e,this.index),K8(e,this.index,this.snappedPosition,r),this.snappedKey=`${this.snappedPosition.x}:${this.snappedPosition.y}:${this.snappedPosition.z}`}addAttribValue(e,t,r){const s=e.getAttribute(t);switch(s.itemSize){case 1:{const i=s.getX(this.index);r.push(i);break}case 2:{rS.fromBufferAttribute(s,this.index),rS.toArray(r,r.length);break}case 3:{sS.fromBufferAttribute(s,this.index),sS.toArray(r,r.length);break}case 4:{iS.fromBufferAttribute(s,this.index),iS.toArray(r,r.length);break}}}};class q8{constructor(e,t,r){this.a=e,this.b=t,this.c=r}}function Y8(n,e){e.set(0,0,0),n.forEach(t=>{e.add(t.originalPosition)}),e.divideScalar(n.size)}function K8(n,e,t,r){t.fromBufferAttribute(n,e),r>0&&(t.x=Math.round(t.x/r)*r,t.y=Math.round(t.y/r)*r,t.z=Math.round(t.z/r)*r)}function Z8(n){return n.a.snappedKey==n.b.snappedKey||n.a.snappedKey==n.c.snappedKey||n.b.snappedKey==n.c.snappedKey}const Pm=new Lt(new Float32Array(0),0),Zh=[new Ad(Pm,0,.1),new Ad(Pm,0,.1),new Ad(Pm,0,.1)];function J8(n,e){const t=n.getIndex();if(!t)return;const r=t.array,s=n.getAttribute("position"),i=s.count,o=r.length/3,a=new Array(i),c=new Array(o),l=new Map,u=new Map,h=new Map,d=new Map,p=[],_=[],g={},f=Object.keys(n.attributes).filter(b=>b!="position"),m=f.length;for(let b=0;b<m;b++){const x=f[b];g[x]=[]}for(let b=0;b<i;b++){const x=new Ad(s,b,e);a[b]=x,fr(l,x.snappedKey,x),u.has(x.snappedKey)||u.set(x.snappedKey,x)}l.forEach((b,x)=>{const E=new T;Y8(b,E),h.set(x,E)});for(let b=0;b<o;b++){const x=a[r[b*3]],E=a[r[b*3+1]],S=a[r[b*3+2]],R=new q8(x,E,S);c[b]=R}const y=c.filter(b=>!Z8(b)),v=y.length;for(let b=0;b<v;b++){const x=y[b];Zh[0]=x.a,Zh[1]=x.b,Zh[2]=x.c;for(let E=0;E<3;E++){const S=Zh[E];let R=d.get(S.snappedKey);const C=h.get(S.snappedKey);if(R==null){R=p.length/3,d.set(S.snappedKey,R),C.toArray(p,p.length);const M=u.get(S.snappedKey);for(let G=0;G<m;G++){const F=f[G];M.addAttribValue(n,F,g[F])}}_.push(R)}}n.setAttribute("position",new Lt(new Float32Array(p),3));for(let b=0;b<m;b++){const x=f[b],E=n.getAttribute(x),S=g[x];n.setAttribute(x,new Lt(new Float32Array(S),E.itemSize))}n.setIndex(_)}const So=new W,Ua=new W,Q8=new T,eY=new We;function tY(n){switch(n){case 2:return Ua;case 3:return Q8;case 4:return eY}}const oS=new Jt;function Xp(n){return oS.geometry=n,Su(oS)}function x0(n,e){const t=Xp(n),r=ZT(Math.sqrt(t));e.x=r,e.y=r}function nY(n,e){x0(n,So);const t=Xp(n),r=So.x,s=So.y,i=r*s*4,o=new Float32Array(i);let a=0;for(let l of e){l=Dt.remapName(l);const u=n.getAttribute(l);if(u){const h=u.itemSize,d=u.array;if(h==1)for(let p=0;p<t;p++)o[p*4+a]=d[p];else{const p=tY(h);if(!p)return;for(let _=0;_<t;_++)p.fromArray(d,_*h),p.toArray(o,_*4+a)}a+=h}}const c=new xc(o,r,s,fn,jn);return c.minFilter=c.magFilter=jt,c.wrapS=c.wrapT=Nd,c.needsUpdate=!0,c}function rY(n){const t=Xp(n);x0(n,So);const r=2,s=new Array(t*r);for(let o=0;o<t;o++)Ua.x=o%So.x,Ua.y=Math.floor(o/So.x),Ua.addScalar(.5),Ua.divide(So),Ua.toArray(s,o*r);const i=new Float32Array(s);n.setAttribute("attribLookupUv",new Lt(i,2))}function sY(n){const e=Xp(n),t=1,r=new Array(e*t);for(let i=0;i<e;i++)r[i]=i;const s=new Float32Array(r);n.setAttribute("attribLookupId",new Lt(s,t))}const aS=new T;function bw(n,e){return`${n}${e}`}function iY(n,e){const t=n.attributes.position;if(!(t instanceof Lt)){console.warn("position is not a BufferAttribute");return}for(let r=0,s=t.count;r<s;r++)aS.fromBufferAttribute(t,r),e.push(aS.clone())}function oY(n,e){const t=n.index;if(!t){console.warn("no index");return}const r=e.length,s=t.count/3,i=Array.from({length:r},()=>new Array);for(let o=0,a=s;o<a;o++){const c=o*3,l=t.getX(c+0),u=t.getX(c+1),h=t.getX(c+2),d={a:l,b:u,c:h};i[l].push(d),i[u].push(d),i[h].push(d)}return i}const Nm=new Map,Im=new Set;function aY(n){Nm.clear(),Im.clear();for(const a of n)Nm.set(a[0],a),Im.add(a[1]);let e=0,t=0;for(const a of n){if(!Im.has(a[0])){e=t;break}t++}const r=n.length,s=new Array(r).fill(-1),i=new Array;let o=n[e];for(let a=0;a<r&&(s[a]=o[0],o=Nm.get(o[1]),!!o);a++);for(let a=0;a<r;a+=2)i.push([s[a],s[a+1]]);return i}const tl=new Set,cS=[];function cY(n,e){const t=Array.from({length:e.length},()=>new Array);for(let r=0;r<n.length;r++){const s=n[r];s.length==0&&console.warn(`point ${r} has no face`),tl.clear();for(const i of s)switch(r){case i.a:{tl.add([i.b,i.c]);break}case i.b:{tl.add([i.c,i.a]);break}case i.c:{tl.add([i.a,i.b]);break}}rr(tl,cS),t[r]=aY(cS)}return t}const Cw={adjacencyCountName:"adjacencyCount",adjacencyBaseName:"adjacency"};function lY(n,e){const{adjacencyCountName:t,adjacencyBaseName:r}=e,s=n.geometry;if(!s)return;const i=s.attributes.position;if(!(i instanceof Lt)){console.warn("position is not a BufferAttribute");return}if(!s.index){console.warn("no index");return}const a=[];iY(s,a);const c=oY(s,a);if(!c)return;const l=cY(c,a);let u=-1;for(const g of l)g.length>u&&(u=g.length);const h=2,d=Math.ceil(u);Gt.addAttribute(n,t,u);const p=i.count;(()=>{for(let g=0;g<d;g++){const f=bw(r,g),m=new Array(p*h).fill(-1);for(let v=0;v<p;v++){const b=l[v][g];if(b)for(let x=0;x<h;x++){const E=b[x];m[v*h+x]=E??-1}}const y=new Float32Array(m);s.setAttribute(f,new Lt(y,h))}})(),rY(s),sY(s)}function uY(n,e){var t;const{adjacencyCountName:r,adjacencyBaseName:s}=e,i=n.geometry;if(!i)return[];const o=(t=i.index)==null?void 0:t.array;if(!o)return[];const a=o.length,c=[],l=Gt.attribValue(n,r,0);for(let u=0;u<a;u++){const h=o[u];for(let d=0;d<l;d++){const p=bw(s,d),g=i.getAttribute(p).array;let f=c[h];f||(f=[],c[h]=f);const m=g[h*2],y=g[h*2+1];f.includes(m)||f.push(m),f.includes(y)||f.push(y)}}return c}class hY extends Et{constructor(){super(...arguments),this.fuseDist=A.FLOAT(.001),this.viscosity=A.FLOAT(.1,{range:[0,1],rangeLocked:[!0,!1],expression:{forEntities:!0}}),this.spring=A.FLOAT(2,{range:[0,5],rangeLocked:[!0,!1],expression:{forEntities:!0}})}}const dY=new hY;class pY extends zt{constructor(){super(...arguments),this.paramsConfig=dY}static type(){return rn.CLOTH_PREPARE}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(Mt.FROM_NODE)}async cook(e){const t=e[0],r=t.threejsObjectsWithGeo();for(const s of r){if(!s.geometry)return;this._applyFuse(s),this._addIdAttribute(s),this._addViscosityAttribute(s),this._addSpringAttribute(s),this._addAdjacencyAttributes(s)}this.setCoreGroup(t)}_applyFuse(e){J8(e.geometry,this.pv.fuseDist)}async _addIdAttribute(e){const t=e.geometry,r=t.getAttribute(vt.POSITION);if(!r)return;const s=r.count,i=new Array(s);for(let a=0;a<s;a++)i[a]=a;const o=new Float32Array(i);t.setAttribute(vt.ID,new Lt(o,1))}async _addViscosityAttribute(e){await this._addFloatAttribute(e,this.p.viscosity,nu.VISCOSITY)}async _addSpringAttribute(e){await this._addFloatAttribute(e,this.p.spring,nu.SPRING)}async _addFloatAttribute(e,t,r){const s=Os(e);if(t.hasExpression()&&t.expressionController){s.hasAttribute(e,r)||s.addNumericAttribute(e,r,1,t.value);const i=s.attribute(e,r);i.needsUpdate=!0;const o=i.array,a=[];$d(e,a),await t.expressionController.computeExpressionForPoints(a,(c,l)=>{o[c.index()]=l})}else s.addNumericAttribute(e,r,1,t.value)}_addAdjacencyAttributes(e){lY(e,Cw)}}const b0=`// get vec2 tex coordinate from index
vec2 getClothSolverUV( float id, vec2 textureSize ) { 

	vec2 coords = vec2(
		floor( mod( ( id + 0.5 ), textureSize.x ) ),
		floor( ( id + 0.5 ) / textureSize.x )
	) + 0.5;

	return coords / textureSize;

}
`,C0=`// pack float16 position into float32
vec3 packPosition( vec2 uv ) {

	return ( texture2D( tPosition0, uv ).xyz + texture2D( tPosition1, uv ).xyz ) / 1024.0;

}`,Ru=`
vec3 unpackPosition( vec3 pos, float order ) {

	pos *= 1024.0;

	return ( order > 0.0 ) ? floor( pos ) : fract( pos );

}

vec4 unpackPosition( vec4 pos, float order ) {

	pos *= 1024.0;

	return ( order > 0.0 ) ? floor( pos ) : fract( pos );

}`,fY=`precision highp float;

attribute vec2 position;

void main() {

	gl_Position = vec4( position, vec2(1.0) );

}
`,mY=`precision highp float;
precision highp sampler2D;

uniform vec2 tSize;
uniform float order;
uniform sampler2D texture;

// *** ADD COMMON ***

void main() {

	vec2 uv = gl_FragCoord.xy / tSize.xy;

	gl_FragColor = unpackPosition( texture2D( texture, uv ), order );

}
`,_Y=`precision highp float;
precision highp sampler2D;

uniform vec2 tSize;
uniform float order;
uniform float constraintInfluence;
uniform sampler2D tPosition0;
uniform sampler2D tPosition1;

uniform sampler2D tDistancesA;
uniform sampler2D tDistancesB;

uniform sampler2D tAdjacentsA;
uniform sampler2D tAdjacentsB;



// compute offset based on current distance and spring rest distance
vec3 getDisplacement( vec3 point0, vec3 point1, float restDistance ) {

	float curDistance = distance( point0, point1 );
	return constraintInfluence * ( curDistance - restDistance ) * ( point1 - point0 ) / curDistance;

}

// *** ADD COMMON ***

vec2 getUV( float id ) {
	return getClothSolverUV( id, tSize );
}


void main() {

	vec3 displacement;
	vec2 uv = gl_FragCoord.xy / tSize.xy;

	// indices of adjacent vertices
	vec4 adjacentA = texture2D( tAdjacentsA, uv );
	vec4 adjacentB = texture2D( tAdjacentsB, uv );

	// distances of adjacent vertices
	vec4 distancesA = texture2D( tDistancesA, uv );
	vec4 distancesB = texture2D( tDistancesB, uv );

	// vertex position
	vec3 p0 = packPosition( uv );
	float count = 0.0;

	// adjacent vertices positions
	float Ax = adjacentA.x;
	if( Ax >= 0.0 ){
		vec3 p1 = packPosition( getUV( Ax ) );
		displacement += getDisplacement( p0, p1, distancesA.x );
		count += 1.0;
	}
	float Ay = adjacentA.y;
	if( Ay >= 0.0 ){
		vec3 p2 = packPosition( getUV( adjacentA.y ) );
		displacement += getDisplacement( p0, p2, distancesA.y );
		count += 1.0;
	}
	float Az = adjacentA.z;
	if( Az >= 0.0 ){
		vec3 p3 = packPosition( getUV( adjacentA.z ) );
		displacement += getDisplacement( p0, p3, distancesA.z );
		count += 1.0;
	}
	float Aw = adjacentA.w;
	if( Aw >= 0.0 ){
		vec3 p4 = packPosition( getUV( adjacentA.w ) );
		displacement += getDisplacement( p0, p4, distancesA.w );
		count += 1.0;
	}

	float Bx = adjacentB.x;
	if( Bx >= 0.0 ){
		vec3 p5 = packPosition( getUV( Bx ) );
		displacement += getDisplacement( p0, p5, distancesB.x );
		count += 1.0;
	}
	float By = adjacentB.y;
	if( By >= 0.0 ){
		vec3 p6 = packPosition( getUV( By ) );
		displacement += getDisplacement( p0, p6, distancesB.y );
		count += 1.0;
	}
	float Bz = adjacentB.z;
	if( Bz >= 0.0 ){
		vec3 p7 = packPosition( getUV( Bz ) );
		displacement += getDisplacement( p0, p7, distancesB.z );
		count += 1.0;
	}
	float Bw = adjacentB.w;
	if( Bw >= 0.0 ){
		vec3 p8 = packPosition( getUV( Bw ) );
		displacement += getDisplacement( p0, p8, distancesB.w );
		count += 1.0;
	}

	p0 += displacement / count;

	gl_FragColor = vec4( unpackPosition( p0, order ), 1.0 );

}
`,gY=`precision highp float;
precision highp sampler2D;

uniform float vertex;
uniform vec3 coordinates;

uniform vec2 tSize;
uniform float order;
uniform sampler2D tPosition0;
uniform sampler2D tPosition1;
uniform sampler2D tOriginal;

// *** ADD COMMON ***

vec2 getUV( float id ) {
	return getClothSolverUV( id, tSize );
}

void main() {

	vec2 uv = gl_FragCoord.xy / tSize.xy;

	vec3 position = packPosition( uv );
	vec3 original = texture2D( tOriginal, uv ).xyz;

	vec3 ref, diff, proj, offset;

	if ( vertex != - 1.0 ){

		ref = texture2D( tOriginal, getUV( vertex ) ).xyz;
		offset = coordinates - ref;

		if ( distance( original, ref ) <= 0.1 ) {

			diff = ref - original;

			proj = dot( diff, offset ) / dot( offset, offset ) * original;

			position = original + proj + offset;

		}
	}

	gl_FragColor = vec4( unpackPosition( position, order ), 1.0 );

}
`,vY=`precision highp float;
precision highp sampler2D;

uniform vec2 tSize;

uniform sampler2D tPosition0;
uniform sampler2D tPosition1;

uniform sampler2D tAdjacentsA;
uniform sampler2D tAdjacentsB;

// *** ADD COMMON ***

vec2 getUV( float id ) { 
	return getClothSolverUV( id, tSize );
}

void main () {

	vec3 normal;
	vec2 uv = gl_FragCoord.xy / tSize.xy;

	// indices of adjacent vertices
	vec4 adjacentA = texture2D( tAdjacentsA, uv );
	vec4 adjacentB = texture2D( tAdjacentsB, uv );

	// vertex position
	vec3 p0 = ( texture2D( tPosition0, uv ).xyz + texture2D( tPosition1, uv ).xyz ) / 1024.0;

	// adjacent vertices positions
	vec3 p1 = packPosition( getUV( adjacentA.x ) );
	vec3 p2 = packPosition( getUV( adjacentA.y ) );
	vec3 p3 = packPosition( getUV( adjacentA.z ) );
	vec3 p4 = packPosition( getUV( adjacentA.w ) );

	// compute vertex normal contribution
	normal += cross( p1 - p0, p2 - p0 );
	normal += cross( p2 - p0, p3 - p0 );
	normal += cross( p3 - p0, p4 - p0 );

	float Bx = adjacentB.x;
	vec3 p5 = Bx >= 0.0 ? packPosition( getUV( Bx ) ) : vec3(0.0);
	if( Bx >= 0.0 ){
		normal += cross( p4 - p0, p5 - p0 );
	}
	float By = adjacentB.y;
	vec3 p6 = By >= 0.0 ? packPosition( getUV( By ) ) : vec3(0.0);
	if( By >= 0.0 ){
		normal += cross( p5 - p0, p6 - p0 );
	}
	float Bz = adjacentB.z;
	vec3 p7 = Bz >= 0.0 ? packPosition( getUV( Bz ) ) : vec3(0.0);
	if( Bz >= 0.0 ){
		normal += cross( p6 - p0, p7 - p0 );
	}
	float Bw = adjacentB.w;
	vec3 p8 = Bw >= 0.0 ? packPosition( getUV( Bw ) ) : vec3(0.0);
	if( Bw >= 0.0 ){
		normal += cross( p7 - p0, p8 - p0 );
	}

	gl_FragColor = vec4( normalize( normal ), 1.0 );
}`,yY=`
`,xY="// *** ADD COMMON ***";function wu(n,e){const t=e.join(yY);return n.replace(xY,t)}const bY=wu(mY,[Ru]),CY=wu(_Y,[b0,C0,Ru]),EY=wu(gY,[b0,C0,Ru]),SY=wu(vY,[b0,C0,Ru]);function nl(){return new Zg({uniforms:{order:{value:null},tSize:{value:new W},texture:{value:null}},vertexShader:fY,fragmentShader:bY,fog:!1,lights:!1,depthWrite:!1,depthTest:!1})}class AY{constructor(e){this.mainController=e,this.copyShader=nl(),this.integrateShader=nl(),this.mouseShader=nl(),this.constraintsShader=nl(),this.normalsShader=nl();const t=this.mainController.integrationFragmentShader();if(!t)throw"no integrationFragmentShader";this.integrateShader.fragmentShader=wu(t,[Ru]),this.integrateShader.uniforms={timeDelta:this.mainController.scene.timeController.timeDeltaUniform(),time:this.mainController.scene.timeController.timeUniform(),viscosity:{value:.1},spring:{value:1},tSize:{value:new W},order:{value:-1},tOriginal:{value:null},tPrevious0:{value:null},tPrevious1:{value:null},tPosition0:{value:null},tPosition1:{value:null},tViscositySpring:{value:null}},this.mainController.addMaterialUniforms(this.integrateShader),this.mouseShader.fragmentShader=EY,this.mouseShader.uniforms={time:this.mainController.scene.timeController.timeUniform(),vertex:{value:-1},coordinates:{value:new T},order:{value:-1},tSize:{value:new W},tOriginal:{value:null},tPosition0:{value:null},tPosition1:{value:null}},this.constraintsShader.fragmentShader=CY,this.constraintsShader.uniforms={time:this.mainController.scene.timeController.timeUniform(),tSize:{value:new W},order:{value:-1},constraintInfluence:{value:0},tPosition0:{value:null},tPosition1:{value:null},tAdjacentsA:{value:null},tAdjacentsB:{value:null},tDistancesA:{value:null},tDistancesB:{value:null},secondaryMotionMult:{value:0}},this.normalsShader.fragmentShader=SY,this.normalsShader.uniforms={tSize:{value:new W},tPosition0:{value:null},tPosition1:{value:null},tAdjacentsA:{value:null},tAdjacentsB:{value:null}}}}class TY{constructor(e){this.mesh=e,this.adjacency=[],this.resolution=new W,this.geometry=e.geometry,Pv.assignDefaultBVHIfNone(this.mesh),this.adjacency=uY(this.mesh,Cw),x0(this.geometry,this.resolution)}}const np=new T,lS=new T;function MY(n,e){const t=new Float32Array(e.x*e.y*4),r=n.getAttribute(vt.POSITION),s=r.array,i=r.count;for(let a=0;a<i;a++){np.fromArray(s,a*3);const c=a*4;np.toArray(t,c)}const o=new xc(t,e.x,e.y,fn,jn);return o.needsUpdate=!0,o}function RY(n,e,t,r){const s=new Float32Array(e.x*e.y*4),o=n.getAttribute(vt.POSITION).count;for(let c=0;c<o;c++){const l=c*4,u=t[c];for(let h=0;h<4;h++){const d=u[r*4+h];d!=null?s[l+h]=d:s[l+h]=-1}}const a=new xc(s,e.x,e.y,fn,jn);return a.needsUpdate=!0,a}function wY(n,e,t,r){const s=new Float32Array(e.x*e.y*4).fill(-1),i=n.getAttribute(vt.POSITION),o=i.count,a=i.array;for(let l=0;l<o;l++){np.fromArray(a,l*3);const u=l*4,h=t[l],d=h.length-1;for(let p=0;p<4;p++)if(d<r*4+p)s[u+p]=-1;else{const _=h[r*4+p];if(_<0)s[u+p]=-1;else{lS.fromArray(a,_*3);const g=np.distanceTo(lS);s[u+p]=g,g<1e-4&&console.log("bad dist")}}}const c=new xc(s,e.x,e.y,fn,jn);return c.needsUpdate=!0,c}function OY(n,e){return nY(n,[nu.VISCOSITY,nu.SPRING])}function PY(n,e,t){const r={},i=n.getAttribute(vt.POSITION).count;return t.readonlyAllocations().forEach(o=>{var a;const c=new Float32Array(e.x*e.y*4),l=new xc(c,e.x,e.y,fn,jn);r[o.textureName()]=l;let u=0;(a=o.variables())==null||a.forEach(h=>{const d=h.name(),p=h.size(),_=n.getAttribute(d);if(_){const g=_.array;for(let f=0;f<i;f++){const m=f*4+u;for(let y=0;y<p;y++)c[m+y]=g[f*p+y]}l.needsUpdate=!0}u+=p})}),r}function Ma(n,e){n.texture&&(e.value=n.texture)}class NY{constructor(e){this.mainController=e,this.tSize=new W,this.fboScene=new gu,this.fboCamera=new kg,this.RESOLUTION=new W,this.originalRT={texture:null},this.viscositySpringT={texture:null},this.previousRT=new Array(2),this.targetRT=new Array(2),this.positionRT=new Array(2),this.adjacentsRT=new Array(2),this.distancesRT=new Array(2),this._initialized=!1,this.RESOLUTION.copy(this.mainController.geometryInit.resolution),this.tSize.set(this.RESOLUTION.x,this.RESOLUTION.y);const t=new sn,r=new Float32Array([-1,-1,3,-1,-1,3]);t.setAttribute("position",new Lt(r,2)),t.boundingSphere=new vr(new T(0,0,0),5),this.fboMesh=new Jt(t,this.mainController.materials.copyShader),this.fboMesh.frustumCulled=!1,this.fboScene.add(this.fboMesh),this.fboScene.updateMatrixWorld=function(){},this.normalsRT=Jh(this.RESOLUTION)}init(e){if(this._initialized)return;this._initialized=!0,this.renderer=e;const t=e.getRenderTarget();this.createPositionTexture(),this.createViscositySpringTexture(),this.createTexturesFromAllocation();for(let r=0;r<2;r++)this.createAdjacentsTexture(r),this.createDistancesTexture(r),this.positionRT[r]=Jh(this.RESOLUTION),this.previousRT[r]=Jh(this.RESOLUTION),this.targetRT[r]=Jh(this.RESOLUTION),this.copyTexture(this.originalRT,this.positionRT[r],!r,e),this.copyTexture(this.originalRT,this.previousRT[r],!r,e);e.setRenderTarget(t)}copyTexture(e,t,r,s){const i=this.mainController.materials.copyShader;this.fboMesh.material=i,i.uniforms.order.value=r?1:-1,i.uniforms.tSize.value=this.tSize,i.uniforms.texture.value=e.texture,s.setRenderTarget(t),s.render(this.fboScene,this.fboCamera)}createPositionTexture(){this.originalRT={texture:MY(this.mainController.geometryInit.geometry,this.RESOLUTION)}}createViscositySpringTexture(){const e=OY(this.mainController.geometryInit.geometry,this.RESOLUTION);e&&(this.viscositySpringT={texture:e})}createTexturesFromAllocation(){const e=this.mainController.textureAllocationsController();if(!e)return;const t=PY(this.mainController.geometryInit.geometry,this.RESOLUTION,e);this.mainController.assignReadonlyTextures(this.mainController.materials.integrateShader,t)}createAdjacentsTexture(e){this.adjacentsRT[e]={texture:RY(this.mainController.geometryInit.geometry,this.RESOLUTION,this.mainController.geometryInit.adjacency,e)}}createDistancesTexture(e){this.distancesRT[e]={texture:wY(this.mainController.geometryInit.geometry,this.RESOLUTION,this.mainController.geometryInit.adjacency,e)}}update(e){const t=this.renderer;if(!(t&&this._initialized))return;const r=t.getRenderTarget();this.integrate(t);const s=this.mainController.selectedVertexIndex(),i=this.mainController.stepsCount;for(let o=0;o<i;o++)s>=0&&o<i-5&&this.mouseOffset(t),this.solveConstraints(t,o==i-1?1:0);this.computeVertexNormals(t),t.setRenderTarget(r),e&&this._updateTextureRefs(e)}_updateTextureRefs(e){e.tSize.value=this.mainController.fbo.tSize,e.tPosition0.value=this.positionRT[0].texture,e.tPosition1.value=this.positionRT[1].texture,e.tNormal.value=this.normalsRT.texture,Ma(this.originalRT,e.tOriginalRT),Ma(this.viscositySpringT,e.tViscositySpringT),e.tPreviousRT0.value=this.previousRT[0].texture,e.tPreviousRT1.value=this.previousRT[1].texture,e.tTargetRT0.value=this.targetRT[0].texture,e.tTargetRT1.value=this.targetRT[1].texture,e.tNormalsRT.value=this.normalsRT.texture,e.tPositionRT0.value=this.positionRT[0].texture,e.tPositionRT1.value=this.positionRT[1].texture,Ma(this.adjacentsRT[0],e.tAdjacentsRT0),Ma(this.adjacentsRT[1],e.tAdjacentsRT1),Ma(this.distancesRT[0],e.tDistanceRT0),Ma(this.distancesRT[1],e.tDistanceRT1),e.integrationMat.value=this.mainController.materials.integrateShader}integrate(e){const t=this.mainController.materials.integrateShader;this.fboMesh.material=t,t.uniforms.viscosity.value=this.mainController.viscosity,t.uniforms.spring.value=this.mainController.spring,t.uniforms.tSize.value.copy(this.tSize),t.uniforms.tOriginal.value=this.originalRT.texture,t.uniforms.tPrevious0.value=this.previousRT[0].texture,t.uniforms.tPrevious1.value=this.previousRT[1].texture,t.uniforms.tPosition0.value=this.positionRT[0].texture,t.uniforms.tPosition1.value=this.positionRT[1].texture,t.uniforms.tViscositySpring.value=this.viscositySpringT.texture,t.uniforms.order.value=1,e.setRenderTarget(this.targetRT[0]),e.render(this.fboScene,this.fboCamera),t.uniforms.order.value=-1,e.setRenderTarget(this.targetRT[1]),e.render(this.fboScene,this.fboCamera);let r=this.previousRT[0];this.previousRT[0]=this.positionRT[0],this.positionRT[0]=this.targetRT[0],this.targetRT[0]=r,r=this.previousRT[1],this.previousRT[1]=this.positionRT[1],this.positionRT[1]=this.targetRT[1],this.targetRT[1]=r}solveConstraints(e,t){const r=this.mainController.materials.constraintsShader;this.fboMesh.material=r,r.uniforms.constraintInfluence.value=this.mainController.constraintInfluence,r.uniforms.tSize.value.copy(this.tSize),r.uniforms.tPosition0.value=this.positionRT[0].texture,r.uniforms.tPosition1.value=this.positionRT[1].texture,r.uniforms.tAdjacentsA.value=this.adjacentsRT[0].texture,r.uniforms.tAdjacentsB.value=this.adjacentsRT[1].texture,r.uniforms.tDistancesA.value=this.distancesRT[0].texture,r.uniforms.tDistancesB.value=this.distancesRT[1].texture,r.uniforms.secondaryMotionMult.value=t,r.uniforms.order.value=1,e.setRenderTarget(this.targetRT[0]),e.render(this.fboScene,this.fboCamera),r.uniforms.order.value=-1,e.setRenderTarget(this.targetRT[1]),e.render(this.fboScene,this.fboCamera);let s=this.positionRT[0];this.positionRT[0]=this.targetRT[0],this.targetRT[0]=s,s=this.positionRT[1],this.positionRT[1]=this.targetRT[1],this.targetRT[1]=s}mouseOffset(e){const t=this.mainController.materials.mouseShader;this.fboMesh.material=t,t.uniforms.tSize.value.copy(this.tSize),t.uniforms.vertex.value=this.mainController.selectedVertexIndex(),this.mainController.constraintPosition(t.uniforms.coordinates.value),t.uniforms.tOriginal.value=this.originalRT.texture,t.uniforms.tPosition0.value=this.positionRT[0].texture,t.uniforms.tPosition1.value=this.positionRT[1].texture,t.uniforms.order.value=1,e.setRenderTarget(this.targetRT[0]),e.render(this.fboScene,this.fboCamera),t.uniforms.order.value=-1,e.setRenderTarget(this.targetRT[1]),e.render(this.fboScene,this.fboCamera);let r=this.positionRT[0];this.positionRT[0]=this.targetRT[0],this.targetRT[0]=r,r=this.positionRT[1],this.positionRT[1]=this.targetRT[1],this.targetRT[1]=r}computeVertexNormals(e){const t=this.mainController.materials.normalsShader;this.fboMesh.material=t,t.uniforms.tSize.value.copy(this.tSize),t.uniforms.tPosition0.value=this.positionRT[0].texture,t.uniforms.tPosition1.value=this.positionRT[1].texture,t.uniforms.tAdjacentsA.value=this.adjacentsRT[0].texture,t.uniforms.tAdjacentsB.value=this.adjacentsRT[1].texture,e.setRenderTarget(this.normalsRT),e.render(this.fboScene,this.fboCamera)}}function Jh(n){return new Br(n.x,n.y,{wrapS:cr,wrapT:cr,minFilter:jt,magFilter:jt,format:fn,type:tc,depthBuffer:!1,stencilBuffer:!1})}class IY{constructor(e,t,r){this.scene=e,this._node=t,this.clothObject=r,this.stepsCount=40,this.constraintInfluence=.1,this.viscosity=.1,this.spring=1,this._selectedVertexIndex=-1,this._selectedVertexPosition=new T,this._node.initCoreClothControllerFromPersistedConfig(this),this.materials=new AY(this),this.geometryInit=new TY(this.clothObject),this.fbo=new NY(this)}dispose(){this._persistedTextureAllocationsController&&(this._persistedTextureAllocationsController.dispose(),this._persistedTextureAllocationsController=void 0)}setPersistedTextureAllocationController(e){this._persistedTextureAllocationsController=e}integrationFragmentShader(){let e;return this._node.shadersByName().forEach((t,r)=>{e=t}),e}textureAllocationsController(){var e;return((e=this._node.assemblerController())==null?void 0:e.assembler.textureAllocationsController())||this._persistedTextureAllocationsController}assignReadonlyTextures(e,t){const r=Object.keys(t);for(const s of r){const i=t[s],o=s;e.uniforms[o]={value:i}}}addMaterialUniforms(e){var t;const r=this._node,s=(t=r.assemblerController())==null?void 0:t.assembler;if(s)for(const i of s.param_configs())e.uniforms[i.uniformName()]=i.uniform();else{const i=r.persisted_config.loaded_data();if(i){const o=r.persisted_config.uniforms();if(o){const a=i.param_uniform_pairs;for(const c of a){const l=c[0],u=c[1],h=r.params.get(l),d=o[u];if(e.uniforms[u]=d,h&&d){const p=()=>{bo.callback(h,e.uniforms[u])};h.options.setOption("callback",p),p()}}}}}}init(e){this.fbo.init(e)}update(e){this.fbo.update(e)}_setSelectedVertexIndex(e){e==null?this._selectedVertexIndex=-1:this._selectedVertexIndex=e}createConstraint(e){this._setSelectedVertexIndex(e)}deleteConstraint(){this._setSelectedVertexIndex(null)}selectedVertexIndex(){return this._selectedVertexIndex}setConstraintPosition(e){this._selectedVertexPosition.copy(e)}constraintPosition(e){e.copy(this._selectedVertexPosition)}}const dg=new Map;function DY(n,e,t){let r=dg.get(t.uuid);if(!r){if(!(t instanceof Jt))return;r=new IY(n,e,t),dg.set(t.uuid,r)}return{controller:r}}function LY(n){return Ut(n).attribValue(n,tp.OBJECT)}function $p(n){return dg.get(n.uuid)}var ys=(n=>(n.ADJACENT_POINTS_ATTRIB_SMOOTH="adjacentPointsAttribSmooth",n.ADJACENT_UV_ATTRIB_SMOOTH="adjacentUvAttribSmooth",n.ATTRIBUTE="attribute",n.COMPUTE_NORMALS="computeNormals",n.CONSTANT="constant",n.FOR_LOOP="forLoop",n.IF_THEN="ifThen",n.GLOBALS="globals",n.NOISE="noise",n.OUTPUT="output",n.PARAM="param",n.RAMP="ramp",n.SDF_2D_BOX="SDF2DBox",n.SDF_2D_CIRCLE="SDF2DCircle",n.SDF_2D_CROSS="SDF2DCross",n.SDF_2D_HEART="SDF2DHeart",n.SDF_2D_ROUNDED_X="SDF2DRoundedX",n.SDF_2D_STAIRS="SDF2DStairs",n.SDF_BOX="SDFBox",n.SDF_BOX_FRAME="SDFBoxFrame",n.SDF_BOX_ROUND="SDFBoxRound",n.SDF_CAPSULE="SDFCapsule",n.SDF_CAPSULE_VERTICAL="SDFCapsuleVertical",n.SDF_CONE="SDFCone",n.SDF_CONE_ROUND="SDFConeRound",n.SDF_ELONGATE="SDFElongate",n.SDF_FRACTAL_MANDELBROT="SDFFractalMandelbrot",n.SDF_GRADIENT="SDFGradient",n.SDF_HEXAGONAL_PRISM="SDFHexagonalPrism",n.SDF_HORSE_SHOE="SDFHorseShoe",n.SDF_LINK="SDFLink",n.SDF_OCTAHEDRON="SDFOctahedron",n.SDF_OCTOGONAL_PRISM="SDFOctogonalPrism",n.SDF_ONION="SDFOnion",n.SDF_PLANE="SDFPlane",n.SDF_PYRAMID="SDFPyramid",n.SDF_QUAD="SDFQuad",n.SDF_REPEAT_POLAR="SDFRepeatPolar",n.SDF_REVOLUTION="SDFRevolution",n.SDF_RHOMBUS="SDFRhombus",n.SDF_RHOMBUS_TRIACONTAHEDRON="SDFRhombusTriacontahedron",n.SDF_SOLID_ANGLE="SDFSolidAngle",n.SDF_SPHERE="SDFSphere",n.SDF_SPHERE_CUT="SDFSphereCut",n.SDF_SPHERE_HOLLOW="SDFSphereHollow",n.SDF_TORUS="SDFTorus",n.SDF_TRANSFORM="SDFTransform",n.SDF_TRIANGULAR_PRISM="SDFTriangularPrism",n.SDF_TRIANGLE="SDFTriangle",n.SDF_TUBE="SDFTube",n.SDF_TWIST="SDFTwist",n.SDF_CONTEXT="SDFContext",n.SDF_MATERIAL="SDFMaterial",n.TEXTURE="texture",n.TEXTURE_DISPLACEMENT="textureDisplacement",n.TEXTURE_SDF="textureSDF",n.VARYING_READ="varyingRead",n.VARYING_WRITE="varyingWrite",n.VERTEX_ANIMATION_TEXTURE="vertexAnimationTexture",n.VERTEX_ANIMATION_TEXTURE_INTERPOLATED="vertexAnimationTextureInterpolated",n))(ys||{});class Ti{constructor(e,t){if(this._name=e,this._size=t,this._position=-1,this._readonly=!1,!e)throw"TextureVariable requires a name"}merge(e){var t;e.readonly()||this.setReadonly(!1),(t=e.graphNodeIds())==null||t.forEach(r=>{this.addGraphNodeId(r)})}setReadonly(e){this._readonly=e}readonly(){return this._readonly}setAllocation(e){this._allocation=e}allocation(){return this._allocation}graphNodeIds(){return this._graphNodeIds}addGraphNodeId(e){this._graphNodeIds=this._graphNodeIds||new Set,this._graphNodeIds.add(e)}name(){return this._name}size(){return this._size}setPosition(e){this._position=e}position(){return this._position}component(){return"xyzw".split("").splice(this._position,this._size).join("")}static fromJSON(e){return new Ti(e.name,e.size)}toJSON(e){const t=[];return this._graphNodeIds&&this._graphNodeIds.forEach(r=>{const s=e.graph.nodeFromId(r);if(s){const i=s.path();i&&t.push(i)}}),{name:this.name(),size:this.size(),nodes:t}}}class FY{constructor(e){this.node=e,this._initialized=!1,this._checkParamsEditableStateBound=this._checkParamsEditableState.bind(this)}initializeNode(){if(this._initialized){console.warn("already initialized",this.node);return}this._initialized=!0,this.node.io.inputs.add_on_set_input_hook("_checkParamsEditableStateBound",this._checkParamsEditableStateBound)}initialized(){return this._initialized}_checkParamsEditableState(){this._paramsMatchEditableState()||this.updateParamsEditableStateIfNeeded()}_paramsMatchEditableState(){let e=0;const t=this.node.params,r=this.node.io.inputs.namedInputConnectionPoints();if(!r)return!1;for(const s of r){if(s){const i=this.node.io.inputs.input(e)!=null,o=s==null?void 0:s.name();if(t.has(o)){const c=t.get(o);if(c){const l=!i,u=c.options.editable();if(l!=u)return!1}}}e++}return!0}updateParamsEditableStateIfNeeded(){let e=0;const t=this.node.params,r=this.node.io.inputs.namedInputConnectionPoints();if(r)for(const s of r){if(s){const i=this.node.io.inputs.input(e)!=null,o=s==null?void 0:s.name();if(t.has(o)){const a=t.get(o);if(a){const c=!i;a.options.setEditableState(c)}}}e++}}}const UY="v_POLY";class E0 extends rs{constructor(){super(...arguments),this._paramsEditableStatesController=new FY(this)}static context(){return be.GL}initializeBaseNode(){this.uiData.setLayoutHorizontal(),this.io.connections.initInputs(),this.io.connection_points.spare_params.initializeNode(),this._paramsEditableStatesController.initializeNode()}cook(){console.warn("gl node cooking")}_setMatToRecompile(){var e,t;(t=(e=this.materialNode())==null?void 0:e.assemblerController())==null||t.setCompilationRequiredAndDirty(this)}materialNode(){const e=this.parent();if(e)return e.context()==be.GL?e==null?void 0:e.materialNode():e}glVarName(e){const t=[this];let r=this;for(;r.parent()&&r.parent()!=this.materialNode();){const i=r.parent();i&&(t.unshift(i),r=i)}const s=t.map(i=>i._glVarNameBase());return`${UY}_${s.join("_")}_${e}`}_glVarNameBase(){return this.name()}variableForInputParam(e){return this.variableForInput(e.name())}variableForInput(e){var t;const r=this.io.inputs.getInputIndex(e),s=this.io.connections.inputConnection(r);if(s){const i=s.nodeSrc(),o=i.io.outputs.namedOutputConnectionPoints();if(o){const a=o[s.outputIndex()];if(a){const c=a.name();return i.glVarName(c)}else throw console.warn(`no output called '${e}' for gl node ${i.path()}`),"variable_for_input ERROR"}}else{if(this.params.has(e))return hg.any((t=this.params.get(e))==null?void 0:t.value);{const i=this.io.inputs.namedInputConnectionPoints();if(i){const o=i[r];return hg.any(o.init_value)}}}throw"variable_for_input ERROR"}setLines(e){}reset_code(){var e;(e=this._param_configs_controller)==null||e.reset()}setParamConfigs(){}param_configs(){var e;return(e=this._param_configs_controller)==null?void 0:e.list()}paramsGenerating(){return!1}paramDefaultValue(e){return null}}const Td=[xt.FLOAT,xt.VEC2,xt.VEC3,xt.VEC4];class kY extends Et{constructor(){super(...arguments),this.name=A.STRING("attribute1"),this.type=A.INTEGER(0,{menu:{entries:Td.map((e,t)=>({name:e,value:t}))}}),this.texportWhenConnected=A.BOOLEAN(0,{hidden:!0}),this.exportWhenConnected=A.BOOLEAN(0,{visibleIf:{texportWhenConnected:1}})}}const BY=new kY,_o=class extends E0{constructor(){super(...arguments),this.paramsConfig=BY,this._bound_setExportWhenConnectedStatus=this._setExportWhenConnectedStatus.bind(this)}static type(){return ys.ATTRIBUTE}initializeNode(){this.addPostDirtyHook("_setMatToRecompile",this._setMatToRecompileIfIsExporting.bind(this)),this.io.connection_points.initializeNode(),this.io.connection_points.set_expected_input_types_function(()=>{var n,e;return(e=(n=this.materialNode())==null?void 0:n.assemblerController())!=null&&e.allow_attribute_exports()?[Td[this.pv.type]]:[]}),this.io.connection_points.set_input_name_function(n=>_o.INPUT_NAME),this.io.connection_points.set_expected_output_types_function(()=>[Td[this.pv.type]]),this.lifecycle.onAfterAdded(this._bound_setExportWhenConnectedStatus),this.params.addOnSceneLoadHook("prepare params",this._bound_setExportWhenConnectedStatus)}_setExportWhenConnectedStatus(){var n,e;(e=(n=this.materialNode())==null?void 0:n.assemblerController())!=null&&e.allow_attribute_exports()&&this.p.texportWhenConnected.set(1)}setAttribSize(n){this.p.type.set(n-1)}inputName(){return _o.INPUT_NAME}outputName(){return _o.OUTPUT_NAME}varyingName(){return`v_POLY_attribute_${this.pv.name}`}setLines(n){n.assembler().setNodeLinesAttribute(this,n)}attributeName(){return this.pv.name.trim()}glType(){const n=this.io.outputs.namedOutputConnectionPoints();return n?n[0].type():xt.FLOAT}setGlType(n){this.p.type.set(Td.indexOf(n))}connected_input_node(){return this.io.inputs.named_input(_o.INPUT_NAME)}connected_input_connection_point(){return this.io.inputs.named_input_connection_point(_o.INPUT_NAME)}output_connection_point(){return this.io.outputs.namedOutputConnectionPointsByName(this.outputName())}isImporting(){return this.io.outputs.used_output_names().length>0}isExporting(){return this.pv.exportWhenConnected?this.io.inputs.named_input(_o.INPUT_NAME)!=null:!1}_setMatToRecompileIfIsExporting(){this.pv.exportWhenConnected&&this._setMatToRecompile()}};let pc=_o;pc.INPUT_NAME="in";pc.OUTPUT_NAME="val";const GY="texture_",VY="_x_";class wl{constructor(){this._size=0}addVariable(e){this._variables=this._variables||[],this._variables.push(e),e.setPosition(this._size),e.setAllocation(this),this._size+=e.size()}hasSpaceForVariable(e){return this._size+e.size()<=4}shaderName(){var e;return(((e=this.variables())==null?void 0:e.map(r=>r.name()))||["no_variables_allocated"]).join(VY)}textureName(){return`${GY}${this.shaderName()}`}variables(){return this._variables}variablesForInputNode(e){var t;return(t=this._variables)==null?void 0:t.filter(r=>{var s;return((s=r.graphNodeIds())==null?void 0:s.has(e.graphNodeId()))||!1})}inputNamesForNode(e){const t=this.variablesForInputNode(e);if(t)return e.type()==ys.ATTRIBUTE?[pc.INPUT_NAME]:t.map(r=>r.name())}variable(e){if(this._variables){for(const t of this._variables)if(t.name()==e)return t}}static fromJSON(e){const t=new wl;for(const r of e){const s=Ti.fromJSON(r);t.addVariable(s)}return t}toJSON(e){return this._variables?this._variables.map(t=>t.toJSON(e)):[]}}class zY extends Et{}const HY=new zY;class jY extends E0{constructor(){super(...arguments),this.paramsConfig=HY}static type(){return ys.GLOBALS}initializeNode(){super.initializeNode(),this.lifecycle.onAfterAdded(()=>{var e,t;(t=(e=this.materialNode())==null?void 0:e.assemblerController())==null||t.add_globals_outputs(this)})}setLines(e){e.assembler().set_node_lines_globals(this,e)}}class WY extends Et{}const XY=new WY;class Dm extends E0{constructor(){super(...arguments),this.paramsConfig=XY}static type(){return ys.OUTPUT}initializeNode(){super.initializeNode(),this.addPostDirtyHook("_setMatToRecompile",this._setMatToRecompile.bind(this)),this.lifecycle.onAfterAdded(()=>{var e,t;(t=(e=this.materialNode())==null?void 0:e.assemblerController())==null||t.add_output_inputs(this),this._setMatToRecompile()})}setLines(e){e.assembler().set_node_lines_output(this,e)}}const $Y=["position","normal","color","uv"];class Ol{constructor(){this._writableAllocations=[],this._readonlyAllocations=[]}dispose(){this._writableAllocations.splice(0,this._writableAllocations.length),this._readonlyAllocations.splice(0,this._readonlyAllocations.length)}static _sortNodes(e){const r=e.filter(a=>a.type()==Dm.type()),s=e.filter(a=>a.type()!=Dm.type()),i=s.map(a=>a.path()).sort(),o=new Map;for(const a of s)o.set(a.path(),a);for(const a of i){const c=o.get(a);c&&r.push(c)}return r}allocateConnectionsFromRootNodes(e,t){const r=[];e=Ol._sortNodes(e),t=Ol._sortNodes(t);for(const s of e){const i=s.graphNodeId();switch(s.type()){case Dm.type():{const o=s.io.inputs.namedInputConnectionPoints();if(o){for(const a of o)if(s.io.inputs.named_input(a.name())){const l=new Ti(a.name(),Jc[a.type()]);l.addGraphNodeId(i),r.push(l)}}break}case pc.type():{const o=s,a=o.connected_input_node(),c=o.connected_input_connection_point();if(a&&c){const l=new Ti(o.attributeName(),Jc[c.type()]);l.addGraphNodeId(i),r.push(l)}break}case ys.ADJACENT_POINTS_ATTRIB_SMOOTH:{const a=s.textureAllocationData();for(const c of a){const l=new Ti(c,Jc[xt.VEC2]);l.setReadonly(!0),l.addGraphNodeId(i),r.push(l)}break}}}for(const s of t){const i=s.graphNodeId();switch(s.type()){case jY.type():{const o=s;for(const a of o.io.outputs.used_output_names())if($Y.includes(a)){const l=o.io.outputs.namedOutputConnectionPointsByName(a);if(l){const u=l.type(),h=new Ti(a,Jc[u]);h.addGraphNodeId(i),r.push(h)}}break}case pc.type():{const o=s,a=o.output_connection_point();if(a){const c=new Ti(o.attributeName(),Jc[a.type()]);o.isExporting()||c.setReadonly(!0),c.addGraphNodeId(i),r.push(c)}break}}}this._allocateVariables(r)}_allocateVariables(e){const r=this._ensureVariablesAreUnique(e).sort((s,i)=>s.size()<i.size()?1:-1);for(const s of r)s.readonly()?this._allocateVariable(s,this._readonlyAllocations):this._allocateVariable(s,this._writableAllocations)}_ensureVariablesAreUnique(e){const t=new Map;for(const s of e)dr(t,s.name(),s);const r=[];return t.forEach((s,i)=>{const o=s[0];r.push(o);for(let a=1;a<s.length;a++){const c=s[a];o.merge(c)}}),r}_allocateVariable(e,t){let r=this.hasVariable(e.name());if(r)throw"no variable should be allocated since they have been made unique before";for(const s of t)!r&&s.hasSpaceForVariable(e)&&(s.addVariable(e),r=!0);if(!r){const s=new wl;t.push(s),s.addVariable(e)}}_addWritableAllocation(e){this._writableAllocations.push(e)}_addReadonlyAllocation(e){this._readonlyAllocations.push(e)}readonlyAllocations(){return this._readonlyAllocations}shaderNames(){const e=this._writableAllocations.map(r=>r.shaderName()),t=[];return Zs(e,t),t}createShaderConfigs(){return[]}allocationForShaderName(e){const t=this._writableAllocations.filter(r=>r.shaderName()==e)[0];return t||this._readonlyAllocations.filter(r=>r.shaderName()==e)[0]}inputNamesForShaderName(e,t){const r=this.allocationForShaderName(t);if(r)return r.inputNamesForNode(e)}variable(e){for(const t of this._writableAllocations){const r=t.variable(e);if(r)return r}for(const t of this._readonlyAllocations){const r=t.variable(e);if(r)return r}}variables(){const e=this._writableAllocations.map(r=>r.variables()||[]).flat(),t=this._writableAllocations.map(r=>r.variables()||[]).flat();return e.concat(t)}hasVariable(e){return this.variables().map(r=>r.name()).includes(e)}static fromJSON(e){const t=new Ol;for(const r of e.writable){const s=Object.keys(r)[0],i=r[s],o=wl.fromJSON(i);t._addWritableAllocation(o)}for(const r of e.readonly){const s=Object.keys(r)[0],i=r[s],o=wl.fromJSON(i);t._addReadonlyAllocation(o)}return t}toJSON(e){const t=this._writableAllocations.map(s=>({[s.shaderName()]:s.toJSON(e)})),r=this._readonlyAllocations.map(s=>({[s.shaderName()]:s.toJSON(e)}));return{writable:t,readonly:r}}print(e){console.warn(JSON.stringify(this.toJSON(e),[""],2))}}class qY extends p0{constructor(e){super(e),this.node=e}async toData(){const e=this.node.assemblerController();if(!e)return;const t={};this.node.shadersByName().forEach((u,h)=>{t[h]=u});const s=e.assembler.textureAllocationsController().toJSON(this.node.scene()),i=[],o=new Kn,a=e.assembler.param_configs();for(let u of a)i.push([u.name(),u.uniformName()]),o.uniforms[u.uniformName()]=u.uniform();const c=this._materialToJson(o,{node:this.node,suffix:"main"});return{texture_allocations:s,param_uniform_pairs:i,uniforms_owner:c||{},shaders:t}}load(e){this.node.assemblerController()||(this._loaded_data=e,this.node.init_with_persisted_config())}loaded_data(){return this._loaded_data}shaders_by_name(){if(this._loaded_data){const e=new Map,t=this._loaded_data.shaders;if(t){const r=Object.keys(t);for(let s of r)e.set(s,t[s])}return e}}texture_allocations_controller(){if(this._loaded_data)return Ol.fromJSON(this._loaded_data.texture_allocations)}uniforms(){if(this._loaded_data){const e=this._loadMaterial(this._loaded_data.uniforms_owner);return(e==null?void 0:e.uniforms)||{}}}}class Ew{handleGlobalsNode(e,t,r){}handleGlobalVar(e,t,r,s){}}class YY{constructor(e=[]){this._definitions=e,this._errored=!1}get errored(){return this._errored}get error_message(){return this._error_message}uniq(){const e=new Map,t=[];for(const s of this._definitions)if(!this._errored){const i=s.name(),o=e.get(i);o?o.data_type!=s.data_type&&(this._errored=!0,this._error_message=`attempt to create '${s.name()}' with types '${s.data_type}' by node '${s.node.path()}', when there is already an existing with type ${o.data_type} from node '${o.node.path()}'`,console.warn("emitting error message:",this._error_message)):(e.set(i,s),t.push(i))}const r=[];for(const s of t){const i=e.get(s);i&&r.push(i)}return r}}class S0{constructor(e,t,r,s){this._definition_type=e,this._data_type=t,this._node=r,this._name=s}get definition_type(){return this._definition_type}get data_type(){return this._data_type}get node(){return this._node}name(){return this._name}collection_instance(){return new YY}}class Sw extends S0{constructor(e,t,r){super("attribute",t,e,r),this._node=e,this._data_type=t,this._name=r}get line(){return`attribute ${this.data_type} ${this.name()}`}}class KY extends S0{constructor(e,t,r){super("uniform",t,e,r),this._node=e,this._data_type=t,this._name=r}get line(){return`uniform ${this.data_type} ${this.name()}`}}class pg extends S0{constructor(e,t,r){super("varying",t,e,r),this._node=e,this._data_type=t,this._name=r}get line(){return`varying ${this.data_type} ${this.name()}`}}var Hs=(n=>(n.VERTEX="vertex",n.FRAGMENT="fragment",n.LEAVES_FROM_NODES_SHADER="leaves_from_nodes_shader",n))(Hs||{}),fg=(n=>(n.TIME="time",n.RESOLUTION="resolution",n.MV_POSITION="mvPosition",n.GL_POSITION="gl_Position",n.GL_FRAGCOORD="gl_FragCoord",n.GL_POINTCOORD="gl_PointCoord",n.GL_POINTSIZE="gl_PointSize",n.WORLD_POSITION="worldPosition",n.WORLD_NORMAL="worldNormal",n.MODEL_MATRIX="modelMatrix",n.MODEL_VIEW_MATRIX="modelViewMatrix",n.NORMAL_MATRIX="normalMatrix",n))(fg||{}),A0=(n=>(n.GEOMETRY="geometry",n.TEXTURE="texture",n))(A0||{});const ZY={position:"vec3( position )"},dl=class extends Ew{type(){return A0.GEOMETRY}handleGlobalsNode(n,e,t){const r=n.io.outputs.namedOutputConnectionPointsByName(e);if(!r)return;const s=r.type();this.handleGlobalVar(n,e,s,t)}handleGlobalVar(n,e,t,r){var s,i;const o=n.glVarName(e),a=new pg(n,t,o);r.addDefinitions(n,[a]);const c=(i=(s=n.materialNode())==null?void 0:s.assemblerController())==null?void 0:i.assembler;if(!c)return;const l=c.shader_config(r.currentShaderName());if(!l)return;const u=l.dependencies(),h=[],d=`${o} = modelMatrix * vec4( position, 1.0 )`,p=`${o} = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal )`;switch(e){case fg.WORLD_POSITION:{h.push(d);break}case fg.WORLD_NORMAL:{h.push(p);break}default:h.push(`${o} = ${t}(${e})`)}for(const _ of u)r.addDefinitions(n,[a],_),r.addBodyLines(n,h,_);u.length==0&&r.addBodyLines(n,h)}static variable_config_default(n){return ZY[n]}variable_config_default(n){return dl.variable_config_default(n)}readAttribute(n,e,t,r){return dl.readAttribute(n,e,t,r)}static readAttribute(n,e,t,r){var s,i;dl.PRE_DEFINED_ATTRIBUTES.indexOf(t)<0&&r.addDefinitions(n,[new Sw(n,e,t)],Hs.VERTEX);const o=r.currentShaderName();switch(o){case Hs.VERTEX:return t;case Hs.FRAGMENT:{if(!(n instanceof pc))return;const c=n.varyingName(),l=new pg(n,e,c),u=new Map;u.set(Hs.FRAGMENT,[]);const h=new Map;h.set(Hs.FRAGMENT,[]),dr(u,o,l);const d=`${c} = ${e}(${t})`,p=(i=(s=n.materialNode())==null?void 0:s.assemblerController())==null?void 0:i.assembler.shader_config(o);if(p){const _=p.dependencies();for(const g of _)dr(u,g,l),dr(h,g,d);u.forEach((g,f)=>{r.addDefinitions(n,g,f)}),h.forEach((g,f)=>{r.addBodyLines(n,g,f)})}return c}}}handle_attribute_node(n,e,t,r){return dl.readAttribute(n,e,t,r)}};let ru=dl;ru.PRE_DEFINED_ATTRIBUTES=["position","color","normal","uv","uv2","morphTarget0","morphTarget1","morphTarget2","morphTarget3","skinIndex","skinWeight"];ru.IF_RULE={uv:"defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )"};var Aw=(n=>(n.PARTICLES_SHADER="particles_shader",n.MATERIAL="material",n))(Aw||{});const pl=class extends Ew{constructor(n,e){super(),this._uvName=n,this._purpose=e}type(){return A0.TEXTURE}set_texture_allocations_controller(n){this._textureAllocationsController=n}handleGlobalsNode(n,e,t){if(!this._textureAllocationsController)return;const r=n.io.outputs.namedOutputConnectionPointsByName(e),s=n.glVarName(e);if(this._textureAllocationsController.variable(e)&&r){const o=r.type(),a=this.readAttribute(n,o,e,t),c=`${o} ${s} = ${a}`;t.addBodyLines(n,[c])}else this._globalsGeometryHandler=this._globalsGeometryHandler||new ru,this._globalsGeometryHandler.handleGlobalsNode(n,e,t)}_textureVariableUsable(n){switch(this._purpose){case"particles_shader":return!0;case"material":return!n.readonly()}St.unreachable(this._purpose)}attribTextureData(n){if(!this._textureAllocationsController){console.warn("no texture allocation controller");return}const e=this._textureAllocationsController.variable(n);if(e&&this._textureVariableUsable(e)){const t=e.allocation();if(t){const r=e.component();return{textureName:t.textureName(),component:r,uvName:this._uvName}}}}readAttribute(n,e,t,r){if(!this._textureAllocationsController){console.warn("no texture allocation controller");return}const s=this._textureAllocationsController.variable(t);if(s&&this._textureVariableUsable(s)){this.addParticlesSimUvAttribute(n,r);const i=this.attribTextureData(t);if(i){const{textureName:o,component:a,uvName:c}=i,l=new KY(n,xt.SAMPLER_2D,o);return r.addDefinitions(n,[l]),`texture2D( ${o}, ${c} ).${a}`}}else return ru.readAttribute(n,e,t,r)}addParticlesSimUvAttribute(n,e){const t=new Sw(n,xt.VEC2,pl.PARTICLES_SIM_UV_ATTRIB),r=new pg(n,xt.VEC2,pl.UV_VARYING);e.addDefinitions(n,[t,r],Hs.VERTEX),e.addDefinitions(n,[r],Hs.FRAGMENT),e.addBodyLines(n,[`${pl.UV_VARYING} = ${pl.PARTICLES_SIM_UV_ATTRIB}`],Hs.VERTEX)}};let su=pl;su.PARTICLES_SIM_UV_ATTRIB="particlesSimUv";su.UV_VARYING="particlesSimUvVarying";su.PARTICLE_SIM_UV="particleUv";class JY{static findOutputNodes(e){return e.nodesByType(ys.OUTPUT)}static findParamGeneratingNodes(e){var t;const r=[];return(t=e.childrenController)==null||t.traverseChildren(s=>{const i=s;i.paramsGenerating()&&r.push(i)},s=>s.childrenController?s.context()==be.GL&&s.childrenController.context==be.GL:s.context()==be.GL),r}static findVaryingNodes(e){return e.nodesByType(ys.VARYING_WRITE)}static findAttributeExportNodes(e){return e.nodesByType(ys.ATTRIBUTE).filter(r=>r.isExporting())}static findAjacencyNodes(e){return e.nodesByType(ys.ADJACENT_POINTS_ATTRIB_SMOOTH)}}class QY extends Et{}const e7=new QY;class t7 extends zt{constructor(){super(...arguments),this.paramsConfig=e7,this._assemblerController=this._createAssemblerController(),this.persisted_config=new qY(this),this._globalsHandler=new su(su.PARTICLE_SIM_UV,Aw.PARTICLES_SHADER),this._shadersByName=new Map,this._childrenControllerContext=be.GL}static type(){return rn.CLOTH_SOLVER}assemblerController(){return this._assemblerController}usedAssembler(){return Rp.GL_CLOTH}_createAssemblerController(){return ve.assemblersRegister.assembler(this,this.usedAssembler())}shadersByName(){return this._shadersByName}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(Mt.ALWAYS)}createNode(e,t){return super.createNode(e,t)}children(){return super.children()}nodesByType(e){return super.nodesByType(e)}childrenAllowed(){return this.assemblerController()?super.childrenAllowed():!1}sceneReadonly(){return this.assemblerController()==null}async cook(e){this.compileIfRequired();const s=e[0].allObjects()[0],i=this.scene().actorsManager.objectActorNodeIds(s);(i==null||i.length==0)&&this.states.error.set("the input objects requires an actor node assigned to it"),Ut(s).addAttribute(s,tp.OBJECT,this.graphNodeId()),ve.onObjectsAddRemoveHooks.assignOnAddHookHandler(s,this),this.setObject(s)}updateObjectOnAdd(e){const t=Ut(e).attribValue(e,tp.OBJECT);if(t!=null){if(t!=this.graphNodeId())return;const r=e,s=DY(this.scene(),this,r);if(!s)return;const{controller:i}=s;this.scene().renderersRegister.waitForRenderer().then(o=>{if(!o){console.warn("no renderer");return}if(!(o instanceof bs)){console.warn("not a WebGLRenderer");return}i.init(o)})}}compileIfRequired(){var e;if((e=this.assemblerController())!=null&&e.compileRequired())try{this.run_assembler()}catch(t){const r=t.message||"failed to compile";this.states.error.set(r)}}run_assembler(){const e=this.assemblerController();if(!e)return;const t=this._findExportNodes();if(t.length>0){const s=t;e.setAssemblerGlobalsHandler(this._globalsHandler),e.assembler.set_root_nodes(s),e.assembler.compile(),e.post_compile()}const r=e.assembler.shaders_by_name();this._setShaderNames(r)}_setShaderNames(e){this._shadersByName=e}init_with_persisted_config(){const e=this.persisted_config.shaders_by_name(),t=this.persisted_config.texture_allocations_controller();e&&t&&this._setShaderNames(e)}initCoreClothControllerFromPersistedConfig(e){const t=this.persisted_config.shaders_by_name(),r=this.persisted_config.texture_allocations_controller();t&&r&&e.setPersistedTextureAllocationController(r)}_findExportNodes(){const e=[],t=JY.findOutputNodes(this);if(t.length==0&&this.states.error.set("one output node is required"),t.length>1)return this.states.error.set("only one output node is allowed"),[];const r=t[0];return r&&e.push(r),e}}function n7(n,e){const t=LY(n);if(t==null)return;const r=e.graph.nodeFromId(t);if(!r)return;const s=bp(r.context)?r:null;if(s&&s.context()==be.SOP&&s.type()==rn.CLOTH_SOLVER)return s}class r7 extends Ft{static type(){return"emptyObject"}cook(e,t){const r=this._createObjectFromType(t),s=[];if(r){const i=BM[t.type];i&&(r.material=i),Ft.applyObjectDefault(r),s.push(r)}return this.createCoreGroupFromObjects(s)}_createObjectFromType(e){switch(e.type){case Tt.GROUP:return new lr;case Tt.LINE_SEGMENTS:return new ic;case Tt.MESH:return new Jt;case Tt.OBJECT3D:return new wt;case Tt.POINTS:return new vl}}}const Tw=[Tt.OBJECT3D,Tt.GROUP,Tt.MESH,Tt.POINTS,Tt.LINE_SEGMENTS];class s7 extends Et{constructor(){super(...arguments),this.type=A.STRING(Tt.GROUP,{menuString:{entries:Tw.map((e,t)=>({name:e,value:e}))}})}}const i7=new s7;class o7 extends zt{constructor(){super(...arguments),this.paramsConfig=i7}static type(){return"emptyObject"}initializeNode(){this.io.inputs.setCount(0)}cook(e){this._operation=this._operation||new r7(this._scene,this.states,this);const t=this.pv.type,r=this._operation.cook(e,{type:t});this.setCoreGroup(r)}setObjectType(e){this.p.type.set(e)}objectType(){return Tw.includes(this.pv.type)?this.pv.type:void 0}}const a7="https://raw.githubusercontent.com/polygonjs/polygonjs-assets/master/",c7=/^[og]\s*(.+)?/,l7=/^mtllib /,u7=/^usemtl /,h7=/^usemap /,uS=/\s+/,hS=new T,Lm=new T,dS=new T,pS=new T,Mr=new T,Qh=new xe;function d7(){const n={objects:[],object:{},vertices:[],normals:[],colors:[],uvs:[],materials:{},materialLibraries:[],startObject:function(e,t){if(this.object&&this.object.fromDeclaration===!1){this.object.name=e,this.object.fromDeclaration=t!==!1;return}const r=this.object&&typeof this.object.currentMaterial=="function"?this.object.currentMaterial():void 0;if(this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0),this.object={name:e||"",fromDeclaration:t!==!1,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(s,i){const o=this._finalize(!1);o&&(o.inherited||o.groupCount<=0)&&this.materials.splice(o.index,1);const a={index:this.materials.length,name:s||"",mtllib:Array.isArray(i)&&i.length>0?i[i.length-1]:"",smooth:o!==void 0?o.smooth:this.smooth,groupStart:o!==void 0?o.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(c){const l={index:typeof c=="number"?c:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return l.clone=this.clone.bind(l),l}};return this.materials.push(a),a},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(s){const i=this.currentMaterial();if(i&&i.groupEnd===-1&&(i.groupEnd=this.geometry.vertices.length/3,i.groupCount=i.groupEnd-i.groupStart,i.inherited=!1),s&&this.materials.length>1)for(let o=this.materials.length-1;o>=0;o--)this.materials[o].groupCount<=0&&this.materials.splice(o,1);return s&&this.materials.length===0&&this.materials.push({name:"",smooth:this.smooth}),i}},r&&r.name&&typeof r.clone=="function"){const s=r.clone(0);s.inherited=!0,this.object.materials.push(s)}this.objects.push(this.object)},finalize:function(){this.object&&typeof this.object._finalize=="function"&&this.object._finalize(!0)},parseVertexIndex:function(e,t){const r=parseInt(e,10);return(r>=0?r-1:r+t/3)*3},parseNormalIndex:function(e,t){const r=parseInt(e,10);return(r>=0?r-1:r+t/3)*3},parseUVIndex:function(e,t){const r=parseInt(e,10);return(r>=0?r-1:r+t/2)*2},addVertex:function(e,t,r){const s=this.vertices,i=this.object.geometry.vertices;i.push(s[e+0],s[e+1],s[e+2]),i.push(s[t+0],s[t+1],s[t+2]),i.push(s[r+0],s[r+1],s[r+2])},addVertexPoint:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addVertexLine:function(e){const t=this.vertices;this.object.geometry.vertices.push(t[e+0],t[e+1],t[e+2])},addNormal:function(e,t,r){const s=this.normals,i=this.object.geometry.normals;i.push(s[e+0],s[e+1],s[e+2]),i.push(s[t+0],s[t+1],s[t+2]),i.push(s[r+0],s[r+1],s[r+2])},addFaceNormal:function(e,t,r){const s=this.vertices,i=this.object.geometry.normals;hS.fromArray(s,e),Lm.fromArray(s,t),dS.fromArray(s,r),Mr.subVectors(dS,Lm),pS.subVectors(hS,Lm),Mr.cross(pS),Mr.normalize(),i.push(Mr.x,Mr.y,Mr.z),i.push(Mr.x,Mr.y,Mr.z),i.push(Mr.x,Mr.y,Mr.z)},addColor:function(e,t,r){const s=this.colors,i=this.object.geometry.colors;s[e]!==void 0&&i.push(s[e+0],s[e+1],s[e+2]),s[t]!==void 0&&i.push(s[t+0],s[t+1],s[t+2]),s[r]!==void 0&&i.push(s[r+0],s[r+1],s[r+2])},addUV:function(e,t,r){const s=this.uvs,i=this.object.geometry.uvs;i.push(s[e+0],s[e+1]),i.push(s[t+0],s[t+1]),i.push(s[r+0],s[r+1])},addDefaultUV:function(){const e=this.object.geometry.uvs;e.push(0,0),e.push(0,0),e.push(0,0)},addUVLine:function(e){const t=this.uvs;this.object.geometry.uvs.push(t[e+0],t[e+1])},addFace:function(e,t,r,s,i,o,a,c,l){const u=this.vertices.length;let h=this.parseVertexIndex(e,u),d=this.parseVertexIndex(t,u),p=this.parseVertexIndex(r,u);if(this.addVertex(h,d,p),this.addColor(h,d,p),a!==void 0&&a!==""){const _=this.normals.length;h=this.parseNormalIndex(a,_),d=this.parseNormalIndex(c,_),p=this.parseNormalIndex(l,_),this.addNormal(h,d,p)}else this.addFaceNormal(h,d,p);if(s!==void 0&&s!==""){const _=this.uvs.length;h=this.parseUVIndex(s,_),d=this.parseUVIndex(i,_),p=this.parseUVIndex(o,_),this.addUV(h,d,p),this.object.geometry.hasUVIndices=!0}else this.addDefaultUV()},addPointGeometry:function(e){this.object.geometry.type="Points";const t=this.vertices.length;for(let r=0,s=e.length;r<s;r++){const i=this.parseVertexIndex(e[r],t);this.addVertexPoint(i),this.addColor(i)}},addLineGeometry:function(e,t){this.object.geometry.type="Line";const r=this.vertices.length,s=this.uvs.length;for(let i=0,o=e.length;i<o;i++)this.addVertexLine(this.parseVertexIndex(e[i],r));for(let i=0,o=t.length;i<o;i++)this.addUVLine(this.parseUVIndex(t[i],s))}};return n.startObject("",!1),n}class p7 extends ko{constructor(e){super(e),this.materials=null}load(e,t,r,s){const i=this,o=new vu(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(a){try{t(i.parse(a))}catch(c){s?s(c):console.error(c),i.manager.itemError(e)}},r,s)}setMaterials(e){return this.materials=e,this}parse(e){const t=new d7;e.indexOf(`\r
`)!==-1&&(e=e.replace(/\r\n/g,`
`)),e.indexOf(`\\
`)!==-1&&(e=e.replace(/\\\n/g,""));const r=e.split(`
`);let s=[];for(let a=0,c=r.length;a<c;a++){const l=r[a].trimStart();if(l.length===0)continue;const u=l.charAt(0);if(u!=="#")if(u==="v"){const h=l.split(uS);switch(h[0]){case"v":t.vertices.push(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3])),h.length>=7?(Qh.setRGB(parseFloat(h[4]),parseFloat(h[5]),parseFloat(h[6])).convertSRGBToLinear(),t.colors.push(Qh.r,Qh.g,Qh.b)):t.colors.push(void 0,void 0,void 0);break;case"vn":t.normals.push(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3]));break;case"vt":t.uvs.push(parseFloat(h[1]),parseFloat(h[2]));break}}else if(u==="f"){const d=l.slice(1).trim().split(uS),p=[];for(let g=0,f=d.length;g<f;g++){const m=d[g];if(m.length>0){const y=m.split("/");p.push(y)}}const _=p[0];for(let g=1,f=p.length-1;g<f;g++){const m=p[g],y=p[g+1];t.addFace(_[0],m[0],y[0],_[1],m[1],y[1],_[2],m[2],y[2])}}else if(u==="l"){const h=l.substring(1).trim().split(" ");let d=[];const p=[];if(l.indexOf("/")===-1)d=h;else for(let _=0,g=h.length;_<g;_++){const f=h[_].split("/");f[0]!==""&&d.push(f[0]),f[1]!==""&&p.push(f[1])}t.addLineGeometry(d,p)}else if(u==="p"){const d=l.slice(1).trim().split(" ");t.addPointGeometry(d)}else if((s=c7.exec(l))!==null){const h=(" "+s[0].slice(1).trim()).slice(1);t.startObject(h)}else if(u7.test(l))t.object.startMaterial(l.substring(7).trim(),t.materialLibraries);else if(l7.test(l))t.materialLibraries.push(l.substring(7).trim());else if(h7.test(l))console.warn('THREE.OBJLoader: Rendering identifier "usemap" not supported. Textures must be defined in MTL files.');else if(u==="s"){if(s=l.split(" "),s.length>1){const d=s[1].trim().toLowerCase();t.object.smooth=d!=="0"&&d!=="off"}else t.object.smooth=!0;const h=t.object.currentMaterial();h&&(h.smooth=t.object.smooth)}else{if(l==="\0")continue;console.warn('THREE.OBJLoader: Unexpected line: "'+l+'"')}}t.finalize();const i=new lr;if(i.materialLibraries=[].concat(t.materialLibraries),!(t.objects.length===1&&t.objects[0].geometry.vertices.length===0)===!0)for(let a=0,c=t.objects.length;a<c;a++){const l=t.objects[a],u=l.geometry,h=l.materials,d=u.type==="Line",p=u.type==="Points";let _=!1;if(u.vertices.length===0)continue;const g=new sn;g.setAttribute("position",new gt(u.vertices,3)),u.normals.length>0&&g.setAttribute("normal",new gt(u.normals,3)),u.colors.length>0&&(_=!0,g.setAttribute("color",new gt(u.colors,3))),u.hasUVIndices===!0&&g.setAttribute("uv",new gt(u.uvs,2));const f=[];for(let y=0,v=h.length;y<v;y++){const b=h[y],x=b.name+"_"+b.smooth+"_"+_;let E=t.materials[x];if(this.materials!==null){if(E=this.materials.create(b.name),d&&E&&!(E instanceof Cs)){const S=new Cs;gn.prototype.copy.call(S,E),S.color.copy(E.color),E=S}else if(p&&E&&!(E instanceof Pi)){const S=new Pi({size:10,sizeAttenuation:!1});gn.prototype.copy.call(S,E),S.color.copy(E.color),S.map=E.map,E=S}}E===void 0&&(d?E=new Cs:p?E=new Pi({size:1,sizeAttenuation:!1}):E=new Jg,E.name=b.name,E.flatShading=!b.smooth,E.vertexColors=_,t.materials[x]=E),f.push(E)}let m;if(f.length>1){for(let y=0,v=h.length;y<v;y++){const b=h[y];g.addGroup(b.groupStart,b.groupCount,y)}d?m=new ic(g,f):p?m=new vl(g,f):m=new Jt(g,f)}else d?m=new ic(g,f[0]):p?m=new vl(g,f[0]):m=new Jt(g,f[0]);m.name=l.name,i.add(m)}else if(t.vertices.length>0){const a=new Pi({size:1,sizeAttenuation:!1}),c=new sn;c.setAttribute("position",new gt(t.vertices,3)),t.colors.length>0&&t.colors[0]!==void 0&&(c.setAttribute("color",new gt(t.colors,3)),a.vertexColors=!0);const l=new vl(c,a);i.add(l)}return i}}function f7(n){const e=ve.assetUrls.remapedUrl(n);return e||n}function m7(){const n=new mT;return n.setURLModifier(f7),n}const Mw=m7(),mg=class{constructor(n,e,t={}){this._url=n,this._node=e,this.blobOptions=t,this.loadingManager=Mw,_t(this._url)?this._url=this._url.map(ud):this._url=ud(this._url)}static extension(n){let e=null;try{e=new URL(n).searchParams.get("ext")}catch{}if(!e){const r=n.split("?")[0].split(".");e=r[r.length-1].toLowerCase()}return e}extension(){return _t(this._url)?mg.extension(this._url[0]):mg.extension(this._url)}_urlToLoad(){const n=e=>{if(this._node){const t=this._node.scene().assets.root();e.startsWith("http")||(e=t?ud(`${t}/${e}`):e)}return e};return _t(this._url)?this._url.map(n):n(this._url)}static async _loadMultipleUrlsGlobal(n){const e=[];for(const r of n.files){const s=r.fullUrl,i=async()=>(await fetch(s)).ok?{}:{error:`failed to fetch '${s}'`};e.push(i())}const t=await Promise.all(e);if(n.node)for(const r of t)r.error&&n.node.states.error.set(n.error)}static onAssetLoaded(n){this._onAssetLoadedCallbacks=this._onAssetLoadedCallbacks||[],this._onAssetLoadedCallbacks.push(n)}static _runOnAssetLoadedCallbacks(n,e){if(this._onAssetLoadedCallbacks)for(const t of this._onAssetLoadedCallbacks)t(n,e)}};let qp=mg;qp.loadingManager=Mw;const T0=class extends qp{constructor(n,e){super(n.url,e),this._options=n,this._node=e}static setMaxConcurrentLoadsCount(n){this._maxConcurrentLoadsCountMethod=n}static _initMaxConcurrentLoadsCount(){return this._maxConcurrentLoadsCountMethod?this._maxConcurrentLoadsCountMethod():Do.isChrome()?4:1}static _initConcurrentLoadsDelay(){return Do.isChrome()?1:10}static incrementInProgressLoadsCount(){this._inProgressLoadsCount++}static decrementInProgressLoadsCount(n,e){this._inProgressLoadsCount--;const t=this._queue.pop();if(t){const r=this.CONCURRENT_LOADS_DELAY;setTimeout(()=>{t()},r)}this._runOnAssetLoadedCallbacks(n,e)}static async waitForMaxConcurrentLoadsQueueFreed(){if(!(this._inProgressLoadsCount<=this.MAX_CONCURRENT_LOADS_COUNT))return new Promise(n=>{this._queue.push(n)})}};let Fi=T0;Fi.MAX_CONCURRENT_LOADS_COUNT=T0._initMaxConcurrentLoadsCount();Fi.CONCURRENT_LOADS_DELAY=T0._initConcurrentLoadsDelay();Fi._inProgressLoadsCount=0;Fi._queue=[];class _7 extends qp{reset(){this._loader=void 0}async load(e){const t=await this._getLoader(e);if(!t){console.warn("no loader",this);return}const r=this._urlToLoad();return new Promise(async s=>{Fi.incrementInProgressLoadsCount(),await Fi.waitForMaxConcurrentLoadsQueueFreed(),t.load(r,i=>{Fi.decrementInProgressLoadsCount(r,i);const o=this._onLoadSuccess(i);ok(o)?o.then(a=>{s(a)}):s(o)},i=>{},i=>{var o;Fi.decrementInProgressLoadsCount(r);const a=this._errorMessage(r,i);(o=e.node)==null||o.states.error.set(a)})})}_errorMessage(e,t){return`could not load geometry from ${e} (Error: ${t.message})`}}class g7 extends _7{_onLoadSuccess(e){return e instanceof wt?[e]:[]}}class v7 extends g7{async _getLoader(){return this._loader=this._loader||await new p7(this.loadingManager)}}class Rw extends Ft{async cook(e,t){if(this._node){ve.blobs.clearBlobsForNode(this._node);const r=this._createGeoLoaderHandler(t),s=await this._load(r,t);if(s){const i=this._onLoad(s,t);return this.createCoreGroupFromObjects(i)}}return this.createCoreGroupFromObjects([])}async _load(e,t){if(this._node)return await e.load({node:this._node})}_onLoad(e,t){for(let r of e)r.traverse(s=>{this._ensureGeometryHasIndex(s),t.matrixAutoUpdate||s.updateMatrix(),s.matrixAutoUpdate=t.matrixAutoUpdate});return e}_ensureGeometryHasIndex(e){const r=e.geometry;r&&this.createIndexIfNone(r)}}Rw.DEFAULT_PARAMS={url:"",matrixAutoUpdate:!1};class ww extends Rw{static type(){return Rn.FILE_OBJ}_createGeoLoaderHandler(e){return new v7(e.url,this._node)}}ww.DEFAULT_PARAMS={url:ud(`${a7}/models/dolphin.obj`),matrixAutoUpdate:!1};function y7(n){const e=n.operation.DEFAULT_PARAMS;class t extends Et{constructor(){super(...arguments),this.url=A.STRING(e.url,{fileBrowse:{extensions:n.extensions}}),this.matrixAutoUpdate=A.BOOLEAN(e.matrixAutoUpdate),this.reload=A.BUTTON(null,{callback:o=>{s.PARAM_CALLBACK_reload(o)}})}}const r=new t;class s extends zt{constructor(){super(...arguments),this.paramsConfig=r}static type(){return n.type}dispose(){super.dispose(),ve.blobs.clearBlobsForNode(this)}operation(){const o=n.operation;return this._operation=this._operation||new o(this.scene(),this.states,this)}async cook(o){const a=await this.operation().cook(o,this.pv);this.setCoreGroup(a)}static PARAM_CALLBACK_reload(o){o._paramCallbackReload()}_paramCallbackReload(){this.p.url.setDirty(),this.p.url.emit(Cn.ASSET_RELOAD_REQUEST)}}return s}var Ow=(n=>(n.AM_SYNTH="AMSynth",n.FM_SYNTH="FMSynth",n.FILE="file",n.MONO_SYNTH="monoSynth",n.POLY_SYNTH="polySynth",n.SAMPLER="sampler",n.SWITCH="switch",n.SYNTH="synth",n))(Ow||{});const fS=["mp4","ogv","ogg","webm"];var Mn=(n=>(n.GIF="gif",n.JPG="jpg",n.JPEG="jpeg",n.PNG="png",n.EXR="exr",n.KTX2="ktx2",n.HDR="hdr",n.WEBP="webp",n))(Mn||{}),Nt=(n=>(n.TDS="3DS",n.DRC="drc",n.FBX="fbx",n.GEOJSON="geojson",n.GLTF="gltf",n.GLB="glb",n.IFC="ifc",n.JSON="json",n.MPD="mpd",n.OBJ="obj",n.PDB="pdb",n.PLY="ply",n.STEP="step",n.STL="stl",n.SVG="svg",n.USDZ="usdz",n.VOX="vox",n))(Nt||{});const x7=["bin"],b7=["mp3","wav","ogg"];var Md=(n=>(n.TTF="ttf",n.JSON="json",n))(Md||{});const Pw={[be.ANIM]:{},[be.AUDIO]:{[Ow.FILE]:[...b7]},[be.COP]:{[_s.CUBE_MAP]:[Mn.PNG,Mn.JPEG,Mn.JPG,Mn.WEBP],[_s.GIF]:[Mn.GIF],[hl.IMAGE]:[Mn.PNG,Mn.JPEG,Mn.JPG,Mn.WEBP],[hl.IMAGE_EXR]:[Mn.EXR],[hl.IMAGE_HDR]:[Mn.HDR],[hl.IMAGE_KTX2]:[Mn.KTX2],[_s.LUT]:[Mn.PNG],[_s.SDF_FROM_URL]:[...x7],[_s.TEXT]:[Md.TTF],[_s.VIDEO]:[...fS]},[be.EVENT]:{},[be.GL]:{},[be.JS]:{},[be.MANAGER]:{},[be.MAT]:{},[be.OBJ]:{},[be.POST]:{},[be.ROP]:{},[be.SOP]:{[zo.WEBXR_AR_MARKER_TRACKING]:[Mn.PNG,Mn.JPEG,Mn.JPG,Mn.WEBP,...fS],[rn.CAD_EXPORTER_STEP]:[Nt.STEP],[rn.CAD_FILE_STEP]:[Nt.STEP],[rn.DATA_URL]:[Nt.JSON],[ul.EXPORTER_GLTF]:[Nt.GLB],[ul.EXPORTER_OBJ]:[Nt.OBJ],[ul.EXPORTER_PLY]:[Nt.PLY],[ul.EXPORTER_STL]:[Nt.STL],[Rn.FILE_3DS]:[Nt.TDS],[Rn.FILE_GLTF]:[Nt.GLB,Nt.GLTF],[Rn.FILE_DRC]:[Nt.DRC],[Rn.FILE_FBX]:[Nt.FBX],[Rn.FILE_GEOJSON]:[Nt.GEOJSON],[Rn.FILE_JSON]:[Nt.JSON],[Rn.FILE_MPD]:[Nt.MPD],[sg.FILE_GLTF]:[Nt.GLTF,Nt.GLB],[sg.FILE_OBJ]:[Nt.OBJ],[Rn.FILE_OBJ]:[Nt.OBJ],[Rn.FILE_PDB]:[Nt.PDB],[Rn.FILE_PLY]:[Nt.PLY],[Rn.FILE_STL]:[Nt.STL],[Rn.FILE_SVG]:[Nt.SVG],[Rn.FILE_USDZ]:[Nt.USDZ],[Rn.FILE_VOX]:[Nt.VOX],[rn.TEXT]:[Md.TTF,Md.JSON]}};class C7 extends y7({type:Rn.FILE_OBJ,operation:ww,extensions:Pw[be.SOP][Rn.FILE_OBJ]}){}const rp={skyColor:new xe(1,1,1),groundColor:new xe(0,0,0),intensity:1,position:new T(0,1,0),name:"hemisphereLight"},ed=rp;function E7(n){return class extends n{constructor(){super(...arguments),this.skyColor=A.COLOR(ed.skyColor.toArray(),{}),this.groundColor=A.COLOR(ed.groundColor.toArray(),{}),this.intensity=A.FLOAT(ed.intensity,{range:[0,2],rangeLocked:[!0,!1]}),this.position=A.VECTOR3(ed.position.toArray()),this.name=A.STRING("`$OS`")}}}class M0 extends Ft{static type(){return"hemisphereLight"}cook(e,t){const r=this.createLight();return r.name=t.name,this.updateLightParams(r,t),this.createCoreGroupFromObjects([r])}createLight(){var e;Ip({type:Tt.HEMISPHERE_LIGHT,checkFunc:r=>{if(r.isHemisphereLight)return Tt.HEMISPHERE_LIGHT},ctor:Vx,humanName:"HemisphereLight"});const t=new Vx;return t.name=`HemisphereLight_${((e=this._node)==null?void 0:e.name())||""}`,t.matrixAutoUpdate=!1,t.updateMatrix(),t.color.copy(rp.skyColor),t.groundColor.copy(rp.groundColor),t}updateLightParams(e,t){e.color.copy(t.skyColor),e.groundColor.copy(t.groundColor),e.intensity=t.intensity,e.position.copy(t.position),e.updateMatrix()}}M0.DEFAULT_PARAMS=rp;M0.INPUT_CLONED_STATE=Mt.NEVER;class S7 extends E7(Et){}const A7=new S7;class T7 extends zt{constructor(){super(...arguments),this.paramsConfig=A7}static type(){return"hemisphereLight"}initializeNode(){this.io.inputs.setCount(0)}cook(e){this._operation=this._operation||new M0(this._scene,this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}}var Ao=(n=>(n.ADD_PARENT="add parent",n.REMOVE_PARENT="remove parent",n.ADD_CHILD="add child",n))(Ao||{});const Mi=["add parent","remove parent","add child"],Yp=["one child per parent","all children under first parent","all children under all parents"];class iu extends Ft{static type(){return"hierarchy"}cook(e,t){const r=e[0],s=Mi[t.mode];switch(s){case"add parent":{const i=M7(r,e[1],t);return this.createCoreGroupFromObjects(i)}case"remove parent":{const i=R7(r,t);return this.createCoreGroupFromObjects(i)}case"add child":{const i=w7(r,e[1],t,this,this.states);return this.createCoreGroupFromObjects(i)}}St.unreachable(s)}}iu.DEFAULT_PARAMS={mode:Mi.indexOf("add parent"),levels:1,objectMask:"",addChildMode:Yp.indexOf("all children under first parent")};iu.INPUT_CLONED_STATE=Mt.FROM_NODE;function M7(n,e,t){function r(s){function i(){const a=new lr;return a.matrixAutoUpdate=!1,a}let o;e&&(o=e==null?void 0:e.threejsObjects()[0]),o=o||i();for(let a of s)o.add(a);if(t.levels>1){let a=function(c,l){const u=i();return u.add(c),u};for(let c=1;c<t.levels;c++)o=a(o)}return o}return t.levels==0?n.threejsObjects():[r(n.threejsObjects())]}function R7(n,e){function t(r,s){function i(a){let c;const l=[];for(;c=a.pop();)if(c.children)for(let u of c.children)l.push(u);return l}let o=r.children;for(let a=0;a<s.levels-1;a++)o=i(o);return o}if(e.levels==0)return n.threejsObjects();{const r=[],s=n.threejsObjects();for(let i of s){const o=t(i,e);for(let a of o)r.push(a)}return r}}function w7(n,e,t,r,s){const i=n.threejsObjects();if(!e)return s==null||s.error.set("input 1 is invalid"),[];function o(_,g){const f=[];for(let m of g)gr.objectsByMaskInObject(_,m,f);return f}function a(){const _=t.objectMask.trim();return _!=""?o(_,i):i}const c=a(),l=e.threejsObjects();function u(){for(let _=0;_<c.length;_++){const g=c[_],f=l[_]||l[0];if(!f)return s==null||s.error.set("no objects found in input 1"),[];g.add(f)}return i}function h(){const _=c[0];for(let g of l)_.add(g);return i}function d(){for(let _ of c)for(let g of l)_.add(g.clone());return i}const p=Yp[t.addChildMode];switch(p){case"one child per parent":return u();case"all children under first parent":return h();case"all children under all parents":return d()}St.unreachable(p)}Ao.ADD_PARENT,Ao.REMOVE_PARENT;const Fm=iu.DEFAULT_PARAMS;class O7 extends Et{constructor(){super(...arguments),this.mode=A.INTEGER(Fm.mode,{menu:{entries:Mi.map((e,t)=>({name:e,value:t}))}}),this.levels=A.INTEGER(Fm.levels,{range:[0,5],visibleIf:[{mode:Mi.indexOf(Ao.ADD_PARENT)},{mode:Mi.indexOf(Ao.REMOVE_PARENT)}]}),this.objectMask=A.STRING("",{visibleIf:{mode:Mi.indexOf(Ao.ADD_CHILD)},objectMask:!0}),this.addChildMode=A.INTEGER(Fm.addChildMode,{visibleIf:{mode:Mi.indexOf(Ao.ADD_CHILD)},menu:{entries:Yp.map((e,t)=>({name:e,value:t}))}})}}const P7=new O7;class N7 extends zt{constructor(){super(...arguments),this.paramsConfig=P7}static type(){return rn.HIERARCHY}initializeNode(){this.io.inputs.setCount(1,2),this.io.inputs.initInputsClonedState(iu.INPUT_CLONED_STATE)}cook(e){this._operation=this._operation||new iu(this._scene,this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}setMode(e){this.p.mode.set(Mi.indexOf(e))}setAddChildMode(e){this.p.addChildMode.set(Yp.indexOf(e))}}function I7(n){return Math.atan2(n.z,-n.x)}function D7(n){return Math.atan2(-n.y,Math.sqrt(n.x*n.x+n.z*n.z))}class L7 extends sn{constructor(e,t,r,s,i){super(),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:s},r=r||1,s=s||0;const o=[],a=[],c=new Map;l(s),h(r),d(),this.setAttribute("position",new gt(o,3)),this.setAttribute("uv",new gt(a,2)),i||(this.setAttribute("normal",new gt(o.slice(),3)),s===0?this.computeVertexNormals():this.normalizeNormals());function l(g){const f=new T,m=new T,y=new T;for(let v=0;v<t.length;v+=3)_(t[v+0],f),_(t[v+1],m),_(t[v+2],y),u(f,m,y,g)}function u(g,f,m,y){const v=y+1,b=[];for(let x=0;x<=v;x++){b[x]=[];const E=g.clone().lerp(m,x/v),S=f.clone().lerp(m,x/v),R=v-x;for(let C=0;C<=R;C++)C===0&&x===v?b[x][C]=E:b[x][C]=E.clone().lerp(S,C/R)}for(let x=0;x<v;x++)for(let E=0;E<2*(v-x)-1;E++){const S=Math.floor(E/2);E%2===0?(p(b[x][S+1]),p(b[x+1][S]),p(b[x][S])):(p(b[x][S+1]),p(b[x+1][S+1]),p(b[x+1][S]))}}function h(g){const f=new T;for(let m=0;m<o.length;m+=3)f.x=o[m+0],f.y=o[m+1],f.z=o[m+2],f.normalize().multiplyScalar(g),o[m+0]=f.x,o[m+1]=f.y,o[m+2]=f.z}function d(){const g=new T;for(let f=0;f<o.length;f+=3){g.x=o[f+0],g.y=o[f+1],g.z=o[f+2];const m=I7(g)/2/Math.PI+.5,y=D7(g)/Math.PI+.5;a.push(m,1-y)}}function p(g){if(i){let f=c.get(g.x);if(f){const y=f.get(g.y);if(y&&y.has(g.z))return}f||(f=new Map,c.set(g.x,f));let m=f.get(g.y);m||(m=new Set,f.set(g.y,m)),m.add(g.z)}o.push(g.x,g.y,g.z)}function _(g,f){const m=g*3;f.x=e[m+0],f.y=e[m+1],f.z=e[m+2]}}}class F7 extends L7{constructor(e,t,r){const s=(1+Math.sqrt(5))/2,i=[-1,s,0,1,s,0,-1,-s,0,1,-s,0,0,-1,s,0,1,s,0,-1,-s,0,1,-s,s,0,-1,s,0,1,-s,0,-1,-s,0,1],o=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];super(i,o,e,t,r),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}}class R0 extends Ft{static type(){return"icosahedron"}cook(e,t){const r=this._createIcosahedronObject(t);return this._node&&(r.name=this._node.name()),this.createCoreGroupFromObjects([r])}_createIcosahedronObject(e){const t=e.pointsOnly,r=new F7(e.radius,e.detail,t);return r.translate(e.center.x,e.center.y,e.center.z),t?this.createObject(r,Tt.POINTS):(r.computeVertexNormals(),this.createObject(r,Tt.MESH))}}R0.DEFAULT_PARAMS={radius:1,detail:0,pointsOnly:!1,center:new T(0,0,0)};const td=R0.DEFAULT_PARAMS;class U7 extends Et{constructor(){super(...arguments),this.radius=A.FLOAT(td.radius),this.detail=A.INTEGER(td.detail,{range:[0,32],rangeLocked:[!0,!1]}),this.pointsOnly=A.BOOLEAN(td.pointsOnly),this.center=A.VECTOR3(td.center)}}const k7=new U7;class B7 extends zt{constructor(){super(...arguments),this.paramsConfig=k7}static type(){return rn.ICOSAHEDRON}cook(){this._operation=this._operation||new R0(this._scene,this.states,this);const e=this._operation.cook([],this.pv);this.setCoreGroup(e)}}let G7=0;class ou extends Ft{constructor(){super(...arguments),this._materialSopOperationId=G7++,this._globalsHandler=new ru,this._onMaterialUpdateBound=this._onMaterialUpdate.bind(this),this._oldMatByOldNewId=new Map,this._materialByUuid=new Map}static type(){return"material"}async cook(e,t){const r=e[0];return this._oldMatByOldNewId.clear(),await this._applyMaterials(r,t),this._swapTextures(r,t),r}async _getMaterial(e){var t,r,s,i;const o=e.material.nodeWithContext(be.MAT,(t=this.states)==null?void 0:t.error);if(o){this._watchMaterialNode(o);const a=await o.material(),c=o;return c.assemblerController&&((r=c.assemblerController())==null||r.setAssemblerGlobalsHandler(this._globalsHandler)),a||(s=this.states)==null||s.error.set(`material invalid. (error: '${o.states.error.message()}')`),a}else(i=this.states)==null||i.error.set("no material node found")}_watchMaterialNode(e){if(this._watchedMaterialNode==e)return;const t=this._watchHookName();e.addPostDirtyHook(t,this._onMaterialUpdateBound),e.cookController.registerOnCookEnd(t,this._onMaterialUpdateBound),this._watchedMaterialNode&&(this._watchedMaterialNode.removePostDirtyHook(t),this._watchedMaterialNode.cookController.deregisterOnCookEnd(t)),this._watchedMaterialNode=e}async _onMaterialUpdate(){if(!this._watchedMaterialNode)return;const t=(await this._watchedMaterialNode.compute()).material();t!=this._watchedMaterialNodeMaterial&&(this._watchedMaterialNodeMaterial=t,this._node&&this._node.p.material.setDirty())}_watchHookName(){return`MaterialSopOperationId-${this._materialSopOperationId}`}async _applyMaterials(e,t){if(!t.assignMat)return;const r=await this._getMaterial(t);if(!r)return;const s=Qr.filterThreejsObjects(e,t);for(let i of s)this._applyMaterial(i,r,t);return e}_swapTextures(e,t){if(!t.swapCurrentTex)return;this._materialByUuid.clear();const r=Qr.filterObjects(e,t,e.allCoreObjects());for(let s of r){const i=s.material;this._materialByUuid.set(i.uuid,i)}this._materialByUuid.forEach((s,i)=>{this._swapTexture(s,t)})}_applyMaterial(e,t,r){const s=r.cloneMat?Av(this.scene(),t,{shareCustomUniforms:r.shareCustomUniforms,addCustomMaterials:!0}):t;if(t instanceof Kn&&s instanceof Kn)for(let o in t.uniforms)s.uniforms[o]=t.uniforms[o];if(e.isGroup)return;const i=e;this._oldMatByOldNewId.set(s.uuid,i.material),i.material=s,tH(e,s),Tv(e,s)}_swapTexture(e,t){if(t.texSrc0==""||t.texDest0=="")return;let r=this._oldMatByOldNewId.get(e.uuid);r=r||e;const s=r[t.texSrc0];if(s){e[t.texDest0]=s;const i=e.uniforms;i&&i[t.texDest0]&&(i[t.texDest0]={value:s})}}}ou.DEFAULT_PARAMS={group:"",assignMat:!0,material:new Zr(""),cloneMat:!1,shareCustomUniforms:!0,swapCurrentTex:!1,texSrc0:"emissiveMap",texDest0:"map"};ou.INPUT_CLONED_STATE=Mt.FROM_NODE;const io=ou.DEFAULT_PARAMS;class V7 extends Et{constructor(){super(...arguments),this.group=A.STRING(io.group,{objectMask:!0}),this.assignMat=A.BOOLEAN(io.assignMat),this.material=A.NODE_PATH("",{nodeSelection:{context:be.MAT},dependentOnFoundNode:!1,visibleIf:{assignMat:1}}),this.cloneMat=A.BOOLEAN(io.cloneMat,{visibleIf:{assignMat:1},separatorBefore:!0}),this.shareCustomUniforms=A.BOOLEAN(io.shareCustomUniforms,{visibleIf:{assignMat:1,cloneMat:1}}),this.swapCurrentTex=A.BOOLEAN(io.swapCurrentTex),this.texSrc0=A.STRING(io.texSrc0,{visibleIf:{swapCurrentTex:1}}),this.texDest0=A.STRING(io.texDest0,{visibleIf:{swapCurrentTex:1}})}}const z7=new V7;class H7 extends zt{constructor(){super(...arguments),this.paramsConfig=z7}static type(){return rn.MATERIAL}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(ou.INPUT_CLONED_STATE)}async cook(e){this._operation=this._operation||new ou(this._scene,this.states,this);const t=await this._operation.cook(e,this.pv);this.setCoreGroup(t)}}class j7 extends rs{static context(){return be.SOP}cook(){this.cookController.endCook()}}class W7 extends j7{}class X7 extends W7{constructor(){super(...arguments),this._childrenControllerContext=be.MAT}static type(){return Ac.MAT}createNode(e,t){return super.createNode(e,t)}children(){return super.children()}nodesByType(e){return super.nodesByType(e)}}const Nw=class extends Ft{static type(){return"merge"}cook(n,e){var t;let r=[];for(const s of n)if(s){const i=s.allObjects();if(e.compact)for(const o of i)o.traverse(a=>{r.push(a)});else for(const o of i)r.push(o)}return e.compact&&(r=Nw.makeCompact(r,e,(t=this.states)==null?void 0:t.error)),this.createCoreGroupFromObjects(r)}static makeCompact(n,e,t){const{preserveMaterials:r}=e,s=new Map,i=new Map,o=[];for(let c of n)c.traverse(l=>{if(l instanceof lr)return;const u=c.type;u&&(o.includes(u)||o.push(u),u&&(s.get(u)||s.set(u,c.material),dr(i,u,c)))});const a=[];return o.forEach(c=>{const l=s.get(c),u=i.get(c);u&&u.length!=0&&(r?$7({objects:u,material:l,objectType:c,mergedObjects:a,onError:h=>{t==null||t.set(h)}}):Ut(u[0]).mergeCompact({objects:u,material:l,objectType:c,mergedObjects:a,onError:d=>{t==null||t.set(d)}}))}),a}};let au=Nw;au.DEFAULT_PARAMS={compact:!1,preserveMaterials:!0};au.INPUT_CLONED_STATE=Mt.FROM_NODE;const Um=new Map;function $7(n){const{objects:e,objectType:t,mergedObjects:r,onError:s}=n,i=Ut(e[0]);Um.clear();for(let o of e)fr(Um,o.material,o);Um.forEach((o,a)=>{i.mergeCompact({objects:rr(o,[]),material:a,objectType:t,mergedObjects:r,onError:s})})}const mS=au.DEFAULT_PARAMS,Iw=4;class q7 extends Et{constructor(){super(...arguments),this.compact=A.BOOLEAN(mS.compact),this.preserveMaterials=A.BOOLEAN(mS.preserveMaterials,{visibleIf:{compact:!0}}),this.inputsCount=A.INTEGER(Iw,{range:[1,32],rangeLocked:[!0,!1],callback:e=>{Dw.PARAM_CALLBACK_setInputsCount(e)}})}}const Y7=new q7;class Dw extends zt{constructor(){super(...arguments),this.paramsConfig=Y7}static type(){return rn.MERGE}setCompactMode(e){this.p.compact.set(e)}initializeNode(){this.io.inputs.setCount(1,Iw),this.io.inputs.initInputsClonedState(au.INPUT_CLONED_STATE),this.params.onParamsCreated("update inputs",()=>{this._callbackUpdateInputsCount()})}cook(e){this._operation=this._operation||new au(this.scene(),this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}_callbackUpdateInputsCount(){this.io.inputs.setCount(1,this.pv.inputsCount),this.emit(_n.INPUTS_UPDATED)}static PARAM_CALLBACK_setInputsCount(e){e._callbackUpdateInputsCount()}}class cu extends Ft{static type(){return"objectProperties"}cook(e,t){const r=e[0],s=Qr.filterObjects(r,t);for(let i of s)this._updateObject(i,t);return r}_updateObject(e,t){t.tname&&(e.name=t.name),t.trenderOrder&&(e.renderOrder=t.renderOrder),t.tfrustumCulled&&(e.frustumCulled=t.frustumCulled),t.tmatrixAutoUpdate&&(e.matrixAutoUpdate=t.matrixAutoUpdate),t.tvisible&&(e.visible=t.visible),t.tcastShadow&&(e.castShadow=t.castShadow),t.treceiveShadow&&(e.receiveShadow=t.receiveShadow)}}cu.DEFAULT_PARAMS={group:"",tname:!1,name:"",trenderOrder:!1,renderOrder:0,tfrustumCulled:!1,frustumCulled:!0,tmatrixAutoUpdate:!1,matrixAutoUpdate:!1,tvisible:!1,visible:!0,tcastShadow:!1,castShadow:!0,treceiveShadow:!1,receiveShadow:!0};cu.INPUT_CLONED_STATE=Mt.FROM_NODE;const $n=cu.DEFAULT_PARAMS;class K7 extends Et{constructor(){super(...arguments),this.group=A.STRING($n.group,{objectMask:!0}),this.tname=A.BOOLEAN($n.tname),this.name=A.STRING($n.name,{visibleIf:{tname:!0},separatorAfter:!0,expression:{forEntities:!0}}),this.trenderOrder=A.BOOLEAN($n.trenderOrder),this.renderOrder=A.INTEGER($n.renderOrder,{visibleIf:{trenderOrder:!0},range:[0,10],rangeLocked:[!1,!1],separatorAfter:!0,expression:{forEntities:!0}}),this.tfrustumCulled=A.BOOLEAN($n.tfrustumCulled),this.frustumCulled=A.BOOLEAN($n.frustumCulled,{visibleIf:{tfrustumCulled:!0},separatorAfter:!0,expression:{forEntities:!0}}),this.tmatrixAutoUpdate=A.BOOLEAN($n.tmatrixAutoUpdate),this.matrixAutoUpdate=A.BOOLEAN($n.matrixAutoUpdate,{visibleIf:{tmatrixAutoUpdate:!0},separatorAfter:!0,expression:{forEntities:!0}}),this.tvisible=A.BOOLEAN($n.tvisible),this.visible=A.BOOLEAN($n.visible,{visibleIf:{tvisible:!0},separatorAfter:!0,expression:{forEntities:!0}}),this.tcastShadow=A.BOOLEAN($n.tcastShadow),this.castShadow=A.BOOLEAN($n.castShadow,{visibleIf:{tcastShadow:!0},separatorAfter:!0,expression:{forEntities:!0}}),this.treceiveShadow=A.BOOLEAN($n.treceiveShadow),this.receiveShadow=A.BOOLEAN($n.receiveShadow,{visibleIf:{treceiveShadow:!0},expression:{forEntities:!0}})}}const Z7=new K7;class J7 extends zt{constructor(){super(...arguments),this.paramsConfig=Z7}static type(){return rn.OBJECT_PROPERTIES}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(cu.INPUT_CLONED_STATE)}async cook(e){if(this._operation=this._operation||new cu(this.scene(),this.states,this),this.params.all.find(r=>r.hasExpression())){const r=e[0];await this._cookWithExpressions(r),this.setCoreGroup(r)}else{const r=this._operation.cook(e,this.pv);this.setCoreGroup(r)}}async _cookWithExpressions(e){const t=gw(e,this.pv);await this._cookWithExpressionsForCoreObjects(t)}async _cookWithExpressionsForCoreObjects(e){const t=this.p;async function r(o,a,c){if(o.value)if(a.expressionController&&a.expressionController.entitiesDependent())await a.expressionController.computeExpressionForObjects(e,(l,u)=>{l.object()[c]=u});else for(const l of e){const u=l.object();u&&(u[c]=a.value)}}async function s(o,a,c){if(o.value)if(a.expressionController&&a.expressionController.entitiesDependent())await a.expressionController.computeExpressionForObjects(e,(l,u)=>{l.object()[c]=u});else for(const l of e){const u=l.object();u&&(u[c]=a.value)}}async function i(o,a,c){if(o.value)if(a.expressionController&&a.expressionController.entitiesDependent())await a.expressionController.computeExpressionForObjects(e,(l,u)=>{l.object()[c]=u});else for(const l of e){const u=l.object();u&&(u[c]=a.value)}}await Promise.all([r(t.tname,t.name,"name"),s(t.trenderOrder,t.renderOrder,"renderOrder"),i(t.tfrustumCulled,t.frustumCulled,"frustumCulled"),i(t.tmatrixAutoUpdate,t.matrixAutoUpdate,"matrixAutoUpdate"),i(t.tvisible,t.visible,"visible"),i(t.tcastShadow,t.castShadow,"castShadow"),i(t.treceiveShadow,t.receiveShadow,"receiveShadow")])}}class Q7{constructor(e){this._viewer=e,this._size=new W(100,100),this._aspect=1}camera(){return this._viewer.camera()}get size(){return this._size}get aspect(){return this._aspect}computeSizeAndAspect(e){this._updateSize(),this._viewer.scene().uniformsController.updateResolution(this._size,e),this._aspect=this._getAspect()}_updateSize(){var e,t;this._size.x=((e=this._viewer.domElement())==null?void 0:e.offsetWidth)||0,this._size.y=((t=this._viewer.domElement())==null?void 0:t.offsetHeight)||0}_getAspect(){return this._size.x/this._size.y}updateCameraAspect(){this._viewer.updateCameraAspect(this._aspect,this._size)}async prepareCurrentCamera(){await this._updateFromCameraContainer()}async _updateFromCameraContainer(){this.updateCameraAspect()}}const _S=["start","end"],e9={type:"start"},t9={type:"end"};class n9 extends Ms{constructor(e){super(),this.viewer=e,this._active=!1,this._mounted=!1,this._boundEventHandler={start:()=>this.dispatchEvent(e9),end:()=>this.dispatchEvent(t9)}}controls(){return this._controls}mount(){if(this._mounted)return;this._mounted=!0;const e=this.viewer.controlsNode(),t=this.viewer.camera();e&&t&&e.applyControls(t,this.viewer).then(r=>{this._controls=r,this._updateControlsFunc=r?s=>r.update(s):void 0;for(const s of _S)r.addEventListener(s,this._boundEventHandler[s]);this._mounted||this._disposeControls()})}unmount(){this._mounted&&(this._mounted=!1,this._disposeControls())}_disposeControls(){if(this._controls){for(const e of _S)this._controls.removeEventListener(e,this._boundEventHandler[e]);this._controls.dispose()}this._updateControlsFunc=void 0}update(e){this._updateControlsFunc&&this._updateControlsFunc(e)}setActive(e){e?this.mount():this.unmount()}setTarget(e){if(!this._controls)return;const t=this._controls;t.target&&t.target.copy(e)}}function r9(n){n.setAttribute("tabindex","0")}var Lw=(n=>(n.resize="resize",n))(Lw||{});function s9(n,e){return n==Yd.CANVAS?e:document}function gS(n,e){return n.type==Lw.resize?window:s9(n.emitter,e)}const km=new Set;class i9{constructor(e){this.viewer=e,this._eventTypes=new Map}removeEvents(e,t){const r=t||this.canvas();if(!r){console.warn("no canvas found");return}const s=this._eventTypes.get(e.type());s&&s.forEach((i,o)=>{i.forEach((a,c)=>{gS({emitter:a.data.emitter,type:c},r).removeEventListener(c,a.listener)}),i.clear()})}updateEvents(e){const t=this.canvas();if(!t){console.warn("no canvas found");return}this.removeEvents(e,t);const r=e.activeEventDatas();for(const s of r){const i=gS(s,t),o=this._mapForEmitter(e,i),a=s.type,c=(u,h)=>{const d={viewer:this.viewer,event:u,emitter:s.emitter};h.processEvent(d)},l=u=>{c(u,e)};i.addEventListener(a,l,{passive:!0}),i!=document&&WR.includes(s.type)&&r9(i),o.set(s.type,{listener:l,data:s})}}_mapForEmitter(e,t){const r=e.type();let s=this._eventTypes.get(r);s||(s=new Map,this._eventTypes.set(r,s));let i=s.get(t);return i||(i=new Map,s.set(t,i)),i}camera(){return this.viewer.camera()}canvas(){return this.viewer.canvas()}init(){if(!this.canvas()){console.warn("no canvas found for eventsController");return}this.viewer.scene().eventsDispatcher.traverseControllers(e=>{this.updateEvents(e)})}unmount(){this.viewer.scene().eventsDispatcher.traverseControllers(e=>{this.removeEvents(e)})}registeredEventTypes(){km.clear(),this._eventTypes.forEach(t=>{t.forEach((r,s)=>{r.forEach((i,o)=>{km.add(o)})})});const e=[];return rr(km,e),e}}class o9{constructor(e){this.viewer=e}init(){const e=this.viewer.canvas();e&&(e.onwebglcontextlost=this._on_webglcontextlost.bind(this),e.onwebglcontextrestored=this._on_webglcontextrestored.bind(this))}_on_webglcontextlost(){console.warn("context lost at frame",this.viewer.scene().frame()),this.request_animation_frame_id?cancelAnimationFrame(this.request_animation_frame_id):console.warn("request_animation_frame_id not initialized"),console.warn("not canceled",this.request_animation_frame_id)}_on_webglcontextrestored(){console.log("context restored")}}const vS={ON:`<svg xmlns="http://www.w3.org/2000/svg" class="soundOn h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
	<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
  </svg>`,OFF:`<svg xmlns="http://www.w3.org/2000/svg" class="soundOff h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
	<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" />
	<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
  </svg>`};class a9{constructor(e){this._viewer=e}update(){const e=this._viewer.scene().root();e.pv.displayAudioIcon?(this._showIcon(),this._updateIcon(e)):this._hideIcon()}unmount(){var e;this.__iconContainer&&((e=this.__iconContainer.parentElement)==null||e.removeChild(this.__iconContainer),this.__iconContainer=void 0),this._onIcon=void 0,this._offIcon=void 0}_showIcon(){const e=this._iconContainer();e&&(e.style.display="block")}_hideIcon(){this.__iconContainer&&(this.__iconContainer.style.display="none")}_iconContainer(){const e=()=>{const t=this._createIconContainer(),r=this._viewer.domElement();if(r)return r.append(t),t};return this.__iconContainer=this.__iconContainer||e()}_createIconContainer(){const e=document.createElement("div");return e.addEventListener("pointerdown",t=>(this._toggleSound(),t.preventDefault(),t.stopPropagation(),!1)),e}_setIconContainerStyle(e,t){const r=t.pv.audioIconStyle;e.setAttribute("style",r),e.style.color=t.pv.audioIconColor.getStyle()}offIcon(){function e(){const t=document.createElement("div");return t.innerHTML=vS.OFF,t.children[0]}return this._offIcon=this._offIcon||e()}onIcon(){function e(){const t=document.createElement("div");return t.innerHTML=vS.ON,t.children[0]}return this._onIcon=this._onIcon||e()}_toggleSound(){const e=this._viewer.scene().root();e.audioController.toggleSound(),this._updateIcon(e)}_updateIcon(e){var t,r;const s=this._iconContainer();if(!s)return;this._setIconContainerStyle(s,e);const i=this.onIcon(),o=this.offIcon();this._viewer.scene().root().audioController.soundOn()?(s.appendChild(i),(t=o.parentElement)==null||t.removeChild(o)):(s.appendChild(o),(r=i.parentElement)==null||r.removeChild(i))}}class c9{constructor(e){this.viewer=e;const t=this.viewer.scene();this.pointerEventsController=t.eventsDispatcher.pointerEventsController,this.pointerEventsController.setRaycaster(e.createRaycaster())}setCursor0(e){this.pointerEventsController.cursor().value.set(e.x,e.y)}raycaster0(){return this.pointerEventsController.raycaster().value}updateRaycasters(){this.pointerEventsController.raycaster().value.setFromCamera(this.pointerEventsController.cursor().value,this.viewer.camera())}}function yS(n){return Math.round(n*10)}class l9{constructor(e){this.viewer=e,this._accumulatedDelta=0,this._framesCount=0,this._lastRoundedPerf=yS(1)}measurePerformance(e){if(this._accumulatedDelta+=e,this._accumulatedDelta>=1){const t=this._framesCount/tz,r=yS(t);r!=this._lastRoundedPerf&&(this._lastRoundedPerf=r,this.viewer.scene().perfMonitor.onPerformanceChange(t)),this._framesCount=0,this._accumulatedDelta=0}this._framesCount++}}const xS="hovered",fl=class{constructor(n){this._active=!1,this._doRender=!0,this._mounted=!1,this._controlsController=new n9(this),this.performanceMonitor=new l9(this),this._size=new W,this._onBeforeTickCallbacks=[],this._onAfterTickCallbacks=[],this._onBeforeRenderCallbacks=[],this._onAfterRenderCallbacks=[],this._id=fl._nextId(),this._camera=n.camera,this._scene=n.scene,this._canvas=n.canvas,n.autoRender!=null&&(this._doRender=n.autoRender),this.updateCameraAspect=n.updateCameraAspect,this.scene().viewersRegister.registerViewer(this),this.raycastersController=new c9(this)}static _nextId(){return`${fl._nextViewerId++}`}createRaycaster(){return XR()}mount(n,e){let t=!0;e&&e.updateAutoRenderOnIntersectionChange!=null&&(t=e.updateAutoRenderOnIntersectionChange),this._domElement=n,this._domElement.viewer=this,this._domElement.scene=this._scene,this._domElement.Poly=ve,t&&this.updateAutoRenderOnIntersectionChange({playPauseScene:!0}),this.controlsController().mount(),this._mounted=!0}unmount(){var n,e;if(!this._domElement)return;(n=this._audioController)==null||n.unmount();const t=this.canvas();(e=t.parentElement)==null||e.removeChild(t),this.eventsController().unmount(),this.controlsController().unmount(),this._mounted=!1}static _canvasIdPrefix(){return"TypedViewer"}static createCanvas(n){n=n||fl._nextId();const e=ve.canvasRegister.findOrCreateCanvas();return e.id=`${this._canvasIdPrefix()}_${n}`,e.style.display="block",e.style.outline="none",e.style.width="100%",e.style.height="100%",e.addEventListener("contextmenu",t=>{t.preventDefault(),t.stopPropagation()}),e}controlsNode(){return this._controlsNode}canvas(){return this._canvas=this._canvas||fl.createCanvas(this._id)}_tickAndRender(n){this._tick(n),this.render(n),this._postRender(n)}_tick(n){this.controlsController().update(n),this.raycastersController.updateRaycasters(),this._runOnBeforeTickCallbacks(n),this.scene().update(n),this._runOnAfterTickCallbacks(n)}render(n){if(!this._doRender)return;const e=this._renderer;if(!e){console.error("render: no renderer");return}this._runOnBeforeRenderCallbacks(n,e),this._renderFunc&&this._renderFunc(n),this._renderCSSFunc&&this._renderCSSFunc(),this._runOnAfterRenderCallbacks(n,e)}_postRender(n){this._scene.viewersRegister.markViewerAsRendered(this),this.scene().timeController.playing()&&this.performanceMonitor.measurePerformance(n)}setRenderObjectOverride(n){n?this._renderObjectOverride=n:this._renderObjectOverride=void 0}active(){return this._active}activate(){this._active=!0}deactivate(){this._active=!1}camerasController(){return this._camerasController=this._camerasController||new Q7(this)}controlsController(){return this._controlsController}eventsController(){return this._eventsController=this._eventsController||new i9(this)}webglController(){return this._webGLController=this._webGLController||new o9(this)}audioController(){return this._audioController=this._audioController||new a9(this)}domElement(){return this._domElement}scene(){return this._scene}camera(){return this._camera}id(){return this._id}size(n){n.copy(this._size)}updateSize(){}dispose(){if(this._scene.viewersRegister.unregisterViewer(this),this.controlsController().unmount(),!this._domElement)return;let n;for(;n=this._domElement.children[0];)this._domElement.removeChild(n)}resetContainerClass(){var n;(n=this.domElement())==null||n.classList.remove(xS)}setContainerClassHovered(){var n;(n=this.domElement())==null||n.classList.add(xS)}markAsReady(){}setAutoRender(n=!0){this._doRender=n}autoRenderState(){return this._doRender}updateAutoRenderOnIntersectionChange(n){if(!this._domElement){console.warn("cannot apply");return}let{threshold:e,root:t,rootMargin:r,playPauseScene:s,onChange:i}=n;e==null&&(e=.01);const o={root:t,rootMargin:r,threshold:e},a=(c,l)=>{this._scene.loadingController.loaded()&&c.forEach(u=>{const h=u.isIntersecting;this.setAutoRender(h),s&&(h?this._scene.play():this._scene.pause()),i&&i(h)})};this.disableUpdateAutoRenderOnIntersectionChange(),this._observer=new IntersectionObserver(a,o),this._observer.observe(this._domElement)}disableUpdateAutoRenderOnIntersectionChange(){this._domElement&&this._observer&&this._observer.unobserve(this._domElement)}registerOnResizeCallback(n){this._onResizeCallbacks=this._onResizeCallbacks||[],this._onResizeCallbacks.push(n)}unregisterOnResizeCallback(n){if(!this._onResizeCallbacks)return;const e=this._onResizeCallbacks.indexOf(n);e>=0&&this._onResizeCallbacks.splice(e,1),this._onResizeCallbacks.length==0&&(this._onResizeCallbacks=void 0)}_runOnResizeCallbacks(){const n=this.canvas();if(n&&rg.resetCacheForCanvas(n),!!this._onResizeCallbacks)for(const e of this._onResizeCallbacks)e(this._size.x,this._size.y)}registerOnBeforeTick(n,e,t={}){this._registerCallback(n,e,this.registeredBeforeTickCallbacks(),t)}unRegisterOnBeforeTick(n){this._unregisterCallback(n,this._onBeforeTickCallbacksMap)}registeredBeforeTickCallbacks(){return this._onBeforeTickCallbacksMap=this._onBeforeTickCallbacksMap||new Map}registerOnAfterTick(n,e,t={}){this._registerCallback(n,e,this.registeredAfterTickCallbacks(),t)}unRegisterOnAfterTick(n){this._unregisterCallback(n,this._onAfterTickCallbacksMap)}registeredAfterTickCallbacks(){return this._onAfterTickCallbacksMap=this._onAfterTickCallbacksMap||new Map}registerOnBeforeRender(n,e,t={}){this._registerCallback(n,e,this.registeredBeforeRenderCallbacks(),t)}unRegisterOnBeforeRender(n){this._unregisterCallback(n,this._onBeforeRenderCallbacksMap)}registeredBeforeRenderCallbacks(){return this._onBeforeRenderCallbacksMap=this._onBeforeRenderCallbacksMap||new Map}registerOnAfterRender(n,e,t={}){this._registerCallback(n,e,this.registeredAfterRenderCallbacks(),t)}unRegisterOnAfterRender(n){this._unregisterCallback(n,this._onAfterRenderCallbacksMap)}registeredAfterRenderCallbacks(){return this._onAfterRenderCallbacksMap=this._onAfterRenderCallbacksMap||new Map}_registerCallback(n,e,t,r={}){if(t.has(n)){console.warn(`callback ${n} already registered`);return}t.set(n,{callback:e,options:r}),this._updateCallbacks()}_unregisterCallback(n,e){if(!e)return;const t=e.get(n);!t||t.options.persistent==!0||(e.delete(n),this._updateCallbacks())}_updateCallbacks(){var n,e,t,r;this._onBeforeTickCallbacks=[],(n=this._onBeforeTickCallbacksMap)==null||n.forEach(s=>{this._onBeforeTickCallbacks.push(s.callback)}),this._onAfterTickCallbacks=[],(e=this._onAfterTickCallbacksMap)==null||e.forEach(s=>{this._onAfterTickCallbacks.push(s.callback)}),this._onBeforeRenderCallbacks=[],(t=this._onBeforeRenderCallbacksMap)==null||t.forEach(s=>{this._onBeforeRenderCallbacks.push(s.callback)}),this._onAfterRenderCallbacks=[],(r=this._onAfterRenderCallbacksMap)==null||r.forEach(s=>{this._onAfterRenderCallbacks.push(s.callback)})}_runTickCallbacks(n,e){for(const t of n)t(e)}_runRenderCallbacks(n,e,t){for(const r of n)r(e,t)}_runOnBeforeTickCallbacks(n){this._runTickCallbacks(this._onBeforeTickCallbacks,n)}_runOnAfterTickCallbacks(n){this._runTickCallbacks(this._onAfterTickCallbacks,n)}_runOnBeforeRenderCallbacks(n,e){this._runRenderCallbacks(this._onBeforeRenderCallbacks,n,e)}_runOnAfterRenderCallbacks(n,e){this._runRenderCallbacks(this._onAfterRenderCallbacks,n,e)}};let Fw=fl;Fw._nextViewerId=0;class u9 extends rs{constructor(){super(...arguments),this.flags=new zv(this)}static context(){return be.ROP}initializeBaseNode(){this.dirtyController.addPostDirtyHook("cook_immediately",()=>{this.cookController.cookMainWithoutInputs()})}cook(){this.cookController.endCook()}}var fc=(n=>(n.CSS2D="CSS2DRenderer",n.CSS3D="CSS3DRenderer",n.WEBGL="WebGLRenderer",n.WEBGPU="WebGPURenderer",n.PATH_TRACING="pathTracingRenderer",n))(fc||{});function Uw(){return 2}const rl=[{Linear:xn},{sRGB:nn},{LinearSRGB:kr},{DisplayP3:gc},{LinearDisplayP3:Fo}],h9={[xn]:Object.keys(rl[0])[0],[nn]:Object.keys(rl[1])[0],[kr]:Object.keys(rl[2])[0],[gc]:Object.keys(rl[3])[0],[Fo]:Object.keys(rl[4])[0]},d9=[nn,kr,gc,Fo],kw=nn;var Ri=(n=>(n[n.No=Fr]="No",n[n.Linear=SA]="Linear",n[n.Reinhard=AA]="Reinhard",n[n.Cineon=TA]="Cineon",n[n.ACESFilmic=MA]="ACESFilmic",n))(Ri||{});const p9=["No","Linear","Reinhard","Cineon","ACESFilmic"],Bw=[Ri.No,Ri.Linear,Ri.Reinhard,Ri.Cineon,Ri.ACESFilmic],Gw=Ri.ACESFilmic,f9=p9.map((n,e)=>({name:n,value:Bw[e]})),Vw=[];for(const n of Bw)n!=Ri.No&&Vw.push(n);var $a=(n=>(n[n.Basic=lP]="Basic",n[n.PCF=Og]="PCF",n[n.PCFSoft=EA]="PCFSoft",n[n.VSM=hs]="VSM",n))($a||{});const m9=["Basic","PCF","PCFSoft","VSM"],_9=[$a.Basic,$a.PCF,$a.PCFSoft,$a.VSM],zw=$a.PCFSoft;class g9 extends Et{constructor(){super(...arguments),this.common=A.FOLDER(),this.toneMapping=A.INTEGER(Gw,{menu:{entries:f9},cook:!1,callback:e=>{cs.PARAM_CALLBACK_updateToneMapping(e)}}),this.toneMappingExposure=A.FLOAT(1,{range:[0,2],cook:!1,visibleIf:Vw.map(e=>({toneMapping:e})),callback:e=>{cs.PARAM_CALLBACK_updateToneMappingExposure(e)}}),this.outputColorSpace=A.STRING(kw,{menuString:{entries:d9.map(e=>({name:h9[e],value:e}))},cook:!1,callback:e=>{cs.PARAM_CALLBACK_updateOutputColorSpace(e)}}),this.sortObjects=A.BOOLEAN(1,{cook:!1,callback:e=>{cs.PARAM_CALLBACK_updateSortObjects(e)}}),this.tpixelRatio=A.BOOLEAN(0,{cook:!1,callback:e=>{cs.PARAM_CALLBACK_updatePixelRatio(e)}}),this.pixelRatio=A.FLOAT(2,{visibleIf:{tpixelRatio:!0},range:[.1,4],rangeLocked:[!0,!1],cook:!1,callback:e=>{cs.PARAM_CALLBACK_updatePixelRatio(e)}}),this.shadow=A.FOLDER(),this.tshadowMap=A.BOOLEAN(1,{cook:!1,callback:e=>{cs.PARAM_CALLBACK_updateShadow(e)}}),this.shadowMapAutoUpdate=A.BOOLEAN(1,{visibleIf:{tshadowMap:1},cook:!1,callback:e=>{cs.PARAM_CALLBACK_updateShadow(e)}}),this.shadowMapNeedsUpdate=A.BOOLEAN(0,{visibleIf:{tshadowMap:1},cook:!1,callback:e=>{cs.PARAM_CALLBACK_updateShadow(e)}}),this.shadowMapType=A.INTEGER(zw,{visibleIf:{tshadowMap:1},menu:{entries:m9.map((e,t)=>({name:e,value:_9[t]}))},cook:!1,callback:e=>{cs.PARAM_CALLBACK_updateShadow(e)}}),this.advanced=A.FOLDER(),this.alpha=A.BOOLEAN(1),this.antialias=A.BOOLEAN(1),this.premultipliedAlpha=A.BOOLEAN(1),this.stencil=A.BOOLEAN(1),this.depth=A.BOOLEAN(1),this.localClippingEnabled=A.BOOLEAN(0),this.logarithmicDepthBuffer=A.BOOLEAN(0),this.preserveDrawingBuffer=A.BOOLEAN(0),this.tprecision=A.BOOLEAN(0),this.precision=A.INTEGER(b_.indexOf(yT.HIGH),{visibleIf:{tprecision:1},menu:{entries:b_.map((e,t)=>({value:t,name:e}))}}),this.tpowerPreference=A.BOOLEAN(0),this.powerPreference=A.INTEGER(x_.indexOf(vT.HIGH),{visibleIf:{tpowerPreference:1},menu:{entries:x_.map((e,t)=>({value:t,name:e}))}})}}const v9=new g9;class cs extends u9{constructor(){super(...arguments),this.paramsConfig=v9,this._rendererByCanvas=new Map}static type(){return fc.WEBGL}createRenderer(e,t){const r={},s=Object.keys(C_);let i;for(i of s)r[i]=C_[i];if(this.pv.tprecision){const a=b_[this.pv.precision];r.precision=a}if(this.pv.tpowerPreference){const a=x_[this.pv.powerPreference];r.powerPreference=a}r.antialias=this.pv.antialias,r.alpha=this.pv.alpha,r.premultipliedAlpha=this.pv.premultipliedAlpha,r.depth=this.pv.depth,r.stencil=this.pv.stencil,r.logarithmicDepthBuffer=this.pv.logarithmicDepthBuffer,r.canvas=e,r.context=t,r.preserveDrawingBuffer=this.pv.preserveDrawingBuffer;const o=ve.renderersController.createWebGLRenderer(r);return o.localClippingEnabled=this.pv.localClippingEnabled,this._rendererByCanvas.set(e,o),ve.renderersController.printDebug()&&(ve.renderersController.printDebugMessage(`create renderer from node '${this.path()}'`),ve.renderersController.printDebugMessage({params:r})),this._updateRenderer(o),o}cook(){this._traverseSceneAndUpdateMaterials(),this.cookController.endCook()}_updateRenderer(e){this._updateRendererOutputColorSpace(e),this._updateRendererToneMapping(e),this._updateRendererToneMappingExposure(e),this._updateRendererShadow(e),this._updateRendererSortObjects(e),this._updateRendererPixelRatio(e)}_traverseSceneAndUpdateMaterials(){this.scene().threejsScene().traverse(e=>{const t=e.material;if(t)if(_t(t))for(const r of t)r.needsUpdate=!0;else t.needsUpdate=!0})}static PARAM_CALLBACK_updateToneMapping(e){e._rendererByCanvas.forEach((t,r)=>{e._updateRendererToneMapping(t)})}static PARAM_CALLBACK_updateToneMappingExposure(e){e._rendererByCanvas.forEach((t,r)=>{e._updateRendererToneMappingExposure(t)})}static PARAM_CALLBACK_updateOutputColorSpace(e){e._rendererByCanvas.forEach((t,r)=>{e._updateRendererOutputColorSpace(t)})}static PARAM_CALLBACK_updateShadow(e){e._rendererByCanvas.forEach((t,r)=>{e._updateRendererShadow(t)})}static PARAM_CALLBACK_updateSortObjects(e){e._rendererByCanvas.forEach((t,r)=>{e._updateRendererSortObjects(t)})}static PARAM_CALLBACK_updatePixelRatio(e){e._rendererByCanvas.forEach((t,r)=>{e._updateRendererPixelRatio(t)}),globalThis.dispatchEvent(new Event("resize"))}_updateRendererToneMapping(e){e.toneMapping=this.pv.toneMapping}_updateRendererToneMappingExposure(e){e.toneMappingExposure=this.pv.toneMappingExposure}_updateRendererOutputColorSpace(e){const t=this.pv.outputColorSpace;t!=e.outputColorSpace&&(e.outputColorSpace=t)}_updateRendererShadow(e){e.shadowMap.enabled=this.pv.tshadowMap,e.shadowMap.autoUpdate=this.pv.shadowMapAutoUpdate,e.shadowMap.needsUpdate=this.pv.shadowMapNeedsUpdate,e.shadowMap.type=this.pv.shadowMapType}_updateRendererSortObjects(e){e.sortObjects=this.pv.sortObjects}_updateRendererPixelRatio(e){const t=this.pv.tpixelRatio?this.pv.pixelRatio:Uw();ve.renderersController.printDebug()&&(ve.renderersController.printDebugMessage(`set renderer pixelRatio from '${this.path()}'`),ve.renderersController.printDebugMessage({pixelRatio:t})),e.setPixelRatio(t)}setToneMapping(e){this.p.toneMapping.set(e)}}const y9=!1,bS=1,Hw=class{static renderer(n){return this._renderersByCanvas.get(n)}static rendererNode(n){const{scene:e,camera:t}=n,r=Ut(t).attribValue(t,et.RENDERER_NODE_ID);if(r&&Ye(r))return e.graph.nodeFromId(r)}static rendererConfig(n){const{canvas:e,scene:t}=n,r=ve.renderersController.getRenderingContext(e);if(!r){console.error("failed to create webgl context");return}let s,i;const o=this.rendererNode(n);if(o!=null&&o instanceof rs&&o.context()==be.ROP)switch(o.type()){case fc.WEBGL:{s=o.createRenderer(e,r),i=o;break}case fc.PATH_TRACING:{s=o.renderer(e,r),i=o;break}}return s||(s=this._defaultRendererByContext.get(r),s||(s=Hw.createDefaultRenderer(e,r),this._defaultRendererByContext.set(r,s))),t.renderersRegister.registerRenderer(s),this._renderersByCanvas.set(e,s),s?{renderer:s,rendererNode:i}:void 0}static setRendererSize(n,e){const t=this.renderer(n);t&&t.setSize(bS*e.x,bS*e.y,y9)}static createDefaultRenderer(n,e){const t=ve.renderersController.defaultWebGLRendererForCanvas(n),r=Uw();return t.setPixelRatio(r),t.shadowMap.enabled=!0,t.shadowMap.type=zw,t.toneMapping=Gw,t.toneMappingExposure=1,t.outputColorSpace=kw,ve.renderersController.printDebug()&&ve.renderersController.printDebugMessage("create default renderer"),t}};let sp=Hw;sp._defaultRendererByContext=new Map;sp._renderersByCanvas=new Map;class x9{static isPostProcessNetworkNode(e){return e.type()==Ac.POST||e.context()==be.SOP&&e.type()==zo.POST_PROCESS}static createComposer(e){const{renderer:t,scene:r,renderScene:s,camera:i,viewer:o}=e;let a;const c=Ut(i).attribValue(i,et.POST_PROCESS_NODE_ID);if(c&&Ye(c)){const l=r.graph.nodeFromId(c);l&&l instanceof rs&&this.isPostProcessNetworkNode(l)&&(a=l)}if(a&&t instanceof bs)return a.effectsComposerController.createEffectsComposerAndBuildPasses({renderer:t,scene:s,camera:i,viewer:o})}}class b9{static isCSSRendererNode(e){return e.type()==fc.CSS2D||e.type()==fc.CSS3D}static cssRendererConfig(e){const{canvas:t,scene:r,camera:s}=e,i=Ut(s).attribValue(s,et.CSS_RENDERER_NODE_ID);if(i==null||!Ye(i))return;const o=r.graph.nodeFromId(i);if(!o||!this.isCSSRendererNode(o))return;const a=o;return a.compute(),{cssRenderer:a.renderer(t),cssRendererNode:a}}}class C9{constructor(e){this.options=e}createViewerElement(e){const{viewerId:t,html:r}=this.options,{domElement:s,canvas:i,CSSClass:o}=e,c=document.createElement("div");c.style.height="100%",c.innerHTML=r,s==null||s.appendChild(c),c.classList.add(o);const l=c.querySelector(`#${t}`);if(!l){console.error(`failed to find element with id ${t}`);return}l.appendChild(i);function u(h){const d=h.querySelectorAll("script");Array.from(d).forEach(p=>{var _;const g=document.createElement("script");Array.from(p.attributes).forEach(f=>{g.setAttribute(f.name,f.value)}),g.text=p.text,(_=p.parentNode)==null||_.replaceChild(g,p)})}return u(c),l}}class E9{static viewerCodeConfig(e){const{camera:t}=e,r=Ut(t),s=r.attribValue(t,et.VIEWER_ID),i=r.attribValue(t,et.VIEWER_HTML);if(!(s==null||i==null))return new C9({viewerId:s,html:i})}}class S9{static controlsNode(e){const{scene:t,camera:r}=e;let s;const i=Ut(r).attribValue(r,et.CONTROLS_NODE_ID);if(i&&Ye(i)){const o=t.graph.nodeFromId(i);o&&o.applyControls&&(s=o)}return s}}class A9{static isRenderSceneNode(e){return e.type()==_0.SCENE}static renderScene(e){const{scene:t,camera:r}=e;let s;const i=Ut(r).attribValue(r,et.RENDER_SCENE_NODE_ID);if(i&&Ye(i)){const o=t.graph.nodeFromId(i);if(o&&o instanceof rs&&this.isRenderSceneNode(o))return s=o,s.object}}}const T9=["connected","disconnected","select","selectstart","selectend"];function M9(){const n=new Map;let e=0;for(const t of T9)n.set(t,e),e++;return n}M9();const R9=["viewer","local","local-floor","bounded-floor","unbounded"],w9=["local-floor","bounded-floor","hand-tracking","layers"],O9=["hit-test","light-estimation"];function CS(n,e,t){const r=[],s=Ut(n).attribValue(n,e),i=s==null?void 0:s.split(" ");if(i)for(const o of i)t.includes(o)&&r.push(o);return r}function ES(n,e,t){const r=CS(n,t.optional,e);return{requiredFeatures:CS(n,t.required,e),optionalFeatures:r}}function SS(n,e){const t=Ut(n);let r=t.attribValue(n,e.override),s=t.attribValue(n,e.type);return s&&R9.includes(s)||(r=!1,s=void 0),{overrideReferenceSpaceType:r,referenceSpaceType:s}}class P9{static process(e){const{camera:t,scene:r,renderer:s,canvas:i}=e,o=[],a=[],c=[],l=()=>{for(const _ of a)_()},u=()=>{for(const _ of c)_()},h=Ut(t);if(h.attribValue(t,et.WEBXR_AR)==!0){const _=r.webXR.ARControllerCreateFunction();if(_){const{overrideReferenceSpaceType:g,referenceSpaceType:f}=SS(t,{type:et.WEBXR_AR_OVERRIDE_REFERENCE_SPACE_TYPE,override:et.WEBXR_AR_REFERENCE_SPACE_TYPE}),{requiredFeatures:m,optionalFeatures:y}=ES(t,O9,{optional:et.WEBXR_AR_FEATURES_OPTIONAL,required:et.WEBXR_AR_FEATURES_REQUIRED}),v=_(s,t,i,{overrideReferenceSpaceType:g||!1,referenceSpaceType:f,requiredFeatures:m,optionalFeatures:y});o.push(v)}}if(h.attribValue(t,et.WEBXR_VR)==!0){const _=r.webXR.VRControllerCreateFunction();if(_){const{overrideReferenceSpaceType:g,referenceSpaceType:f}=SS(t,{type:et.WEBXR_VR_OVERRIDE_REFERENCE_SPACE_TYPE,override:et.WEBXR_VR_REFERENCE_SPACE_TYPE}),{requiredFeatures:m,optionalFeatures:y}=ES(t,w9,{optional:et.WEBXR_VR_FEATURES_OPTIONAL,required:et.WEBXR_VR_FEATURES_REQUIRED}),v=_(s,t,i,{overrideReferenceSpaceType:g||!1,referenceSpaceType:f,requiredFeatures:m,optionalFeatures:y});o.push(v)}}for(const _ of o)a.push(()=>_.mount()),c.push(()=>_.unmount());return{mountFunction:l,unmountFunction:u}}}var ip=(n=>(n.WEBCAM="webcam",n.IMAGE="image",n.VIDEO="video",n))(ip||{});const w0=["webcam","image","video"];var jw=(n=>(n.CAMERA="camera",n.MARKER="marker",n))(jw||{});const O0=["camera","marker"],Ww=class extends Ft{static type(){return zo.WEBXR_AR_MARKER_TRACKING}cook(n,e){var t;const r=n[0],s=Qr.filterObjects(r,{group:e.group});return ve.thirdParty.markerTracking().hasController()?this._node&&Ww.updateObject({scene:this._node.scene(),objects:s,params:e,active:!0}):(t=this._node)==null||t.states.error.set("This node requires the plugin-marker-tracking. See [https://github.com/polygonjs/plugin-marker-tracking](https://github.com/polygonjs/plugin-marker-tracking)"),r}static updateObject(n){const{objects:e,params:t,active:r}=n;for(let s of e){Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING,r);const i=w0[t.sourceMode];Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING_SOURCE_MODE,i),Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING_SOURCE_URL,t.sourceUrl);const o=O0[t.transformMode];Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING_TRANSFORM_MODE,o),Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING_SMOOTH,t.smooth),Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING_SMOOTH_COUNT,t.smoothCount),Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING_BAR_CODE_TYPE,t.barCodeType),Gt.addAttribute(s,et.WEBXR_AR_MARKER_TRACKING_BAR_CODE_VALUE,t.barCodeValue)}}};let P0=Ww;P0.DEFAULT_PARAMS={group:"",sourceMode:w0.indexOf(ip.WEBCAM),sourceUrl:"",transformMode:O0.indexOf(jw.CAMERA),smooth:!0,smoothCount:5,barCodeType:ve.thirdParty.markerTracking().barCodeTypes()[0]||"",barCodeValue:0};P0.INPUT_CLONED_STATE=Mt.FROM_NODE;P0.DEFAULT_PARAMS;class N9{static process(e){const{canvas:t,scene:r,camera:s,onError:i}=e,o=Ut(s);if(!o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING))return;const c=o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING_SOURCE_MODE),l=o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING_SOURCE_URL),u=o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING_BAR_CODE_TYPE),h=o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING_BAR_CODE_VALUE),d=o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING_TRANSFORM_MODE);if(c==null||u==null||h==null||d==null||!w0.includes(c)||[ip.IMAGE,ip.VIDEO].includes(c)&&l==null||!Ke(u)||!Ke(d)||!ve.thirdParty.markerTracking().barCodeTypes().includes(u)||!O0.includes(d)||!Ye(h))return;const p=o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING_SMOOTH)||!1,_=o.attribValue(s,et.WEBXR_AR_MARKER_TRACKING_SMOOTH_COUNT)||0;try{const g=ve.thirdParty.markerTracking().createController({sourceMode:c,sourceUrl:l,canvas:t,camera:s,scene:r.threejsScene(),transformMode:d,barCode:{type:u,value:h},smooth:{active:p,count:_}}),f=g==null?void 0:g.errorMessage();return f?i(f):g||i("failed to create the MarkerTracking controller. Make sure you have loaded the plugin. See: `https://polygonjs.com/markerTracking`"),g==null?void 0:g.config()}catch{i("There was an unknown error while using the MarkerTracking plugin")}}}const Xw=class extends Ft{static type(){return zo.FPS}cook(n,e){const t=n[0],r=Qr.filterObjects(t,{group:e.group});return this._node&&Xw.updateObject({objects:r,params:e}),t}static updateObject(n){const{objects:e,params:t}=n;for(let r of e)Gt.addAttribute(r,et.MAX_FPS,t.maxFPS),Gt.addAttribute(r,et.MAX_FPS_DYNAMIC_CHANGE,t.allowDynamicChange)}};let N0=Xw;N0.DEFAULT_PARAMS={group:"",maxFPS:60,allowDynamicChange:!1};N0.INPUT_CLONED_STATE=Mt.FROM_NODE;N0.DEFAULT_PARAMS;const Bm=n=>1/n,I9=.1;function D9(n,e){const t=e.minDelta();if(n>t)return!0;const r=t-n;return!(r>0&&r/t>I9)}class L9{static viewerFPSConfig(e){const{camera:t}=e,r=()=>Ut(t).attribValue(t,et.MAX_FPS),s=r();if(s==null)return;const i=Bm(s);if(Ut(t).attribValue(t,et.MAX_FPS_DYNAMIC_CHANGE)||!1){const a=Bm(60);return{minDelta:()=>{const l=r();return l==null?a:Bm(l)}}}else return{minDelta:()=>i}}}const AS="CoreThreejsViewer";class F9 extends Fw{constructor(e){super(e),this._animateWebBound=this._animateWeb.bind(this),this._accumulatedDelta=0,this._onResizeBound=this.onResize.bind(this),this._setupFunctions(e)}static _canvasIdPrefix(){return"ThreejsViewer"}rendererConfig(){return this._rendererConfig}_setupFunctions(e){var t;const r=this.camera(),s=this.scene(),i=this.canvas(),o=s.threejsScene();this._errorMessage=void 0,this._renderer=e.renderer,this._renderer||(this._rendererConfig=sp.rendererConfig({camera:r,scene:s,canvas:i}),this._rendererConfig&&(this._renderer=this._rendererConfig.renderer));const a=this._renderer;if(a||console.error("no renderer"),a){const l=A9.renderScene({camera:r,scene:s})||o;this._effectComposer=x9.createComposer({camera:r,scene:s,renderScene:l,renderer:a,viewer:this});const u=this._effectComposer;a instanceof bs&&(this._webXRConfig=P9.process({camera:r,scene:s,renderer:a,canvas:this.canvas()}),this._markerTrackingConfig=N9.process({canvas:i,camera:r,scene:s,onError:d=>{this._errorMessage=d}})),this._codeConfig=E9.viewerCodeConfig({camera:r}),this._cssRendererConfig=b9.cssRendererConfig({scene:s,camera:r,canvas:i});const h=(t=this._cssRendererConfig)==null?void 0:t.cssRenderer;return this._renderCSSFunc=h?()=>h.render(l,r):void 0,this._controlsNode=S9.controlsNode({camera:r,scene:s}),this._FPSConfig=L9.viewerFPSConfig({camera:r}),u?this._renderFunc=d=>u.render(d):this._renderFunc=()=>a.render(l,r),{renderer:a,renderScene:l,camera:r}}}mount(e,t){var r,s,i;super.mount(e,t);const o=this.canvas(),a=d=>{if(this._domElement)return d.createViewerElement({domElement:this._domElement,canvas:o,CSSClass:AS})},c=()=>{var d,p;return(d=this._domElement)==null||d.appendChild(o),(p=this._domElement)==null||p.classList.add(AS),this._domElement},l=this._codeConfig?a(this._codeConfig):c(),u=(r=this._cssRendererConfig)==null?void 0:r.cssRendererNode;u&&u.mountRenderer(o),(s=this._webXRConfig)==null||s.mountFunction(),(i=this._markerTrackingConfig)==null||i.mountFunction(),this._build(),this._setEvents();const h=o.parentElement;if(h&&this._createResizeObserver(h),this.onResize(),this._errorMessage){const d=document.createElement("div");d.style.position="absolute",d.style.top="0px",d.style.width="100%",d.style.color="red",d.style.backgroundColor="white",d.style.padding="20px",d.style.textAlign="center",d.style.opacity="90%",d.innerText=this._errorMessage,l==null||l.append(d)}}_build(){this._initDisplay(),this.activate()}dispose(){var e,t,r;const s=this.canvas(),i=(e=this._cssRendererConfig)==null?void 0:e.cssRendererNode;i&&i.unmountRenderer(s),this._cssRendererConfig=void 0,(t=this._webXRConfig)==null||t.unmountFunction(),(r=this._markerTrackingConfig)==null||r.unmountFunction(),this._effectComposer=void 0,this.setAutoRender(!1),this._cancelAnimate(),this._unlistenToWindowResize(),this._disposeResizeObserver(),super.dispose()}_setEvents(){this.eventsController().init(),this.webglController().init(),this._unlistenToWindowResize(),this._listenToWindowResize()}_initDisplay(){if(!this._canvas){console.warn("no canvas found for viewer");return}if(!this._renderer)return;const e=this._renderer.getPixelRatio();this.camerasController().computeSizeAndAspect(e),this.audioController().update(),this._startAnimate()}setAutoRender(e=!0,t){super.setAutoRender(e),this._doRender&&this._requestAnimationFrameId==null&&this._startAnimate(),this._doRender||t&&t.cancelAnimate==!0&&this._cancelAnimate()}isXR(){return this._renderer?this._renderer instanceof bs&&this._renderer.xr.enabled:!1}_startAnimate(){if(this.isXR()){const e=this._renderer;if(!e)return;const t=this.scene().webXR,r=(s,i)=>{var o;(o=t.activeXRController())==null||o.process(i),this._animateWebXR()};e.setAnimationLoop(r)}else this._animateWeb()}_cancelAnimate(){var e;this.isXR()?(e=this._renderer)==null||e.setAnimationLoop(null):this._cancelAnimateCommon()}_animateWeb(){this._requestAnimationFrameId=requestAnimationFrame(this._animateWebBound),this.__animateCommon__()}_animateWebXR(){this.__animateCommon__()}__animateCommon__(){const e=this._scene.timeController.updateClockDelta();if(this._FPSConfig){if(this._accumulatedDelta+=e,!D9(this._accumulatedDelta,this._FPSConfig))return;this._accumulatedDelta=0}this._tickAndRender(e)}_cancelAnimateCommon(){this._doRender=!1,this._requestAnimationFrameId!=null&&(cancelAnimationFrame(this._requestAnimationFrameId),this._requestAnimationFrameId=void 0),this._canvas}_tick(e){var t;super._tick(e),(t=this._markerTrackingConfig)==null||t.renderFunction()}renderer(){return this._renderer}effectComposer(){return this._effectComposer}preCompile(){this._renderer&&this._renderer.compile(this._scene.threejsScene(),this._camera)}markAsReady(){this.preCompile(),this.setAutoRender(!0)}onResize(){this.updateSize()&&(this._updateRendererSize(),this._renderFunc&&this._renderFunc(this.scene().timeController.delta()),this._runOnResizeCallbacks())}updateSize(){const e=this._renderer;if(!e)return!1;const t=e.getPixelRatio();this.camerasController().computeSizeAndAspect(t);const r=this.camerasController().size;return this._size.equals(r)?!1:(this._size.copy(r),this._scene.viewersRegister.markViewerAsSizeUpdated(this),!0)}_updateRendererSize(){var e,t;const r=this._canvas;r&&(sp.setRendererSize(r,this._size),(e=this._cssRendererConfig)==null||e.cssRenderer.setSize(this._size.x,this._size.y),(t=this._effectComposer)==null||t.setSize(this._size.x,this._size.y),this.camerasController().updateCameraAspect())}_listenToWindowResize(){}_unlistenToWindowResize(){}_createResizeObserver(e){this._disposeResizeObserver(),this._resizeObserver=new ResizeObserver(this._onResizeBound),this._resizeObserver.observe(e,{box:"border-box"})}_disposeResizeObserver(){this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=void 0)}}var Pl=(n=>(n.DEFAULT="default",n.COVER="cover",n.CONTAIN="contain",n))(Pl||{});const U9=["default","cover","contain"];class TS{static frameMode(e){return this._getFrameMode(e)||Pl.DEFAULT}static expectedAspectRatio(e){return Ut(e).attribValue(e,et.FRAME_MODE_EXPECTED_ASPECT_RATIO)}static _getFrameMode(e){const t=Ut(e).attribValue(e,et.FRAME_MODE);if(t&&Ye(t))return U9[t]}}function k9(n,e,t){t.set(0,0),n.attribValue(e,et.VIEW_OFFSET_MIN,0,t)}function B9(n,e,t){t.set(1,1),n.attribValue(e,et.VIEW_OFFSET_MAX,0,t)}const Gm=new W,Vm=new W;function G9(n,e){const t=Ut(n),r=t.hasAttribute(n,et.VIEW_OFFSET_MIN),s=t.hasAttribute(n,et.VIEW_OFFSET_MAX);r&&s&&(k9(t,n,Gm),B9(t,n,Vm),n.setViewOffset(e.x,e.y,Gm.x*e.x,Gm.y*e.y,Vm.x*e.x,Vm.y*e.y))}class V9{static updateCameraAspect(e,t,r){e.aspect=t;const s=(r==null?void 0:r.cameraWithAttributes)||e,i=TS.frameMode(s),o=TS.expectedAspectRatio(s),a=Ut(s).attribValue(s,v0.FOV);a!=null&&o!=null&&this._update({mode:i,camera:e,fov:a,expectedAspectRatio:o}),r&&r.resolution&&G9(e,r.resolution),e.updateProjectionMatrix()}static _update(e){const t=e.mode;switch(t){case Pl.DEFAULT:return this._adjustFOVFromModeDefault(e);case Pl.COVER:return this._adjustFOVFromModeCover(e);case Pl.CONTAIN:return this._adjustFOVFromModeContain(e)}St.unreachable(t)}static _adjustFOVFromModeDefault(e){e.camera.fov=e.fov}static _adjustFOVFromModeCover(e){if(e.camera.aspect>e.expectedAspectRatio){const t=Math.tan(On.degToRad(e.fov/2)),r=e.camera.aspect/e.expectedAspectRatio,s=t/r;e.camera.fov=On.radToDeg(Math.atan(s))*2}else e.camera.fov=e.fov}static _adjustFOVFromModeContain(e){if(e.camera.aspect>e.expectedAspectRatio)e.camera.fov=e.fov;else{const t=Math.tan(On.degToRad(e.fov/2)),r=e.camera.aspect/e.expectedAspectRatio,s=t/r;e.camera.fov=On.radToDeg(Math.atan(s))*2}}}const $w={fov:50,fovRange:[.001,180]},qw=n=>{n.registerCameraNodeType(lc.PERSPECTIVE),n.registerCamera(Un,e=>new F9({...e,updateCameraAspect:(r,s)=>{V9.updateCameraAspect(e.camera,r,{resolution:s})}}))},nd=new T,tn=new Un;function z9(){const n=new sn,e=new xe(16755200),t=new xe(16711680),r=new xe(43775),s=new xe(16777215),i=new xe(3355443),o=[],a=[],c={};function l(h,d,p){u(h,p),u(d,p)}function u(h,d){o.push(0,0,0),a.push(d.r,d.g,d.b),c[h]===void 0&&(c[h]=[]),c[h].push(o.length/3-1)}return l("n1","n2",e),l("n2","n4",e),l("n4","n3",e),l("n3","n1",e),l("f1","f2",e),l("f2","f4",e),l("f4","f3",e),l("f3","f1",e),l("n1","f1",e),l("n2","f2",e),l("n3","f3",e),l("n4","f4",e),l("p","n1",t),l("p","n2",t),l("p","n3",t),l("p","n4",t),l("u1","u2",r),l("u2","u3",r),l("u3","u1",r),l("c","t",s),l("p","c",i),l("cn1","cn2",i),l("cn3","cn4",i),l("cf1","cf2",i),l("cf3","cf4",i),n.setAttribute("position",new gt(o,3)),n.setAttribute("color",new gt(a,3)),{geometry:n,pointMap:c}}function H9(){return new Cs({color:16777215,vertexColors:!0,toneMapped:!1})}class I0 extends ic{constructor(e){super(),this._pointMap={},this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.name="CameraHelper",this.type="CameraHelper",this.matrixAutoUpdate=!1;const{geometry:t,pointMap:r}=z9();this.geometry=t,this._pointMap=r,this.material=H9()}clone(){return new I0(this.camera)}update(){const e=this.geometry,t=this._pointMap,r=1,s=1;tn.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),cn("c",t,e,tn,0,0,-1),cn("t",t,e,tn,0,0,1),cn("n1",t,e,tn,-r,-s,-1),cn("n2",t,e,tn,r,-s,-1),cn("n3",t,e,tn,-r,s,-1),cn("n4",t,e,tn,r,s,-1),cn("f1",t,e,tn,-r,-s,1),cn("f2",t,e,tn,r,-s,1),cn("f3",t,e,tn,-r,s,1),cn("f4",t,e,tn,r,s,1),cn("u1",t,e,tn,r*.7,s*1.1,-1),cn("u2",t,e,tn,-r*.7,s*1.1,-1),cn("u3",t,e,tn,0,s*2,-1),cn("cf1",t,e,tn,-r,0,1),cn("cf2",t,e,tn,r,0,1),cn("cf3",t,e,tn,0,-s,1),cn("cf4",t,e,tn,0,s,1),cn("cn1",t,e,tn,-r,0,-1),cn("cn2",t,e,tn,r,0,-1),cn("cn3",t,e,tn,0,-s,-1),cn("cn4",t,e,tn,0,s,-1),e.getAttribute("position").needsUpdate=!0}}function cn(n,e,t,r,s,i,o){nd.set(s,i,o).unproject(r);const a=e[n];if(a!==void 0){const c=t.getAttribute("position");for(let l=0,u=a.length;l<u;l++)c.setXYZ(a[l],nd.x,nd.y,nd.z)}}function Yw(n){const e=n.copy.bind(n);n.copy=function(t,r){const s=e(t,r);return s.map=t.map,Yw(s),s}}var lu=(n=>(n.PERSPECTIVE_CAMERA="perspectiveCamera",n.PERSPECTIVE_CAMERA_UPDATE="perspectiveCameraUpdate",n.AREA_LIGHT="areaLight",n.SPOT_LIGHT="spotLight",n.SPOT_LIGHT_UPDATE="spotLightUpdate",n))(lu||{});const j9=n=>{Ip({type:Tt.PERSPECTIVE_CAMERA,checkFunc:i=>{if(i.isPerspectiveCamera)return Tt.PERSPECTIVE_CAMERA},ctor:Un,humanName:"PerspectiveCamera"});const{fov:e,aspect:t,near:r,far:s}=n;return new Un(e,t,r,s)},W9=n=>{},X9=n=>{Ip({type:Tt.AREA_LIGHT,checkFunc:i=>{if(i.isRectAreaLight)return Tt.AREA_LIGHT},ctor:Wx,humanName:"AreaLight"});const{color:e,intensity:t,width:r,height:s}=n;return new Wx(e,t,r,s)},$9=()=>{Ip({type:Tt.SPOT_LIGHT,checkFunc:e=>{if(e.isSpotLight)return Tt.SPOT_LIGHT},ctor:jx,humanName:Tt.SPOT_LIGHT});const n=new jx;return Yw(n),n},q9=n=>{};class D0{constructor(){this._generators={perspectiveCamera:j9,perspectiveCameraUpdate:W9,areaLight:X9,spotLight:$9,spotLightUpdate:q9}}static instance(){return this._instance=this._instance||new D0}generator(e){return this._generators[e]}registerGenerator(e,t){this._generators[e]=t}}const op=D0.instance(),_g=class extends Ft{static type(){return lc.PERSPECTIVE}cook(n,e){const t=_g.createCamera(e,this._node);t.name=e.name||lc.PERSPECTIVE,t.position.copy(e.position),t.rotation.set(On.degToRad(e.rotation.x),On.degToRad(e.rotation.y),On.degToRad(e.rotation.z)),t.updateWorldMatrix(!1,!1),t.updateProjectionMatrix(),t.matrixAutoUpdate=e.matrixAutoUpdate,_g.setCameraAttributes(t,e),op.generator(lu.PERSPECTIVE_CAMERA_UPDATE)({camera:t,params:{apertureBlades:e.apertureBlades,fStop:e.fStop,focusDistance:e.focusDistance,apertureRotation:e.apertureRotation,anamorphicRatio:e.anamorphicRatio}});const s=[t];if(e.showHelper){const i=new I0(t);i.update(),t.add(i)}return this.createCoreGroupFromObjects(s)}static createCamera(n,e){const t=op.generator(lu.PERSPECTIVE_CAMERA)({fov:n.fov,aspect:1,near:n.near,far:n.far});return e&&Gt.addAttribute(t,et.NODE_ID,e.graphNodeId()),t}static setCameraAttributes(n,e){Gt.addAttribute(n,v0.FOV,e.fov)}};let Ou=_g;Ou.DEFAULT_PARAMS={fov:$w.fov,near:nS.near,far:nS.far,position:new T(0,0,0),rotation:new T(0,0,0),showHelper:!1,matrixAutoUpdate:!0,name:lc.PERSPECTIVE,apertureBlades:6,fStop:.6,focusDistance:10,apertureRotation:0,anamorphicRatio:1};Ou.INPUT_CLONED_STATE=Mt.NEVER;Ou.onRegister=qw;const rd=[0,0,0];async function Y9(n){const t=`*/${n.p.name.value}`,r=n.scene().objectsController.findObjectByMask(t);r&&(n.p.position.set(r.position.toArray()),r.rotation.toArray(rd),rd.forEach((s,i)=>rd[i]=On.radToDeg(s)),n.p.rotation.set(rd))}const oo=Ou.DEFAULT_PARAMS;class K9 extends Et{constructor(){super(...arguments),this.default=A.FOLDER(),this.fov=A.FLOAT(oo.fov,{range:$w.fovRange,rangeLocked:[!0,!1]}),this.near=A.FLOAT(oo.near,{range:[0,100],rangeLocked:[!0,!1]}),this.far=A.FLOAT(oo.far,{range:[0,100],rangeLocked:[!0,!1]}),this.position=A.VECTOR3(oo.position),this.rotation=A.VECTOR3(oo.rotation),this.showHelper=A.BOOLEAN(oo.showHelper),this.matrixAutoUpdate=A.BOOLEAN(oo.matrixAutoUpdate),this.name=A.STRING("`$OS`"),this.updateTransformFromCamera=A.BUTTON(null,{callback:e=>{Y9(e)}}),this.PBR=A.FOLDER(),this.apertureBlades=A.INTEGER(6,{range:[0,10],rangeLocked:[!0,!1]}),this.fStop=A.FLOAT(.5,{range:[.02,20],rangeLocked:[!0,!1]}),this.focusDistance=A.FLOAT(10,{range:[0,100],rangeLocked:[!0,!1]}),this.apertureRotation=A.FLOAT(0,{range:[0,12.5],rangeLocked:[!0,!1]}),this.anamorphicRatio=A.FLOAT(1,{range:[.1,10],rangeLocked:[!0,!1]})}}const Z9=new K9;class Kw extends zt{constructor(){super(...arguments),this.paramsConfig=Z9}static type(){return lc.PERSPECTIVE}initializeNode(){this.io.inputs.setCount(0)}cook(e){this._operation=this._operation||new Ou(this._scene,this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}}Kw.onRegister=qw;const J9=new T(0,1,0),Q9=new T(-1,0,0),zm=new qe,Hm=new qe,jm=new qe,Wm=new qe,Ra={t:new T,q:new Qt,s:new T};class MS{static matrix(e,t){zm.identity(),Hm.identity(),jm.identity(),Wm.identity(),zm.makeTranslation(e.center.x,e.center.y,e.center.z),Hm.makeRotationAxis(J9,On.degToRad(e.longitude)),jm.makeRotationAxis(Q9,On.degToRad(e.latitude)),Wm.makeTranslation(0,0,e.depth),t.copy(zm).multiply(Hm).multiply(jm).multiply(Wm)}static applyMatrixToObject(e,t){t.decompose(Ra.t,Ra.q,Ra.s),e.position.copy(Ra.t),e.quaternion.copy(Ra.q),e.scale.copy(Ra.s),e.updateMatrix()}}class uu extends Ft{constructor(){super(...arguments),this._fullMatrix=new qe}static type(){return"polarTransform"}cook(e,t){const r=e[0].threejsObjects();return MS.matrix(t,this._fullMatrix),this._applyTransform(r,t,this._fullMatrix),e[0]}_applyTransform(e,t,r){const s=nr[t.applyOn];switch(s){case hr.GEOMETRY:return this._applyMatrixToGeometries(e,r);case hr.OBJECT:return this._applyMatrixToObjects(e,r)}St.unreachable(s)}_applyMatrixToGeometries(e,t){for(let r of e){const s=r.geometry;s&&s.applyMatrix4(t)}}_applyMatrixToObjects(e,t){for(let r of e)MS.applyMatrixToObject(r,t)}}uu.DEFAULT_PARAMS={applyOn:nr.indexOf(hr.OBJECT),center:new T(0,0,0),longitude:0,latitude:0,depth:1};uu.INPUT_CLONED_STATE=Mt.FROM_NODE;const sl=uu.DEFAULT_PARAMS;class eK extends Et{constructor(){super(...arguments),this.applyOn=A.INTEGER(sl.applyOn,{menu:{entries:nr.map((e,t)=>({name:e,value:t}))}}),this.center=A.VECTOR3(sl.center.toArray()),this.longitude=A.FLOAT(sl.longitude,{range:[-360,360]}),this.latitude=A.FLOAT(sl.latitude,{range:[-180,180]}),this.depth=A.FLOAT(sl.depth,{range:[0,10]})}}const tK=new eK;class nK extends zt{constructor(){super(...arguments),this.paramsConfig=tK}static type(){return rn.POLAR_TRANSFORM}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(uu.INPUT_CLONED_STATE)}cook(e){this._operation=this._operation||new uu(this.scene(),this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}setApplyOn(e){this.p.applyOn.set(nr.indexOf(e))}}class L0 extends Ft{static type(){return"restAttributes"}cook(e,t){const s=e[0].threejsObjectsWithGeo();return t.tposition&&this._create_rest_attribute(s,t.position,t.restP),t.tnormal&&this._create_rest_attribute(s,t.normal,t.restN),this.createCoreGroupFromObjects(s)}_create_rest_attribute(e,t,r){for(let s of e){const i=s.geometry;if(i){const o=i.getAttribute(t);o&&i.setAttribute(r,o.clone())}}}}L0.DEFAULT_PARAMS={tposition:!0,position:"position",restP:"restP",tnormal:!0,normal:"normal",restN:"restN"};const wa=L0.DEFAULT_PARAMS;class rK extends Et{constructor(){super(...arguments),this.tposition=A.BOOLEAN(wa.tposition),this.position=A.STRING(wa.position,{visibleIf:{tposition:!0}}),this.restP=A.STRING(wa.restP,{visibleIf:{tposition:!0}}),this.tnormal=A.BOOLEAN(wa.tnormal),this.normal=A.STRING(wa.normal,{visibleIf:{tnormal:!0}}),this.restN=A.STRING(wa.restN,{visibleIf:{tnormal:!0}})}}const sK=new rK;class iK extends zt{constructor(){super(...arguments),this.paramsConfig=sK}static type(){return"restAttributes"}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState([Mt.FROM_NODE])}cook(e){this._operation=this._operation||new L0(this.scene(),this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}}const oK=`varying vec3 vNormal;
varying vec3 vWorldPosition;
varying vec3 vWorldOrigin;

void main(){
	// compute intensity
	vNormal		= normalize( normalMatrix * normal );

	vec4 worldPosition	= modelMatrix * vec4( position, 1.0 );
	vWorldPosition		= worldPosition.xyz;

	vec4 worldOrigin	= modelMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
	vWorldOrigin		= worldOrigin.xyz;

	// set gl_Position
	gl_Position	= projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,aK=`varying vec3 vNormal;
varying vec3 vWorldPosition;
varying vec3 vWorldOrigin;

uniform vec3 lightColor;

// uniform vec3 spotPosition;

uniform float attenuation;
uniform float anglePower;

void main(){

	//////////////////////////////////////////////////////////
	// distance attenuation   //
	//////////////////////////////////////////////////////////
	float intensity = distance(vWorldPosition, vWorldOrigin) / attenuation;
	intensity = 1.0 - clamp(intensity, 0.0, 1.0);

	//////////////////////////////////////////////////////////
	// intensity on angle   //
	//////////////////////////////////////////////////////////
	vec3 normal = vec3(vNormal.x, vNormal.y, abs(vNormal.z));
	float angleIntensity = pow( dot(normal, vec3(0.0, 0.0, 1.0)), anglePower );
	intensity = intensity * angleIntensity;
	// 'gl_FragColor = vec4( lightColor, intensity );

	//////////////////////////////////////////////////////////
	// final color   //
	//////////////////////////////////////////////////////////

	// set the final color
	gl_FragColor = vec4( lightColor, intensity);
}`,gg=class{constructor(n){this.container=n,this.object=new Jt,this._cone=new ic,this._lineMaterial=new Cs,this.object.name=`CoreSpotLightHelper_${this.container.nodeName}`,this.object.matrixAutoUpdate=!1,this.createAndBuildObject({helperSize:1})}createAndBuildObject(n){this.buildHelper(),this.update(n)}buildHelper(){this._cone.geometry=gg._buildConeGeometry(),this._cone.material=this._lineMaterial,this._cone.matrixAutoUpdate=!1,this._cone.name=`CoreSpotLightHelperCone_${this.container.nodeName}`,this.object.add(this._cone)}update(n){const e=this.container.light();gg.transformObject(this._cone,{sizeMult:n.helperSize,distance:e.distance,angle:e.angle}),this._lineMaterial.color.copy(e.color)}static transformObject(n,e){const t=(e.distance?e.distance:1e3)*e.sizeMult,r=t*Math.tan(e.angle);this._matrixScale.set(r,r,t),n.matrix.identity(),n.matrix.makeRotationX(Math.PI*1),n.matrix.scale(this._matrixScale)}static _buildConeGeometry(){const n=new sn,e=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let t=0,r=1,s=32;t<s;t++,r++){const i=t/s*Math.PI*2,o=r/s*Math.PI*2;e.push(Math.cos(i),Math.sin(i),1,Math.cos(o),Math.sin(o),1)}return n.setAttribute("position",new gt(e,3)),n}};let F0=gg;F0._matrixScale=new T;class cK{constructor(e){this.container=e}update(e){const t=this.container.light();if(e.tvolumetric){const r=this.object();F0.transformObject(r,{sizeMult:1,distance:t.distance,angle:t.angle});const s=r.material.uniforms;s.lightColor.value.copy(t.color),s.attenuation.value=e.volAttenuation,s.anglePower.value=e.volAnglePower,t.add(r)}else this._mesh&&t.remove(this._mesh)}object(){return this._mesh=this._mesh||this._createMesh()}_createMesh(){const i=new qg(1,1,128,32);i.applyMatrix4(new qe().makeTranslation(0,-.5*1,0)),i.applyMatrix4(new qe().makeRotationX(-Math.PI/2));const o=this._createMaterial(),a=new Jt(i,o);return a.matrixAutoUpdate=!1,a.name=`VolumetricSpotLight_${this.container.nodeName}`,o.uniforms.lightColor.value.set("white"),a}_createMaterial(){return new Kn({uniforms:{attenuation:{value:5},anglePower:{value:1.2},lightColor:{value:new xe("cyan")}},vertexShader:oK,fragmentShader:aK,transparent:!0,depthWrite:!1})}}const Zw={color:new xe(1,1,1),intensity:2,angle:45,penumbra:.1,decay:2,distance:100,showHelper:!1,helperSize:1,tmap:!1,map:new Zr(""),name:"pointLight",castShadow:!1,shadowAutoUpdate:!0,shadowUpdateOnNextRender:!1,shadowRes:new W(1024,1024),shadowBias:1e-4,shadowNear:.1,shadowFar:100,shadowRadius:0,tvolumetric:!1,volAttenuation:5,volAnglePower:10,raymarchingPenumbra:0,raymarchingShadowBiasAngle:.01,raymarchingShadowBiasDistance:.1},qt=Zw;function lK(n){return class extends n{constructor(){super(...arguments),this.light=A.FOLDER(),this.color=A.COLOR(qt.color.toArray(),{}),this.intensity=A.FLOAT(qt.intensity,{range:[0,10],rangeLocked:[!0,!1]}),this.angle=A.FLOAT(qt.angle,{range:[0,180],rangeLocked:[!0,!1]}),this.penumbra=A.FLOAT(qt.penumbra,{range:[0,1],rangeLocked:[!0,!0]}),this.decay=A.FLOAT(qt.decay,{range:[0,10],rangeLocked:[!0,!1]}),this.distance=A.FLOAT(qt.distance,{range:[0,100],rangeLocked:[!0,!1]}),this.showHelper=A.BOOLEAN(qt.showHelper),this.helperSize=A.FLOAT(qt.helperSize,{visibleIf:{showHelper:1}}),this.tmap=A.BOOLEAN(qt.tmap),this.map=A.NODE_PATH("",{nodeSelection:{context:be.COP},dependentOnFoundNode:!1,visibleIf:{tmap:1}}),this.name=A.STRING("`$OS`"),this.shadow=A.FOLDER(),this.castShadow=A.BOOLEAN(qt.castShadow),this.shadowAutoUpdate=A.BOOLEAN(qt.shadowAutoUpdate,{visibleIf:{castShadow:1}}),this.shadowUpdateOnNextRender=A.BOOLEAN(qt.shadowUpdateOnNextRender,{visibleIf:{castShadow:1,shadowAutoUpdate:0}}),this.shadowRes=A.VECTOR2(qt.shadowRes.toArray(),{visibleIf:{castShadow:1}}),this.shadowBias=A.FLOAT(qt.shadowBias,{visibleIf:{castShadow:1},range:[-.01,.01],rangeLocked:[!1,!1]}),this.shadowNear=A.FLOAT(qt.shadowNear,{visibleIf:{castShadow:1},range:[0,100],rangeLocked:[!0,!1]}),this.shadowFar=A.FLOAT(qt.shadowFar,{visibleIf:{castShadow:1},range:[0,100],rangeLocked:[!0,!1]}),this.shadowRadius=A.FLOAT(qt.shadowRadius,{visibleIf:{castShadow:1},range:[0,10],rangeLocked:[!0,!1]}),this.volumetric=A.FOLDER(),this.tvolumetric=A.BOOLEAN(qt.tvolumetric),this.volAttenuation=A.FLOAT(qt.volAttenuation,{range:[0,10],rangeLocked:[!0,!1]}),this.volAnglePower=A.FLOAT(qt.volAnglePower,{range:[0,20],rangeLocked:[!0,!1]}),this.raymarching=A.FOLDER(),this.raymarchingPenumbra=A.FLOAT(qt.raymarchingPenumbra),this.raymarchingShadowBiasAngle=A.FLOAT(qt.raymarchingShadowBiasAngle,{range:[0,1],rangeLocked:[!0,!1]}),this.raymarchingShadowBiasDistance=A.FLOAT(qt.raymarchingShadowBiasDistance,{range:[0,1],rangeLocked:[!0,!1]})}}}class U0 extends lr{constructor(e,t){super(),this.nodeName=t,this._target=new wt,this.matrixAutoUpdate=!1,this.params={showHelper:!1,helperSize:1,tvolumetric:!1,volAnglePower:1,volAttenuation:1},e.showHelper!=null&&(this.params.showHelper=e.showHelper),e.tvolumetric!=null&&(this.params.tvolumetric=e.tvolumetric),e.volAnglePower!=null&&(this.params.volAnglePower=e.volAnglePower),e.volAttenuation!=null&&(this.params.volAttenuation=e.volAttenuation),this._light=op.generator(lu.SPOT_LIGHT)(),op.generator(lu.SPOT_LIGHT_UPDATE)({spotLight:this._light,textureName:"IES_PROFILE_LM_63_1995"}),this._target.copy(this._light.target,!1),this._light.target=this._target,this._light.position.set(0,0,.01),this._light.target.position.set(0,0,-1),this._light.updateMatrix(),this._target.updateMatrix(),this._light.matrixAutoUpdate=!1,this._target.matrixAutoUpdate=!1,this.name=`SpotLightContainer_${this.nodeName}`,this._light.name=`SpotLight_${this.nodeName}`,this._target.name=`SpotLightDefaultTarget_${this.nodeName}`,this.add(this._light),this.add(this._target),this.updateHelper()}updateParams(e){e.showHelper!=null&&(this.params.showHelper=e.showHelper),e.helperSize!=null&&(this.params.helperSize=e.helperSize),e.tvolumetric!=null&&(this.params.tvolumetric=e.tvolumetric),e.volAnglePower!=null&&(this.params.volAnglePower=e.volAnglePower),e.volAttenuation!=null&&(this.params.volAttenuation=e.volAttenuation)}light(){return this._light}copy(e,t){const r=e.light();return this._light.copy(r),super.copy(e,!1),this.updateParams(e.params),this.updateHelper(),this._light.target=this._target,t&&this.updateVolumetric(),this}clone(e){const t=new U0(this.params,this.nodeName);return t.copy(this),t}updateHelper(){this.params.showHelper?(this.__helper__=this.__helper__||new F0(this),this.add(this.__helper__.object),this.__helper__.update({helperSize:this.params.helperSize})):this.__helper__&&this.remove(this.__helper__.object)}updateVolumetric(){this.params.tvolumetric?(this.__volumetric__=this.__volumetric__||new cK(this),this.__volumetric__.update(this.params)):this.__volumetric__&&this.__volumetric__.update(this.params)}}class k0 extends Ft{static type(){return"spotLight"}async cook(e,t){const r=this.createLight(t);return r.light().name=t.name,await this.updateLightParams(r,t),this.updateShadowParams(r,t),r.updateParams(t),r.updateHelper(),r.updateVolumetric(),this.createCoreGroupFromObjects([r])}createLight(e){var t;const r=new U0(e,((t=this._node)==null?void 0:t.name())||"_"),s=r.light();return s.matrixAutoUpdate=!1,s.castShadow=!0,s.shadow.bias=-.001,s.shadow.mapSize.x=1024,s.shadow.mapSize.y=1024,s.shadow.camera.near=.1,r}async updateLightParams(e,t){const r=e.light();r.color=t.color,r.intensity=t.intensity,r.angle=t.angle*(Math.PI/180),r.penumbra=t.penumbra,r.decay=t.decay,r.distance=t.distance,r.userData[Ws.PENUMBRA]=t.raymarchingPenumbra,r.userData[Ws.SHADOW_BIAS_ANGLE]=t.raymarchingShadowBiasAngle,r.userData[Ws.SHADOW_BIAS_DISTANCE]=t.raymarchingShadowBiasDistance,await this._updateLightMap(r,t)}async _updateLightMap(e,t){var r,s,i;if(!t.tmap){e.map=null;return}const o=t.map.nodeWithContext(be.COP,(r=this.states)==null?void 0:r.error);if(o){const c=(await o.compute()).coreContent();c||(s=this.states)==null||s.error.set(`texture invalid. (error: '${o.states.error.message()}')`),e.map=c||null}else(i=this.states)==null||i.error.set("no texture node found")}updateShadowParams(e,t){const r=e.light();r.castShadow=t.castShadow,r.shadow.autoUpdate=t.shadowAutoUpdate,r.shadow.needsUpdate=t.shadowUpdateOnNextRender,r.shadow.mapSize.copy(t.shadowRes);const s=r.shadow.map;s&&s.setSize(t.shadowRes.x,t.shadowRes.y),r.shadow.bias=t.shadowBias,r.shadow.radius=t.shadowRadius,r.shadow.camera.near=t.shadowNear,r.shadow.camera.far=t.shadowFar,r.shadow.camera.updateProjectionMatrix(),e.updateHelper()}}k0.DEFAULT_PARAMS=Zw;k0.INPUT_CLONED_STATE=Mt.NEVER;var Jw=(n=>(n.AREA="areaLight",n.DIRECTIONAL="directionalLight",n.HEMISPHERE="hemisphereLight",n.POINT="pointLight",n.PROBE="lightProbe",n.SPOT="spotLight",n))(Jw||{});class uK extends lK(Et){}const hK=new uK;class dK extends zt{constructor(){super(...arguments),this.paramsConfig=hK}static type(){return Jw.SPOT}initializeNode(){this.io.inputs.setCount(0)}async cook(e){this._operation=this._operation||new k0(this._scene,this.states,this);const t=await this._operation.cook(e,this.pv);this.setCoreGroup(t)}}const pK=4;class fK extends Et{constructor(){super(...arguments),this.input=A.INTEGER(0,{range:[0,3],rangeLocked:[!0,!1],callback:e=>{vg.PARAM_CALLBACK_setInputsEvaluation(e)}}),this.inputsCount=A.INTEGER(pK,{range:[1,32],rangeLocked:[!0,!1],separatorBefore:!0,callback:e=>{vg.PARAM_CALLBACK_setInputsCount(e)}})}}const mK=new fK;class vg extends zt{constructor(){super(...arguments),this.paramsConfig=mK}static type(){return rn.SWITCH}initializeNode(){this.io.inputs.setCount(0,4),this.io.inputs.initInputsClonedState(Mt.NEVER),this.io.inputs.onEnsureListenToSingleInputIndexUpdated(async()=>{await this._callbackUpdateInputsEvaluation()}),this.params.onParamsCreated("update inputs",()=>{this._callbackUpdateInputsCount()})}async cook(){const e=this.pv.input;if(!this.io.inputs.hasInput(e)){this.states.error.set(`no input ${e}`),this.cookController.endCook();return}const t=await this.containerController.requestInputContainer(e);if(!t){this.states.error.set(`invalid input ${e}`),this.cookController.endCook();return}const r=t.coreContent();if(!r){this.states.error.set(`invalid input ${e}`),this.cookController.endCook();return}this.setObjects(r.allObjects())}async _callbackUpdateInputsEvaluation(){this.p.input.isDirty()&&await this.p.input.compute(),this.io.inputs.listenToSingleInputIndex(this.pv.input)}static PARAM_CALLBACK_setInputsEvaluation(e){e._callbackUpdateInputsEvaluation()}_callbackUpdateInputsCount(){this.io.inputs.setCount(1,this.pv.inputsCount),this.emit(_n.INPUTS_UPDATED)}static PARAM_CALLBACK_setInputsCount(e){e._callbackUpdateInputsCount()}}let _K=class{constructor(e){this.data=e,this.isFont=!0,this.type="font"}generateShapes(e,t={}){t.size==null&&(t.size=100),t.isCCW==null&&(t.isCCW=!1);const r=[],s=gK(e,t.size,this.data);for(const i of s){const o=[];for(const a of i){const c=a.toShapes(t.isCCW);o.push(...c)}r.push(o)}return r}};function gK(n,e,t){const r=Array.from(n),s=e/t.resolution,i=(t.boundingBox.yMax-t.boundingBox.yMin+t.underlineThickness)*s,o=[];let a=0,c=0;for(let l=0;l<r.length;l++){const u=r[l],h=[];if(u===`
`)a=0,c-=i;else{const d=vK(u,s,a,c,t);d&&(a+=d.offsetX,h.push(d.path))}o.push(h)}return o}function vK(n,e,t,r,s){const i=s.glyphs[n]||s.glyphs["?"];if(!i){console.error('THREE.Font: character "'+n+'" does not exists in font family '+s.familyName+".");return}const o=new xi;let a,c,l,u,h,d,p,_;if(i.o){const g=i._cachedOutline||(i._cachedOutline=i.o.split(" "));for(let f=0,m=g.length;f<m;)switch(g[f++]){case"m":a=g[f++]*e+t,c=g[f++]*e+r,o.moveTo(a,c);break;case"l":a=g[f++]*e+t,c=g[f++]*e+r,o.lineTo(a,c);break;case"q":l=g[f++]*e+t,u=g[f++]*e+r,h=g[f++]*e+t,d=g[f++]*e+r,o.quadraticCurveTo(h,d,l,u);break;case"b":l=g[f++]*e+t,u=g[f++]*e+r,h=g[f++]*e+t,d=g[f++]*e+r,p=g[f++]*e+t,_=g[f++]*e+r,o.bezierCurveTo(h,d,p,_,l,u);break}}return{offsetX:i.ha*e,path:o}}class yK extends ko{constructor(e){super(e)}load(e,t,r,s){const i=this,o=new vu(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(i.withCredentials),o.load(e,function(a){if(!Ke(a))return;let c;try{c=JSON.parse(a)}catch{console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),c=JSON.parse(a.substring(65,a.length-2))}if(!c)return;const l=i.parse(c);t&&t(l)},r,s)}parse(e){return new _K(e)}}const xK=nn;class B0 extends ko{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,r,s){const i=this,o=new vu(i.manager);o.setPath(i.path),o.setRequestHeader(i.requestHeader),o.setWithCredentials(i.withCredentials),o.load(e,function(a){try{t(i.parse(a))}catch(c){s?s(c):console.error(c),i.manager.itemError(e)}},r,s)}parse(e){const t=this;function r(V,B){if(V.nodeType!==1)return;const P=b(V);let O=!1,se=null;switch(V.nodeName){case"svg":B=_(V,B);break;case"style":i(V);break;case"g":B=_(V,B);break;case"path":B=_(V,B),V.hasAttribute("d")&&(se=s(V));break;case"rect":B=_(V,B),se=c(V);break;case"polygon":B=_(V,B),se=l(V);break;case"polyline":B=_(V,B),se=u(V);break;case"circle":B=_(V,B),se=h(V);break;case"ellipse":B=_(V,B),se=d(V);break;case"line":B=_(V,B),se=p(V);break;case"defs":O=!0;break;case"use":B=_(V,B);const me=(V.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),L=V.viewportElement.getElementById(me);L?r(L,B):console.warn("SVGLoader: 'use node' references non-existent node id: "+me);break}se&&(B.fill!==void 0&&B.fill!=="none"&&se.color.setStyle(B.fill,xK),E(se,ue),F.push(se),se.userData={node:V,style:B});const _e=V.childNodes;for(let Z=0;Z<_e.length;Z++){const me=_e[Z];O&&me.nodeName!=="style"&&me.nodeName!=="defs"||r(me,B)}P&&(N.pop(),N.length>0?ue.copy(N[N.length-1]):ue.identity())}function s(V){const B=new xi,P=new W,O=new W,se=new W;let _e=!0,Z=!1;const me=V.getAttribute("d");if(me===""||me==="none")return null;const L=me.match(/[a-df-z][^a-df-z]*/ig);for(let oe=0,H=L.length;oe<H;oe++){const Q=L[oe],ee=Q.charAt(0),ge=Q.slice(1).trim();_e===!0&&(Z=!0,_e=!1);let z;switch(ee){case"M":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=2)P.x=z[D+0],P.y=z[D+1],O.x=P.x,O.y=P.y,D===0?B.moveTo(P.x,P.y):B.lineTo(P.x,P.y),D===0&&se.copy(P);break;case"H":z=f(ge);for(let D=0,ye=z.length;D<ye;D++)P.x=z[D],O.x=P.x,O.y=P.y,B.lineTo(P.x,P.y),D===0&&Z===!0&&se.copy(P);break;case"V":z=f(ge);for(let D=0,ye=z.length;D<ye;D++)P.y=z[D],O.x=P.x,O.y=P.y,B.lineTo(P.x,P.y),D===0&&Z===!0&&se.copy(P);break;case"L":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=2)P.x=z[D+0],P.y=z[D+1],O.x=P.x,O.y=P.y,B.lineTo(P.x,P.y),D===0&&Z===!0&&se.copy(P);break;case"C":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=6)B.bezierCurveTo(z[D+0],z[D+1],z[D+2],z[D+3],z[D+4],z[D+5]),O.x=z[D+2],O.y=z[D+3],P.x=z[D+4],P.y=z[D+5],D===0&&Z===!0&&se.copy(P);break;case"S":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=4)B.bezierCurveTo(g(P.x,O.x),g(P.y,O.y),z[D+0],z[D+1],z[D+2],z[D+3]),O.x=z[D+0],O.y=z[D+1],P.x=z[D+2],P.y=z[D+3],D===0&&Z===!0&&se.copy(P);break;case"Q":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=4)B.quadraticCurveTo(z[D+0],z[D+1],z[D+2],z[D+3]),O.x=z[D+0],O.y=z[D+1],P.x=z[D+2],P.y=z[D+3],D===0&&Z===!0&&se.copy(P);break;case"T":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=2){const Ie=g(P.x,O.x),ot=g(P.y,O.y);B.quadraticCurveTo(Ie,ot,z[D+0],z[D+1]),O.x=Ie,O.y=ot,P.x=z[D+0],P.y=z[D+1],D===0&&Z===!0&&se.copy(P)}break;case"A":z=f(ge,[3,4],7);for(let D=0,ye=z.length;D<ye;D+=7){if(z[D+5]==P.x&&z[D+6]==P.y)continue;const Ie=P.clone();P.x=z[D+5],P.y=z[D+6],O.x=P.x,O.y=P.y,o(B,z[D],z[D+1],z[D+2],z[D+3],z[D+4],Ie,P),D===0&&Z===!0&&se.copy(P)}break;case"m":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=2)P.x+=z[D+0],P.y+=z[D+1],O.x=P.x,O.y=P.y,D===0?B.moveTo(P.x,P.y):B.lineTo(P.x,P.y),D===0&&se.copy(P);break;case"h":z=f(ge);for(let D=0,ye=z.length;D<ye;D++)P.x+=z[D],O.x=P.x,O.y=P.y,B.lineTo(P.x,P.y),D===0&&Z===!0&&se.copy(P);break;case"v":z=f(ge);for(let D=0,ye=z.length;D<ye;D++)P.y+=z[D],O.x=P.x,O.y=P.y,B.lineTo(P.x,P.y),D===0&&Z===!0&&se.copy(P);break;case"l":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=2)P.x+=z[D+0],P.y+=z[D+1],O.x=P.x,O.y=P.y,B.lineTo(P.x,P.y),D===0&&Z===!0&&se.copy(P);break;case"c":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=6)B.bezierCurveTo(P.x+z[D+0],P.y+z[D+1],P.x+z[D+2],P.y+z[D+3],P.x+z[D+4],P.y+z[D+5]),O.x=P.x+z[D+2],O.y=P.y+z[D+3],P.x+=z[D+4],P.y+=z[D+5],D===0&&Z===!0&&se.copy(P);break;case"s":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=4)B.bezierCurveTo(g(P.x,O.x),g(P.y,O.y),P.x+z[D+0],P.y+z[D+1],P.x+z[D+2],P.y+z[D+3]),O.x=P.x+z[D+0],O.y=P.y+z[D+1],P.x+=z[D+2],P.y+=z[D+3],D===0&&Z===!0&&se.copy(P);break;case"q":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=4)B.quadraticCurveTo(P.x+z[D+0],P.y+z[D+1],P.x+z[D+2],P.y+z[D+3]),O.x=P.x+z[D+0],O.y=P.y+z[D+1],P.x+=z[D+2],P.y+=z[D+3],D===0&&Z===!0&&se.copy(P);break;case"t":z=f(ge);for(let D=0,ye=z.length;D<ye;D+=2){const Ie=g(P.x,O.x),ot=g(P.y,O.y);B.quadraticCurveTo(Ie,ot,P.x+z[D+0],P.y+z[D+1]),O.x=Ie,O.y=ot,P.x=P.x+z[D+0],P.y=P.y+z[D+1],D===0&&Z===!0&&se.copy(P)}break;case"a":z=f(ge,[3,4],7);for(let D=0,ye=z.length;D<ye;D+=7){if(z[D+5]==0&&z[D+6]==0)continue;const Ie=P.clone();P.x+=z[D+5],P.y+=z[D+6],O.x=P.x,O.y=P.y,o(B,z[D],z[D+1],z[D+2],z[D+3],z[D+4],Ie,P),D===0&&Z===!0&&se.copy(P)}break;case"Z":case"z":B.currentPath.autoClose=!0,B.currentPath.curves.length>0&&(P.copy(se),B.currentPath.currentPoint.copy(P),_e=!0);break;default:console.warn(Q)}Z=!1}return B}function i(V){if(!(!V.sheet||!V.sheet.cssRules||!V.sheet.cssRules.length))for(let B=0;B<V.sheet.cssRules.length;B++){const P=V.sheet.cssRules[B];if(P.type!==1)continue;const O=P.selectorText.split(/,/gm).filter(Boolean).map(se=>se.trim());for(let se=0;se<O.length;se++){const _e=Object.fromEntries(Object.entries(P.style).filter(([,Z])=>Z!==""));X[O[se]]=Object.assign(X[O[se]]||{},_e)}}}function o(V,B,P,O,se,_e,Z,me){if(B==0||P==0){V.lineTo(me.x,me.y);return}O=O*Math.PI/180,B=Math.abs(B),P=Math.abs(P);const L=(Z.x-me.x)/2,oe=(Z.y-me.y)/2,H=Math.cos(O)*L+Math.sin(O)*oe,Q=-Math.sin(O)*L+Math.cos(O)*oe;let ee=B*B,ge=P*P;const z=H*H,D=Q*Q,ye=z/ee+D/ge;if(ye>1){const Re=Math.sqrt(ye);B=Re*B,P=Re*P,ee=B*B,ge=P*P}const Ie=ee*D+ge*z,ot=(ee*ge-Ie)/Ie;let U=Math.sqrt(Math.max(0,ot));se===_e&&(U=-U);const w=U*B*Q/P,re=-U*P*H/B,Se=Math.cos(O)*w-Math.sin(O)*re+(Z.x+me.x)/2,Ce=Math.sin(O)*w+Math.cos(O)*re+(Z.y+me.y)/2,Ae=a(1,0,(H-w)/B,(Q-re)/P),Ve=a((H-w)/B,(Q-re)/P,(-H-w)/B,(-Q-re)/P)%(Math.PI*2);V.currentPath.absellipse(Se,Ce,B,P,Ae,Ae+Ve,_e===0,O)}function a(V,B,P,O){const se=V*P+B*O,_e=Math.sqrt(V*V+B*B)*Math.sqrt(P*P+O*O);let Z=Math.acos(Math.max(-1,Math.min(1,se/_e)));return V*O-B*P<0&&(Z=-Z),Z}function c(V){const B=v(V.getAttribute("x")||0),P=v(V.getAttribute("y")||0),O=v(V.getAttribute("rx")||V.getAttribute("ry")||0),se=v(V.getAttribute("ry")||V.getAttribute("rx")||0),_e=v(V.getAttribute("width")),Z=v(V.getAttribute("height")),me=1-.551915024494,L=new xi;return L.moveTo(B+O,P),L.lineTo(B+_e-O,P),(O!==0||se!==0)&&L.bezierCurveTo(B+_e-O*me,P,B+_e,P+se*me,B+_e,P+se),L.lineTo(B+_e,P+Z-se),(O!==0||se!==0)&&L.bezierCurveTo(B+_e,P+Z-se*me,B+_e-O*me,P+Z,B+_e-O,P+Z),L.lineTo(B+O,P+Z),(O!==0||se!==0)&&L.bezierCurveTo(B+O*me,P+Z,B,P+Z-se*me,B,P+Z-se),L.lineTo(B,P+se),(O!==0||se!==0)&&L.bezierCurveTo(B,P+se*me,B+O*me,P,B+O,P),L}function l(V){function B(_e,Z,me){const L=v(Z),oe=v(me);se===0?O.moveTo(L,oe):O.lineTo(L,oe),se++}const P=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,O=new xi;let se=0;return V.getAttribute("points").replace(P,B),O.currentPath.autoClose=!0,O}function u(V){function B(_e,Z,me){const L=v(Z),oe=v(me);se===0?O.moveTo(L,oe):O.lineTo(L,oe),se++}const P=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,O=new xi;let se=0;return V.getAttribute("points").replace(P,B),O.currentPath.autoClose=!1,O}function h(V){const B=v(V.getAttribute("cx")||0),P=v(V.getAttribute("cy")||0),O=v(V.getAttribute("r")||0),se=new Ya;se.absarc(B,P,O,0,Math.PI*2);const _e=new xi;return _e.subPaths.push(se),_e}function d(V){const B=v(V.getAttribute("cx")||0),P=v(V.getAttribute("cy")||0),O=v(V.getAttribute("rx")||0),se=v(V.getAttribute("ry")||0),_e=new Ya;_e.absellipse(B,P,O,se,0,Math.PI*2);const Z=new xi;return Z.subPaths.push(_e),Z}function p(V){const B=v(V.getAttribute("x1")||0),P=v(V.getAttribute("y1")||0),O=v(V.getAttribute("x2")||0),se=v(V.getAttribute("y2")||0),_e=new xi;return _e.moveTo(B,P),_e.lineTo(O,se),_e.currentPath.autoClose=!1,_e}function _(V,B){B=Object.assign({},B);let P={};if(V.hasAttribute("class")){const Z=V.getAttribute("class").split(/\s/).filter(Boolean).map(me=>me.trim());for(let me=0;me<Z.length;me++)P=Object.assign(P,X["."+Z[me]])}V.hasAttribute("id")&&(P=Object.assign(P,X["#"+V.getAttribute("id")]));function O(Z,me,L){L===void 0&&(L=function(H){return H.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),H}),V.hasAttribute(Z)&&(B[me]=L(V.getAttribute(Z))),P[Z]&&(B[me]=L(P[Z])),V.style&&V.style[Z]!==""&&(B[me]=L(V.style[Z]))}function se(Z){return Math.max(0,Math.min(1,v(Z)))}function _e(Z){return Math.max(0,v(Z))}return O("fill","fill"),O("fill-opacity","fillOpacity",se),O("fill-rule","fillRule"),O("opacity","opacity",se),O("stroke","stroke"),O("stroke-opacity","strokeOpacity",se),O("stroke-width","strokeWidth",_e),O("stroke-linejoin","strokeLineJoin"),O("stroke-linecap","strokeLineCap"),O("stroke-miterlimit","strokeMiterLimit",_e),O("visibility","visibility"),B}function g(V,B){return V-(B-V)}function f(V,B,P){if(typeof V!="string")throw new TypeError("Invalid input: "+typeof V);const O={SEPARATOR:/[ \t\r\n\,.\-+]/,WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/},se=0,_e=1,Z=2,me=3;let L=se,oe=!0,H="",Q="";const ee=[];function ge(Ie,ot,U){const w=new SyntaxError('Unexpected character "'+Ie+'" at index '+ot+".");throw w.partial=U,w}function z(){H!==""&&(Q===""?ee.push(Number(H)):ee.push(Number(H)*Math.pow(10,Number(Q)))),H="",Q=""}let D;const ye=V.length;for(let Ie=0;Ie<ye;Ie++){if(D=V[Ie],Array.isArray(B)&&B.includes(ee.length%P)&&O.FLAGS.test(D)){L=_e,H=D,z();continue}if(L===se){if(O.WHITESPACE.test(D))continue;if(O.DIGIT.test(D)||O.SIGN.test(D)){L=_e,H=D;continue}if(O.POINT.test(D)){L=Z,H=D;continue}O.COMMA.test(D)&&(oe&&ge(D,Ie,ee),oe=!0)}if(L===_e){if(O.DIGIT.test(D)){H+=D;continue}if(O.POINT.test(D)){H+=D,L=Z;continue}if(O.EXP.test(D)){L=me;continue}O.SIGN.test(D)&&H.length===1&&O.SIGN.test(H[0])&&ge(D,Ie,ee)}if(L===Z){if(O.DIGIT.test(D)){H+=D;continue}if(O.EXP.test(D)){L=me;continue}O.POINT.test(D)&&H[H.length-1]==="."&&ge(D,Ie,ee)}if(L===me){if(O.DIGIT.test(D)){Q+=D;continue}if(O.SIGN.test(D)){if(Q===""){Q+=D;continue}Q.length===1&&O.SIGN.test(Q)&&ge(D,Ie,ee)}}O.WHITESPACE.test(D)?(z(),L=se,oe=!1):O.COMMA.test(D)?(z(),L=se,oe=!0):O.SIGN.test(D)?(z(),L=_e,H=D):O.POINT.test(D)?(z(),L=Z,H=D):ge(D,Ie,ee)}return z(),ee}const m=["mm","cm","in","pt","pc","px"],y={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:72/6,pc:1,px:-1},px:{px:1}};function v(V){let B="px";if(typeof V=="string"||V instanceof String)for(let O=0,se=m.length;O<se;O++){const _e=m[O];if(V.endsWith(_e)){B=_e,V=V.substring(0,V.length-_e.length);break}}let P;return B==="px"&&t.defaultUnit!=="px"?P=y.in[t.defaultUnit]/t.defaultDPI:(P=y[B][t.defaultUnit],P<0&&(P=y[B].in*t.defaultDPI)),P*parseFloat(V)}function b(V){if(!(V.hasAttribute("transform")||V.nodeName==="use"&&(V.hasAttribute("x")||V.hasAttribute("y"))))return null;const B=x(V);return N.length>0&&B.premultiply(N[N.length-1]),ue.copy(B),N.push(B),B}function x(V){const B=new nt,P=j;if(V.nodeName==="use"&&(V.hasAttribute("x")||V.hasAttribute("y"))){const O=v(V.getAttribute("x")),se=v(V.getAttribute("y"));B.translate(O,se)}if(V.hasAttribute("transform")){const O=V.getAttribute("transform").split(")");for(let se=O.length-1;se>=0;se--){const _e=O[se].trim();if(_e==="")continue;const Z=_e.indexOf("("),me=_e.length;if(Z>0&&Z<me){const L=_e.slice(0,Z),oe=f(_e.slice(Z+1));switch(P.identity(),L){case"translate":if(oe.length>=1){const H=oe[0];let Q=0;oe.length>=2&&(Q=oe[1]),P.translate(H,Q)}break;case"rotate":if(oe.length>=1){let H=0,Q=0,ee=0;H=oe[0]*Math.PI/180,oe.length>=3&&(Q=oe[1],ee=oe[2]),K.makeTranslation(-Q,-ee),$.makeRotation(H),q.multiplyMatrices($,K),K.makeTranslation(Q,ee),P.multiplyMatrices(K,q)}break;case"scale":if(oe.length>=1){const H=oe[0];let Q=H;oe.length>=2&&(Q=oe[1]),P.scale(H,Q)}break;case"skewX":oe.length===1&&P.set(1,Math.tan(oe[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":oe.length===1&&P.set(1,0,0,Math.tan(oe[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":oe.length===6&&P.set(oe[0],oe[2],oe[4],oe[1],oe[3],oe[5],0,0,1);break}}B.premultiply(P)}}return B}function E(V,B){function P(Z){le.set(Z.x,Z.y,1).applyMatrix3(B),Z.set(le.x,le.y)}function O(Z){const me=Z.xRadius,L=Z.yRadius,oe=Math.cos(Z.aRotation),H=Math.sin(Z.aRotation),Q=new T(me*oe,me*H,0),ee=new T(-L*H,L*oe,0),ge=Q.applyMatrix3(B),z=ee.applyMatrix3(B),D=j.set(ge.x,z.x,0,ge.y,z.y,0,0,0,1),ye=K.copy(D).invert(),U=$.copy(ye).transpose().multiply(ye).elements,w=G(U[0],U[1],U[4]),re=Math.sqrt(w.rt1),Se=Math.sqrt(w.rt2);if(Z.xRadius=1/re,Z.yRadius=1/Se,Z.aRotation=Math.atan2(w.sn,w.cs),!((Z.aEndAngle-Z.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const Ae=K.set(re,0,0,0,Se,0,0,0,1),Ve=$.set(w.cs,w.sn,0,-w.sn,w.cs,0,0,0,1),Re=Ae.multiply(Ve).multiply(D),Ne=Ze=>{const{x:pt,y:k}=new T(Math.cos(Ze),Math.sin(Ze),0).applyMatrix3(Re);return Math.atan2(k,pt)};Z.aStartAngle=Ne(Z.aStartAngle),Z.aEndAngle=Ne(Z.aEndAngle),S(B)&&(Z.aClockwise=!Z.aClockwise)}}function se(Z){const me=C(B),L=M(B);Z.xRadius*=me,Z.yRadius*=L;const oe=me>Number.EPSILON?Math.atan2(B.elements[1],B.elements[0]):Math.atan2(-B.elements[3],B.elements[4]);Z.aRotation+=oe,S(B)&&(Z.aStartAngle*=-1,Z.aEndAngle*=-1,Z.aClockwise=!Z.aClockwise)}const _e=V.subPaths;for(let Z=0,me=_e.length;Z<me;Z++){const oe=_e[Z].curves;for(let H=0;H<oe.length;H++){const Q=oe[H];Q.isLineCurve?(P(Q.v1),P(Q.v2)):Q.isCubicBezierCurve?(P(Q.v0),P(Q.v1),P(Q.v2),P(Q.v3)):Q.isQuadraticBezierCurve?(P(Q.v0),P(Q.v1),P(Q.v2)):Q.isEllipseCurve&&(ne.set(Q.aX,Q.aY),P(ne),Q.aX=ne.x,Q.aY=ne.y,R(B)?O(Q):se(Q))}}}function S(V){const B=V.elements;return B[0]*B[4]-B[1]*B[3]<0}function R(V){const B=V.elements,P=B[0]*B[3]+B[1]*B[4];if(P===0)return!1;const O=C(V),se=M(V);return Math.abs(P/(O*se))>Number.EPSILON}function C(V){const B=V.elements;return Math.sqrt(B[0]*B[0]+B[1]*B[1])}function M(V){const B=V.elements;return Math.sqrt(B[3]*B[3]+B[4]*B[4])}function G(V,B,P){let O,se,_e,Z,me;const L=V+P,oe=V-P,H=Math.sqrt(oe*oe+4*B*B);return L>0?(O=.5*(L+H),me=1/O,se=V*me*P-B*me*B):L<0?se=.5*(L-H):(O=.5*H,se=-.5*H),oe>0?_e=oe+H:_e=oe-H,Math.abs(_e)>2*Math.abs(B)?(me=-2*B/_e,Z=1/Math.sqrt(1+me*me),_e=me*Z):Math.abs(B)===0?(_e=1,Z=0):(me=-.5*_e/B,_e=1/Math.sqrt(1+me*me),Z=me*_e),oe>0&&(me=_e,_e=-Z,Z=me),{rt1:O,rt2:se,cs:_e,sn:Z}}const F=[],X={},N=[],j=new nt,K=new nt,$=new nt,q=new nt,ne=new W,le=new T,ue=new nt,Ee=new DOMParser().parseFromString(e,"image/svg+xml");return r(Ee.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:F,xml:Ee.documentElement}}static createShapes(e){const r={ORIGIN:0,DESTINATION:1,BETWEEN:2,LEFT:3,RIGHT:4,BEHIND:5,BEYOND:6},s={loc:r.ORIGIN,t:0};function i(g,f,m,y){const v=g.x,b=f.x,x=m.x,E=y.x,S=g.y,R=f.y,C=m.y,M=y.y,G=(E-x)*(S-C)-(M-C)*(v-x),F=(b-v)*(S-C)-(R-S)*(v-x),X=(M-C)*(b-v)-(E-x)*(R-S),N=G/X,j=F/X;if(X===0&&G!==0||N<=0||N>=1||j<0||j>1)return null;if(G===0&&X===0){for(let K=0;K<2;K++)if(o(K===0?m:y,g,f),s.loc==r.ORIGIN){const $=K===0?m:y;return{x:$.x,y:$.y,t:s.t}}else if(s.loc==r.BETWEEN){const $=+(v+s.t*(b-v)).toPrecision(10),q=+(S+s.t*(R-S)).toPrecision(10);return{x:$,y:q,t:s.t}}return null}else{for(let q=0;q<2;q++)if(o(q===0?m:y,g,f),s.loc==r.ORIGIN){const ne=q===0?m:y;return{x:ne.x,y:ne.y,t:s.t}}const K=+(v+N*(b-v)).toPrecision(10),$=+(S+N*(R-S)).toPrecision(10);return{x:K,y:$,t:N}}}function o(g,f,m){const y=m.x-f.x,v=m.y-f.y,b=g.x-f.x,x=g.y-f.y,E=y*x-b*v;if(g.x===f.x&&g.y===f.y){s.loc=r.ORIGIN,s.t=0;return}if(g.x===m.x&&g.y===m.y){s.loc=r.DESTINATION,s.t=1;return}if(E<-Number.EPSILON){s.loc=r.LEFT;return}if(E>Number.EPSILON){s.loc=r.RIGHT;return}if(y*b<0||v*x<0){s.loc=r.BEHIND;return}if(Math.sqrt(y*y+v*v)<Math.sqrt(b*b+x*x)){s.loc=r.BEYOND;return}let S;y!==0?S=b/y:S=x/v,s.loc=r.BETWEEN,s.t=S}function a(g,f){const m=[],y=[];for(let v=1;v<g.length;v++){const b=g[v-1],x=g[v];for(let E=1;E<f.length;E++){const S=f[E-1],R=f[E],C=i(b,x,S,R);C!==null&&m.find(M=>M.t<=C.t+Number.EPSILON&&M.t>=C.t-Number.EPSILON)===void 0&&(m.push(C),y.push(new W(C.x,C.y)))}}return y}function c(g,f,m){const y=new W;f.getCenter(y);const v=[];return m.forEach(b=>{b.boundingBox.containsPoint(y)&&a(g,b.points).forEach(E=>{v.push({identifier:b.identifier,isCW:b.isCW,point:E})})}),v.sort((b,x)=>b.point.x-x.point.x),v}function l(g,f,m,y,v){(v==null||v==="")&&(v="nonzero");const b=new W;g.boundingBox.getCenter(b);const x=[new W(m,b.y),new W(y,b.y)],E=c(x,g.boundingBox,f);E.sort((F,X)=>F.point.x-X.point.x);const S=[],R=[];E.forEach(F=>{F.identifier===g.identifier?S.push(F):R.push(F)});const C=S[0].point.x,M=[];let G=0;for(;G<R.length&&R[G].point.x<C;)M.length>0&&M[M.length-1]===R[G].identifier?M.pop():M.push(R[G].identifier),G++;if(M.push(g.identifier),v==="evenodd"){const F=M.length%2===0,X=M[M.length-2];return{identifier:g.identifier,isHole:F,for:X}}else if(v==="nonzero"){let F=!0,X=null,N=null;for(let j=0;j<M.length;j++){const K=M[j];F?(N=f[K].isCW,F=!1,X=K):N!==f[K].isCW&&(N=f[K].isCW,F=!0)}return{identifier:g.identifier,isHole:F,for:X}}else console.warn('fill-rule: "'+v+'" is currently not implemented.')}let u=999999999,h=-999999999,d=e.subPaths.map(g=>{const f=g.getPoints();let m=-999999999,y=999999999,v=-999999999,b=999999999;for(let x=0;x<f.length;x++){const E=f[x];E.y>m&&(m=E.y),E.y<y&&(y=E.y),E.x>v&&(v=E.x),E.x<b&&(b=E.x)}return h<=v&&(h=v+1),u>=b&&(u=b-1),{curves:g.curves,points:f,isCW:Es.isClockWise(f),identifier:-1,boundingBox:new sU(new W(b,y),new W(v,m))}});d=d.filter(g=>g.points.length>1);for(let g=0;g<d.length;g++)d[g].identifier=g;const p=d.map(g=>l(g,d,u,h,e.userData?e.userData.style.fillRule:void 0)),_=[];return d.forEach(g=>{if(!p[g.identifier].isHole){const m=new Ka;m.curves=g.curves,p.filter(v=>v.isHole&&v.for===g.identifier).forEach(v=>{const b=d[v.identifier],x=new Ya;x.curves=b.curves,m.holes.push(x)}),_.push(m)}}),_}static getStrokeStyle(e,t,r,s,i){return e=e!==void 0?e:1,t=t!==void 0?t:"#000",r=r!==void 0?r:"miter",s=s!==void 0?s:"butt",i=i!==void 0?i:4,{strokeColor:t,strokeWidth:e,strokeLineJoin:r,strokeLineCap:s,strokeMiterLimit:i}}static pointsToStroke(e,t,r,s){const i=[],o=[],a=[];if(B0.pointsToStrokeWithBuffers(e,t,r,s,i,o,a)===0)return null;const c=new sn;return c.setAttribute("position",new gt(i,3)),c.setAttribute("normal",new gt(o,3)),c.setAttribute("uv",new gt(a,2)),c}static pointsToStrokeWithBuffers(e,t,r,s,i,o,a,c){const l=new W,u=new W,h=new W,d=new W,p=new W,_=new W,g=new W,f=new W,m=new W,y=new W,v=new W,b=new W,x=new W,E=new W,S=new W,R=new W,C=new W;r=r!==void 0?r:12,s=s!==void 0?s:.001,c=c!==void 0?c:0,e=oe(e);const M=e.length;if(M<2)return 0;const G=e[0].equals(e[M-1]);let F,X=e[0],N;const j=t.strokeWidth/2,K=1/(M-1);let $=0,q,ne,le,ue,Ee=!1,de=0,V=c*3,B=c*2;P(e[0],e[1],l).multiplyScalar(j),f.copy(e[0]).sub(l),m.copy(e[0]).add(l),y.copy(f),v.copy(m);for(let H=1;H<M;H++){F=e[H],H===M-1?G?N=e[1]:N=void 0:N=e[H+1];const Q=l;if(P(X,F,Q),h.copy(Q).multiplyScalar(j),b.copy(F).sub(h),x.copy(F).add(h),q=$+K,ne=!1,N!==void 0){P(F,N,u),h.copy(u).multiplyScalar(j),E.copy(F).sub(h),S.copy(F).add(h),le=!0,h.subVectors(N,X),Q.dot(h)<0&&(le=!1),H===1&&(Ee=le),h.subVectors(N,F),h.normalize();const ee=Math.abs(Q.dot(h));if(ee>Number.EPSILON){const ge=j/ee;h.multiplyScalar(-ge),d.subVectors(F,X),p.copy(d).setLength(ge).add(h),R.copy(p).negate();const z=p.length(),D=d.length();d.divideScalar(D),_.subVectors(N,F);const ye=_.length();switch(_.divideScalar(ye),d.dot(R)<D&&_.dot(R)<ye&&(ne=!0),C.copy(p).add(F),R.add(F),ue=!1,ne?le?(S.copy(R),x.copy(R)):(E.copy(R),b.copy(R)):_e(),t.strokeLineJoin){case"bevel":Z(le,ne,q);break;case"round":me(le,ne),le?se(F,b,E,q,0):se(F,S,x,q,1);break;case"miter":case"miter-clip":default:const Ie=j*t.strokeMiterLimit/z;if(Ie<1)if(t.strokeLineJoin!=="miter-clip"){Z(le,ne,q);break}else me(le,ne),le?(_.subVectors(C,b).multiplyScalar(Ie).add(b),g.subVectors(C,E).multiplyScalar(Ie).add(E),O(b,q,0),O(_,q,0),O(F,q,.5),O(F,q,.5),O(_,q,0),O(g,q,0),O(F,q,.5),O(g,q,0),O(E,q,0)):(_.subVectors(C,x).multiplyScalar(Ie).add(x),g.subVectors(C,S).multiplyScalar(Ie).add(S),O(x,q,1),O(_,q,1),O(F,q,.5),O(F,q,.5),O(_,q,1),O(g,q,1),O(F,q,.5),O(g,q,1),O(S,q,1));else ne?(le?(O(m,$,1),O(f,$,0),O(C,q,0),O(m,$,1),O(C,q,0),O(R,q,1)):(O(m,$,1),O(f,$,0),O(C,q,1),O(f,$,0),O(R,q,0),O(C,q,1)),le?E.copy(C):S.copy(C)):le?(O(b,q,0),O(C,q,0),O(F,q,.5),O(F,q,.5),O(C,q,0),O(E,q,0)):(O(x,q,1),O(C,q,1),O(F,q,.5),O(F,q,.5),O(C,q,1),O(S,q,1)),ue=!0;break}}else _e()}else _e();!G&&H===M-1&&L(e[0],y,v,le,!0,$),$=q,X=F,f.copy(E),m.copy(S)}if(!G)L(F,b,x,le,!1,q);else if(ne&&i){let H=C,Q=R;Ee!==le&&(H=R,Q=C),le?(ue||Ee)&&(Q.toArray(i,0*3),Q.toArray(i,3*3),ue&&H.toArray(i,1*3)):(ue||!Ee)&&(Q.toArray(i,1*3),Q.toArray(i,3*3),ue&&H.toArray(i,0*3))}return de;function P(H,Q,ee){return ee.subVectors(Q,H),ee.set(-ee.y,ee.x).normalize()}function O(H,Q,ee){i&&(i[V]=H.x,i[V+1]=H.y,i[V+2]=0,o&&(o[V]=0,o[V+1]=0,o[V+2]=1),V+=3,a&&(a[B]=Q,a[B+1]=ee,B+=2)),de+=3}function se(H,Q,ee,ge,z){l.copy(Q).sub(H).normalize(),u.copy(ee).sub(H).normalize();let D=Math.PI;const ye=l.dot(u);Math.abs(ye)<1&&(D=Math.abs(Math.acos(ye))),D/=r,h.copy(Q);for(let Ie=0,ot=r-1;Ie<ot;Ie++)d.copy(h).rotateAround(H,D),O(h,ge,z),O(d,ge,z),O(H,ge,.5),h.copy(d);O(d,ge,z),O(ee,ge,z),O(H,ge,.5)}function _e(){O(m,$,1),O(f,$,0),O(b,q,0),O(m,$,1),O(b,q,1),O(x,q,0)}function Z(H,Q,ee){Q?H?(O(m,$,1),O(f,$,0),O(b,q,0),O(m,$,1),O(b,q,0),O(R,q,1),O(b,ee,0),O(E,ee,0),O(R,ee,.5)):(O(m,$,1),O(f,$,0),O(x,q,1),O(f,$,0),O(R,q,0),O(x,q,1),O(x,ee,1),O(R,ee,0),O(S,ee,1)):H?(O(b,ee,0),O(E,ee,0),O(F,ee,.5)):(O(x,ee,1),O(S,ee,0),O(F,ee,.5))}function me(H,Q){Q&&(H?(O(m,$,1),O(f,$,0),O(b,q,0),O(m,$,1),O(b,q,0),O(R,q,1),O(b,$,0),O(F,q,.5),O(R,q,1),O(F,q,.5),O(E,$,0),O(R,q,1)):(O(m,$,1),O(f,$,0),O(x,q,1),O(f,$,0),O(R,q,0),O(x,q,1),O(x,$,1),O(R,q,0),O(F,q,.5),O(F,q,.5),O(R,q,0),O(S,$,1)))}function L(H,Q,ee,ge,z,D){switch(t.strokeLineCap){case"round":z?se(H,ee,Q,D,.5):se(H,Q,ee,D,.5);break;case"square":if(z)l.subVectors(Q,H),u.set(l.y,-l.x),h.addVectors(l,u).add(H),d.subVectors(u,l).add(H),ge?(h.toArray(i,1*3),d.toArray(i,0*3),d.toArray(i,3*3)):(h.toArray(i,1*3),h.toArray(i,3*3),d.toArray(i,0*3));else{l.subVectors(ee,H),u.set(l.y,-l.x),h.addVectors(l,u).add(H),d.subVectors(u,l).add(H);const ye=i.length;ge?(h.toArray(i,ye-1*3),d.toArray(i,ye-2*3),d.toArray(i,ye-4*3)):(d.toArray(i,ye-2*3),h.toArray(i,ye-1*3),d.toArray(i,ye-4*3))}break}}function oe(H){let Q=!1;for(let ge=1,z=H.length-1;ge<z;ge++)if(H[ge].distanceTo(H[ge+1])<s){Q=!0;break}if(!Q)return H;const ee=[];ee.push(H[0]);for(let ge=1,z=H.length-1;ge<z;ge++)H[ge].distanceTo(H[ge+1])>=s&&ee.push(H[ge]);return ee.push(H[H.length-1]),ee}}}/*! https://mths.be/codepointat v0.2.0 by @mathias */String.prototype.codePointAt||function(){var n=function(){try{var t={},r=Object.defineProperty,s=r(t,t,t)&&r}catch{}return s}(),e=function(t){if(this==null)throw TypeError();var r=String(this),s=r.length,i=t?Number(t):0;if(i!=i&&(i=0),!(i<0||i>=s)){var o=r.charCodeAt(i),a;return o>=55296&&o<=56319&&s>i+1&&(a=r.charCodeAt(i+1),a>=56320&&a<=57343)?(o-55296)*1024+a-56320+65536:o}};n?n(String.prototype,"codePointAt",{value:e,configurable:!0,writable:!0}):String.prototype.codePointAt=e}();var G0=0,Qw=-3;function hu(){this.table=new Uint16Array(16),this.trans=new Uint16Array(288)}function bK(n,e){this.source=n,this.sourceIndex=0,this.tag=0,this.bitcount=0,this.dest=e,this.destLen=0,this.ltree=new hu,this.dtree=new hu}var eO=new hu,tO=new hu,V0=new Uint8Array(30),z0=new Uint16Array(30),nO=new Uint8Array(30),rO=new Uint16Array(30),CK=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),RS=new hu,ls=new Uint8Array(288+32);function sO(n,e,t,r){var s,i;for(s=0;s<t;++s)n[s]=0;for(s=0;s<30-t;++s)n[s+t]=s/t|0;for(i=r,s=0;s<30;++s)e[s]=i,i+=1<<n[s]}function EK(n,e){var t;for(t=0;t<7;++t)n.table[t]=0;for(n.table[7]=24,n.table[8]=152,n.table[9]=112,t=0;t<24;++t)n.trans[t]=256+t;for(t=0;t<144;++t)n.trans[24+t]=t;for(t=0;t<8;++t)n.trans[24+144+t]=280+t;for(t=0;t<112;++t)n.trans[24+144+8+t]=144+t;for(t=0;t<5;++t)e.table[t]=0;for(e.table[5]=32,t=0;t<32;++t)e.trans[t]=t}var wS=new Uint16Array(16);function Xm(n,e,t,r){var s,i;for(s=0;s<16;++s)n.table[s]=0;for(s=0;s<r;++s)n.table[e[t+s]]++;for(n.table[0]=0,i=0,s=0;s<16;++s)wS[s]=i,i+=n.table[s];for(s=0;s<r;++s)e[t+s]&&(n.trans[wS[e[t+s]]++]=s)}function SK(n){n.bitcount--||(n.tag=n.source[n.sourceIndex++],n.bitcount=7);var e=n.tag&1;return n.tag>>>=1,e}function ps(n,e,t){if(!e)return t;for(;n.bitcount<24;)n.tag|=n.source[n.sourceIndex++]<<n.bitcount,n.bitcount+=8;var r=n.tag&65535>>>16-e;return n.tag>>>=e,n.bitcount-=e,r+t}function yg(n,e){for(;n.bitcount<24;)n.tag|=n.source[n.sourceIndex++]<<n.bitcount,n.bitcount+=8;var t=0,r=0,s=0,i=n.tag;do r=2*r+(i&1),i>>>=1,++s,t+=e.table[s],r-=e.table[s];while(r>=0);return n.tag=i,n.bitcount-=s,e.trans[t+r]}function AK(n,e,t){var r,s,i,o,a,c;for(r=ps(n,5,257),s=ps(n,5,1),i=ps(n,4,4),o=0;o<19;++o)ls[o]=0;for(o=0;o<i;++o){var l=ps(n,3,0);ls[CK[o]]=l}for(Xm(RS,ls,0,19),a=0;a<r+s;){var u=yg(n,RS);switch(u){case 16:var h=ls[a-1];for(c=ps(n,2,3);c;--c)ls[a++]=h;break;case 17:for(c=ps(n,3,3);c;--c)ls[a++]=0;break;case 18:for(c=ps(n,7,11);c;--c)ls[a++]=0;break;default:ls[a++]=u;break}}Xm(e,ls,0,r),Xm(t,ls,r,s)}function OS(n,e,t){for(;;){var r=yg(n,e);if(r===256)return G0;if(r<256)n.dest[n.destLen++]=r;else{var s,i,o,a;for(r-=257,s=ps(n,V0[r],z0[r]),i=yg(n,t),o=n.destLen-ps(n,nO[i],rO[i]),a=o;a<o+s;++a)n.dest[n.destLen++]=n.dest[a]}}}function TK(n){for(var e,t,r;n.bitcount>8;)n.sourceIndex--,n.bitcount-=8;if(e=n.source[n.sourceIndex+1],e=256*e+n.source[n.sourceIndex],t=n.source[n.sourceIndex+3],t=256*t+n.source[n.sourceIndex+2],e!==(~t&65535))return Qw;for(n.sourceIndex+=4,r=e;r;--r)n.dest[n.destLen++]=n.source[n.sourceIndex++];return n.bitcount=0,G0}function MK(n,e){var t=new bK(n,e),r,s,i;do{switch(r=SK(t),s=ps(t,2,0),s){case 0:i=TK(t);break;case 1:i=OS(t,eO,tO);break;case 2:AK(t,t.ltree,t.dtree),i=OS(t,t.ltree,t.dtree);break;default:i=Qw}if(i!==G0)throw new Error("Data error")}while(!r);return t.destLen<t.dest.length?typeof t.dest.slice=="function"?t.dest.slice(0,t.destLen):t.dest.subarray(0,t.destLen):t.dest}EK(eO,tO);sO(V0,z0,4,3);sO(nO,rO,2,1);V0[28]=0;z0[28]=258;var RK=MK;function Oa(n,e,t,r,s){return Math.pow(1-s,3)*n+3*Math.pow(1-s,2)*s*e+3*(1-s)*Math.pow(s,2)*t+Math.pow(s,3)*r}function ai(){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN}ai.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)};ai.prototype.addPoint=function(n,e){typeof n=="number"&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=n,this.x2=n),n<this.x1&&(this.x1=n),n>this.x2&&(this.x2=n)),typeof e=="number"&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=e,this.y2=e),e<this.y1&&(this.y1=e),e>this.y2&&(this.y2=e))};ai.prototype.addX=function(n){this.addPoint(n,null)};ai.prototype.addY=function(n){this.addPoint(null,n)};ai.prototype.addBezier=function(n,e,t,r,s,i,o,a){var c=[n,e],l=[t,r],u=[s,i],h=[o,a];this.addPoint(n,e),this.addPoint(o,a);for(var d=0;d<=1;d++){var p=6*c[d]-12*l[d]+6*u[d],_=-3*c[d]+9*l[d]-9*u[d]+3*h[d],g=3*l[d]-3*c[d];if(_===0){if(p===0)continue;var f=-g/p;0<f&&f<1&&(d===0&&this.addX(Oa(c[d],l[d],u[d],h[d],f)),d===1&&this.addY(Oa(c[d],l[d],u[d],h[d],f)));continue}var m=Math.pow(p,2)-4*g*_;if(!(m<0)){var y=(-p+Math.sqrt(m))/(2*_);0<y&&y<1&&(d===0&&this.addX(Oa(c[d],l[d],u[d],h[d],y)),d===1&&this.addY(Oa(c[d],l[d],u[d],h[d],y)));var v=(-p-Math.sqrt(m))/(2*_);0<v&&v<1&&(d===0&&this.addX(Oa(c[d],l[d],u[d],h[d],v)),d===1&&this.addY(Oa(c[d],l[d],u[d],h[d],v)))}}};ai.prototype.addQuad=function(n,e,t,r,s,i){var o=n+.6666666666666666*(t-n),a=e+2/3*(r-e),c=o+1/3*(s-n),l=a+1/3*(i-e);this.addBezier(n,e,o,a,c,l,s,i)};function vn(){this.commands=[],this.fill="black",this.stroke=null,this.strokeWidth=1}vn.prototype.moveTo=function(n,e){this.commands.push({type:"M",x:n,y:e})};vn.prototype.lineTo=function(n,e){this.commands.push({type:"L",x:n,y:e})};vn.prototype.curveTo=vn.prototype.bezierCurveTo=function(n,e,t,r,s,i){this.commands.push({type:"C",x1:n,y1:e,x2:t,y2:r,x:s,y:i})};vn.prototype.quadTo=vn.prototype.quadraticCurveTo=function(n,e,t,r){this.commands.push({type:"Q",x1:n,y1:e,x:t,y:r})};vn.prototype.close=vn.prototype.closePath=function(){this.commands.push({type:"Z"})};vn.prototype.extend=function(n){if(n.commands)n=n.commands;else if(n instanceof ai){var e=n;this.moveTo(e.x1,e.y1),this.lineTo(e.x2,e.y1),this.lineTo(e.x2,e.y2),this.lineTo(e.x1,e.y2),this.close();return}Array.prototype.push.apply(this.commands,n)};vn.prototype.getBoundingBox=function(){for(var n=new ai,e=0,t=0,r=0,s=0,i=0;i<this.commands.length;i++){var o=this.commands[i];switch(o.type){case"M":n.addPoint(o.x,o.y),e=r=o.x,t=s=o.y;break;case"L":n.addPoint(o.x,o.y),r=o.x,s=o.y;break;case"Q":n.addQuad(r,s,o.x1,o.y1,o.x,o.y),r=o.x,s=o.y;break;case"C":n.addBezier(r,s,o.x1,o.y1,o.x2,o.y2,o.x,o.y),r=o.x,s=o.y;break;case"Z":r=e,s=t;break;default:throw new Error("Unexpected path command "+o.type)}}return n.isEmpty()&&n.addPoint(0,0),n};vn.prototype.draw=function(n){n.beginPath();for(var e=0;e<this.commands.length;e+=1){var t=this.commands[e];t.type==="M"?n.moveTo(t.x,t.y):t.type==="L"?n.lineTo(t.x,t.y):t.type==="C"?n.bezierCurveTo(t.x1,t.y1,t.x2,t.y2,t.x,t.y):t.type==="Q"?n.quadraticCurveTo(t.x1,t.y1,t.x,t.y):t.type==="Z"&&n.closePath()}this.fill&&(n.fillStyle=this.fill,n.fill()),this.stroke&&(n.strokeStyle=this.stroke,n.lineWidth=this.strokeWidth,n.stroke())};vn.prototype.toPathData=function(n){n=n!==void 0?n:2;function e(o){return Math.round(o)===o?""+Math.round(o):o.toFixed(n)}function t(){for(var o=arguments,a="",c=0;c<arguments.length;c+=1){var l=o[c];l>=0&&c>0&&(a+=" "),a+=e(l)}return a}for(var r="",s=0;s<this.commands.length;s+=1){var i=this.commands[s];i.type==="M"?r+="M"+t(i.x,i.y):i.type==="L"?r+="L"+t(i.x,i.y):i.type==="C"?r+="C"+t(i.x1,i.y1,i.x2,i.y2,i.x,i.y):i.type==="Q"?r+="Q"+t(i.x1,i.y1,i.x,i.y):i.type==="Z"&&(r+="Z")}return r};vn.prototype.toSVG=function(n){var e='<path d="';return e+=this.toPathData(n),e+='"',this.fill&&this.fill!=="black"&&(this.fill===null?e+=' fill="none"':e+=' fill="'+this.fill+'"'),this.stroke&&(e+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'),e+="/>",e};vn.prototype.toDOMElement=function(n){var e=this.toPathData(n),t=document.createElementNS("http://www.w3.org/2000/svg","path");return t.setAttribute("d",e),t};function iO(n){throw new Error(n)}function PS(n,e){n||iO(e)}var $e={fail:iO,argument:PS,assert:PS},NS=32768,IS=2147483648,mc={},Pe={},tt={};function ss(n){return function(){return n}}Pe.BYTE=function(n){return $e.argument(n>=0&&n<=255,"Byte value should be between 0 and 255."),[n]};tt.BYTE=ss(1);Pe.CHAR=function(n){return[n.charCodeAt(0)]};tt.CHAR=ss(1);Pe.CHARARRAY=function(n){typeof n>"u"&&(n="",console.warn("Undefined CHARARRAY encountered and treated as an empty string. This is probably caused by a missing glyph name."));for(var e=[],t=0;t<n.length;t+=1)e[t]=n.charCodeAt(t);return e};tt.CHARARRAY=function(n){return typeof n>"u"?0:n.length};Pe.USHORT=function(n){return[n>>8&255,n&255]};tt.USHORT=ss(2);Pe.SHORT=function(n){return n>=NS&&(n=-(2*NS-n)),[n>>8&255,n&255]};tt.SHORT=ss(2);Pe.UINT24=function(n){return[n>>16&255,n>>8&255,n&255]};tt.UINT24=ss(3);Pe.ULONG=function(n){return[n>>24&255,n>>16&255,n>>8&255,n&255]};tt.ULONG=ss(4);Pe.LONG=function(n){return n>=IS&&(n=-(2*IS-n)),[n>>24&255,n>>16&255,n>>8&255,n&255]};tt.LONG=ss(4);Pe.FIXED=Pe.ULONG;tt.FIXED=tt.ULONG;Pe.FWORD=Pe.SHORT;tt.FWORD=tt.SHORT;Pe.UFWORD=Pe.USHORT;tt.UFWORD=tt.USHORT;Pe.LONGDATETIME=function(n){return[0,0,0,0,n>>24&255,n>>16&255,n>>8&255,n&255]};tt.LONGDATETIME=ss(8);Pe.TAG=function(n){return $e.argument(n.length===4,"Tag should be exactly 4 ASCII characters."),[n.charCodeAt(0),n.charCodeAt(1),n.charCodeAt(2),n.charCodeAt(3)]};tt.TAG=ss(4);Pe.Card8=Pe.BYTE;tt.Card8=tt.BYTE;Pe.Card16=Pe.USHORT;tt.Card16=tt.USHORT;Pe.OffSize=Pe.BYTE;tt.OffSize=tt.BYTE;Pe.SID=Pe.USHORT;tt.SID=tt.USHORT;Pe.NUMBER=function(n){return n>=-107&&n<=107?[n+139]:n>=108&&n<=1131?(n=n-108,[(n>>8)+247,n&255]):n>=-1131&&n<=-108?(n=-n-108,[(n>>8)+251,n&255]):n>=-32768&&n<=32767?Pe.NUMBER16(n):Pe.NUMBER32(n)};tt.NUMBER=function(n){return Pe.NUMBER(n).length};Pe.NUMBER16=function(n){return[28,n>>8&255,n&255]};tt.NUMBER16=ss(3);Pe.NUMBER32=function(n){return[29,n>>24&255,n>>16&255,n>>8&255,n&255]};tt.NUMBER32=ss(5);Pe.REAL=function(n){var e=n.toString(),t=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(e);if(t){var r=parseFloat("1e"+((t[2]?+t[2]:0)+t[1].length));e=(Math.round(n*r)/r).toString()}for(var s="",i=0,o=e.length;i<o;i+=1){var a=e[i];a==="e"?s+=e[++i]==="-"?"c":"b":a==="."?s+="a":a==="-"?s+="e":s+=a}s+=s.length&1?"f":"ff";for(var c=[30],l=0,u=s.length;l<u;l+=2)c.push(parseInt(s.substr(l,2),16));return c};tt.REAL=function(n){return Pe.REAL(n).length};Pe.NAME=Pe.CHARARRAY;tt.NAME=tt.CHARARRAY;Pe.STRING=Pe.CHARARRAY;tt.STRING=tt.CHARARRAY;mc.UTF8=function(n,e,t){for(var r=[],s=t,i=0;i<s;i++,e+=1)r[i]=n.getUint8(e);return String.fromCharCode.apply(null,r)};mc.UTF16=function(n,e,t){for(var r=[],s=t/2,i=0;i<s;i++,e+=2)r[i]=n.getUint16(e);return String.fromCharCode.apply(null,r)};Pe.UTF16=function(n){for(var e=[],t=0;t<n.length;t+=1){var r=n.charCodeAt(t);e[e.length]=r>>8&255,e[e.length]=r&255}return e};tt.UTF16=function(n){return n.length*2};var xg={"x-mac-croatian":"","x-mac-cyrillic":"","x-mac-gaelic":"","x-mac-greek":"","x-mac-icelandic":"","x-mac-inuit":"","x-mac-ce":"",macintosh:"","x-mac-romanian":"","x-mac-turkish":""};mc.MACSTRING=function(n,e,t,r){var s=xg[r];if(s!==void 0){for(var i="",o=0;o<t;o++){var a=n.getUint8(e+o);a<=127?i+=String.fromCharCode(a):i+=s[a&127]}return i}};var sd=typeof WeakMap=="function"&&new WeakMap,id,wK=function(n){if(!id){id={};for(var e in xg)id[e]=new String(e)}var t=id[n];if(t!==void 0){if(sd){var r=sd.get(t);if(r!==void 0)return r}var s=xg[n];if(s!==void 0){for(var i={},o=0;o<s.length;o++)i[s.charCodeAt(o)]=o+128;return sd&&sd.set(t,i),i}}};Pe.MACSTRING=function(n,e){var t=wK(e);if(t!==void 0){for(var r=[],s=0;s<n.length;s++){var i=n.charCodeAt(s);if(i>=128&&(i=t[i],i===void 0))return;r[s]=i}return r}};tt.MACSTRING=function(n,e){var t=Pe.MACSTRING(n,e);return t!==void 0?t.length:0};function bg(n){return n>=-128&&n<=127}function OK(n,e,t){for(var r=0,s=n.length;e<s&&r<64&&n[e]===0;)++e,++r;return t.push(128|r-1),e}function PK(n,e,t){for(var r=0,s=n.length,i=e;i<s&&r<64;){var o=n[i];if(!bg(o)||o===0&&i+1<s&&n[i+1]===0)break;++i,++r}t.push(r-1);for(var a=e;a<i;++a)t.push(n[a]+256&255);return i}function NK(n,e,t){for(var r=0,s=n.length,i=e;i<s&&r<64;){var o=n[i];if(o===0||bg(o)&&i+1<s&&bg(n[i+1]))break;++i,++r}t.push(64|r-1);for(var a=e;a<i;++a){var c=n[a];t.push(c+65536>>8&255,c+256&255)}return i}Pe.VARDELTAS=function(n){for(var e=0,t=[];e<n.length;){var r=n[e];r===0?e=OK(n,e,t):r>=-128&&r<=127?e=PK(n,e,t):e=NK(n,e,t)}return t};Pe.INDEX=function(n){for(var e=1,t=[e],r=[],s=0;s<n.length;s+=1){var i=Pe.OBJECT(n[s]);Array.prototype.push.apply(r,i),e+=i.length,t.push(e)}if(r.length===0)return[0,0];for(var o=[],a=1+Math.floor(Math.log(e)/Math.log(2))/8|0,c=[void 0,Pe.BYTE,Pe.USHORT,Pe.UINT24,Pe.ULONG][a],l=0;l<t.length;l+=1){var u=c(t[l]);Array.prototype.push.apply(o,u)}return Array.prototype.concat(Pe.Card16(n.length),Pe.OffSize(a),o,r)};tt.INDEX=function(n){return Pe.INDEX(n).length};Pe.DICT=function(n){for(var e=[],t=Object.keys(n),r=t.length,s=0;s<r;s+=1){var i=parseInt(t[s],0),o=n[i];e=e.concat(Pe.OPERAND(o.value,o.type)),e=e.concat(Pe.OPERATOR(i))}return e};tt.DICT=function(n){return Pe.DICT(n).length};Pe.OPERATOR=function(n){return n<1200?[n]:[12,n-1200]};Pe.OPERAND=function(n,e){var t=[];if(Array.isArray(e))for(var r=0;r<e.length;r+=1)$e.argument(n.length===e.length,"Not enough arguments given for type"+e),t=t.concat(Pe.OPERAND(n[r],e[r]));else if(e==="SID")t=t.concat(Pe.NUMBER(n));else if(e==="offset")t=t.concat(Pe.NUMBER32(n));else if(e==="number")t=t.concat(Pe.NUMBER(n));else if(e==="real")t=t.concat(Pe.REAL(n));else throw new Error("Unknown operand type "+e);return t};Pe.OP=Pe.BYTE;tt.OP=tt.BYTE;var od=typeof WeakMap=="function"&&new WeakMap;Pe.CHARSTRING=function(n){if(od){var e=od.get(n);if(e!==void 0)return e}for(var t=[],r=n.length,s=0;s<r;s+=1){var i=n[s];t=t.concat(Pe[i.type](i.value))}return od&&od.set(n,t),t};tt.CHARSTRING=function(n){return Pe.CHARSTRING(n).length};Pe.OBJECT=function(n){var e=Pe[n.type];return $e.argument(e!==void 0,"No encoding function for type "+n.type),e(n.value)};tt.OBJECT=function(n){var e=tt[n.type];return $e.argument(e!==void 0,"No sizeOf function for type "+n.type),e(n.value)};Pe.TABLE=function(n){for(var e=[],t=n.fields.length,r=[],s=[],i=0;i<t;i+=1){var o=n.fields[i],a=Pe[o.type];$e.argument(a!==void 0,"No encoding function for field type "+o.type+" ("+o.name+")");var c=n[o.name];c===void 0&&(c=o.value);var l=a(c);o.type==="TABLE"?(s.push(e.length),e=e.concat([0,0]),r.push(l)):e=e.concat(l)}for(var u=0;u<r.length;u+=1){var h=s[u],d=e.length;$e.argument(d<65536,"Table "+n.tableName+" too big."),e[h]=d>>8,e[h+1]=d&255,e=e.concat(r[u])}return e};tt.TABLE=function(n){for(var e=0,t=n.fields.length,r=0;r<t;r+=1){var s=n.fields[r],i=tt[s.type];$e.argument(i!==void 0,"No sizeOf function for field type "+s.type+" ("+s.name+")");var o=n[s.name];o===void 0&&(o=s.value),e+=i(o),s.type==="TABLE"&&(e+=2)}return e};Pe.RECORD=Pe.TABLE;tt.RECORD=tt.TABLE;Pe.LITERAL=function(n){return n};tt.LITERAL=function(n){return n.length};function Nn(n,e,t){if(e.length&&(e[0].name!=="coverageFormat"||e[0].value===1))for(var r=0;r<e.length;r+=1){var s=e[r];this[s.name]=s.value}if(this.tableName=n,this.fields=e,t)for(var i=Object.keys(t),o=0;o<i.length;o+=1){var a=i[o],c=t[a];this[a]!==void 0&&(this[a]=c)}}Nn.prototype.encode=function(){return Pe.TABLE(this)};Nn.prototype.sizeOf=function(){return tt.TABLE(this)};function du(n,e,t){t===void 0&&(t=e.length);var r=new Array(e.length+1);r[0]={name:n+"Count",type:"USHORT",value:t};for(var s=0;s<e.length;s++)r[s+1]={name:n+s,type:"USHORT",value:e[s]};return r}function Cg(n,e,t){var r=e.length,s=new Array(r+1);s[0]={name:n+"Count",type:"USHORT",value:r};for(var i=0;i<r;i++)s[i+1]={name:n+i,type:"TABLE",value:t(e[i],i)};return s}function pu(n,e,t){var r=e.length,s=[];s[0]={name:n+"Count",type:"USHORT",value:r};for(var i=0;i<r;i++)s=s.concat(t(e[i],i));return s}function ap(n){n.format===1?Nn.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(du("glyph",n.glyphs))):n.format===2?Nn.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:2}].concat(pu("rangeRecord",n.ranges,function(e){return[{name:"startGlyphID",type:"USHORT",value:e.start},{name:"endGlyphID",type:"USHORT",value:e.end},{name:"startCoverageIndex",type:"USHORT",value:e.index}]}))):$e.assert(!1,"Coverage format must be 1 or 2.")}ap.prototype=Object.create(Nn.prototype);ap.prototype.constructor=ap;function cp(n){Nn.call(this,"scriptListTable",pu("scriptRecord",n,function(e,t){var r=e.script,s=r.defaultLangSys;return $e.assert(!!s,"Unable to write GSUB: script "+e.tag+" has no default language system."),[{name:"scriptTag"+t,type:"TAG",value:e.tag},{name:"script"+t,type:"TABLE",value:new Nn("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new Nn("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:s.reqFeatureIndex}].concat(du("featureIndex",s.featureIndexes)))}].concat(pu("langSys",r.langSysRecords,function(i,o){var a=i.langSys;return[{name:"langSysTag"+o,type:"TAG",value:i.tag},{name:"langSys"+o,type:"TABLE",value:new Nn("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:a.reqFeatureIndex}].concat(du("featureIndex",a.featureIndexes)))}]})))}]}))}cp.prototype=Object.create(Nn.prototype);cp.prototype.constructor=cp;function lp(n){Nn.call(this,"featureListTable",pu("featureRecord",n,function(e,t){var r=e.feature;return[{name:"featureTag"+t,type:"TAG",value:e.tag},{name:"feature"+t,type:"TABLE",value:new Nn("featureTable",[{name:"featureParams",type:"USHORT",value:r.featureParams}].concat(du("lookupListIndex",r.lookupListIndexes)))}]}))}lp.prototype=Object.create(Nn.prototype);lp.prototype.constructor=lp;function up(n,e){Nn.call(this,"lookupListTable",Cg("lookup",n,function(t){var r=e[t.lookupType];return $e.assert(!!r,"Unable to write GSUB lookup type "+t.lookupType+" tables."),new Nn("lookupTable",[{name:"lookupType",type:"USHORT",value:t.lookupType},{name:"lookupFlag",type:"USHORT",value:t.lookupFlag}].concat(Cg("subtable",t.subtables,r)))}))}up.prototype=Object.create(Nn.prototype);up.prototype.constructor=up;var Fe={Table:Nn,Record:Nn,Coverage:ap,ScriptList:cp,FeatureList:lp,LookupList:up,ushortList:du,tableList:Cg,recordList:pu};function DS(n,e){return n.getUint8(e)}function hp(n,e){return n.getUint16(e,!1)}function IK(n,e){return n.getInt16(e,!1)}function H0(n,e){return n.getUint32(e,!1)}function oO(n,e){var t=n.getInt16(e,!1),r=n.getUint16(e+2,!1);return t+r/65535}function DK(n,e){for(var t="",r=e;r<e+4;r+=1)t+=String.fromCharCode(n.getInt8(r));return t}function LK(n,e,t){for(var r=0,s=0;s<t;s+=1)r<<=8,r+=n.getUint8(e+s);return r}function FK(n,e,t){for(var r=[],s=e;s<t;s+=1)r.push(n.getUint8(s));return r}function UK(n){for(var e="",t=0;t<n.length;t+=1)e+=String.fromCharCode(n[t]);return e}var kK={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function ie(n,e){this.data=n,this.offset=e,this.relativeOffset=0}ie.prototype.parseByte=function(){var n=this.data.getUint8(this.offset+this.relativeOffset);return this.relativeOffset+=1,n};ie.prototype.parseChar=function(){var n=this.data.getInt8(this.offset+this.relativeOffset);return this.relativeOffset+=1,n};ie.prototype.parseCard8=ie.prototype.parseByte;ie.prototype.parseUShort=function(){var n=this.data.getUint16(this.offset+this.relativeOffset);return this.relativeOffset+=2,n};ie.prototype.parseCard16=ie.prototype.parseUShort;ie.prototype.parseSID=ie.prototype.parseUShort;ie.prototype.parseOffset16=ie.prototype.parseUShort;ie.prototype.parseShort=function(){var n=this.data.getInt16(this.offset+this.relativeOffset);return this.relativeOffset+=2,n};ie.prototype.parseF2Dot14=function(){var n=this.data.getInt16(this.offset+this.relativeOffset)/16384;return this.relativeOffset+=2,n};ie.prototype.parseULong=function(){var n=H0(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,n};ie.prototype.parseOffset32=ie.prototype.parseULong;ie.prototype.parseFixed=function(){var n=oO(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,n};ie.prototype.parseString=function(n){var e=this.data,t=this.offset+this.relativeOffset,r="";this.relativeOffset+=n;for(var s=0;s<n;s++)r+=String.fromCharCode(e.getUint8(t+s));return r};ie.prototype.parseTag=function(){return this.parseString(4)};ie.prototype.parseLongDateTime=function(){var n=H0(this.data,this.offset+this.relativeOffset+4);return n-=2082844800,this.relativeOffset+=8,n};ie.prototype.parseVersion=function(n){var e=hp(this.data,this.offset+this.relativeOffset),t=hp(this.data,this.offset+this.relativeOffset+2);return this.relativeOffset+=4,n===void 0&&(n=4096),e+t/n/10};ie.prototype.skip=function(n,e){e===void 0&&(e=1),this.relativeOffset+=kK[n]*e};ie.prototype.parseULongList=function(n){n===void 0&&(n=this.parseULong());for(var e=new Array(n),t=this.data,r=this.offset+this.relativeOffset,s=0;s<n;s++)e[s]=t.getUint32(r),r+=4;return this.relativeOffset+=n*4,e};ie.prototype.parseOffset16List=ie.prototype.parseUShortList=function(n){n===void 0&&(n=this.parseUShort());for(var e=new Array(n),t=this.data,r=this.offset+this.relativeOffset,s=0;s<n;s++)e[s]=t.getUint16(r),r+=2;return this.relativeOffset+=n*2,e};ie.prototype.parseShortList=function(n){for(var e=new Array(n),t=this.data,r=this.offset+this.relativeOffset,s=0;s<n;s++)e[s]=t.getInt16(r),r+=2;return this.relativeOffset+=n*2,e};ie.prototype.parseByteList=function(n){for(var e=new Array(n),t=this.data,r=this.offset+this.relativeOffset,s=0;s<n;s++)e[s]=t.getUint8(r++);return this.relativeOffset+=n,e};ie.prototype.parseList=function(n,e){e||(e=n,n=this.parseUShort());for(var t=new Array(n),r=0;r<n;r++)t[r]=e.call(this);return t};ie.prototype.parseList32=function(n,e){e||(e=n,n=this.parseULong());for(var t=new Array(n),r=0;r<n;r++)t[r]=e.call(this);return t};ie.prototype.parseRecordList=function(n,e){e||(e=n,n=this.parseUShort());for(var t=new Array(n),r=Object.keys(e),s=0;s<n;s++){for(var i={},o=0;o<r.length;o++){var a=r[o],c=e[a];i[a]=c.call(this)}t[s]=i}return t};ie.prototype.parseRecordList32=function(n,e){e||(e=n,n=this.parseULong());for(var t=new Array(n),r=Object.keys(e),s=0;s<n;s++){for(var i={},o=0;o<r.length;o++){var a=r[o],c=e[a];i[a]=c.call(this)}t[s]=i}return t};ie.prototype.parseStruct=function(n){if(typeof n=="function")return n.call(this);for(var e=Object.keys(n),t={},r=0;r<e.length;r++){var s=e[r],i=n[s];t[s]=i.call(this)}return t};ie.prototype.parseValueRecord=function(n){if(n===void 0&&(n=this.parseUShort()),n!==0){var e={};return n&1&&(e.xPlacement=this.parseShort()),n&2&&(e.yPlacement=this.parseShort()),n&4&&(e.xAdvance=this.parseShort()),n&8&&(e.yAdvance=this.parseShort()),n&16&&(e.xPlaDevice=void 0,this.parseShort()),n&32&&(e.yPlaDevice=void 0,this.parseShort()),n&64&&(e.xAdvDevice=void 0,this.parseShort()),n&128&&(e.yAdvDevice=void 0,this.parseShort()),e}};ie.prototype.parseValueRecordList=function(){for(var n=this.parseUShort(),e=this.parseUShort(),t=new Array(e),r=0;r<e;r++)t[r]=this.parseValueRecord(n);return t};ie.prototype.parsePointer=function(n){var e=this.parseOffset16();if(e>0)return new ie(this.data,this.offset+e).parseStruct(n)};ie.prototype.parsePointer32=function(n){var e=this.parseOffset32();if(e>0)return new ie(this.data,this.offset+e).parseStruct(n)};ie.prototype.parseListOfLists=function(n){for(var e=this.parseOffset16List(),t=e.length,r=this.relativeOffset,s=new Array(t),i=0;i<t;i++){var o=e[i];if(o===0){s[i]=void 0;continue}if(this.relativeOffset=o,n){for(var a=this.parseOffset16List(),c=new Array(a.length),l=0;l<a.length;l++)this.relativeOffset=o+a[l],c[l]=n.call(this);s[i]=c}else s[i]=this.parseUShortList()}return this.relativeOffset=r,s};ie.prototype.parseCoverage=function(){var n=this.offset+this.relativeOffset,e=this.parseUShort(),t=this.parseUShort();if(e===1)return{format:1,glyphs:this.parseUShortList(t)};if(e===2){for(var r=new Array(t),s=0;s<t;s++)r[s]={start:this.parseUShort(),end:this.parseUShort(),index:this.parseUShort()};return{format:2,ranges:r}}throw new Error("0x"+n.toString(16)+": Coverage format must be 1 or 2.")};ie.prototype.parseClassDef=function(){var n=this.offset+this.relativeOffset,e=this.parseUShort();if(e===1)return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()};if(e===2)return{format:2,ranges:this.parseRecordList({start:ie.uShort,end:ie.uShort,classId:ie.uShort})};throw new Error("0x"+n.toString(16)+": ClassDef format must be 1 or 2.")};ie.list=function(n,e){return function(){return this.parseList(n,e)}};ie.list32=function(n,e){return function(){return this.parseList32(n,e)}};ie.recordList=function(n,e){return function(){return this.parseRecordList(n,e)}};ie.recordList32=function(n,e){return function(){return this.parseRecordList32(n,e)}};ie.pointer=function(n){return function(){return this.parsePointer(n)}};ie.pointer32=function(n){return function(){return this.parsePointer32(n)}};ie.tag=ie.prototype.parseTag;ie.byte=ie.prototype.parseByte;ie.uShort=ie.offset16=ie.prototype.parseUShort;ie.uShortList=ie.prototype.parseUShortList;ie.uLong=ie.offset32=ie.prototype.parseULong;ie.uLongList=ie.prototype.parseULongList;ie.struct=ie.prototype.parseStruct;ie.coverage=ie.prototype.parseCoverage;ie.classDef=ie.prototype.parseClassDef;var LS={reserved:ie.uShort,reqFeatureIndex:ie.uShort,featureIndexes:ie.uShortList};ie.prototype.parseScriptList=function(){return this.parsePointer(ie.recordList({tag:ie.tag,script:ie.pointer({defaultLangSys:ie.pointer(LS),langSysRecords:ie.recordList({tag:ie.tag,langSys:ie.pointer(LS)})})}))||[]};ie.prototype.parseFeatureList=function(){return this.parsePointer(ie.recordList({tag:ie.tag,feature:ie.pointer({featureParams:ie.offset16,lookupListIndexes:ie.uShortList})}))||[]};ie.prototype.parseLookupList=function(n){return this.parsePointer(ie.list(ie.pointer(function(){var e=this.parseUShort();$e.argument(1<=e&&e<=9,"GPOS/GSUB lookup type "+e+" unknown.");var t=this.parseUShort(),r=t&16;return{lookupType:e,lookupFlag:t,subtables:this.parseList(ie.pointer(n[e])),markFilteringSet:r?this.parseUShort():void 0}})))||[]};ie.prototype.parseFeatureVariationsList=function(){return this.parsePointer32(function(){var n=this.parseUShort(),e=this.parseUShort();$e.argument(n===1&&e<1,"GPOS/GSUB feature variations table unknown.");var t=this.parseRecordList32({conditionSetOffset:ie.offset32,featureTableSubstitutionOffset:ie.offset32});return t})||[]};var He={getByte:DS,getCard8:DS,getUShort:hp,getCard16:hp,getShort:IK,getULong:H0,getFixed:oO,getTag:DK,getOffset:LK,getBytes:FK,bytesToString:UK,Parser:ie};function BK(n,e){e.parseUShort(),n.length=e.parseULong(),n.language=e.parseULong();var t;n.groupCount=t=e.parseULong(),n.glyphIndexMap={};for(var r=0;r<t;r+=1)for(var s=e.parseULong(),i=e.parseULong(),o=e.parseULong(),a=s;a<=i;a+=1)n.glyphIndexMap[a]=o,o++}function GK(n,e,t,r,s){n.length=e.parseUShort(),n.language=e.parseUShort();var i;n.segCount=i=e.parseUShort()>>1,e.skip("uShort",3),n.glyphIndexMap={};for(var o=new He.Parser(t,r+s+14),a=new He.Parser(t,r+s+16+i*2),c=new He.Parser(t,r+s+16+i*4),l=new He.Parser(t,r+s+16+i*6),u=r+s+16+i*8,h=0;h<i-1;h+=1)for(var d=void 0,p=o.parseUShort(),_=a.parseUShort(),g=c.parseShort(),f=l.parseUShort(),m=_;m<=p;m+=1)f!==0?(u=l.offset+l.relativeOffset-2,u+=f,u+=(m-_)*2,d=He.getUShort(t,u),d!==0&&(d=d+g&65535)):d=m+g&65535,n.glyphIndexMap[m]=d}function VK(n,e){var t={};t.version=He.getUShort(n,e),$e.argument(t.version===0,"cmap table version should be 0."),t.numTables=He.getUShort(n,e+2);for(var r=-1,s=t.numTables-1;s>=0;s-=1){var i=He.getUShort(n,e+4+s*8),o=He.getUShort(n,e+4+s*8+2);if(i===3&&(o===0||o===1||o===10)||i===0&&(o===0||o===1||o===2||o===3||o===4)){r=He.getULong(n,e+4+s*8+4);break}}if(r===-1)throw new Error("No valid cmap sub-tables found.");var a=new He.Parser(n,e+r);if(t.format=a.parseUShort(),t.format===12)BK(t,a);else if(t.format===4)GK(t,a,n,e,r);else throw new Error("Only format 4 and 12 cmap tables are supported (found format "+t.format+").");return t}function zK(n,e,t){n.segments.push({end:e,start:e,delta:-(e-t),offset:0,glyphIndex:t})}function HK(n){n.segments.push({end:65535,start:65535,delta:1,offset:0})}function jK(n){var e=!0,t;for(t=n.length-1;t>0;t-=1){var r=n.get(t);if(r.unicode>65535){console.log("Adding CMAP format 12 (needed!)"),e=!1;break}}var s=[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:e?1:2},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:e?12:12+8}];e||(s=s.concat([{name:"cmap12PlatformID",type:"USHORT",value:3},{name:"cmap12EncodingID",type:"USHORT",value:10},{name:"cmap12Offset",type:"ULONG",value:0}])),s=s.concat([{name:"format",type:"USHORT",value:4},{name:"cmap4Length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);var i=new Fe.Table("cmap",s);for(i.segments=[],t=0;t<n.length;t+=1){for(var o=n.get(t),a=0;a<o.unicodes.length;a+=1)zK(i,o.unicodes[a],t);i.segments=i.segments.sort(function(y,v){return y.start-v.start})}HK(i);var c=i.segments.length,l=0,u=[],h=[],d=[],p=[],_=[],g=[];for(t=0;t<c;t+=1){var f=i.segments[t];f.end<=65535&&f.start<=65535?(u=u.concat({name:"end_"+t,type:"USHORT",value:f.end}),h=h.concat({name:"start_"+t,type:"USHORT",value:f.start}),d=d.concat({name:"idDelta_"+t,type:"SHORT",value:f.delta}),p=p.concat({name:"idRangeOffset_"+t,type:"USHORT",value:f.offset}),f.glyphId!==void 0&&(_=_.concat({name:"glyph_"+t,type:"USHORT",value:f.glyphId}))):l+=1,!e&&f.glyphIndex!==void 0&&(g=g.concat({name:"cmap12Start_"+t,type:"ULONG",value:f.start}),g=g.concat({name:"cmap12End_"+t,type:"ULONG",value:f.end}),g=g.concat({name:"cmap12Glyph_"+t,type:"ULONG",value:f.glyphIndex}))}if(i.segCountX2=(c-l)*2,i.searchRange=Math.pow(2,Math.floor(Math.log(c-l)/Math.log(2)))*2,i.entrySelector=Math.log(i.searchRange/2)/Math.log(2),i.rangeShift=i.segCountX2-i.searchRange,i.fields=i.fields.concat(u),i.fields.push({name:"reservedPad",type:"USHORT",value:0}),i.fields=i.fields.concat(h),i.fields=i.fields.concat(d),i.fields=i.fields.concat(p),i.fields=i.fields.concat(_),i.cmap4Length=14+u.length*2+2+h.length*2+d.length*2+p.length*2+_.length*2,!e){var m=16+g.length*4;i.cmap12Offset=12+2*2+4+i.cmap4Length,i.fields=i.fields.concat([{name:"cmap12Format",type:"USHORT",value:12},{name:"cmap12Reserved",type:"USHORT",value:0},{name:"cmap12Length",type:"ULONG",value:m},{name:"cmap12Language",type:"ULONG",value:0},{name:"cmap12nGroups",type:"ULONG",value:g.length/3}]),i.fields=i.fields.concat(g)}return i}var aO={parse:VK,make:jK},Rd=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"],WK=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"],XK=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"],yo=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function cO(n){this.font=n}cO.prototype.charToGlyphIndex=function(n){var e=n.codePointAt(0),t=this.font.glyphs;if(t){for(var r=0;r<t.length;r+=1)for(var s=t.get(r),i=0;i<s.unicodes.length;i+=1)if(s.unicodes[i]===e)return r}return null};function lO(n){this.cmap=n}lO.prototype.charToGlyphIndex=function(n){return this.cmap.glyphIndexMap[n.codePointAt(0)]||0};function dp(n,e){this.encoding=n,this.charset=e}dp.prototype.charToGlyphIndex=function(n){var e=n.codePointAt(0),t=this.encoding[e];return this.charset.indexOf(t)};function j0(n){switch(n.version){case 1:this.names=yo.slice();break;case 2:this.names=new Array(n.numberOfGlyphs);for(var e=0;e<n.numberOfGlyphs;e++)n.glyphNameIndex[e]<yo.length?this.names[e]=yo[n.glyphNameIndex[e]]:this.names[e]=n.names[n.glyphNameIndex[e]-yo.length];break;case 2.5:this.names=new Array(n.numberOfGlyphs);for(var t=0;t<n.numberOfGlyphs;t++)this.names[t]=yo[t+n.glyphNameIndex[t]];break;case 3:this.names=[];break;default:this.names=[];break}}j0.prototype.nameToGlyphIndex=function(n){return this.names.indexOf(n)};j0.prototype.glyphIndexToName=function(n){return this.names[n]};function $K(n){for(var e,t=n.tables.cmap.glyphIndexMap,r=Object.keys(t),s=0;s<r.length;s+=1){var i=r[s],o=t[i];e=n.glyphs.get(o),e.addUnicode(parseInt(i))}for(var a=0;a<n.glyphs.length;a+=1)e=n.glyphs.get(a),n.cffEncoding?n.isCIDFont?e.name="gid"+a:e.name=n.cffEncoding.charset[a]:n.glyphNames.names&&(e.name=n.glyphNames.glyphIndexToName(a))}function qK(n){n._IndexToUnicodeMap={};for(var e=n.tables.cmap.glyphIndexMap,t=Object.keys(e),r=0;r<t.length;r+=1){var s=t[r],i=e[s];n._IndexToUnicodeMap[i]===void 0?n._IndexToUnicodeMap[i]={unicodes:[parseInt(s)]}:n._IndexToUnicodeMap[i].unicodes.push(parseInt(s))}}function YK(n,e){e.lowMemory?qK(n):$K(n)}function KK(n,e,t,r,s){n.beginPath(),n.moveTo(e,t),n.lineTo(r,s),n.stroke()}var ao={line:KK};function ZK(n,e){var t=e||new vn;return{configurable:!0,get:function(){return typeof t=="function"&&(t=t()),t},set:function(r){t=r}}}function xr(n){this.bindConstructorValues(n)}xr.prototype.bindConstructorValues=function(n){this.index=n.index||0,this.name=n.name||null,this.unicode=n.unicode||void 0,this.unicodes=n.unicodes||n.unicode!==void 0?[n.unicode]:[],"xMin"in n&&(this.xMin=n.xMin),"yMin"in n&&(this.yMin=n.yMin),"xMax"in n&&(this.xMax=n.xMax),"yMax"in n&&(this.yMax=n.yMax),"advanceWidth"in n&&(this.advanceWidth=n.advanceWidth),Object.defineProperty(this,"path",ZK(this,n.path))};xr.prototype.addUnicode=function(n){this.unicodes.length===0&&(this.unicode=n),this.unicodes.push(n)};xr.prototype.getBoundingBox=function(){return this.path.getBoundingBox()};xr.prototype.getPath=function(n,e,t,r,s){n=n!==void 0?n:0,e=e!==void 0?e:0,t=t!==void 0?t:72;var i,o;r||(r={});var a=r.xScale,c=r.yScale;if(r.hinting&&s&&s.hinting&&(o=this.path&&s.hinting.exec(this,t)),o)i=s.hinting.getCommands(o),n=Math.round(n),e=Math.round(e),a=c=1;else{i=this.path.commands;var l=1/(this.path.unitsPerEm||1e3)*t;a===void 0&&(a=l),c===void 0&&(c=l)}for(var u=new vn,h=0;h<i.length;h+=1){var d=i[h];d.type==="M"?u.moveTo(n+d.x*a,e+-d.y*c):d.type==="L"?u.lineTo(n+d.x*a,e+-d.y*c):d.type==="Q"?u.quadraticCurveTo(n+d.x1*a,e+-d.y1*c,n+d.x*a,e+-d.y*c):d.type==="C"?u.curveTo(n+d.x1*a,e+-d.y1*c,n+d.x2*a,e+-d.y2*c,n+d.x*a,e+-d.y*c):d.type==="Z"&&u.closePath()}return u};xr.prototype.getContours=function(){if(this.points===void 0)return[];for(var n=[],e=[],t=0;t<this.points.length;t+=1){var r=this.points[t];e.push(r),r.lastPointOfContour&&(n.push(e),e=[])}return $e.argument(e.length===0,"There are still points left in the current contour."),n};xr.prototype.getMetrics=function(){for(var n=this.path.commands,e=[],t=[],r=0;r<n.length;r+=1){var s=n[r];s.type!=="Z"&&(e.push(s.x),t.push(s.y)),(s.type==="Q"||s.type==="C")&&(e.push(s.x1),t.push(s.y1)),s.type==="C"&&(e.push(s.x2),t.push(s.y2))}var i={xMin:Math.min.apply(null,e),yMin:Math.min.apply(null,t),xMax:Math.max.apply(null,e),yMax:Math.max.apply(null,t),leftSideBearing:this.leftSideBearing};return isFinite(i.xMin)||(i.xMin=0),isFinite(i.xMax)||(i.xMax=this.advanceWidth),isFinite(i.yMin)||(i.yMin=0),isFinite(i.yMax)||(i.yMax=0),i.rightSideBearing=this.advanceWidth-i.leftSideBearing-(i.xMax-i.xMin),i};xr.prototype.draw=function(n,e,t,r,s){this.getPath(e,t,r,s).draw(n)};xr.prototype.drawPoints=function(n,e,t,r){function s(h,d,p,_){n.beginPath();for(var g=0;g<h.length;g+=1)n.moveTo(d+h[g].x*_,p+h[g].y*_),n.arc(d+h[g].x*_,p+h[g].y*_,2,0,Math.PI*2,!1);n.closePath(),n.fill()}e=e!==void 0?e:0,t=t!==void 0?t:0,r=r!==void 0?r:24;for(var i=1/this.path.unitsPerEm*r,o=[],a=[],c=this.path,l=0;l<c.commands.length;l+=1){var u=c.commands[l];u.x!==void 0&&o.push({x:u.x,y:-u.y}),u.x1!==void 0&&a.push({x:u.x1,y:-u.y1}),u.x2!==void 0&&a.push({x:u.x2,y:-u.y2})}n.fillStyle="blue",s(o,e,t,i),n.fillStyle="red",s(a,e,t,i)};xr.prototype.drawMetrics=function(n,e,t,r){var s;e=e!==void 0?e:0,t=t!==void 0?t:0,r=r!==void 0?r:24,s=1/this.path.unitsPerEm*r,n.lineWidth=1,n.strokeStyle="black",ao.line(n,e,-1e4,e,1e4),ao.line(n,-1e4,t,1e4,t);var i=this.xMin||0,o=this.yMin||0,a=this.xMax||0,c=this.yMax||0,l=this.advanceWidth||0;n.strokeStyle="blue",ao.line(n,e+i*s,-1e4,e+i*s,1e4),ao.line(n,e+a*s,-1e4,e+a*s,1e4),ao.line(n,-1e4,t+-o*s,1e4,t+-o*s),ao.line(n,-1e4,t+-c*s,1e4,t+-c*s),n.strokeStyle="green",ao.line(n,e+l*s,-1e4,e+l*s,1e4)};function ad(n,e,t){Object.defineProperty(n,e,{get:function(){return n.path,n[t]},set:function(r){n[t]=r},enumerable:!0,configurable:!0})}function W0(n,e){if(this.font=n,this.glyphs={},Array.isArray(e))for(var t=0;t<e.length;t++){var r=e[t];r.path.unitsPerEm=n.unitsPerEm,this.glyphs[t]=r}this.length=e&&e.length||0}W0.prototype.get=function(n){if(this.glyphs[n]===void 0){this.font._push(n),typeof this.glyphs[n]=="function"&&(this.glyphs[n]=this.glyphs[n]());var e=this.glyphs[n],t=this.font._IndexToUnicodeMap[n];if(t)for(var r=0;r<t.unicodes.length;r++)e.addUnicode(t.unicodes[r]);this.font.cffEncoding?this.font.isCIDFont?e.name="gid"+n:e.name=this.font.cffEncoding.charset[n]:this.font.glyphNames.names&&(e.name=this.font.glyphNames.glyphIndexToName(n)),this.glyphs[n].advanceWidth=this.font._hmtxTableData[n].advanceWidth,this.glyphs[n].leftSideBearing=this.font._hmtxTableData[n].leftSideBearing}else typeof this.glyphs[n]=="function"&&(this.glyphs[n]=this.glyphs[n]());return this.glyphs[n]};W0.prototype.push=function(n,e){this.glyphs[n]=e,this.length++};function JK(n,e){return new xr({index:e,font:n})}function QK(n,e,t,r,s,i){return function(){var o=new xr({index:e,font:n});return o.path=function(){t(o,r,s);var a=i(n.glyphs,o);return a.unitsPerEm=n.unitsPerEm,a},ad(o,"xMin","_xMin"),ad(o,"xMax","_xMax"),ad(o,"yMin","_yMin"),ad(o,"yMax","_yMax"),o}}function eZ(n,e,t,r){return function(){var s=new xr({index:e,font:n});return s.path=function(){var i=t(n,s,r);return i.unitsPerEm=n.unitsPerEm,i},s}}var As={GlyphSet:W0,glyphLoader:JK,ttfGlyphLoader:QK,cffGlyphLoader:eZ};function uO(n,e){if(n===e)return!0;if(Array.isArray(n)&&Array.isArray(e)){if(n.length!==e.length)return!1;for(var t=0;t<n.length;t+=1)if(!uO(n[t],e[t]))return!1;return!0}else return!1}function Eg(n){var e;return n.length<1240?e=107:n.length<33900?e=1131:e=32768,e}function Ci(n,e,t){var r=[],s=[],i=He.getCard16(n,e),o,a;if(i!==0){var c=He.getByte(n,e+2);o=e+(i+1)*c+2;for(var l=e+3,u=0;u<i+1;u+=1)r.push(He.getOffset(n,l,c)),l+=c;a=o+r[i]}else a=e+2;for(var h=0;h<r.length-1;h+=1){var d=He.getBytes(n,o+r[h],o+r[h+1]);t&&(d=t(d)),s.push(d)}return{objects:s,startOffset:e,endOffset:a}}function tZ(n,e){var t=[],r=He.getCard16(n,e),s,i;if(r!==0){var o=He.getByte(n,e+2);s=e+(r+1)*o+2;for(var a=e+3,c=0;c<r+1;c+=1)t.push(He.getOffset(n,a,o)),a+=o;i=s+t[r]}else i=e+2;return{offsets:t,startOffset:e,endOffset:i}}function nZ(n,e,t,r,s){var i=He.getCard16(t,r),o=0;if(i!==0){var a=He.getByte(t,r+2);o=r+(i+1)*a+2}var c=He.getBytes(t,o+e[n],o+e[n+1]);return s&&(c=s(c)),c}function rZ(n){for(var e="",t=15,r=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];;){var s=n.parseByte(),i=s>>4,o=s&15;if(i===t||(e+=r[i],o===t))break;e+=r[o]}return parseFloat(e)}function sZ(n,e){var t,r,s,i;if(e===28)return t=n.parseByte(),r=n.parseByte(),t<<8|r;if(e===29)return t=n.parseByte(),r=n.parseByte(),s=n.parseByte(),i=n.parseByte(),t<<24|r<<16|s<<8|i;if(e===30)return rZ(n);if(e>=32&&e<=246)return e-139;if(e>=247&&e<=250)return t=n.parseByte(),(e-247)*256+t+108;if(e>=251&&e<=254)return t=n.parseByte(),-(e-251)*256-t-108;throw new Error("Invalid b0 "+e)}function iZ(n){for(var e={},t=0;t<n.length;t+=1){var r=n[t][0],s=n[t][1],i=void 0;if(s.length===1?i=s[0]:i=s,e.hasOwnProperty(r)&&!isNaN(e[r]))throw new Error("Object "+e+" already has key "+r);e[r]=i}return e}function hO(n,e,t){e=e!==void 0?e:0;var r=new He.Parser(n,e),s=[],i=[];for(t=t!==void 0?t:n.length;r.relativeOffset<t;){var o=r.parseByte();o<=21?(o===12&&(o=1200+r.parseByte()),s.push([o,i]),i=[]):i.push(sZ(r,o))}return iZ(s)}function Nl(n,e){return e<=390?e=Rd[e]:e=n[e-391],e}function dO(n,e,t){for(var r={},s,i=0;i<e.length;i+=1){var o=e[i];if(Array.isArray(o.type)){var a=[];a.length=o.type.length;for(var c=0;c<o.type.length;c++)s=n[o.op]!==void 0?n[o.op][c]:void 0,s===void 0&&(s=o.value!==void 0&&o.value[c]!==void 0?o.value[c]:null),o.type[c]==="SID"&&(s=Nl(t,s)),a[c]=s;r[o.name]=a}else s=n[o.op],s===void 0&&(s=o.value!==void 0?o.value:null),o.type==="SID"&&(s=Nl(t,s)),r[o.name]=s}return r}function oZ(n,e){var t={};return t.formatMajor=He.getCard8(n,e),t.formatMinor=He.getCard8(n,e+1),t.size=He.getCard8(n,e+2),t.offsetSize=He.getCard8(n,e+3),t.startOffset=e,t.endOffset=e+4,t}var pO=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}],fO=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function aZ(n,e){var t=hO(n,0,n.byteLength);return dO(t,pO,e)}function mO(n,e,t,r){var s=hO(n,e,t);return dO(s,fO,r)}function FS(n,e,t,r){for(var s=[],i=0;i<t.length;i+=1){var o=new DataView(new Uint8Array(t[i]).buffer),a=aZ(o,r);a._subrs=[],a._subrsBias=0,a._defaultWidthX=0,a._nominalWidthX=0;var c=a.private[0],l=a.private[1];if(c!==0&&l!==0){var u=mO(n,l+e,c,r);if(a._defaultWidthX=u.defaultWidthX,a._nominalWidthX=u.nominalWidthX,u.subrs!==0){var h=l+u.subrs,d=Ci(n,h+e);a._subrs=d.objects,a._subrsBias=Eg(a._subrs)}a._privateDict=u}s.push(a)}return s}function cZ(n,e,t,r){var s,i,o=new He.Parser(n,e);t-=1;var a=[".notdef"],c=o.parseCard8();if(c===0)for(var l=0;l<t;l+=1)s=o.parseSID(),a.push(Nl(r,s));else if(c===1)for(;a.length<=t;){s=o.parseSID(),i=o.parseCard8();for(var u=0;u<=i;u+=1)a.push(Nl(r,s)),s+=1}else if(c===2)for(;a.length<=t;){s=o.parseSID(),i=o.parseCard16();for(var h=0;h<=i;h+=1)a.push(Nl(r,s)),s+=1}else throw new Error("Unknown charset format "+c);return a}function lZ(n,e,t){var r,s={},i=new He.Parser(n,e),o=i.parseCard8();if(o===0)for(var a=i.parseCard8(),c=0;c<a;c+=1)r=i.parseCard8(),s[r]=c;else if(o===1){var l=i.parseCard8();r=1;for(var u=0;u<l;u+=1)for(var h=i.parseCard8(),d=i.parseCard8(),p=h;p<=h+d;p+=1)s[p]=r,r+=1}else throw new Error("Unknown encoding format "+o);return new dp(s,t)}function US(n,e,t){var r,s,i,o,a=new vn,c=[],l=0,u=!1,h=!1,d=0,p=0,_,g,f,m;if(n.isCIDFont){var y=n.tables.cff.topDict._fdSelect[e.index],v=n.tables.cff.topDict._fdArray[y];_=v._subrs,g=v._subrsBias,f=v._defaultWidthX,m=v._nominalWidthX}else _=n.tables.cff.topDict._subrs,g=n.tables.cff.topDict._subrsBias,f=n.tables.cff.topDict._defaultWidthX,m=n.tables.cff.topDict._nominalWidthX;var b=f;function x(R,C){h&&a.closePath(),a.moveTo(R,C),h=!0}function E(){var R;R=c.length%2!==0,R&&!u&&(b=c.shift()+m),l+=c.length>>1,c.length=0,u=!0}function S(R){for(var C,M,G,F,X,N,j,K,$,q,ne,le,ue=0;ue<R.length;){var Ee=R[ue];switch(ue+=1,Ee){case 1:E();break;case 3:E();break;case 4:c.length>1&&!u&&(b=c.shift()+m,u=!0),p+=c.pop(),x(d,p);break;case 5:for(;c.length>0;)d+=c.shift(),p+=c.shift(),a.lineTo(d,p);break;case 6:for(;c.length>0&&(d+=c.shift(),a.lineTo(d,p),c.length!==0);)p+=c.shift(),a.lineTo(d,p);break;case 7:for(;c.length>0&&(p+=c.shift(),a.lineTo(d,p),c.length!==0);)d+=c.shift(),a.lineTo(d,p);break;case 8:for(;c.length>0;)r=d+c.shift(),s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),d=i+c.shift(),p=o+c.shift(),a.curveTo(r,s,i,o,d,p);break;case 10:X=c.pop()+g,N=_[X],N&&S(N);break;case 11:return;case 12:switch(Ee=R[ue],ue+=1,Ee){case 35:r=d+c.shift(),s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),j=i+c.shift(),K=o+c.shift(),$=j+c.shift(),q=K+c.shift(),ne=$+c.shift(),le=q+c.shift(),d=ne+c.shift(),p=le+c.shift(),c.shift(),a.curveTo(r,s,i,o,j,K),a.curveTo($,q,ne,le,d,p);break;case 34:r=d+c.shift(),s=p,i=r+c.shift(),o=s+c.shift(),j=i+c.shift(),K=o,$=j+c.shift(),q=o,ne=$+c.shift(),le=p,d=ne+c.shift(),a.curveTo(r,s,i,o,j,K),a.curveTo($,q,ne,le,d,p);break;case 36:r=d+c.shift(),s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),j=i+c.shift(),K=o,$=j+c.shift(),q=o,ne=$+c.shift(),le=q+c.shift(),d=ne+c.shift(),a.curveTo(r,s,i,o,j,K),a.curveTo($,q,ne,le,d,p);break;case 37:r=d+c.shift(),s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),j=i+c.shift(),K=o+c.shift(),$=j+c.shift(),q=K+c.shift(),ne=$+c.shift(),le=q+c.shift(),Math.abs(ne-d)>Math.abs(le-p)?d=ne+c.shift():p=le+c.shift(),a.curveTo(r,s,i,o,j,K),a.curveTo($,q,ne,le,d,p);break;default:console.log("Glyph "+e.index+": unknown operator 1200"+Ee),c.length=0}break;case 14:c.length>0&&!u&&(b=c.shift()+m,u=!0),h&&(a.closePath(),h=!1);break;case 18:E();break;case 19:case 20:E(),ue+=l+7>>3;break;case 21:c.length>2&&!u&&(b=c.shift()+m,u=!0),p+=c.pop(),d+=c.pop(),x(d,p);break;case 22:c.length>1&&!u&&(b=c.shift()+m,u=!0),d+=c.pop(),x(d,p);break;case 23:E();break;case 24:for(;c.length>2;)r=d+c.shift(),s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),d=i+c.shift(),p=o+c.shift(),a.curveTo(r,s,i,o,d,p);d+=c.shift(),p+=c.shift(),a.lineTo(d,p);break;case 25:for(;c.length>6;)d+=c.shift(),p+=c.shift(),a.lineTo(d,p);r=d+c.shift(),s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),d=i+c.shift(),p=o+c.shift(),a.curveTo(r,s,i,o,d,p);break;case 26:for(c.length%2&&(d+=c.shift());c.length>0;)r=d,s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),d=i,p=o+c.shift(),a.curveTo(r,s,i,o,d,p);break;case 27:for(c.length%2&&(p+=c.shift());c.length>0;)r=d+c.shift(),s=p,i=r+c.shift(),o=s+c.shift(),d=i+c.shift(),p=o,a.curveTo(r,s,i,o,d,p);break;case 28:C=R[ue],M=R[ue+1],c.push((C<<24|M<<16)>>16),ue+=2;break;case 29:X=c.pop()+n.gsubrsBias,N=n.gsubrs[X],N&&S(N);break;case 30:for(;c.length>0&&(r=d,s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),d=i+c.shift(),p=o+(c.length===1?c.shift():0),a.curveTo(r,s,i,o,d,p),c.length!==0);)r=d+c.shift(),s=p,i=r+c.shift(),o=s+c.shift(),p=o+c.shift(),d=i+(c.length===1?c.shift():0),a.curveTo(r,s,i,o,d,p);break;case 31:for(;c.length>0&&(r=d+c.shift(),s=p,i=r+c.shift(),o=s+c.shift(),p=o+c.shift(),d=i+(c.length===1?c.shift():0),a.curveTo(r,s,i,o,d,p),c.length!==0);)r=d,s=p+c.shift(),i=r+c.shift(),o=s+c.shift(),d=i+c.shift(),p=o+(c.length===1?c.shift():0),a.curveTo(r,s,i,o,d,p);break;default:Ee<32?console.log("Glyph "+e.index+": unknown operator "+Ee):Ee<247?c.push(Ee-139):Ee<251?(C=R[ue],ue+=1,c.push((Ee-247)*256+C+108)):Ee<255?(C=R[ue],ue+=1,c.push(-(Ee-251)*256-C-108)):(C=R[ue],M=R[ue+1],G=R[ue+2],F=R[ue+3],ue+=4,c.push((C<<24|M<<16|G<<8|F)/65536))}}}return S(t),e.advanceWidth=b,a}function uZ(n,e,t,r){var s=[],i,o=new He.Parser(n,e),a=o.parseCard8();if(a===0)for(var c=0;c<t;c++){if(i=o.parseCard8(),i>=r)throw new Error("CFF table CID Font FDSelect has bad FD index value "+i+" (FD count "+r+")");s.push(i)}else if(a===3){var l=o.parseCard16(),u=o.parseCard16();if(u!==0)throw new Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+u);for(var h,d=0;d<l;d++){if(i=o.parseCard8(),h=o.parseCard16(),i>=r)throw new Error("CFF table CID Font FDSelect has bad FD index value "+i+" (FD count "+r+")");if(h>t)throw new Error("CFF Table CID Font FDSelect format 3 range has bad GID "+h);for(;u<h;u++)s.push(i);u=h}if(h!==t)throw new Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+h)}else throw new Error("CFF Table CID Font FDSelect table has unsupported format "+a);return s}function hZ(n,e,t,r){t.tables.cff={};var s=oZ(n,e),i=Ci(n,s.endOffset,He.bytesToString),o=Ci(n,i.endOffset),a=Ci(n,o.endOffset,He.bytesToString),c=Ci(n,a.endOffset);t.gsubrs=c.objects,t.gsubrsBias=Eg(t.gsubrs);var l=FS(n,e,o.objects,a.objects);if(l.length!==1)throw new Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+l.length);var u=l[0];if(t.tables.cff.topDict=u,u._privateDict&&(t.defaultWidthX=u._privateDict.defaultWidthX,t.nominalWidthX=u._privateDict.nominalWidthX),u.ros[0]!==void 0&&u.ros[1]!==void 0&&(t.isCIDFont=!0),t.isCIDFont){var h=u.fdArray,d=u.fdSelect;if(h===0||d===0)throw new Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing");h+=e;var p=Ci(n,h),_=FS(n,e,p.objects,a.objects);u._fdArray=_,d+=e,u._fdSelect=uZ(n,d,t.numGlyphs,_.length)}var g=e+u.private[1],f=mO(n,g,u.private[0],a.objects);if(t.defaultWidthX=f.defaultWidthX,t.nominalWidthX=f.nominalWidthX,f.subrs!==0){var m=g+f.subrs,y=Ci(n,m);t.subrs=y.objects,t.subrsBias=Eg(t.subrs)}else t.subrs=[],t.subrsBias=0;var v;r.lowMemory?(v=tZ(n,e+u.charStrings),t.nGlyphs=v.offsets.length):(v=Ci(n,e+u.charStrings),t.nGlyphs=v.objects.length);var b=cZ(n,e+u.charset,t.nGlyphs,a.objects);if(u.encoding===0?t.cffEncoding=new dp(WK,b):u.encoding===1?t.cffEncoding=new dp(XK,b):t.cffEncoding=lZ(n,e+u.encoding,b),t.encoding=t.encoding||t.cffEncoding,t.glyphs=new As.GlyphSet(t),r.lowMemory)t._push=function(S){var R=nZ(S,v.offsets,n,e+u.charStrings);t.glyphs.push(S,As.cffGlyphLoader(t,S,US,R))};else for(var x=0;x<t.nGlyphs;x+=1){var E=v.objects[x];t.glyphs.push(x,As.cffGlyphLoader(t,x,US,E))}}function _O(n,e){var t,r=Rd.indexOf(n);return r>=0&&(t=r),r=e.indexOf(n),r>=0?t=r+Rd.length:(t=Rd.length+e.length,e.push(n)),t}function dZ(){return new Fe.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}])}function pZ(n){var e=new Fe.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);e.names=[];for(var t=0;t<n.length;t+=1)e.names.push({name:"name_"+t,type:"NAME",value:n[t]});return e}function gO(n,e,t){for(var r={},s=0;s<n.length;s+=1){var i=n[s],o=e[i.name];o!==void 0&&!uO(o,i.value)&&(i.type==="SID"&&(o=_O(o,t)),r[i.op]={name:i.name,type:i.type,value:o})}return r}function kS(n,e){var t=new Fe.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);return t.dict=gO(pO,n,e),t}function BS(n){var e=new Fe.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);return e.topDicts=[{name:"topDict_0",type:"TABLE",value:n}],e}function fZ(n){var e=new Fe.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);e.strings=[];for(var t=0;t<n.length;t+=1)e.strings.push({name:"string_"+t,type:"STRING",value:n[t]});return e}function mZ(){return new Fe.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}])}function _Z(n,e){for(var t=new Fe.Record("Charsets",[{name:"format",type:"Card8",value:0}]),r=0;r<n.length;r+=1){var s=n[r],i=_O(s,e);t.fields.push({name:"glyph_"+r,type:"SID",value:i})}return t}function gZ(n){var e=[],t=n.path;e.push({name:"width",type:"NUMBER",value:n.advanceWidth});for(var r=0,s=0,i=0;i<t.commands.length;i+=1){var o=void 0,a=void 0,c=t.commands[i];if(c.type==="Q"){var l=.3333333333333333,u=2/3;c={type:"C",x:c.x,y:c.y,x1:Math.round(l*r+u*c.x1),y1:Math.round(l*s+u*c.y1),x2:Math.round(l*c.x+u*c.x1),y2:Math.round(l*c.y+u*c.y1)}}if(c.type==="M")o=Math.round(c.x-r),a=Math.round(c.y-s),e.push({name:"dx",type:"NUMBER",value:o}),e.push({name:"dy",type:"NUMBER",value:a}),e.push({name:"rmoveto",type:"OP",value:21}),r=Math.round(c.x),s=Math.round(c.y);else if(c.type==="L")o=Math.round(c.x-r),a=Math.round(c.y-s),e.push({name:"dx",type:"NUMBER",value:o}),e.push({name:"dy",type:"NUMBER",value:a}),e.push({name:"rlineto",type:"OP",value:5}),r=Math.round(c.x),s=Math.round(c.y);else if(c.type==="C"){var h=Math.round(c.x1-r),d=Math.round(c.y1-s),p=Math.round(c.x2-c.x1),_=Math.round(c.y2-c.y1);o=Math.round(c.x-c.x2),a=Math.round(c.y-c.y2),e.push({name:"dx1",type:"NUMBER",value:h}),e.push({name:"dy1",type:"NUMBER",value:d}),e.push({name:"dx2",type:"NUMBER",value:p}),e.push({name:"dy2",type:"NUMBER",value:_}),e.push({name:"dx",type:"NUMBER",value:o}),e.push({name:"dy",type:"NUMBER",value:a}),e.push({name:"rrcurveto",type:"OP",value:8}),r=Math.round(c.x),s=Math.round(c.y)}}return e.push({name:"endchar",type:"OP",value:14}),e}function vZ(n){for(var e=new Fe.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]),t=0;t<n.length;t+=1){var r=n.get(t),s=gZ(r);e.charStrings.push({name:r.name,type:"CHARSTRING",value:s})}return e}function yZ(n,e){var t=new Fe.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}]);return t.dict=gO(fO,n,e),t}function xZ(n,e){for(var t=new Fe.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]),r=1/e.unitsPerEm,s={version:e.version,fullName:e.fullName,familyName:e.familyName,weight:e.weightName,fontBBox:e.fontBBox||[0,0,0,0],fontMatrix:[r,0,0,r,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]},i={},o=[],a,c=1;c<n.length;c+=1)a=n.get(c),o.push(a.name);var l=[];t.header=dZ(),t.nameIndex=pZ([e.postScriptName]);var u=kS(s,l);t.topDictIndex=BS(u),t.globalSubrIndex=mZ(),t.charsets=_Z(o,l),t.charStringsIndex=vZ(n),t.privateDict=yZ(i,l),t.stringIndex=fZ(l);var h=t.header.sizeOf()+t.nameIndex.sizeOf()+t.topDictIndex.sizeOf()+t.stringIndex.sizeOf()+t.globalSubrIndex.sizeOf();return s.charset=h,s.encoding=0,s.charStrings=s.charset+t.charsets.sizeOf(),s.private[1]=s.charStrings+t.charStringsIndex.sizeOf(),u=kS(s,l),t.topDictIndex=BS(u),t}var vO={parse:hZ,make:xZ};function bZ(n,e){var t={},r=new He.Parser(n,e);return t.version=r.parseVersion(),t.fontRevision=Math.round(r.parseFixed()*1e3)/1e3,t.checkSumAdjustment=r.parseULong(),t.magicNumber=r.parseULong(),$e.argument(t.magicNumber===1594834165,"Font header has wrong magic number."),t.flags=r.parseUShort(),t.unitsPerEm=r.parseUShort(),t.created=r.parseLongDateTime(),t.modified=r.parseLongDateTime(),t.xMin=r.parseShort(),t.yMin=r.parseShort(),t.xMax=r.parseShort(),t.yMax=r.parseShort(),t.macStyle=r.parseUShort(),t.lowestRecPPEM=r.parseUShort(),t.fontDirectionHint=r.parseShort(),t.indexToLocFormat=r.parseShort(),t.glyphDataFormat=r.parseShort(),t}function CZ(n){var e=Math.round(new Date().getTime()/1e3)+2082844800,t=e;return n.createdTimestamp&&(t=n.createdTimestamp+2082844800),new Fe.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:t},{name:"modified",type:"LONGDATETIME",value:e},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],n)}var yO={parse:bZ,make:CZ};function EZ(n,e){var t={},r=new He.Parser(n,e);return t.version=r.parseVersion(),t.ascender=r.parseShort(),t.descender=r.parseShort(),t.lineGap=r.parseShort(),t.advanceWidthMax=r.parseUShort(),t.minLeftSideBearing=r.parseShort(),t.minRightSideBearing=r.parseShort(),t.xMaxExtent=r.parseShort(),t.caretSlopeRise=r.parseShort(),t.caretSlopeRun=r.parseShort(),t.caretOffset=r.parseShort(),r.relativeOffset+=8,t.metricDataFormat=r.parseShort(),t.numberOfHMetrics=r.parseUShort(),t}function SZ(n){return new Fe.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],n)}var xO={parse:EZ,make:SZ};function AZ(n,e,t,r,s){for(var i,o,a=new He.Parser(n,e),c=0;c<r;c+=1){c<t&&(i=a.parseUShort(),o=a.parseShort());var l=s.get(c);l.advanceWidth=i,l.leftSideBearing=o}}function TZ(n,e,t,r,s){n._hmtxTableData={};for(var i,o,a=new He.Parser(e,t),c=0;c<s;c+=1)c<r&&(i=a.parseUShort(),o=a.parseShort()),n._hmtxTableData[c]={advanceWidth:i,leftSideBearing:o}}function MZ(n,e,t,r,s,i,o){o.lowMemory?TZ(n,e,t,r,s):AZ(e,t,r,s,i)}function RZ(n){for(var e=new Fe.Table("hmtx",[]),t=0;t<n.length;t+=1){var r=n.get(t),s=r.advanceWidth||0,i=r.leftSideBearing||0;e.fields.push({name:"advanceWidth_"+t,type:"USHORT",value:s}),e.fields.push({name:"leftSideBearing_"+t,type:"SHORT",value:i})}return e}var bO={parse:MZ,make:RZ};function wZ(n){for(var e=new Fe.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:n.length}]),t="",r=12+n.length*4,s=0;s<n.length;++s){var i=t.indexOf(n[s]);i<0&&(i=t.length,t+=n[s]),e.fields.push({name:"offset "+s,type:"USHORT",value:r+i}),e.fields.push({name:"length "+s,type:"USHORT",value:n[s].length})}return e.fields.push({name:"stringPool",type:"CHARARRAY",value:t}),e}function OZ(n,e){var t=new He.Parser(n,e),r=t.parseULong();$e.argument(r===1,"Unsupported ltag table version."),t.skip("uLong",1);for(var s=t.parseULong(),i=[],o=0;o<s;o++){for(var a="",c=e+t.parseUShort(),l=t.parseUShort(),u=c;u<c+l;++u)a+=String.fromCharCode(n.getInt8(u));i.push(a)}return i}var CO={make:wZ,parse:OZ};function PZ(n,e){var t={},r=new He.Parser(n,e);return t.version=r.parseVersion(),t.numGlyphs=r.parseUShort(),t.version===1&&(t.maxPoints=r.parseUShort(),t.maxContours=r.parseUShort(),t.maxCompositePoints=r.parseUShort(),t.maxCompositeContours=r.parseUShort(),t.maxZones=r.parseUShort(),t.maxTwilightPoints=r.parseUShort(),t.maxStorage=r.parseUShort(),t.maxFunctionDefs=r.parseUShort(),t.maxInstructionDefs=r.parseUShort(),t.maxStackElements=r.parseUShort(),t.maxSizeOfInstructions=r.parseUShort(),t.maxComponentElements=r.parseUShort(),t.maxComponentDepth=r.parseUShort()),t}function NZ(n){return new Fe.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:n}])}var EO={parse:PZ,make:NZ},SO=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"],AO={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"},IZ={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0},TO={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"};function DZ(n,e,t){switch(n){case 0:if(e===65535)return"und";if(t)return t[e];break;case 1:return AO[e];case 3:return TO[e]}}var Sg="utf-16",LZ={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"},FZ={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function MO(n,e,t){switch(n){case 0:return Sg;case 1:return FZ[t]||LZ[e];case 3:if(e===1||e===10)return Sg;break}}function UZ(n,e,t){for(var r={},s=new He.Parser(n,e),i=s.parseUShort(),o=s.parseUShort(),a=s.offset+s.parseUShort(),c=0;c<o;c++){var l=s.parseUShort(),u=s.parseUShort(),h=s.parseUShort(),d=s.parseUShort(),p=SO[d]||d,_=s.parseUShort(),g=s.parseUShort(),f=DZ(l,h,t),m=MO(l,u,h);if(m!==void 0&&f!==void 0){var y=void 0;if(m===Sg?y=mc.UTF16(n,a+g,_):y=mc.MACSTRING(n,a+g,_,m),y){var v=r[p];v===void 0&&(v=r[p]={}),v[f]=y}}}return i===1&&s.parseUShort(),r}function $m(n){var e={};for(var t in n)e[n[t]]=parseInt(t);return e}function GS(n,e,t,r,s,i){return new Fe.Record("NameRecord",[{name:"platformID",type:"USHORT",value:n},{name:"encodingID",type:"USHORT",value:e},{name:"languageID",type:"USHORT",value:t},{name:"nameID",type:"USHORT",value:r},{name:"length",type:"USHORT",value:s},{name:"offset",type:"USHORT",value:i}])}function kZ(n,e){var t=n.length,r=e.length-t+1;e:for(var s=0;s<r;s++)for(;s<r;s++){for(var i=0;i<t;i++)if(e[s+i]!==n[i])continue e;return s}return-1}function VS(n,e){var t=kZ(n,e);if(t<0){t=e.length;for(var r=0,s=n.length;r<s;++r)e.push(n[r])}return t}function BZ(n,e){var t,r=[],s={},i=$m(SO);for(var o in n){var a=i[o];if(a===void 0&&(a=o),t=parseInt(a),isNaN(t))throw new Error('Name table entry "'+o+'" does not exist, see nameTableNames for complete list.');s[t]=n[o],r.push(t)}for(var c=$m(AO),l=$m(TO),u=[],h=[],d=0;d<r.length;d++){t=r[d];var p=s[t];for(var _ in p){var g=p[_],f=1,m=c[_],y=IZ[m],v=MO(f,y,m),b=Pe.MACSTRING(g,v);b===void 0&&(f=0,m=e.indexOf(_),m<0&&(m=e.length,e.push(_)),y=4,b=Pe.UTF16(g));var x=VS(b,h);u.push(GS(f,y,m,t,b.length,x));var E=l[_];if(E!==void 0){var S=Pe.UTF16(g),R=VS(S,h);u.push(GS(3,1,E,t,S.length,R))}}}u.sort(function(G,F){return G.platformID-F.platformID||G.encodingID-F.encodingID||G.languageID-F.languageID||G.nameID-F.nameID});for(var C=new Fe.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:u.length},{name:"stringOffset",type:"USHORT",value:6+u.length*12}]),M=0;M<u.length;M++)C.fields.push({name:"record_"+M,type:"RECORD",value:u[M]});return C.fields.push({name:"strings",type:"LITERAL",value:h}),C}var RO={parse:UZ,make:BZ},Ag=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}];function GZ(n){for(var e=0;e<Ag.length;e+=1){var t=Ag[e];if(n>=t.begin&&n<t.end)return e}return-1}function VZ(n,e){var t={},r=new He.Parser(n,e);t.version=r.parseUShort(),t.xAvgCharWidth=r.parseShort(),t.usWeightClass=r.parseUShort(),t.usWidthClass=r.parseUShort(),t.fsType=r.parseUShort(),t.ySubscriptXSize=r.parseShort(),t.ySubscriptYSize=r.parseShort(),t.ySubscriptXOffset=r.parseShort(),t.ySubscriptYOffset=r.parseShort(),t.ySuperscriptXSize=r.parseShort(),t.ySuperscriptYSize=r.parseShort(),t.ySuperscriptXOffset=r.parseShort(),t.ySuperscriptYOffset=r.parseShort(),t.yStrikeoutSize=r.parseShort(),t.yStrikeoutPosition=r.parseShort(),t.sFamilyClass=r.parseShort(),t.panose=[];for(var s=0;s<10;s++)t.panose[s]=r.parseByte();return t.ulUnicodeRange1=r.parseULong(),t.ulUnicodeRange2=r.parseULong(),t.ulUnicodeRange3=r.parseULong(),t.ulUnicodeRange4=r.parseULong(),t.achVendID=String.fromCharCode(r.parseByte(),r.parseByte(),r.parseByte(),r.parseByte()),t.fsSelection=r.parseUShort(),t.usFirstCharIndex=r.parseUShort(),t.usLastCharIndex=r.parseUShort(),t.sTypoAscender=r.parseShort(),t.sTypoDescender=r.parseShort(),t.sTypoLineGap=r.parseShort(),t.usWinAscent=r.parseUShort(),t.usWinDescent=r.parseUShort(),t.version>=1&&(t.ulCodePageRange1=r.parseULong(),t.ulCodePageRange2=r.parseULong()),t.version>=2&&(t.sxHeight=r.parseShort(),t.sCapHeight=r.parseShort(),t.usDefaultChar=r.parseUShort(),t.usBreakChar=r.parseUShort(),t.usMaxContent=r.parseUShort()),t}function zZ(n){return new Fe.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],n)}var Tg={parse:VZ,make:zZ,unicodeRanges:Ag,getUnicodeRange:GZ};function HZ(n,e){var t={},r=new He.Parser(n,e);switch(t.version=r.parseVersion(),t.italicAngle=r.parseFixed(),t.underlinePosition=r.parseShort(),t.underlineThickness=r.parseShort(),t.isFixedPitch=r.parseULong(),t.minMemType42=r.parseULong(),t.maxMemType42=r.parseULong(),t.minMemType1=r.parseULong(),t.maxMemType1=r.parseULong(),t.version){case 1:t.names=yo.slice();break;case 2:t.numberOfGlyphs=r.parseUShort(),t.glyphNameIndex=new Array(t.numberOfGlyphs);for(var s=0;s<t.numberOfGlyphs;s++)t.glyphNameIndex[s]=r.parseUShort();t.names=[];for(var i=0;i<t.numberOfGlyphs;i++)if(t.glyphNameIndex[i]>=yo.length){var o=r.parseChar();t.names.push(r.parseString(o))}break;case 2.5:t.numberOfGlyphs=r.parseUShort(),t.offset=new Array(t.numberOfGlyphs);for(var a=0;a<t.numberOfGlyphs;a++)t.offset[a]=r.parseChar();break}return t}function jZ(){return new Fe.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}var wO={parse:HZ,make:jZ},es=new Array(9);es[1]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(t===1)return{substFormat:1,coverage:this.parsePointer(ie.coverage),deltaGlyphId:this.parseUShort()};if(t===2)return{substFormat:2,coverage:this.parsePointer(ie.coverage),substitute:this.parseOffset16List()};$e.assert(!1,"0x"+e.toString(16)+": lookup type 1 format must be 1 or 2.")};es[2]=function(){var e=this.parseUShort();return $e.argument(e===1,"GSUB Multiple Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(ie.coverage),sequences:this.parseListOfLists()}};es[3]=function(){var e=this.parseUShort();return $e.argument(e===1,"GSUB Alternate Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(ie.coverage),alternateSets:this.parseListOfLists()}};es[4]=function(){var e=this.parseUShort();return $e.argument(e===1,"GSUB ligature table identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(ie.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var Ja={sequenceIndex:ie.uShort,lookupListIndex:ie.uShort};es[5]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(t===1)return{substFormat:t,coverage:this.parsePointer(ie.coverage),ruleSets:this.parseListOfLists(function(){var i=this.parseUShort(),o=this.parseUShort();return{input:this.parseUShortList(i-1),lookupRecords:this.parseRecordList(o,Ja)}})};if(t===2)return{substFormat:t,coverage:this.parsePointer(ie.coverage),classDef:this.parsePointer(ie.classDef),classSets:this.parseListOfLists(function(){var i=this.parseUShort(),o=this.parseUShort();return{classes:this.parseUShortList(i-1),lookupRecords:this.parseRecordList(o,Ja)}})};if(t===3){var r=this.parseUShort(),s=this.parseUShort();return{substFormat:t,coverages:this.parseList(r,ie.pointer(ie.coverage)),lookupRecords:this.parseRecordList(s,Ja)}}$e.assert(!1,"0x"+e.toString(16)+": lookup type 5 format must be 1, 2 or 3.")};es[6]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(t===1)return{substFormat:1,coverage:this.parsePointer(ie.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Ja)}})};if(t===2)return{substFormat:2,coverage:this.parsePointer(ie.coverage),backtrackClassDef:this.parsePointer(ie.classDef),inputClassDef:this.parsePointer(ie.classDef),lookaheadClassDef:this.parsePointer(ie.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(Ja)}})};if(t===3)return{substFormat:3,backtrackCoverage:this.parseList(ie.pointer(ie.coverage)),inputCoverage:this.parseList(ie.pointer(ie.coverage)),lookaheadCoverage:this.parseList(ie.pointer(ie.coverage)),lookupRecords:this.parseRecordList(Ja)};$e.assert(!1,"0x"+e.toString(16)+": lookup type 6 format must be 1, 2 or 3.")};es[7]=function(){var e=this.parseUShort();$e.argument(e===1,"GSUB Extension Substitution subtable identifier-format must be 1");var t=this.parseUShort(),r=new ie(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:t,extension:es[t].call(r)}};es[8]=function(){var e=this.parseUShort();return $e.argument(e===1,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(ie.coverage),backtrackCoverage:this.parseList(ie.pointer(ie.coverage)),lookaheadCoverage:this.parseList(ie.pointer(ie.coverage)),substitutes:this.parseUShortList()}};function WZ(n,e){e=e||0;var t=new ie(n,e),r=t.parseVersion(1);return $e.argument(r===1||r===1.1,"Unsupported GSUB table version."),r===1?{version:r,scripts:t.parseScriptList(),features:t.parseFeatureList(),lookups:t.parseLookupList(es)}:{version:r,scripts:t.parseScriptList(),features:t.parseFeatureList(),lookups:t.parseLookupList(es),variations:t.parseFeatureVariationsList()}}var Pc=new Array(9);Pc[1]=function(e){return e.substFormat===1?new Fe.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new Fe.Coverage(e.coverage)},{name:"deltaGlyphID",type:"USHORT",value:e.deltaGlyphId}]):new Fe.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new Fe.Coverage(e.coverage)}].concat(Fe.ushortList("substitute",e.substitute)))};Pc[2]=function(e){return $e.assert(e.substFormat===1,"Lookup type 2 substFormat must be 1."),new Fe.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new Fe.Coverage(e.coverage)}].concat(Fe.tableList("seqSet",e.sequences,function(t){return new Fe.Table("sequenceSetTable",Fe.ushortList("sequence",t))})))};Pc[3]=function(e){return $e.assert(e.substFormat===1,"Lookup type 3 substFormat must be 1."),new Fe.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new Fe.Coverage(e.coverage)}].concat(Fe.tableList("altSet",e.alternateSets,function(t){return new Fe.Table("alternateSetTable",Fe.ushortList("alternate",t))})))};Pc[4]=function(e){return $e.assert(e.substFormat===1,"Lookup type 4 substFormat must be 1."),new Fe.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new Fe.Coverage(e.coverage)}].concat(Fe.tableList("ligSet",e.ligatureSets,function(t){return new Fe.Table("ligatureSetTable",Fe.tableList("ligature",t,function(r){return new Fe.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:r.ligGlyph}].concat(Fe.ushortList("component",r.components,r.components.length+1)))}))})))};Pc[6]=function(e){if(e.substFormat===1){var t=new Fe.Table("chainContextTable",[{name:"substFormat",type:"USHORT",value:e.substFormat},{name:"coverage",type:"TABLE",value:new Fe.Coverage(e.coverage)}].concat(Fe.tableList("chainRuleSet",e.chainRuleSets,function(i){return new Fe.Table("chainRuleSetTable",Fe.tableList("chainRule",i,function(o){var a=Fe.ushortList("backtrackGlyph",o.backtrack,o.backtrack.length).concat(Fe.ushortList("inputGlyph",o.input,o.input.length+1)).concat(Fe.ushortList("lookaheadGlyph",o.lookahead,o.lookahead.length)).concat(Fe.ushortList("substitution",[],o.lookupRecords.length));return o.lookupRecords.forEach(function(c,l){a=a.concat({name:"sequenceIndex"+l,type:"USHORT",value:c.sequenceIndex}).concat({name:"lookupListIndex"+l,type:"USHORT",value:c.lookupListIndex})}),new Fe.Table("chainRuleTable",a)}))})));return t}else if(e.substFormat===2)$e.assert(!1,"lookup type 6 format 2 is not yet supported.");else if(e.substFormat===3){var r=[{name:"substFormat",type:"USHORT",value:e.substFormat}];r.push({name:"backtrackGlyphCount",type:"USHORT",value:e.backtrackCoverage.length}),e.backtrackCoverage.forEach(function(i,o){r.push({name:"backtrackCoverage"+o,type:"TABLE",value:new Fe.Coverage(i)})}),r.push({name:"inputGlyphCount",type:"USHORT",value:e.inputCoverage.length}),e.inputCoverage.forEach(function(i,o){r.push({name:"inputCoverage"+o,type:"TABLE",value:new Fe.Coverage(i)})}),r.push({name:"lookaheadGlyphCount",type:"USHORT",value:e.lookaheadCoverage.length}),e.lookaheadCoverage.forEach(function(i,o){r.push({name:"lookaheadCoverage"+o,type:"TABLE",value:new Fe.Coverage(i)})}),r.push({name:"substitutionCount",type:"USHORT",value:e.lookupRecords.length}),e.lookupRecords.forEach(function(i,o){r=r.concat({name:"sequenceIndex"+o,type:"USHORT",value:i.sequenceIndex}).concat({name:"lookupListIndex"+o,type:"USHORT",value:i.lookupListIndex})});var s=new Fe.Table("chainContextTable",r);return s}$e.assert(!1,"lookup type 6 format must be 1, 2 or 3.")};function XZ(n){return new Fe.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new Fe.ScriptList(n.scripts)},{name:"features",type:"TABLE",value:new Fe.FeatureList(n.features)},{name:"lookups",type:"TABLE",value:new Fe.LookupList(n.lookups,Pc)}])}var OO={parse:WZ,make:XZ};function $Z(n,e){var t=new He.Parser(n,e),r=t.parseULong();$e.argument(r===1,"Unsupported META table version."),t.parseULong(),t.parseULong();for(var s=t.parseULong(),i={},o=0;o<s;o++){var a=t.parseTag(),c=t.parseULong(),l=t.parseULong(),u=mc.UTF8(n,e+c,l);i[a]=u}return i}function qZ(n){var e=Object.keys(n).length,t="",r=16+e*12,s=new Fe.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:r},{name:"numTags",type:"ULONG",value:e}]);for(var i in n){var o=t.length;t+=n[i],s.fields.push({name:"tag "+i,type:"TAG",value:i}),s.fields.push({name:"offset "+i,type:"ULONG",value:r+o}),s.fields.push({name:"length "+i,type:"ULONG",value:n[i].length})}return s.fields.push({name:"stringPool",type:"CHARARRAY",value:t}),s}var PO={parse:$Z,make:qZ};function YZ(n,e){var t=new ie(n,e),r=t.parseUShort();$e.argument(r===0,"Only COLRv0 supported.");var s=t.parseUShort(),i=t.parseOffset32(),o=t.parseOffset32(),a=t.parseUShort();t.relativeOffset=i;var c=t.parseRecordList(s,{glyphID:ie.uShort,firstLayerIndex:ie.uShort,numLayers:ie.uShort});t.relativeOffset=o;var l=t.parseRecordList(a,{glyphID:ie.uShort,paletteIndex:ie.uShort});return{version:r,baseGlyphRecords:c,layerRecords:l}}function KZ(n){var e=n.version;e===void 0&&(e=0);var t=n.baseGlyphRecords;t===void 0&&(t=[]);var r=n.layerRecords;r===void 0&&(r=[]),$e.argument(e===0,"Only COLRv0 supported.");var s=14,i=s+t.length*6;return new Fe.Table("COLR",[{name:"version",type:"USHORT",value:e},{name:"numBaseGlyphRecords",type:"USHORT",value:t.length},{name:"baseGlyphRecordsOffset",type:"ULONG",value:s},{name:"layerRecordsOffset",type:"ULONG",value:i},{name:"numLayerRecords",type:"USHORT",value:r.length}].concat(t.map(function(o,a){return[{name:"glyphID_"+a,type:"USHORT",value:o.glyphID},{name:"firstLayerIndex_"+a,type:"USHORT",value:o.firstLayerIndex},{name:"numLayers_"+a,type:"USHORT",value:o.numLayers}]}).flat(),r.map(function(o,a){return[{name:"LayerGlyphID_"+a,type:"USHORT",value:o.glyphID},{name:"paletteIndex_"+a,type:"USHORT",value:o.paletteIndex}]}).flat()))}var NO={parse:YZ,make:KZ};function ZZ(n,e){var t=new ie(n,e),r=t.parseShort(),s=t.parseShort(),i=t.parseShort(),o=t.parseShort(),a=t.parseOffset32(),c=t.parseUShortList(i);t.relativeOffset=a;var l=t.parseULongList(o);return{version:r,numPaletteEntries:s,colorRecords:l,colorRecordIndices:c}}function JZ(n){var e=n.version;e===void 0&&(e=0);var t=n.numPaletteEntries;t===void 0&&(t=0);var r=n.colorRecords;r===void 0&&(r=[]);var s=n.colorRecordIndices;return s===void 0&&(s=[0]),$e.argument(e===0,"Only CPALv0 are supported."),$e.argument(r.length,"No colorRecords given."),$e.argument(s.length,"No colorRecordIndices given."),$e.argument(!t&&s.length==1,"Can't infer numPaletteEntries on multiple colorRecordIndices"),new Fe.Table("CPAL",[{name:"version",type:"USHORT",value:e},{name:"numPaletteEntries",type:"USHORT",value:t||r.length},{name:"numPalettes",type:"USHORT",value:s.length},{name:"numColorRecords",type:"USHORT",value:r.length},{name:"colorRecordsArrayOffset",type:"ULONG",value:12+2*s.length}].concat(s.map(function(i,o){return{name:"colorRecordIndices_"+o,type:"USHORT",value:i}}),r.map(function(i,o){return{name:"colorRecords_"+o,type:"ULONG",value:i}})))}var IO={parse:ZZ,make:JZ};function zS(n){return Math.log(n)/Math.log(2)|0}function X0(n){for(;n.length%4!==0;)n.push(0);for(var e=0,t=0;t<n.length;t+=4)e+=(n[t]<<24)+(n[t+1]<<16)+(n[t+2]<<8)+n[t+3];return e%=Math.pow(2,32),e}function HS(n,e,t,r){return new Fe.Record("Table Record",[{name:"tag",type:"TAG",value:n!==void 0?n:""},{name:"checkSum",type:"ULONG",value:e!==void 0?e:0},{name:"offset",type:"ULONG",value:t!==void 0?t:0},{name:"length",type:"ULONG",value:r!==void 0?r:0}])}function DO(n){var e=new Fe.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);e.tables=n,e.numTables=n.length;var t=Math.pow(2,zS(e.numTables));e.searchRange=16*t,e.entrySelector=zS(t),e.rangeShift=e.numTables*16-e.searchRange;for(var r=[],s=[],i=e.sizeOf()+HS().sizeOf()*e.numTables;i%4!==0;)i+=1,s.push({name:"padding",type:"BYTE",value:0});for(var o=0;o<n.length;o+=1){var a=n[o];$e.argument(a.tableName.length===4,"Table name"+a.tableName+" is invalid.");var c=a.sizeOf(),l=HS(a.tableName,X0(a.encode()),i,c);for(r.push({name:l.tag+" Table Record",type:"RECORD",value:l}),s.push({name:a.tableName+" table",type:"RECORD",value:a}),i+=c,$e.argument(!isNaN(i),"Something went wrong calculating the offset.");i%4!==0;)i+=1,s.push({name:"padding",type:"BYTE",value:0})}return r.sort(function(u,h){return u.value.tag>h.value.tag?1:-1}),e.fields=e.fields.concat(r),e.fields=e.fields.concat(s),e}function jS(n,e,t){for(var r=0;r<e.length;r+=1){var s=n.charToGlyphIndex(e[r]);if(s>0){var i=n.glyphs.get(s);return i.getMetrics()}}return t}function QZ(n){for(var e=0,t=0;t<n.length;t+=1)e+=n[t];return e/n.length}function eJ(n){for(var e=[],t=[],r=[],s=[],i=[],o=[],a=[],c,l=0,u=0,h=0,d=0,p=0,_=0;_<n.glyphs.length;_+=1){var g=n.glyphs.get(_),f=g.unicode|0;if(isNaN(g.advanceWidth))throw new Error("Glyph "+g.name+" ("+_+"): advanceWidth is not a number.");(c>f||c===void 0)&&f>0&&(c=f),l<f&&(l=f);var m=Tg.getUnicodeRange(f);if(m<32)u|=1<<m;else if(m<64)h|=1<<m-32;else if(m<96)d|=1<<m-64;else if(m<123)p|=1<<m-96;else throw new Error("Unicode ranges bits > 123 are reserved for internal usage");if(g.name!==".notdef"){var y=g.getMetrics();e.push(y.xMin),t.push(y.yMin),r.push(y.xMax),s.push(y.yMax),o.push(y.leftSideBearing),a.push(y.rightSideBearing),i.push(g.advanceWidth)}}var v={xMin:Math.min.apply(null,e),yMin:Math.min.apply(null,t),xMax:Math.max.apply(null,r),yMax:Math.max.apply(null,s),advanceWidthMax:Math.max.apply(null,i),advanceWidthAvg:QZ(i),minLeftSideBearing:Math.min.apply(null,o),maxLeftSideBearing:Math.max.apply(null,o),minRightSideBearing:Math.min.apply(null,a)};v.ascender=n.ascender,v.descender=n.descender;var b=yO.make({flags:3,unitsPerEm:n.unitsPerEm,xMin:v.xMin,yMin:v.yMin,xMax:v.xMax,yMax:v.yMax,lowestRecPPEM:3,createdTimestamp:n.createdTimestamp}),x=xO.make({ascender:v.ascender,descender:v.descender,advanceWidthMax:v.advanceWidthMax,minLeftSideBearing:v.minLeftSideBearing,minRightSideBearing:v.minRightSideBearing,xMaxExtent:v.maxLeftSideBearing+(v.xMax-v.xMin),numberOfHMetrics:n.glyphs.length}),E=EO.make(n.glyphs.length),S=Tg.make(Object.assign({xAvgCharWidth:Math.round(v.advanceWidthAvg),usFirstCharIndex:c,usLastCharIndex:l,ulUnicodeRange1:u,ulUnicodeRange2:h,ulUnicodeRange3:d,ulUnicodeRange4:p,sTypoAscender:v.ascender,sTypoDescender:v.descender,sTypoLineGap:0,usWinAscent:v.yMax,usWinDescent:Math.abs(v.yMin),ulCodePageRange1:1,sxHeight:jS(n,"xyvw",{yMax:Math.round(v.ascender/2)}).yMax,sCapHeight:jS(n,"HIKLEFJMNTZBDPRAGOQSUVWXY",v).yMax,usDefaultChar:n.hasChar(" ")?32:0,usBreakChar:n.hasChar(" ")?32:0},n.tables.os2)),R=bO.make(n.glyphs),C=aO.make(n.glyphs),M=n.getEnglishName("fontFamily"),G=n.getEnglishName("fontSubfamily"),F=M+" "+G,X=n.getEnglishName("postScriptName");X||(X=M.replace(/\s/g,"")+"-"+G);var N={};for(var j in n.names)N[j]=n.names[j];N.uniqueID||(N.uniqueID={en:n.getEnglishName("manufacturer")+":"+F}),N.postScriptName||(N.postScriptName={en:X}),N.preferredFamily||(N.preferredFamily=n.names.fontFamily),N.preferredSubfamily||(N.preferredSubfamily=n.names.fontSubfamily);var K=[],$=RO.make(N,K),q=K.length>0?CO.make(K):void 0,ne=wO.make(),le=vO.make(n.glyphs,{version:n.getEnglishName("version"),fullName:F,familyName:M,weightName:G,postScriptName:X,unitsPerEm:n.unitsPerEm,fontBBox:[0,v.yMin,v.ascender,v.advanceWidthMax]}),ue=n.metas&&Object.keys(n.metas).length>0?PO.make(n.metas):void 0,Ee=[b,x,E,S,$,C,ne,le,R];q&&Ee.push(q),n.tables.gsub&&Ee.push(OO.make(n.tables.gsub)),n.tables.cpal&&Ee.push(IO.make(n.tables.cpal)),n.tables.colr&&Ee.push(NO.make(n.tables.colr)),ue&&Ee.push(ue);for(var de=DO(Ee),V=de.encode(),B=X0(V),P=de.fields,O=!1,se=0;se<P.length;se+=1)if(P[se].name==="head table"){P[se].value.checkSumAdjustment=2981146554-B,O=!0;break}if(!O)throw new Error("Could not find head table with checkSum to adjust.");return de}var tJ={make:DO,fontToTable:eJ,computeCheckSum:X0};function qm(n,e){for(var t=0,r=n.length-1;t<=r;){var s=t+r>>>1,i=n[s].tag;if(i===e)return s;i<e?t=s+1:r=s-1}return-t-1}function WS(n,e){for(var t=0,r=n.length-1;t<=r;){var s=t+r>>>1,i=n[s];if(i===e)return s;i<e?t=s+1:r=s-1}return-t-1}function XS(n,e){for(var t,r=0,s=n.length-1;r<=s;){var i=r+s>>>1;t=n[i];var o=t.start;if(o===e)return t;o<e?r=i+1:s=i-1}if(r>0)return t=n[r-1],e>t.end?0:t}function Pu(n,e){this.font=n,this.tableName=e}Pu.prototype={searchTag:qm,binSearch:WS,getTable:function(n){var e=this.font.tables[this.tableName];return!e&&n&&(e=this.font.tables[this.tableName]=this.createDefaultTable()),e},getScriptNames:function(){var n=this.getTable();return n?n.scripts.map(function(e){return e.tag}):[]},getDefaultScriptName:function(){var n=this.getTable();if(n){for(var e=!1,t=0;t<n.scripts.length;t++){var r=n.scripts[t].tag;if(r==="DFLT")return r;r==="latn"&&(e=!0)}if(e)return"latn"}},getScriptTable:function(n,e){var t=this.getTable(e);if(t){n=n||"DFLT";var r=t.scripts,s=qm(t.scripts,n);if(s>=0)return r[s].script;if(e){var i={tag:n,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};return r.splice(-1-s,0,i),i.script}}},getLangSysTable:function(n,e,t){var r=this.getScriptTable(n,t);if(r){if(!e||e==="dflt"||e==="DFLT")return r.defaultLangSys;var s=qm(r.langSysRecords,e);if(s>=0)return r.langSysRecords[s].langSys;if(t){var i={tag:e,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};return r.langSysRecords.splice(-1-s,0,i),i.langSys}}},getFeatureTable:function(n,e,t,r){var s=this.getLangSysTable(n,e,r);if(s){for(var i,o=s.featureIndexes,a=this.font.tables[this.tableName].features,c=0;c<o.length;c++)if(i=a[o[c]],i.tag===t)return i.feature;if(r){var l=a.length;return $e.assert(l===0||t>=a[l-1].tag,"Features must be added in alphabetical order."),i={tag:t,feature:{params:0,lookupListIndexes:[]}},a.push(i),o.push(l),i.feature}}},getLookupTables:function(n,e,t,r,s){var i=this.getFeatureTable(n,e,t,s),o=[];if(i){for(var a,c=i.lookupListIndexes,l=this.font.tables[this.tableName].lookups,u=0;u<c.length;u++)a=l[c[u]],a.lookupType===r&&o.push(a);if(o.length===0&&s){a={lookupType:r,lookupFlag:0,subtables:[],markFilteringSet:void 0};var h=l.length;return l.push(a),c.push(h),[a]}}return o},getGlyphClass:function(n,e){switch(n.format){case 1:return n.startGlyph<=e&&e<n.startGlyph+n.classes.length?n.classes[e-n.startGlyph]:0;case 2:var t=XS(n.ranges,e);return t?t.classId:0}},getCoverageIndex:function(n,e){switch(n.format){case 1:var t=WS(n.glyphs,e);return t>=0?t:-1;case 2:var r=XS(n.ranges,e);return r?r.index+e-r.start:-1}},expandCoverage:function(n){if(n.format===1)return n.glyphs;for(var e=[],t=n.ranges,r=0;r<t.length;r++)for(var s=t[r],i=s.start,o=s.end,a=i;a<=o;a++)e.push(a);return e}};function Nu(n){Pu.call(this,n,"gpos")}Nu.prototype=Pu.prototype;Nu.prototype.init=function(){var n=this.getDefaultScriptName();this.defaultKerningTables=this.getKerningTables(n)};Nu.prototype.getKerningValue=function(n,e,t){for(var r=0;r<n.length;r++)for(var s=n[r].subtables,i=0;i<s.length;i++){var o=s[i],a=this.getCoverageIndex(o.coverage,e);if(!(a<0))switch(o.posFormat){case 1:for(var c=o.pairSets[a],l=0;l<c.length;l++){var u=c[l];if(u.secondGlyph===t)return u.value1&&u.value1.xAdvance||0}break;case 2:var h=this.getGlyphClass(o.classDef1,e),d=this.getGlyphClass(o.classDef2,t),p=o.classRecords[h][d];return p.value1&&p.value1.xAdvance||0}}return 0};Nu.prototype.getKerningTables=function(n,e){if(this.font.tables.gpos)return this.getLookupTables(n,e,"kern",2)};function br(n){Pu.call(this,n,"gsub")}function nJ(n,e){var t=n.length;if(t!==e.length)return!1;for(var r=0;r<t;r++)if(n[r]!==e[r])return!1;return!0}function $0(n,e,t){for(var r=n.subtables,s=0;s<r.length;s++){var i=r[s];if(i.substFormat===e)return i}if(t)return r.push(t),t}br.prototype=Pu.prototype;br.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}};br.prototype.getSingle=function(n,e,t){for(var r=[],s=this.getLookupTables(e,t,n,1),i=0;i<s.length;i++)for(var o=s[i].subtables,a=0;a<o.length;a++){var c=o[a],l=this.expandCoverage(c.coverage),u=void 0;if(c.substFormat===1){var h=c.deltaGlyphId;for(u=0;u<l.length;u++){var d=l[u];r.push({sub:d,by:d+h})}}else{var p=c.substitute;for(u=0;u<l.length;u++)r.push({sub:l[u],by:p[u]})}}return r};br.prototype.getMultiple=function(n,e,t){for(var r=[],s=this.getLookupTables(e,t,n,2),i=0;i<s.length;i++)for(var o=s[i].subtables,a=0;a<o.length;a++){var c=o[a],l=this.expandCoverage(c.coverage),u=void 0;for(u=0;u<l.length;u++){var h=l[u],d=c.sequences[u];r.push({sub:h,by:d})}}return r};br.prototype.getAlternates=function(n,e,t){for(var r=[],s=this.getLookupTables(e,t,n,3),i=0;i<s.length;i++)for(var o=s[i].subtables,a=0;a<o.length;a++)for(var c=o[a],l=this.expandCoverage(c.coverage),u=c.alternateSets,h=0;h<l.length;h++)r.push({sub:l[h],by:u[h]});return r};br.prototype.getLigatures=function(n,e,t){for(var r=[],s=this.getLookupTables(e,t,n,4),i=0;i<s.length;i++)for(var o=s[i].subtables,a=0;a<o.length;a++)for(var c=o[a],l=this.expandCoverage(c.coverage),u=c.ligatureSets,h=0;h<l.length;h++)for(var d=l[h],p=u[h],_=0;_<p.length;_++){var g=p[_];r.push({sub:[d].concat(g.components),by:g.ligGlyph})}return r};br.prototype.addSingle=function(n,e,t,r){var s=this.getLookupTables(t,r,n,1,!0)[0],i=$0(s,2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});$e.assert(i.coverage.format===1,"Single: unable to modify coverage table format "+i.coverage.format);var o=e.sub,a=this.binSearch(i.coverage.glyphs,o);a<0&&(a=-1-a,i.coverage.glyphs.splice(a,0,o),i.substitute.splice(a,0,0)),i.substitute[a]=e.by};br.prototype.addMultiple=function(n,e,t,r){$e.assert(e.by instanceof Array&&e.by.length>1,'Multiple: "by" must be an array of two or more ids');var s=this.getLookupTables(t,r,n,2,!0)[0],i=$0(s,1,{substFormat:1,coverage:{format:1,glyphs:[]},sequences:[]});$e.assert(i.coverage.format===1,"Multiple: unable to modify coverage table format "+i.coverage.format);var o=e.sub,a=this.binSearch(i.coverage.glyphs,o);a<0&&(a=-1-a,i.coverage.glyphs.splice(a,0,o),i.sequences.splice(a,0,0)),i.sequences[a]=e.by};br.prototype.addAlternate=function(n,e,t,r){var s=this.getLookupTables(t,r,n,3,!0)[0],i=$0(s,1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});$e.assert(i.coverage.format===1,"Alternate: unable to modify coverage table format "+i.coverage.format);var o=e.sub,a=this.binSearch(i.coverage.glyphs,o);a<0&&(a=-1-a,i.coverage.glyphs.splice(a,0,o),i.alternateSets.splice(a,0,0)),i.alternateSets[a]=e.by};br.prototype.addLigature=function(n,e,t,r){var s=this.getLookupTables(t,r,n,4,!0)[0],i=s.subtables[0];i||(i={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]},s.subtables[0]=i),$e.assert(i.coverage.format===1,"Ligature: unable to modify coverage table format "+i.coverage.format);var o=e.sub[0],a=e.sub.slice(1),c={ligGlyph:e.by,components:a},l=this.binSearch(i.coverage.glyphs,o);if(l>=0){for(var u=i.ligatureSets[l],h=0;h<u.length;h++)if(nJ(u[h].components,a))return;u.push(c)}else l=-1-l,i.coverage.glyphs.splice(l,0,o),i.ligatureSets.splice(l,0,[c])};br.prototype.getFeature=function(n,e,t){if(/ss\d\d/.test(n))return this.getSingle(n,e,t);switch(n){case"aalt":case"salt":return this.getSingle(n,e,t).concat(this.getAlternates(n,e,t));case"dlig":case"liga":case"rlig":return this.getLigatures(n,e,t);case"ccmp":return this.getMultiple(n,e,t).concat(this.getLigatures(n,e,t));case"stch":return this.getMultiple(n,e,t)}};br.prototype.add=function(n,e,t,r){if(/ss\d\d/.test(n))return this.addSingle(n,e,t,r);switch(n){case"aalt":case"salt":return typeof e.by=="number"?this.addSingle(n,e,t,r):this.addAlternate(n,e,t,r);case"dlig":case"liga":case"rlig":return this.addLigature(n,e,t,r);case"ccmp":return e.by instanceof Array?this.addMultiple(n,e,t,r):this.addLigature(n,e,t,r)}};function il(n,e){if(!n)throw e}function $S(n,e,t,r,s){var i;return(e&r)>0?(i=n.parseByte(),e&s||(i=-i),i=t+i):(e&s)>0?i=t:i=t+n.parseShort(),i}function LO(n,e,t){var r=new He.Parser(e,t);n.numberOfContours=r.parseShort(),n._xMin=r.parseShort(),n._yMin=r.parseShort(),n._xMax=r.parseShort(),n._yMax=r.parseShort();var s,i;if(n.numberOfContours>0){for(var o=n.endPointIndices=[],a=0;a<n.numberOfContours;a+=1)o.push(r.parseUShort());n.instructionLength=r.parseUShort(),n.instructions=[];for(var c=0;c<n.instructionLength;c+=1)n.instructions.push(r.parseByte());var l=o[o.length-1]+1;s=[];for(var u=0;u<l;u+=1)if(i=r.parseByte(),s.push(i),(i&8)>0)for(var h=r.parseByte(),d=0;d<h;d+=1)s.push(i),u+=1;if($e.argument(s.length===l,"Bad flags."),o.length>0){var p=[],_;if(l>0){for(var g=0;g<l;g+=1)i=s[g],_={},_.onCurve=!!(i&1),_.lastPointOfContour=o.indexOf(g)>=0,p.push(_);for(var f=0,m=0;m<l;m+=1)i=s[m],_=p[m],_.x=$S(r,i,f,2,16),f=_.x;for(var y=0,v=0;v<l;v+=1)i=s[v],_=p[v],_.y=$S(r,i,y,4,32),y=_.y}n.points=p}else n.points=[]}else if(n.numberOfContours===0)n.points=[];else{n.isComposite=!0,n.points=[],n.components=[];for(var b=!0;b;){s=r.parseUShort();var x={glyphIndex:r.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};(s&1)>0?(s&2)>0?(x.dx=r.parseShort(),x.dy=r.parseShort()):x.matchedPoints=[r.parseUShort(),r.parseUShort()]:(s&2)>0?(x.dx=r.parseChar(),x.dy=r.parseChar()):x.matchedPoints=[r.parseByte(),r.parseByte()],(s&8)>0?x.xScale=x.yScale=r.parseF2Dot14():(s&64)>0?(x.xScale=r.parseF2Dot14(),x.yScale=r.parseF2Dot14()):(s&128)>0&&(x.xScale=r.parseF2Dot14(),x.scale01=r.parseF2Dot14(),x.scale10=r.parseF2Dot14(),x.yScale=r.parseF2Dot14()),n.components.push(x),b=!!(s&32)}if(s&256){n.instructionLength=r.parseUShort(),n.instructions=[];for(var E=0;E<n.instructionLength;E+=1)n.instructions.push(r.parseByte())}}}function Ym(n,e){for(var t=[],r=0;r<n.length;r+=1){var s=n[r],i={x:e.xScale*s.x+e.scale01*s.y+e.dx,y:e.scale10*s.x+e.yScale*s.y+e.dy,onCurve:s.onCurve,lastPointOfContour:s.lastPointOfContour};t.push(i)}return t}function rJ(n){for(var e=[],t=[],r=0;r<n.length;r+=1){var s=n[r];t.push(s),s.lastPointOfContour&&(e.push(t),t=[])}return $e.argument(t.length===0,"There are still points left in the current contour."),e}function FO(n){var e=new vn;if(!n)return e;for(var t=rJ(n),r=0;r<t.length;++r){var s=t[r],i=null,o=s[s.length-1],a=s[0];if(o.onCurve)e.moveTo(o.x,o.y);else if(a.onCurve)e.moveTo(a.x,a.y);else{var c={x:(o.x+a.x)*.5,y:(o.y+a.y)*.5};e.moveTo(c.x,c.y)}for(var l=0;l<s.length;++l)if(i=o,o=a,a=s[(l+1)%s.length],o.onCurve)e.lineTo(o.x,o.y);else{var u=a;i.onCurve||((o.x+i.x)*.5,(o.y+i.y)*.5),a.onCurve||(u={x:(o.x+a.x)*.5,y:(o.y+a.y)*.5}),e.quadraticCurveTo(o.x,o.y,u.x,u.y)}e.closePath()}return e}function UO(n,e){if(e.isComposite)for(var t=0;t<e.components.length;t+=1){var r=e.components[t],s=n.get(r.glyphIndex);if(s.getPath(),s.points){var i=void 0;if(r.matchedPoints===void 0)i=Ym(s.points,r);else{if(r.matchedPoints[0]>e.points.length-1||r.matchedPoints[1]>s.points.length-1)throw Error("Matched points out of range in "+e.name);var o=e.points[r.matchedPoints[0]],a=s.points[r.matchedPoints[1]],c={xScale:r.xScale,scale01:r.scale01,scale10:r.scale10,yScale:r.yScale,dx:0,dy:0};a=Ym([a],c)[0],c.dx=o.x-a.x,c.dy=o.y-a.y,i=Ym(s.points,c)}e.points=e.points.concat(i)}}return FO(e.points)}function sJ(n,e,t,r){for(var s=new As.GlyphSet(r),i=0;i<t.length-1;i+=1){var o=t[i],a=t[i+1];o!==a?s.push(i,As.ttfGlyphLoader(r,i,LO,n,e+o,UO)):s.push(i,As.glyphLoader(r,i))}return s}function iJ(n,e,t,r){var s=new As.GlyphSet(r);return r._push=function(i){var o=t[i],a=t[i+1];o!==a?s.push(i,As.ttfGlyphLoader(r,i,LO,n,e+o,UO)):s.push(i,As.glyphLoader(r,i))},s}function oJ(n,e,t,r,s){return s.lowMemory?iJ(n,e,t,r):sJ(n,e,t,r)}var kO={getPath:FO,parse:oJ},BO,Lo,GO,Mg;function VO(n){this.font=n,this.getCommands=function(e){return kO.getPath(e).commands},this._fpgmState=this._prepState=void 0,this._errorState=0}function aJ(n){return n}function zO(n){return Math.sign(n)*Math.round(Math.abs(n))}function cJ(n){return Math.sign(n)*Math.round(Math.abs(n*2))/2}function lJ(n){return Math.sign(n)*(Math.round(Math.abs(n)+.5)-.5)}function uJ(n){return Math.sign(n)*Math.ceil(Math.abs(n))}function hJ(n){return Math.sign(n)*Math.floor(Math.abs(n))}var HO=function(n){var e=this.srPeriod,t=this.srPhase,r=this.srThreshold,s=1;return n<0&&(n=-n,s=-1),n+=r-t,n=Math.trunc(n/e)*e,n+=t,n<0?t*s:n*s},xs={x:1,y:0,axis:"x",distance:function(n,e,t,r){return(t?n.xo:n.x)-(r?e.xo:e.x)},interpolate:function(n,e,t,r){var s,i,o,a,c,l,u;if(!r||r===this){if(s=n.xo-e.xo,i=n.xo-t.xo,c=e.x-e.xo,l=t.x-t.xo,o=Math.abs(s),a=Math.abs(i),u=o+a,u===0){n.x=n.xo+(c+l)/2;return}n.x=n.xo+(c*a+l*o)/u;return}if(s=r.distance(n,e,!0,!0),i=r.distance(n,t,!0,!0),c=r.distance(e,e,!1,!0),l=r.distance(t,t,!1,!0),o=Math.abs(s),a=Math.abs(i),u=o+a,u===0){xs.setRelative(n,n,(c+l)/2,r,!0);return}xs.setRelative(n,n,(c*a+l*o)/u,r,!0)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(n,e,t,r,s){if(!r||r===this){n.x=(s?e.xo:e.x)+t;return}var i=s?e.xo:e.x,o=s?e.yo:e.y,a=i+t*r.x,c=o+t*r.y;n.x=a+(n.y-c)/r.normalSlope},slope:0,touch:function(n){n.xTouched=!0},touched:function(n){return n.xTouched},untouch:function(n){n.xTouched=!1}},Xs={x:0,y:1,axis:"y",distance:function(n,e,t,r){return(t?n.yo:n.y)-(r?e.yo:e.y)},interpolate:function(n,e,t,r){var s,i,o,a,c,l,u;if(!r||r===this){if(s=n.yo-e.yo,i=n.yo-t.yo,c=e.y-e.yo,l=t.y-t.yo,o=Math.abs(s),a=Math.abs(i),u=o+a,u===0){n.y=n.yo+(c+l)/2;return}n.y=n.yo+(c*a+l*o)/u;return}if(s=r.distance(n,e,!0,!0),i=r.distance(n,t,!0,!0),c=r.distance(e,e,!1,!0),l=r.distance(t,t,!1,!0),o=Math.abs(s),a=Math.abs(i),u=o+a,u===0){Xs.setRelative(n,n,(c+l)/2,r,!0);return}Xs.setRelative(n,n,(c*a+l*o)/u,r,!0)},normalSlope:0,setRelative:function(n,e,t,r,s){if(!r||r===this){n.y=(s?e.yo:e.y)+t;return}var i=s?e.xo:e.x,o=s?e.yo:e.y,a=i+t*r.x,c=o+t*r.y;n.y=c+r.normalSlope*(n.x-a)},slope:Number.POSITIVE_INFINITY,touch:function(n){n.yTouched=!0},touched:function(n){return n.yTouched},untouch:function(n){n.yTouched=!1}};Object.freeze(xs);Object.freeze(Xs);function Iu(n,e){this.x=n,this.y=e,this.axis=void 0,this.slope=e/n,this.normalSlope=-n/e,Object.freeze(this)}Iu.prototype.distance=function(n,e,t,r){return this.x*xs.distance(n,e,t,r)+this.y*Xs.distance(n,e,t,r)};Iu.prototype.interpolate=function(n,e,t,r){var s,i,o,a,c,l,u;if(o=r.distance(n,e,!0,!0),a=r.distance(n,t,!0,!0),s=r.distance(e,e,!1,!0),i=r.distance(t,t,!1,!0),c=Math.abs(o),l=Math.abs(a),u=c+l,u===0){this.setRelative(n,n,(s+i)/2,r,!0);return}this.setRelative(n,n,(s*l+i*c)/u,r,!0)};Iu.prototype.setRelative=function(n,e,t,r,s){r=r||this;var i=s?e.xo:e.x,o=s?e.yo:e.y,a=i+t*r.x,c=o+t*r.y,l=r.normalSlope,u=this.slope,h=n.x,d=n.y;n.x=(u*h-l*a+c-d)/(u-l),n.y=u*(n.x-h)+d};Iu.prototype.touch=function(n){n.xTouched=!0,n.yTouched=!0};function Du(n,e){var t=Math.sqrt(n*n+e*e);return n/=t,e/=t,n===1&&e===0?xs:n===0&&e===1?Xs:new Iu(n,e)}function Ks(n,e,t,r){this.x=this.xo=Math.round(n*64)/64,this.y=this.yo=Math.round(e*64)/64,this.lastPointOfContour=t,this.onCurve=r,this.prevPointOnContour=void 0,this.nextPointOnContour=void 0,this.xTouched=!1,this.yTouched=!1,Object.preventExtensions(this)}Ks.prototype.nextTouched=function(n){for(var e=this.nextPointOnContour;!n.touched(e)&&e!==this;)e=e.nextPointOnContour;return e};Ks.prototype.prevTouched=function(n){for(var e=this.prevPointOnContour;!n.touched(e)&&e!==this;)e=e.prevPointOnContour;return e};var fu=Object.freeze(new Ks(0,0)),dJ={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:!0};function Ui(n,e){switch(this.env=n,this.stack=[],this.prog=e,n){case"glyf":this.zp0=this.zp1=this.zp2=1,this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=xs,this.round=zO}}VO.prototype.exec=function(n,e){if(typeof e!="number")throw new Error("Point size is not a number!");if(!(this._errorState>2)){var t=this.font,r=this._prepState;if(!r||r.ppem!==e){var s=this._fpgmState;if(!s){Ui.prototype=dJ,s=this._fpgmState=new Ui("fpgm",t.tables.fpgm),s.funcs=[],s.font=t,exports.DEBUG&&(console.log("---EXEC FPGM---"),s.step=-1);try{Lo(s)}catch(l){console.log("Hinting error in FPGM:"+l),this._errorState=3;return}}Ui.prototype=s,r=this._prepState=new Ui("prep",t.tables.prep),r.ppem=e;var i=t.tables.cvt;if(i)for(var o=r.cvt=new Array(i.length),a=e/t.unitsPerEm,c=0;c<i.length;c++)o[c]=i[c]*a;else r.cvt=[];exports.DEBUG&&(console.log("---EXEC PREP---"),r.step=-1);try{Lo(r)}catch(l){this._errorState<2&&console.log("Hinting error in PREP:"+l),this._errorState=2}}if(!(this._errorState>1))try{return GO(n,r)}catch(l){this._errorState<1&&(console.log("Hinting error:"+l),console.log("Note: further hinting errors are silenced")),this._errorState=1;return}}};GO=function(n,e){var t=e.ppem/e.font.unitsPerEm,r=t,s=n.components,i,o,a;if(Ui.prototype=e,!s)a=new Ui("glyf",n.instructions),exports.DEBUG&&(console.log("---EXEC GLYPH---"),a.step=-1),Mg(n,a,t,r),o=a.gZone;else{var c=e.font;o=[],i=[];for(var l=0;l<s.length;l++){var u=s[l],h=c.glyphs.get(u.glyphIndex);a=new Ui("glyf",h.instructions),exports.DEBUG&&(console.log("---EXEC COMP "+l+"---"),a.step=-1),Mg(h,a,t,r);for(var d=Math.round(u.dx*t),p=Math.round(u.dy*r),_=a.gZone,g=a.contours,f=0;f<_.length;f++){var m=_[f];m.xTouched=m.yTouched=!1,m.xo=m.x=m.x+d,m.yo=m.y=m.y+p}var y=o.length;o.push.apply(o,_);for(var v=0;v<g.length;v++)i.push(g[v]+y)}n.instructions&&!a.inhibitGridFit&&(a=new Ui("glyf",n.instructions),a.gZone=a.z0=a.z1=a.z2=o,a.contours=i,o.push(new Ks(0,0),new Ks(Math.round(n.advanceWidth*t),0)),exports.DEBUG&&(console.log("---EXEC COMPOSITE---"),a.step=-1),Lo(a),o.length-=2)}return o};Mg=function(n,e,t,r){for(var s=n.points||[],i=s.length,o=e.gZone=e.z0=e.z1=e.z2=[],a=e.contours=[],c,l=0;l<i;l++)c=s[l],o[l]=new Ks(c.x*t,c.y*r,c.lastPointOfContour,c.onCurve);for(var u,h,d=0;d<i;d++)c=o[d],u||(u=c,a.push(d)),c.lastPointOfContour?(c.nextPointOnContour=u,u.prevPointOnContour=c,u=void 0):(h=o[d+1],c.nextPointOnContour=h,h.prevPointOnContour=c);if(!e.inhibitGridFit){if(exports.DEBUG){console.log("PROCESSING GLYPH",e.stack);for(var p=0;p<i;p++)console.log(p,o[p].x,o[p].y)}if(o.push(new Ks(0,0),new Ks(Math.round(n.advanceWidth*t),0)),Lo(e),o.length-=2,exports.DEBUG){console.log("FINISHED GLYPH",e.stack);for(var _=0;_<i;_++)console.log(_,o[_].x,o[_].y)}}};Lo=function(n){var e=n.prog;if(e){var t=e.length,r;for(n.ip=0;n.ip<t;n.ip++){if(exports.DEBUG&&n.step++,r=BO[e[n.ip]],!r)throw new Error("unknown instruction: 0x"+Number(e[n.ip]).toString(16));r(n)}}};function Kp(n){for(var e=n.tZone=new Array(n.gZone.length),t=0;t<e.length;t++)e[t]=new Ks(0,0)}function jO(n,e){var t=n.prog,r=n.ip,s=1,i;do if(i=t[++r],i===88)s++;else if(i===89)s--;else if(i===64)r+=t[r+1]+1;else if(i===65)r+=2*t[r+1]+1;else if(i>=176&&i<=183)r+=i-176+1;else if(i>=184&&i<=191)r+=(i-184+1)*2;else if(e&&s===1&&i===27)break;while(s>0);n.ip=r}function qS(n,e){exports.DEBUG&&console.log(e.step,"SVTCA["+n.axis+"]"),e.fv=e.pv=e.dpv=n}function YS(n,e){exports.DEBUG&&console.log(e.step,"SPVTCA["+n.axis+"]"),e.pv=e.dpv=n}function KS(n,e){exports.DEBUG&&console.log(e.step,"SFVTCA["+n.axis+"]"),e.fv=n}function ZS(n,e){var t=e.stack,r=t.pop(),s=t.pop(),i=e.z2[r],o=e.z1[s];exports.DEBUG&&console.log("SPVTL["+n+"]",r,s);var a,c;n?(a=i.y-o.y,c=o.x-i.x):(a=o.x-i.x,c=o.y-i.y),e.pv=e.dpv=Du(a,c)}function JS(n,e){var t=e.stack,r=t.pop(),s=t.pop(),i=e.z2[r],o=e.z1[s];exports.DEBUG&&console.log("SFVTL["+n+"]",r,s);var a,c;n?(a=i.y-o.y,c=o.x-i.x):(a=o.x-i.x,c=o.y-i.y),e.fv=Du(a,c)}function pJ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"SPVFS[]",t,r),n.pv=n.dpv=Du(r,t)}function fJ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"SPVFS[]",t,r),n.fv=Du(r,t)}function mJ(n){var e=n.stack,t=n.pv;exports.DEBUG&&console.log(n.step,"GPV[]"),e.push(t.x*16384),e.push(t.y*16384)}function _J(n){var e=n.stack,t=n.fv;exports.DEBUG&&console.log(n.step,"GFV[]"),e.push(t.x*16384),e.push(t.y*16384)}function gJ(n){n.fv=n.pv,exports.DEBUG&&console.log(n.step,"SFVTPV[]")}function vJ(n){var e=n.stack,t=e.pop(),r=e.pop(),s=e.pop(),i=e.pop(),o=e.pop(),a=n.z0,c=n.z1,l=a[t],u=a[r],h=c[s],d=c[i],p=n.z2[o];exports.DEBUG&&console.log("ISECT[], ",t,r,s,i,o);var _=l.x,g=l.y,f=u.x,m=u.y,y=h.x,v=h.y,b=d.x,x=d.y,E=(_-f)*(v-x)-(g-m)*(y-b),S=_*m-g*f,R=y*x-v*b;p.x=(S*(y-b)-R*(_-f))/E,p.y=(S*(v-x)-R*(g-m))/E}function yJ(n){n.rp0=n.stack.pop(),exports.DEBUG&&console.log(n.step,"SRP0[]",n.rp0)}function xJ(n){n.rp1=n.stack.pop(),exports.DEBUG&&console.log(n.step,"SRP1[]",n.rp1)}function bJ(n){n.rp2=n.stack.pop(),exports.DEBUG&&console.log(n.step,"SRP2[]",n.rp2)}function CJ(n){var e=n.stack.pop();switch(exports.DEBUG&&console.log(n.step,"SZP0[]",e),n.zp0=e,e){case 0:n.tZone||Kp(n),n.z0=n.tZone;break;case 1:n.z0=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function EJ(n){var e=n.stack.pop();switch(exports.DEBUG&&console.log(n.step,"SZP1[]",e),n.zp1=e,e){case 0:n.tZone||Kp(n),n.z1=n.tZone;break;case 1:n.z1=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function SJ(n){var e=n.stack.pop();switch(exports.DEBUG&&console.log(n.step,"SZP2[]",e),n.zp2=e,e){case 0:n.tZone||Kp(n),n.z2=n.tZone;break;case 1:n.z2=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function AJ(n){var e=n.stack.pop();switch(exports.DEBUG&&console.log(n.step,"SZPS[]",e),n.zp0=n.zp1=n.zp2=e,e){case 0:n.tZone||Kp(n),n.z0=n.z1=n.z2=n.tZone;break;case 1:n.z0=n.z1=n.z2=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function TJ(n){n.loop=n.stack.pop(),exports.DEBUG&&console.log(n.step,"SLOOP[]",n.loop)}function MJ(n){exports.DEBUG&&console.log(n.step,"RTG[]"),n.round=zO}function RJ(n){exports.DEBUG&&console.log(n.step,"RTHG[]"),n.round=lJ}function wJ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"SMD[]",e),n.minDis=e/64}function OJ(n){exports.DEBUG&&console.log(n.step,"ELSE[]"),jO(n,!1)}function PJ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"JMPR[]",e),n.ip+=e-1}function NJ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"SCVTCI[]",e),n.cvCutIn=e/64}function IJ(n){var e=n.stack;exports.DEBUG&&console.log(n.step,"DUP[]"),e.push(e[e.length-1])}function Km(n){exports.DEBUG&&console.log(n.step,"POP[]"),n.stack.pop()}function DJ(n){exports.DEBUG&&console.log(n.step,"CLEAR[]"),n.stack.length=0}function LJ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"SWAP[]"),e.push(t),e.push(r)}function FJ(n){var e=n.stack;exports.DEBUG&&console.log(n.step,"DEPTH[]"),e.push(e.length)}function UJ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"LOOPCALL[]",t,r);var s=n.ip,i=n.prog;n.prog=n.funcs[t];for(var o=0;o<r;o++)Lo(n),exports.DEBUG&&console.log(++n.step,o+1<r?"next loopcall":"done loopcall",o);n.ip=s,n.prog=i}function kJ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"CALL[]",e);var t=n.ip,r=n.prog;n.prog=n.funcs[e],Lo(n),n.ip=t,n.prog=r,exports.DEBUG&&console.log(++n.step,"returning from",e)}function BJ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"CINDEX[]",t),e.push(e[e.length-t])}function GJ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"MINDEX[]",t),e.push(e.splice(e.length-t,1)[0])}function VJ(n){if(n.env!=="fpgm")throw new Error("FDEF not allowed here");var e=n.stack,t=n.prog,r=n.ip,s=e.pop(),i=r;for(exports.DEBUG&&console.log(n.step,"FDEF[]",s);t[++r]!==45;);n.ip=r,n.funcs[s]=t.slice(i+1,r)}function QS(n,e){var t=e.stack.pop(),r=e.z0[t],s=e.fv,i=e.pv;exports.DEBUG&&console.log(e.step,"MDAP["+n+"]",t);var o=i.distance(r,fu);n&&(o=e.round(o)),s.setRelative(r,fu,o,i),s.touch(r),e.rp0=e.rp1=t}function eA(n,e){var t=e.z2,r=t.length-2,s,i,o;exports.DEBUG&&console.log(e.step,"IUP["+n.axis+"]");for(var a=0;a<r;a++)s=t[a],!n.touched(s)&&(i=s.prevTouched(n),i!==s&&(o=s.nextTouched(n),i===o&&n.setRelative(s,s,n.distance(i,i,!1,!0),n,!0),n.interpolate(s,i,o,n)))}function tA(n,e){for(var t=e.stack,r=n?e.rp1:e.rp2,s=(n?e.z0:e.z1)[r],i=e.fv,o=e.pv,a=e.loop,c=e.z2;a--;){var l=t.pop(),u=c[l],h=o.distance(s,s,!1,!0);i.setRelative(u,u,h,o),i.touch(u),exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-a)+": ":"")+"SHP["+(n?"rp1":"rp2")+"]",l)}e.loop=1}function nA(n,e){var t=e.stack,r=n?e.rp1:e.rp2,s=(n?e.z0:e.z1)[r],i=e.fv,o=e.pv,a=t.pop(),c=e.z2[e.contours[a]],l=c;exports.DEBUG&&console.log(e.step,"SHC["+n+"]",a);var u=o.distance(s,s,!1,!0);do l!==s&&i.setRelative(l,l,u,o),l=l.nextPointOnContour;while(l!==c)}function rA(n,e){var t=e.stack,r=n?e.rp1:e.rp2,s=(n?e.z0:e.z1)[r],i=e.fv,o=e.pv,a=t.pop();exports.DEBUG&&console.log(e.step,"SHZ["+n+"]",a);var c;switch(a){case 0:c=e.tZone;break;case 1:c=e.gZone;break;default:throw new Error("Invalid zone")}for(var l,u=o.distance(s,s,!1,!0),h=c.length-2,d=0;d<h;d++)l=c[d],i.setRelative(l,l,u,o)}function zJ(n){for(var e=n.stack,t=n.loop,r=n.fv,s=e.pop()/64,i=n.z2;t--;){var o=e.pop(),a=i[o];exports.DEBUG&&console.log(n.step,(n.loop>1?"loop "+(n.loop-t)+": ":"")+"SHPIX[]",o,s),r.setRelative(a,a,s),r.touch(a)}n.loop=1}function HJ(n){for(var e=n.stack,t=n.rp1,r=n.rp2,s=n.loop,i=n.z0[t],o=n.z1[r],a=n.fv,c=n.dpv,l=n.z2;s--;){var u=e.pop(),h=l[u];exports.DEBUG&&console.log(n.step,(n.loop>1?"loop "+(n.loop-s)+": ":"")+"IP[]",u,t,"<->",r),a.interpolate(h,i,o,c),a.touch(h)}n.loop=1}function sA(n,e){var t=e.stack,r=t.pop()/64,s=t.pop(),i=e.z1[s],o=e.z0[e.rp0],a=e.fv,c=e.pv;a.setRelative(i,o,r,c),a.touch(i),exports.DEBUG&&console.log(e.step,"MSIRP["+n+"]",r,s),e.rp1=e.rp0,e.rp2=s,n&&(e.rp0=s)}function jJ(n){for(var e=n.stack,t=n.rp0,r=n.z0[t],s=n.loop,i=n.fv,o=n.pv,a=n.z1;s--;){var c=e.pop(),l=a[c];exports.DEBUG&&console.log(n.step,(n.loop>1?"loop "+(n.loop-s)+": ":"")+"ALIGNRP[]",c),i.setRelative(l,r,0,o),i.touch(l)}n.loop=1}function WJ(n){exports.DEBUG&&console.log(n.step,"RTDG[]"),n.round=cJ}function iA(n,e){var t=e.stack,r=t.pop(),s=t.pop(),i=e.z0[s],o=e.fv,a=e.pv,c=e.cvt[r];exports.DEBUG&&console.log(e.step,"MIAP["+n+"]",r,"(",c,")",s);var l=a.distance(i,fu);n&&(Math.abs(l-c)<e.cvCutIn&&(l=c),l=e.round(l)),o.setRelative(i,fu,l,a),e.zp0===0&&(i.xo=i.x,i.yo=i.y),o.touch(i),e.rp0=e.rp1=s}function XJ(n){var e=n.prog,t=n.ip,r=n.stack,s=e[++t];exports.DEBUG&&console.log(n.step,"NPUSHB[]",s);for(var i=0;i<s;i++)r.push(e[++t]);n.ip=t}function $J(n){var e=n.ip,t=n.prog,r=n.stack,s=t[++e];exports.DEBUG&&console.log(n.step,"NPUSHW[]",s);for(var i=0;i<s;i++){var o=t[++e]<<8|t[++e];o&32768&&(o=-((o^65535)+1)),r.push(o)}n.ip=e}function qJ(n){var e=n.stack,t=n.store;t||(t=n.store=[]);var r=e.pop(),s=e.pop();exports.DEBUG&&console.log(n.step,"WS",r,s),t[s]=r}function YJ(n){var e=n.stack,t=n.store,r=e.pop();exports.DEBUG&&console.log(n.step,"RS",r);var s=t&&t[r]||0;e.push(s)}function KJ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"WCVTP",t,r),n.cvt[r]=t/64}function ZJ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"RCVT",t),e.push(n.cvt[t]*64)}function oA(n,e){var t=e.stack,r=t.pop(),s=e.z2[r];exports.DEBUG&&console.log(e.step,"GC["+n+"]",r),t.push(e.dpv.distance(s,fu,n,!1)*64)}function aA(n,e){var t=e.stack,r=t.pop(),s=t.pop(),i=e.z1[r],o=e.z0[s],a=e.dpv.distance(o,i,n,n);exports.DEBUG&&console.log(e.step,"MD["+n+"]",r,s,"->",a),e.stack.push(Math.round(a*64))}function JJ(n){exports.DEBUG&&console.log(n.step,"MPPEM[]"),n.stack.push(n.ppem)}function QJ(n){exports.DEBUG&&console.log(n.step,"FLIPON[]"),n.autoFlip=!0}function eQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"LT[]",t,r),e.push(r<t?1:0)}function tQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"LTEQ[]",t,r),e.push(r<=t?1:0)}function nQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"GT[]",t,r),e.push(r>t?1:0)}function rQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"GTEQ[]",t,r),e.push(r>=t?1:0)}function sQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"EQ[]",t,r),e.push(t===r?1:0)}function iQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"NEQ[]",t,r),e.push(t!==r?1:0)}function oQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"ODD[]",t),e.push(Math.trunc(t)%2?1:0)}function aQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"EVEN[]",t),e.push(Math.trunc(t)%2?0:1)}function cQ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"IF[]",e),e||(jO(n,!0),exports.DEBUG&&console.log(n.step,"EIF[]"))}function lQ(n){exports.DEBUG&&console.log(n.step,"EIF[]")}function uQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"AND[]",t,r),e.push(t&&r?1:0)}function hQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"OR[]",t,r),e.push(t||r?1:0)}function dQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"NOT[]",t),e.push(t?0:1)}function Zm(n,e){var t=e.stack,r=t.pop(),s=e.fv,i=e.pv,o=e.ppem,a=e.deltaBase+(n-1)*16,c=e.deltaShift,l=e.z0;exports.DEBUG&&console.log(e.step,"DELTAP["+n+"]",r,t);for(var u=0;u<r;u++){var h=t.pop(),d=t.pop(),p=a+((d&240)>>4);if(p===o){var _=(d&15)-8;_>=0&&_++,exports.DEBUG&&console.log(e.step,"DELTAPFIX",h,"by",_*c);var g=l[h];s.setRelative(g,g,_*c,i)}}}function pQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"SDB[]",t),n.deltaBase=t}function fQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"SDS[]",t),n.deltaShift=Math.pow(.5,t)}function mQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"ADD[]",t,r),e.push(r+t)}function _Q(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"SUB[]",t,r),e.push(r-t)}function gQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"DIV[]",t,r),e.push(r*64/t)}function vQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"MUL[]",t,r),e.push(r*t/64)}function yQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"ABS[]",t),e.push(Math.abs(t))}function xQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"NEG[]",t),e.push(-t)}function bQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"FLOOR[]",t),e.push(Math.floor(t/64)*64)}function CQ(n){var e=n.stack,t=e.pop();exports.DEBUG&&console.log(n.step,"CEILING[]",t),e.push(Math.ceil(t/64)*64)}function cd(n,e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"ROUND[]"),t.push(e.round(r/64)*64)}function EQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"WCVTF[]",t,r),n.cvt[r]=t*n.ppem/n.font.unitsPerEm}function Jm(n,e){var t=e.stack,r=t.pop(),s=e.ppem,i=e.deltaBase+(n-1)*16,o=e.deltaShift;exports.DEBUG&&console.log(e.step,"DELTAC["+n+"]",r,t);for(var a=0;a<r;a++){var c=t.pop(),l=t.pop(),u=i+((l&240)>>4);if(u===s){var h=(l&15)-8;h>=0&&h++;var d=h*o;exports.DEBUG&&console.log(e.step,"DELTACFIX",c,"by",d),e.cvt[c]+=d}}}function SQ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"SROUND[]",e),n.round=HO;var t;switch(e&192){case 0:t=.5;break;case 64:t=1;break;case 128:t=2;break;default:throw new Error("invalid SROUND value")}switch(n.srPeriod=t,e&48){case 0:n.srPhase=0;break;case 16:n.srPhase=.25*t;break;case 32:n.srPhase=.5*t;break;case 48:n.srPhase=.75*t;break;default:throw new Error("invalid SROUND value")}e&=15,e===0?n.srThreshold=0:n.srThreshold=(e/8-.5)*t}function AQ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"S45ROUND[]",e),n.round=HO;var t;switch(e&192){case 0:t=Math.sqrt(2)/2;break;case 64:t=Math.sqrt(2);break;case 128:t=2*Math.sqrt(2);break;default:throw new Error("invalid S45ROUND value")}switch(n.srPeriod=t,e&48){case 0:n.srPhase=0;break;case 16:n.srPhase=.25*t;break;case 32:n.srPhase=.5*t;break;case 48:n.srPhase=.75*t;break;default:throw new Error("invalid S45ROUND value")}e&=15,e===0?n.srThreshold=0:n.srThreshold=(e/8-.5)*t}function TQ(n){exports.DEBUG&&console.log(n.step,"ROFF[]"),n.round=aJ}function MQ(n){exports.DEBUG&&console.log(n.step,"RUTG[]"),n.round=uJ}function RQ(n){exports.DEBUG&&console.log(n.step,"RDTG[]"),n.round=hJ}function wQ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"SCANCTRL[]",e)}function cA(n,e){var t=e.stack,r=t.pop(),s=t.pop(),i=e.z2[r],o=e.z1[s];exports.DEBUG&&console.log(e.step,"SDPVTL["+n+"]",r,s);var a,c;n?(a=i.y-o.y,c=o.x-i.x):(a=o.x-i.x,c=o.y-i.y),e.dpv=Du(a,c)}function OQ(n){var e=n.stack,t=e.pop(),r=0;exports.DEBUG&&console.log(n.step,"GETINFO[]",t),t&1&&(r=35),t&32&&(r|=4096),e.push(r)}function PQ(n){var e=n.stack,t=e.pop(),r=e.pop(),s=e.pop();exports.DEBUG&&console.log(n.step,"ROLL[]"),e.push(r),e.push(t),e.push(s)}function NQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"MAX[]",t,r),e.push(Math.max(r,t))}function IQ(n){var e=n.stack,t=e.pop(),r=e.pop();exports.DEBUG&&console.log(n.step,"MIN[]",t,r),e.push(Math.min(r,t))}function DQ(n){var e=n.stack.pop();exports.DEBUG&&console.log(n.step,"SCANTYPE[]",e)}function LQ(n){var e=n.stack.pop(),t=n.stack.pop();switch(exports.DEBUG&&console.log(n.step,"INSTCTRL[]",e,t),e){case 1:n.inhibitGridFit=!!t;return;case 2:n.ignoreCvt=!!t;return;default:throw new Error("invalid INSTCTRL[] selector")}}function gi(n,e){var t=e.stack,r=e.prog,s=e.ip;exports.DEBUG&&console.log(e.step,"PUSHB["+n+"]");for(var i=0;i<n;i++)t.push(r[++s]);e.ip=s}function vi(n,e){var t=e.ip,r=e.prog,s=e.stack;exports.DEBUG&&console.log(e.ip,"PUSHW["+n+"]");for(var i=0;i<n;i++){var o=r[++t]<<8|r[++t];o&32768&&(o=-((o^65535)+1)),s.push(o)}e.ip=t}function ze(n,e,t,r,s,i){var o=i.stack,a=n&&o.pop(),c=o.pop(),l=i.rp0,u=i.z0[l],h=i.z1[c],d=i.minDis,p=i.fv,_=i.dpv,g,f,m,y;f=g=_.distance(h,u,!0,!0),m=f>=0?1:-1,f=Math.abs(f),n&&(y=i.cvt[a],r&&Math.abs(f-y)<i.cvCutIn&&(f=y)),t&&f<d&&(f=d),r&&(f=i.round(f)),p.setRelative(h,u,m*f,_),p.touch(h),exports.DEBUG&&console.log(i.step,(n?"MIRP[":"MDRP[")+(e?"M":"m")+(t?">":"_")+(r?"R":"_")+(s===0?"Gr":s===1?"Bl":s===2?"Wh":"")+"]",n?a+"("+i.cvt[a]+","+y+")":"",c,"(d =",g,"->",m*f,")"),i.rp1=i.rp0,i.rp2=c,e&&(i.rp0=c)}BO=[qS.bind(void 0,Xs),qS.bind(void 0,xs),YS.bind(void 0,Xs),YS.bind(void 0,xs),KS.bind(void 0,Xs),KS.bind(void 0,xs),ZS.bind(void 0,0),ZS.bind(void 0,1),JS.bind(void 0,0),JS.bind(void 0,1),pJ,fJ,mJ,_J,gJ,vJ,yJ,xJ,bJ,CJ,EJ,SJ,AJ,TJ,MJ,RJ,wJ,OJ,PJ,NJ,void 0,void 0,IJ,Km,DJ,LJ,FJ,BJ,GJ,void 0,void 0,void 0,UJ,kJ,VJ,void 0,QS.bind(void 0,0),QS.bind(void 0,1),eA.bind(void 0,Xs),eA.bind(void 0,xs),tA.bind(void 0,0),tA.bind(void 0,1),nA.bind(void 0,0),nA.bind(void 0,1),rA.bind(void 0,0),rA.bind(void 0,1),zJ,HJ,sA.bind(void 0,0),sA.bind(void 0,1),jJ,WJ,iA.bind(void 0,0),iA.bind(void 0,1),XJ,$J,qJ,YJ,KJ,ZJ,oA.bind(void 0,0),oA.bind(void 0,1),void 0,aA.bind(void 0,0),aA.bind(void 0,1),JJ,void 0,QJ,void 0,void 0,eQ,tQ,nQ,rQ,sQ,iQ,oQ,aQ,cQ,lQ,uQ,hQ,dQ,Zm.bind(void 0,1),pQ,fQ,mQ,_Q,gQ,vQ,yQ,xQ,bQ,CQ,cd.bind(void 0,0),cd.bind(void 0,1),cd.bind(void 0,2),cd.bind(void 0,3),void 0,void 0,void 0,void 0,EQ,Zm.bind(void 0,2),Zm.bind(void 0,3),Jm.bind(void 0,1),Jm.bind(void 0,2),Jm.bind(void 0,3),SQ,AQ,void 0,void 0,TQ,void 0,MQ,RQ,Km,Km,void 0,void 0,void 0,void 0,void 0,wQ,cA.bind(void 0,0),cA.bind(void 0,1),OQ,void 0,PQ,NQ,IQ,DQ,LQ,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,gi.bind(void 0,1),gi.bind(void 0,2),gi.bind(void 0,3),gi.bind(void 0,4),gi.bind(void 0,5),gi.bind(void 0,6),gi.bind(void 0,7),gi.bind(void 0,8),vi.bind(void 0,1),vi.bind(void 0,2),vi.bind(void 0,3),vi.bind(void 0,4),vi.bind(void 0,5),vi.bind(void 0,6),vi.bind(void 0,7),vi.bind(void 0,8),ze.bind(void 0,0,0,0,0,0),ze.bind(void 0,0,0,0,0,1),ze.bind(void 0,0,0,0,0,2),ze.bind(void 0,0,0,0,0,3),ze.bind(void 0,0,0,0,1,0),ze.bind(void 0,0,0,0,1,1),ze.bind(void 0,0,0,0,1,2),ze.bind(void 0,0,0,0,1,3),ze.bind(void 0,0,0,1,0,0),ze.bind(void 0,0,0,1,0,1),ze.bind(void 0,0,0,1,0,2),ze.bind(void 0,0,0,1,0,3),ze.bind(void 0,0,0,1,1,0),ze.bind(void 0,0,0,1,1,1),ze.bind(void 0,0,0,1,1,2),ze.bind(void 0,0,0,1,1,3),ze.bind(void 0,0,1,0,0,0),ze.bind(void 0,0,1,0,0,1),ze.bind(void 0,0,1,0,0,2),ze.bind(void 0,0,1,0,0,3),ze.bind(void 0,0,1,0,1,0),ze.bind(void 0,0,1,0,1,1),ze.bind(void 0,0,1,0,1,2),ze.bind(void 0,0,1,0,1,3),ze.bind(void 0,0,1,1,0,0),ze.bind(void 0,0,1,1,0,1),ze.bind(void 0,0,1,1,0,2),ze.bind(void 0,0,1,1,0,3),ze.bind(void 0,0,1,1,1,0),ze.bind(void 0,0,1,1,1,1),ze.bind(void 0,0,1,1,1,2),ze.bind(void 0,0,1,1,1,3),ze.bind(void 0,1,0,0,0,0),ze.bind(void 0,1,0,0,0,1),ze.bind(void 0,1,0,0,0,2),ze.bind(void 0,1,0,0,0,3),ze.bind(void 0,1,0,0,1,0),ze.bind(void 0,1,0,0,1,1),ze.bind(void 0,1,0,0,1,2),ze.bind(void 0,1,0,0,1,3),ze.bind(void 0,1,0,1,0,0),ze.bind(void 0,1,0,1,0,1),ze.bind(void 0,1,0,1,0,2),ze.bind(void 0,1,0,1,0,3),ze.bind(void 0,1,0,1,1,0),ze.bind(void 0,1,0,1,1,1),ze.bind(void 0,1,0,1,1,2),ze.bind(void 0,1,0,1,1,3),ze.bind(void 0,1,1,0,0,0),ze.bind(void 0,1,1,0,0,1),ze.bind(void 0,1,1,0,0,2),ze.bind(void 0,1,1,0,0,3),ze.bind(void 0,1,1,0,1,0),ze.bind(void 0,1,1,0,1,1),ze.bind(void 0,1,1,0,1,2),ze.bind(void 0,1,1,0,1,3),ze.bind(void 0,1,1,1,0,0),ze.bind(void 0,1,1,1,0,1),ze.bind(void 0,1,1,1,0,2),ze.bind(void 0,1,1,1,0,3),ze.bind(void 0,1,1,1,1,0),ze.bind(void 0,1,1,1,1,1),ze.bind(void 0,1,1,1,1,2),ze.bind(void 0,1,1,1,1,3)];function Nc(n){this.char=n,this.state={},this.activeState=null}function q0(n,e,t){this.contextName=t,this.startIndex=n,this.endOffset=e}function FQ(n,e,t){this.contextName=n,this.openRange=null,this.ranges=[],this.checkStart=e,this.checkEnd=t}function ts(n,e){this.context=n,this.index=e,this.length=n.length,this.current=n[e],this.backtrack=n.slice(0,e),this.lookahead=n.slice(e+1)}function Zp(n){this.eventId=n,this.subscribers=[]}function UQ(n){var e=this,t=["start","end","next","newToken","contextStart","contextEnd","insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD","updateContextsRanges"];t.forEach(function(s){Object.defineProperty(e.events,s,{value:new Zp(s)})}),n&&t.forEach(function(s){var i=n[s];typeof i=="function"&&e.events[s].subscribe(i)});var r=["insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD"];r.forEach(function(s){e.events[s].subscribe(e.updateContextsRanges)})}function on(n){this.tokens=[],this.registeredContexts={},this.contextCheckers=[],this.events={},this.registeredModifiers=[],UQ.call(this,n)}Nc.prototype.setState=function(n,e){return this.state[n]=e,this.activeState={key:n,value:this.state[n]},this.activeState};Nc.prototype.getState=function(n){return this.state[n]||null};on.prototype.inboundIndex=function(n){return n>=0&&n<this.tokens.length};on.prototype.composeRUD=function(n){var e=this,t=!0,r=n.map(function(i){return e[i[0]].apply(e,i.slice(1).concat(t))}),s=function(i){return typeof i=="object"&&i.hasOwnProperty("FAIL")};if(r.every(s))return{FAIL:"composeRUD: one or more operations hasn't completed successfully",report:r.filter(s)};this.dispatch("composeRUD",[r.filter(function(i){return!s(i)})])};on.prototype.replaceRange=function(n,e,t,r){e=e!==null?e:this.tokens.length;var s=t.every(function(o){return o instanceof Nc});if(!isNaN(n)&&this.inboundIndex(n)&&s){var i=this.tokens.splice.apply(this.tokens,[n,e].concat(t));return r||this.dispatch("replaceToken",[n,e,t]),[i,t]}else return{FAIL:"replaceRange: invalid tokens or startIndex."}};on.prototype.replaceToken=function(n,e,t){if(!isNaN(n)&&this.inboundIndex(n)&&e instanceof Nc){var r=this.tokens.splice(n,1,e);return t||this.dispatch("replaceToken",[n,e]),[r[0],e]}else return{FAIL:"replaceToken: invalid token or index."}};on.prototype.removeRange=function(n,e,t){e=isNaN(e)?this.tokens.length:e;var r=this.tokens.splice(n,e);return t||this.dispatch("removeRange",[r,n,e]),r};on.prototype.removeToken=function(n,e){if(!isNaN(n)&&this.inboundIndex(n)){var t=this.tokens.splice(n,1);return e||this.dispatch("removeToken",[t,n]),t}else return{FAIL:"removeToken: invalid token index."}};on.prototype.insertToken=function(n,e,t){var r=n.every(function(s){return s instanceof Nc});return r?(this.tokens.splice.apply(this.tokens,[e,0].concat(n)),t||this.dispatch("insertToken",[n,e]),n):{FAIL:"insertToken: invalid token(s)."}};on.prototype.registerModifier=function(n,e,t){this.events.newToken.subscribe(function(r,s){var i=[r,s],o=e===null||e.apply(this,i)===!0,a=[r,s];if(o){var c=t.apply(this,a);r.setState(n,c)}}),this.registeredModifiers.push(n)};Zp.prototype.subscribe=function(n){return typeof n=="function"?this.subscribers.push(n)-1:{FAIL:"invalid '"+this.eventId+"' event handler"}};Zp.prototype.unsubscribe=function(n){this.subscribers.splice(n,1)};ts.prototype.setCurrentIndex=function(n){this.index=n,this.current=this.context[n],this.backtrack=this.context.slice(0,n),this.lookahead=this.context.slice(n+1)};ts.prototype.get=function(n){switch(!0){case n===0:return this.current;case(n<0&&Math.abs(n)<=this.backtrack.length):return this.backtrack.slice(n)[0];case(n>0&&n<=this.lookahead.length):return this.lookahead[n-1];default:return null}};on.prototype.rangeToText=function(n){if(n instanceof q0)return this.getRangeTokens(n).map(function(e){return e.char}).join("")};on.prototype.getText=function(){return this.tokens.map(function(n){return n.char}).join("")};on.prototype.getContext=function(n){var e=this.registeredContexts[n];return e||null};on.prototype.on=function(n,e){var t=this.events[n];return t?t.subscribe(e):null};on.prototype.dispatch=function(n,e){var t=this,r=this.events[n];r instanceof Zp&&r.subscribers.forEach(function(s){s.apply(t,e||[])})};on.prototype.registerContextChecker=function(n,e,t){if(this.getContext(n))return{FAIL:"context name '"+n+"' is already registered."};if(typeof e!="function")return{FAIL:"missing context start check."};if(typeof t!="function")return{FAIL:"missing context end check."};var r=new FQ(n,e,t);return this.registeredContexts[n]=r,this.contextCheckers.push(r),r};on.prototype.getRangeTokens=function(n){var e=n.startIndex+n.endOffset;return[].concat(this.tokens.slice(n.startIndex,e))};on.prototype.getContextRanges=function(n){var e=this.getContext(n);return e?e.ranges:{FAIL:"context checker '"+n+"' is not registered."}};on.prototype.resetContextsRanges=function(){var n=this.registeredContexts;for(var e in n)if(n.hasOwnProperty(e)){var t=n[e];t.ranges=[]}};on.prototype.updateContextsRanges=function(){this.resetContextsRanges();for(var n=this.tokens.map(function(r){return r.char}),e=0;e<n.length;e++){var t=new ts(n,e);this.runContextCheck(t)}this.dispatch("updateContextsRanges",[this.registeredContexts])};on.prototype.setEndOffset=function(n,e){var t=this.getContext(e).openRange.startIndex,r=new q0(t,n,e),s=this.getContext(e).ranges;return r.rangeId=e+"."+s.length,s.push(r),this.getContext(e).openRange=null,r};on.prototype.runContextCheck=function(n){var e=this,t=n.index;this.contextCheckers.forEach(function(r){var s=r.contextName,i=e.getContext(s).openRange;if(!i&&r.checkStart(n)&&(i=new q0(t,null,s),e.getContext(s).openRange=i,e.dispatch("contextStart",[s,t])),i&&r.checkEnd(n)){var o=t-i.startIndex+1,a=e.setEndOffset(o,s);e.dispatch("contextEnd",[s,a])}})};on.prototype.tokenize=function(n){this.tokens=[],this.resetContextsRanges();var e=Array.from(n);this.dispatch("start");for(var t=0;t<e.length;t++){var r=e[t],s=new ts(e,t);this.dispatch("next",[s]),this.runContextCheck(s);var i=new Nc(r);this.tokens.push(i),this.dispatch("newToken",[i,s])}return this.dispatch("end",[this.tokens]),this.tokens};function Hi(n){return/[\u0600-\u065F\u066A-\u06D2\u06FA-\u06FF]/.test(n)}function WO(n){return/[\u0630\u0690\u0621\u0631\u0661\u0671\u0622\u0632\u0672\u0692\u06C2\u0623\u0673\u0693\u06C3\u0624\u0694\u06C4\u0625\u0675\u0695\u06C5\u06E5\u0676\u0696\u06C6\u0627\u0677\u0697\u06C7\u0648\u0688\u0698\u06C8\u0689\u0699\u06C9\u068A\u06CA\u066B\u068B\u06CB\u068C\u068D\u06CD\u06FD\u068E\u06EE\u06FE\u062F\u068F\u06CF\u06EF]/.test(n)}function qi(n){return/[\u0600-\u0605\u060C-\u060E\u0610-\u061B\u061E\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED]/.test(n)}function wd(n){return/[A-z]/.test(n)}function kQ(n){return/\s/.test(n)}function Cr(n){this.font=n,this.features={}}function xo(n){this.id=n.id,this.tag=n.tag,this.substitution=n.substitution}function Lu(n,e){if(!n)return-1;switch(e.format){case 1:return e.glyphs.indexOf(n);case 2:for(var t=e.ranges,r=0;r<t.length;r++){var s=t[r];if(n>=s.start&&n<=s.end){var i=n-s.start;return s.index+i}}break;default:return-1}return-1}function BQ(n,e){var t=Lu(n,e.coverage);return t===-1?null:n+e.deltaGlyphId}function GQ(n,e){var t=Lu(n,e.coverage);return t===-1?null:e.substitute[t]}function Qm(n,e){for(var t=[],r=0;r<n.length;r++){var s=n[r],i=e.current;i=Array.isArray(i)?i[0]:i;var o=Lu(i,s);o!==-1&&t.push(o)}return t.length!==n.length?-1:t}function VQ(n,e){var t=e.inputCoverage.length+e.lookaheadCoverage.length+e.backtrackCoverage.length;if(n.context.length<t)return[];var r=Qm(e.inputCoverage,n);if(r===-1)return[];var s=e.inputCoverage.length-1;if(n.lookahead.length<e.lookaheadCoverage.length)return[];for(var i=n.lookahead.slice(s);i.length&&qi(i[0].char);)i.shift();var o=new ts(i,0),a=Qm(e.lookaheadCoverage,o),c=[].concat(n.backtrack);for(c.reverse();c.length&&qi(c[0].char);)c.shift();if(c.length<e.backtrackCoverage.length)return[];var l=new ts(c,0),u=Qm(e.backtrackCoverage,l),h=r.length===e.inputCoverage.length&&a.length===e.lookaheadCoverage.length&&u.length===e.backtrackCoverage.length,d=[];if(h)for(var p=0;p<e.lookupRecords.length;p++)for(var _=e.lookupRecords[p],g=_.lookupListIndex,f=this.getLookupByIndex(g),m=0;m<f.subtables.length;m++){var y=f.subtables[m],v=this.getLookupMethod(f,y),b=this.getSubstitutionType(f,y);if(b==="12")for(var x=0;x<r.length;x++){var E=n.get(x),S=v(E);S&&d.push(S)}}return d}function zQ(n,e){var t=n.current,r=Lu(t,e.coverage);if(r===-1)return null;for(var s,i=e.ligatureSets[r],o=0;o<i.length;o++){s=i[o];for(var a=0;a<s.components.length;a++){var c=n.lookahead[a],l=s.components[a];if(c!==l)break;if(a===s.components.length-1)return s}}return null}function HQ(n,e){var t=Lu(n,e.coverage);return t===-1?null:e.sequences[t]}Cr.prototype.getDefaultScriptFeaturesIndexes=function(){for(var n=this.font.tables.gsub.scripts,e=0;e<n.length;e++){var t=n[e];if(t.tag==="DFLT")return t.script.defaultLangSys.featureIndexes}return[]};Cr.prototype.getScriptFeaturesIndexes=function(n){var e=this.font.tables;if(!e.gsub)return[];if(!n)return this.getDefaultScriptFeaturesIndexes();for(var t=this.font.tables.gsub.scripts,r=0;r<t.length;r++){var s=t[r];if(s.tag===n&&s.script.defaultLangSys)return s.script.defaultLangSys.featureIndexes;var i=s.langSysRecords;if(i)for(var o=0;o<i.length;o++){var a=i[o];if(a.tag===n){var c=a.langSys;return c.featureIndexes}}}return this.getDefaultScriptFeaturesIndexes()};Cr.prototype.mapTagsToFeatures=function(n,e){for(var t={},r=0;r<n.length;r++){var s=n[r].tag,i=n[r].feature;t[s]=i}this.features[e].tags=t};Cr.prototype.getScriptFeatures=function(n){var e=this.features[n];if(this.features.hasOwnProperty(n))return e;var t=this.getScriptFeaturesIndexes(n);if(!t)return null;var r=this.font.tables.gsub;return e=t.map(function(s){return r.features[s]}),this.features[n]=e,this.mapTagsToFeatures(e,n),e};Cr.prototype.getSubstitutionType=function(n,e){var t=n.lookupType.toString(),r=e.substFormat.toString();return t+r};Cr.prototype.getLookupMethod=function(n,e){var t=this,r=this.getSubstitutionType(n,e);switch(r){case"11":return function(s){return BQ.apply(t,[s,e])};case"12":return function(s){return GQ.apply(t,[s,e])};case"63":return function(s){return VQ.apply(t,[s,e])};case"41":return function(s){return zQ.apply(t,[s,e])};case"21":return function(s){return HQ.apply(t,[s,e])};default:throw new Error("lookupType: "+n.lookupType+" - substFormat: "+e.substFormat+" is not yet supported")}};Cr.prototype.lookupFeature=function(n){var e=n.contextParams,t=e.index,r=this.getFeature({tag:n.tag,script:n.script});if(!r)return new Error("font '"+this.font.names.fullName.en+"' doesn't support feature '"+n.tag+"' for script '"+n.script+"'.");for(var s=this.getFeatureLookups(r),i=[].concat(e.context),o=0;o<s.length;o++)for(var a=s[o],c=this.getLookupSubtables(a),l=0;l<c.length;l++){var u=c[l],h=this.getSubstitutionType(a,u),d=this.getLookupMethod(a,u),p=void 0;switch(h){case"11":p=d(e.current),p&&i.splice(t,1,new xo({id:11,tag:n.tag,substitution:p}));break;case"12":p=d(e.current),p&&i.splice(t,1,new xo({id:12,tag:n.tag,substitution:p}));break;case"63":p=d(e),Array.isArray(p)&&p.length&&i.splice(t,1,new xo({id:63,tag:n.tag,substitution:p}));break;case"41":p=d(e),p&&i.splice(t,1,new xo({id:41,tag:n.tag,substitution:p}));break;case"21":p=d(e.current),p&&i.splice(t,1,new xo({id:21,tag:n.tag,substitution:p}));break}e=new ts(i,t),!(Array.isArray(p)&&!p.length)&&(p=null)}return i.length?i:null};Cr.prototype.supports=function(n){if(!n.script)return!1;this.getScriptFeatures(n.script);var e=this.features.hasOwnProperty(n.script);if(!n.tag)return e;var t=this.features[n.script].some(function(r){return r.tag===n.tag});return e&&t};Cr.prototype.getLookupSubtables=function(n){return n.subtables||null};Cr.prototype.getLookupByIndex=function(n){var e=this.font.tables.gsub.lookups;return e[n]||null};Cr.prototype.getFeatureLookups=function(n){return n.lookupListIndexes.map(this.getLookupByIndex.bind(this))};Cr.prototype.getFeature=function(e){if(!this.font)return{FAIL:"No font was found"};this.features.hasOwnProperty(e.script)||this.getScriptFeatures(e.script);var t=this.features[e.script];return t?t.tags[e.tag]?this.features[e.script].tags[e.tag]:null:{FAIL:"No feature for script "+e.script}};function jQ(n){var e=n.current,t=n.get(-1);return t===null&&Hi(e)||!Hi(t)&&Hi(e)}function WQ(n){var e=n.get(1);return e===null||!Hi(e)}var XQ={startCheck:jQ,endCheck:WQ};function $Q(n){var e=n.current,t=n.get(-1);return(Hi(e)||qi(e))&&!Hi(t)}function qQ(n){var e=n.get(1);switch(!0){case e===null:return!0;case(!Hi(e)&&!qi(e)):var t=kQ(e);if(!t)return!0;if(t){var r=!1;if(r=n.lookahead.some(function(s){return Hi(s)||qi(s)}),!r)return!0}break;default:return!1}}var YQ={startCheck:$Q,endCheck:qQ};function KQ(n,e,t){e[t].setState(n.tag,n.substitution)}function ZQ(n,e,t){e[t].setState(n.tag,n.substitution)}function JQ(n,e,t){n.substitution.forEach(function(r,s){var i=e[t+s];i.setState(n.tag,r)})}function QQ(n,e,t){var r=e[t];r.setState(n.tag,n.substitution.ligGlyph);for(var s=n.substitution.components.length,i=0;i<s;i++)r=e[t+i+1],r.setState("deleted",!0)}var lA={11:KQ,12:ZQ,63:JQ,41:QQ};function Y0(n,e,t){n instanceof xo&&lA[n.id]&&lA[n.id](n,e,t)}function eee(n){for(var e=[].concat(n.backtrack),t=e.length-1;t>=0;t--){var r=e[t],s=WO(r),i=qi(r);if(!s&&!i)return!0;if(s)return!1}return!1}function tee(n){if(WO(n.current))return!1;for(var e=0;e<n.lookahead.length;e++){var t=n.lookahead[e],r=qi(t);if(!r)return!0}return!1}function nee(n){var e=this,t="arab",r=this.featuresTags[t],s=this.tokenizer.getRangeTokens(n);if(s.length!==1){var i=new ts(s.map(function(a){return a.getState("glyphIndex")}),0),o=new ts(s.map(function(a){return a.char}),0);s.forEach(function(a,c){if(!qi(a.char)){i.setCurrentIndex(c),o.setCurrentIndex(c);var l=0;eee(o)&&(l|=1),tee(o)&&(l|=2);var u;switch(l){case 1:u="fina";break;case 2:u="init";break;case 3:u="medi";break}if(r.indexOf(u)!==-1){var h=e.query.lookupFeature({tag:u,script:t,contextParams:i});if(h instanceof Error)return console.info(h.message);h.forEach(function(d,p){d instanceof xo&&(Y0(d,s,p),i.context[p]=d.substitution)})}}})}}function uA(n,e){var t=n.map(function(r){return r.activeState.value});return new ts(t,e||0)}function ree(n){var e=this,t="arab",r=this.tokenizer.getRangeTokens(n),s=uA(r);s.context.forEach(function(i,o){s.setCurrentIndex(o);var a=e.query.lookupFeature({tag:"rlig",script:t,contextParams:s});a.length&&(a.forEach(function(c){return Y0(c,r,o)}),s=uA(r))})}function see(n){var e=n.current,t=n.get(-1);return t===null&&wd(e)||!wd(t)&&wd(e)}function iee(n){var e=n.get(1);return e===null||!wd(e)}var oee={startCheck:see,endCheck:iee};function hA(n,e){var t=n.map(function(r){return r.activeState.value});return new ts(t,e||0)}function aee(n){var e=this,t="latn",r=this.tokenizer.getRangeTokens(n),s=hA(r);s.context.forEach(function(i,o){s.setCurrentIndex(o);var a=e.query.lookupFeature({tag:"liga",script:t,contextParams:s});a.length&&(a.forEach(function(c){return Y0(c,r,o)}),s=hA(r))})}function is(n){this.baseDir=n||"ltr",this.tokenizer=new on,this.featuresTags={}}is.prototype.setText=function(n){this.text=n};is.prototype.contextChecks={latinWordCheck:oee,arabicWordCheck:XQ,arabicSentenceCheck:YQ};function e_(n){var e=this.contextChecks[n+"Check"];return this.tokenizer.registerContextChecker(n,e.startCheck,e.endCheck)}function cee(){return e_.call(this,"latinWord"),e_.call(this,"arabicWord"),e_.call(this,"arabicSentence"),this.tokenizer.tokenize(this.text)}function lee(){var n=this,e=this.tokenizer.getContextRanges("arabicSentence");e.forEach(function(t){var r=n.tokenizer.getRangeTokens(t);n.tokenizer.replaceRange(t.startIndex,t.endOffset,r.reverse())})}is.prototype.registerFeatures=function(n,e){var t=this,r=e.filter(function(s){return t.query.supports({script:n,tag:s})});this.featuresTags.hasOwnProperty(n)?this.featuresTags[n]=this.featuresTags[n].concat(r):this.featuresTags[n]=r};is.prototype.applyFeatures=function(n,e){if(!n)throw new Error("No valid font was provided to apply features");this.query||(this.query=new Cr(n));for(var t=0;t<e.length;t++){var r=e[t];this.query.supports({script:r.script})&&this.registerFeatures(r.script,r.tags)}};is.prototype.registerModifier=function(n,e,t){this.tokenizer.registerModifier(n,e,t)};function K0(){if(this.tokenizer.registeredModifiers.indexOf("glyphIndex")===-1)throw new Error("glyphIndex modifier is required to apply arabic presentation features.")}function uee(){var n=this,e="arab";if(this.featuresTags.hasOwnProperty(e)){K0.call(this);var t=this.tokenizer.getContextRanges("arabicWord");t.forEach(function(r){nee.call(n,r)})}}function hee(){var n=this,e="arab";if(this.featuresTags.hasOwnProperty(e)){var t=this.featuresTags[e];if(t.indexOf("rlig")!==-1){K0.call(this);var r=this.tokenizer.getContextRanges("arabicWord");r.forEach(function(s){ree.call(n,s)})}}}function dee(){var n=this,e="latn";if(this.featuresTags.hasOwnProperty(e)){var t=this.featuresTags[e];if(t.indexOf("liga")!==-1){K0.call(this);var r=this.tokenizer.getContextRanges("latinWord");r.forEach(function(s){aee.call(n,s)})}}}is.prototype.checkContextReady=function(n){return!!this.tokenizer.getContext(n)};is.prototype.applyFeaturesToContexts=function(){this.checkContextReady("arabicWord")&&(uee.call(this),hee.call(this)),this.checkContextReady("latinWord")&&dee.call(this),this.checkContextReady("arabicSentence")&&lee.call(this)};is.prototype.processText=function(n){(!this.text||this.text!==n)&&(this.setText(n),cee.call(this),this.applyFeaturesToContexts())};is.prototype.getBidiText=function(n){return this.processText(n),this.tokenizer.getText()};is.prototype.getTextGlyphs=function(n){this.processText(n);for(var e=[],t=0;t<this.tokenizer.tokens.length;t++){var r=this.tokenizer.tokens[t];if(!r.state.deleted){var s=r.activeState.value;e.push(Array.isArray(s)?s[0]:s)}}return e};function Pt(n){n=n||{},n.tables=n.tables||{},n.empty||(il(n.familyName,"When creating a new Font object, familyName is required."),il(n.styleName,"When creating a new Font object, styleName is required."),il(n.unitsPerEm,"When creating a new Font object, unitsPerEm is required."),il(n.ascender,"When creating a new Font object, ascender is required."),il(n.descender<=0,"When creating a new Font object, negative descender value is required."),this.names={fontFamily:{en:n.familyName||" "},fontSubfamily:{en:n.styleName||" "},fullName:{en:n.fullName||n.familyName+" "+n.styleName},postScriptName:{en:n.postScriptName||(n.familyName+n.styleName).replace(/\s/g,"")},designer:{en:n.designer||" "},designerURL:{en:n.designerURL||" "},manufacturer:{en:n.manufacturer||" "},manufacturerURL:{en:n.manufacturerURL||" "},license:{en:n.license||" "},licenseURL:{en:n.licenseURL||" "},version:{en:n.version||"Version 0.1"},description:{en:n.description||" "},copyright:{en:n.copyright||" "},trademark:{en:n.trademark||" "}},this.unitsPerEm=n.unitsPerEm||1e3,this.ascender=n.ascender,this.descender=n.descender,this.createdTimestamp=n.createdTimestamp,this.tables=Object.assign(n.tables,{os2:Object.assign({usWeightClass:n.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:n.widthClass||this.usWidthClasses.MEDIUM,fsSelection:n.fsSelection||this.fsSelectionValues.REGULAR},n.tables.os2)})),this.supported=!0,this.glyphs=new As.GlyphSet(this,n.glyphs||[]),this.encoding=new cO(this),this.position=new Nu(this),this.substitution=new br(this),this.tables=this.tables||{},this._push=null,this._hmtxTableData={},Object.defineProperty(this,"hinting",{get:function(){if(this._hinting)return this._hinting;if(this.outlinesFormat==="truetype")return this._hinting=new VO(this)}})}Pt.prototype.hasChar=function(n){return this.encoding.charToGlyphIndex(n)!==null};Pt.prototype.charToGlyphIndex=function(n){return this.encoding.charToGlyphIndex(n)};Pt.prototype.charToGlyph=function(n){var e=this.charToGlyphIndex(n),t=this.glyphs.get(e);return t||(t=this.glyphs.get(0)),t};Pt.prototype.updateFeatures=function(n){return this.defaultRenderOptions.features.map(function(e){return e.script==="latn"?{script:"latn",tags:e.tags.filter(function(t){return n[t]})}:e})};Pt.prototype.stringToGlyphs=function(n,e){var t=this,r=new is,s=function(h){return t.charToGlyphIndex(h.char)};r.registerModifier("glyphIndex",null,s);var i=e?this.updateFeatures(e.features):this.defaultRenderOptions.features;r.applyFeatures(this,i);for(var o=r.getTextGlyphs(n),a=o.length,c=new Array(a),l=this.glyphs.get(0),u=0;u<a;u+=1)c[u]=this.glyphs.get(o[u])||l;return c};Pt.prototype.nameToGlyphIndex=function(n){return this.glyphNames.nameToGlyphIndex(n)};Pt.prototype.nameToGlyph=function(n){var e=this.nameToGlyphIndex(n),t=this.glyphs.get(e);return t||(t=this.glyphs.get(0)),t};Pt.prototype.glyphIndexToName=function(n){return this.glyphNames.glyphIndexToName?this.glyphNames.glyphIndexToName(n):""};Pt.prototype.getKerningValue=function(n,e){n=n.index||n,e=e.index||e;var t=this.position.defaultKerningTables;return t?this.position.getKerningValue(t,n,e):this.kerningPairs[n+","+e]||0};Pt.prototype.defaultRenderOptions={kerning:!0,features:[{script:"arab",tags:["init","medi","fina","rlig"]},{script:"latn",tags:["liga","rlig"]}]};Pt.prototype.forEachGlyph=function(n,e,t,r,s,i){e=e!==void 0?e:0,t=t!==void 0?t:0,r=r!==void 0?r:72,s=Object.assign({},this.defaultRenderOptions,s);var o=1/this.unitsPerEm*r,a=this.stringToGlyphs(n,s),c;if(s.kerning){var l=s.script||this.position.getDefaultScriptName();c=this.position.getKerningTables(l,s.language)}for(var u=0;u<a.length;u+=1){var h=a[u];if(i.call(this,h,e,t,r,s),h.advanceWidth&&(e+=h.advanceWidth*o),s.kerning&&u<a.length-1){var d=c?this.position.getKerningValue(c,h.index,a[u+1].index):this.getKerningValue(h,a[u+1]);e+=d*o}s.letterSpacing?e+=s.letterSpacing*r:s.tracking&&(e+=s.tracking/1e3*r)}return e};Pt.prototype.getPath=function(n,e,t,r,s){var i=new vn;return this.forEachGlyph(n,e,t,r,s,function(o,a,c,l){var u=o.getPath(a,c,l,s,this);i.extend(u)}),i};Pt.prototype.getPaths=function(n,e,t,r,s){var i=[];return this.forEachGlyph(n,e,t,r,s,function(o,a,c,l){var u=o.getPath(a,c,l,s,this);i.push(u)}),i};Pt.prototype.getAdvanceWidth=function(n,e,t){return this.forEachGlyph(n,0,0,e,t,function(){})};Pt.prototype.draw=function(n,e,t,r,s,i){this.getPath(e,t,r,s,i).draw(n)};Pt.prototype.drawPoints=function(n,e,t,r,s,i){this.forEachGlyph(e,t,r,s,i,function(o,a,c,l){o.drawPoints(n,a,c,l)})};Pt.prototype.drawMetrics=function(n,e,t,r,s,i){this.forEachGlyph(e,t,r,s,i,function(o,a,c,l){o.drawMetrics(n,a,c,l)})};Pt.prototype.getEnglishName=function(n){var e=this.names[n];if(e)return e.en};Pt.prototype.validate=function(){var n=this;function e(r,s){}function t(r){var s=n.getEnglishName(r);s&&s.trim().length>0}t("fontFamily"),t("weightName"),t("manufacturer"),t("copyright"),t("version"),this.unitsPerEm>0};Pt.prototype.toTables=function(){return tJ.fontToTable(this)};Pt.prototype.toBuffer=function(){return console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead."),this.toArrayBuffer()};Pt.prototype.toArrayBuffer=function(){for(var n=this.toTables(),e=n.encode(),t=new ArrayBuffer(e.length),r=new Uint8Array(t),s=0;s<e.length;s++)r[s]=e[s];return t};Pt.prototype.download=function(n){var e=this.getEnglishName("fontFamily"),t=this.getEnglishName("fontSubfamily");n=n||e.replace(/\s/g,"")+"-"+t+".otf";var r=this.toArrayBuffer();if(window.URL=window.URL||window.webkitURL,window.URL){var s=new DataView(r),i=new Blob([s],{type:"font/opentype"}),o=document.createElement("a");o.href=window.URL.createObjectURL(i),o.download=n;var a=document.createEvent("MouseEvents");a.initEvent("click",!0,!1),o.dispatchEvent(a)}else console.warn("Font file could not be downloaded. Try using a different browser.")};Pt.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512};Pt.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9};Pt.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};function XO(n,e){var t=JSON.stringify(n),r=256;for(var s in e){var i=parseInt(s);if(!(!i||i<256)){if(JSON.stringify(e[s])===t)return i;r<=i&&(r=i+1)}}return e[r]=n,r}function pee(n,e,t){var r=XO(e.name,t);return[{name:"tag_"+n,type:"TAG",value:e.tag},{name:"minValue_"+n,type:"FIXED",value:e.minValue<<16},{name:"defaultValue_"+n,type:"FIXED",value:e.defaultValue<<16},{name:"maxValue_"+n,type:"FIXED",value:e.maxValue<<16},{name:"flags_"+n,type:"USHORT",value:0},{name:"nameID_"+n,type:"USHORT",value:r}]}function fee(n,e,t){var r={},s=new He.Parser(n,e);return r.tag=s.parseTag(),r.minValue=s.parseFixed(),r.defaultValue=s.parseFixed(),r.maxValue=s.parseFixed(),s.skip("uShort",1),r.name=t[s.parseUShort()]||{},r}function mee(n,e,t,r){for(var s=XO(e.name,r),i=[{name:"nameID_"+n,type:"USHORT",value:s},{name:"flags_"+n,type:"USHORT",value:0}],o=0;o<t.length;++o){var a=t[o].tag;i.push({name:"axis_"+n+" "+a,type:"FIXED",value:e.coordinates[a]<<16})}return i}function _ee(n,e,t,r){var s={},i=new He.Parser(n,e);s.name=r[i.parseUShort()]||{},i.skip("uShort",1),s.coordinates={};for(var o=0;o<t.length;++o)s.coordinates[t[o].tag]=i.parseFixed();return s}function gee(n,e){var t=new Fe.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:n.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:n.instances.length},{name:"instanceSize",type:"USHORT",value:4+n.axes.length*4}]);t.offsetToData=t.sizeOf();for(var r=0;r<n.axes.length;r++)t.fields=t.fields.concat(pee(r,n.axes[r],e));for(var s=0;s<n.instances.length;s++)t.fields=t.fields.concat(mee(s,n.instances[s],n.axes,e));return t}function vee(n,e,t){var r=new He.Parser(n,e),s=r.parseULong();$e.argument(s===65536,"Unsupported fvar table version.");var i=r.parseOffset16();r.skip("uShort",1);for(var o=r.parseUShort(),a=r.parseUShort(),c=r.parseUShort(),l=r.parseUShort(),u=[],h=0;h<o;h++)u.push(fee(n,e+i+h*a,t));for(var d=[],p=e+i+o*a,_=0;_<c;_++)d.push(_ee(n,p+_*l,u,t));return{axes:u,instances:d}}var yee={make:gee,parse:vee},xee=function(){return{coverage:this.parsePointer(ie.coverage),attachPoints:this.parseList(ie.pointer(ie.uShortList))}},bee=function(){var n=this.parseUShort();if($e.argument(n===1||n===2||n===3,"Unsupported CaretValue table version."),n===1)return{coordinate:this.parseShort()};if(n===2)return{pointindex:this.parseShort()};if(n===3)return{coordinate:this.parseShort()}},Cee=function(){return this.parseList(ie.pointer(bee))},Eee=function(){return{coverage:this.parsePointer(ie.coverage),ligGlyphs:this.parseList(ie.pointer(Cee))}},See=function(){return this.parseUShort(),this.parseList(ie.pointer(ie.coverage))};function Aee(n,e){e=e||0;var t=new ie(n,e),r=t.parseVersion(1);$e.argument(r===1||r===1.2||r===1.3,"Unsupported GDEF table version.");var s={version:r,classDef:t.parsePointer(ie.classDef),attachList:t.parsePointer(xee),ligCaretList:t.parsePointer(Eee),markAttachClassDef:t.parsePointer(ie.classDef)};return r>=1.2&&(s.markGlyphSets=t.parsePointer(See)),s}var Tee={parse:Aee},ns=new Array(10);ns[1]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(t===1)return{posFormat:1,coverage:this.parsePointer(ie.coverage),value:this.parseValueRecord()};if(t===2)return{posFormat:2,coverage:this.parsePointer(ie.coverage),values:this.parseValueRecordList()};$e.assert(!1,"0x"+e.toString(16)+": GPOS lookup type 1 format must be 1 or 2.")};ns[2]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();$e.assert(t===1||t===2,"0x"+e.toString(16)+": GPOS lookup type 2 format must be 1 or 2.");var r=this.parsePointer(ie.coverage),s=this.parseUShort(),i=this.parseUShort();if(t===1)return{posFormat:t,coverage:r,valueFormat1:s,valueFormat2:i,pairSets:this.parseList(ie.pointer(ie.list(function(){return{secondGlyph:this.parseUShort(),value1:this.parseValueRecord(s),value2:this.parseValueRecord(i)}})))};if(t===2){var o=this.parsePointer(ie.classDef),a=this.parsePointer(ie.classDef),c=this.parseUShort(),l=this.parseUShort();return{posFormat:t,coverage:r,valueFormat1:s,valueFormat2:i,classDef1:o,classDef2:a,class1Count:c,class2Count:l,classRecords:this.parseList(c,ie.list(l,function(){return{value1:this.parseValueRecord(s),value2:this.parseValueRecord(i)}}))}}};ns[3]=function(){return{error:"GPOS Lookup 3 not supported"}};ns[4]=function(){return{error:"GPOS Lookup 4 not supported"}};ns[5]=function(){return{error:"GPOS Lookup 5 not supported"}};ns[6]=function(){return{error:"GPOS Lookup 6 not supported"}};ns[7]=function(){return{error:"GPOS Lookup 7 not supported"}};ns[8]=function(){return{error:"GPOS Lookup 8 not supported"}};ns[9]=function(){return{error:"GPOS Lookup 9 not supported"}};function Mee(n,e){e=e||0;var t=new ie(n,e),r=t.parseVersion(1);return $e.argument(r===1||r===1.1,"Unsupported GPOS table version "+r),r===1?{version:r,scripts:t.parseScriptList(),features:t.parseFeatureList(),lookups:t.parseLookupList(ns)}:{version:r,scripts:t.parseScriptList(),features:t.parseFeatureList(),lookups:t.parseLookupList(ns),variations:t.parseFeatureVariationsList()}}var Ree=new Array(10);function wee(n){return new Fe.Table("GPOS",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new Fe.ScriptList(n.scripts)},{name:"features",type:"TABLE",value:new Fe.FeatureList(n.features)},{name:"lookups",type:"TABLE",value:new Fe.LookupList(n.lookups,Ree)}])}var Oee={parse:Mee,make:wee};function Pee(n){var e={};n.skip("uShort");var t=n.parseUShort();$e.argument(t===0,"Unsupported kern sub-table version."),n.skip("uShort",2);var r=n.parseUShort();n.skip("uShort",3);for(var s=0;s<r;s+=1){var i=n.parseUShort(),o=n.parseUShort(),a=n.parseShort();e[i+","+o]=a}return e}function Nee(n){var e={};n.skip("uShort");var t=n.parseULong();t>1&&console.warn("Only the first kern subtable is supported."),n.skip("uLong");var r=n.parseUShort(),s=r&255;if(n.skip("uShort"),s===0){var i=n.parseUShort();n.skip("uShort",3);for(var o=0;o<i;o+=1){var a=n.parseUShort(),c=n.parseUShort(),l=n.parseShort();e[a+","+c]=l}}return e}function Iee(n,e){var t=new He.Parser(n,e),r=t.parseUShort();if(r===0)return Pee(t);if(r===1)return Nee(t);throw new Error("Unsupported kern table version ("+r+").")}var Dee={parse:Iee};function Lee(n,e,t,r){for(var s=new He.Parser(n,e),i=r?s.parseUShort:s.parseULong,o=[],a=0;a<t+1;a+=1){var c=i.call(s);r&&(c*=2),o.push(c)}return o}var Fee={parse:Lee};function Uee(n,e){var t=new XMLHttpRequest;t.open("get",n,!0),t.responseType="arraybuffer",t.onload=function(){return t.response?e(null,t.response):e("Font could not be loaded: "+t.statusText)},t.onerror=function(){e("Font could not be loaded")},t.send()}function dA(n,e){for(var t=[],r=12,s=0;s<e;s+=1){var i=He.getTag(n,r),o=He.getULong(n,r+4),a=He.getULong(n,r+8),c=He.getULong(n,r+12);t.push({tag:i,checksum:o,offset:a,length:c,compression:!1}),r+=16}return t}function kee(n,e){for(var t=[],r=44,s=0;s<e;s+=1){var i=He.getTag(n,r),o=He.getULong(n,r+4),a=He.getULong(n,r+8),c=He.getULong(n,r+12),l=void 0;a<c?l="WOFF":l=!1,t.push({tag:i,offset:o,compression:l,compressedLength:a,length:c}),r+=20}return t}function Yt(n,e){if(e.compression==="WOFF"){var t=new Uint8Array(n.buffer,e.offset+2,e.compressedLength-2),r=new Uint8Array(e.length);if(RK(t,r),r.byteLength!==e.length)throw new Error("Decompression error: "+e.tag+" decompressed length doesn't match recorded length");var s=new DataView(r.buffer,0);return{data:s,offset:0}}else return{data:n,offset:e.offset}}function $O(n,e){e=e??{};var t,r,s=new Pt({empty:!0}),i=new DataView(n,0),o,a=[],c=He.getTag(i,0);if(c===String.fromCharCode(0,1,0,0)||c==="true"||c==="typ1")s.outlinesFormat="truetype",o=He.getUShort(i,4),a=dA(i,o);else if(c==="OTTO")s.outlinesFormat="cff",o=He.getUShort(i,4),a=dA(i,o);else if(c==="wOFF"){var l=He.getTag(i,4);if(l===String.fromCharCode(0,1,0,0))s.outlinesFormat="truetype";else if(l==="OTTO")s.outlinesFormat="cff";else throw new Error("Unsupported OpenType flavor "+c);o=He.getUShort(i,12),a=kee(i,o)}else throw new Error("Unsupported OpenType signature "+c);for(var u,h,d,p,_,g,f,m,y,v,b,x,E=0;E<o;E+=1){var S=a[E],R=void 0;switch(S.tag){case"cmap":R=Yt(i,S),s.tables.cmap=aO.parse(R.data,R.offset),s.encoding=new lO(s.tables.cmap);break;case"cvt ":R=Yt(i,S),x=new He.Parser(R.data,R.offset),s.tables.cvt=x.parseShortList(S.length/2);break;case"fvar":h=S;break;case"fpgm":R=Yt(i,S),x=new He.Parser(R.data,R.offset),s.tables.fpgm=x.parseByteList(S.length);break;case"head":R=Yt(i,S),s.tables.head=yO.parse(R.data,R.offset),s.unitsPerEm=s.tables.head.unitsPerEm,t=s.tables.head.indexToLocFormat;break;case"hhea":R=Yt(i,S),s.tables.hhea=xO.parse(R.data,R.offset),s.ascender=s.tables.hhea.ascender,s.descender=s.tables.hhea.descender,s.numberOfHMetrics=s.tables.hhea.numberOfHMetrics;break;case"hmtx":f=S;break;case"ltag":R=Yt(i,S),r=CO.parse(R.data,R.offset);break;case"COLR":R=Yt(i,S),s.tables.colr=NO.parse(R.data,R.offset);break;case"CPAL":R=Yt(i,S),s.tables.cpal=IO.parse(R.data,R.offset);break;case"maxp":R=Yt(i,S),s.tables.maxp=EO.parse(R.data,R.offset),s.numGlyphs=s.tables.maxp.numGlyphs;break;case"name":v=S;break;case"OS/2":R=Yt(i,S),s.tables.os2=Tg.parse(R.data,R.offset);break;case"post":R=Yt(i,S),s.tables.post=wO.parse(R.data,R.offset),s.glyphNames=new j0(s.tables.post);break;case"prep":R=Yt(i,S),x=new He.Parser(R.data,R.offset),s.tables.prep=x.parseByteList(S.length);break;case"glyf":d=S;break;case"loca":y=S;break;case"CFF ":u=S;break;case"kern":m=S;break;case"GDEF":p=S;break;case"GPOS":_=S;break;case"GSUB":g=S;break;case"meta":b=S;break}}var C=Yt(i,v);if(s.tables.name=RO.parse(C.data,C.offset,r),s.names=s.tables.name,d&&y){var M=t===0,G=Yt(i,y),F=Fee.parse(G.data,G.offset,s.numGlyphs,M),X=Yt(i,d);s.glyphs=kO.parse(X.data,X.offset,F,s,e)}else if(u){var N=Yt(i,u);vO.parse(N.data,N.offset,s,e)}else throw new Error("Font doesn't contain TrueType or CFF outlines.");var j=Yt(i,f);if(bO.parse(s,j.data,j.offset,s.numberOfHMetrics,s.numGlyphs,s.glyphs,e),YK(s,e),m){var K=Yt(i,m);s.kerningPairs=Dee.parse(K.data,K.offset)}else s.kerningPairs={};if(p){var $=Yt(i,p);s.tables.gdef=Tee.parse($.data,$.offset)}if(_){var q=Yt(i,_);s.tables.gpos=Oee.parse(q.data,q.offset),s.position.init()}if(g){var ne=Yt(i,g);s.tables.gsub=OO.parse(ne.data,ne.offset)}if(h){var le=Yt(i,h);s.tables.fvar=yee.parse(le.data,le.offset,s.names)}if(b){var ue=Yt(i,b);s.tables.meta=PO.parse(ue.data,ue.offset),s.metas=s.tables.meta}return s}function Bee(n,e,t){return t=t??{},new Promise(function(r,s){Uee(n,function(i,o){if(i){if(e)return e(i);s(i)}var a;try{a=$O(o,t)}catch(c){if(e)return e(c,null);s(c)}if(e)return e(null,a);r(a)})})}var Gee=Object.freeze({__proto__:null,Font:Pt,Glyph:xr,Path:vn,BoundingBox:ai,_parse:He,parse:$O,load:Bee});const Vee=Gee;class zee extends ko{constructor(e){super(e),this.reversed=!1}load(e,t,r,s){const i=this,o=new vu(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(a){try{t(i.parse(a))}catch(c){s?s(c):console.error(c),i.manager.itemError(e)}},r,s)}parse(e){function t(s,i){const o=Math.round,a={},c=1e5/((s.unitsPerEm||2048)*72),l=s.encoding.cmap.glyphIndexMap,u=Object.keys(l);for(let h=0;h<u.length;h++){const d=u[h],p=s.glyphs.glyphs[l[d]];if(d!==void 0){const _={ha:o(p.advanceWidth*c),x_min:o(p.xMin*c),x_max:o(p.xMax*c),o:""};i&&(p.path.commands=r(p.path.commands)),p.path.commands.forEach(function(g){g.type.toLowerCase()==="c"&&(g.type="b"),_.o+=g.type.toLowerCase()+" ",g.x!==void 0&&g.y!==void 0&&(_.o+=o(g.x*c)+" "+o(g.y*c)+" "),g.x1!==void 0&&g.y1!==void 0&&(_.o+=o(g.x1*c)+" "+o(g.y1*c)+" "),g.x2!==void 0&&g.y2!==void 0&&(_.o+=o(g.x2*c)+" "+o(g.y2*c)+" ")}),a[String.fromCodePoint(p.unicode)]=_}}return{glyphs:a,familyName:s.getEnglishName("fullName"),ascender:o(s.ascender*c),descender:o(s.descender*c),underlinePosition:s.tables.post.underlinePosition,underlineThickness:s.tables.post.underlineThickness,boundingBox:{xMin:s.tables.head.xMin,xMax:s.tables.head.xMax,yMin:s.tables.head.yMin,yMax:s.tables.head.yMax},resolution:1e3,original_font_information:s.tables.name}}function r(s){const i=[];let o;s.forEach(function(c){c.type.toLowerCase()==="m"?(o=[c],i.push(o)):c.type.toLowerCase()!=="z"&&o.push(c)});const a=[];return i.forEach(function(c){const l={type:"m",x:c[c.length-1].x,y:c[c.length-1].y};a.push(l);for(let u=c.length-1;u>0;u--){const h=c[u],d={type:h.type};h.x2!==void 0&&h.y2!==void 0?(d.x1=h.x2,d.y1=h.y2,d.x2=h.x1,d.y2=h.y1):h.x1!==void 0&&h.y1!==void 0&&(d.x1=h.x1,d.y1=h.y1),d.x=c[u-1].x,d.y=c[u-1].y,a.push(d)}}),a}return t(Vee.parse(e),this.reversed)}}class qO extends qp{constructor(e,t){super(e,t),this._fontLoader=new yK(this.loadingManager)}async load(){this._node&&ve.blobs.clearBlobsForNode(this._node);const e=this.extension(),t=this._urlToLoad();switch(e){case"ttf":return this._loadTTF(t);case"json":return this._loadJSON(t);default:return null}}_loadTTF(e){return new Promise(async(t,r)=>{const s=await this._loadTTFLoader();s&&s.load(e,i=>{const o=this._fontLoader.parse(i);t(o)},void 0,i=>{r(i)})})}_loadJSON(e){return new Promise((t,r)=>{this._fontLoader.load(e,s=>{t(s)},void 0,()=>{r()})})}async _loadTTFLoader(){return new zee(this.loadingManager)}static async loadSVGLoader(){return B0}}const Hee="https://raw.githubusercontent.com/polygonjs/polygonjs-assets/master",jee=`${Hee}/fonts/droid_sans_regular.typeface.json`;var YO=(n=>(n.LEFT="left",n.RIGHT="right",n.CENTER="center",n))(YO||{});const Rg=["left","right","center"];function Wee(n,e){if(n.length==0)return;let t=null;for(const s of n)s&&(s.computeBoundingBox(),s.boundingBox&&(t==null?t=s.boundingBox:t.union(s.boundingBox)));if(!t)return;const r=e.justifyMode;Xee(n,r,t)}function Xee(n,e,t){switch(e){case"left":return;case"center":{const r=.5*(t.min.x+t.max.x);for(const s of n)s==null||s.translate(-r,0,0);return}case"right":{const r=t.max.x;for(const s of n)s==null||s.translate(-r,0,0);return}}St.unreachable(e)}function $ee(n){var e;return(e=n.shapes)==null?void 0:e.map(t=>qee({...n,shapes:t}))}function qee(n){const e={curveSegments:n.curveSegments,depth:n.extrude,bevelEnabled:n.bevelEnabled,bevelThickness:n.bevelThickness,bevelSize:n.bevelSize,bevelOffset:n.bevelOffset,bevelSegments:n.bevelSegments},t=n.shapes.map(r=>new Yg(r,e));if(!(t==null||t.length==0))return Eu(t)}function Yee(n){return n.font.generateShapes(n.text,n)}function Kee(n){var e;return(e=n.shapes)==null?void 0:e.map(t=>Zee({shapes:t}))}function Zee(n){var e;const t=((e=n.shapes)==null?void 0:e.map(r=>new Kg(r)))||[];if(!(t==null||t.length==0))return Eu(t)}async function Jee(n){var e;const t=await qO.loadSVGLoader();if(t)return(e=n.shapes)==null?void 0:e.map(r=>Qee({loader:t,shapes:r,strokeWidth:n.strokeWidth}))}function Qee(n){if(!n.shapes)return;var e=n.loader.getStrokeStyle(n.strokeWidth,"white","miter","butt",4);const t=[];for(let r=0;r<n.shapes.length;r++){const i=n.shapes[r].getPoints(),o=12,a=.001,c=n.loader.pointsToStroke(i,e,o,a);t.push(c)}if(t.length>0)return Eu(t)}function pA(n){return n==null?void 0:n.map(e=>ete(e))}function ete(n){const e=[...n];if(n)for(let t=0;t<n.length;t++){const r=n[t],s=[];if(r.holes&&r.holes.length>0)for(let i=0;i<r.holes.length;i++){const o=r.holes[i];s.push(o)}e.push(...s)}return e}function tte(n){var e;return(e=n.shapes)==null?void 0:e.map(t=>nte(t))}function nte(n){if(!n)return;const e=[],t=[];let r=0;for(let i=0;i<n.length;i++){const a=n[i].getPoints();for(let c=0;c<a.length;c++){const l=a[c];e.push(l.x),e.push(l.y),e.push(0),t.push(r),c>0&&c<a.length-1&&t.push(r),r+=1}}const s=new sn;return s.setAttribute("position",new gt(e,3)),s.setIndex(t),s}var Qn=(n=>(n.MESH="mesh",n.FLAT="flat",n.LINE="line",n.STROKE="stroke",n))(Qn||{});const wr=["mesh","flat","line","stroke"];async function rte(n){const{textType:e}=n,t=Yee(n);switch(e){case Qn.MESH:return $ee({...n,shapes:t});case Qn.FLAT:return Kee({shapes:t});case Qn.LINE:return tte({shapes:pA(t)});case Qn.STROKE:return await Jee({shapes:pA(t),strokeWidth:n.strokeWidth})}St.unreachable(e)}const ste=["reset objects transform","center geometries","center geometry and reset object"],yi=new T,Pa=new qe,Od=class extends Ft{static type(){return"transformReset"}cook(n,e){const t=ste[e.mode];return this._selectMode(t,n)}_selectMode(n,e){switch(n){case"reset objects transform":return this._resetObjects(e[0]);case"center geometries":return Od.centerCoreGroup(e[0],{applyMatrixToObject:!1,refCoreGroup:e[1]});case"center geometry and reset object":return Od.centerCoreGroup(e[0],{applyMatrixToObject:!0,refCoreGroup:e[1]})}St.unreachable(n)}_resetObjects(n){const e=n.threejsObjects();for(let t of e)t.matrix.identity(),Pn.decomposeMatrix(t);return n}static centerCoreGroup(n,e){const t=n.threejsObjects();let r=t;e.refCoreGroup&&(r=e.refCoreGroup.threejsObjectsWithGeo());for(let s=0;s<t.length;s++){const i=t[s],o=r[s]||r[r.length-1];Od.centerObject(i,{applyMatrixToObject:e.applyMatrixToObject,refObject:o})}return n}static centerObject(n,e){const t=e.refObject||n,r=n.geometry,s=t.geometry;if(r&&s){s.computeBoundingBox();const i=s.boundingBox;i&&(i.getCenter(yi),t.updateMatrixWorld(),yi.applyMatrix4(t.matrixWorld),e.applyMatrixToObject&&(Pa.identity(),Pa.makeTranslation(yi.x,yi.y,yi.z),n.matrix.multiply(Pa),Pn.decomposeMatrix(n),n.updateWorldMatrix(!1,!1)),Pa.identity(),Pa.makeTranslation(-yi.x,-yi.y,-yi.z),r.applyMatrix4(Pa))}}};let Z0=Od;Z0.DEFAULT_PARAMS={mode:0};Z0.INPUT_CLONED_STATE=Mt.FROM_NODE;function ite(n,e){if(n.length==0||e.lineHeight==1)return;let t=null;for(const i of n)i&&(i.computeBoundingBox(),i.boundingBox&&(t==null?t=i.boundingBox:t.union(i.boundingBox)));if(!t)return;const s=t.min.y*e.lineHeight-t.min.y;for(const i of n)i==null||i.translate(0,s,0)}function ote(n){const e=cte(n);for(const s of e)Wee(s,n),ite(s,n);const t=e.flat(),r=ate({...n,geometries:t});if(r)return Js(r,[])}function ate(n){const e=n.textType==Qn.LINE?Tt.LINE_SEGMENTS:Tt.MESH;if(n.splitPerLetter){let t=function(a){let c=r[s];if(c===`
`){i++,s++;return}if(c==" "&&n.keepEmptyGeometries==!1){s++;return}const l=zt.createObject(a||new sn,e);Z0.centerObject(l,{applyMatrixToObject:!0});const u=new Gt(l,s);return u.addAttribute("character",c),l.name=c,u.addAttribute("characterId",s),u.addAttribute("lineId",i),s++,l};const r=Array.from(n.text);let s=0,i=0;const o=[];for(let a=0;a<n.geometries.length;a++){const c=t(n.geometries[a]);c&&o.push(c)}return o}else try{const t=[];if(Js(n.geometries,t),t.length>0){const r=Eu(t);return[zt.createObject(r,e)]}}catch{return}}function cte(n){const e=[],t=Array.from(n.text);let r=0,s=0;for(const i of n.geometries)t[r]===`
`&&s++,e[s]=e[s]||[],e[s].push(i),r++;return e}const lte="failed to generate geometry. Try to remove some characters";class ute extends Et{constructor(){super(...arguments),this.font=A.STRING(jee,{fileBrowse:{extensions:Pw[be.SOP][rn.TEXT]}}),this.text=A.STRING("polygonjs",{multiline:!0}),this.type=A.INTEGER(0,{menu:{entries:wr.map((e,t)=>({name:e,value:t}))}}),this.size=A.FLOAT(1,{range:[0,1],rangeLocked:[!0,!1]}),this.extrude=A.FLOAT(.1,{visibleIf:{type:wr.indexOf(Qn.MESH)}}),this.segments=A.INTEGER(1,{range:[1,20],rangeLocked:[!0,!1],visibleIf:{type:wr.indexOf(Qn.MESH)}}),this.bevelEnabled=A.BOOLEAN(!1,{visibleIf:{type:wr.indexOf(Qn.MESH)}}),this.bevelThickness=A.FLOAT(0,{visibleIf:{type:wr.indexOf(Qn.MESH),bevelEnabled:!0}}),this.bevelSize=A.FLOAT(0,{visibleIf:{type:wr.indexOf(Qn.MESH),bevelEnabled:!0}}),this.bevelOffset=A.FLOAT(0,{visibleIf:{type:wr.indexOf(Qn.MESH),bevelEnabled:!0}}),this.bevelSegments=A.INTEGER(2,{range:[1,6],visibleIf:{type:wr.indexOf(Qn.MESH),bevelEnabled:!0}}),this.strokeWidth=A.FLOAT(.02,{visibleIf:{type:wr.indexOf(Qn.STROKE)}}),this.lineHeight=A.FLOAT(1,{range:[0,2],rangeLocked:[!1,!1]}),this.splitPerLetter=A.BOOLEAN(0),this.keepEmptyGeometries=A.BOOLEAN(0,{visibleIf:{splitPerLetter:1}}),this.justifyMode=A.INTEGER(Rg.indexOf(YO.LEFT),{menu:{entries:Rg.map((e,t)=>({name:e,value:t}))}}),this.tadvanced=A.BOOLEAN(0),this.isCCW=A.BOOLEAN(0,{visibleIf:{tadvanced:!0}})}}const hte=new ute;class dte extends zt{constructor(){super(...arguments),this.paramsConfig=hte,this._loadedFonts=new Map}static type(){return rn.TEXT}dispose(){super.dispose(),ve.blobs.clearBlobsForNode(this)}setTextType(e){this.p.type.set(wr.indexOf(e))}async cook(){const e=this.pv.font;let t=this._loadedFonts.get(e);try{t||(t=await new qO(this.pv.font,this).load(),t&&this._loadedFonts.set(e,t))}catch(o){console.warn("error:",o),this.states.error.set(`could not load font (${this.pv.font}, reason:${o.message})`),this.cookController.endCook();return}if(!t){this.cookController.endCook();return}const r=wr[this.pv.type];if(!wr.includes(r)){this.cookController.endCook();return}if(this.pv.text.replace(/\s/g,"").length==0)return this.setObjects([]);const i=await await rte({text:this.pv.text,textType:r,font:t,size:this.pv.size,extrude:this.pv.extrude,curveSegments:this.pv.segments,strokeWidth:this.pv.strokeWidth,bevelEnabled:this.pv.bevelEnabled,bevelThickness:this.pv.bevelThickness,bevelSize:this.pv.bevelSize,bevelOffset:this.pv.bevelOffset,bevelSegments:this.pv.bevelSegments,isCCW:this.pv.tadvanced?this.pv.isCCW:void 0});if(i){const o=ote({text:this.pv.text,geometries:i,textType:r,splitPerLetter:this.pv.splitPerLetter,keepEmptyGeometries:this.pv.keepEmptyGeometries,justifyMode:Rg[this.pv.justifyMode],lineHeight:this.pv.lineHeight});if(o)return this.setObjects(o)}this.states.error.set(lte),this.cookController.endCook()}}const ld=new T,fA=new pr,mA=new Qt,_A=new T,gA=new qe,pte=new T,vA=[];class mu extends Ft{constructor(){super(...arguments),this._coreTransform=new Pn}static type(){return rn.TRANSFORM}cook(e,t){const r=e[0],s=Qr.filterObjects(r,t);for(const i of s)this._applyTransform(i,r,t);return r.resetBoundingBox(),r}_applyTransform(e,t,r){Xn(e)?this._applyTransformWithTransformTargetType(e,t,r):this._applyTransformWithoutTransformTargetType(e,r)}_applyTransformWithoutTransformTargetType(e,t){this._updateObject(e,t)}_applyTransformWithTransformTargetType(e,t,r){const s=nr[r.applyOn];switch(s){case hr.GEOMETRY:return this._updateGeometry(e,r);case hr.OBJECT:return this._updateObject(e,r)}St.unreachable(s)}_updateGeometry(e,t){const r=this._matrix(t),s=t.pointGroup;if(s.trim()===""){const i=e.geometry;i&&(i.translate(-t.pivot.x,-t.pivot.y,-t.pivot.z),i.applyMatrix4(r),i.translate(t.pivot.x,t.pivot.y,t.pivot.z))}else{P4(e,s,vA);for(const i of vA){const o=i.position(pte).sub(t.pivot);o.applyMatrix4(r),i.setPosition(o.add(t.pivot))}}}_updateObject(e,t){const r=ql[t.objectMode];switch(r){case Co.SET:return this._setMatrix(e,t);case Co.MULT:return this._multMatrix(e,t)}St.unreachable(r)}_setMatrix(e,t){const r=Io[t.rotationOrder];ld.copy(t.r).multiplyScalar(On.DEG2RAD),fA.set(ld.x,ld.y,ld.z,r),mA.setFromEuler(fA),_A.copy(t.s).multiplyScalar(t.scale),gA.compose(t.t,mA,_A),Ut(e).applyMatrix(e,gA,nr[t.applyOn],Lv.LOCAL,Co.SET)}_multMatrix(e,t){const r=this._matrix(t),s=Xd[t.objectTransformSpace];oR(e,r,s,Co.MULT)}_matrix(e){return this._coreTransform.matrix(e.t,e.r,e.s,e.scale,Io[e.rotationOrder])}}mu.DEFAULT_PARAMS={applyOn:nr.indexOf(hr.GEOMETRY),group:"",objectMode:ql.indexOf(Co.SET),objectTransformSpace:Xd.indexOf(Lv.PARENT),pointGroup:"",rotationOrder:Io.indexOf(Dv.XYZ),t:new T(0,0,0),r:new T(0,0,0),s:new T(1,1,1),scale:1,pivot:new T(0,0,0)};mu.INPUT_CLONED_STATE=Mt.FROM_NODE;const us=mu.DEFAULT_PARAMS;class fte extends Et{constructor(){super(...arguments),this.applyOn=A.INTEGER(us.applyOn,{menu:{entries:nr.map((e,t)=>({name:e,value:t}))}}),this.group=A.STRING(us.group,{objectMask:!0}),this.objectMode=A.INTEGER(us.objectMode,{visibleIf:{applyOn:nr.indexOf(hr.OBJECT)},menu:{entries:ql.map((e,t)=>({name:e,value:t}))}}),this.objectTransformSpace=A.INTEGER(0,{visibleIf:{applyOn:nr.indexOf(hr.OBJECT),objectMode:ql.indexOf(Co.MULT)},menu:{entries:w4}}),this.pointGroup=A.STRING(us.pointGroup,{visibleIf:{applyOn:nr.indexOf(hr.GEOMETRY)}}),this.rotationOrder=A.INTEGER(us.rotationOrder,{separatorBefore:!0,menu:{entries:Io.map((e,t)=>({name:e,value:t}))}}),this.t=A.VECTOR3(us.t),this.r=A.VECTOR3(us.r),this.s=A.VECTOR3(us.s),this.scale=A.FLOAT(us.scale,{range:[0,2],step:.01}),this.pivot=A.VECTOR3(us.pivot,{visibleIf:{applyOn:nr.indexOf(hr.GEOMETRY)}})}}const mte=new fte;class _te extends zt{constructor(){super(...arguments),this.paramsConfig=mte}static type(){return rn.TRANSFORM}initializeNode(){this.io.inputs.setCount(1),this.io.inputs.initInputsClonedState(mu.INPUT_CLONED_STATE)}setApplyOn(e){this.p.applyOn.set(nr.indexOf(e))}applyOn(){return nr[this.pv.applyOn]}setObjectMode(e){this.p.objectMode.set(ql.indexOf(e))}cook(e){this._operation=this._operation||new mu(this.scene(),this.states,this);const t=this._operation.cook(e,this.pv);this.setCoreGroup(t)}}class KO{constructor(e,t){this.node=e,this.shadersCollectionController=t,this.scene=e.scene(),this.timeController=this.scene.timeController,e.context()==be.JS?(this.jsNode=e,this.functionNode=this.jsNode.functionNode()):(this.jsNode=void 0,this.functionNode=e)}static type(){throw"type to be overriden"}type(){return this.constructor.type()}asString(...e){return this.shadersCollectionController?this.jsNode&&this.shadersCollectionController.addFunction(this.jsNode,this):console.warn("no shadersCollectionController in func",this.type()),""}}class J0 extends KO{constructor(){super(...arguments),this.async=!1}asString(...e){super.asString(...e);const t=`${this.type()}(${e.join(", ")})`;return this.async?`await ${t}`:t}}class ZO extends J0{}class Q0 extends J0{}class gte extends J0{}class Jp extends KO{asString(...e){return super.asString(...e),`${this.type()}(${e.join(", ")})`}}class JO extends Jp{}class vte extends Jp{}class ey extends Jp{}class yte extends Jp{}function xte(n){const{controller:e,object3D:t,evaluator:r,options:s}=n;e.addPropertiesForObject(t,s),r.onDispose(()=>{e.removePropertiesForObject(t,s)}),ve.onObjectsAddRemoveHooks.assignOnRemoveHookCallback(t,i=>{e.removePropertiesForObject(t,s)})}class bte extends ey{static type(){return"addObjectToObjectPointerdownCheck"}func(e,t,r){xte({object3D:e,evaluator:t,options:r,controller:this.scene.actorsManager.rayObjectIntersectionPointerdown})}}class Cte extends ey{static type(){return"addObjectToPointerupCheck"}func(e,t,r){const s=this.scene.actorsManager.pointerup;s.addPropertiesForObject(e,r),t.onDispose(()=>{s.removePropertiesForObject(e,r)})}}const Ete="v_POLY_param_",Ste="v_POLY_texture_";function Ate(n){return`${Ete}${n}`}function t_(n){return`${Ste}${n}`}function Tte(n,e,t,r,s,i){const o=$p(n);if(!o){console.log("no controller for",n.uuid);return}o.stepsCount=e,o.constraintInfluence=t,o.viscosity=r,o.spring=s,o.update(i)}function Mte(n,e,t){const r=$l.getUniforms(n);r&&(r[Ate(t.tSize)].value=e.tSize,r[t_(t.tPosition0)].value=e.tPosition0,r[t_(t.tPosition1)].value=e.tPosition1,r[t_(t.tNormal)].value=e.tNormal)}const yA=new T;class Rte extends JO{static type(){return"clothSolverReset"}func(e){const t=n7(e,this.scene);t&&t.setDirty()}}let co,lo;class wte extends yte{static type(){return"clothSolverStepSimulation"}func(e,t,r,s,i,o){Tte(e,t,r,s,i,o)}}class Ote extends gte{static type(){return"clothSolverUpdateMaterial"}func(e,t,r,s,i,o,a,c,l){co=co||{tSize:o,tPosition0:a,tPosition1:c,tNormal:l},co.tSize=o,co.tPosition0=a,co.tPosition1=c,co.tNormal=l,lo=lo||{tSize:t,tPosition0:r,tPosition1:s,tNormal:i},lo.tSize=t,lo.tPosition0=r,lo.tPosition1=s,lo.tNormal=i,Mte(e,co,lo)}}class Pte extends vte{static type(){return"clothCreateConstraint"}func(e,t){const r=$p(e);r&&r.createConstraint(t)}}class Nte extends JO{static type(){return"clothDeleteConstraint"}func(e){const t=$p(e);t&&t.deleteConstraint()}}class Ite extends ey{static type(){return"clothConstraintSetPosition"}func(e,t,r){const s=$p(e);s&&(r>=1||(s.constraintPosition(yA),yA.lerp(t,r)),s.setConstraintPosition(t))}}const xA=new T,bA=new T,CA=new T;new xe;new xe;new xe;new W;new W;new W;new T;new T;new T;new We;new We;new We;new T;new xe;new xe;new xe;function Dte(n,e,t){const r=n.point;xA.fromBufferAttribute(e,t.a),bA.fromBufferAttribute(e,t.b),CA.fromBufferAttribute(e,t.c);const s=xA.distanceTo(r),i=bA.distanceTo(r),o=CA.distanceTo(r);return s<i&&s<o?t.a:i<s&&i<o?t.b:t.c}function Lte(n){if(!n)return;const e=n.object.geometry;if(!e)return;const t=e.getAttribute("position");if(!t)return;const r=n.face;if(r)return Dte(n,t,r)}class Fte extends Q0{static type(){return"getIntersectionAttributeNumberNearest"}func(e,t,r){if(!e)return r;const s=Lte(e);if(s==null)return r;const i=e.object.geometry;if(!i)return r;const o=i.getAttribute(t);return o?o.array[s]:r}}class QO extends ZO{constructor(e,t){super(e,t)}}class Ute extends ZO{constructor(e,t){super(e,t),this.pointerEventsController=e.scene().eventsDispatcher.pointerEventsController}}class kte extends QO{static type(){return"globalsTime"}func(){return this.timeController.timeUniform().value}}class Bte extends QO{static type(){return"globalsTimeDelta"}func(){return this.timeController.timeDeltaUniform().value}}class Gte extends Ute{static type(){return"globalsRayFromCursor"}func(){return this.pointerEventsController.raycaster().value.ray}}class Vte extends Q0{static type(){return"planeSet"}func(e,t,r){return r.normal.copy(e),r.constant=t,r}}new _T;const zte=new T;new wt;new W;class Hte extends Q0{static type(){return"rayIntersectPlane"}func(e,t,r){return e.intersectPlane(t,r),r}}const n_={nodes:[QR,hq,Tq,Yq,E8,B8,z8,$8,pY,t7,o7,C7,T7,N7,B7,H7,X7,Dw,J7,Kw,nK,iK,dK,vg,dte,_te],operations:[],jsFunctions:[bte,Cte,Ite,Pte,Nte,Rte,wte,Ote,Fte,Gte,kte,Bte,Vte,Hte]},Xne=async function(n){const{domElement:e,sceneData:t,onProgress:r,autoPlay:s,createViewer:i,assetsRoot:o,libsRootPrefix:a,printWarnings:c,renderer:l,cameraMaskOverride:u}=n;if(n.runRegister!=null?n.runRegister:!0){for(const m of n_.nodes)ve.registerNode(m,void 0,{printWarnings:c});for(const m of n_.operations)ve.registerOperation(m,{printWarnings:c});for(const m of n_.jsFunctions)ve.registerNamedFunction(m,{printWarnings:c});const f=[];for(let m of f)zp.createNodeClassAndRegister(m);G$.run(ve)}ve.libs.setRoot("./three/js/libs");function d(f){o&&f.assets.setRoot(o),a&&ve.libs.setRootPrefix(a)}const p="scene_01",{scene:_,viewer:g}=await Rl.loadSceneData({domElement:e,sceneName:p,configureScene:d,sceneData:t,onProgress:r,autoPlay:s,createViewer:i,renderer:l,cameraMaskOverride:u});return{scene:_,viewer:g}};export{ve as Poly,Xne as loadSceneFromSceneData_scene_01};
